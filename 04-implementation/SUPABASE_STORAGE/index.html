<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Comprehensive documentation for the ToolBoxAI educational platform with AI-powered content generation and Roblox integration" name="description"/><meta content="ToolBoxAI Team" name="author"/><link href="https://docs.toolboxai.com/04-implementation/SUPABASE_STORAGE/" rel="canonical"/><link href="../../images/favicon.png" rel="icon"/><meta content="mkdocs-1.6.1, mkdocs-material-9.6.21" name="generator"/><title>Supabase Storage Implementation - ToolBoxAI Solutions Documentation</title><link href="../../assets/stylesheets/main.2a3383ac.min.css" rel="stylesheet"/><link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href="../../css/timeago.css" rel="stylesheet"/><link href="../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#supabase-storage-implementation"> Skip to content </a> </div> <div data-md-component="announce"> </div> <div data-md-color-scheme="default" data-md-component="outdated" hidden=""> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../images/logo.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> ToolBoxAI Solutions Documentation </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Supabase Storage Implementation </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0"> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> </nav> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../01-overview/README.md"> Getting Started </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../02-architecture/README.md"> Architecture </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../03-api/README.md"> API Documentation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../README.md"> Implementation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../05-features/README.md"> Features </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../06-user-guides/README.md"> User Guides </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../07-operations/README.md"> Operations </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../08-reference/README.md"> Reference </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../09-meta/README.md"> Meta </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../10-reports/README.md"> Reports </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../11-sdks/README.md"> SDKs </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../phase2/"> Phase 2 (Current) </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> Audit &amp; Reports </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../images/logo.png"/> </a> ToolBoxAI Solutions Documentation </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../.."> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../01-overview/README.md"> <span class="md-ellipsis"> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../02-architecture/README.md"> <span class="md-ellipsis"> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../03-api/README.md"> <span class="md-ellipsis"> API Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../README.md"> <span class="md-ellipsis"> Implementation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../05-features/README.md"> <span class="md-ellipsis"> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../06-user-guides/README.md"> <span class="md-ellipsis"> User Guides </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../07-operations/README.md"> <span class="md-ellipsis"> Operations </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../08-reference/README.md"> <span class="md-ellipsis"> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../09-meta/README.md"> <span class="md-ellipsis"> Meta </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../10-reports/README.md"> <span class="md-ellipsis"> Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../11-sdks/README.md"> <span class="md-ellipsis"> SDKs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../phase2/"> <span class="md-ellipsis"> Phase 2 (Current) </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> <span class="md-ellipsis"> Audit &amp; Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/edit/main/docs/04-implementation/SUPABASE_STORAGE.md" rel="edit" title="Edit this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/raw/main/docs/04-implementation/SUPABASE_STORAGE.md" title="View source of this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id="supabase-storage-implementation">Supabase Storage Implementation<a class="headerlink" href="#supabase-storage-implementation" title="Permanent link">¶</a></h1> <p>This document provides comprehensive technical details about the ToolBoxAI Storage System implementation using Supabase as the storage backend. The system is designed with multi-tenancy, security, and educational compliance as core principles.</p> <h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">¶</a></h2> <ul> <li><a href="#architecture-overview">Architecture Overview</a></li> <li><a href="#database-schema">Database Schema</a></li> <li><a href="#row-level-security-rls-policies">Row Level Security (RLS) Policies</a></li> <li><a href="#storage-service-implementation">Storage Service Implementation</a></li> <li><a href="#multi-tenant-bucket-management">Multi-Tenant Bucket Management</a></li> <li><a href="#security-implementation">Security Implementation</a></li> <li><a href="#performance-optimizations">Performance Optimizations</a></li> <li><a href="#background-processing">Background Processing</a></li> <li><a href="#integration-patterns">Integration Patterns</a></li> <li><a href="#deployment-configuration">Deployment Configuration</a></li> </ul> <h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">¶</a></h2> <h3 id="system-components">System Components<a class="headerlink" href="#system-components" title="Permanent link">¶</a></h3> <pre class="mermaid"><code>graph TB
    subgraph "API Layer"
        FastAPI[FastAPI Endpoints]
        Auth[JWT Authentication]
        RateLimit[Rate Limiting]
    end

    subgraph "Service Layer"
        StorageService[Storage Service]
        FileValidator[File Validator]
        VirusScanner[Virus Scanner]
        ImageProcessor[Image Processor]
        SecurityMgr[Security Manager]
        CDNManager[CDN Manager]
    end

    subgraph "Background Processing"
        CeleryWorkers[Celery Workers]
        VirusScanTask[Virus Scan Tasks]
        ImageOptTask[Image Optimization]
        CleanupTask[Cleanup Tasks]
        AnalyticsTask[Analytics Tasks]
    end

    subgraph "Storage Infrastructure"
        SupabaseStorage[Supabase Storage]
        PostgresDB[(PostgreSQL)]
        RedisCache[(Redis)]
        ClamAV[ClamAV Service]
    end

    subgraph "External Services"
        CDN[CDN Provider]
        EmailService[Email Service]
        Monitoring[Monitoring]
    end

    FastAPI --&gt; StorageService
    StorageService --&gt; FileValidator
    StorageService --&gt; VirusScanner
    StorageService --&gt; ImageProcessor
    StorageService --&gt; SecurityMgr
    StorageService --&gt; CDNManager

    StorageService --&gt; CeleryWorkers
    CeleryWorkers --&gt; VirusScanTask
    CeleryWorkers --&gt; ImageOptTask
    CeleryWorkers --&gt; CleanupTask
    CeleryWorkers --&gt; AnalyticsTask

    StorageService --&gt; SupabaseStorage
    StorageService --&gt; PostgresDB
    StorageService --&gt; RedisCache
    VirusScanner --&gt; ClamAV

    CDNManager --&gt; CDN
    CeleryWorkers --&gt; EmailService
    StorageService --&gt; Monitoring</code></pre> <h3 id="technology-stack">Technology Stack<a class="headerlink" href="#technology-stack" title="Permanent link">¶</a></h3> <ul> <li><strong>Storage Backend</strong>: Supabase Storage (S3-compatible)</li> <li><strong>Database</strong>: PostgreSQL 15+ with Row Level Security</li> <li><strong>Cache</strong>: Redis 6+ for session and metadata caching</li> <li><strong>Background Jobs</strong>: Celery with Redis broker</li> <li><strong>Virus Scanning</strong>: ClamAV with pyclamd</li> <li><strong>Image Processing</strong>: Pillow with WebP/AVIF support</li> <li><strong>CDN</strong>: Configurable (CloudFlare, KeyCDN, etc.)</li> <li><strong>Monitoring</strong>: Prometheus metrics with Grafana</li> </ul> <h2 id="database-schema">Database Schema<a class="headerlink" href="#database-schema" title="Permanent link">¶</a></h2> <h3 id="core-storage-models">Core Storage Models<a class="headerlink" href="#core-storage-models" title="Permanent link">¶</a></h3> <p>The storage system uses several interconnected models to manage files, versions, sharing, and compliance:</p> <div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">-- Files table with multi-tenant isolation</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">organization_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">organizations</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="c1">-- File metadata</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">filename</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">original_filename</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">file_size</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">file_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">mime_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">127</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">file_extension</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="c1">-- Storage information</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">storage_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">bucket_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">cdn_url</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="n">thumbnail_url</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="c1">-- File properties</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="n">file_status</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'pending'</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="n">category</span><span class="w"> </span><span class="n">file_category</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'media_resource'</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="n">checksum</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span><span class="w"> </span><span class="c1">-- SHA256</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="c1">-- Security and scanning</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="n">virus_scanned</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="n">virus_scan_result</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="n">last_scanned_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="c1">-- Compliance fields</span>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="n">contains_pii</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-0-31"><a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="n">requires_consent</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-0-32"><a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="n">retention_days</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
</span><span id="__span-0-33"><a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="n">deletion_date</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-0-34"><a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>
</span><span id="__span-0-35"><a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="c1">-- User relationship</span>
</span><span id="__span-0-36"><a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="n">uploaded_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-0-37"><a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>
</span><span id="__span-0-38"><a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="c1">-- Additional metadata</span>
</span><span id="__span-0-39"><a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-40"><a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-41"><a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'[]'</span><span class="p">,</span>
</span><span id="__span-0-42"><a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="n">metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'{}'</span><span class="p">,</span>
</span><span id="__span-0-43"><a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>
</span><span id="__span-0-44"><a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="c1">-- Access tracking</span>
</span><span id="__span-0-45"><a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="n">download_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-46"><a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">    </span><span class="n">last_accessed_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-0-47"><a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>
</span><span id="__span-0-48"><a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="c1">-- Timestamps</span>
</span><span id="__span-0-49"><a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-0-50"><a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-0-51"><a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>
</span><span id="__span-0-52"><a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="c1">-- Audit fields</span>
</span><span id="__span-0-53"><a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">    </span><span class="n">created_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-0-54"><a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">    </span><span class="n">updated_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-0-55"><a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="p">);</span>
</span><span id="__span-0-56"><a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>
</span><span id="__span-0-57"><a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="c1">-- Indexes for performance</span>
</span><span id="__span-0-58"><a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_organization_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-0-59"><a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_category</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">category</span><span class="p">);</span>
</span><span id="__span-0-60"><a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_uploaded_by</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">uploaded_by</span><span class="p">);</span>
</span><span id="__span-0-61"><a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_created_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
</span><span id="__span-0-62"><a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_checksum</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">checksum</span><span class="p">);</span>
</span><span id="__span-0-63"><a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_files_deletion_date</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">deletion_date</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">deletion_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div> <h3 id="file-versions">File Versions<a class="headerlink" href="#file-versions" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">-- File version tracking</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_versions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">organization_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">organizations</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">file_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="c1">-- Version information</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="n">version_number</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="n">storage_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="n">file_size</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="n">checksum</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="c1">-- Change tracking</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="n">changed_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="n">change_description</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="c1">-- Timestamps</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="k">UNIQUE</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">version_number</span><span class="p">)</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="p">);</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_versions_file_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_versions</span><span class="p">(</span><span class="n">file_id</span><span class="p">);</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_versions_created_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_versions</span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
</span></code></pre></div> <h3 id="file-sharing">File Sharing<a class="headerlink" href="#file-sharing" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">-- File sharing and access control</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_shares</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">organization_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">organizations</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">file_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="c1">-- Share configuration</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="n">share_type</span><span class="w"> </span><span class="n">share_type</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'public_link'</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="n">share_token</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">()::</span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="c1">-- Access control</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">password_protected</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="n">password_hash</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="c1">-- Permissions</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="n">can_download</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="n">can_view_only</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="c1">-- Expiration</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span><span class="n">expires_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="n">max_downloads</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="n">download_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>
</span><span id="__span-2-24"><a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="c1">-- Sharing details</span>
</span><span id="__span-2-25"><a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="n">shared_by</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-2-26"><a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="n">shared_with_users</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'[]'</span><span class="p">,</span>
</span><span id="__span-2-27"><a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">    </span><span class="n">shared_with_class</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">classes</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-2-28"><a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>
</span><span id="__span-2-29"><a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">    </span><span class="c1">-- Access tracking</span>
</span><span id="__span-2-30"><a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">    </span><span class="n">last_accessed_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-2-31"><a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'[]'</span><span class="p">,</span>
</span><span id="__span-2-32"><a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>
</span><span id="__span-2-33"><a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">    </span><span class="c1">-- Timestamps</span>
</span><span id="__span-2-34"><a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-2-35"><a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
</span><span id="__span-2-36"><a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="p">);</span>
</span><span id="__span-2-37"><a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>
</span><span id="__span-2-38"><a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_shares_file_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_shares</span><span class="p">(</span><span class="n">file_id</span><span class="p">);</span>
</span><span id="__span-2-39"><a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_shares_share_token</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_shares</span><span class="p">(</span><span class="n">share_token</span><span class="p">);</span>
</span><span id="__span-2-40"><a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">uq_file_shares_token</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_shares</span><span class="p">(</span><span class="n">share_token</span><span class="p">);</span>
</span></code></pre></div> <h3 id="storage-quotas">Storage Quotas<a class="headerlink" href="#storage-quotas" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">-- Storage quota management per organization</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">storage_quotas</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">organization_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">organizations</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="c1">-- Quota limits (in bytes)</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="n">total_quota</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1073741824</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 1GB</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="n">used_storage</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="c1">-- File count limits</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">max_files</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="n">file_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="c1">-- Category-specific limits (in MB)</span>
</span><span id="__span-3-15"><a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="n">max_file_size_mb</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-3-16"><a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="n">max_video_size_mb</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span>
</span><span id="__span-3-17"><a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="n">max_image_size_mb</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-3-18"><a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="n">max_document_size_mb</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-3-19"><a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>
</span><span id="__span-3-20"><a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="c1">-- Usage tracking</span>
</span><span id="__span-3-21"><a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="n">last_calculated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-3-22"><a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>
</span><span id="__span-3-23"><a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="c1">-- Alerts</span>
</span><span id="__span-3-24"><a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">    </span><span class="n">warning_threshold_percent</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
</span><span id="__span-3-25"><a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="n">critical_threshold_percent</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span>
</span><span id="__span-3-26"><a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">    </span><span class="n">last_warning_sent_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="p">,</span>
</span><span id="__span-3-27"><a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>
</span><span id="__span-3-28"><a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">    </span><span class="c1">-- Timestamps</span>
</span><span id="__span-3-29"><a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
</span><span id="__span-3-30"><a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
</span><span id="__span-3-31"><a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="p">);</span>
</span><span id="__span-3-32"><a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>
</span><span id="__span-3-33"><a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_storage_quotas_organization</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">storage_quotas</span><span class="p">(</span><span class="n">organization_id</span><span class="p">);</span>
</span></code></pre></div> <h3 id="access-logging">Access Logging<a class="headerlink" href="#access-logging" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">-- File access audit log (FERPA compliance)</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_access_logs</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">gen_random_uuid</span><span class="p">(),</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">file_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">files</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">organization_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">organizations</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="c1">-- Access details</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="n">action</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- view, download, share, delete</span>
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="n">accessed_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">ip_address</span><span class="w"> </span><span class="n">INET</span><span class="p">,</span>
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="n">user_agent</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
</span><span id="__span-4-14"><a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="c1">-- Additional context</span>
</span><span id="__span-4-15"><a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="n">access_granted</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
</span><span id="__span-4-16"><a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="n">denial_reason</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-4-17"><a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="n">metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'{}'</span>
</span><span id="__span-4-18"><a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">);</span>
</span><span id="__span-4-19"><a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_access_logs_file</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_access_logs</span><span class="p">(</span><span class="n">file_id</span><span class="p">);</span>
</span><span id="__span-4-21"><a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_access_logs_user</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_access_logs</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
</span><span id="__span-4-22"><a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_access_logs_timestamp</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_access_logs</span><span class="p">(</span><span class="n">accessed_at</span><span class="p">);</span>
</span><span id="__span-4-23"><a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_file_access_logs_organization</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_access_logs</span><span class="p">(</span><span class="n">organization_id</span><span class="p">);</span>
</span></code></pre></div> <h3 id="enums">Enums<a class="headerlink" href="#enums" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">-- File status enumeration</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">file_status</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="s1">'pending'</span><span class="p">,</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="s1">'processing'</span><span class="p">,</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="s1">'available'</span><span class="p">,</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="s1">'quarantined'</span><span class="p">,</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="s1">'deleted'</span><span class="p">,</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="s1">'archived'</span><span class="p">,</span>
</span><span id="__span-5-9"><a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="s1">'error'</span>
</span><span id="__span-5-10"><a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="p">);</span>
</span><span id="__span-5-11"><a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>
</span><span id="__span-5-12"><a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="c1">-- File category enumeration</span>
</span><span id="__span-5-13"><a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">file_category</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-5-14"><a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="s1">'educational_content'</span><span class="p">,</span>
</span><span id="__span-5-15"><a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="s1">'student_submission'</span><span class="p">,</span>
</span><span id="__span-5-16"><a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="s1">'assessment'</span><span class="p">,</span>
</span><span id="__span-5-17"><a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="s1">'administrative'</span><span class="p">,</span>
</span><span id="__span-5-18"><a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="s1">'media_resource'</span><span class="p">,</span>
</span><span id="__span-5-19"><a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="s1">'temporary'</span><span class="p">,</span>
</span><span id="__span-5-20"><a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="s1">'avatar'</span><span class="p">,</span>
</span><span id="__span-5-21"><a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="s1">'report'</span>
</span><span id="__span-5-22"><a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="p">);</span>
</span><span id="__span-5-23"><a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>
</span><span id="__span-5-24"><a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="c1">-- Share type enumeration</span>
</span><span id="__span-5-25"><a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">share_type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-5-26"><a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="s1">'public_link'</span><span class="p">,</span>
</span><span id="__span-5-27"><a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">    </span><span class="s1">'organization'</span><span class="p">,</span>
</span><span id="__span-5-28"><a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">    </span><span class="s1">'specific_users'</span><span class="p">,</span>
</span><span id="__span-5-29"><a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">    </span><span class="s1">'class'</span><span class="p">,</span>
</span><span id="__span-5-30"><a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">    </span><span class="s1">'temporary'</span>
</span><span id="__span-5-31"><a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="p">);</span>
</span></code></pre></div> <h2 id="row-level-security-rls-policies">Row Level Security (RLS) Policies<a class="headerlink" href="#row-level-security-rls-policies" title="Permanent link">¶</a></h2> <h3 id="organization-isolation">Organization Isolation<a class="headerlink" href="#organization-isolation" title="Permanent link">¶</a></h3> <p>All storage tables implement RLS to ensure complete organization isolation:</p> <div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">-- Enable RLS on all storage tables</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_versions</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_shares</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">storage_quotas</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">file_access_logs</span><span class="w"> </span><span class="n">ENABLE</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SECURITY</span><span class="p">;</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="c1">-- Files table policies</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">files_organization_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">);</span>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">files_user_access</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">files</span>
</span><span id="__span-6-14"><a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span>
</span><span id="__span-6-15"><a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-16"><a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">        </span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span>
</span><span id="__span-6-17"><a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-18"><a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">            </span><span class="n">uploaded_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_user_id'</span><span class="p">)::</span><span class="n">UUID</span>
</span><span id="__span-6-19"><a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">            </span><span class="k">OR</span><span class="w"> </span><span class="n">has_file_access</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_user_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">)</span>
</span><span id="__span-6-20"><a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-6-21"><a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-6-22"><a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a>
</span><span id="__span-6-23"><a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="c1">-- File versions policies</span>
</span><span id="__span-6-24"><a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">file_versions_organization_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_versions</span>
</span><span id="__span-6-25"><a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-6-26"><a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">);</span>
</span><span id="__span-6-27"><a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a>
</span><span id="__span-6-28"><a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="c1">-- File shares policies</span>
</span><span id="__span-6-29"><a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">file_shares_organization_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_shares</span>
</span><span id="__span-6-30"><a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-6-31"><a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">);</span>
</span><span id="__span-6-32"><a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>
</span><span id="__span-6-33"><a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="c1">-- Storage quotas policies</span>
</span><span id="__span-6-34"><a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">storage_quotas_organization_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">storage_quotas</span>
</span><span id="__span-6-35"><a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-6-36"><a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">);</span>
</span><span id="__span-6-37"><a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a>
</span><span id="__span-6-38"><a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="c1">-- Access logs policies</span>
</span><span id="__span-6-39"><a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="n">file_access_logs_organization_isolation</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">file_access_logs</span>
</span><span id="__span-6-40"><a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-6-41"><a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">organization_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">'app.current_organization_id'</span><span class="p">)::</span><span class="n">UUID</span><span class="p">);</span>
</span></code></pre></div> <h3 id="permission-functions">Permission Functions<a class="headerlink" href="#permission-functions" title="Permanent link">¶</a></h3> <div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">-- Function to check if user has access to a file</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">has_file_access</span><span class="p">(</span><span class="n">file_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">)</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="k">RETURNS</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="k">DECLARE</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">file_org_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">;</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="n">user_org_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">;</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="n">user_role</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="n">file_category</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">;</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="n">is_shared</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">;</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="k">BEGIN</span>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="c1">-- Get file organization and category</span>
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">organization_id</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">category</span>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="k">INTO</span><span class="w"> </span><span class="n">file_org_id</span><span class="p">,</span><span class="w"> </span><span class="n">file_category</span>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">f</span>
</span><span id="__span-7-15"><a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_id</span><span class="p">;</span>
</span><span id="__span-7-16"><a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>
</span><span id="__span-7-17"><a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="c1">-- Get user organization and role</span>
</span><span id="__span-7-18"><a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">organization_id</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="k">role</span>
</span><span id="__span-7-19"><a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_org_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_role</span>
</span><span id="__span-7-20"><a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span>
</span><span id="__span-7-21"><a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span><span class="p">;</span>
</span><span id="__span-7-22"><a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>
</span><span id="__span-7-23"><a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">    </span><span class="c1">-- Check organization membership</span>
</span><span id="__span-7-24"><a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">file_org_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">user_org_id</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-25"><a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
</span><span id="__span-7-26"><a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-27"><a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>
</span><span id="__span-7-28"><a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">    </span><span class="c1">-- Admin access</span>
</span><span id="__span-7-29"><a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">user_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'admin'</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-30"><a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</span><span id="__span-7-31"><a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-32"><a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>
</span><span id="__span-7-33"><a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">    </span><span class="c1">-- Check if file is shared with user</span>
</span><span id="__span-7-34"><a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span>
</span><span id="__span-7-35"><a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">file_shares</span><span class="w"> </span><span class="n">fs</span>
</span><span id="__span-7-36"><a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">file_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">has_file_access</span><span class="p">.</span><span class="n">file_id</span>
</span><span id="__span-7-37"><a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-38"><a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">            </span><span class="n">fs</span><span class="p">.</span><span class="n">share_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'organization'</span>
</span><span id="__span-7-39"><a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">            </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">share_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'specific_users'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">shared_with_users</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">user_id</span><span class="p">::</span><span class="nb">TEXT</span><span class="p">)</span>
</span><span id="__span-7-40"><a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">            </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">share_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'class'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">user_in_class</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">shared_with_class</span><span class="p">))</span>
</span><span id="__span-7-41"><a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-7-42"><a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">expires_at</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">expires_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NOW</span><span class="p">())</span>
</span><span id="__span-7-43"><a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">is_shared</span><span class="p">;</span>
</span><span id="__span-7-44"><a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a>
</span><span id="__span-7-45"><a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">is_shared</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-46"><a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</span><span id="__span-7-47"><a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-48"><a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a>
</span><span id="__span-7-49"><a href="#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a><span class="w">    </span><span class="c1">-- Teacher access to educational content and student submissions</span>
</span><span id="__span-7-50"><a href="#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">user_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'teacher'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">file_category</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'educational_content'</span><span class="p">,</span><span class="w"> </span><span class="s1">'student_submission'</span><span class="p">,</span><span class="w"> </span><span class="s1">'assessment'</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-51"><a href="#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</span><span id="__span-7-52"><a href="#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-53"><a href="#__codelineno-7-53" id="__codelineno-7-53" name="__codelineno-7-53"></a>
</span><span id="__span-7-54"><a href="#__codelineno-7-54" id="__codelineno-7-54" name="__codelineno-7-54"></a><span class="w">    </span><span class="c1">-- Student access to their own submissions and shared educational content</span>
</span><span id="__span-7-55"><a href="#__codelineno-7-55" id="__codelineno-7-55" name="__codelineno-7-55"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">user_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'student'</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-56"><a href="#__codelineno-7-56" id="__codelineno-7-56" name="__codelineno-7-56"></a><span class="w">        </span><span class="c1">-- Own files</span>
</span><span id="__span-7-57"><a href="#__codelineno-7-57" id="__codelineno-7-57" name="__codelineno-7-57"></a><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">uploaded_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-58"><a href="#__codelineno-7-58" id="__codelineno-7-58" name="__codelineno-7-58"></a><span class="w">            </span><span class="k">RETURN</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</span><span id="__span-7-59"><a href="#__codelineno-7-59" id="__codelineno-7-59" name="__codelineno-7-59"></a><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-60"><a href="#__codelineno-7-60" id="__codelineno-7-60" name="__codelineno-7-60"></a>
</span><span id="__span-7-61"><a href="#__codelineno-7-61" id="__codelineno-7-61" name="__codelineno-7-61"></a><span class="w">        </span><span class="c1">-- Educational content in their classes</span>
</span><span id="__span-7-62"><a href="#__codelineno-7-62" id="__codelineno-7-62" name="__codelineno-7-62"></a><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">file_category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'educational_content'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">user_has_class_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">file_id</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-7-63"><a href="#__codelineno-7-63" id="__codelineno-7-63" name="__codelineno-7-63"></a><span class="w">            </span><span class="k">RETURN</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
</span><span id="__span-7-64"><a href="#__codelineno-7-64" id="__codelineno-7-64" name="__codelineno-7-64"></a><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-65"><a href="#__codelineno-7-65" id="__codelineno-7-65" name="__codelineno-7-65"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
</span><span id="__span-7-66"><a href="#__codelineno-7-66" id="__codelineno-7-66" name="__codelineno-7-66"></a>
</span><span id="__span-7-67"><a href="#__codelineno-7-67" id="__codelineno-7-67" name="__codelineno-7-67"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
</span><span id="__span-7-68"><a href="#__codelineno-7-68" id="__codelineno-7-68" name="__codelineno-7-68"></a><span class="k">END</span><span class="p">;</span>
</span><span id="__span-7-69"><a href="#__codelineno-7-69" id="__codelineno-7-69" name="__codelineno-7-69"></a><span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="k">SECURITY</span><span class="w"> </span><span class="k">DEFINER</span><span class="p">;</span>
</span></code></pre></div> <h2 id="storage-service-implementation">Storage Service Implementation<a class="headerlink" href="#storage-service-implementation" title="Permanent link">¶</a></h2> <h3 id="base-storage-service-interface">Base Storage Service Interface<a class="headerlink" href="#base-storage-service-interface" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="nd">@dataclass</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">UploadOptions</span><span class="p">:</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="sd">"""Configuration options for file upload"""</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>    <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"media_resource"</span>
</span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-13"><a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-14"><a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="n">virus_scan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-8-15"><a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="n">content_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-8-16"><a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="n">generate_thumbnails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-8-17"><a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>    <span class="n">optimize_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-8-18"><a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="n">retention_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-19"><a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-20"><a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a>
</span><span id="__span-8-21"><a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="nd">@dataclass</span>
</span><span id="__span-8-22"><a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">UploadResult</span><span class="p">:</span>
</span><span id="__span-8-23"><a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="sd">"""Result of file upload operation"""</span>
</span><span id="__span-8-24"><a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a>    <span class="n">file_id</span><span class="p">:</span> <span class="n">UUID</span>
</span><span id="__span-8-25"><a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a>    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-26"><a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a>    <span class="n">file_size</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-8-27"><a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a>    <span class="n">mime_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-28"><a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-8-29"><a href="#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a>    <span class="n">cdn_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-30"><a href="#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a>    <span class="n">thumbnail_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-31"><a href="#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a>    <span class="n">checksum</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-32"><a href="#__codelineno-8-32" id="__codelineno-8-32" name="__codelineno-8-32"></a>    <span class="n">processing_eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-33"><a href="#__codelineno-8-33" id="__codelineno-8-33" name="__codelineno-8-33"></a>
</span><span id="__span-8-34"><a href="#__codelineno-8-34" id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">StorageService</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="__span-8-35"><a href="#__codelineno-8-35" id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">    </span><span class="sd">"""Abstract base class for storage services"""</span>
</span><span id="__span-8-36"><a href="#__codelineno-8-36" id="__codelineno-8-36" name="__codelineno-8-36"></a>
</span><span id="__span-8-37"><a href="#__codelineno-8-37" id="__codelineno-8-37" name="__codelineno-8-37"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">):</span>
</span><span id="__span-8-38"><a href="#__codelineno-8-38" id="__codelineno-8-38" name="__codelineno-8-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span> <span class="o">=</span> <span class="n">organization_id</span>
</span><span id="__span-8-39"><a href="#__codelineno-8-39" id="__codelineno-8-39" name="__codelineno-8-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span><span id="__span-8-40"><a href="#__codelineno-8-40" id="__codelineno-8-40" name="__codelineno-8-40"></a>
</span><span id="__span-8-41"><a href="#__codelineno-8-41" id="__codelineno-8-41" name="__codelineno-8-41"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-8-42"><a href="#__codelineno-8-42" id="__codelineno-8-42" name="__codelineno-8-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span>
</span><span id="__span-8-43"><a href="#__codelineno-8-43" id="__codelineno-8-43" name="__codelineno-8-43"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-8-44"><a href="#__codelineno-8-44" id="__codelineno-8-44" name="__codelineno-8-44"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-8-45"><a href="#__codelineno-8-45" id="__codelineno-8-45" name="__codelineno-8-45"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-8-46"><a href="#__codelineno-8-46" id="__codelineno-8-46" name="__codelineno-8-46"></a>        <span class="n">options</span><span class="p">:</span> <span class="n">UploadOptions</span>
</span><span id="__span-8-47"><a href="#__codelineno-8-47" id="__codelineno-8-47" name="__codelineno-8-47"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UploadResult</span><span class="p">:</span>
</span><span id="__span-8-48"><a href="#__codelineno-8-48" id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">        </span><span class="sd">"""Upload a single file"""</span>
</span><span id="__span-8-49"><a href="#__codelineno-8-49" id="__codelineno-8-49" name="__codelineno-8-49"></a>        <span class="k">pass</span>
</span><span id="__span-8-50"><a href="#__codelineno-8-50" id="__codelineno-8-50" name="__codelineno-8-50"></a>
</span><span id="__span-8-51"><a href="#__codelineno-8-51" id="__codelineno-8-51" name="__codelineno-8-51"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-8-52"><a href="#__codelineno-8-52" id="__codelineno-8-52" name="__codelineno-8-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file_multipart</span><span class="p">(</span>
</span><span id="__span-8-53"><a href="#__codelineno-8-53" id="__codelineno-8-53" name="__codelineno-8-53"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-8-54"><a href="#__codelineno-8-54" id="__codelineno-8-54" name="__codelineno-8-54"></a>        <span class="n">file_stream</span><span class="p">:</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
</span><span id="__span-8-55"><a href="#__codelineno-8-55" id="__codelineno-8-55" name="__codelineno-8-55"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-8-56"><a href="#__codelineno-8-56" id="__codelineno-8-56" name="__codelineno-8-56"></a>        <span class="n">total_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-8-57"><a href="#__codelineno-8-57" id="__codelineno-8-57" name="__codelineno-8-57"></a>        <span class="n">options</span><span class="p">:</span> <span class="n">UploadOptions</span><span class="p">,</span>
</span><span id="__span-8-58"><a href="#__codelineno-8-58" id="__codelineno-8-58" name="__codelineno-8-58"></a>        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 10MB</span>
</span><span id="__span-8-59"><a href="#__codelineno-8-59" id="__codelineno-8-59" name="__codelineno-8-59"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UploadResult</span><span class="p">:</span>
</span><span id="__span-8-60"><a href="#__codelineno-8-60" id="__codelineno-8-60" name="__codelineno-8-60"></a><span class="w">        </span><span class="sd">"""Upload large file using multipart upload"""</span>
</span><span id="__span-8-61"><a href="#__codelineno-8-61" id="__codelineno-8-61" name="__codelineno-8-61"></a>        <span class="k">pass</span>
</span><span id="__span-8-62"><a href="#__codelineno-8-62" id="__codelineno-8-62" name="__codelineno-8-62"></a>
</span><span id="__span-8-63"><a href="#__codelineno-8-63" id="__codelineno-8-63" name="__codelineno-8-63"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-8-64"><a href="#__codelineno-8-64" id="__codelineno-8-64" name="__codelineno-8-64"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span>
</span><span id="__span-8-65"><a href="#__codelineno-8-65" id="__codelineno-8-65" name="__codelineno-8-65"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-8-66"><a href="#__codelineno-8-66" id="__codelineno-8-66" name="__codelineno-8-66"></a>        <span class="n">file_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-8-67"><a href="#__codelineno-8-67" id="__codelineno-8-67" name="__codelineno-8-67"></a>        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-68"><a href="#__codelineno-8-68" id="__codelineno-8-68" name="__codelineno-8-68"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-8-69"><a href="#__codelineno-8-69" id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="w">        </span><span class="sd">"""Get download URL for file"""</span>
</span><span id="__span-8-70"><a href="#__codelineno-8-70" id="__codelineno-8-70" name="__codelineno-8-70"></a>        <span class="k">pass</span>
</span><span id="__span-8-71"><a href="#__codelineno-8-71" id="__codelineno-8-71" name="__codelineno-8-71"></a>
</span><span id="__span-8-72"><a href="#__codelineno-8-72" id="__codelineno-8-72" name="__codelineno-8-72"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-8-73"><a href="#__codelineno-8-73" id="__codelineno-8-73" name="__codelineno-8-73"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span>
</span><span id="__span-8-74"><a href="#__codelineno-8-74" id="__codelineno-8-74" name="__codelineno-8-74"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-8-75"><a href="#__codelineno-8-75" id="__codelineno-8-75" name="__codelineno-8-75"></a>        <span class="n">file_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-8-76"><a href="#__codelineno-8-76" id="__codelineno-8-76" name="__codelineno-8-76"></a>        <span class="n">permanent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-8-77"><a href="#__codelineno-8-77" id="__codelineno-8-77" name="__codelineno-8-77"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-8-78"><a href="#__codelineno-8-78" id="__codelineno-8-78" name="__codelineno-8-78"></a><span class="w">        </span><span class="sd">"""Delete file (soft delete by default)"""</span>
</span><span id="__span-8-79"><a href="#__codelineno-8-79" id="__codelineno-8-79" name="__codelineno-8-79"></a>        <span class="k">pass</span>
</span><span id="__span-8-80"><a href="#__codelineno-8-80" id="__codelineno-8-80" name="__codelineno-8-80"></a>
</span><span id="__span-8-81"><a href="#__codelineno-8-81" id="__codelineno-8-81" name="__codelineno-8-81"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-8-82"><a href="#__codelineno-8-82" id="__codelineno-8-82" name="__codelineno-8-82"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_files</span><span class="p">(</span>
</span><span id="__span-8-83"><a href="#__codelineno-8-83" id="__codelineno-8-83" name="__codelineno-8-83"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-8-84"><a href="#__codelineno-8-84" id="__codelineno-8-84" name="__codelineno-8-84"></a>        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-8-85"><a href="#__codelineno-8-85" id="__codelineno-8-85" name="__codelineno-8-85"></a>        <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-8-86"><a href="#__codelineno-8-86" id="__codelineno-8-86" name="__codelineno-8-86"></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-8-87"><a href="#__codelineno-8-87" id="__codelineno-8-87" name="__codelineno-8-87"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-8-88"><a href="#__codelineno-8-88" id="__codelineno-8-88" name="__codelineno-8-88"></a><span class="w">        </span><span class="sd">"""List files with pagination and filtering"""</span>
</span><span id="__span-8-89"><a href="#__codelineno-8-89" id="__codelineno-8-89" name="__codelineno-8-89"></a>        <span class="k">pass</span>
</span></code></pre></div> <h3 id="supabase-storage-provider">Supabase Storage Provider<a class="headerlink" href="#supabase-storage-provider" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mimetypes</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">AsyncIterator</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid4</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">supabase</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_client</span><span class="p">,</span> <span class="n">Client</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">delete</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.file_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileValidator</span>
</span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.virus_scanner</span><span class="w"> </span><span class="kn">import</span> <span class="n">VirusScanner</span>
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.image_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageProcessor</span>
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.security_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">SecurityManager</span>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.cdn_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">CDNManager</span>
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database.models.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">FileStatus</span><span class="p">,</span> <span class="n">FileCategory</span>
</span><span id="__span-9-18"><a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">toolboxai_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
</span><span id="__span-9-19"><a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>
</span><span id="__span-9-20"><a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">SupabaseStorageProvider</span><span class="p">(</span><span class="n">StorageService</span><span class="p">):</span>
</span><span id="__span-9-21"><a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="sd">"""Supabase-based storage implementation"""</span>
</span><span id="__span-9-22"><a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>
</span><span id="__span-9-23"><a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">):</span>
</span><span id="__span-9-24"><a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span><span id="__span-9-25"><a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a>
</span><span id="__span-9-26"><a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>        <span class="c1"># Initialize Supabase client</span>
</span><span id="__span-9-27"><a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span><span class="p">:</span> <span class="n">Client</span> <span class="o">=</span> <span class="n">create_client</span><span class="p">(</span>
</span><span id="__span-9-28"><a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a>            <span class="n">settings</span><span class="o">.</span><span class="n">SUPABASE_URL</span><span class="p">,</span>
</span><span id="__span-9-29"><a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>            <span class="n">settings</span><span class="o">.</span><span class="n">SUPABASE_SERVICE_ROLE_KEY</span>
</span><span id="__span-9-30"><a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a>        <span class="p">)</span>
</span><span id="__span-9-31"><a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a>
</span><span id="__span-9-32"><a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a>        <span class="c1"># Initialize service components</span>
</span><span id="__span-9-33"><a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_validator</span> <span class="o">=</span> <span class="n">FileValidator</span><span class="p">()</span>
</span><span id="__span-9-34"><a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virus_scanner</span> <span class="o">=</span> <span class="n">VirusScanner</span><span class="p">()</span>
</span><span id="__span-9-35"><a href="#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">()</span>
</span><span id="__span-9-36"><a href="#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">security_manager</span> <span class="o">=</span> <span class="n">SecurityManager</span><span class="p">()</span>
</span><span id="__span-9-37"><a href="#__codelineno-9-37" id="__codelineno-9-37" name="__codelineno-9-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">CDNManager</span><span class="p">()</span>
</span><span id="__span-9-38"><a href="#__codelineno-9-38" id="__codelineno-9-38" name="__codelineno-9-38"></a>
</span><span id="__span-9-39"><a href="#__codelineno-9-39" id="__codelineno-9-39" name="__codelineno-9-39"></a>        <span class="c1"># Organization-specific bucket</span>
</span><span id="__span-9-40"><a href="#__codelineno-9-40" id="__codelineno-9-40" name="__codelineno-9-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"toolboxai-org-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-9-41"><a href="#__codelineno-9-41" id="__codelineno-9-41" name="__codelineno-9-41"></a>
</span><span id="__span-9-42"><a href="#__codelineno-9-42" id="__codelineno-9-42" name="__codelineno-9-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span>
</span><span id="__span-9-43"><a href="#__codelineno-9-43" id="__codelineno-9-43" name="__codelineno-9-43"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-9-44"><a href="#__codelineno-9-44" id="__codelineno-9-44" name="__codelineno-9-44"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-9-45"><a href="#__codelineno-9-45" id="__codelineno-9-45" name="__codelineno-9-45"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-9-46"><a href="#__codelineno-9-46" id="__codelineno-9-46" name="__codelineno-9-46"></a>        <span class="n">options</span><span class="p">:</span> <span class="n">UploadOptions</span>
</span><span id="__span-9-47"><a href="#__codelineno-9-47" id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UploadResult</span><span class="p">:</span>
</span><span id="__span-9-48"><a href="#__codelineno-9-48" id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">        </span><span class="sd">"""Upload a single file with full processing pipeline"""</span>
</span><span id="__span-9-49"><a href="#__codelineno-9-49" id="__codelineno-9-49" name="__codelineno-9-49"></a>
</span><span id="__span-9-50"><a href="#__codelineno-9-50" id="__codelineno-9-50" name="__codelineno-9-50"></a>        <span class="c1"># Validate file</span>
</span><span id="__span-9-51"><a href="#__codelineno-9-51" id="__codelineno-9-51" name="__codelineno-9-51"></a>        <span class="n">validation_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_validator</span><span class="o">.</span><span class="n">validate_file</span><span class="p">(</span>
</span><span id="__span-9-52"><a href="#__codelineno-9-52" id="__codelineno-9-52" name="__codelineno-9-52"></a>            <span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">file_category</span>
</span><span id="__span-9-53"><a href="#__codelineno-9-53" id="__codelineno-9-53" name="__codelineno-9-53"></a>        <span class="p">)</span>
</span><span id="__span-9-54"><a href="#__codelineno-9-54" id="__codelineno-9-54" name="__codelineno-9-54"></a>
</span><span id="__span-9-55"><a href="#__codelineno-9-55" id="__codelineno-9-55" name="__codelineno-9-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
</span><span id="__span-9-56"><a href="#__codelineno-9-56" id="__codelineno-9-56" name="__codelineno-9-56"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File validation failed: </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-9-57"><a href="#__codelineno-9-57" id="__codelineno-9-57" name="__codelineno-9-57"></a>
</span><span id="__span-9-58"><a href="#__codelineno-9-58" id="__codelineno-9-58" name="__codelineno-9-58"></a>        <span class="c1"># Generate file metadata</span>
</span><span id="__span-9-59"><a href="#__codelineno-9-59" id="__codelineno-9-59" name="__codelineno-9-59"></a>        <span class="n">file_id</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span>
</span><span id="__span-9-60"><a href="#__codelineno-9-60" id="__codelineno-9-60" name="__codelineno-9-60"></a>        <span class="n">mime_type</span> <span class="o">=</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">detected_mime_type</span>
</span><span id="__span-9-61"><a href="#__codelineno-9-61" id="__codelineno-9-61" name="__codelineno-9-61"></a>        <span class="n">file_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-9-62"><a href="#__codelineno-9-62" id="__codelineno-9-62" name="__codelineno-9-62"></a>        <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-9-63"><a href="#__codelineno-9-63" id="__codelineno-9-63" name="__codelineno-9-63"></a>
</span><span id="__span-9-64"><a href="#__codelineno-9-64" id="__codelineno-9-64" name="__codelineno-9-64"></a>        <span class="c1"># Generate storage path</span>
</span><span id="__span-9-65"><a href="#__codelineno-9-65" id="__codelineno-9-65" name="__codelineno-9-65"></a>        <span class="n">storage_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_storage_path</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">file_category</span><span class="p">)</span>
</span><span id="__span-9-66"><a href="#__codelineno-9-66" id="__codelineno-9-66" name="__codelineno-9-66"></a>
</span><span id="__span-9-67"><a href="#__codelineno-9-67" id="__codelineno-9-67" name="__codelineno-9-67"></a>        <span class="c1"># Create database record</span>
</span><span id="__span-9-68"><a href="#__codelineno-9-68" id="__codelineno-9-68" name="__codelineno-9-68"></a>        <span class="n">file_record</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span>
</span><span id="__span-9-69"><a href="#__codelineno-9-69" id="__codelineno-9-69" name="__codelineno-9-69"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">file_id</span><span class="p">,</span>
</span><span id="__span-9-70"><a href="#__codelineno-9-70" id="__codelineno-9-70" name="__codelineno-9-70"></a>            <span class="n">organization_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="p">,</span>
</span><span id="__span-9-71"><a href="#__codelineno-9-71" id="__codelineno-9-71" name="__codelineno-9-71"></a>            <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
</span><span id="__span-9-72"><a href="#__codelineno-9-72" id="__codelineno-9-72" name="__codelineno-9-72"></a>            <span class="n">original_filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
</span><span id="__span-9-73"><a href="#__codelineno-9-73" id="__codelineno-9-73" name="__codelineno-9-73"></a>            <span class="n">file_size</span><span class="o">=</span><span class="n">file_size</span><span class="p">,</span>
</span><span id="__span-9-74"><a href="#__codelineno-9-74" id="__codelineno-9-74" name="__codelineno-9-74"></a>            <span class="n">mime_type</span><span class="o">=</span><span class="n">mime_type</span><span class="p">,</span>
</span><span id="__span-9-75"><a href="#__codelineno-9-75" id="__codelineno-9-75" name="__codelineno-9-75"></a>            <span class="n">file_extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
</span><span id="__span-9-76"><a href="#__codelineno-9-76" id="__codelineno-9-76" name="__codelineno-9-76"></a>            <span class="n">storage_path</span><span class="o">=</span><span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-9-77"><a href="#__codelineno-9-77" id="__codelineno-9-77" name="__codelineno-9-77"></a>            <span class="n">bucket_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-9-78"><a href="#__codelineno-9-78" id="__codelineno-9-78" name="__codelineno-9-78"></a>            <span class="n">status</span><span class="o">=</span><span class="n">FileStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span>
</span><span id="__span-9-79"><a href="#__codelineno-9-79" id="__codelineno-9-79" name="__codelineno-9-79"></a>            <span class="n">category</span><span class="o">=</span><span class="n">FileCategory</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">file_category</span><span class="p">),</span>
</span><span id="__span-9-80"><a href="#__codelineno-9-80" id="__codelineno-9-80" name="__codelineno-9-80"></a>            <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">,</span>
</span><span id="__span-9-81"><a href="#__codelineno-9-81" id="__codelineno-9-81" name="__codelineno-9-81"></a>            <span class="n">uploaded_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-9-82"><a href="#__codelineno-9-82" id="__codelineno-9-82" name="__codelineno-9-82"></a>            <span class="n">title</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="__span-9-83"><a href="#__codelineno-9-83" id="__codelineno-9-83" name="__codelineno-9-83"></a>            <span class="n">description</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
</span><span id="__span-9-84"><a href="#__codelineno-9-84" id="__codelineno-9-84" name="__codelineno-9-84"></a>            <span class="n">tags</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">[],</span>
</span><span id="__span-9-85"><a href="#__codelineno-9-85" id="__codelineno-9-85" name="__codelineno-9-85"></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="__span-9-86"><a href="#__codelineno-9-86" id="__codelineno-9-86" name="__codelineno-9-86"></a>        <span class="p">)</span>
</span><span id="__span-9-87"><a href="#__codelineno-9-87" id="__codelineno-9-87" name="__codelineno-9-87"></a>
</span><span id="__span-9-88"><a href="#__codelineno-9-88" id="__codelineno-9-88" name="__codelineno-9-88"></a>        <span class="c1"># Save to database</span>
</span><span id="__span-9-89"><a href="#__codelineno-9-89" id="__codelineno-9-89" name="__codelineno-9-89"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-9-90"><a href="#__codelineno-9-90" id="__codelineno-9-90" name="__codelineno-9-90"></a>            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_record</span><span class="p">)</span>
</span><span id="__span-9-91"><a href="#__codelineno-9-91" id="__codelineno-9-91" name="__codelineno-9-91"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-9-92"><a href="#__codelineno-9-92" id="__codelineno-9-92" name="__codelineno-9-92"></a>
</span><span id="__span-9-93"><a href="#__codelineno-9-93" id="__codelineno-9-93" name="__codelineno-9-93"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-94"><a href="#__codelineno-9-94" id="__codelineno-9-94" name="__codelineno-9-94"></a>            <span class="c1"># Upload to Supabase Storage</span>
</span><span id="__span-9-95"><a href="#__codelineno-9-95" id="__codelineno-9-95" name="__codelineno-9-95"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_bucket_exists</span><span class="p">()</span>
</span><span id="__span-9-96"><a href="#__codelineno-9-96" id="__codelineno-9-96" name="__codelineno-9-96"></a>
</span><span id="__span-9-97"><a href="#__codelineno-9-97" id="__codelineno-9-97" name="__codelineno-9-97"></a>            <span class="n">upload_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">)</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
</span><span id="__span-9-98"><a href="#__codelineno-9-98" id="__codelineno-9-98" name="__codelineno-9-98"></a>                <span class="n">path</span><span class="o">=</span><span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-9-99"><a href="#__codelineno-9-99" id="__codelineno-9-99" name="__codelineno-9-99"></a>                <span class="n">file</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span>
</span><span id="__span-9-100"><a href="#__codelineno-9-100" id="__codelineno-9-100" name="__codelineno-9-100"></a>                <span class="n">file_options</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-9-101"><a href="#__codelineno-9-101" id="__codelineno-9-101" name="__codelineno-9-101"></a>                    <span class="s2">"content-type"</span><span class="p">:</span> <span class="n">mime_type</span><span class="p">,</span>
</span><span id="__span-9-102"><a href="#__codelineno-9-102" id="__codelineno-9-102" name="__codelineno-9-102"></a>                    <span class="s2">"cache-control"</span><span class="p">:</span> <span class="s2">"3600"</span><span class="p">,</span>
</span><span id="__span-9-103"><a href="#__codelineno-9-103" id="__codelineno-9-103" name="__codelineno-9-103"></a>                    <span class="s2">"upsert"</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="__span-9-104"><a href="#__codelineno-9-104" id="__codelineno-9-104" name="__codelineno-9-104"></a>                <span class="p">}</span>
</span><span id="__span-9-105"><a href="#__codelineno-9-105" id="__codelineno-9-105" name="__codelineno-9-105"></a>            <span class="p">)</span>
</span><span id="__span-9-106"><a href="#__codelineno-9-106" id="__codelineno-9-106" name="__codelineno-9-106"></a>
</span><span id="__span-9-107"><a href="#__codelineno-9-107" id="__codelineno-9-107" name="__codelineno-9-107"></a>            <span class="k">if</span> <span class="n">upload_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error"</span><span class="p">):</span>
</span><span id="__span-9-108"><a href="#__codelineno-9-108" id="__codelineno-9-108" name="__codelineno-9-108"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Supabase upload failed: </span><span class="si">{</span><span class="n">upload_response</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-9-109"><a href="#__codelineno-9-109" id="__codelineno-9-109" name="__codelineno-9-109"></a>
</span><span id="__span-9-110"><a href="#__codelineno-9-110" id="__codelineno-9-110" name="__codelineno-9-110"></a>            <span class="c1"># Get CDN URL</span>
</span><span id="__span-9-111"><a href="#__codelineno-9-111" id="__codelineno-9-111" name="__codelineno-9-111"></a>            <span class="n">cdn_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_file_url</span><span class="p">(</span>
</span><span id="__span-9-112"><a href="#__codelineno-9-112" id="__codelineno-9-112" name="__codelineno-9-112"></a>                <span class="n">bucket_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-9-113"><a href="#__codelineno-9-113" id="__codelineno-9-113" name="__codelineno-9-113"></a>                <span class="n">storage_path</span><span class="o">=</span><span class="n">storage_path</span>
</span><span id="__span-9-114"><a href="#__codelineno-9-114" id="__codelineno-9-114" name="__codelineno-9-114"></a>            <span class="p">)</span>
</span><span id="__span-9-115"><a href="#__codelineno-9-115" id="__codelineno-9-115" name="__codelineno-9-115"></a>
</span><span id="__span-9-116"><a href="#__codelineno-9-116" id="__codelineno-9-116" name="__codelineno-9-116"></a>            <span class="c1"># Update file record with URLs</span>
</span><span id="__span-9-117"><a href="#__codelineno-9-117" id="__codelineno-9-117" name="__codelineno-9-117"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-9-118"><a href="#__codelineno-9-118" id="__codelineno-9-118" name="__codelineno-9-118"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-9-119"><a href="#__codelineno-9-119" id="__codelineno-9-119" name="__codelineno-9-119"></a>                    <span class="n">update</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
</span><span id="__span-9-120"><a href="#__codelineno-9-120" id="__codelineno-9-120" name="__codelineno-9-120"></a>                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">file_id</span><span class="p">)</span>
</span><span id="__span-9-121"><a href="#__codelineno-9-121" id="__codelineno-9-121" name="__codelineno-9-121"></a>                    <span class="o">.</span><span class="n">values</span><span class="p">(</span>
</span><span id="__span-9-122"><a href="#__codelineno-9-122" id="__codelineno-9-122" name="__codelineno-9-122"></a>                        <span class="n">cdn_url</span><span class="o">=</span><span class="n">cdn_url</span><span class="p">,</span>
</span><span id="__span-9-123"><a href="#__codelineno-9-123" id="__codelineno-9-123" name="__codelineno-9-123"></a>                        <span class="n">status</span><span class="o">=</span><span class="n">FileStatus</span><span class="o">.</span><span class="n">PROCESSING</span>
</span><span id="__span-9-124"><a href="#__codelineno-9-124" id="__codelineno-9-124" name="__codelineno-9-124"></a>                    <span class="p">)</span>
</span><span id="__span-9-125"><a href="#__codelineno-9-125" id="__codelineno-9-125" name="__codelineno-9-125"></a>                <span class="p">)</span>
</span><span id="__span-9-126"><a href="#__codelineno-9-126" id="__codelineno-9-126" name="__codelineno-9-126"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-9-127"><a href="#__codelineno-9-127" id="__codelineno-9-127" name="__codelineno-9-127"></a>
</span><span id="__span-9-128"><a href="#__codelineno-9-128" id="__codelineno-9-128" name="__codelineno-9-128"></a>            <span class="c1"># Schedule background processing</span>
</span><span id="__span-9-129"><a href="#__codelineno-9-129" id="__codelineno-9-129" name="__codelineno-9-129"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_background_processing</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="__span-9-130"><a href="#__codelineno-9-130" id="__codelineno-9-130" name="__codelineno-9-130"></a>
</span><span id="__span-9-131"><a href="#__codelineno-9-131" id="__codelineno-9-131" name="__codelineno-9-131"></a>            <span class="k">return</span> <span class="n">UploadResult</span><span class="p">(</span>
</span><span id="__span-9-132"><a href="#__codelineno-9-132" id="__codelineno-9-132" name="__codelineno-9-132"></a>                <span class="n">file_id</span><span class="o">=</span><span class="n">file_id</span><span class="p">,</span>
</span><span id="__span-9-133"><a href="#__codelineno-9-133" id="__codelineno-9-133" name="__codelineno-9-133"></a>                <span class="n">filename</span><span class="o">=</span><span class="n">file_record</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
</span><span id="__span-9-134"><a href="#__codelineno-9-134" id="__codelineno-9-134" name="__codelineno-9-134"></a>                <span class="n">file_size</span><span class="o">=</span><span class="n">file_size</span><span class="p">,</span>
</span><span id="__span-9-135"><a href="#__codelineno-9-135" id="__codelineno-9-135" name="__codelineno-9-135"></a>                <span class="n">mime_type</span><span class="o">=</span><span class="n">mime_type</span><span class="p">,</span>
</span><span id="__span-9-136"><a href="#__codelineno-9-136" id="__codelineno-9-136" name="__codelineno-9-136"></a>                <span class="n">status</span><span class="o">=</span><span class="s2">"processing"</span><span class="p">,</span>
</span><span id="__span-9-137"><a href="#__codelineno-9-137" id="__codelineno-9-137" name="__codelineno-9-137"></a>                <span class="n">cdn_url</span><span class="o">=</span><span class="n">cdn_url</span><span class="p">,</span>
</span><span id="__span-9-138"><a href="#__codelineno-9-138" id="__codelineno-9-138" name="__codelineno-9-138"></a>                <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">,</span>
</span><span id="__span-9-139"><a href="#__codelineno-9-139" id="__codelineno-9-139" name="__codelineno-9-139"></a>                <span class="n">processing_eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_processing_time</span><span class="p">(</span><span class="n">file_size</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>
</span><span id="__span-9-140"><a href="#__codelineno-9-140" id="__codelineno-9-140" name="__codelineno-9-140"></a>            <span class="p">)</span>
</span><span id="__span-9-141"><a href="#__codelineno-9-141" id="__codelineno-9-141" name="__codelineno-9-141"></a>
</span><span id="__span-9-142"><a href="#__codelineno-9-142" id="__codelineno-9-142" name="__codelineno-9-142"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-143"><a href="#__codelineno-9-143" id="__codelineno-9-143" name="__codelineno-9-143"></a>            <span class="c1"># Update file status to error</span>
</span><span id="__span-9-144"><a href="#__codelineno-9-144" id="__codelineno-9-144" name="__codelineno-9-144"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-9-145"><a href="#__codelineno-9-145" id="__codelineno-9-145" name="__codelineno-9-145"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-9-146"><a href="#__codelineno-9-146" id="__codelineno-9-146" name="__codelineno-9-146"></a>                    <span class="n">update</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
</span><span id="__span-9-147"><a href="#__codelineno-9-147" id="__codelineno-9-147" name="__codelineno-9-147"></a>                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">file_id</span><span class="p">)</span>
</span><span id="__span-9-148"><a href="#__codelineno-9-148" id="__codelineno-9-148" name="__codelineno-9-148"></a>                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">FileStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</span><span id="__span-9-149"><a href="#__codelineno-9-149" id="__codelineno-9-149" name="__codelineno-9-149"></a>                <span class="p">)</span>
</span><span id="__span-9-150"><a href="#__codelineno-9-150" id="__codelineno-9-150" name="__codelineno-9-150"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-9-151"><a href="#__codelineno-9-151" id="__codelineno-9-151" name="__codelineno-9-151"></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="__span-9-152"><a href="#__codelineno-9-152" id="__codelineno-9-152" name="__codelineno-9-152"></a>
</span><span id="__span-9-153"><a href="#__codelineno-9-153" id="__codelineno-9-153" name="__codelineno-9-153"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_schedule_background_processing</span><span class="p">(</span>
</span><span id="__span-9-154"><a href="#__codelineno-9-154" id="__codelineno-9-154" name="__codelineno-9-154"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-9-155"><a href="#__codelineno-9-155" id="__codelineno-9-155" name="__codelineno-9-155"></a>        <span class="n">file_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-9-156"><a href="#__codelineno-9-156" id="__codelineno-9-156" name="__codelineno-9-156"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-9-157"><a href="#__codelineno-9-157" id="__codelineno-9-157" name="__codelineno-9-157"></a>        <span class="n">options</span><span class="p">:</span> <span class="n">UploadOptions</span>
</span><span id="__span-9-158"><a href="#__codelineno-9-158" id="__codelineno-9-158" name="__codelineno-9-158"></a>    <span class="p">):</span>
</span><span id="__span-9-159"><a href="#__codelineno-9-159" id="__codelineno-9-159" name="__codelineno-9-159"></a><span class="w">        </span><span class="sd">"""Schedule background processing tasks"""</span>
</span><span id="__span-9-160"><a href="#__codelineno-9-160" id="__codelineno-9-160" name="__codelineno-9-160"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.workers.tasks.storage_tasks</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-9-161"><a href="#__codelineno-9-161" id="__codelineno-9-161" name="__codelineno-9-161"></a>            <span class="n">virus_scan_file</span><span class="p">,</span>
</span><span id="__span-9-162"><a href="#__codelineno-9-162" id="__codelineno-9-162" name="__codelineno-9-162"></a>            <span class="n">process_image_variants</span><span class="p">,</span>
</span><span id="__span-9-163"><a href="#__codelineno-9-163" id="__codelineno-9-163" name="__codelineno-9-163"></a>            <span class="n">calculate_storage_usage</span>
</span><span id="__span-9-164"><a href="#__codelineno-9-164" id="__codelineno-9-164" name="__codelineno-9-164"></a>        <span class="p">)</span>
</span><span id="__span-9-165"><a href="#__codelineno-9-165" id="__codelineno-9-165" name="__codelineno-9-165"></a>
</span><span id="__span-9-166"><a href="#__codelineno-9-166" id="__codelineno-9-166" name="__codelineno-9-166"></a>        <span class="c1"># Virus scanning (always for security)</span>
</span><span id="__span-9-167"><a href="#__codelineno-9-167" id="__codelineno-9-167" name="__codelineno-9-167"></a>        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">virus_scan</span><span class="p">:</span>
</span><span id="__span-9-168"><a href="#__codelineno-9-168" id="__codelineno-9-168" name="__codelineno-9-168"></a>            <span class="n">virus_scan_file</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span>
</span><span id="__span-9-169"><a href="#__codelineno-9-169" id="__codelineno-9-169" name="__codelineno-9-169"></a>                <span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span>
</span><span id="__span-9-170"><a href="#__codelineno-9-170" id="__codelineno-9-170" name="__codelineno-9-170"></a>                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-9-171"><a href="#__codelineno-9-171" id="__codelineno-9-171" name="__codelineno-9-171"></a>            <span class="p">)</span>
</span><span id="__span-9-172"><a href="#__codelineno-9-172" id="__codelineno-9-172" name="__codelineno-9-172"></a>
</span><span id="__span-9-173"><a href="#__codelineno-9-173" id="__codelineno-9-173" name="__codelineno-9-173"></a>        <span class="c1"># Image processing</span>
</span><span id="__span-9-174"><a href="#__codelineno-9-174" id="__codelineno-9-174" name="__codelineno-9-174"></a>        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">generate_thumbnails</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">optimize_images</span><span class="p">:</span>
</span><span id="__span-9-175"><a href="#__codelineno-9-175" id="__codelineno-9-175" name="__codelineno-9-175"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_image_file</span><span class="p">(</span><span class="n">file_data</span><span class="p">):</span>
</span><span id="__span-9-176"><a href="#__codelineno-9-176" id="__codelineno-9-176" name="__codelineno-9-176"></a>                <span class="n">process_image_variants</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span>
</span><span id="__span-9-177"><a href="#__codelineno-9-177" id="__codelineno-9-177" name="__codelineno-9-177"></a>                    <span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">),</span>
</span><span id="__span-9-178"><a href="#__codelineno-9-178" id="__codelineno-9-178" name="__codelineno-9-178"></a>                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="p">),</span>
</span><span id="__span-9-179"><a href="#__codelineno-9-179" id="__codelineno-9-179" name="__codelineno-9-179"></a>                    <span class="p">{</span>
</span><span id="__span-9-180"><a href="#__codelineno-9-180" id="__codelineno-9-180" name="__codelineno-9-180"></a>                        <span class="s2">"generate_thumbnails"</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">generate_thumbnails</span><span class="p">,</span>
</span><span id="__span-9-181"><a href="#__codelineno-9-181" id="__codelineno-9-181" name="__codelineno-9-181"></a>                        <span class="s2">"optimize"</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">optimize_images</span>
</span><span id="__span-9-182"><a href="#__codelineno-9-182" id="__codelineno-9-182" name="__codelineno-9-182"></a>                    <span class="p">}</span>
</span><span id="__span-9-183"><a href="#__codelineno-9-183" id="__codelineno-9-183" name="__codelineno-9-183"></a>                <span class="p">)</span>
</span><span id="__span-9-184"><a href="#__codelineno-9-184" id="__codelineno-9-184" name="__codelineno-9-184"></a>
</span><span id="__span-9-185"><a href="#__codelineno-9-185" id="__codelineno-9-185" name="__codelineno-9-185"></a>        <span class="c1"># Update storage usage</span>
</span><span id="__span-9-186"><a href="#__codelineno-9-186" id="__codelineno-9-186" name="__codelineno-9-186"></a>        <span class="n">calculate_storage_usage</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="p">))</span>
</span><span id="__span-9-187"><a href="#__codelineno-9-187" id="__codelineno-9-187" name="__codelineno-9-187"></a>
</span><span id="__span-9-188"><a href="#__codelineno-9-188" id="__codelineno-9-188" name="__codelineno-9-188"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_storage_path</span><span class="p">(</span>
</span><span id="__span-9-189"><a href="#__codelineno-9-189" id="__codelineno-9-189" name="__codelineno-9-189"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-9-190"><a href="#__codelineno-9-190" id="__codelineno-9-190" name="__codelineno-9-190"></a>        <span class="n">file_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-9-191"><a href="#__codelineno-9-191" id="__codelineno-9-191" name="__codelineno-9-191"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-9-192"><a href="#__codelineno-9-192" id="__codelineno-9-192" name="__codelineno-9-192"></a>        <span class="n">category</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-193"><a href="#__codelineno-9-193" id="__codelineno-9-193" name="__codelineno-9-193"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-9-194"><a href="#__codelineno-9-194" id="__codelineno-9-194" name="__codelineno-9-194"></a><span class="w">        </span><span class="sd">"""Generate organized storage path"""</span>
</span><span id="__span-9-195"><a href="#__codelineno-9-195" id="__codelineno-9-195" name="__codelineno-9-195"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-9-196"><a href="#__codelineno-9-196" id="__codelineno-9-196" name="__codelineno-9-196"></a>        <span class="n">sanitized_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="__span-9-197"><a href="#__codelineno-9-197" id="__codelineno-9-197" name="__codelineno-9-197"></a>
</span><span id="__span-9-198"><a href="#__codelineno-9-198" id="__codelineno-9-198" name="__codelineno-9-198"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-9-199"><a href="#__codelineno-9-199" id="__codelineno-9-199" name="__codelineno-9-199"></a>            <span class="sa">f</span><span class="s2">"org_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">/"</span>
</span><span id="__span-9-200"><a href="#__codelineno-9-200" id="__codelineno-9-200" name="__codelineno-9-200"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">/"</span>
</span><span id="__span-9-201"><a href="#__codelineno-9-201" id="__codelineno-9-201" name="__codelineno-9-201"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">/"</span>
</span><span id="__span-9-202"><a href="#__codelineno-9-202" id="__codelineno-9-202" name="__codelineno-9-202"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">/"</span>
</span><span id="__span-9-203"><a href="#__codelineno-9-203" id="__codelineno-9-203" name="__codelineno-9-203"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sanitized_filename</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-9-204"><a href="#__codelineno-9-204" id="__codelineno-9-204" name="__codelineno-9-204"></a>        <span class="p">)</span>
</span><span id="__span-9-205"><a href="#__codelineno-9-205" id="__codelineno-9-205" name="__codelineno-9-205"></a>
</span><span id="__span-9-206"><a href="#__codelineno-9-206" id="__codelineno-9-206" name="__codelineno-9-206"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-9-207"><a href="#__codelineno-9-207" id="__codelineno-9-207" name="__codelineno-9-207"></a><span class="w">        </span><span class="sd">"""Sanitize filename for safe storage"""</span>
</span><span id="__span-9-208"><a href="#__codelineno-9-208" id="__codelineno-9-208" name="__codelineno-9-208"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-9-209"><a href="#__codelineno-9-209" id="__codelineno-9-209" name="__codelineno-9-209"></a>        <span class="c1"># Remove or replace unsafe characters</span>
</span><span id="__span-9-210"><a href="#__codelineno-9-210" id="__codelineno-9-210" name="__codelineno-9-210"></a>        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[^a-zA-Z0-9._-]'</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-9-211"><a href="#__codelineno-9-211" id="__codelineno-9-211" name="__codelineno-9-211"></a>        <span class="c1"># Limit length</span>
</span><span id="__span-9-212"><a href="#__codelineno-9-212" id="__codelineno-9-212" name="__codelineno-9-212"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="__span-9-213"><a href="#__codelineno-9-213" id="__codelineno-9-213" name="__codelineno-9-213"></a>            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span>
</span><span id="__span-9-214"><a href="#__codelineno-9-214" id="__codelineno-9-214" name="__codelineno-9-214"></a>            <span class="n">sanitized</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">95</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>
</span><span id="__span-9-215"><a href="#__codelineno-9-215" id="__codelineno-9-215" name="__codelineno-9-215"></a>        <span class="k">return</span> <span class="n">sanitized</span>
</span><span id="__span-9-216"><a href="#__codelineno-9-216" id="__codelineno-9-216" name="__codelineno-9-216"></a>
</span><span id="__span-9-217"><a href="#__codelineno-9-217" id="__codelineno-9-217" name="__codelineno-9-217"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_bucket_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-218"><a href="#__codelineno-9-218" id="__codelineno-9-218" name="__codelineno-9-218"></a><span class="w">        </span><span class="sd">"""Ensure organization bucket exists"""</span>
</span><span id="__span-9-219"><a href="#__codelineno-9-219" id="__codelineno-9-219" name="__codelineno-9-219"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-220"><a href="#__codelineno-9-220" id="__codelineno-9-220" name="__codelineno-9-220"></a>            <span class="c1"># Check if bucket exists</span>
</span><span id="__span-9-221"><a href="#__codelineno-9-221" id="__codelineno-9-221" name="__codelineno-9-221"></a>            <span class="n">buckets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
</span><span id="__span-9-222"><a href="#__codelineno-9-222" id="__codelineno-9-222" name="__codelineno-9-222"></a>            <span class="n">bucket_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">bucket</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">]</span>
</span><span id="__span-9-223"><a href="#__codelineno-9-223" id="__codelineno-9-223" name="__codelineno-9-223"></a>
</span><span id="__span-9-224"><a href="#__codelineno-9-224" id="__codelineno-9-224" name="__codelineno-9-224"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bucket_names</span><span class="p">:</span>
</span><span id="__span-9-225"><a href="#__codelineno-9-225" id="__codelineno-9-225" name="__codelineno-9-225"></a>                <span class="c1"># Create bucket with proper policies</span>
</span><span id="__span-9-226"><a href="#__codelineno-9-226" id="__codelineno-9-226" name="__codelineno-9-226"></a>                <span class="n">create_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
</span><span id="__span-9-227"><a href="#__codelineno-9-227" id="__codelineno-9-227" name="__codelineno-9-227"></a>                    <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-9-228"><a href="#__codelineno-9-228" id="__codelineno-9-228" name="__codelineno-9-228"></a>                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-9-229"><a href="#__codelineno-9-229" id="__codelineno-9-229" name="__codelineno-9-229"></a>                    <span class="n">options</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-9-230"><a href="#__codelineno-9-230" id="__codelineno-9-230" name="__codelineno-9-230"></a>                        <span class="s2">"public"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Private by default</span>
</span><span id="__span-9-231"><a href="#__codelineno-9-231" id="__codelineno-9-231" name="__codelineno-9-231"></a>                        <span class="s2">"file_size_limit"</span><span class="p">:</span> <span class="mi">1073741824</span><span class="p">,</span>  <span class="c1"># 1GB</span>
</span><span id="__span-9-232"><a href="#__codelineno-9-232" id="__codelineno-9-232" name="__codelineno-9-232"></a>                        <span class="s2">"allowed_mime_types"</span><span class="p">:</span> <span class="kc">None</span>  <span class="c1"># Allow all for now</span>
</span><span id="__span-9-233"><a href="#__codelineno-9-233" id="__codelineno-9-233" name="__codelineno-9-233"></a>                    <span class="p">}</span>
</span><span id="__span-9-234"><a href="#__codelineno-9-234" id="__codelineno-9-234" name="__codelineno-9-234"></a>                <span class="p">)</span>
</span><span id="__span-9-235"><a href="#__codelineno-9-235" id="__codelineno-9-235" name="__codelineno-9-235"></a>
</span><span id="__span-9-236"><a href="#__codelineno-9-236" id="__codelineno-9-236" name="__codelineno-9-236"></a>                <span class="k">if</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error"</span><span class="p">):</span>
</span><span id="__span-9-237"><a href="#__codelineno-9-237" id="__codelineno-9-237" name="__codelineno-9-237"></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to create bucket: </span><span class="si">{</span><span class="n">create_response</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-9-238"><a href="#__codelineno-9-238" id="__codelineno-9-238" name="__codelineno-9-238"></a>
</span><span id="__span-9-239"><a href="#__codelineno-9-239" id="__codelineno-9-239" name="__codelineno-9-239"></a>                <span class="c1"># Set up bucket policies</span>
</span><span id="__span-9-240"><a href="#__codelineno-9-240" id="__codelineno-9-240" name="__codelineno-9-240"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_bucket_policies</span><span class="p">()</span>
</span><span id="__span-9-241"><a href="#__codelineno-9-241" id="__codelineno-9-241" name="__codelineno-9-241"></a>
</span><span id="__span-9-242"><a href="#__codelineno-9-242" id="__codelineno-9-242" name="__codelineno-9-242"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-243"><a href="#__codelineno-9-243" id="__codelineno-9-243" name="__codelineno-9-243"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to ensure bucket exists: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-9-244"><a href="#__codelineno-9-244" id="__codelineno-9-244" name="__codelineno-9-244"></a>            <span class="k">raise</span>
</span><span id="__span-9-245"><a href="#__codelineno-9-245" id="__codelineno-9-245" name="__codelineno-9-245"></a>
</span><span id="__span-9-246"><a href="#__codelineno-9-246" id="__codelineno-9-246" name="__codelineno-9-246"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_configure_bucket_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-247"><a href="#__codelineno-9-247" id="__codelineno-9-247" name="__codelineno-9-247"></a><span class="w">        </span><span class="sd">"""Configure RLS policies for the bucket"""</span>
</span><span id="__span-9-248"><a href="#__codelineno-9-248" id="__codelineno-9-248" name="__codelineno-9-248"></a>        <span class="c1"># This would typically be done via Supabase SQL editor or migration</span>
</span><span id="__span-9-249"><a href="#__codelineno-9-249" id="__codelineno-9-249" name="__codelineno-9-249"></a>        <span class="c1"># Policies ensure organization isolation at the storage level</span>
</span><span id="__span-9-250"><a href="#__codelineno-9-250" id="__codelineno-9-250" name="__codelineno-9-250"></a>        <span class="n">policies_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span>
</span><span id="__span-9-251"><a href="#__codelineno-9-251" id="__codelineno-9-251" name="__codelineno-9-251"></a><span class="s2">        -- Allow organization members to read their files</span>
</span><span id="__span-9-252"><a href="#__codelineno-9-252" id="__codelineno-9-252" name="__codelineno-9-252"></a><span class="s2">        CREATE POLICY "org_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">_read" ON storage.objects</span>
</span><span id="__span-9-253"><a href="#__codelineno-9-253" id="__codelineno-9-253" name="__codelineno-9-253"></a><span class="s2">        FOR SELECT USING (</span>
</span><span id="__span-9-254"><a href="#__codelineno-9-254" id="__codelineno-9-254" name="__codelineno-9-254"></a><span class="s2">            bucket_id = '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">'</span>
</span><span id="__span-9-255"><a href="#__codelineno-9-255" id="__codelineno-9-255" name="__codelineno-9-255"></a><span class="s2">            AND auth.uid()::text IN (</span>
</span><span id="__span-9-256"><a href="#__codelineno-9-256" id="__codelineno-9-256" name="__codelineno-9-256"></a><span class="s2">                SELECT user_id::text FROM organization_members</span>
</span><span id="__span-9-257"><a href="#__codelineno-9-257" id="__codelineno-9-257" name="__codelineno-9-257"></a><span class="s2">                WHERE organization_id = '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">'::uuid</span>
</span><span id="__span-9-258"><a href="#__codelineno-9-258" id="__codelineno-9-258" name="__codelineno-9-258"></a><span class="s2">            )</span>
</span><span id="__span-9-259"><a href="#__codelineno-9-259" id="__codelineno-9-259" name="__codelineno-9-259"></a><span class="s2">        );</span>
</span><span id="__span-9-260"><a href="#__codelineno-9-260" id="__codelineno-9-260" name="__codelineno-9-260"></a>
</span><span id="__span-9-261"><a href="#__codelineno-9-261" id="__codelineno-9-261" name="__codelineno-9-261"></a><span class="s2">        -- Allow organization members to upload files</span>
</span><span id="__span-9-262"><a href="#__codelineno-9-262" id="__codelineno-9-262" name="__codelineno-9-262"></a><span class="s2">        CREATE POLICY "org_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">_upload" ON storage.objects</span>
</span><span id="__span-9-263"><a href="#__codelineno-9-263" id="__codelineno-9-263" name="__codelineno-9-263"></a><span class="s2">        FOR INSERT WITH CHECK (</span>
</span><span id="__span-9-264"><a href="#__codelineno-9-264" id="__codelineno-9-264" name="__codelineno-9-264"></a><span class="s2">            bucket_id = '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">'</span>
</span><span id="__span-9-265"><a href="#__codelineno-9-265" id="__codelineno-9-265" name="__codelineno-9-265"></a><span class="s2">            AND auth.uid()::text IN (</span>
</span><span id="__span-9-266"><a href="#__codelineno-9-266" id="__codelineno-9-266" name="__codelineno-9-266"></a><span class="s2">                SELECT user_id::text FROM organization_members</span>
</span><span id="__span-9-267"><a href="#__codelineno-9-267" id="__codelineno-9-267" name="__codelineno-9-267"></a><span class="s2">                WHERE organization_id = '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">'::uuid</span>
</span><span id="__span-9-268"><a href="#__codelineno-9-268" id="__codelineno-9-268" name="__codelineno-9-268"></a><span class="s2">            )</span>
</span><span id="__span-9-269"><a href="#__codelineno-9-269" id="__codelineno-9-269" name="__codelineno-9-269"></a><span class="s2">        );</span>
</span><span id="__span-9-270"><a href="#__codelineno-9-270" id="__codelineno-9-270" name="__codelineno-9-270"></a><span class="s2">        """</span>
</span><span id="__span-9-271"><a href="#__codelineno-9-271" id="__codelineno-9-271" name="__codelineno-9-271"></a>
</span><span id="__span-9-272"><a href="#__codelineno-9-272" id="__codelineno-9-272" name="__codelineno-9-272"></a>        <span class="c1"># Execute via Supabase RPC or direct SQL</span>
</span><span id="__span-9-273"><a href="#__codelineno-9-273" id="__codelineno-9-273" name="__codelineno-9-273"></a>        <span class="c1"># Implementation depends on your Supabase setup</span>
</span></code></pre></div> <h2 id="multi-tenant-bucket-management">Multi-Tenant Bucket Management<a class="headerlink" href="#multi-tenant-bucket-management" title="Permanent link">¶</a></h2> <h3 id="bucket-naming-strategy">Bucket Naming Strategy<a class="headerlink" href="#bucket-naming-strategy" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TenantStorageManager</span><span class="p">:</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="sd">"""Manages multi-tenant storage buckets and quotas"""</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">supabase_client</span><span class="p">:</span> <span class="n">Client</span><span class="p">):</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span> <span class="o">=</span> <span class="n">supabase_client</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bucket_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">        </span><span class="sd">"""Generate organization-specific bucket name"""</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="c1"># Remove hyphens and use prefix for clarity</span>
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="n">org_id_clean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span><span id="__span-10-11"><a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"toolboxai-org-</span><span class="si">{</span><span class="n">org_id_clean</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-12"><a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>
</span><span id="__span-10-13"><a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_organization_bucket</span><span class="p">(</span>
</span><span id="__span-10-14"><a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-10-15"><a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-10-16"><a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="n">quota_gb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-10-17"><a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-10-18"><a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">        </span><span class="sd">"""Create a new bucket for an organization"""</span>
</span><span id="__span-10-19"><a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="n">bucket_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-10-20"><a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>
</span><span id="__span-10-21"><a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-22"><a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a>            <span class="c1"># Create bucket</span>
</span><span id="__span-10-23"><a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a>            <span class="n">create_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supabase</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span>
</span><span id="__span-10-24"><a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a>                <span class="nb">id</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-10-25"><a href="#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a>                <span class="n">name</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-10-26"><a href="#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a>                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-10-27"><a href="#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a>                    <span class="s2">"public"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-10-28"><a href="#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a>                    <span class="s2">"file_size_limit"</span><span class="p">:</span> <span class="n">quota_gb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># Convert GB to bytes</span>
</span><span id="__span-10-29"><a href="#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a>                    <span class="s2">"allowed_mime_types"</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="__span-10-30"><a href="#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a>                <span class="p">}</span>
</span><span id="__span-10-31"><a href="#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a>            <span class="p">)</span>
</span><span id="__span-10-32"><a href="#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a>
</span><span id="__span-10-33"><a href="#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a>            <span class="k">if</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error"</span><span class="p">):</span>
</span><span id="__span-10-34"><a href="#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to create bucket: </span><span class="si">{</span><span class="n">create_response</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-35"><a href="#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a>
</span><span id="__span-10-36"><a href="#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a>            <span class="c1"># Create storage quota record</span>
</span><span id="__span-10-37"><a href="#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a>            <span class="n">quota_record</span> <span class="o">=</span> <span class="n">StorageQuota</span><span class="p">(</span>
</span><span id="__span-10-38"><a href="#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a>                <span class="n">organization_id</span><span class="o">=</span><span class="n">organization_id</span><span class="p">,</span>
</span><span id="__span-10-39"><a href="#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a>                <span class="n">total_quota</span><span class="o">=</span><span class="n">quota_gb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="__span-10-40"><a href="#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a>                <span class="n">max_files</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
</span><span id="__span-10-41"><a href="#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a>                <span class="n">max_file_size_mb</span><span class="o">=</span><span class="mi">100</span>
</span><span id="__span-10-42"><a href="#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a>            <span class="p">)</span>
</span><span id="__span-10-43"><a href="#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a>
</span><span id="__span-10-44"><a href="#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-10-45"><a href="#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">quota_record</span><span class="p">)</span>
</span><span id="__span-10-46"><a href="#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-10-47"><a href="#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a>
</span><span id="__span-10-48"><a href="#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a>            <span class="c1"># Configure bucket policies</span>
</span><span id="__span-10-49"><a href="#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_bucket_policies</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
</span><span id="__span-10-50"><a href="#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a>
</span><span id="__span-10-51"><a href="#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-10-52"><a href="#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a>                <span class="s2">"bucket_name"</span><span class="p">:</span> <span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-10-53"><a href="#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a>                <span class="s2">"quota_gb"</span><span class="p">:</span> <span class="n">quota_gb</span><span class="p">,</span>
</span><span id="__span-10-54"><a href="#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a>                <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"created"</span>
</span><span id="__span-10-55"><a href="#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a>            <span class="p">}</span>
</span><span id="__span-10-56"><a href="#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a>
</span><span id="__span-10-57"><a href="#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-10-58"><a href="#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to create organization bucket: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-59"><a href="#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a>            <span class="k">raise</span>
</span><span id="__span-10-60"><a href="#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a>
</span><span id="__span-10-61"><a href="#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_storage_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-10-62"><a href="#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">        </span><span class="sd">"""Get comprehensive storage usage for organization"""</span>
</span><span id="__span-10-63"><a href="#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-10-64"><a href="#__codelineno-10-64" id="__codelineno-10-64" name="__codelineno-10-64"></a>            <span class="c1"># Get quota information</span>
</span><span id="__span-10-65"><a href="#__codelineno-10-65" id="__codelineno-10-65" name="__codelineno-10-65"></a>            <span class="n">quota</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-10-66"><a href="#__codelineno-10-66" id="__codelineno-10-66" name="__codelineno-10-66"></a>                <span class="n">select</span><span class="p">(</span><span class="n">StorageQuota</span><span class="p">)</span>
</span><span id="__span-10-67"><a href="#__codelineno-10-67" id="__codelineno-10-67" name="__codelineno-10-67"></a>                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">StorageQuota</span><span class="o">.</span><span class="n">organization_id</span> <span class="o">==</span> <span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-10-68"><a href="#__codelineno-10-68" id="__codelineno-10-68" name="__codelineno-10-68"></a>            <span class="p">)</span>
</span><span id="__span-10-69"><a href="#__codelineno-10-69" id="__codelineno-10-69" name="__codelineno-10-69"></a>            <span class="n">quota_record</span> <span class="o">=</span> <span class="n">quota</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
</span><span id="__span-10-70"><a href="#__codelineno-10-70" id="__codelineno-10-70" name="__codelineno-10-70"></a>
</span><span id="__span-10-71"><a href="#__codelineno-10-71" id="__codelineno-10-71" name="__codelineno-10-71"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">quota_record</span><span class="p">:</span>
</span><span id="__span-10-72"><a href="#__codelineno-10-72" id="__codelineno-10-72" name="__codelineno-10-72"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No quota record found for organization </span><span class="si">{</span><span class="n">organization_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-73"><a href="#__codelineno-10-73" id="__codelineno-10-73" name="__codelineno-10-73"></a>
</span><span id="__span-10-74"><a href="#__codelineno-10-74" id="__codelineno-10-74" name="__codelineno-10-74"></a>            <span class="c1"># Get detailed usage by category</span>
</span><span id="__span-10-75"><a href="#__codelineno-10-75" id="__codelineno-10-75" name="__codelineno-10-75"></a>            <span class="n">usage_query</span> <span class="o">=</span> <span class="s2">"""</span>
</span><span id="__span-10-76"><a href="#__codelineno-10-76" id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="s2">            SELECT</span>
</span><span id="__span-10-77"><a href="#__codelineno-10-77" id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="s2">                category,</span>
</span><span id="__span-10-78"><a href="#__codelineno-10-78" id="__codelineno-10-78" name="__codelineno-10-78"></a><span class="s2">                COUNT(*) as file_count,</span>
</span><span id="__span-10-79"><a href="#__codelineno-10-79" id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="s2">                SUM(file_size) as total_size,</span>
</span><span id="__span-10-80"><a href="#__codelineno-10-80" id="__codelineno-10-80" name="__codelineno-10-80"></a><span class="s2">                AVG(file_size) as avg_size</span>
</span><span id="__span-10-81"><a href="#__codelineno-10-81" id="__codelineno-10-81" name="__codelineno-10-81"></a><span class="s2">            FROM files</span>
</span><span id="__span-10-82"><a href="#__codelineno-10-82" id="__codelineno-10-82" name="__codelineno-10-82"></a><span class="s2">            WHERE organization_id = :org_id</span>
</span><span id="__span-10-83"><a href="#__codelineno-10-83" id="__codelineno-10-83" name="__codelineno-10-83"></a><span class="s2">                AND status != 'deleted'</span>
</span><span id="__span-10-84"><a href="#__codelineno-10-84" id="__codelineno-10-84" name="__codelineno-10-84"></a><span class="s2">            GROUP BY category</span>
</span><span id="__span-10-85"><a href="#__codelineno-10-85" id="__codelineno-10-85" name="__codelineno-10-85"></a><span class="s2">            """</span>
</span><span id="__span-10-86"><a href="#__codelineno-10-86" id="__codelineno-10-86" name="__codelineno-10-86"></a>
</span><span id="__span-10-87"><a href="#__codelineno-10-87" id="__codelineno-10-87" name="__codelineno-10-87"></a>            <span class="n">usage_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-10-88"><a href="#__codelineno-10-88" id="__codelineno-10-88" name="__codelineno-10-88"></a>                <span class="n">text</span><span class="p">(</span><span class="n">usage_query</span><span class="p">),</span>
</span><span id="__span-10-89"><a href="#__codelineno-10-89" id="__codelineno-10-89" name="__codelineno-10-89"></a>                <span class="p">{</span><span class="s2">"org_id"</span><span class="p">:</span> <span class="n">organization_id</span><span class="p">}</span>
</span><span id="__span-10-90"><a href="#__codelineno-10-90" id="__codelineno-10-90" name="__codelineno-10-90"></a>            <span class="p">)</span>
</span><span id="__span-10-91"><a href="#__codelineno-10-91" id="__codelineno-10-91" name="__codelineno-10-91"></a>
</span><span id="__span-10-92"><a href="#__codelineno-10-92" id="__codelineno-10-92" name="__codelineno-10-92"></a>            <span class="n">usage_by_category</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-10-93"><a href="#__codelineno-10-93" id="__codelineno-10-93" name="__codelineno-10-93"></a>            <span class="n">total_files</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-10-94"><a href="#__codelineno-10-94" id="__codelineno-10-94" name="__codelineno-10-94"></a>            <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-10-95"><a href="#__codelineno-10-95" id="__codelineno-10-95" name="__codelineno-10-95"></a>
</span><span id="__span-10-96"><a href="#__codelineno-10-96" id="__codelineno-10-96" name="__codelineno-10-96"></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">usage_result</span><span class="p">:</span>
</span><span id="__span-10-97"><a href="#__codelineno-10-97" id="__codelineno-10-97" name="__codelineno-10-97"></a>                <span class="n">category_usage</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-10-98"><a href="#__codelineno-10-98" id="__codelineno-10-98" name="__codelineno-10-98"></a>                    <span class="s2">"file_count"</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">file_count</span><span class="p">,</span>
</span><span id="__span-10-99"><a href="#__codelineno-10-99" id="__codelineno-10-99" name="__codelineno-10-99"></a>                    <span class="s2">"total_size"</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">total_size</span><span class="p">,</span>
</span><span id="__span-10-100"><a href="#__codelineno-10-100" id="__codelineno-10-100" name="__codelineno-10-100"></a>                    <span class="s2">"average_size"</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">avg_size</span><span class="p">,</span>
</span><span id="__span-10-101"><a href="#__codelineno-10-101" id="__codelineno-10-101" name="__codelineno-10-101"></a>                    <span class="s2">"total_size_mb"</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">total_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
</span><span id="__span-10-102"><a href="#__codelineno-10-102" id="__codelineno-10-102" name="__codelineno-10-102"></a>                    <span class="s2">"percentage_of_total"</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># Calculate below</span>
</span><span id="__span-10-103"><a href="#__codelineno-10-103" id="__codelineno-10-103" name="__codelineno-10-103"></a>                <span class="p">}</span>
</span><span id="__span-10-104"><a href="#__codelineno-10-104" id="__codelineno-10-104" name="__codelineno-10-104"></a>                <span class="n">usage_by_category</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_usage</span>
</span><span id="__span-10-105"><a href="#__codelineno-10-105" id="__codelineno-10-105" name="__codelineno-10-105"></a>                <span class="n">total_files</span> <span class="o">+=</span> <span class="n">row</span><span class="o">.</span><span class="n">file_count</span>
</span><span id="__span-10-106"><a href="#__codelineno-10-106" id="__codelineno-10-106" name="__codelineno-10-106"></a>                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">row</span><span class="o">.</span><span class="n">total_size</span>
</span><span id="__span-10-107"><a href="#__codelineno-10-107" id="__codelineno-10-107" name="__codelineno-10-107"></a>
</span><span id="__span-10-108"><a href="#__codelineno-10-108" id="__codelineno-10-108" name="__codelineno-10-108"></a>            <span class="c1"># Calculate percentages</span>
</span><span id="__span-10-109"><a href="#__codelineno-10-109" id="__codelineno-10-109" name="__codelineno-10-109"></a>            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">usage_by_category</span><span class="p">:</span>
</span><span id="__span-10-110"><a href="#__codelineno-10-110" id="__codelineno-10-110" name="__codelineno-10-110"></a>                <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-10-111"><a href="#__codelineno-10-111" id="__codelineno-10-111" name="__codelineno-10-111"></a>                    <span class="n">usage_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s2">"percentage_of_total"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-10-112"><a href="#__codelineno-10-112" id="__codelineno-10-112" name="__codelineno-10-112"></a>                        <span class="n">usage_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s2">"total_size"</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_size</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="__span-10-113"><a href="#__codelineno-10-113" id="__codelineno-10-113" name="__codelineno-10-113"></a>                    <span class="p">)</span>
</span><span id="__span-10-114"><a href="#__codelineno-10-114" id="__codelineno-10-114" name="__codelineno-10-114"></a>
</span><span id="__span-10-115"><a href="#__codelineno-10-115" id="__codelineno-10-115" name="__codelineno-10-115"></a>            <span class="c1"># Update quota record if needed</span>
</span><span id="__span-10-116"><a href="#__codelineno-10-116" id="__codelineno-10-116" name="__codelineno-10-116"></a>            <span class="k">if</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">used_storage</span> <span class="o">!=</span> <span class="n">total_size</span> <span class="ow">or</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">file_count</span> <span class="o">!=</span> <span class="n">total_files</span><span class="p">:</span>
</span><span id="__span-10-117"><a href="#__codelineno-10-117" id="__codelineno-10-117" name="__codelineno-10-117"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-10-118"><a href="#__codelineno-10-118" id="__codelineno-10-118" name="__codelineno-10-118"></a>                    <span class="n">update</span><span class="p">(</span><span class="n">StorageQuota</span><span class="p">)</span>
</span><span id="__span-10-119"><a href="#__codelineno-10-119" id="__codelineno-10-119" name="__codelineno-10-119"></a>                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">StorageQuota</span><span class="o">.</span><span class="n">organization_id</span> <span class="o">==</span> <span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-10-120"><a href="#__codelineno-10-120" id="__codelineno-10-120" name="__codelineno-10-120"></a>                    <span class="o">.</span><span class="n">values</span><span class="p">(</span>
</span><span id="__span-10-121"><a href="#__codelineno-10-121" id="__codelineno-10-121" name="__codelineno-10-121"></a>                        <span class="n">used_storage</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span>
</span><span id="__span-10-122"><a href="#__codelineno-10-122" id="__codelineno-10-122" name="__codelineno-10-122"></a>                        <span class="n">file_count</span><span class="o">=</span><span class="n">total_files</span><span class="p">,</span>
</span><span id="__span-10-123"><a href="#__codelineno-10-123" id="__codelineno-10-123" name="__codelineno-10-123"></a>                        <span class="n">last_calculated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-10-124"><a href="#__codelineno-10-124" id="__codelineno-10-124" name="__codelineno-10-124"></a>                    <span class="p">)</span>
</span><span id="__span-10-125"><a href="#__codelineno-10-125" id="__codelineno-10-125" name="__codelineno-10-125"></a>                <span class="p">)</span>
</span><span id="__span-10-126"><a href="#__codelineno-10-126" id="__codelineno-10-126" name="__codelineno-10-126"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-10-127"><a href="#__codelineno-10-127" id="__codelineno-10-127" name="__codelineno-10-127"></a>
</span><span id="__span-10-128"><a href="#__codelineno-10-128" id="__codelineno-10-128" name="__codelineno-10-128"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-10-129"><a href="#__codelineno-10-129" id="__codelineno-10-129" name="__codelineno-10-129"></a>                <span class="s2">"organization_id"</span><span class="p">:</span> <span class="n">organization_id</span><span class="p">,</span>
</span><span id="__span-10-130"><a href="#__codelineno-10-130" id="__codelineno-10-130" name="__codelineno-10-130"></a>                <span class="s2">"total_quota"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span><span class="p">,</span>
</span><span id="__span-10-131"><a href="#__codelineno-10-131" id="__codelineno-10-131" name="__codelineno-10-131"></a>                <span class="s2">"used_storage"</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
</span><span id="__span-10-132"><a href="#__codelineno-10-132" id="__codelineno-10-132" name="__codelineno-10-132"></a>                <span class="s2">"available_storage"</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span> <span class="o">-</span> <span class="n">total_size</span><span class="p">),</span>
</span><span id="__span-10-133"><a href="#__codelineno-10-133" id="__codelineno-10-133" name="__codelineno-10-133"></a>                <span class="s2">"used_percentage"</span><span class="p">:</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-134"><a href="#__codelineno-10-134" id="__codelineno-10-134" name="__codelineno-10-134"></a>                <span class="s2">"file_count"</span><span class="p">:</span> <span class="n">total_files</span><span class="p">,</span>
</span><span id="__span-10-135"><a href="#__codelineno-10-135" id="__codelineno-10-135" name="__codelineno-10-135"></a>                <span class="s2">"max_files"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">max_files</span><span class="p">,</span>
</span><span id="__span-10-136"><a href="#__codelineno-10-136" id="__codelineno-10-136" name="__codelineno-10-136"></a>                <span class="s2">"usage_by_category"</span><span class="p">:</span> <span class="n">usage_by_category</span><span class="p">,</span>
</span><span id="__span-10-137"><a href="#__codelineno-10-137" id="__codelineno-10-137" name="__codelineno-10-137"></a>                <span class="s2">"quota_limits"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-138"><a href="#__codelineno-10-138" id="__codelineno-10-138" name="__codelineno-10-138"></a>                    <span class="s2">"max_file_size_mb"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">max_file_size_mb</span><span class="p">,</span>
</span><span id="__span-10-139"><a href="#__codelineno-10-139" id="__codelineno-10-139" name="__codelineno-10-139"></a>                    <span class="s2">"max_video_size_mb"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">max_video_size_mb</span><span class="p">,</span>
</span><span id="__span-10-140"><a href="#__codelineno-10-140" id="__codelineno-10-140" name="__codelineno-10-140"></a>                    <span class="s2">"max_image_size_mb"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">max_image_size_mb</span><span class="p">,</span>
</span><span id="__span-10-141"><a href="#__codelineno-10-141" id="__codelineno-10-141" name="__codelineno-10-141"></a>                    <span class="s2">"max_document_size_mb"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">max_document_size_mb</span>
</span><span id="__span-10-142"><a href="#__codelineno-10-142" id="__codelineno-10-142" name="__codelineno-10-142"></a>                <span class="p">},</span>
</span><span id="__span-10-143"><a href="#__codelineno-10-143" id="__codelineno-10-143" name="__codelineno-10-143"></a>                <span class="s2">"alert_thresholds"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-144"><a href="#__codelineno-10-144" id="__codelineno-10-144" name="__codelineno-10-144"></a>                    <span class="s2">"warning_threshold"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">warning_threshold_percent</span><span class="p">,</span>
</span><span id="__span-10-145"><a href="#__codelineno-10-145" id="__codelineno-10-145" name="__codelineno-10-145"></a>                    <span class="s2">"critical_threshold"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">critical_threshold_percent</span><span class="p">,</span>
</span><span id="__span-10-146"><a href="#__codelineno-10-146" id="__codelineno-10-146" name="__codelineno-10-146"></a>                    <span class="s2">"is_warning_reached"</span><span class="p">:</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">warning_threshold_percent</span><span class="p">,</span>
</span><span id="__span-10-147"><a href="#__codelineno-10-147" id="__codelineno-10-147" name="__codelineno-10-147"></a>                    <span class="s2">"is_critical_reached"</span><span class="p">:</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">total_quota</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">critical_threshold_percent</span>
</span><span id="__span-10-148"><a href="#__codelineno-10-148" id="__codelineno-10-148" name="__codelineno-10-148"></a>                <span class="p">},</span>
</span><span id="__span-10-149"><a href="#__codelineno-10-149" id="__codelineno-10-149" name="__codelineno-10-149"></a>                <span class="s2">"last_calculated_at"</span><span class="p">:</span> <span class="n">quota_record</span><span class="o">.</span><span class="n">last_calculated_at</span>
</span><span id="__span-10-150"><a href="#__codelineno-10-150" id="__codelineno-10-150" name="__codelineno-10-150"></a>            <span class="p">}</span>
</span></code></pre></div> <h2 id="security-implementation">Security Implementation<a class="headerlink" href="#security-implementation" title="Permanent link">¶</a></h2> <h3 id="pii-detection-and-compliance">PII Detection and Compliance<a class="headerlink" href="#pii-detection-and-compliance" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">PIIType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="n">SSN</span> <span class="o">=</span> <span class="s2">"ssn"</span>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a>    <span class="n">EMAIL</span> <span class="o">=</span> <span class="s2">"email"</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="n">PHONE</span> <span class="o">=</span> <span class="s2">"phone"</span>
</span><span id="__span-11-10"><a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="n">CREDIT_CARD</span> <span class="o">=</span> <span class="s2">"credit_card"</span>
</span><span id="__span-11-11"><a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a>    <span class="n">STUDENT_ID</span> <span class="o">=</span> <span class="s2">"student_id"</span>
</span><span id="__span-11-12"><a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a>    <span class="n">DATE_OF_BIRTH</span> <span class="o">=</span> <span class="s2">"date_of_birth"</span>
</span><span id="__span-11-13"><a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="n">ADDRESS</span> <span class="o">=</span> <span class="s2">"address"</span>
</span><span id="__span-11-14"><a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a>
</span><span id="__span-11-15"><a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="nd">@dataclass</span>
</span><span id="__span-11-16"><a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">PIIDetectionResult</span><span class="p">:</span>
</span><span id="__span-11-17"><a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a>    <span class="n">has_pii</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-11-18"><a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a>    <span class="n">pii_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PIIType</span><span class="p">]</span>
</span><span id="__span-11-19"><a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>    <span class="n">confidence_score</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="__span-11-20"><a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a>    <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-11-21"><a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a>
</span><span id="__span-11-22"><a href="#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityManager</span><span class="p">:</span>
</span><span id="__span-11-23"><a href="#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">    </span><span class="sd">"""Handles security, compliance, and PII detection"""</span>
</span><span id="__span-11-24"><a href="#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a>
</span><span id="__span-11-25"><a href="#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encryption_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-11-26"><a href="#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_key</span> <span class="o">=</span> <span class="n">encryption_key</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">STORAGE_ENCRYPTION_KEY</span>
</span><span id="__span-11-27"><a href="#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pii_patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-28"><a href="#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">SSN</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-29"><a href="#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>                <span class="sa">r</span><span class="s1">'\b\d</span><span class="si">{3}</span><span class="s1">-\d</span><span class="si">{2}</span><span class="s1">-\d</span><span class="si">{4}</span><span class="s1">\b'</span><span class="p">,</span>  <span class="c1"># 123-45-6789</span>
</span><span id="__span-11-30"><a href="#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a>                <span class="sa">r</span><span class="s1">'\b\d</span><span class="si">{9}</span><span class="s1">\b'</span>               <span class="c1"># 123456789</span>
</span><span id="__span-11-31"><a href="#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a>            <span class="p">],</span>
</span><span id="__span-11-32"><a href="#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">EMAIL</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-33"><a href="#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a>                <span class="sa">r</span><span class="s1">'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'</span>
</span><span id="__span-11-34"><a href="#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a>            <span class="p">],</span>
</span><span id="__span-11-35"><a href="#__codelineno-11-35" id="__codelineno-11-35" name="__codelineno-11-35"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">PHONE</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-36"><a href="#__codelineno-11-36" id="__codelineno-11-36" name="__codelineno-11-36"></a>                <span class="sa">r</span><span class="s1">'\b\(?([0-9]</span><span class="si">{3}</span><span class="s1">)\)?[-. ]?([0-9]</span><span class="si">{3}</span><span class="s1">)[-. ]?([0-9]</span><span class="si">{4}</span><span class="s1">)\b'</span><span class="p">,</span>
</span><span id="__span-11-37"><a href="#__codelineno-11-37" id="__codelineno-11-37" name="__codelineno-11-37"></a>                <span class="sa">r</span><span class="s1">'\b\+?1?[-.\s]?\(?([0-9]</span><span class="si">{3}</span><span class="s1">)\)?[-.\s]?([0-9]</span><span class="si">{3}</span><span class="s1">)[-.\s]?([0-9]</span><span class="si">{4}</span><span class="s1">)\b'</span>
</span><span id="__span-11-38"><a href="#__codelineno-11-38" id="__codelineno-11-38" name="__codelineno-11-38"></a>            <span class="p">],</span>
</span><span id="__span-11-39"><a href="#__codelineno-11-39" id="__codelineno-11-39" name="__codelineno-11-39"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">CREDIT_CARD</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-40"><a href="#__codelineno-11-40" id="__codelineno-11-40" name="__codelineno-11-40"></a>                <span class="sa">r</span><span class="s1">'\b(?:4[0-9]</span><span class="si">{12}</span><span class="s1">(?:[0-9]</span><span class="si">{3}</span><span class="s1">)?|5[1-5][0-9]</span><span class="si">{14}</span><span class="s1">|3[47][0-9]</span><span class="si">{13}</span><span class="s1">|3[0-9]</span><span class="si">{13}</span><span class="s1">|6(?:011|5[0-9]</span><span class="si">{2}</span><span class="s1">)[0-9]</span><span class="si">{12}</span><span class="s1">)\b'</span>
</span><span id="__span-11-41"><a href="#__codelineno-11-41" id="__codelineno-11-41" name="__codelineno-11-41"></a>            <span class="p">],</span>
</span><span id="__span-11-42"><a href="#__codelineno-11-42" id="__codelineno-11-42" name="__codelineno-11-42"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">STUDENT_ID</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-43"><a href="#__codelineno-11-43" id="__codelineno-11-43" name="__codelineno-11-43"></a>                <span class="sa">r</span><span class="s1">'\b[A-Z]{2,4}\d{6,10}\b'</span><span class="p">,</span>  <span class="c1"># ABC123456789</span>
</span><span id="__span-11-44"><a href="#__codelineno-11-44" id="__codelineno-11-44" name="__codelineno-11-44"></a>                <span class="sa">r</span><span class="s1">'\bSTU\d{6,9}\b'</span>           <span class="c1"># STU123456</span>
</span><span id="__span-11-45"><a href="#__codelineno-11-45" id="__codelineno-11-45" name="__codelineno-11-45"></a>            <span class="p">],</span>
</span><span id="__span-11-46"><a href="#__codelineno-11-46" id="__codelineno-11-46" name="__codelineno-11-46"></a>            <span class="n">PIIType</span><span class="o">.</span><span class="n">DATE_OF_BIRTH</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-11-47"><a href="#__codelineno-11-47" id="__codelineno-11-47" name="__codelineno-11-47"></a>                <span class="sa">r</span><span class="s1">'\b(?:0[1-9]|1[0-2])[-/](?:0[1-9]|[12][0-9]|3[01])[-/](?:19|20)\d</span><span class="si">{2}</span><span class="s1">\b'</span><span class="p">,</span>
</span><span id="__span-11-48"><a href="#__codelineno-11-48" id="__codelineno-11-48" name="__codelineno-11-48"></a>                <span class="sa">r</span><span class="s1">'\b(?:19|20)\d</span><span class="si">{2}</span><span class="s1">[-/](?:0[1-9]|1[0-2])[-/](?:0[1-9]|[12][0-9]|3[01])\b'</span>
</span><span id="__span-11-49"><a href="#__codelineno-11-49" id="__codelineno-11-49" name="__codelineno-11-49"></a>            <span class="p">]</span>
</span><span id="__span-11-50"><a href="#__codelineno-11-50" id="__codelineno-11-50" name="__codelineno-11-50"></a>        <span class="p">}</span>
</span><span id="__span-11-51"><a href="#__codelineno-11-51" id="__codelineno-11-51" name="__codelineno-11-51"></a>
</span><span id="__span-11-52"><a href="#__codelineno-11-52" id="__codelineno-11-52" name="__codelineno-11-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">detect_pii</span><span class="p">(</span>
</span><span id="__span-11-53"><a href="#__codelineno-11-53" id="__codelineno-11-53" name="__codelineno-11-53"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-11-54"><a href="#__codelineno-11-54" id="__codelineno-11-54" name="__codelineno-11-54"></a>        <span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-11-55"><a href="#__codelineno-11-55" id="__codelineno-11-55" name="__codelineno-11-55"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-56"><a href="#__codelineno-11-56" id="__codelineno-11-56" name="__codelineno-11-56"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PIIDetectionResult</span><span class="p">:</span>
</span><span id="__span-11-57"><a href="#__codelineno-11-57" id="__codelineno-11-57" name="__codelineno-11-57"></a><span class="w">        </span><span class="sd">"""Detect PII in file content"""</span>
</span><span id="__span-11-58"><a href="#__codelineno-11-58" id="__codelineno-11-58" name="__codelineno-11-58"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-59"><a href="#__codelineno-11-59" id="__codelineno-11-59" name="__codelineno-11-59"></a>            <span class="c1"># Convert bytes to text for analysis</span>
</span><span id="__span-11-60"><a href="#__codelineno-11-60" id="__codelineno-11-60" name="__codelineno-11-60"></a>            <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_text_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-11-61"><a href="#__codelineno-11-61" id="__codelineno-11-61" name="__codelineno-11-61"></a>
</span><span id="__span-11-62"><a href="#__codelineno-11-62" id="__codelineno-11-62" name="__codelineno-11-62"></a>            <span class="n">detected_pii</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-63"><a href="#__codelineno-11-63" id="__codelineno-11-63" name="__codelineno-11-63"></a>            <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-11-64"><a href="#__codelineno-11-64" id="__codelineno-11-64" name="__codelineno-11-64"></a>            <span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-65"><a href="#__codelineno-11-65" id="__codelineno-11-65" name="__codelineno-11-65"></a>
</span><span id="__span-11-66"><a href="#__codelineno-11-66" id="__codelineno-11-66" name="__codelineno-11-66"></a>            <span class="k">for</span> <span class="n">pii_type</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pii_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-11-67"><a href="#__codelineno-11-67" id="__codelineno-11-67" name="__codelineno-11-67"></a>                <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-68"><a href="#__codelineno-11-68" id="__codelineno-11-68" name="__codelineno-11-68"></a>                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="__span-11-69"><a href="#__codelineno-11-69" id="__codelineno-11-69" name="__codelineno-11-69"></a>                    <span class="n">pattern_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="__span-11-70"><a href="#__codelineno-11-70" id="__codelineno-11-70" name="__codelineno-11-70"></a>                    <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pattern_matches</span><span class="p">)</span>
</span><span id="__span-11-71"><a href="#__codelineno-11-71" id="__codelineno-11-71" name="__codelineno-11-71"></a>
</span><span id="__span-11-72"><a href="#__codelineno-11-72" id="__codelineno-11-72" name="__codelineno-11-72"></a>                <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="__span-11-73"><a href="#__codelineno-11-73" id="__codelineno-11-73" name="__codelineno-11-73"></a>                    <span class="n">detected_pii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pii_type</span><span class="p">)</span>
</span><span id="__span-11-74"><a href="#__codelineno-11-74" id="__codelineno-11-74" name="__codelineno-11-74"></a>                    <span class="n">details</span><span class="p">[</span><span class="n">pii_type</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-75"><a href="#__codelineno-11-75" id="__codelineno-11-75" name="__codelineno-11-75"></a>                        <span class="s2">"match_count"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span>
</span><span id="__span-11-76"><a href="#__codelineno-11-76" id="__codelineno-11-76" name="__codelineno-11-76"></a>                        <span class="s2">"sample_matches"</span><span class="p">:</span> <span class="n">matches</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># First 3 matches for review</span>
</span><span id="__span-11-77"><a href="#__codelineno-11-77" id="__codelineno-11-77" name="__codelineno-11-77"></a>                    <span class="p">}</span>
</span><span id="__span-11-78"><a href="#__codelineno-11-78" id="__codelineno-11-78" name="__codelineno-11-78"></a>                    <span class="n">confidence_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>  <span class="c1"># Base confidence for regex matches</span>
</span><span id="__span-11-79"><a href="#__codelineno-11-79" id="__codelineno-11-79" name="__codelineno-11-79"></a>
</span><span id="__span-11-80"><a href="#__codelineno-11-80" id="__codelineno-11-80" name="__codelineno-11-80"></a>            <span class="c1"># Calculate overall confidence</span>
</span><span id="__span-11-81"><a href="#__codelineno-11-81" id="__codelineno-11-81" name="__codelineno-11-81"></a>            <span class="n">overall_confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_scores</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="__span-11-82"><a href="#__codelineno-11-82" id="__codelineno-11-82" name="__codelineno-11-82"></a>
</span><span id="__span-11-83"><a href="#__codelineno-11-83" id="__codelineno-11-83" name="__codelineno-11-83"></a>            <span class="k">return</span> <span class="n">PIIDetectionResult</span><span class="p">(</span>
</span><span id="__span-11-84"><a href="#__codelineno-11-84" id="__codelineno-11-84" name="__codelineno-11-84"></a>                <span class="n">has_pii</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">detected_pii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-11-85"><a href="#__codelineno-11-85" id="__codelineno-11-85" name="__codelineno-11-85"></a>                <span class="n">pii_types</span><span class="o">=</span><span class="n">detected_pii</span><span class="p">,</span>
</span><span id="__span-11-86"><a href="#__codelineno-11-86" id="__codelineno-11-86" name="__codelineno-11-86"></a>                <span class="n">confidence_score</span><span class="o">=</span><span class="n">overall_confidence</span><span class="p">,</span>
</span><span id="__span-11-87"><a href="#__codelineno-11-87" id="__codelineno-11-87" name="__codelineno-11-87"></a>                <span class="n">details</span><span class="o">=</span><span class="n">details</span>
</span><span id="__span-11-88"><a href="#__codelineno-11-88" id="__codelineno-11-88" name="__codelineno-11-88"></a>            <span class="p">)</span>
</span><span id="__span-11-89"><a href="#__codelineno-11-89" id="__codelineno-11-89" name="__codelineno-11-89"></a>
</span><span id="__span-11-90"><a href="#__codelineno-11-90" id="__codelineno-11-90" name="__codelineno-11-90"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-11-91"><a href="#__codelineno-11-91" id="__codelineno-11-91" name="__codelineno-11-91"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"PII detection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-92"><a href="#__codelineno-11-92" id="__codelineno-11-92" name="__codelineno-11-92"></a>            <span class="c1"># Return safe default</span>
</span><span id="__span-11-93"><a href="#__codelineno-11-93" id="__codelineno-11-93" name="__codelineno-11-93"></a>            <span class="k">return</span> <span class="n">PIIDetectionResult</span><span class="p">(</span>
</span><span id="__span-11-94"><a href="#__codelineno-11-94" id="__codelineno-11-94" name="__codelineno-11-94"></a>                <span class="n">has_pii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Assume PII present if detection fails</span>
</span><span id="__span-11-95"><a href="#__codelineno-11-95" id="__codelineno-11-95" name="__codelineno-11-95"></a>                <span class="n">pii_types</span><span class="o">=</span><span class="p">[],</span>
</span><span id="__span-11-96"><a href="#__codelineno-11-96" id="__codelineno-11-96" name="__codelineno-11-96"></a>                <span class="n">confidence_score</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-11-97"><a href="#__codelineno-11-97" id="__codelineno-11-97" name="__codelineno-11-97"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="__span-11-98"><a href="#__codelineno-11-98" id="__codelineno-11-98" name="__codelineno-11-98"></a>            <span class="p">)</span>
</span><span id="__span-11-99"><a href="#__codelineno-11-99" id="__codelineno-11-99" name="__codelineno-11-99"></a>
</span><span id="__span-11-100"><a href="#__codelineno-11-100" id="__codelineno-11-100" name="__codelineno-11-100"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_compliance</span><span class="p">(</span>
</span><span id="__span-11-101"><a href="#__codelineno-11-101" id="__codelineno-11-101" name="__codelineno-11-101"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-11-102"><a href="#__codelineno-11-102" id="__codelineno-11-102" name="__codelineno-11-102"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-11-103"><a href="#__codelineno-11-103" id="__codelineno-11-103" name="__codelineno-11-103"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-11-104"><a href="#__codelineno-11-104" id="__codelineno-11-104" name="__codelineno-11-104"></a>        <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-11-105"><a href="#__codelineno-11-105" id="__codelineno-11-105" name="__codelineno-11-105"></a>        <span class="n">organization_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-11-106"><a href="#__codelineno-11-106" id="__codelineno-11-106" name="__codelineno-11-106"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-11-107"><a href="#__codelineno-11-107" id="__codelineno-11-107" name="__codelineno-11-107"></a><span class="w">        </span><span class="sd">"""Check COPPA/FERPA compliance requirements"""</span>
</span><span id="__span-11-108"><a href="#__codelineno-11-108" id="__codelineno-11-108" name="__codelineno-11-108"></a>        <span class="n">pii_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_pii</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-11-109"><a href="#__codelineno-11-109" id="__codelineno-11-109" name="__codelineno-11-109"></a>
</span><span id="__span-11-110"><a href="#__codelineno-11-110" id="__codelineno-11-110" name="__codelineno-11-110"></a>        <span class="n">compliance_result</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-111"><a href="#__codelineno-11-111" id="__codelineno-11-111" name="__codelineno-11-111"></a>            <span class="s2">"pii_detected"</span><span class="p">:</span> <span class="n">pii_result</span><span class="o">.</span><span class="n">has_pii</span><span class="p">,</span>
</span><span id="__span-11-112"><a href="#__codelineno-11-112" id="__codelineno-11-112" name="__codelineno-11-112"></a>            <span class="s2">"pii_types"</span><span class="p">:</span> <span class="p">[</span><span class="n">pii</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">pii</span> <span class="ow">in</span> <span class="n">pii_result</span><span class="o">.</span><span class="n">pii_types</span><span class="p">],</span>
</span><span id="__span-11-113"><a href="#__codelineno-11-113" id="__codelineno-11-113" name="__codelineno-11-113"></a>            <span class="s2">"coppa_compliance"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_coppa_compliance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">organization_context</span><span class="p">),</span>
</span><span id="__span-11-114"><a href="#__codelineno-11-114" id="__codelineno-11-114" name="__codelineno-11-114"></a>            <span class="s2">"ferpa_compliance"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_ferpa_compliance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">pii_result</span><span class="p">),</span>
</span><span id="__span-11-115"><a href="#__codelineno-11-115" id="__codelineno-11-115" name="__codelineno-11-115"></a>            <span class="s2">"encryption_required"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-11-116"><a href="#__codelineno-11-116" id="__codelineno-11-116" name="__codelineno-11-116"></a>            <span class="s2">"consent_required"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-11-117"><a href="#__codelineno-11-117" id="__codelineno-11-117" name="__codelineno-11-117"></a>            <span class="s2">"retention_requirements"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_retention_requirements</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
</span><span id="__span-11-118"><a href="#__codelineno-11-118" id="__codelineno-11-118" name="__codelineno-11-118"></a>        <span class="p">}</span>
</span><span id="__span-11-119"><a href="#__codelineno-11-119" id="__codelineno-11-119" name="__codelineno-11-119"></a>
</span><span id="__span-11-120"><a href="#__codelineno-11-120" id="__codelineno-11-120" name="__codelineno-11-120"></a>        <span class="c1"># Determine if encryption is required</span>
</span><span id="__span-11-121"><a href="#__codelineno-11-121" id="__codelineno-11-121" name="__codelineno-11-121"></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="__span-11-122"><a href="#__codelineno-11-122" id="__codelineno-11-122" name="__codelineno-11-122"></a>            <span class="n">pii_result</span><span class="o">.</span><span class="n">has_pii</span> <span class="ow">or</span>
</span><span id="__span-11-123"><a href="#__codelineno-11-123" id="__codelineno-11-123" name="__codelineno-11-123"></a>            <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"student_submission"</span><span class="p">,</span> <span class="s2">"assessment"</span><span class="p">,</span> <span class="s2">"administrative"</span><span class="p">]</span> <span class="ow">or</span>
</span><span id="__span-11-124"><a href="#__codelineno-11-124" id="__codelineno-11-124" name="__codelineno-11-124"></a>            <span class="n">compliance_result</span><span class="p">[</span><span class="s2">"coppa_compliance"</span><span class="p">][</span><span class="s2">"enhanced_protection_required"</span><span class="p">]</span>
</span><span id="__span-11-125"><a href="#__codelineno-11-125" id="__codelineno-11-125" name="__codelineno-11-125"></a>        <span class="p">):</span>
</span><span id="__span-11-126"><a href="#__codelineno-11-126" id="__codelineno-11-126" name="__codelineno-11-126"></a>            <span class="n">compliance_result</span><span class="p">[</span><span class="s2">"encryption_required"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-11-127"><a href="#__codelineno-11-127" id="__codelineno-11-127" name="__codelineno-11-127"></a>
</span><span id="__span-11-128"><a href="#__codelineno-11-128" id="__codelineno-11-128" name="__codelineno-11-128"></a>        <span class="c1"># Determine if consent is required</span>
</span><span id="__span-11-129"><a href="#__codelineno-11-129" id="__codelineno-11-129" name="__codelineno-11-129"></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="__span-11-130"><a href="#__codelineno-11-130" id="__codelineno-11-130" name="__codelineno-11-130"></a>            <span class="n">compliance_result</span><span class="p">[</span><span class="s2">"coppa_compliance"</span><span class="p">][</span><span class="s2">"parental_consent_required"</span><span class="p">]</span> <span class="ow">or</span>
</span><span id="__span-11-131"><a href="#__codelineno-11-131" id="__codelineno-11-131" name="__codelineno-11-131"></a>            <span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="s2">"student_submission"</span> <span class="ow">and</span> <span class="n">pii_result</span><span class="o">.</span><span class="n">has_pii</span><span class="p">)</span>
</span><span id="__span-11-132"><a href="#__codelineno-11-132" id="__codelineno-11-132" name="__codelineno-11-132"></a>        <span class="p">):</span>
</span><span id="__span-11-133"><a href="#__codelineno-11-133" id="__codelineno-11-133" name="__codelineno-11-133"></a>            <span class="n">compliance_result</span><span class="p">[</span><span class="s2">"consent_required"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-11-134"><a href="#__codelineno-11-134" id="__codelineno-11-134" name="__codelineno-11-134"></a>
</span><span id="__span-11-135"><a href="#__codelineno-11-135" id="__codelineno-11-135" name="__codelineno-11-135"></a>        <span class="k">return</span> <span class="n">compliance_result</span>
</span><span id="__span-11-136"><a href="#__codelineno-11-136" id="__codelineno-11-136" name="__codelineno-11-136"></a>
</span><span id="__span-11-137"><a href="#__codelineno-11-137" id="__codelineno-11-137" name="__codelineno-11-137"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_coppa_compliance</span><span class="p">(</span>
</span><span id="__span-11-138"><a href="#__codelineno-11-138" id="__codelineno-11-138" name="__codelineno-11-138"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-11-139"><a href="#__codelineno-11-139" id="__codelineno-11-139" name="__codelineno-11-139"></a>        <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-11-140"><a href="#__codelineno-11-140" id="__codelineno-11-140" name="__codelineno-11-140"></a>        <span class="n">organization_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-11-141"><a href="#__codelineno-11-141" id="__codelineno-11-141" name="__codelineno-11-141"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-11-142"><a href="#__codelineno-11-142" id="__codelineno-11-142" name="__codelineno-11-142"></a><span class="w">        </span><span class="sd">"""Check COPPA compliance requirements"""</span>
</span><span id="__span-11-143"><a href="#__codelineno-11-143" id="__codelineno-11-143" name="__codelineno-11-143"></a>        <span class="n">student_age</span> <span class="o">=</span> <span class="n">organization_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"student_age"</span><span class="p">)</span>
</span><span id="__span-11-144"><a href="#__codelineno-11-144" id="__codelineno-11-144" name="__codelineno-11-144"></a>        <span class="n">is_child_user</span> <span class="o">=</span> <span class="n">student_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">student_age</span> <span class="o">&lt;</span> <span class="mi">13</span>
</span><span id="__span-11-145"><a href="#__codelineno-11-145" id="__codelineno-11-145" name="__codelineno-11-145"></a>
</span><span id="__span-11-146"><a href="#__codelineno-11-146" id="__codelineno-11-146" name="__codelineno-11-146"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-147"><a href="#__codelineno-11-147" id="__codelineno-11-147" name="__codelineno-11-147"></a>            <span class="s2">"applies"</span><span class="p">:</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"avatar"</span><span class="p">,</span> <span class="s2">"student_submission"</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_child_user</span><span class="p">,</span>
</span><span id="__span-11-148"><a href="#__codelineno-11-148" id="__codelineno-11-148" name="__codelineno-11-148"></a>            <span class="s2">"child_user_detected"</span><span class="p">:</span> <span class="n">is_child_user</span><span class="p">,</span>
</span><span id="__span-11-149"><a href="#__codelineno-11-149" id="__codelineno-11-149" name="__codelineno-11-149"></a>            <span class="s2">"parental_consent_required"</span><span class="p">:</span> <span class="n">is_child_user</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"avatar"</span><span class="p">,</span> <span class="s2">"student_submission"</span><span class="p">],</span>
</span><span id="__span-11-150"><a href="#__codelineno-11-150" id="__codelineno-11-150" name="__codelineno-11-150"></a>            <span class="s2">"enhanced_protection_required"</span><span class="p">:</span> <span class="n">is_child_user</span><span class="p">,</span>
</span><span id="__span-11-151"><a href="#__codelineno-11-151" id="__codelineno-11-151" name="__codelineno-11-151"></a>            <span class="s2">"data_minimization_required"</span><span class="p">:</span> <span class="n">is_child_user</span><span class="p">,</span>
</span><span id="__span-11-152"><a href="#__codelineno-11-152" id="__codelineno-11-152" name="__codelineno-11-152"></a>            <span class="s2">"retention_limit_days"</span><span class="p">:</span> <span class="mi">2555</span> <span class="k">if</span> <span class="n">is_child_user</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># 7 years max for children</span>
</span><span id="__span-11-153"><a href="#__codelineno-11-153" id="__codelineno-11-153" name="__codelineno-11-153"></a>        <span class="p">}</span>
</span><span id="__span-11-154"><a href="#__codelineno-11-154" id="__codelineno-11-154" name="__codelineno-11-154"></a>
</span><span id="__span-11-155"><a href="#__codelineno-11-155" id="__codelineno-11-155" name="__codelineno-11-155"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_ferpa_compliance</span><span class="p">(</span>
</span><span id="__span-11-156"><a href="#__codelineno-11-156" id="__codelineno-11-156" name="__codelineno-11-156"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-11-157"><a href="#__codelineno-11-157" id="__codelineno-11-157" name="__codelineno-11-157"></a>        <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-11-158"><a href="#__codelineno-11-158" id="__codelineno-11-158" name="__codelineno-11-158"></a>        <span class="n">pii_result</span><span class="p">:</span> <span class="n">PIIDetectionResult</span>
</span><span id="__span-11-159"><a href="#__codelineno-11-159" id="__codelineno-11-159" name="__codelineno-11-159"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-11-160"><a href="#__codelineno-11-160" id="__codelineno-11-160" name="__codelineno-11-160"></a><span class="w">        </span><span class="sd">"""Check FERPA compliance requirements"""</span>
</span><span id="__span-11-161"><a href="#__codelineno-11-161" id="__codelineno-11-161" name="__codelineno-11-161"></a>        <span class="n">is_educational_record</span> <span class="o">=</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="__span-11-162"><a href="#__codelineno-11-162" id="__codelineno-11-162" name="__codelineno-11-162"></a>            <span class="s2">"student_submission"</span><span class="p">,</span>
</span><span id="__span-11-163"><a href="#__codelineno-11-163" id="__codelineno-11-163" name="__codelineno-11-163"></a>            <span class="s2">"assessment"</span><span class="p">,</span>
</span><span id="__span-11-164"><a href="#__codelineno-11-164" id="__codelineno-11-164" name="__codelineno-11-164"></a>            <span class="s2">"administrative"</span><span class="p">,</span>
</span><span id="__span-11-165"><a href="#__codelineno-11-165" id="__codelineno-11-165" name="__codelineno-11-165"></a>            <span class="s2">"report"</span>
</span><span id="__span-11-166"><a href="#__codelineno-11-166" id="__codelineno-11-166" name="__codelineno-11-166"></a>        <span class="p">]</span>
</span><span id="__span-11-167"><a href="#__codelineno-11-167" id="__codelineno-11-167" name="__codelineno-11-167"></a>
</span><span id="__span-11-168"><a href="#__codelineno-11-168" id="__codelineno-11-168" name="__codelineno-11-168"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-169"><a href="#__codelineno-11-169" id="__codelineno-11-169" name="__codelineno-11-169"></a>            <span class="s2">"applies"</span><span class="p">:</span> <span class="n">is_educational_record</span> <span class="ow">or</span> <span class="n">pii_result</span><span class="o">.</span><span class="n">has_pii</span><span class="p">,</span>
</span><span id="__span-11-170"><a href="#__codelineno-11-170" id="__codelineno-11-170" name="__codelineno-11-170"></a>            <span class="s2">"is_educational_record"</span><span class="p">:</span> <span class="n">is_educational_record</span><span class="p">,</span>
</span><span id="__span-11-171"><a href="#__codelineno-11-171" id="__codelineno-11-171" name="__codelineno-11-171"></a>            <span class="s2">"audit_logging_required"</span><span class="p">:</span> <span class="n">is_educational_record</span><span class="p">,</span>
</span><span id="__span-11-172"><a href="#__codelineno-11-172" id="__codelineno-11-172" name="__codelineno-11-172"></a>            <span class="s2">"legitimate_interest_required"</span><span class="p">:</span> <span class="n">is_educational_record</span><span class="p">,</span>
</span><span id="__span-11-173"><a href="#__codelineno-11-173" id="__codelineno-11-173" name="__codelineno-11-173"></a>            <span class="s2">"directory_information_opt_out"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># To be implemented based on user preferences</span>
</span><span id="__span-11-174"><a href="#__codelineno-11-174" id="__codelineno-11-174" name="__codelineno-11-174"></a>            <span class="s2">"retention_requirement_years"</span><span class="p">:</span> <span class="mi">7</span> <span class="k">if</span> <span class="n">is_educational_record</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-11-175"><a href="#__codelineno-11-175" id="__codelineno-11-175" name="__codelineno-11-175"></a>        <span class="p">}</span>
</span><span id="__span-11-176"><a href="#__codelineno-11-176" id="__codelineno-11-176" name="__codelineno-11-176"></a>
</span><span id="__span-11-177"><a href="#__codelineno-11-177" id="__codelineno-11-177" name="__codelineno-11-177"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_sensitive_file</span><span class="p">(</span>
</span><span id="__span-11-178"><a href="#__codelineno-11-178" id="__codelineno-11-178" name="__codelineno-11-178"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-11-179"><a href="#__codelineno-11-179" id="__codelineno-11-179" name="__codelineno-11-179"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-11-180"><a href="#__codelineno-11-180" id="__codelineno-11-180" name="__codelineno-11-180"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span>
</span><span id="__span-11-181"><a href="#__codelineno-11-181" id="__codelineno-11-181" name="__codelineno-11-181"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-11-182"><a href="#__codelineno-11-182" id="__codelineno-11-182" name="__codelineno-11-182"></a><span class="w">        </span><span class="sd">"""Encrypt sensitive file data"""</span>
</span><span id="__span-11-183"><a href="#__codelineno-11-183" id="__codelineno-11-183" name="__codelineno-11-183"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>
</span><span id="__span-11-184"><a href="#__codelineno-11-184" id="__codelineno-11-184" name="__codelineno-11-184"></a>
</span><span id="__span-11-185"><a href="#__codelineno-11-185" id="__codelineno-11-185" name="__codelineno-11-185"></a>        <span class="c1"># Generate organization-specific key</span>
</span><span id="__span-11-186"><a href="#__codelineno-11-186" id="__codelineno-11-186" name="__codelineno-11-186"></a>        <span class="n">org_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_organization_key</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-11-187"><a href="#__codelineno-11-187" id="__codelineno-11-187" name="__codelineno-11-187"></a>        <span class="n">fernet</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">org_key</span><span class="p">)</span>
</span><span id="__span-11-188"><a href="#__codelineno-11-188" id="__codelineno-11-188" name="__codelineno-11-188"></a>
</span><span id="__span-11-189"><a href="#__codelineno-11-189" id="__codelineno-11-189" name="__codelineno-11-189"></a>        <span class="c1"># Encrypt file data</span>
</span><span id="__span-11-190"><a href="#__codelineno-11-190" id="__codelineno-11-190" name="__codelineno-11-190"></a>        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">fernet</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-11-191"><a href="#__codelineno-11-191" id="__codelineno-11-191" name="__codelineno-11-191"></a>
</span><span id="__span-11-192"><a href="#__codelineno-11-192" id="__codelineno-11-192" name="__codelineno-11-192"></a>        <span class="n">encryption_metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-193"><a href="#__codelineno-11-193" id="__codelineno-11-193" name="__codelineno-11-193"></a>            <span class="s2">"encrypted"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-11-194"><a href="#__codelineno-11-194" id="__codelineno-11-194" name="__codelineno-11-194"></a>            <span class="s2">"encryption_method"</span><span class="p">:</span> <span class="s2">"Fernet"</span><span class="p">,</span>
</span><span id="__span-11-195"><a href="#__codelineno-11-195" id="__codelineno-11-195" name="__codelineno-11-195"></a>            <span class="s2">"key_derivation"</span><span class="p">:</span> <span class="s2">"PBKDF2-HMAC-SHA256"</span><span class="p">,</span>
</span><span id="__span-11-196"><a href="#__codelineno-11-196" id="__codelineno-11-196" name="__codelineno-11-196"></a>            <span class="s2">"organization_id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">organization_id</span><span class="p">),</span>
</span><span id="__span-11-197"><a href="#__codelineno-11-197" id="__codelineno-11-197" name="__codelineno-11-197"></a>            <span class="s2">"encrypted_at"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-11-198"><a href="#__codelineno-11-198" id="__codelineno-11-198" name="__codelineno-11-198"></a>        <span class="p">}</span>
</span><span id="__span-11-199"><a href="#__codelineno-11-199" id="__codelineno-11-199" name="__codelineno-11-199"></a>
</span><span id="__span-11-200"><a href="#__codelineno-11-200" id="__codelineno-11-200" name="__codelineno-11-200"></a>        <span class="k">return</span> <span class="n">encrypted_data</span><span class="p">,</span> <span class="n">encryption_metadata</span>
</span></code></pre></div> <h2 id="performance-optimizations">Performance Optimizations<a class="headerlink" href="#performance-optimizations" title="Permanent link">¶</a></h2> <h3 id="image-processing-and-cdn-integration">Image Processing and CDN Integration<a class="headerlink" href="#image-processing-and-cdn-integration" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageProcessor</span><span class="p">:</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="sd">"""Handles image optimization and variant generation"""</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_sizes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>            <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>   <span class="c1"># Small thumbnail</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a>            <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>   <span class="c1"># Medium thumbnail</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>            <span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">),</span>   <span class="c1"># Large thumbnail</span>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="p">]</span>
</span><span id="__span-12-14"><a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">responsive_breakpoints</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-12-16"><a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a>            <span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="s2">"mobile"</span><span class="p">),</span>
</span><span id="__span-12-17"><a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a>            <span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="s2">"tablet"</span><span class="p">),</span>
</span><span id="__span-12-18"><a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a>            <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="s2">"desktop"</span><span class="p">),</span>
</span><span id="__span-12-19"><a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a>            <span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="s2">"large"</span><span class="p">)</span>
</span><span id="__span-12-20"><a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a>        <span class="p">]</span>
</span><span id="__span-12-21"><a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a>
</span><span id="__span-12-22"><a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_image</span><span class="p">(</span>
</span><span id="__span-12-23"><a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-24"><a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a>        <span class="n">image_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-12-25"><a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a>        <span class="n">generate_thumbnails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-26"><a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a>        <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-27"><a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a>        <span class="n">generate_responsive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-12-28"><a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-12-29"><a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">        </span><span class="sd">"""Process image with optimization and variant generation"""</span>
</span><span id="__span-12-30"><a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a>
</span><span id="__span-12-31"><a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-32"><a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a>            <span class="c1"># Open image</span>
</span><span id="__span-12-33"><a href="#__codelineno-12-33" id="__codelineno-12-33" name="__codelineno-12-33"></a>            <span class="n">original_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_data</span><span class="p">))</span>
</span><span id="__span-12-34"><a href="#__codelineno-12-34" id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a href="#__codelineno-12-35" id="__codelineno-12-35" name="__codelineno-12-35"></a>            <span class="c1"># Fix orientation based on EXIF</span>
</span><span id="__span-12-36"><a href="#__codelineno-12-36" id="__codelineno-12-36" name="__codelineno-12-36"></a>            <span class="n">original_image</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">original_image</span><span class="p">)</span>
</span><span id="__span-12-37"><a href="#__codelineno-12-37" id="__codelineno-12-37" name="__codelineno-12-37"></a>
</span><span id="__span-12-38"><a href="#__codelineno-12-38" id="__codelineno-12-38" name="__codelineno-12-38"></a>            <span class="n">variants</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-12-39"><a href="#__codelineno-12-39" id="__codelineno-12-39" name="__codelineno-12-39"></a>
</span><span id="__span-12-40"><a href="#__codelineno-12-40" id="__codelineno-12-40" name="__codelineno-12-40"></a>            <span class="c1"># Original optimized version</span>
</span><span id="__span-12-41"><a href="#__codelineno-12-41" id="__codelineno-12-41" name="__codelineno-12-41"></a>            <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span id="__span-12-42"><a href="#__codelineno-12-42" id="__codelineno-12-42" name="__codelineno-12-42"></a>                <span class="n">optimized_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_image</span><span class="p">(</span><span class="n">original_image</span><span class="p">)</span>
</span><span id="__span-12-43"><a href="#__codelineno-12-43" id="__codelineno-12-43" name="__codelineno-12-43"></a>                <span class="n">variants</span><span class="p">[</span><span class="s2">"optimized"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-44"><a href="#__codelineno-12-44" id="__codelineno-12-44" name="__codelineno-12-44"></a>                    <span class="s2">"data"</span><span class="p">:</span> <span class="n">optimized_data</span><span class="p">,</span>
</span><span id="__span-12-45"><a href="#__codelineno-12-45" id="__codelineno-12-45" name="__codelineno-12-45"></a>                    <span class="s2">"width"</span><span class="p">:</span> <span class="n">original_image</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
</span><span id="__span-12-46"><a href="#__codelineno-12-46" id="__codelineno-12-46" name="__codelineno-12-46"></a>                    <span class="s2">"height"</span><span class="p">:</span> <span class="n">original_image</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
</span><span id="__span-12-47"><a href="#__codelineno-12-47" id="__codelineno-12-47" name="__codelineno-12-47"></a>                    <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"WebP"</span><span class="p">,</span>
</span><span id="__span-12-48"><a href="#__codelineno-12-48" id="__codelineno-12-48" name="__codelineno-12-48"></a>                    <span class="s2">"file_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimized_data</span><span class="p">)</span>
</span><span id="__span-12-49"><a href="#__codelineno-12-49" id="__codelineno-12-49" name="__codelineno-12-49"></a>                <span class="p">}</span>
</span><span id="__span-12-50"><a href="#__codelineno-12-50" id="__codelineno-12-50" name="__codelineno-12-50"></a>
</span><span id="__span-12-51"><a href="#__codelineno-12-51" id="__codelineno-12-51" name="__codelineno-12-51"></a>            <span class="c1"># Generate thumbnails</span>
</span><span id="__span-12-52"><a href="#__codelineno-12-52" id="__codelineno-12-52" name="__codelineno-12-52"></a>            <span class="k">if</span> <span class="n">generate_thumbnails</span><span class="p">:</span>
</span><span id="__span-12-53"><a href="#__codelineno-12-53" id="__codelineno-12-53" name="__codelineno-12-53"></a>                <span class="k">for</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_sizes</span><span class="p">:</span>
</span><span id="__span-12-54"><a href="#__codelineno-12-54" id="__codelineno-12-54" name="__codelineno-12-54"></a>                    <span class="n">thumbnail_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_thumbnail</span><span class="p">(</span>
</span><span id="__span-12-55"><a href="#__codelineno-12-55" id="__codelineno-12-55" name="__codelineno-12-55"></a>                        <span class="n">original_image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
</span><span id="__span-12-56"><a href="#__codelineno-12-56" id="__codelineno-12-56" name="__codelineno-12-56"></a>                    <span class="p">)</span>
</span><span id="__span-12-57"><a href="#__codelineno-12-57" id="__codelineno-12-57" name="__codelineno-12-57"></a>                    <span class="n">variants</span><span class="p">[</span><span class="sa">f</span><span class="s2">"thumb_</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-58"><a href="#__codelineno-12-58" id="__codelineno-12-58" name="__codelineno-12-58"></a>                        <span class="s2">"data"</span><span class="p">:</span> <span class="n">thumbnail_data</span><span class="p">,</span>
</span><span id="__span-12-59"><a href="#__codelineno-12-59" id="__codelineno-12-59" name="__codelineno-12-59"></a>                        <span class="s2">"width"</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
</span><span id="__span-12-60"><a href="#__codelineno-12-60" id="__codelineno-12-60" name="__codelineno-12-60"></a>                        <span class="s2">"height"</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
</span><span id="__span-12-61"><a href="#__codelineno-12-61" id="__codelineno-12-61" name="__codelineno-12-61"></a>                        <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"WebP"</span><span class="p">,</span>
</span><span id="__span-12-62"><a href="#__codelineno-12-62" id="__codelineno-12-62" name="__codelineno-12-62"></a>                        <span class="s2">"file_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_data</span><span class="p">)</span>
</span><span id="__span-12-63"><a href="#__codelineno-12-63" id="__codelineno-12-63" name="__codelineno-12-63"></a>                    <span class="p">}</span>
</span><span id="__span-12-64"><a href="#__codelineno-12-64" id="__codelineno-12-64" name="__codelineno-12-64"></a>
</span><span id="__span-12-65"><a href="#__codelineno-12-65" id="__codelineno-12-65" name="__codelineno-12-65"></a>            <span class="c1"># Generate responsive variants</span>
</span><span id="__span-12-66"><a href="#__codelineno-12-66" id="__codelineno-12-66" name="__codelineno-12-66"></a>            <span class="k">if</span> <span class="n">generate_responsive</span><span class="p">:</span>
</span><span id="__span-12-67"><a href="#__codelineno-12-67" id="__codelineno-12-67" name="__codelineno-12-67"></a>                <span class="k">for</span> <span class="n">max_width</span><span class="p">,</span> <span class="nb">breakpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">responsive_breakpoints</span><span class="p">:</span>
</span><span id="__span-12-68"><a href="#__codelineno-12-68" id="__codelineno-12-68" name="__codelineno-12-68"></a>                    <span class="k">if</span> <span class="n">original_image</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">max_width</span><span class="p">:</span>
</span><span id="__span-12-69"><a href="#__codelineno-12-69" id="__codelineno-12-69" name="__codelineno-12-69"></a>                        <span class="n">responsive_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_responsive_variant</span><span class="p">(</span>
</span><span id="__span-12-70"><a href="#__codelineno-12-70" id="__codelineno-12-70" name="__codelineno-12-70"></a>                            <span class="n">original_image</span><span class="p">,</span> <span class="n">max_width</span>
</span><span id="__span-12-71"><a href="#__codelineno-12-71" id="__codelineno-12-71" name="__codelineno-12-71"></a>                        <span class="p">)</span>
</span><span id="__span-12-72"><a href="#__codelineno-12-72" id="__codelineno-12-72" name="__codelineno-12-72"></a>                        <span class="n">variants</span><span class="p">[</span><span class="sa">f</span><span class="s2">"responsive_</span><span class="si">{</span><span class="nb">breakpoint</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-73"><a href="#__codelineno-12-73" id="__codelineno-12-73" name="__codelineno-12-73"></a>                            <span class="s2">"data"</span><span class="p">:</span> <span class="n">responsive_data</span><span class="p">,</span>
</span><span id="__span-12-74"><a href="#__codelineno-12-74" id="__codelineno-12-74" name="__codelineno-12-74"></a>                            <span class="s2">"width"</span><span class="p">:</span> <span class="n">max_width</span><span class="p">,</span>
</span><span id="__span-12-75"><a href="#__codelineno-12-75" id="__codelineno-12-75" name="__codelineno-12-75"></a>                            <span class="s2">"height"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">original_image</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_width</span> <span class="o">/</span> <span class="n">original_image</span><span class="o">.</span><span class="n">width</span><span class="p">)),</span>
</span><span id="__span-12-76"><a href="#__codelineno-12-76" id="__codelineno-12-76" name="__codelineno-12-76"></a>                            <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"WebP"</span><span class="p">,</span>
</span><span id="__span-12-77"><a href="#__codelineno-12-77" id="__codelineno-12-77" name="__codelineno-12-77"></a>                            <span class="s2">"file_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">responsive_data</span><span class="p">)</span>
</span><span id="__span-12-78"><a href="#__codelineno-12-78" id="__codelineno-12-78" name="__codelineno-12-78"></a>                        <span class="p">}</span>
</span><span id="__span-12-79"><a href="#__codelineno-12-79" id="__codelineno-12-79" name="__codelineno-12-79"></a>
</span><span id="__span-12-80"><a href="#__codelineno-12-80" id="__codelineno-12-80" name="__codelineno-12-80"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-12-81"><a href="#__codelineno-12-81" id="__codelineno-12-81" name="__codelineno-12-81"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-82"><a href="#__codelineno-12-82" id="__codelineno-12-82" name="__codelineno-12-82"></a>                <span class="s2">"variants"</span><span class="p">:</span> <span class="n">variants</span><span class="p">,</span>
</span><span id="__span-12-83"><a href="#__codelineno-12-83" id="__codelineno-12-83" name="__codelineno-12-83"></a>                <span class="s2">"original_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="p">),</span>
</span><span id="__span-12-84"><a href="#__codelineno-12-84" id="__codelineno-12-84" name="__codelineno-12-84"></a>                <span class="s2">"total_variants"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variants</span><span class="p">),</span>
</span><span id="__span-12-85"><a href="#__codelineno-12-85" id="__codelineno-12-85" name="__codelineno-12-85"></a>                <span class="s2">"space_savings"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_space_savings</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">variants</span><span class="p">)</span>
</span><span id="__span-12-86"><a href="#__codelineno-12-86" id="__codelineno-12-86" name="__codelineno-12-86"></a>            <span class="p">}</span>
</span><span id="__span-12-87"><a href="#__codelineno-12-87" id="__codelineno-12-87" name="__codelineno-12-87"></a>
</span><span id="__span-12-88"><a href="#__codelineno-12-88" id="__codelineno-12-88" name="__codelineno-12-88"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-12-89"><a href="#__codelineno-12-89" id="__codelineno-12-89" name="__codelineno-12-89"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image processing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-90"><a href="#__codelineno-12-90" id="__codelineno-12-90" name="__codelineno-12-90"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-12-91"><a href="#__codelineno-12-91" id="__codelineno-12-91" name="__codelineno-12-91"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-92"><a href="#__codelineno-12-92" id="__codelineno-12-92" name="__codelineno-12-92"></a>                <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-12-93"><a href="#__codelineno-12-93" id="__codelineno-12-93" name="__codelineno-12-93"></a>                <span class="s2">"variants"</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="__span-12-94"><a href="#__codelineno-12-94" id="__codelineno-12-94" name="__codelineno-12-94"></a>            <span class="p">}</span>
</span><span id="__span-12-95"><a href="#__codelineno-12-95" id="__codelineno-12-95" name="__codelineno-12-95"></a>
</span><span id="__span-12-96"><a href="#__codelineno-12-96" id="__codelineno-12-96" name="__codelineno-12-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_optimize_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="__span-12-97"><a href="#__codelineno-12-97" id="__codelineno-12-97" name="__codelineno-12-97"></a><span class="w">        </span><span class="sd">"""Optimize image for web delivery"""</span>
</span><span id="__span-12-98"><a href="#__codelineno-12-98" id="__codelineno-12-98" name="__codelineno-12-98"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="__span-12-99"><a href="#__codelineno-12-99" id="__codelineno-12-99" name="__codelineno-12-99"></a>
</span><span id="__span-12-100"><a href="#__codelineno-12-100" id="__codelineno-12-100" name="__codelineno-12-100"></a>        <span class="c1"># Convert to RGB if necessary</span>
</span><span id="__span-12-101"><a href="#__codelineno-12-101" id="__codelineno-12-101" name="__codelineno-12-101"></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'RGBA'</span><span class="p">,</span> <span class="s1">'LA'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">):</span>
</span><span id="__span-12-102"><a href="#__codelineno-12-102" id="__codelineno-12-102" name="__codelineno-12-102"></a>            <span class="c1"># Create white background for transparency</span>
</span><span id="__span-12-103"><a href="#__codelineno-12-103" id="__codelineno-12-103" name="__codelineno-12-103"></a>            <span class="n">background</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
</span><span id="__span-12-104"><a href="#__codelineno-12-104" id="__codelineno-12-104" name="__codelineno-12-104"></a>            <span class="n">background</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">'RGBA'</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-12-105"><a href="#__codelineno-12-105" id="__codelineno-12-105" name="__codelineno-12-105"></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">background</span>
</span><span id="__span-12-106"><a href="#__codelineno-12-106" id="__codelineno-12-106" name="__codelineno-12-106"></a>
</span><span id="__span-12-107"><a href="#__codelineno-12-107" id="__codelineno-12-107" name="__codelineno-12-107"></a>        <span class="c1"># Save as WebP with optimization</span>
</span><span id="__span-12-108"><a href="#__codelineno-12-108" id="__codelineno-12-108" name="__codelineno-12-108"></a>        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="__span-12-109"><a href="#__codelineno-12-109" id="__codelineno-12-109" name="__codelineno-12-109"></a>            <span class="n">output</span><span class="p">,</span>
</span><span id="__span-12-110"><a href="#__codelineno-12-110" id="__codelineno-12-110" name="__codelineno-12-110"></a>            <span class="nb">format</span><span class="o">=</span><span class="s1">'WebP'</span><span class="p">,</span>
</span><span id="__span-12-111"><a href="#__codelineno-12-111" id="__codelineno-12-111" name="__codelineno-12-111"></a>            <span class="n">quality</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span>
</span><span id="__span-12-112"><a href="#__codelineno-12-112" id="__codelineno-12-112" name="__codelineno-12-112"></a>            <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-113"><a href="#__codelineno-12-113" id="__codelineno-12-113" name="__codelineno-12-113"></a>            <span class="n">method</span><span class="o">=</span><span class="mi">6</span>  <span class="c1"># Best compression</span>
</span><span id="__span-12-114"><a href="#__codelineno-12-114" id="__codelineno-12-114" name="__codelineno-12-114"></a>        <span class="p">)</span>
</span><span id="__span-12-115"><a href="#__codelineno-12-115" id="__codelineno-12-115" name="__codelineno-12-115"></a>
</span><span id="__span-12-116"><a href="#__codelineno-12-116" id="__codelineno-12-116" name="__codelineno-12-116"></a>        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="__span-12-117"><a href="#__codelineno-12-117" id="__codelineno-12-117" name="__codelineno-12-117"></a>
</span><span id="__span-12-118"><a href="#__codelineno-12-118" id="__codelineno-12-118" name="__codelineno-12-118"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_thumbnail</span><span class="p">(</span>
</span><span id="__span-12-119"><a href="#__codelineno-12-119" id="__codelineno-12-119" name="__codelineno-12-119"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-120"><a href="#__codelineno-12-120" id="__codelineno-12-120" name="__codelineno-12-120"></a>        <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
</span><span id="__span-12-121"><a href="#__codelineno-12-121" id="__codelineno-12-121" name="__codelineno-12-121"></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-12-122"><a href="#__codelineno-12-122" id="__codelineno-12-122" name="__codelineno-12-122"></a>        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-12-123"><a href="#__codelineno-12-123" id="__codelineno-12-123" name="__codelineno-12-123"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="__span-12-124"><a href="#__codelineno-12-124" id="__codelineno-12-124" name="__codelineno-12-124"></a><span class="w">        </span><span class="sd">"""Create optimized thumbnail"""</span>
</span><span id="__span-12-125"><a href="#__codelineno-12-125" id="__codelineno-12-125" name="__codelineno-12-125"></a>        <span class="c1"># Create thumbnail maintaining aspect ratio</span>
</span><span id="__span-12-126"><a href="#__codelineno-12-126" id="__codelineno-12-126" name="__codelineno-12-126"></a>        <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-12-127"><a href="#__codelineno-12-127" id="__codelineno-12-127" name="__codelineno-12-127"></a>        <span class="n">thumbnail</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
</span><span id="__span-12-128"><a href="#__codelineno-12-128" id="__codelineno-12-128" name="__codelineno-12-128"></a>
</span><span id="__span-12-129"><a href="#__codelineno-12-129" id="__codelineno-12-129" name="__codelineno-12-129"></a>        <span class="c1"># Center crop to exact dimensions</span>
</span><span id="__span-12-130"><a href="#__codelineno-12-130" id="__codelineno-12-130" name="__codelineno-12-130"></a>        <span class="k">if</span> <span class="n">thumbnail</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
</span><span id="__span-12-131"><a href="#__codelineno-12-131" id="__codelineno-12-131" name="__codelineno-12-131"></a>            <span class="n">thumbnail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_crop</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
</span><span id="__span-12-132"><a href="#__codelineno-12-132" id="__codelineno-12-132" name="__codelineno-12-132"></a>
</span><span id="__span-12-133"><a href="#__codelineno-12-133" id="__codelineno-12-133" name="__codelineno-12-133"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="__span-12-134"><a href="#__codelineno-12-134" id="__codelineno-12-134" name="__codelineno-12-134"></a>        <span class="n">thumbnail</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="__span-12-135"><a href="#__codelineno-12-135" id="__codelineno-12-135" name="__codelineno-12-135"></a>            <span class="n">output</span><span class="p">,</span>
</span><span id="__span-12-136"><a href="#__codelineno-12-136" id="__codelineno-12-136" name="__codelineno-12-136"></a>            <span class="nb">format</span><span class="o">=</span><span class="s1">'WebP'</span><span class="p">,</span>
</span><span id="__span-12-137"><a href="#__codelineno-12-137" id="__codelineno-12-137" name="__codelineno-12-137"></a>            <span class="n">quality</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
</span><span id="__span-12-138"><a href="#__codelineno-12-138" id="__codelineno-12-138" name="__codelineno-12-138"></a>            <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-12-139"><a href="#__codelineno-12-139" id="__codelineno-12-139" name="__codelineno-12-139"></a>        <span class="p">)</span>
</span><span id="__span-12-140"><a href="#__codelineno-12-140" id="__codelineno-12-140" name="__codelineno-12-140"></a>
</span><span id="__span-12-141"><a href="#__codelineno-12-141" id="__codelineno-12-141" name="__codelineno-12-141"></a>        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="__span-12-142"><a href="#__codelineno-12-142" id="__codelineno-12-142" name="__codelineno-12-142"></a>
</span><span id="__span-12-143"><a href="#__codelineno-12-143" id="__codelineno-12-143" name="__codelineno-12-143"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_center_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
</span><span id="__span-12-144"><a href="#__codelineno-12-144" id="__codelineno-12-144" name="__codelineno-12-144"></a><span class="w">        </span><span class="sd">"""Center crop image to exact dimensions"""</span>
</span><span id="__span-12-145"><a href="#__codelineno-12-145" id="__codelineno-12-145" name="__codelineno-12-145"></a>        <span class="n">img_width</span><span class="p">,</span> <span class="n">img_height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
</span><span id="__span-12-146"><a href="#__codelineno-12-146" id="__codelineno-12-146" name="__codelineno-12-146"></a>
</span><span id="__span-12-147"><a href="#__codelineno-12-147" id="__codelineno-12-147" name="__codelineno-12-147"></a>        <span class="c1"># Calculate crop box</span>
</span><span id="__span-12-148"><a href="#__codelineno-12-148" id="__codelineno-12-148" name="__codelineno-12-148"></a>        <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="__span-12-149"><a href="#__codelineno-12-149" id="__codelineno-12-149" name="__codelineno-12-149"></a>        <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="__span-12-150"><a href="#__codelineno-12-150" id="__codelineno-12-150" name="__codelineno-12-150"></a>        <span class="n">right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">width</span>
</span><span id="__span-12-151"><a href="#__codelineno-12-151" id="__codelineno-12-151" name="__codelineno-12-151"></a>        <span class="n">bottom</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">height</span>
</span><span id="__span-12-152"><a href="#__codelineno-12-152" id="__codelineno-12-152" name="__codelineno-12-152"></a>
</span><span id="__span-12-153"><a href="#__codelineno-12-153" id="__codelineno-12-153" name="__codelineno-12-153"></a>        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">))</span>
</span><span id="__span-12-154"><a href="#__codelineno-12-154" id="__codelineno-12-154" name="__codelineno-12-154"></a>
</span><span id="__span-12-155"><a href="#__codelineno-12-155" id="__codelineno-12-155" name="__codelineno-12-155"></a><span class="k">class</span><span class="w"> </span><span class="nc">CDNManager</span><span class="p">:</span>
</span><span id="__span-12-156"><a href="#__codelineno-12-156" id="__codelineno-12-156" name="__codelineno-12-156"></a><span class="w">    </span><span class="sd">"""Manages CDN integration and optimization"""</span>
</span><span id="__span-12-157"><a href="#__codelineno-12-157" id="__codelineno-12-157" name="__codelineno-12-157"></a>
</span><span id="__span-12-158"><a href="#__codelineno-12-158" id="__codelineno-12-158" name="__codelineno-12-158"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span><span id="__span-12-159"><a href="#__codelineno-12-159" id="__codelineno-12-159" name="__codelineno-12-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">cdn_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"base_url"</span><span class="p">)</span>
</span><span id="__span-12-160"><a href="#__codelineno-12-160" id="__codelineno-12-160" name="__codelineno-12-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span> <span class="o">=</span> <span class="n">cdn_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"signing_key"</span><span class="p">)</span>
</span><span id="__span-12-161"><a href="#__codelineno-12-161" id="__codelineno-12-161" name="__codelineno-12-161"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_transformations</span> <span class="o">=</span> <span class="n">cdn_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"enable_transformations"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="__span-12-162"><a href="#__codelineno-12-162" id="__codelineno-12-162" name="__codelineno-12-162"></a>
</span><span id="__span-12-163"><a href="#__codelineno-12-163" id="__codelineno-12-163" name="__codelineno-12-163"></a>        <span class="c1"># Predefined transformation presets</span>
</span><span id="__span-12-164"><a href="#__codelineno-12-164" id="__codelineno-12-164" name="__codelineno-12-164"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-165"><a href="#__codelineno-12-165" id="__codelineno-12-165" name="__codelineno-12-165"></a>            <span class="s2">"avatar"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-166"><a href="#__codelineno-12-166" id="__codelineno-12-166" name="__codelineno-12-166"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
</span><span id="__span-12-167"><a href="#__codelineno-12-167" id="__codelineno-12-167" name="__codelineno-12-167"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
</span><span id="__span-12-168"><a href="#__codelineno-12-168" id="__codelineno-12-168" name="__codelineno-12-168"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-12-169"><a href="#__codelineno-12-169" id="__codelineno-12-169" name="__codelineno-12-169"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"webp"</span><span class="p">,</span>
</span><span id="__span-12-170"><a href="#__codelineno-12-170" id="__codelineno-12-170" name="__codelineno-12-170"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span>
</span><span id="__span-12-171"><a href="#__codelineno-12-171" id="__codelineno-12-171" name="__codelineno-12-171"></a>            <span class="p">},</span>
</span><span id="__span-12-172"><a href="#__codelineno-12-172" id="__codelineno-12-172" name="__codelineno-12-172"></a>            <span class="s2">"thumbnail"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-173"><a href="#__codelineno-12-173" id="__codelineno-12-173" name="__codelineno-12-173"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-12-174"><a href="#__codelineno-12-174" id="__codelineno-12-174" name="__codelineno-12-174"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-12-175"><a href="#__codelineno-12-175" id="__codelineno-12-175" name="__codelineno-12-175"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
</span><span id="__span-12-176"><a href="#__codelineno-12-176" id="__codelineno-12-176" name="__codelineno-12-176"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"webp"</span><span class="p">,</span>
</span><span id="__span-12-177"><a href="#__codelineno-12-177" id="__codelineno-12-177" name="__codelineno-12-177"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span>
</span><span id="__span-12-178"><a href="#__codelineno-12-178" id="__codelineno-12-178" name="__codelineno-12-178"></a>            <span class="p">},</span>
</span><span id="__span-12-179"><a href="#__codelineno-12-179" id="__codelineno-12-179" name="__codelineno-12-179"></a>            <span class="s2">"hero"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-180"><a href="#__codelineno-12-180" id="__codelineno-12-180" name="__codelineno-12-180"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
</span><span id="__span-12-181"><a href="#__codelineno-12-181" id="__codelineno-12-181" name="__codelineno-12-181"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="__span-12-182"><a href="#__codelineno-12-182" id="__codelineno-12-182" name="__codelineno-12-182"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
</span><span id="__span-12-183"><a href="#__codelineno-12-183" id="__codelineno-12-183" name="__codelineno-12-183"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"webp"</span><span class="p">,</span>
</span><span id="__span-12-184"><a href="#__codelineno-12-184" id="__codelineno-12-184" name="__codelineno-12-184"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span>
</span><span id="__span-12-185"><a href="#__codelineno-12-185" id="__codelineno-12-185" name="__codelineno-12-185"></a>            <span class="p">}</span>
</span><span id="__span-12-186"><a href="#__codelineno-12-186" id="__codelineno-12-186" name="__codelineno-12-186"></a>        <span class="p">}</span>
</span><span id="__span-12-187"><a href="#__codelineno-12-187" id="__codelineno-12-187" name="__codelineno-12-187"></a>
</span><span id="__span-12-188"><a href="#__codelineno-12-188" id="__codelineno-12-188" name="__codelineno-12-188"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_optimized_url</span><span class="p">(</span>
</span><span id="__span-12-189"><a href="#__codelineno-12-189" id="__codelineno-12-189" name="__codelineno-12-189"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-190"><a href="#__codelineno-12-190" id="__codelineno-12-190" name="__codelineno-12-190"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-12-191"><a href="#__codelineno-12-191" id="__codelineno-12-191" name="__codelineno-12-191"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-192"><a href="#__codelineno-12-192" id="__codelineno-12-192" name="__codelineno-12-192"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-193"><a href="#__codelineno-12-193" id="__codelineno-12-193" name="__codelineno-12-193"></a><span class="w">        </span><span class="sd">"""Get CDN URL with optional transformations"""</span>
</span><span id="__span-12-194"><a href="#__codelineno-12-194" id="__codelineno-12-194" name="__codelineno-12-194"></a>
</span><span id="__span-12-195"><a href="#__codelineno-12-195" id="__codelineno-12-195" name="__codelineno-12-195"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_transformations</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">transformations</span><span class="p">:</span>
</span><span id="__span-12-196"><a href="#__codelineno-12-196" id="__codelineno-12-196" name="__codelineno-12-196"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-12-197"><a href="#__codelineno-12-197" id="__codelineno-12-197" name="__codelineno-12-197"></a>
</span><span id="__span-12-198"><a href="#__codelineno-12-198" id="__codelineno-12-198" name="__codelineno-12-198"></a>        <span class="c1"># Build transformation parameters</span>
</span><span id="__span-12-199"><a href="#__codelineno-12-199" id="__codelineno-12-199" name="__codelineno-12-199"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-12-200"><a href="#__codelineno-12-200" id="__codelineno-12-200" name="__codelineno-12-200"></a>
</span><span id="__span-12-201"><a href="#__codelineno-12-201" id="__codelineno-12-201" name="__codelineno-12-201"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">):</span>
</span><span id="__span-12-202"><a href="#__codelineno-12-202" id="__codelineno-12-202" name="__codelineno-12-202"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"w_</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-203"><a href="#__codelineno-12-203" id="__codelineno-12-203" name="__codelineno-12-203"></a>
</span><span id="__span-12-204"><a href="#__codelineno-12-204" id="__codelineno-12-204" name="__codelineno-12-204"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">):</span>
</span><span id="__span-12-205"><a href="#__codelineno-12-205" id="__codelineno-12-205" name="__codelineno-12-205"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"h_</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-206"><a href="#__codelineno-12-206" id="__codelineno-12-206" name="__codelineno-12-206"></a>
</span><span id="__span-12-207"><a href="#__codelineno-12-207" id="__codelineno-12-207" name="__codelineno-12-207"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">):</span>
</span><span id="__span-12-208"><a href="#__codelineno-12-208" id="__codelineno-12-208" name="__codelineno-12-208"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"q_</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'quality'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-209"><a href="#__codelineno-12-209" id="__codelineno-12-209" name="__codelineno-12-209"></a>
</span><span id="__span-12-210"><a href="#__codelineno-12-210" id="__codelineno-12-210" name="__codelineno-12-210"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">):</span>
</span><span id="__span-12-211"><a href="#__codelineno-12-211" id="__codelineno-12-211" name="__codelineno-12-211"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f_</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-212"><a href="#__codelineno-12-212" id="__codelineno-12-212" name="__codelineno-12-212"></a>
</span><span id="__span-12-213"><a href="#__codelineno-12-213" id="__codelineno-12-213" name="__codelineno-12-213"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"crop"</span><span class="p">):</span>
</span><span id="__span-12-214"><a href="#__codelineno-12-214" id="__codelineno-12-214" name="__codelineno-12-214"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"c_</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'crop'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-215"><a href="#__codelineno-12-215" id="__codelineno-12-215" name="__codelineno-12-215"></a>
</span><span id="__span-12-216"><a href="#__codelineno-12-216" id="__codelineno-12-216" name="__codelineno-12-216"></a>        <span class="c1"># Construct URL with transformations</span>
</span><span id="__span-12-217"><a href="#__codelineno-12-217" id="__codelineno-12-217" name="__codelineno-12-217"></a>        <span class="n">transform_string</span> <span class="o">=</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-12-218"><a href="#__codelineno-12-218" id="__codelineno-12-218" name="__codelineno-12-218"></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transform_string</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-12-219"><a href="#__codelineno-12-219" id="__codelineno-12-219" name="__codelineno-12-219"></a>
</span><span id="__span-12-220"><a href="#__codelineno-12-220" id="__codelineno-12-220" name="__codelineno-12-220"></a>        <span class="c1"># Add signature if required</span>
</span><span id="__span-12-221"><a href="#__codelineno-12-221" id="__codelineno-12-221" name="__codelineno-12-221"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span><span class="p">:</span>
</span><span id="__span-12-222"><a href="#__codelineno-12-222" id="__codelineno-12-222" name="__codelineno-12-222"></a>            <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_signature</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-12-223"><a href="#__codelineno-12-223" id="__codelineno-12-223" name="__codelineno-12-223"></a>            <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"?sig=</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-12-224"><a href="#__codelineno-12-224" id="__codelineno-12-224" name="__codelineno-12-224"></a>
</span><span id="__span-12-225"><a href="#__codelineno-12-225" id="__codelineno-12-225" name="__codelineno-12-225"></a>        <span class="k">return</span> <span class="n">url</span>
</span><span id="__span-12-226"><a href="#__codelineno-12-226" id="__codelineno-12-226" name="__codelineno-12-226"></a>
</span><span id="__span-12-227"><a href="#__codelineno-12-227" id="__codelineno-12-227" name="__codelineno-12-227"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_preset_url</span><span class="p">(</span>
</span><span id="__span-12-228"><a href="#__codelineno-12-228" id="__codelineno-12-228" name="__codelineno-12-228"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-229"><a href="#__codelineno-12-229" id="__codelineno-12-229" name="__codelineno-12-229"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-12-230"><a href="#__codelineno-12-230" id="__codelineno-12-230" name="__codelineno-12-230"></a>        <span class="n">preset_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-231"><a href="#__codelineno-12-231" id="__codelineno-12-231" name="__codelineno-12-231"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-232"><a href="#__codelineno-12-232" id="__codelineno-12-232" name="__codelineno-12-232"></a><span class="w">        </span><span class="sd">"""Get CDN URL using predefined preset"""</span>
</span><span id="__span-12-233"><a href="#__codelineno-12-233" id="__codelineno-12-233" name="__codelineno-12-233"></a>
</span><span id="__span-12-234"><a href="#__codelineno-12-234" id="__codelineno-12-234" name="__codelineno-12-234"></a>        <span class="k">if</span> <span class="n">preset_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presets</span><span class="p">:</span>
</span><span id="__span-12-235"><a href="#__codelineno-12-235" id="__codelineno-12-235" name="__codelineno-12-235"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown preset: </span><span class="si">{</span><span class="n">preset_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-236"><a href="#__codelineno-12-236" id="__codelineno-12-236" name="__codelineno-12-236"></a>
</span><span id="__span-12-237"><a href="#__codelineno-12-237" id="__codelineno-12-237" name="__codelineno-12-237"></a>        <span class="n">transformations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presets</span><span class="p">[</span><span class="n">preset_name</span><span class="p">]</span>
</span><span id="__span-12-238"><a href="#__codelineno-12-238" id="__codelineno-12-238" name="__codelineno-12-238"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-12-239"><a href="#__codelineno-12-239" id="__codelineno-12-239" name="__codelineno-12-239"></a>
</span><span id="__span-12-240"><a href="#__codelineno-12-240" id="__codelineno-12-240" name="__codelineno-12-240"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_responsive_urls</span><span class="p">(</span>
</span><span id="__span-12-241"><a href="#__codelineno-12-241" id="__codelineno-12-241" name="__codelineno-12-241"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-242"><a href="#__codelineno-12-242" id="__codelineno-12-242" name="__codelineno-12-242"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-12-243"><a href="#__codelineno-12-243" id="__codelineno-12-243" name="__codelineno-12-243"></a>        <span class="n">breakpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-12-244"><a href="#__codelineno-12-244" id="__codelineno-12-244" name="__codelineno-12-244"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-12-245"><a href="#__codelineno-12-245" id="__codelineno-12-245" name="__codelineno-12-245"></a><span class="w">        </span><span class="sd">"""Get responsive image URLs for different breakpoints"""</span>
</span><span id="__span-12-246"><a href="#__codelineno-12-246" id="__codelineno-12-246" name="__codelineno-12-246"></a>
</span><span id="__span-12-247"><a href="#__codelineno-12-247" id="__codelineno-12-247" name="__codelineno-12-247"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">breakpoints</span><span class="p">:</span>
</span><span id="__span-12-248"><a href="#__codelineno-12-248" id="__codelineno-12-248" name="__codelineno-12-248"></a>            <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1920</span><span class="p">]</span>
</span><span id="__span-12-249"><a href="#__codelineno-12-249" id="__codelineno-12-249" name="__codelineno-12-249"></a>
</span><span id="__span-12-250"><a href="#__codelineno-12-250" id="__codelineno-12-250" name="__codelineno-12-250"></a>        <span class="n">responsive_urls</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-12-251"><a href="#__codelineno-12-251" id="__codelineno-12-251" name="__codelineno-12-251"></a>
</span><span id="__span-12-252"><a href="#__codelineno-12-252" id="__codelineno-12-252" name="__codelineno-12-252"></a>        <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
</span><span id="__span-12-253"><a href="#__codelineno-12-253" id="__codelineno-12-253" name="__codelineno-12-253"></a>            <span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-254"><a href="#__codelineno-12-254" id="__codelineno-12-254" name="__codelineno-12-254"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
</span><span id="__span-12-255"><a href="#__codelineno-12-255" id="__codelineno-12-255" name="__codelineno-12-255"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-12-256"><a href="#__codelineno-12-256" id="__codelineno-12-256" name="__codelineno-12-256"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"webp"</span>
</span><span id="__span-12-257"><a href="#__codelineno-12-257" id="__codelineno-12-257" name="__codelineno-12-257"></a>            <span class="p">}</span>
</span><span id="__span-12-258"><a href="#__codelineno-12-258" id="__codelineno-12-258" name="__codelineno-12-258"></a>
</span><span id="__span-12-259"><a href="#__codelineno-12-259" id="__codelineno-12-259" name="__codelineno-12-259"></a>            <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-12-260"><a href="#__codelineno-12-260" id="__codelineno-12-260" name="__codelineno-12-260"></a>            <span class="n">responsive_urls</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">w"</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
</span><span id="__span-12-261"><a href="#__codelineno-12-261" id="__codelineno-12-261" name="__codelineno-12-261"></a>
</span><span id="__span-12-262"><a href="#__codelineno-12-262" id="__codelineno-12-262" name="__codelineno-12-262"></a>        <span class="k">return</span> <span class="n">responsive_urls</span>
</span></code></pre></div> <h2 id="background-processing">Background Processing<a class="headerlink" href="#background-processing" title="Permanent link">¶</a></h2> <h3 id="celery-task-implementation">Celery Task Implementation<a class="headerlink" href="#celery-task-implementation" title="Permanent link">¶</a></h3> <p>The complete Celery task implementation is already present in the codebase at: - <code>apps/backend/workers/tasks/storage_tasks.py</code></p> <p>Key background processing features: - <strong>Virus Scanning</strong>: Real-time ClamAV integration - <strong>Image Processing</strong>: Thumbnail and variant generation - <strong>Storage Analytics</strong>: Usage calculation and reporting - <strong>Cleanup Operations</strong>: Automated file retention and cleanup - <strong>Quota Monitoring</strong>: Threshold alerts and notifications</p> <h2 id="integration-patterns">Integration Patterns<a class="headerlink" href="#integration-patterns" title="Permanent link">¶</a></h2> <h3 id="fastapi-dependency-injection">FastAPI Dependency Injection<a class="headerlink" href="#fastapi-dependency-injection" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.dependencies.tenant</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_tenant</span><span class="p">,</span> <span class="n">TenantContext</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.dependencies.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_user</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps.backend.services.storage.supabase_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupabaseStorageProvider</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_storage_service</span><span class="p">(</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="n">tenant_context</span><span class="p">:</span> <span class="n">TenantContext</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_tenant</span><span class="p">)</span>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SupabaseStorageProvider</span><span class="p">:</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="sd">"""Dependency to get storage service with proper context"""</span>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a>
</span><span id="__span-13-14"><a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a>    <span class="k">return</span> <span class="n">SupabaseStorageProvider</span><span class="p">(</span>
</span><span id="__span-13-15"><a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a>        <span class="n">organization_id</span><span class="o">=</span><span class="n">tenant_context</span><span class="o">.</span><span class="n">organization_id</span><span class="p">,</span>
</span><span id="__span-13-16"><a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-13-17"><a href="#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a>    <span class="p">)</span>
</span><span id="__span-13-18"><a href="#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a>
</span><span id="__span-13-19"><a href="#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="c1"># Usage in endpoints</span>
</span><span id="__span-13-20"><a href="#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/files/upload"</span><span class="p">)</span>
</span><span id="__span-13-21"><a href="#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span>
</span><span id="__span-13-22"><a href="#__codelineno-13-22" id="__codelineno-13-22" name="__codelineno-13-22"></a>    <span class="n">file</span><span class="p">:</span> <span class="n">UploadFile</span><span class="p">,</span>
</span><span id="__span-13-23"><a href="#__codelineno-13-23" id="__codelineno-13-23" name="__codelineno-13-23"></a>    <span class="n">storage</span><span class="p">:</span> <span class="n">SupabaseStorageProvider</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_storage_service</span><span class="p">)</span>
</span><span id="__span-13-24"><a href="#__codelineno-13-24" id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="p">):</span>
</span><span id="__span-13-25"><a href="#__codelineno-13-25" id="__codelineno-13-25" name="__codelineno-13-25"></a>    <span class="c1"># Storage service is automatically configured with user/org context</span>
</span><span id="__span-13-26"><a href="#__codelineno-13-26" id="__codelineno-13-26" name="__codelineno-13-26"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
</span><span id="__span-13-27"><a href="#__codelineno-13-27" id="__codelineno-13-27" name="__codelineno-13-27"></a>        <span class="n">file_data</span><span class="o">=</span><span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
</span><span id="__span-13-28"><a href="#__codelineno-13-28" id="__codelineno-13-28" name="__codelineno-13-28"></a>        <span class="n">filename</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
</span><span id="__span-13-29"><a href="#__codelineno-13-29" id="__codelineno-13-29" name="__codelineno-13-29"></a>        <span class="n">options</span><span class="o">=</span><span class="n">UploadOptions</span><span class="p">(</span><span class="n">file_category</span><span class="o">=</span><span class="s2">"educational_content"</span><span class="p">)</span>
</span><span id="__span-13-30"><a href="#__codelineno-13-30" id="__codelineno-13-30" name="__codelineno-13-30"></a>    <span class="p">)</span>
</span><span id="__span-13-31"><a href="#__codelineno-13-31" id="__codelineno-13-31" name="__codelineno-13-31"></a>    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div> <h3 id="database-session-management">Database Session Management<a class="headerlink" href="#database-session-management" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">AsyncSession</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseManager</span><span class="p">:</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="sd">"""Manages database connections with proper RLS context"""</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>            <span class="n">settings</span><span class="o">.</span><span class="n">DATABASE_URL</span><span class="p">,</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a>            <span class="n">echo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>            <span class="n">pool_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a>            <span class="n">max_overflow</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a>        <span class="p">)</span>
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a>
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a>    <span class="nd">@asynccontextmanager</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session_with_context</span><span class="p">(</span>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">UUID</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a>    <span class="p">):</span>
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="w">        </span><span class="sd">"""Get database session with RLS context set"""</span>
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a>            <span class="c1"># Set RLS context</span>
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a>                <span class="n">text</span><span class="p">(</span><span class="s2">"SELECT set_config('app.current_organization_id', :org_id, true)"</span><span class="p">),</span>
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a>                <span class="p">{</span><span class="s2">"org_id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)}</span>
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>            <span class="p">)</span>
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a>                <span class="n">text</span><span class="p">(</span><span class="s2">"SELECT set_config('app.current_user_id', :user_id, true)"</span><span class="p">),</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a>                <span class="p">{</span><span class="s2">"user_id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)}</span>
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a>            <span class="p">)</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a>                <span class="k">yield</span> <span class="n">session</span>
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a>                <span class="c1"># Clean up context</span>
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a>                    <span class="n">text</span><span class="p">(</span><span class="s2">"SELECT set_config('app.current_organization_id', '', true)"</span><span class="p">)</span>
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a>                <span class="p">)</span>
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a>                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a>                    <span class="n">text</span><span class="p">(</span><span class="s2">"SELECT set_config('app.current_user_id', '', true)"</span><span class="p">)</span>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a>                <span class="p">)</span>
</span></code></pre></div> <h2 id="deployment-configuration">Deployment Configuration<a class="headerlink" href="#deployment-configuration" title="Permanent link">¶</a></h2> <h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">¶</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Supabase Configuration</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nv">SUPABASE_URL</span><span class="o">=</span>https://your-project.supabase.co
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="nv">SUPABASE_SERVICE_ROLE_KEY</span><span class="o">=</span>your-service-role-key
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="nv">SUPABASE_ANON_KEY</span><span class="o">=</span>your-anon-key
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="c1"># Storage Configuration</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="nv">STORAGE_DEFAULT_QUOTA_GB</span><span class="o">=</span><span class="m">5</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="nv">STORAGE_MAX_FILE_SIZE_MB</span><span class="o">=</span><span class="m">100</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="nv">STORAGE_ENABLE_VIRUS_SCAN</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="nv">STORAGE_ENABLE_IMAGE_OPTIMIZATION</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="c1"># CDN Configuration</span>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="nv">CDN_BASE_URL</span><span class="o">=</span>https://cdn.yourapp.com
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="nv">CDN_SIGNING_KEY</span><span class="o">=</span>your-signing-key
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="nv">CDN_ENABLE_TRANSFORMATIONS</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="c1"># Security</span>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="nv">STORAGE_ENCRYPTION_KEY</span><span class="o">=</span>your-encryption-key
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="nv">STORAGE_SIGNING_SECRET</span><span class="o">=</span>your-signing-secret
</span><span id="__span-15-20"><a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a>
</span><span id="__span-15-21"><a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="c1"># Celery/Redis</span>
</span><span id="__span-15-22"><a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="nv">REDIS_URL</span><span class="o">=</span>redis://localhost:6379/0
</span><span id="__span-15-23"><a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="nv">CELERY_BROKER_URL</span><span class="o">=</span>redis://localhost:6379/0
</span><span id="__span-15-24"><a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="nv">CELERY_RESULT_BACKEND</span><span class="o">=</span>redis://localhost:6379/0
</span><span id="__span-15-25"><a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a>
</span><span id="__span-15-26"><a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="c1"># ClamAV</span>
</span><span id="__span-15-27"><a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="nv">CLAMAV_SOCKET_PATH</span><span class="o">=</span>/var/run/clamav/clamd.ctl
</span><span id="__span-15-28"><a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="nv">CLAMAV_TCP_HOST</span><span class="o">=</span>localhost
</span><span id="__span-15-29"><a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="nv">CLAMAV_TCP_PORT</span><span class="o">=</span><span class="m">3310</span>
</span><span id="__span-15-30"><a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a>
</span><span id="__span-15-31"><a href="#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="c1"># Monitoring</span>
</span><span id="__span-15-32"><a href="#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="nv">PROMETHEUS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-15-33"><a href="#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="nv">STRUCTURED_LOGGING</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-15-34"><a href="#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
</span></code></pre></div> <h3 id="docker-compose-setup">Docker Compose Setup<a class="headerlink" href="#docker-compose-setup" title="Permanent link">¶</a></h3> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="nt">fastapi</span><span class="p">:</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SUPABASE_URL=${SUPABASE_URL}</span>
</span><span id="__span-16-8"><a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}</span>
</span><span id="__span-16-9"><a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDIS_URL=redis://redis:6379/0</span>
</span><span id="__span-16-10"><a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
</span><span id="__span-16-11"><a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
</span><span id="__span-16-12"><a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clamav</span>
</span><span id="__span-16-13"><a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-16-14"><a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./uploads:/tmp/uploads</span>
</span><span id="__span-16-15"><a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a>
</span><span id="__span-16-16"><a href="#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">  </span><span class="nt">celery-worker</span><span class="p">:</span>
</span><span id="__span-16-17"><a href="#__codelineno-16-17" id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id="__span-16-18"><a href="#__codelineno-16-18" id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A apps.backend.workers.celery_app worker --loglevel=info</span>
</span><span id="__span-16-19"><a href="#__codelineno-16-19" id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-16-20"><a href="#__codelineno-16-20" id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDIS_URL=redis://redis:6379/0</span>
</span><span id="__span-16-21"><a href="#__codelineno-16-21" id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CLAMAV_TCP_HOST=clamav</span>
</span><span id="__span-16-22"><a href="#__codelineno-16-22" id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
</span><span id="__span-16-23"><a href="#__codelineno-16-23" id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
</span><span id="__span-16-24"><a href="#__codelineno-16-24" id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clamav</span>
</span><span id="__span-16-25"><a href="#__codelineno-16-25" id="__codelineno-16-25" name="__codelineno-16-25"></a>
</span><span id="__span-16-26"><a href="#__codelineno-16-26" id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="w">  </span><span class="nt">celery-beat</span><span class="p">:</span>
</span><span id="__span-16-27"><a href="#__codelineno-16-27" id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id="__span-16-28"><a href="#__codelineno-16-28" id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A apps.backend.workers.celery_app beat --loglevel=info</span>
</span><span id="__span-16-29"><a href="#__codelineno-16-29" id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-16-30"><a href="#__codelineno-16-30" id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDIS_URL=redis://redis:6379/0</span>
</span><span id="__span-16-31"><a href="#__codelineno-16-31" id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
</span><span id="__span-16-32"><a href="#__codelineno-16-32" id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
</span><span id="__span-16-33"><a href="#__codelineno-16-33" id="__codelineno-16-33" name="__codelineno-16-33"></a>
</span><span id="__span-16-34"><a href="#__codelineno-16-34" id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
</span><span id="__span-16-35"><a href="#__codelineno-16-35" id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
</span><span id="__span-16-36"><a href="#__codelineno-16-36" id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-16-37"><a href="#__codelineno-16-37" id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"6379:6379"</span>
</span><span id="__span-16-38"><a href="#__codelineno-16-38" id="__codelineno-16-38" name="__codelineno-16-38"></a>
</span><span id="__span-16-39"><a href="#__codelineno-16-39" id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">  </span><span class="nt">clamav</span><span class="p">:</span>
</span><span id="__span-16-40"><a href="#__codelineno-16-40" id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clamav/clamav:latest</span>
</span><span id="__span-16-41"><a href="#__codelineno-16-41" id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-16-42"><a href="#__codelineno-16-42" id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"3310:3310"</span>
</span><span id="__span-16-43"><a href="#__codelineno-16-43" id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-16-44"><a href="#__codelineno-16-44" id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clamav_data:/var/lib/clamav</span>
</span><span id="__span-16-45"><a href="#__codelineno-16-45" id="__codelineno-16-45" name="__codelineno-16-45"></a>
</span><span id="__span-16-46"><a href="#__codelineno-16-46" id="__codelineno-16-46" name="__codelineno-16-46"></a><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-16-47"><a href="#__codelineno-16-47" id="__codelineno-16-47" name="__codelineno-16-47"></a><span class="w">  </span><span class="nt">clamav_data</span><span class="p">:</span>
</span></code></pre></div> <p>This implementation provides a comprehensive, production-ready storage system that leverages Supabase's capabilities while maintaining educational compliance, security, and performance requirements. The modular design allows for easy testing, maintenance, and future enhancements.</p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:00:33 UTC"><span class="timeago" datetime="2025-09-28T04:00:33+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:00:33 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Created"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:00:33 UTC"><span class="timeago" datetime="2025-09-28T04:00:33+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:00:33 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Contributors"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"></path></svg> </span> <nav> <a href="mailto:140660682+grayghostdev@users.noreply.github.com">GrayGhostDev</a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button class="md-top md-icon" data-md-component="top" hidden="" type="button"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 ToolBoxAI Solutions </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/ToolBoxAI-Solutions" rel="noopener" target="_blank" title="ToolBoxAI on GitHub"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a class="md-social__link" href="https://discord.gg/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Discord"> <svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"></path></svg> </a> <a class="md-social__link" href="https://twitter.com/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Twitter"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <div class="md-progress" data-md-component="progress" role="progressbar"></div> <div class="md-consent" data-md-component="consent" hidden="" id="__consent"> <div class="md-consent__overlay"></div> <aside class="md-consent__inner"> <form class="md-consent__form md-grid md-typeset" name="consent"> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class="md-toggle" id="__settings" type="checkbox"/> <div class="md-consent__settings"> <ul class="task-list"> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="analytics" type="checkbox"/> <span class="task-list-indicator"></span> Google Analytics </label> </li> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="github" type="checkbox"/> <span class="task-list-indicator"></span> GitHub </label> </li> </ul> </div> <div class="md-consent__controls"> <button class="md-button md-button--primary">Accept</button> <label class="md-button" for="__settings">Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script> <script src="../../js/timeago.min.js"></script> <script src="../../js/timeago_mkdocs_material.js"></script> <script src="../../javascripts/extra.js"></script> <script src="../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> </body> </html>