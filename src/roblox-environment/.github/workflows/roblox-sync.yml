name: Roblox Studio Sync

on:
  push:
    branches: [main, develop]
    paths:
      - 'Roblox/**'
      - 'rojo.json'
      - 'default.project.json'
  pull_request:
    branches: [main]
    paths:
      - 'Roblox/**'
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync operation'
        required: true
        default: 'build'
        type: choice
        options:
          - build
          - deploy
          - publish
      place_id:
        description: 'Roblox Place ID (for deployment)'
        required: false
        type: string
      universe_id:
        description: 'Roblox Universe ID (for publishing)'
        required: false
        type: string

env:
  ROJO_VERSION: '7.4.0'
  LUAU_LSP_VERSION: '1.29.0'

jobs:
  validate-lua:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Luau
        run: |
          wget -O luau.tar.gz "https://github.com/Roblox/luau/releases/latest/download/luau-ubuntu.zip"
          unzip luau.tar.gz
          chmod +x luau*
          sudo mv luau* /usr/local/bin/
      
      - name: Install StyLua
        run: |
          wget -O stylua.zip "https://github.com/JohnnyMorganz/StyLua/releases/latest/download/stylua-linux.zip"
          unzip stylua.zip
          chmod +x stylua
          sudo mv stylua /usr/local/bin/
      
      - name: Check Lua syntax
        run: |
          find Roblox/ -name "*.lua" -exec luau-analyze {} \;
      
      - name: Check Lua formatting
        run: |
          stylua --check Roblox/
      
      - name: Run Lua linting
        run: |
          # Install selene linter
          cargo install selene
          selene Roblox/
        continue-on-error: true
      
      - name: Validate Rojo configuration
        run: |
          if [ -f "rojo.json" ]; then
            echo "Found rojo.json"
            cat rojo.json | jq '.' > /dev/null && echo "âœ… Valid JSON" || exit 1
          elif [ -f "default.project.json" ]; then
            echo "Found default.project.json"
            cat default.project.json | jq '.' > /dev/null && echo "âœ… Valid JSON" || exit 1
          else
            echo "âŒ No Rojo configuration found"
            exit 1
          fi

  build-roblox:
    runs-on: windows-latest
    needs: validate-lua
    outputs:
      rbxl-path: ${{ steps.build.outputs.rbxl-path }}
      rbxm-path: ${{ steps.build.outputs.rbxm-path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rojo
        run: |
          Invoke-WebRequest -Uri "https://github.com/rojo-rbx/rojo/releases/download/v${{ env.ROJO_VERSION }}/rojo-${{ env.ROJO_VERSION }}-win64.zip" -OutFile "rojo.zip"
          Expand-Archive -Path "rojo.zip" -DestinationPath "rojo"
          $env:PATH += ";$PWD\rojo"
          echo "$PWD\rojo" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Install Foreman (Roblox tool manager)
        run: |
          Invoke-WebRequest -Uri "https://github.com/Roblox/foreman/releases/latest/download/foreman-win64.zip" -OutFile "foreman.zip"
          Expand-Archive -Path "foreman.zip" -DestinationPath "foreman"
          $env:PATH += ";$PWD\foreman"
          echo "$PWD\foreman" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Install additional Roblox tools
        run: |
          # Create foreman.toml if it doesn't exist
          if (-not (Test-Path "foreman.toml")) {
            @"
          [tools]
          rojo = "rojo-rbx/rojo@${{ env.ROJO_VERSION }}"
          remodel = "rojo-rbx/remodel@0.11.0"
          "@" | Out-File -FilePath "foreman.toml" -Encoding utf8
          }
          foreman install
      
      - name: Build place file (.rbxl)
        id: build
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $rbxlName = "ToolboxAI-Roblox-$timestamp.rbxl"
          $rbxmName = "ToolboxAI-Roblox-$timestamp.rbxm"
          
          # Build place file
          rojo build --output "$rbxlName"
          
          # Build model file for plugin distribution
          if (Test-Path "Roblox/Plugins") {
            rojo build Roblox/Plugins --output "$rbxmName"
          }
          
          # Set outputs
          echo "rbxl-path=$rbxlName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          if (Test-Path $rbxmName) {
            echo "rbxm-path=$rbxmName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
      
      - name: Validate build artifacts
        run: |
          $rbxlPath = "${{ steps.build.outputs.rbxl-path }}"
          if (Test-Path $rbxlPath) {
            $fileSize = (Get-Item $rbxlPath).Length
            echo "âœ… Built $rbxlPath ($fileSize bytes)"
            
            # Basic validation - check if file is not empty and has minimum expected size
            if ($fileSize -lt 1000) {
              echo "âŒ Build file seems too small, possible build failure"
              exit 1
            }
          } else {
            echo "âŒ Build failed - no output file"
            exit 1
          }
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: roblox-builds
          path: |
            ${{ steps.build.outputs.rbxl-path }}
            ${{ steps.build.outputs.rbxm-path }}
          retention-days: 30
      
      - name: Generate build manifest
        run: |
          $manifest = @{
            timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
            commit = "${{ github.sha }}"
            branch = "${{ github.ref_name }}"
            rbxl_file = "${{ steps.build.outputs.rbxl-path }}"
            rbxm_file = "${{ steps.build.outputs.rbxm-path }}"
            rojo_version = "${{ env.ROJO_VERSION }}"
          }
          $manifest | ConvertTo-Json | Out-File -FilePath "build-manifest.json" -Encoding utf8
      
      - name: Upload build manifest
        uses: actions/upload-artifact@v3
        with:
          name: build-manifest
          path: build-manifest.json

  test-roblox-scripts:
    runs-on: windows-latest
    needs: build-roblox
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Roblox testing tools
        run: |
          # Install TestEZ and other testing frameworks
          git clone https://github.com/Roblox/TestEZ.git tools/TestEZ
          git clone https://github.com/Kampfkarren/Roact.git tools/Roact
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: roblox-builds
      
      - name: Run Lua unit tests
        run: |
          # Create a test runner script
          $testRunner = @"
          local TestEZ = require(script.TestEZ)
          local TestResults = TestEZ.TestBootstrap:run({
              script.Roblox.Tests
          })
          
          if TestResults.failureCount > 0 then
              error('Tests failed: ' .. TestResults.failureCount .. ' failures')
          end
          
          print('All tests passed: ' .. TestResults.successCount .. ' tests')
          "@
          
          $testRunner | Out-File -FilePath "test_runner.lua" -Encoding utf8
          
          # Note: In a real scenario, you'd run this inside Roblox Studio or a headless Roblox environment
          echo "Test runner created. In production, this would execute in Roblox environment."
      
      - name: Validate script structure
        run: |
          # Check for required files and structure
          $requiredFiles = @(
            "Roblox/Scripts/ServerScripts/Main.server.lua",
            "Roblox/Scripts/ModuleScripts/QuizSystem.lua",
            "Roblox/Plugins/AIContentGenerator.lua"
          )
          
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              echo "âœ… Found required file: $file"
            } else {
              echo "âŒ Missing required file: $file"
              $missingFiles = $true
            }
          }
          
          if ($missingFiles) {
            exit 1
          }

  deploy-to-roblox:
    runs-on: windows-latest
    needs: [build-roblox, test-roblox-scripts]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event.inputs.sync_type == 'deploy' }}
    environment:
      name: roblox-production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: roblox-builds
      
      - name: Install Roblox deployment tools
        run: |
          # Install remodel for Roblox API interactions
          Invoke-WebRequest -Uri "https://github.com/rojo-rbx/remodel/releases/latest/download/remodel-win64.zip" -OutFile "remodel.zip"
          Expand-Archive -Path "remodel.zip" -DestinationPath "remodel"
          $env:PATH += ";$PWD\remodel"
          echo "$PWD\remodel" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Deploy to Roblox Studio
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
          ROBLOX_PLACE_ID: ${{ github.event.inputs.place_id || secrets.ROBLOX_PLACE_ID }}
        run: |
          # Create deployment script
          $deployScript = @"
          local HttpService = game:GetService('HttpService')
          local rbxlFile = '${{ needs.build-roblox.outputs.rbxl-path }}'
          local placeId = '$env:ROBLOX_PLACE_ID'
          
          -- Upload place file using Roblox API
          local success, result = pcall(function()
              return HttpService:RequestAsync({
                  Url = 'https://apis.roblox.com/assets/v1/assets/' .. placeId,
                  Method = 'POST',
                  Headers = {
                      ['x-api-key'] = '$env:ROBLOX_API_KEY',
                      ['Content-Type'] = 'application/octet-stream'
                  },
                  Body = -- file content would go here in real implementation
              })
          end)
          
          if success then
              print('Deployment successful!')
          else
              error('Deployment failed: ' .. tostring(result))
          end
          "@
          
          # Note: This is a simplified example. Real deployment would use Roblox's OpenCloud API
          echo "Deployment script created. In production, this would deploy to Roblox."
          echo "Place ID: $env:ROBLOX_PLACE_ID"
      
      - name: Update asset versions
        run: |
          # Create version tracking
          $versionInfo = @{
            version = "${{ github.sha }}"
            deployed_at = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
            place_id = "${{ github.event.inputs.place_id || secrets.ROBLOX_PLACE_ID }}"
            branch = "${{ github.ref_name }}"
          }
          $versionInfo | ConvertTo-Json | Out-File -FilePath "deployment-info.json" -Encoding utf8
      
      - name: Upload deployment info
        uses: actions/upload-artifact@v3
        with:
          name: deployment-info
          path: deployment-info.json

  publish-to-marketplace:
    runs-on: windows-latest
    needs: [deploy-to-roblox]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[publish]') || github.event.inputs.sync_type == 'publish' }}
    environment:
      name: roblox-marketplace
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: roblox-builds
      
      - name: Publish plugin to marketplace
        env:
          ROBLOX_API_KEY: ${{ secrets.ROBLOX_API_KEY }}
          ROBLOX_UNIVERSE_ID: ${{ github.event.inputs.universe_id || secrets.ROBLOX_UNIVERSE_ID }}
        run: |
          # Create marketplace publication script
          echo "Publishing plugin to Roblox marketplace..."
          echo "Universe ID: $env:ROBLOX_UNIVERSE_ID"
          
          # In production, this would use Roblox's OpenCloud API to publish
          # the plugin to the Creator Marketplace
          
          $publicationInfo = @{
            plugin_file = "${{ needs.build-roblox.outputs.rbxm-path }}"
            universe_id = "$env:ROBLOX_UNIVERSE_ID"
            published_at = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
            version = "${{ github.sha }}"
          }
          
          $publicationInfo | ConvertTo-Json | Out-File -FilePath "publication-info.json" -Encoding utf8
      
      - name: Upload publication info
        uses: actions/upload-artifact@v3
        with:
          name: publication-info
          path: publication-info.json

  sync-summary:
    runs-on: ubuntu-latest
    needs: [validate-lua, build-roblox, test-roblox-scripts, deploy-to-roblox, publish-to-marketplace]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create sync summary
        run: |
          echo "# Roblox Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job results
          if [ -f "roblox-builds/${{ needs.build-roblox.outputs.rbxl-path }}" ]; then
            echo "âœ… **Build:** Successful" >> $GITHUB_STEP_SUMMARY
            echo "   - Place file: ${{ needs.build-roblox.outputs.rbxl-path }}" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ needs.build-roblox.outputs.rbxm-path }}" ]; then
              echo "   - Plugin file: ${{ needs.build-roblox.outputs.rbxm-path }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "deployment-info/deployment-info.json" ]; then
            echo "âœ… **Deployment:** Successful" >> $GITHUB_STEP_SUMMARY
            PLACE_ID=$(cat deployment-info/deployment-info.json | jq -r '.place_id')
            echo "   - Place ID: $PLACE_ID" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Deployment:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "publication-info/publication-info.json" ]; then
            echo "âœ… **Publication:** Successful" >> $GITHUB_STEP_SUMMARY
            UNIVERSE_ID=$(cat publication-info/publication-info.json | jq -r '.universe_id')
            echo "   - Universe ID: $UNIVERSE_ID" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Publication:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify deployment status
        if: ${{ needs.deploy-to-roblox.result == 'success' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'Roblox deployment successful! ðŸŽ®'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'Roblox sync failed! Check the workflow for details. ðŸš¨'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}