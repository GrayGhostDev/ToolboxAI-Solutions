name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * 1'  # Run every Monday at 3 AM UTC
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - code
          - secrets
          - containers
      severity_threshold:
        description: 'Minimum severity level'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  dependency-scanning:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies' || github.event.inputs.scan_type == '' }}
    strategy:
      matrix:
        language: [python, javascript]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Set up Node.js
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Python security tools
        if: matrix.language == 'python'
        run: |
          pip install safety pip-audit bandit semgrep
      
      - name: Install Node.js security tools
        if: matrix.language == 'javascript'
        run: |
          npm install -g audit-ci npm-check-updates snyk
      
      - name: Python dependency scanning with Safety
        if: matrix.language == 'python'
        run: |
          echo "Running Safety scan..."
          safety check --json --output safety-report.json --continue-on-error
          
          echo "Running pip-audit..."
          pip-audit --format=json --output=pip-audit-report.json --continue-on-error
        continue-on-error: true
      
      - name: Python dependency vulnerability check
        if: matrix.language == 'python'
        run: |
          echo "Checking for known vulnerabilities in requirements.txt..."
          pip install -r requirements.txt
          pip list --format=json > installed-packages.json
          
          # Check for security updates
          pip list --outdated --format=json > outdated-packages.json
      
      - name: JavaScript dependency scanning with npm audit
        if: matrix.language == 'javascript'
        run: |
          echo "Running npm audit..."
          cd API/Dashboard
          npm audit --json > ../../npm-audit-report.json || true
          
          cd ../..
          npm audit --json > npm-audit-root-report.json || true
          
          echo "Running audit-ci..."
          cd API/Dashboard
          audit-ci --config ../../.audit-ci.json --report-type json --output-file ../../audit-ci-report.json || true
        continue-on-error: true
      
      - name: JavaScript dependency vulnerability check with Snyk
        if: matrix.language == 'javascript'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "Running Snyk scan..."
            snyk auth $SNYK_TOKEN
            
            # Scan root package.json
            snyk test --json > snyk-report-root.json || true
            
            # Scan Dashboard
            cd API/Dashboard
            snyk test --json > ../../snyk-report-dashboard.json || true
          else
            echo "Snyk token not provided, skipping Snyk scan"
          fi
        continue-on-error: true
      
      - name: Upload dependency scan reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-scan-${{ matrix.language }}
          path: |
            *-report.json
            *-packages.json

  code-security-scanning:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'code' || github.event.inputs.scan_type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install security scanning tools
        run: |
          pip install bandit semgrep flawfinder
          
          # Install additional security tools
          wget -O /tmp/gosec.tar.gz https://github.com/securecodewarrior/gosec/releases/latest/download/gosec_linux_amd64.tar.gz
          tar -xzf /tmp/gosec.tar.gz -C /tmp/
          sudo mv /tmp/gosec /usr/local/bin/
      
      - name: Run Bandit security scan
        run: |
          echo "Running Bandit scan..."
          bandit -r server/ agents/ mcp/ sparc/ swarm/ coordinators/ \
            -f json -o bandit-report.json \
            -ll -x "*/tests/*,*/test_*.py" \
            --confidence-level medium \
            --severity-level medium
        continue-on-error: true
      
      - name: Run Semgrep static analysis
        run: |
          echo "Running Semgrep scan..."
          semgrep --config=auto \
            --json \
            --output=semgrep-report.json \
            --severity=WARNING \
            --exclude="tests/" \
            --exclude="*.test.*" \
            server/ agents/ mcp/ sparc/ swarm/ coordinators/ API/
        continue-on-error: true
      
      - name: Run custom security rules with Semgrep
        run: |
          echo "Running custom security rules..."
          cat > custom-rules.yml << 'EOF'
          rules:
            - id: hardcoded-secret
              pattern-either:
                - pattern: password = "$PASSWORD"
                - pattern: api_key = "$API_KEY"
                - pattern: secret = "$SECRET"
              message: "Potential hardcoded secret found"
              severity: ERROR
              languages: [python]
              
            - id: sql-injection
              pattern-either:
                - pattern: execute("SELECT * FROM " + $VAR)
                - pattern: query($VAR + "...")
              message: "Potential SQL injection vulnerability"
              severity: ERROR
              languages: [python]
              
            - id: unsafe-eval
              pattern-either:
                - pattern: eval($VAR)
                - pattern: exec($VAR)
              message: "Use of eval() or exec() can be dangerous"
              severity: WARNING
              languages: [python]
          EOF
          
          semgrep --config=custom-rules.yml \
            --json \
            --output=custom-semgrep-report.json \
            server/ agents/ mcp/ sparc/ swarm/ coordinators/
        continue-on-error: true
      
      - name: JavaScript/TypeScript security scan
        run: |
          echo "Scanning JavaScript/TypeScript files..."
          cd API/Dashboard
          
          # Install ESLint security plugin
          npm install --no-save eslint-plugin-security @typescript-eslint/eslint-plugin
          
          # Create ESLint config with security rules
          cat > .eslintrc.security.js << 'EOF'
          module.exports = {
            extends: ['plugin:security/recommended'],
            plugins: ['security'],
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'warn',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'warn',
              'security/detect-non-literal-require': 'error',
              'security/detect-possible-timing-attacks': 'warn',
              'security/detect-pseudoRandomBytes': 'error'
            }
          };
          EOF
          
          # Run security linting
          npx eslint src/ --config .eslintrc.security.js --format json --output-file ../../eslint-security-report.json || true
        continue-on-error: true
      
      - name: Upload code security reports
        uses: actions/upload-artifact@v3
        with:
          name: code-security-reports
          path: |
            bandit-report.json
            semgrep-report.json
            custom-semgrep-report.json
            eslint-security-report.json

  secrets-scanning:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets' || github.event.inputs.scan_type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
          cd /tmp/git-secrets && sudo make install
      
      - name: Run TruffleHog secrets scan
        run: |
          echo "Running TruffleHog scan..."
          trufflehog git file://. \
            --json \
            --no-update \
            --fail \
            --exclude-paths .trufflehog-ignore \
            > trufflehog-report.json || true
        continue-on-error: true
      
      - name: Run git-secrets scan
        run: |
          echo "Running git-secrets scan..."
          git secrets --register-aws
          git secrets --install
          
          # Add custom patterns
          git secrets --add 'api[_-]key\s*[:=]\s*["\']?[a-zA-Z0-9_-]{20,}["\']?'
          git secrets --add 'secret[_-]key\s*[:=]\s*["\']?[a-zA-Z0-9_-]{20,}["\']?'
          git secrets --add 'password\s*[:=]\s*["\']?[a-zA-Z0-9_@#$%^&*!-]{8,}["\']?'
          git secrets --add 'token\s*[:=]\s*["\']?[a-zA-Z0-9_-]{20,}["\']?'
          
          git secrets --scan --recursive . > git-secrets-report.txt 2>&1 || true
        continue-on-error: true
      
      - name: Create .trufflehog-ignore if not exists
        run: |
          if [ ! -f .trufflehog-ignore ]; then
            cat > .trufflehog-ignore << 'EOF'
          # Ignore common false positives
          package-lock.json
          yarn.lock
          *.min.js
          *.min.css
          node_modules/
          .git/
          # Add more patterns as needed
          EOF
          fi
      
      - name: Scan environment files
        run: |
          echo "Scanning for exposed secrets in environment files..."
          
          # Check for .env files that might contain real secrets
          find . -name "*.env*" -not -path "./node_modules/*" | while read file; do
            echo "Checking $file..."
            if grep -E "(api_key|secret_key|password|token)" "$file" > /dev/null 2>&1; then
              echo "âš ï¸  Potential secrets found in $file"
              echo "$file" >> potential-env-secrets.txt
            fi
          done
      
      - name: Upload secrets scanning reports
        uses: actions/upload-artifact@v3
        with:
          name: secrets-scan-reports
          path: |
            trufflehog-report.json
            git-secrets-report.txt
            potential-env-secrets.txt

  container-security-scanning:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'containers' || github.event.inputs.scan_type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install container security tools
        run: |
          # Install Trivy
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          
          # Install Hadolint
          wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      
      - name: Scan Dockerfiles with Hadolint
        run: |
          echo "Running Hadolint on Dockerfiles..."
          find . -name "Dockerfile*" | while read dockerfile; do
            echo "Scanning $dockerfile..."
            hadolint "$dockerfile" --format json >> hadolint-report.json || true
          done
        continue-on-error: true
      
      - name: Build Docker images for scanning
        run: |
          echo "Building Docker images..."
          
          # Build API image
          if [ -f "docker/Dockerfile.api" ]; then
            docker build -t toolboxai-api:security-scan -f docker/Dockerfile.api .
          fi
          
          # Build MCP image
          if [ -f "docker/Dockerfile.mcp" ]; then
            docker build -t toolboxai-mcp:security-scan -f docker/Dockerfile.mcp .
          fi
          
          # Build Agents image
          if [ -f "docker/Dockerfile.agents" ]; then
            docker build -t toolboxai-agents:security-scan -f docker/Dockerfile.agents .
          fi
      
      - name: Scan Docker images with Trivy
        run: |
          echo "Running Trivy scans..."
          
          # Scan API image
          if docker images | grep -q "toolboxai-api"; then
            trivy image --format json --output trivy-api-report.json toolboxai-api:security-scan || true
          fi
          
          # Scan MCP image
          if docker images | grep -q "toolboxai-mcp"; then
            trivy image --format json --output trivy-mcp-report.json toolboxai-mcp:security-scan || true
          fi
          
          # Scan Agents image
          if docker images | grep -q "toolboxai-agents"; then
            trivy image --format json --output trivy-agents-report.json toolboxai-agents:security-scan || true
          fi
        continue-on-error: true
      
      - name: Scan filesystem
        run: |
          echo "Running filesystem scan..."
          trivy fs --format json --output trivy-fs-report.json . || true
        continue-on-error: true
      
      - name: Upload container security reports
        uses: actions/upload-artifact@v3
        with:
          name: container-security-reports
          path: |
            hadolint-report.json
            trivy-*-report.json

  license-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install license checking tools
        run: |
          pip install pip-licenses licensecheck
          npm install -g license-checker license-compliance
      
      - name: Check Python licenses
        run: |
          echo "Checking Python package licenses..."
          pip install -r requirements.txt
          
          pip-licenses --format json --output-file python-licenses.json
          
          # Check for problematic licenses
          pip-licenses --format table --with-license-file > python-licenses-detailed.txt
        continue-on-error: true
      
      - name: Check Node.js licenses
        run: |
          echo "Checking Node.js package licenses..."
          
          # Check root package
          license-checker --json --out node-licenses-root.json || true
          
          # Check Dashboard packages
          cd API/Dashboard
          npm install
          license-checker --json --out ../../node-licenses-dashboard.json || true
        continue-on-error: true
      
      - name: Generate license compliance report
        run: |
          cat > license-report.md << 'EOF'
          # License Compliance Report
          
          ## Summary
          
          This report shows all licenses used by dependencies in the ToolboxAI Roblox Environment project.
          
          ## Python Dependencies
          
          See `python-licenses.json` for detailed license information.
          
          ## Node.js Dependencies
          
          See `node-licenses-*.json` for detailed license information.
          
          ## Action Required
          
          Please review any licenses marked as "UNKNOWN" or potentially incompatible.
          EOF
      
      - name: Upload license reports
        uses: actions/upload-artifact@v3
        with:
          name: license-reports
          path: |
            python-licenses*.json
            python-licenses*.txt
            node-licenses*.json
            license-report.md

  security-summary:
    runs-on: ubuntu-latest
    needs: [dependency-scanning, code-security-scanning, secrets-scanning, container-security-scanning, license-compliance]
    if: always()
    steps:
      - name: Download all security reports
        uses: actions/download-artifact@v3
      
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count findings
          HIGH_ISSUES=0
          MEDIUM_ISSUES=0
          LOW_ISSUES=0
          
          # Process Bandit report if exists
          if [ -f "code-security-reports/bandit-report.json" ]; then
            HIGH_ISSUES=$((HIGH_ISSUES + $(jq '[.results[] | select(.issue_severity=="HIGH")] | length' code-security-reports/bandit-report.json 2>/dev/null || echo 0)))
            MEDIUM_ISSUES=$((MEDIUM_ISSUES + $(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' code-security-reports/bandit-report.json 2>/dev/null || echo 0)))
            LOW_ISSUES=$((LOW_ISSUES + $(jq '[.results[] | select(.issue_severity=="LOW")] | length' code-security-reports/bandit-report.json 2>/dev/null || echo 0)))
          fi
          
          # Process Semgrep report if exists
          if [ -f "code-security-reports/semgrep-report.json" ]; then
            HIGH_ISSUES=$((HIGH_ISSUES + $(jq '[.results[] | select(.extra.severity=="ERROR")] | length' code-security-reports/semgrep-report.json 2>/dev/null || echo 0)))
            MEDIUM_ISSUES=$((MEDIUM_ISSUES + $(jq '[.results[] | select(.extra.severity=="WARNING")] | length' code-security-reports/semgrep-report.json 2>/dev/null || echo 0)))
          fi
          
          echo "## ðŸ” Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.dependency-scanning.result }}" == "success" ]; then
            echo "âœ… **Dependency Scanning:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dependency Scanning:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.code-security-scanning.result }}" == "success" ]; then
            echo "âœ… **Code Security Scanning:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Security Scanning:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.secrets-scanning.result }}" == "success" ]; then
            echo "âœ… **Secrets Scanning:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Secrets Scanning:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.container-security-scanning.result }}" == "success" ]; then
            echo "âœ… **Container Security Scanning:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Container Security Scanning:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.license-compliance.result }}" == "success" ]; then
            echo "âœ… **License Compliance:** Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **License Compliance:** Failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš¨ Security Issues Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **High Severity:** $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- **Medium Severity:** $MEDIUM_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- **Low Severity:** $LOW_ISSUES" >> $GITHUB_STEP_SUMMARY
          
          # Set exit code based on severity threshold
          THRESHOLD="${{ github.event.inputs.severity_threshold || 'medium' }}"
          if [ "$THRESHOLD" == "critical" ] && [ $HIGH_ISSUES -gt 0 ]; then
            echo "âŒ Security scan failed: Critical issues found" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$THRESHOLD" == "high" ] && [ $HIGH_ISSUES -gt 0 ]; then
            echo "âŒ Security scan failed: High severity issues found" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$THRESHOLD" == "medium" ] && [ $((HIGH_ISSUES + MEDIUM_ISSUES)) -gt 0 ]; then
            echo "âŒ Security scan failed: Medium+ severity issues found" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Security scan passed based on threshold: $THRESHOLD" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create security issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const title = `Security vulnerabilities detected - ${context.sha.substring(0, 7)}`;
            const body = `
            ## Security Scan Results
            
            Security vulnerabilities have been detected in commit ${context.sha}.
            
            **Branch:** ${context.ref}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            Please review the security scan artifacts and address any critical or high-severity issues.
            
            ### Next Steps
            1. Review the security scan reports in the workflow artifacts
            2. Address high-priority vulnerabilities
            3. Update dependencies if needed
            4. Re-run security scans to verify fixes
            
            This issue will be automatically closed when security scans pass.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated']
            });
      
      - name: Notify security team
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'ðŸš¨ Security vulnerabilities detected! Check the security scan results immediately.'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK }}