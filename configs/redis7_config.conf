# Redis 7.x Production Configuration
# Optimized for Phase 2 Database Modernization

# =============================================================================
# Network and Connection Settings
# =============================================================================
bind 127.0.0.1 ::1                      # Bind to localhost (adjust for production)
port 6379                                # Default Redis port
tcp-backlog 511                          # TCP listen backlog
timeout 0                                # Client idle timeout (0 = disabled)
tcp-keepalive 300                        # TCP keepalive interval

# =============================================================================
# General Server Settings
# =============================================================================
daemonize yes                            # Run as daemon
pidfile /var/run/redis/redis-server.pid  # PID file location
loglevel notice                          # Log level (debug, verbose, notice, warning)
logfile /var/log/redis/redis-server.log  # Log file location
databases 16                             # Number of databases

# =============================================================================
# Memory Management
# =============================================================================
maxmemory 2gb                            # Maximum memory usage
maxmemory-policy allkeys-lru             # Memory eviction policy
maxmemory-samples 5                      # LRU samples for eviction

# Memory usage optimization
hash-max-ziplist-entries 512            # Hash ziplist entries threshold
hash-max-ziplist-value 64               # Hash ziplist value threshold
list-max-ziplist-size -2                # List ziplist size
list-compress-depth 0                   # List compression depth
set-max-intset-entries 512              # Set intset entries threshold
zset-max-ziplist-entries 128            # Sorted set ziplist entries
zset-max-ziplist-value 64               # Sorted set ziplist value

# =============================================================================
# Persistence Configuration
# =============================================================================

# RDB Configuration (Version 11 format in Redis 7)
save 900 1                               # Save if at least 1 key changed in 900 seconds
save 300 10                              # Save if at least 10 keys changed in 300 seconds
save 60 10000                            # Save if at least 10000 keys changed in 60 seconds

stop-writes-on-bgsave-error yes          # Stop writes if RDB save fails
rdbcompression yes                       # Compress RDB files
rdbchecksum yes                          # Checksum RDB files
dbfilename dump.rdb                      # RDB filename
rdb-del-sync-files no                    # Don't delete RDB files used for replication

# AOF Configuration
appendonly no                            # Disable AOF (use RDB for better performance)
appendfilename "appendonly.aof"         # AOF filename
appendfsync everysec                     # AOF fsync policy
no-appendfsync-on-rewrite no            # Don't fsync during rewrites
auto-aof-rewrite-percentage 100         # AOF rewrite trigger percentage
auto-aof-rewrite-min-size 64mb          # AOF rewrite minimum size
aof-load-truncated yes                   # Load truncated AOF files

# =============================================================================
# Replication Settings
# =============================================================================
# replica-serve-stale-data yes          # Serve stale data when disconnected
# replica-read-only yes                 # Make replicas read-only
# repl-diskless-sync no                 # Use disk-based replication
# repl-diskless-sync-delay 5            # Diskless replication delay
# repl-ping-replica-period 10           # Replica ping period
# repl-timeout 60                       # Replication timeout

# =============================================================================
# Security Configuration (ACL v2 in Redis 7)
# =============================================================================

# Enable ACL
aclfile /etc/redis/users.acl            # ACL configuration file

# Default user configuration (disabled for security)
user default off

# Application users with specific permissions
# These are defined in the ACL file for better security

# =============================================================================
# Client Management
# =============================================================================
maxclients 10000                        # Maximum number of clients
client-output-buffer-limit normal 0 0 0          # Normal clients buffer limit
client-output-buffer-limit replica 256mb 64mb 60  # Replica clients buffer limit
client-output-buffer-limit pubsub 32mb 8mb 60     # Pub/sub clients buffer limit

# =============================================================================
# Advanced Features (Redis 7 Specific)
# =============================================================================

# Redis Functions (replacing Lua scripts)
# Functions are loaded from separate files or via FUNCTION LOAD commands

# Sharded Pub/Sub Configuration
# Enable sharded pub/sub for better scalability
# This is automatically available in Redis 7

# Client-side caching
# tracking-table-max-keys 1000000       # Maximum tracking table keys

# =============================================================================
# Performance Tuning
# =============================================================================

# Networking
tcp-keepalive 300                        # TCP keepalive
tcp-backlog 511                          # TCP backlog

# Timeouts
timeout 0                                # Client timeout (0 = no timeout)

# Background operations
hz 10                                    # Background task frequency

# Lazy freeing (non-blocking deletion)
lazyfree-lazy-eviction no               # Lazy eviction
lazyfree-lazy-expire no                 # Lazy expiration
lazyfree-lazy-server-del no             # Lazy server deletion
replica-lazy-flush no                   # Lazy replica flush

# =============================================================================
# Modules and Extensions
# =============================================================================
# loadmodule /path/to/module.so         # Load Redis modules

# =============================================================================
# Cluster Configuration (if using Redis Cluster)
# =============================================================================
# cluster-enabled yes                   # Enable cluster mode
# cluster-config-file nodes-6379.conf  # Cluster configuration file
# cluster-node-timeout 15000           # Cluster node timeout
# cluster-announce-ip                   # Announce IP for cluster
# cluster-announce-port 6379           # Announce port for cluster
# cluster-announce-bus-port 16379      # Announce bus port for cluster

# =============================================================================
# Debugging and Development
# =============================================================================
# latency-monitor-threshold 100        # Latency monitoring threshold
# notify-keyspace-events ""            # Keyspace notifications

# =============================================================================
# Lua Scripting (Legacy - use Redis Functions in Redis 7)
# =============================================================================
lua-time-limit 5000                     # Lua script time limit

# =============================================================================
# Slow Log Configuration
# =============================================================================
slowlog-log-slower-than 10000          # Log queries slower than 10ms
slowlog-max-len 128                     # Maximum slow log entries

# =============================================================================
# Advanced Configuration
# =============================================================================

# Jemalloc settings for better memory management
# These are typically set as environment variables:
# export MALLOC_CONF="lg_dirty_mult:8,lg_muzzy_mult:8"

# Transparent Huge Pages - should be disabled for Redis
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# File descriptor limits
# Set in /etc/security/limits.conf:
# redis soft nofile 65535
# redis hard nofile 65535

# =============================================================================
# Monitoring and Observability
# =============================================================================

# Enable command logging for monitoring
# This can be done via CONFIG SET or in application code

# Key expiration notifications (if needed)
# notify-keyspace-events Ex

# =============================================================================
# Redis 7 Specific Features
# =============================================================================

# ACL Categories (defined in ACL file)
# Command introspection improvements
# Better client-side caching
# Sharded pub/sub support
# Redis Functions support

# =============================================================================
# Production Optimizations
# =============================================================================

# Disable potentially dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""
# rename-command SHUTDOWN SHUTDOWN_REDIS_NOW
# rename-command DEBUG ""

# Enable memory usage tracking
# maxmemory-policy allkeys-lru
# maxmemory-samples 10

# Optimize for specific workloads
# For cache workload: maxmemory-policy allkeys-lru
# For session store: maxmemory-policy allkeys-random
# For queue workload: maxmemory-policy noeviction