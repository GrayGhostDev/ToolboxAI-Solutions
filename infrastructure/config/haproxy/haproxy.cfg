# ============================================
# HAProxy Load Balancer Configuration
# ============================================
# Production load balancing for backend services
# Health checks and automatic failover
# ============================================

global
    log stdout format raw local0
    maxconn 4096

    # Security
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon

    # SSL/TLS
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch

    retries 3
    timeout http-request 10s
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    timeout http-keep-alive 10s
    timeout check 10s

    maxconn 3000

# ============================================
# Statistics Page
# ============================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats realm HAProxy\ Statistics
    stats auth admin:changeme
    stats show-node
    stats show-legends
    stats show-desc ToolboxAI Load Balancer

# ============================================
# Backend API Load Balancer
# ============================================
frontend api_frontend
    bind *:8080
    mode http

    # Logging
    option httplog
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"

    # Headers
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Real-IP %[src]

    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # Default backend
    default_backend api_backend

backend api_backend
    mode http
    balance roundrobin

    # Health checks
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200

    # Stick tables for session persistence (if needed)
    # stick-table type string len 32 size 100k expire 30m
    # stick on cookie(session_id)

    # Backend servers
    server backend1 backend1:8000 check inter 5s fall 3 rise 2 maxconn 1000
    server backend2 backend2:8000 check inter 5s fall 3 rise 2 maxconn 1000
    server backend3 backend3:8000 check inter 5s fall 3 rise 2 maxconn 1000

    # Backup server (if all fail)
    # server backup_backend backup:8000 check backup

# ============================================
# WebSocket Support (if needed)
# ============================================
frontend ws_frontend
    bind *:8081
    mode http

    # WebSocket upgrade
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket hdr_beg(Host) -i ws

    use_backend ws_backend if is_websocket
    default_backend api_backend

backend ws_backend
    mode http
    balance roundrobin

    # WebSocket timeout (longer)
    timeout tunnel 1h
    timeout server 1h

    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost

    server backend1 backend1:8000 check inter 10s
    server backend2 backend2:8000 check inter 10s
    server backend3 backend3:8000 check inter 10s

# ============================================
# Error Pages
# ============================================
frontend error_pages
    bind *:8082
    mode http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http

