;; PgBouncer Configuration for ToolboxAI Production
;; Optimized for high-traffic production environment with connection multiplexing

[databases]
;; Main application database - transaction pooling for web requests
toolboxai_main = host=postgres port=5432 dbname=toolboxai_production pool_mode=transaction max_db_connections=50

;; Agent service database - session pooling for long-running operations
toolboxai_agents = host=postgres port=5432 dbname=toolboxai_production pool_mode=session max_db_connections=30

;; Analytics database - statement pooling for read-heavy workloads
toolboxai_analytics = host=postgres port=5432 dbname=toolboxai_production pool_mode=statement max_db_connections=20

;; Background workers database - session pooling for batch operations
toolboxai_workers = host=postgres port=5432 dbname=toolboxai_production pool_mode=session max_db_connections=20

;; WebSocket service database - transaction pooling with quick turnover
toolboxai_websocket = host=postgres port=5432 dbname=toolboxai_production pool_mode=transaction max_db_connections=40

;; Administrative database - for monitoring and maintenance
postgres = host=postgres port=5432 dbname=postgres auth_user=postgres pool_mode=session max_db_connections=2

[pgbouncer]
;; Connection limits
listen_addr = *
listen_port = 6432
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0755

;; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1
auth_hba_file = /etc/pgbouncer/pg_hba.conf

;; Pool configuration
pool_mode = transaction
max_client_conn = 2000              ; Maximum client connections
default_pool_size = 25              ; Default connections per pool
min_pool_size = 10                  ; Minimum connections to maintain
reserve_pool_size = 10              ; Reserve pool for admin/superuser
reserve_pool_timeout = 5            ; Timeout for reserve pool

;; Connection limits per database/user
max_db_connections = 100            ; Max connections per database
max_user_connections = 100          ; Max connections per user

;; Connection lifecycle
server_lifetime = 3600              ; Max server connection age (1 hour)
server_idle_timeout = 600           ; Disconnect idle servers (10 min)
server_connect_timeout = 15         ; Connection establishment timeout
server_login_retry = 15             ; Retry failed server connections
client_login_timeout = 60           ; Client authentication timeout
client_idle_timeout = 0             ; Don't disconnect idle clients

;; Query handling
query_timeout = 0                   ; No query timeout (handle in app)
query_wait_timeout = 120            ; Max wait for available connection
idle_transaction_timeout = 0        ; No idle transaction timeout

;; Performance optimizations
server_round_robin = yes            ; Distribute connections evenly
server_reset_query = DISCARD ALL    ; Reset session state
server_reset_query_always = 0       ; Only reset when needed
application_name_add_host = 1       ; Add client host to application_name
disable_pqexec = 0                  ; Allow simple protocol
pkt_buf = 4096                      ; Packet buffer size
max_packet_size = 2147483647        ; Max packet size
listen_backlog = 256                ; Listen queue size
sbuf_loopcnt = 5                    ; IO loop iterations
tcp_defer_accept = 45               ; TCP optimization
tcp_socket_buffer = 0               ; Use system default
tcp_keepalive = 1                   ; Enable keepalive
tcp_keepcnt = 9                     ; Keepalive probes
tcp_keepidle = 7200                 ; Keepalive idle time
tcp_keepintvl = 75                  ; Keepalive interval

;; DNS
dns_max_ttl = 15                    ; DNS cache TTL
dns_nxdomain_ttl = 15               ; Negative DNS cache TTL
dns_zone_check_period = 0           ; Disable zone checking

;; TLS/SSL Configuration (uncomment for production)
;server_tls_sslmode = require
;server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;server_tls_cert_file = /etc/pgbouncer/server.cert
;server_tls_key_file = /etc/pgbouncer/server.key
;server_tls_protocols = secure      ; TLSv1.2 and above
;server_tls_ciphers = HIGH:!aNULL:!MD5

;client_tls_sslmode = allow
;client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;client_tls_cert_file = /etc/pgbouncer/client.cert
;client_tls_key_file = /etc/pgbouncer/client.key

;; Logging
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid
admin_users = postgres, pgbouncer_admin
stats_users = postgres, pgbouncer_stats, monitoring
stats_period = 60                   ; Stats collection interval

;; Log levels: 0=off, 1=errors, 2=warnings, 3=info, 4=debug
verbose = 2
log_connections = 1                 ; Log successful connections
log_disconnections = 1              ; Log disconnections
log_pooler_errors = 1              ; Log pooler errors
log_stats = 1                      ; Log statistics
stats_users_verbosity = 1          ; Stats detail level

;; Monitoring
track_extra_parameters = IntervalStyle,search_path  ; Track these parameters