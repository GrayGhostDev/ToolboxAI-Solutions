# ============================================
# TOOLBOXAI DOCKER COMPOSE - DEVELOPMENT OVERRIDE
# ============================================
# Development-specific overrides for local development
# Use with: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# Updated: 2025-09-24
# ============================================

services:
  # ----------------------------------------
  # PostgreSQL Database (Development)
  # ----------------------------------------
  postgres:
    ports:
      - "5434:5432"
    environment:
      # Use simple password for dev (override secrets)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass2024}
      POSTGRES_USER: ${POSTGRES_USER:-toolboxai}
      POSTGRES_DB: ${POSTGRES_DB:-toolboxai}
      POSTGRES_PASSWORD_FILE: ""
      # Enable query logging for development
      POSTGRES_LOG_STATEMENT: all
      POSTGRES_LOG_CONNECTIONS: "on"
      POSTGRES_LOG_DISCONNECTIONS: "on"
    # No secrets in dev, use env directly
    secrets: []
    # Remove security restrictions for development
    security_opt: []
    cap_drop: []
    cap_add:
      - ALL

  # ----------------------------------------
  # Redis Cache (Development)
  # ----------------------------------------
  redis:
    ports:
      - "6381:6379"
    # Override entrypoint to run directly without user switching
    entrypoint: ["redis-server"]
    command: >
      --save ""
      --appendonly no
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    # No password in development
    secrets: []
    # Remove security restrictions for development
    security_opt: []
    cap_drop: []
    read_only: false
    user: root  # Run as root in development to avoid permission issues
    # Skip volume mount to avoid ownership conflicts
    volumes: []

  # ----------------------------------------
  # HashiCorp Vault (Development)
  # ----------------------------------------
  vault:
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_DEV_ROOT_TOKEN:-devtoken}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_LOG_LEVEL: debug
      SKIP_SETCAP: "true"
    # Override entrypoint to run vault directly (bypass su-exec wrapper)
    entrypoint: ["/bin/vault"]
    command: ["server", "-dev", "-dev-root-token-id=${VAULT_DEV_ROOT_TOKEN:-devtoken}", "-dev-listen-address=0.0.0.0:8200"]
    # Development mode doesn't require security restrictions
    security_opt: []
    cap_drop: []
    cap_add: []
    read_only: false
    user: root  # Run as root in development to avoid permission issues
    # Dev mode runs entirely in-memory, no config file needed (override base volumes)
    volumes: !override []
    labels:
      - "com.toolboxai.environment=development"
      - "com.toolboxai.vault.mode=dev"

  # ----------------------------------------
  # FastAPI Backend (Development)
  # ----------------------------------------
  backend:
    build:
      target: development  # Use development stage in Dockerfile
    ports:
      - "8009:8009"
      - "5678:5678"  # Python debugger port
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      RELOAD: "true"
      WORKERS: 1  # Single worker for debugging
      # Prefer value from environment (can point to Supabase); fallback to local Postgres container
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}}
      # Optional Supabase integration (use with Supabase Local or Cloud)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key-change-in-production}
      # Mock API keys for development
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test-key}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-sk-test-key}
      # Disable rate limiting in dev
      RATE_LIMIT_ENABLED: false
      # Enable detailed logging
      LOG_LEVEL: DEBUG
      PYTHONDEBUG: 1
      HTTP_PROXY: ${HTTP_PROXY}
      HTTPS_PROXY: ${HTTPS_PROXY}
    secrets: []
    # Completely override base volumes list (base has backend_logs:/app/logs which conflicts with tmpfs)
    volumes: !override
      # Mount source code for hot reload
      - ../../../apps/backend:/app/apps/backend:cached
      - ../../../core:/app/core:cached
      - ../../../database:/app/database:cached
      - ../../../toolboxai_settings:/app/toolboxai_settings:cached
      - agent_data:/app/agent_data:Z  # Keep this from base config
      # Allow pip install in development
      - pip_cache:/root/.cache/pip
      # Note: /app/logs is mounted as tmpfs below, not a volume
    tmpfs:
      - /app/logs  # Writable logs directory
    # Remove security restrictions for development
    security_opt: []
    cap_drop: []
    read_only: false
    user: root  # Run as root in development for easier debugging
    command: >
      python -m uvicorn
      apps.backend.main:app
      --host 0.0.0.0
      --port 8009
      --reload
      --reload-dir /app
      --log-level debug

  # ----------------------------------------
  # React Dashboard (Development)
  # ----------------------------------------
  dashboard:
    # Use Node.js 22 base image directly for development (required by package.json)
    image: node:22-alpine
    container_name: toolboxai-dashboard
    restart: unless-stopped
    working_dir: /app
    ports:
      - "5179:5179"  # Vite dev server exposed on host
      - "9229:9229"  # Node debugger port
    environment:
      NODE_ENV: development
      DOCKER_ENV: "true"  # Flag for Docker-specific configurations
      # npm configuration to avoid permission issues
      NPM_CONFIG_CACHE: /tmp/.npm
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_AUDIT: "false"
      # API configuration for development (Vite proxy + app runtime)
      # Point directly to the backend service on the Docker network
      VITE_API_URL: http://backend:8009
      VITE_API_BASE_URL: http://backend:8009
      VITE_PROXY_TARGET: http://backend:8009
      # Pusher configuration (2025 standards)
      VITE_PUSHER_KEY: "${VITE_PUSHER_KEY}"
      VITE_PUSHER_CLUSTER: "${VITE_PUSHER_CLUSTER:-us2}"
      VITE_PUSHER_AUTH_ENDPOINT: "/api/pusher/auth"
      VITE_PUSHER_SSL: "true"
      # Enable all features in development with Pusher
      VITE_ENABLE_WEBSOCKET: "false"
      VITE_ENABLE_PUSHER: "true"
      VITE_ENABLE_GAMIFICATION: "true"
      VITE_ENABLE_ANALYTICS: "true"
      VITE_ENABLE_MCP: "true"
      VITE_ENABLE_AGENTS: "true"
      VITE_ENABLE_ROBLOX: "true"
      VITE_ENABLE_GHOST: "true"
      VITE_ENABLE_AI_CHAT: "true"
      VITE_DEBUG_MODE: "true"
      VITE_MOCK_API: "false"
      # Supabase (optional) â€“ set these in your .env to enable the dashboard client
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}

      # Enable Clerk auth
      VITE_ENABLE_CLERK_AUTH: "true"
      VITE_CLERK_PUBLISHABLE_KEY: "${VITE_CLERK_PUBLISHABLE_KEY}"
    volumes:
      # Mount entire dashboard directory
      - ../../../apps/dashboard:/app:cached
      # Override node_modules with anonymous volume to avoid permission issues
      - dashboard_node_modules:/app/node_modules
    tmpfs:
      - /tmp  # Writable tmp for npm cache
    networks:
      - frontend
      - backend
    # Allow writing to filesystem in development
    read_only: false
    user: root  # Run as root to avoid permission issues
    command: >
      sh -c "
      apk add --no-cache wget &&
      echo 'ðŸ“¦ Installing dashboard dependencies...' &&
      npm install --legacy-peer-deps &&
      echo 'âœ… Dependencies installed, starting dev server...' &&
      npm run dev -- --host 0.0.0.0 --port 5179
      "
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5179"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 90s  # Give more time for npm install and Vite startup

  # ----------------------------------------
  # MCP Server (Development)
  # ----------------------------------------
  mcp-server:
    build:
      target: development  # Use development stage
    ports:
      - "9877:9877"
      - "9878:9878"  # Debug port
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/1
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      AGENT_DISCOVERY_ENABLED: true
      AGENT_REGISTRY_TTL: 60  # Shorter TTL for dev
    secrets: []
    volumes:
      # Mount source code for development
      - ../../../core/mcp:/app/core/mcp:cached
      - mcp_contexts:/data/contexts
      - agent_data:/data/agents
    security_opt: []
    cap_drop: []
    read_only: false
    user: root

  # ----------------------------------------
  # Agent Coordinator (Development)
  # ----------------------------------------
  agent-coordinator:
    # profiles: ["agents"]  # ENABLED: Pydantic compatibility resolved (pinned <2.10.0, LangSmith tracing disabled)
    build:
      target: development  # Use development stage
    ports:
      - "8888:8888"
      - "8889:8889"  # Debug port
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      MCP_SERVER_URL: ws://mcp-server:9877
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/2
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test-key}
      MAX_CONCURRENT_AGENTS: 3  # Lower for dev
      TASK_TIMEOUT: 60  # Shorter timeout for dev
      HEALTH_CHECK_INTERVAL: 10  # More frequent checks in dev
      # Disable LangSmith tracing to avoid Pydantic v1/v2 compatibility issues
      LANGCHAIN_TRACING_V2: "false"
      LANGCHAIN_API_KEY: ""
    secrets: []
    volumes:
      # Mount source code for development
      - ../../../core/agents:/app/core/agents:cached
      - agent_data:/data/agents
      - agent_logs:/app/logs
    security_opt: []
    cap_drop: []
    read_only: false
    user: root

  # ----------------------------------------
  # Celery Worker (Development)
  # ----------------------------------------
  celery-worker:
    build:
      target: development
    # Note: debugpy port removed to avoid conflict with backend service
    # If needed, add: "5679:5678" for separate worker debugging
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      # Direct connection strings for development
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test-key}
      # Development settings
      CELERY_WORKER_CONCURRENCY: 2  # Lower for dev
      CELERY_TASK_ALWAYS_EAGER: false  # Don't run sync in dev
      CELERY_LOG_LEVEL: DEBUG
      CELERY_SEND_TASK_EVENTS: true  # For Flower monitoring
      PYTHONDEBUG: 1
      HTTP_PROXY: ${HTTP_PROXY}
      HTTPS_PROXY: ${HTTPS_PROXY}
    secrets: []
    volumes: !override
      # Mount source code for hot reload
      - ../../../apps/backend:/app/apps/backend:cached
      - ../../../core:/app/core:cached
      - ../../../database:/app/database:cached
      - ../../../toolboxai_settings:/app/toolboxai_settings:cached
      - celery_data:/app/data
    tmpfs:
      - /app/logs  # Use tmpfs to avoid permission issues
    security_opt: []
    cap_drop: []
    read_only: false
    user: root
    command: >
      watchmedo auto-restart
      --directory=/app/apps/backend
      --pattern=*.py
      --recursive
      --
      celery -A apps.backend.celery_app worker
      --loglevel=DEBUG
      --concurrency=2
      --pool=solo
      -Q default,high_priority,low_priority,email,reports,ai_generation

  # ----------------------------------------
  # Celery Beat (Development)
  # ----------------------------------------
  celery-beat:
    build:
      target: development
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      # Direct connection strings
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      # Beat settings
      CELERY_BEAT_LOG_LEVEL: DEBUG
      CELERY_BEAT_MAX_LOOP_INTERVAL: 5  # More frequent in dev
      TZ: ${TZ:-UTC}
      HTTP_PROXY: ${HTTP_PROXY}
      HTTPS_PROXY: ${HTTPS_PROXY}
    secrets: []
    volumes: !override
      # Mount source code for development
      - ../../../apps/backend:/app/apps/backend:cached
      - ../../../core:/app/core:cached
      - ../../../database:/app/database:cached
      - ../../../toolboxai_settings:/app/toolboxai_settings:cached
      - celerybeat_schedule:/app/celerybeat-schedule
    tmpfs:
      - /app/logs  # Use tmpfs to avoid permission issues
    security_opt: []
    cap_drop: []
    read_only: false
    user: root

  # ----------------------------------------
  # Roblox Sync Service (Development - disabled due to command issues)
  # ----------------------------------------
  roblox-sync:
    profiles: ["roblox"]  # Only start with: docker compose --profile roblox up
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      # Use direct env vars instead of secrets
      ROBLOX_API_KEY: ${ROBLOX_API_KEY:-roblox-dev-key}
      ROBLOX_CLIENT_SECRET: ${ROBLOX_CLIENT_SECRET:-roblox-dev-secret}
      # Remove secret file references
      ROBLOX_API_KEY_FILE: ""
      ROBLOX_CLIENT_SECRET_FILE: ""
      # Dev mode enabled
      ROJO_LIVE_RELOAD: "true"
      ROJO_DEV_MODE: "true"
      ROJO_LOG_LEVEL: debug
    secrets: []
    security_opt: []
    cap_drop: []
    read_only: false

  # ----------------------------------------
  # Redis Cloud Connector (Development)
  # ----------------------------------------
  redis-cloud-connector:
    profiles: ["cloud"]  # Disabled by default - only needed for cloud deployment
    # Override entrypoint to avoid user-switching issues
    entrypoint: ["redis-server"]
    command: ["--save", "", "--appendonly", "no"]
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      # Disable LangCache in development
      LANGCACHE_ENABLED: "false"
      LANGCACHE_API_KEY: ${LANGCACHE_API_KEY:-langcache-dev-key}
      LANGCACHE_API_KEY_FILE: ""
    security_opt: []
    cap_drop: []
    read_only: false
    user: root
    volumes: []

  # ----------------------------------------
  # Backup Coordinator (Development)
  # ----------------------------------------
  backup-coordinator:
    profiles: ["backups"]  # Disabled by default - backups not needed in dev
    # Uses backend image (no separate build)
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      # Disable backups in development by default
      BACKUP_ENABLED: "false"
      BACKUP_ENCRYPTION_ENABLED: "false"
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY:-backup-dev-key}
      BACKUP_ENCRYPTION_KEY_FILE: ""
    secrets: []
    security_opt: []
    cap_drop: []
    read_only: false
    user: root  # Run as root in development to avoid permission issues

  # ----------------------------------------
  # Migration Runner (Development)
  # ----------------------------------------
  migration-runner:
    profiles: ["migrations"]  # Disabled by default - run manually when needed
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      # Use direct database connection
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/0
      DATABASE_URL_FILE: ""
      REDIS_URL_FILE: ""
      # Disable auto-run in development
      MIGRATION_AUTO_RUN: "false"
    secrets: []
    security_opt: []
    cap_drop: []
    read_only: false

  # ----------------------------------------
  # Celery Flower - Override to use env vars instead of secrets
  # ----------------------------------------
  celery-flower:
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      FLOWER_PORT: 5555
      FLOWER_BASIC_AUTH: ${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
      FLOWER_DEBUG: "true"
      FLOWER_BASIC_AUTH_FILE: ""  # Disable secret file
    secrets: []  # No secrets in dev mode
    command: >
      celery
      --broker=redis://redis:6379/0
      flower
      --port=5555
      --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}

# ============================================
# ADDITIONAL DEVELOPMENT SERVICES
# ============================================
  # Adminer for database management
  adminer:
    image: adminer:latest
    container_name: toolboxai-adminer
    restart: always
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: pepa-linha-dark
    networks:
      - database
    depends_on:
      - postgres

  # Redis Commander for Redis management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: toolboxai-redis-commander
    restart: always
    ports:
      - "8081:8081"
    environment:
      REDIS_HOSTS: local:redis:6379
      HTTP_USER: admin
      HTTP_PASSWORD: admin
    networks:
      - cache
    depends_on:
      - redis

  # Mailhog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: toolboxai-mailhog
    restart: always
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - backend

  # Prometheus (Development - disabled due to config issues)
  prometheus:
    profiles: ["monitoring"]  # Only start with: docker compose --profile monitoring up
    security_opt: []
    cap_drop: []
    user: root  # Run as root in development to avoid permission issues

  # ----------------------------------------
  # Redis Exporter (Development Override)
  # ----------------------------------------
  redis-exporter:
    # Simplified configuration for development
    # Remove custom entrypoint and command from base config
    entrypoint: !override ["/redis_exporter"]
    command: !override []
    environment:
      REDIS_ADDR: redis:6379
      # No password in development (matches redis service config)
    secrets: !override []  # Don't use secrets in dev
    read_only: false  # Allow writes in development
    user: root      # Run as root for easier debugging
    security_opt: !override []
    cap_drop: !override []

# ============================================
# DEVELOPMENT VOLUMES
# ============================================
volumes:
  pip_cache:
    driver: local
  node_modules:
    driver: local
  dashboard_node_modules:
    driver: local
  celery_logs:
    driver: local
  celery_data:
    driver: local
  celerybeat_schedule:
    driver: local

# ============================================
# NETWORKS (using base configuration)
# ============================================
networks:
  frontend:
    external: false
  backend:
    external: false
  database:
    external: false
    internal: false  # Allow external access in dev
  cache:
    external: false
    internal: false  # Allow external access in dev
  mcp:
    external: false
    internal: false  # Allow external access in dev
  # Add missing networks from base
  toolboxai-network:
    external: false
  monitoring:
    external: false
  roblox:
    external: false

# File-based secrets for Docker Compose development
# These override the external: true secrets from base config
# Values are loaded from .env by start-dev.sh
# Must explicitly set external: false to override base config
secrets:
  db_password:
    file: .secrets/db_password.txt
    external: false
  redis_password:
    file: .secrets/redis_password.txt
    external: false
  database_url:
    file: .secrets/database_url.txt
    external: false
  redis_url:
    file: .secrets/redis_url.txt
    external: false
  jwt_secret:
    file: .secrets/jwt_secret.txt
    external: false
  openai_api_key:
    file: .secrets/openai_api_key.txt
    external: false
  anthropic_api_key:
    file: .secrets/anthropic_api_key.txt
    external: false
  roblox_api_key:
    file: .secrets/roblox_api_key.txt
    external: false
  roblox_client_secret:
    file: .secrets/roblox_client_secret.txt
    external: false
  langcache_api_key:
    file: .secrets/langcache_api_key.txt
    external: false
  backup_encryption_key:
    file: .secrets/backup_encryption_key.txt
    external: false
  # flower_auth not needed in dev - using env vars instead
