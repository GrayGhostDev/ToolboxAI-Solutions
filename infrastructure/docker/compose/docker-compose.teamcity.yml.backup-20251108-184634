# ============================================
# TEAMCITY CI/CD DOCKER COMPOSE - 2025 EDITION
# ============================================
# Complete TeamCity setup for ToolBoxAI with:
# - TeamCity Server with PostgreSQL database
# - 3 Build Agents for parallel builds
# - Docker-in-Docker support for container builds
# - Non-root security configuration
# - External drive optimization
# - Build Cache feature (2025.07+)
#
# Created: 2025-09-28
# Updated: 2025-11-08 - Upgraded to TeamCity 2025.07, Integrated with Supabase PostgreSQL
# ============================================

services:
  # ----------------------------------------
  # TeamCity Database - INTEGRATED WITH SUPABASE POSTGRESQL
  # ----------------------------------------
  # TeamCity now uses Supabase's PostgreSQL 17 instance
  # Database: teamcity (created in Supabase PostgreSQL)
  # Connection: supabase_db_supabase container via supabase_network_supabase
  # Port: 5432 (internal), 54322 (host)
  # User: supabase_admin
  # ----------------------------------------
  # REMOVED: Standalone teamcity-db container
  # Previous postgres:16-alpine container replaced with Supabase integration
  # ----------------------------------------

  # ----------------------------------------
  # TeamCity Server (2025.07)
  # ----------------------------------------
  teamcity-server:
    image: jetbrains/teamcity-server:2025.07
    platform: linux/amd64
    container_name: teamcity-server
    user: "1000:1000" # Non-root user as per 2025 security standards
    environment:
      # Database configuration - Supabase PostgreSQL Integration
      TEAMCITY_DATABASE_URL: jdbc:postgresql://db.supabase.internal:5432/teamcity
      TEAMCITY_DATABASE_USER: supabase_admin
      TEAMCITY_DATABASE_PASSWORD: postgres

      # Server configuration (Updated 2025-11-08: Production-grade 2025 sizing)
      # JetBrains official recommendation: 16GB supports up to 100 agents
      # 12GB heap + 4GB OS/cache overhead = 16GB total container
      # Removed deprecated MaxPermSize (ignored by Java 21)
      TEAMCITY_SERVER_MEM_OPTS: "-Xmx12g -XX:ReservedCodeCacheSize=896m"
      TEAMCITY_HTTPS_PORT: 8111

      # Build Cache feature (2025.07+)
      TEAMCITY_SERVER_OPTS: "-Dteamcity.buildCache.enabled=true -Dteamcity.buildCache.maxSize=10G"

      # External URL for webhooks and agents
      TEAMCITY_SERVER_URL: ${TEAMCITY_SERVER_URL:-https://ci.toolboxaisolutions.com}

      # Pipeline token for API access (from .env)
      TEAMCITY_PIPELINE_ACCESS_TOKEN: ${TEAMCITY_PIPELINE_ACCESS_TOKEN:-eyJ0eXAiOiAiVENWMiJ9.Z00zSzRFazBrNktpandnemRUZ2dJRGhBbVlF.MTZhZjcxM2EtZWJiZC00ODA2LTgxMmQtMzA2MWZjMjk2OWYz}

      # Integration with existing services
      PUSHER_KEY: ${VITE_PUSHER_KEY}
      PUSHER_SECRET: ${PUSHER_SECRET}
      PUSHER_CLUSTER: ${VITE_PUSHER_CLUSTER:-us2}

      # Performance tuning for external drive
      TEAMCITY_DATA_PATH: /data/teamcity_server/datadir
      TEAMCITY_LOGS_PATH: /opt/teamcity/logs
    ports:
      - "8111:8111"
    volumes:
      # TeamCity data directory on external drive
      - teamcity_data:/data/teamcity_server/datadir
      - teamcity_logs:/opt/teamcity/logs
      # Build cache storage (2025.07+)
      - teamcity_cache:/data/teamcity_server/system/caches
      # Mount project for build configurations
      - ../../../.teamcity:/data/teamcity_server/datadir/config/projects/ToolBoxAI/.teamcity:ro
    networks:
      - teamcity
      - supabase_network_supabase  # Connect to Supabase network for PostgreSQL access
      # - toolboxai # Connect to main network for service integration
    # depends_on removed - Supabase PostgreSQL managed externally
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8111/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 16G  # JetBrains official: 16GB supports up to 100 agents (2025-11-08)
          cpus: '4'    # 2025 best practice: explicit CPU limits for resource fairness
        reservations:
          memory: 12G  # 75% of limit (industry standard, 2025-11-08)
          cpus: '2'    # Guaranteed CPU allocation

  # ----------------------------------------
  # TeamCity Agent 1 - Frontend Specialist
  # ----------------------------------------
  teamcity-agent-1:
    image: jetbrains/teamcity-agent:2025.07-linux-sudo
    platform: linux/amd64
    container_name: teamcity-agent-frontend
    user: "1000:1000"
    privileged: true # Required for Docker-in-Docker
    environment:
      SERVER_URL: http://teamcity-server:8111
      AGENT_NAME: "Frontend-Builder-01"

      # Agent JVM configuration (2025 best practice)
      # Modern TypeScript/React builds need 4GB heap
      TEAMCITY_AGENT_MEM_OPTS: "-Xmx4g -XX:ReservedCodeCacheSize=512m"

      # Docker configuration
      DOCKER_IN_DOCKER: "start"

      # Node.js environment
      NODE_VERSION: "22"
      NPM_CONFIG_CACHE: /data/cache/npm

      # External drive optimization
      TMPDIR: /tmp/build
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - agent1_conf:/data/teamcity_agent/conf
      - agent1_work:/data/teamcity_agent/work
      - agent1_temp:/data/teamcity_agent/temp
      - agent1_tools:/data/teamcity_agent/tools
      # Cache for npm/yarn on faster storage
      - npm_cache:/data/cache/npm
      # Mount source for builds
      - ../../../:/workspace/source:cached
    networks:
      - teamcity
      # - toolboxai
    depends_on:
      - teamcity-server
    deploy:
      resources:
        limits:
          memory: 6G   # Modern frontend builds: TypeScript 5.9 + React 19 + Docker (2025-11-08)
          cpus: '2'    # 2025 best practice: explicit CPU limits
        reservations:
          memory: 4.5G # 75% of limit (2025-11-08)
          cpus: '1'    # Guaranteed CPU allocation

  # ----------------------------------------
  # TeamCity Agent 2 - Backend Specialist
  # ----------------------------------------
  teamcity-agent-2:
    image: jetbrains/teamcity-agent:2025.07-linux-sudo
    platform: linux/amd64
    container_name: teamcity-agent-backend
    user: "1000:1000"
    privileged: true
    environment:
      SERVER_URL: http://teamcity-server:8111
      AGENT_NAME: "Backend-Builder-01"

      # Agent JVM configuration (2025 best practice)
      # Python/FastAPI + LangChain builds need 4GB heap
      TEAMCITY_AGENT_MEM_OPTS: "-Xmx4g -XX:ReservedCodeCacheSize=512m"

      # Docker configuration
      DOCKER_IN_DOCKER: "start"

      # Python environment
      PYTHON_VERSION: "3.12"
      PIP_CACHE_DIR: /data/cache/pip
      PYTHONDONTWRITEBYTECODE: 1

      # External drive optimization
      TMPDIR: /tmp/build
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - agent2_conf:/data/teamcity_agent/conf
      - agent2_work:/data/teamcity_agent/work
      - agent2_temp:/data/teamcity_agent/temp
      - agent2_tools:/data/teamcity_agent/tools
      # Cache for pip on faster storage
      - pip_cache:/data/cache/pip
      # Mount source for builds
      - ../../../:/workspace/source:cached
    networks:
      - teamcity
      # - toolboxai
    depends_on:
      - teamcity-server
    deploy:
      resources:
        limits:
          memory: 6G   # Modern backend builds: Python 3.12 + LangChain + Docker (2025-11-08)
          cpus: '2'    # 2025 best practice: explicit CPU limits
        reservations:
          memory: 4.5G # 75% of limit (2025-11-08)
          cpus: '1'    # Guaranteed CPU allocation

  # ----------------------------------------
  # TeamCity Agent 3 - Integration/Docker Specialist
  # ----------------------------------------
  teamcity-agent-3:
    image: jetbrains/teamcity-agent:2025.07-linux-sudo
    platform: linux/amd64
    container_name: teamcity-agent-integration
    user: "1000:1000"
    privileged: true
    environment:
      SERVER_URL: http://teamcity-server:8111
      AGENT_NAME: "Integration-Builder-01"

      # Agent JVM configuration (2025 best practice)
      # Multi-language E2E tests (Node + Python + Docker) need 4GB heap
      TEAMCITY_AGENT_MEM_OPTS: "-Xmx4g -XX:ReservedCodeCacheSize=512m"

      # Docker configuration
      DOCKER_IN_DOCKER: "start"

      # Multi-language support
      NODE_VERSION: "22"
      PYTHON_VERSION: "3.12"

      # External drive optimization
      TMPDIR: /tmp/build

      # Integration testing
      INTEGRATION_TEST_ENABLED: "true"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - agent3_conf:/data/teamcity_agent/conf
      - agent3_work:/data/teamcity_agent/work
      - agent3_temp:/data/teamcity_agent/temp
      - agent3_tools:/data/teamcity_agent/tools
      # Shared caches
      - npm_cache:/data/cache/npm
      - pip_cache:/data/cache/pip
      - docker_cache:/data/cache/docker
      # Mount source for builds
      - ../../../:/workspace/source:cached
    networks:
      - teamcity
      # - toolboxai
    depends_on:
      - teamcity-server
    deploy:
      resources:
        limits:
          memory: 6G   # Integration tests: Node 22 + Python 3.12 + E2E + Docker (2025-11-08)
          cpus: '2'    # 2025 best practice: explicit CPU limits
        reservations:
          memory: 4.5G # 75% of limit (2025-11-08)
          cpus: '1'    # Guaranteed CPU allocation

  # ----------------------------------------
  # Docker Registry Cache (Optional - Disabled for ARM64 compatibility)
  # ----------------------------------------
  # registry-cache:
  #   image: registry:2
  #   container_name: teamcity-registry-cache
  #   platform: linux/amd64
  #   environment:
  #     REGISTRY_PROXY_REMOTEURL: https://registry-1.docker.io
  #     REGISTRY_STORAGE_CACHE_BLOBDESCRIPTOR: inmemory
  #     REGISTRY_HTTP_ADDR: 0.0.0.0:5000
  #   ports:
  #     - "5000:5000"
  #   volumes:
  #     - registry_data:/var/lib/registry
  #   networks:
  #     - teamcity
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M
  #       reservations:
  #         memory: 256M

# ============================================
# VOLUMES
# ============================================
volumes:
  # TeamCity Server volumes
  # teamcity_db_data - REMOVED (using Supabase PostgreSQL)
  teamcity_data:
    driver: local
  teamcity_logs:
    driver: local
  teamcity_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /Volumes/G-DRIVE ArmorATD/Development/Clients/ToolBoxAI-Solutions/TeamCity/cache

  # Agent configuration volumes
  agent1_conf:
    driver: local
  agent1_work:
    driver: local
  agent1_temp:
    driver: local
  agent1_tools:
    driver: local

  agent2_conf:
    driver: local
  agent2_work:
    driver: local
  agent2_temp:
    driver: local
  agent2_tools:
    driver: local

  agent3_conf:
    driver: local
  agent3_work:
    driver: local
  agent3_temp:
    driver: local
  agent3_tools:
    driver: local

  # Cache volumes (on faster internal storage)
  npm_cache:
    driver: local
  pip_cache:
    driver: local
  docker_cache:
    driver: local
  registry_data:
    driver: local

# ============================================
# NETWORKS
# ============================================
networks:
  teamcity:
    driver: bridge
    name: teamcity-network
  supabase_network_supabase:
    external: true
    name: supabase_network_supabase
  toolboxai:
    external: true
    name: toolboxai
