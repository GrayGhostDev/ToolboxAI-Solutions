# ============================================
# TOOLBOXAI DOCKER COMPOSE - BASE CONFIGURATION
# ============================================
# Docker Engine 25.x optimized configuration
# Security-first approach with modern best practices
# Updated: 2025-09-24
# ============================================

# Docker Compose (v2 specification)

# ============================================
# SHARED CONFIGURATIONS (YAML Anchors)
# ============================================
x-common-variables: &common-variables
  TZ: UTC
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  NODE_ENV: ${NODE_ENV:-production}
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1

x-security-opts: &security-opts
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  read_only: true
  tmpfs:
    - /tmp
    - /var/run

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    tag: "{{.Name}}/{{.ID}}"

x-restart-policy: &restart-policy
  restart: unless-stopped

# Removed unused x-resource-limits anchor - use inline deploy sections instead

# ============================================
# SERVICES
# ============================================
services:
  # ----------------------------------------
  # PostgreSQL Database (Primary)
  # ----------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: toolboxai-postgres
    <<: *restart-policy
    environment:
      <<: *common-variables
      POSTGRES_DB: ${POSTGRES_DB:-toolboxai}
      POSTGRES_USER: ${POSTGRES_USER:-toolboxai}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --data-checksums --auth-host=scram-sha-256 --auth-local=scram-sha-256"
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_WORK_MEM: 4MB
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data:Z
      - ../config/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - postgres_backup:/backup
    networks:
      database:
        aliases:
          - db
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ----------------------------------------
  # Redis Cache & Queue
  # ----------------------------------------
  redis:
    image: redis:7-alpine
    container_name: toolboxai-redis
    <<: [*restart-policy, *security-opts]
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass-file /run/secrets/redis_password
      --bind 0.0.0.0
      --protected-mode yes
      --tcp-backlog 511
      --tcp-keepalive 300
      --timeout 0
    secrets:
      - redis_password
    volumes:
      - redis_data:/data:Z
      - ../config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      cache:
        aliases:
          - cache
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ----------------------------------------
  # HashiCorp Vault - Secret Management
  # ----------------------------------------
  vault:
    image: hashicorp/vault:1.15
    container_name: toolboxai-vault
    <<: *restart-policy
    ports:
      - "8200:8200"
    environment:
      <<: *common-variables
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_API_ADDR: http://vault:8200
      SKIP_SETCAP: "true"
    cap_add:
      - IPC_LOCK
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
      - ../config/vault:/vault/config:ro
    networks:
      - backend
      - database
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: server
    labels:
      - "com.toolboxai.service=vault"
      - "com.toolboxai.environment=production"
      - "com.toolboxai.managed=true"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ----------------------------------------
  # FastAPI Backend
  # ----------------------------------------
  backend:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/backend.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
        # BuildKit cache via DOCKER_BUILDKIT=1 environment variable
    image: toolboxai/backend:${DOCKER_TAG:-latest}
    container_name: toolboxai-backend
    <<: *restart-policy
    environment:
      <<: *common-variables
      HOST: 0.0.0.0
      PORT: ${PORT:-8009}
      WORKERS: ${WORKERS:-4}
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret
      # API Keys from secrets
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      ANTHROPIC_API_KEY_FILE: /run/secrets/anthropic_api_key
      # Feature flags
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_PER_MINUTE: "60"
    secrets:
      - database_url
      - redis_url
      - jwt_secret
      - openai_api_key
      - anthropic_api_key
    volumes:
      - backend_logs:/app/logs:rw
      - agent_data:/app/agent_data:rw
    networks:
      - backend
      - database
      - cache
    depends_on:
      - postgres
      - redis
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ----------------------------------------
  # React Dashboard
  # ----------------------------------------
  dashboard:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/dashboard-2025.Dockerfile
      args:
        # HTTP is acceptable for internal Docker network communication
        VITE_API_BASE_URL: "${VITE_API_BASE_URL:-http://backend:8009}"
        VITE_PUSHER_KEY: "${VITE_PUSHER_KEY:-dummy-key-for-development}"
        VITE_PUSHER_CLUSTER: "${VITE_PUSHER_CLUSTER:-us2}"
        VITE_PUSHER_AUTH_ENDPOINT: "${VITE_PUSHER_AUTH_ENDPOINT:-/api/pusher/auth}"
        VITE_PUSHER_SSL: "${VITE_PUSHER_SSL:-true}"
        VITE_CLERK_PUBLISHABLE_KEY: "${VITE_CLERK_PUBLISHABLE_KEY}"
        VITE_ENABLE_WEBSOCKET: "false"
        VITE_ENABLE_PUSHER: "true"
        VITE_ENABLE_GAMIFICATION: "true"
        VITE_ENABLE_ANALYTICS: "true"
        VITE_ENABLE_MCP: "true"
        VITE_ENABLE_AGENTS: "true"
        VITE_ENABLE_ROBLOX: "true"
        VITE_ENABLE_GHOST: "true"
    image: toolboxai/dashboard:${DOCKER_TAG:-latest}
    container_name: toolboxai-dashboard
    <<: *restart-policy
    ports:
      - "5179:80"
    environment:
      <<: *common-variables
      NODE_ENV: production
      NGINX_ENVSUBST_TEMPLATE_DIR: /etc/nginx/templates
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx/conf.d
      # Runtime Pusher configuration
      VITE_PUSHER_KEY: "${VITE_PUSHER_KEY}"
      VITE_PUSHER_CLUSTER: "${VITE_PUSHER_CLUSTER:-us2}"
      # HTTP is acceptable for internal Docker network communication
      VITE_API_BASE_URL: "${VITE_API_BASE_URL:-http://backend:8009}"
    volumes:
      - nginx_logs:/var/log/nginx:Z
    networks:
      - frontend
      - backend
    depends_on:
      - backend
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost/health"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
    read_only: true
    user: "101:101"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ----------------------------------------
  # MCP Server
  # ----------------------------------------
  mcp-server:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/mcp.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/mcp:${DOCKER_TAG:-latest}
    container_name: toolboxai-mcp
    <<: [*restart-policy, *security-opts]
    environment:
      <<: *common-variables
      MCP_HOST: 0.0.0.0
      MCP_PORT: 9877
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret
      MAX_TOKENS: ${MAX_TOKENS:-8192}
      AGENT_DISCOVERY_ENABLED: "true"
    secrets:
      - database_url
      - redis_url
      - jwt_secret
    volumes:
      - mcp_contexts:/data/contexts:Z
      - agent_data:/data/agents:Z
    networks:
      - mcp
      - database
      - cache
    depends_on:
      - postgres
      - redis
    healthcheck:
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 60s
      test: ["CMD", "curl", "-f", "http://localhost:9877/health"]
    logging: *default-logging
    user: "1002:1002"

  # ----------------------------------------
  # Agent Coordinator
  # ----------------------------------------
  agent-coordinator:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/agents.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/agents:${DOCKER_TAG:-latest}
    container_name: toolboxai-agents
    <<: [*restart-policy, *security-opts]
    environment:
      <<: *common-variables
      COORDINATOR_PORT: 8888
      MCP_SERVER_URL: ws://mcp-server:9877
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      MAX_CONCURRENT_AGENTS: ${MAX_CONCURRENT_AGENTS:-10}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
    secrets:
      - database_url
      - redis_url
      - jwt_secret
      - openai_api_key
    volumes:
      - agent_data:/data/agents:rw
      - agent_logs:/app/logs:rw
    networks:
      - mcp
      - database
      - cache
    depends_on:
      - mcp-server
      - postgres
      - redis
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
    logging: *default-logging
    user: "1003:1003"

  # ----------------------------------------
  # Celery Worker (Background Tasks)
  # ----------------------------------------
  celery-worker:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/celery-worker.Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/celery-worker:${DOCKER_TAG:-latest}
    # container_name removed to support replicas
    <<: *restart-policy
    environment:
      <<: *common-variables
      CELERY_BROKER_URL_FILE: /run/secrets/redis_url
      CELERY_RESULT_BACKEND_FILE: /run/secrets/redis_url
      DATABASE_URL_FILE: /run/secrets/database_url
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      # Celery configuration
      CELERY_WORKER_CONCURRENCY: ${CELERY_WORKER_CONCURRENCY:-4}
      CELERY_WORKER_MAX_TASKS_PER_CHILD: 1000
      CELERY_TASK_TIME_LIMIT: 300
      CELERY_TASK_SOFT_TIME_LIMIT: 270
      CELERY_LOG_LEVEL: ${CELERY_LOG_LEVEL:-INFO}
    secrets:
      - database_url
      - redis_url
      - jwt_secret
      - openai_api_key
    volumes:
      - celery_logs:/app/logs:Z
      - celery_data:/app/data:Z
    networks:
      - backend
      - database
      - cache
    depends_on:
      - redis
      - postgres
      - backend
    healthcheck:
      <<: *healthcheck-defaults
      # Using Celery 5.4 inspect ping command for health check
      test: ["CMD-SHELL", "celery -A apps.backend.celery_app inspect ping -d celery@$$HOSTNAME || exit 1"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    user: "1005:1005"
    deploy:
      replicas: 2  # Run multiple workers
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ----------------------------------------
  # Celery Beat (Task Scheduler)
  # ----------------------------------------
  celery-beat:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/celery-beat.Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/celery-beat:${DOCKER_TAG:-latest}
    # container_name removed to support deploy section
    <<: *restart-policy
    environment:
      <<: *common-variables
      CELERY_BROKER_URL_FILE: /run/secrets/redis_url
      CELERY_RESULT_BACKEND_FILE: /run/secrets/redis_url
      DATABASE_URL_FILE: /run/secrets/database_url
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret
      # Beat configuration
      CELERY_BEAT_LOG_LEVEL: ${CELERY_BEAT_LOG_LEVEL:-INFO}
      CELERY_BEAT_MAX_LOOP_INTERVAL: 60
      TZ: ${TZ:-UTC}
    secrets:
      - database_url
      - redis_url
      - jwt_secret
    volumes:
      - celerybeat_schedule:/app/celerybeat-schedule:Z
      - celery_logs:/app/logs:Z
    networks:
      - backend
      - database
      - cache
    depends_on:
      - redis
      - postgres
      - celery-worker
    healthcheck:
      <<: *healthcheck-defaults
      # Beat process check - Celery Beat doesn't have inspect command
      test: ["CMD-SHELL", "pgrep -f 'celery.*beat' || exit 1"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    user: "1006:1006"
    deploy:
      replicas: 1  # Only one beat instance should run
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ----------------------------------------
  # Celery Flower - Monitoring Dashboard
  # ----------------------------------------
  celery-flower:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/celery-flower.Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/celery-flower:${DOCKER_TAG:-latest}
    <<: *restart-policy
    environment:
      <<: *common-variables
      CELERY_BROKER_URL: ${REDIS_URL:-redis://redis:6379/0}
      FLOWER_PORT: 5555
      FLOWER_BASIC_AUTH: ${FLOWER_BASIC_AUTH:-admin:changeme}
      FLOWER_URL_PREFIX: /flower
    volumes:
      - flower-data:/data:rw
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    networks:
      - backend
    depends_on:
      - redis
      - celery-worker
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5555/api/workers"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
    user: "1007:1007"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ----------------------------------------
  # Roblox Sync Service (Rojo Server)
  # ----------------------------------------
  roblox-sync:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/dockerfiles/roblox-sync.Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: toolboxai/roblox-sync:${DOCKER_TAG:-latest}
    container_name: toolboxai-roblox-sync
    <<: *restart-policy
    environment:
      <<: *common-variables
      ROJO_SERVER_HOST: 0.0.0.0
      ROJO_SERVER_PORT: 34872
      ROJO_PROJECT_PATH: /app/default.project.json
      ROJO_LIVE_RELOAD: ${ROJO_LIVE_RELOAD:-false}
      ROJO_DEV_MODE: ${ROJO_DEV_MODE:-false}
      ROJO_LOG_LEVEL: ${ROJO_LOG_LEVEL:-info}
      RUST_LOG: ${RUST_LOG:-warn}
      # Roblox API configuration
      ROBLOX_UNIVERSE_ID: ${ROBLOX_UNIVERSE_ID}
      ROBLOX_CLIENT_ID: ${ROBLOX_CLIENT_ID}
      ROBLOX_API_KEY_FILE: /run/secrets/roblox_api_key
      ROBLOX_CLIENT_SECRET_FILE: /run/secrets/roblox_client_secret
      # Deployment configuration
      ROBLOX_DEPLOYMENT_ENABLED: ${ROBLOX_DEPLOYMENT_ENABLED:-false}
      ROBLOX_AUTO_DEPLOY: ${ROBLOX_AUTO_DEPLOY:-false}
      ROBLOX_DEPLOY_BRANCH: ${ROBLOX_DEPLOY_BRANCH:-main}
    secrets:
      - roblox_api_key
      - roblox_client_secret
    volumes:
      - ../../../roblox/src:/app/src:ro
      - ../../../roblox/plugins:/app/plugins:ro
      - ../../../roblox/assets:/app/assets:ro
      - ../config/rojo/default.project.json:/app/default.project.json:ro
      - roblox_builds:/app/builds:Z
      - roblox_logs:/app/logs:Z
    networks:
      - backend
      - roblox
    ports:
      - "34872:34872"  # Rojo server port for Studio connection
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:34872/api/rojo/health"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    user: "1007:1007"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ----------------------------------------
  # Redis Cloud Connector (Week 2)
  # ----------------------------------------
  redis-cloud-connector:
    image: redis:7-alpine
    container_name: toolboxai-redis-cloud
    <<: *restart-policy
    environment:
      <<: *common-variables
      REDIS_CLOUD_URL: ${REDIS_CLOUD_URL:-}
      REDIS_CLOUD_CA_CERT_PATH: /certs/redis-cloud-ca.pem
      LANGCACHE_ENABLED: ${LANGCACHE_ENABLED:-false}
      LANGCACHE_API_KEY_FILE: /run/secrets/langcache_api_key
      LANGCACHE_CACHE_ID: ${LANGCACHE_CACHE_ID:-}
      LANGCACHE_SERVER_URL: ${LANGCACHE_SERVER_URL:-https://gcp-us-east4.langcache.redis.io}
      LANGCACHE_SIMILARITY_THRESHOLD: ${LANGCACHE_SIMILARITY_THRESHOLD:-0.95}
    volumes:
      - ../../config/certificates:/certs:ro
      - langcache_data:/data:Z
    networks:
      - cache
      - backend
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD-SHELL", "test -f /certs/redis-cloud-ca.pem && echo 'OK' || exit 1"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ----------------------------------------
  # Backup Coordinator (Week 2)
  # ----------------------------------------
  backup-coordinator:
    image: toolboxai/backend:${DOCKER_TAG:-latest}
    container_name: toolboxai-backup
    <<: *restart-policy
    command: ["python", "-m", "infrastructure.backups.scripts.backup_manager", "status"]
    environment:
      <<: *common-variables
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      BACKUP_ENCRYPTION_ENABLED: ${BACKUP_ENCRYPTION_ENABLED:-true}
      BACKUP_ENCRYPTION_KEY_FILE: /run/secrets/backup_encryption_key
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET:-}
      BACKUP_S3_REGION: ${BACKUP_S3_REGION:-us-east-1}
    secrets:
      - backup_encryption_key
    volumes:
      - postgres_backup:/backup/postgres:rw
      - redis_backup:/backup/redis:rw
      - app_backup:/backup/application:rw
      - backup_logs:/app/logs:rw
    networks:
      - database
      - cache
    depends_on:
      - postgres
      - redis
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "python", "-c", "import sys; from infrastructure.backups.scripts.backup_manager import BackupManager; sys.exit(0 if BackupManager.health_check() else 1)"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE  # For backup file operations
    user: "1008:1008"

  # ----------------------------------------
  # Migration Runner (Week 2)
  # ----------------------------------------
  migration-runner:
    image: toolboxai/backend:${DOCKER_TAG:-latest}
    container_name: toolboxai-migration
    command: ["python", "-m", "apps.backend.services.supabase_migration_manager"]
    environment:
      <<: *common-variables
      MIGRATION_AUTO_RUN: ${MIGRATION_AUTO_RUN:-false}
      MIGRATION_STRATEGY: ${MIGRATION_STRATEGY:-blue-green}
      MIGRATION_TIMEOUT: ${MIGRATION_TIMEOUT:-300}
      MIGRATION_ROLLBACK_ON_ERROR: ${MIGRATION_ROLLBACK_ON_ERROR:-true}
      MIGRATION_HEALTH_CHECK_TIMEOUT: ${MIGRATION_HEALTH_CHECK_TIMEOUT:-60}
      MIGRATION_MAX_RETRIES: ${MIGRATION_MAX_RETRIES:-3}
      DATABASE_URL_FILE: /run/secrets/database_url
      REDIS_URL_FILE: /run/secrets/redis_url
    secrets:
      - database_url
      - redis_url
    volumes:
      - migration_logs:/app/logs:rw
      - ../../../infrastructure/migrations:/app/migrations:ro
    networks:
      - database
      - cache
    depends_on:
      - postgres
      - redis
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "python", "-c", "import sys; from apps.backend.services.supabase_migration_manager import MigrationManager; sys.exit(0 if MigrationManager.health_check() else 1)"]
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    user: "1009:1009"

  # ----------------------------------------
  # Prometheus Monitoring
  # ----------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: toolboxai-prometheus
    <<: *restart-policy
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'
      - '--query.max-concurrency=20'
      - '--enable-feature=promql-at-modifier'
      - '--enable-feature=promql-negative-offset'
    ports:
      - "9090:9090"
    volumes:
      - ../config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../config/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      # prometheus_data:/prometheus  # Disabled - using tmpfs in dev mode
    networks:
      - monitoring
      - backend
      - database
      - cache
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # read_only: false  # Prometheus needs write access to /prometheus for TSDB
    tmpfs:
      - /tmp
      - /prometheus  # Use tmpfs for data in development mode (data not persisted)
    user: "root"  # Development mode - run as root for volume permissions
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.toolboxai.service=prometheus"
      - "com.toolboxai.component=monitoring"
      - "com.toolboxai.managed=true"

  # ----------------------------------------
  # PostgreSQL Exporter
  # ----------------------------------------
  postgres-exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
    container_name: toolboxai-postgres-exporter
    <<: *restart-policy
    environment:
      <<: *common-variables
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}?sslmode=disable"
    networks:
      - monitoring
      - database
    depends_on:
      - postgres
    ports:
      - "9187:9187"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "nobody"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      - "com.toolboxai.service=postgres-exporter"
      - "com.toolboxai.component=monitoring"
      - "com.toolboxai.managed=true"

  # ----------------------------------------
  # Redis Exporter
  # ----------------------------------------
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: toolboxai-redis-exporter
    <<: *restart-policy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export REDIS_PASSWORD=$$(cat /run/secrets/redis_password)
        /redis_exporter
    environment:
      <<: *common-variables
      REDIS_ADDR: redis:6379
    secrets:
      - redis_password
    networks:
      - monitoring
      - cache
    depends_on:
      - redis
    ports:
      - "9121:9121"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging: *default-logging
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    user: "nobody"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      - "com.toolboxai.service=redis-exporter"
      - "com.toolboxai.component=monitoring"
      - "com.toolboxai.managed=true"

# ============================================
# NETWORKS
# ============================================
# All networks are internally managed by Docker Compose
# They will be created automatically when services start
networks:
  toolboxai-network:
    driver: bridge
    name: toolboxai_toolboxai-network

  frontend:
    driver: bridge
    name: toolboxai_frontend

  backend:
    driver: bridge
    name: toolboxai_backend

  database:
    driver: bridge
    name: toolboxai_database

  cache:
    driver: bridge
    name: toolboxai_cache

  mcp:
    driver: bridge
    name: toolboxai_mcp

  monitoring:
    driver: bridge
    name: toolboxai_monitoring

  roblox:
    driver: bridge
    name: toolboxai_roblox

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres_data:
    driver: local
    # Note: For production, consider using named volumes or external storage
    # The DATA_DIR environment variable is no longer used for volume path

  postgres_backup:
    driver: local

  redis_data:
    driver: local

  vault_data:
    driver: local

  vault_logs:
    driver: local

  flower-data:
    driver: local

  backend_logs:
    driver: local

  nginx_logs:
    driver: local

  agent_data:
    driver: local

  agent_logs:
    driver: local

  mcp_contexts:
    driver: local

  prometheus_data:
    driver: local

  celery_logs:
    driver: local

  celery_data:
    driver: local

  celerybeat_schedule:
    driver: local

  roblox_builds:
    driver: local

  roblox_logs:
    driver: local

  # Week 2 Volumes
  redis_backup:
    driver: local

  app_backup:
    driver: local

  langcache_data:
    driver: local

  backup_logs:
    driver: local

  migration_logs:
    driver: local

# ============================================
# SECRETS (External - must be created separately)
# ============================================
secrets:
  db_password:
    external: true
  redis_password:
    external: true
  database_url:
    external: true
  redis_url:
    external: true
  jwt_secret:
    external: true
  openai_api_key:
    external: true
  anthropic_api_key:
    external: true
  roblox_api_key:
    external: true
  roblox_client_secret:
    external: true
  # Week 2 Secrets
  langcache_api_key:
    external: true
  backup_encryption_key:
    external: true
