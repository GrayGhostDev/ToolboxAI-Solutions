# ============================================
# TOOLBOXAI FAST DEVELOPMENT COMPOSE
# ============================================
# Optimized for external drive development
# Uses volume mounts instead of builds for fast startup
# Created: 2025-09-28
# ============================================

services:
  # ----------------------------------------
  # PostgreSQL Database
  # ----------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: toolboxai-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-toolboxai}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass2024}
      POSTGRES_DB: ${POSTGRES_DB:-toolboxai}
    ports:
      - "5434:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - toolboxai
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-toolboxai}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # Redis Cache
  # ----------------------------------------
  redis:
    image: redis:7-alpine
    container_name: toolboxai-redis
    ports:
      - "6381:6379"
    volumes:
      - redis_data:/data
    networks:
      - toolboxai
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # FastAPI Backend (No Build - Volume Mount)
  # ----------------------------------------
  backend:
    image: python:3.12-slim
    container_name: toolboxai-backend
    working_dir: /app
    ports:
      - "8009:8009"
    environment:
      PYTHONPATH: /app
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-sk-test}
      PUSHER_APP_ID: ${PUSHER_APP_ID:-}
      PUSHER_KEY: ${PUSHER_KEY:-}
      PUSHER_SECRET: ${PUSHER_SECRET:-}
      PUSHER_CLUSTER: ${PUSHER_CLUSTER:-us2}
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
    volumes:
      # Mount entire project for Python imports
      - ../../../:/app:cached
      # Mount requirements for pip install
      - ../../../requirements.txt:/app/requirements.txt:ro
    networks:
      - toolboxai
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        echo 'ðŸ”§ Installing build dependencies...' &&
        apt-get update && apt-get install -y gcc python3-dev &&
        echo 'ðŸ”§ Installing Python dependencies...' &&
        pip install --no-cache-dir -q -r requirements.txt &&
        echo 'âœ… Dependencies installed' &&
        echo 'ðŸš€ Starting FastAPI server...' &&
        cd /app &&
        python -m uvicorn apps.backend.main:app --host 0.0.0.0 --port 8009 --reload
      "

  # ----------------------------------------
  # React Dashboard (No Build - Volume Mount)
  # ----------------------------------------
  dashboard:
    image: node:20-alpine
    container_name: toolboxai-dashboard
    working_dir: /app
    ports:
      - "5179:5173"
    environment:
      NODE_ENV: development
      VITE_API_BASE_URL: http://localhost:8009
      VITE_PUSHER_KEY: ${VITE_PUSHER_KEY:-}
      VITE_PUSHER_CLUSTER: ${VITE_PUSHER_CLUSTER:-us2}
      VITE_PUSHER_AUTH_ENDPOINT: /api/pusher/auth
      VITE_PUSHER_SSL: "true"
      VITE_ENABLE_PUSHER: "true"
      VITE_ENABLE_WEBSOCKET: "false"
      VITE_ENABLE_CLERK_AUTH: ${VITE_ENABLE_CLERK_AUTH:-false}
      VITE_CLERK_PUBLISHABLE_KEY: ${VITE_CLERK_PUBLISHABLE_KEY:-}
    volumes:
      # Mount dashboard directory
      - ../../../apps/dashboard:/app:cached
      # Create a named volume for node_modules (faster than external drive)
      - dashboard_node_modules:/app/node_modules
    networks:
      - toolboxai
    depends_on:
      - backend
    command: >
      sh -c "
        echo 'ðŸ”§ Installing Node dependencies (this will take 5-10 minutes on first run)...' &&
        npm install --legacy-peer-deps &&
        echo 'âœ… Dependencies installed' &&
        echo 'ðŸš€ Starting Vite dev server...' &&
        npm run dev -- --host 0.0.0.0
      "

  # ----------------------------------------
  # OPTIONAL: MCP Server (if needed)
  # ----------------------------------------
  mcp-server:
    image: python:3.12-slim
    container_name: toolboxai-mcp
    working_dir: /app
    ports:
      - "9877:9877"
    environment:
      PYTHONPATH: /app
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/1
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-sk-test}
      DEBUG: "true"
    volumes:
      - ../../../:/app:cached
    networks:
      - toolboxai
    depends_on:
      - postgres
      - redis
    command: >
      sh -c "
        echo 'ðŸ”§ Installing MCP dependencies...' &&
        pip install --no-cache-dir -q fastapi uvicorn websockets PyJWT python-jose[cryptography] pydantic pydantic-settings python-dotenv sqlalchemy asyncpg redis langchain langchain-openai langchain-anthropic &&
        echo 'ðŸš€ Starting MCP server...' &&
        python -m uvicorn core.mcp.server:app --host 0.0.0.0 --port 9877 --reload
      "

  # ----------------------------------------
  # OPTIONAL: Agent Coordinator (if needed)
  # ----------------------------------------
  agent-coordinator:
    image: python:3.12-slim
    container_name: toolboxai-coordinator
    working_dir: /app
    ports:
      - "8888:8888"
    environment:
      PYTHONPATH: /app
      MCP_SERVER_URL: ws://mcp-server:9877
      DATABASE_URL: postgresql://${POSTGRES_USER:-toolboxai}:${POSTGRES_PASSWORD:-devpass2024}@postgres:5432/${POSTGRES_DB:-toolboxai}
      REDIS_URL: redis://redis:6379/2
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-key}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-sk-test}
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY:-}
      LANGCHAIN_PROJECT: ${LANGCHAIN_PROJECT:-ToolboxAI-Solutions}
    volumes:
      - ../../../:/app:cached
    networks:
      - toolboxai
    depends_on:
      - mcp-server
    command: >
      sh -c "
        echo 'ðŸ”§ Installing coordinator dependencies...' &&
        pip install --no-cache-dir -q langchain langchain-openai langchain-anthropic langgraph langsmith PyJWT python-jose[cryptography] pydantic pydantic-settings sqlalchemy asyncpg redis fastapi uvicorn websockets &&
        echo 'ðŸš€ Starting coordinator...' &&
        python -m uvicorn core.agents.coordinator:app --host 0.0.0.0 --port 8888 --reload
      "

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  dashboard_node_modules:
    driver: local  # This will be on internal drive - much faster!

# ============================================
# NETWORKS
# ============================================
networks:
  toolboxai:
    driver: bridge