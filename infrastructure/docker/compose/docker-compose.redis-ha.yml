# ============================================
# Redis High Availability Configuration
# ============================================
# Master-Replica setup with Sentinel
# Automatic failover enabled
# ============================================

version: '3.9'

networks:
  cache:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.23.0.0/24

  backend:
    driver: bridge
    internal: true

volumes:
  redis_master_data:
  redis_replica1_data:
  redis_replica2_data:
  redis_sentinel1_data:
  redis_sentinel2_data:
  redis_sentinel3_data:

secrets:
  redis_password:
    external: true

services:
  # ----------------------------------------
  # Redis Master
  # ----------------------------------------
  redis-master:
    image: redis:7-alpine
    container_name: toolboxai-redis-master
    restart: unless-stopped
    command: >
      sh -c '
        echo "requirepass $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        echo "masterauth $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        redis-server /etc/redis/redis.conf
      '
    volumes:
      - redis_master_data:/data
      - ../config/redis/redis.conf:/etc/redis/redis.conf:ro
      - ../config/redis/users.acl:/etc/redis/users.acl:ro
      - ../certificates/redis:/etc/redis/certs:ro
    secrets:
      - redis_password
    networks:
      cache:
        ipv4_address: 172.23.0.10
      backend:
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "-p", "6380", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ----------------------------------------
  # Redis Replica 1
  # ----------------------------------------
  redis-replica1:
    image: redis:7-alpine
    container_name: toolboxai-redis-replica1
    restart: unless-stopped
    command: >
      sh -c '
        echo "requirepass $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        echo "masterauth $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        echo "replicaof redis-master 6380" >> /etc/redis/redis.conf &&
        redis-server /etc/redis/redis.conf
      '
    volumes:
      - redis_replica1_data:/data
      - ../config/redis/redis.conf:/etc/redis/redis.conf:ro
      - ../config/redis/users.acl:/etc/redis/users.acl:ro
      - ../certificates/redis:/etc/redis/certs:ro
    secrets:
      - redis_password
    networks:
      - cache
      - backend
    depends_on:
      - redis-master
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "-p", "6380", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------------------------------
  # Redis Replica 2
  # ----------------------------------------
  redis-replica2:
    image: redis:7-alpine
    container_name: toolboxai-redis-replica2
    restart: unless-stopped
    command: >
      sh -c '
        echo "requirepass $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        echo "masterauth $$(cat /run/secrets/redis_password)" >> /etc/redis/redis.conf &&
        echo "replicaof redis-master 6380" >> /etc/redis/redis.conf &&
        redis-server /etc/redis/redis.conf
      '
    volumes:
      - redis_replica2_data:/data
      - ../config/redis/redis.conf:/etc/redis/redis.conf:ro
      - ../config/redis/users.acl:/etc/redis/users.acl:ro
      - ../certificates/redis:/etc/redis/certs:ro
    secrets:
      - redis_password
    networks:
      - cache
      - backend
    depends_on:
      - redis-master
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "-p", "6380", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------------------------------
  # Redis Sentinel 1
  # ----------------------------------------
  redis-sentinel1:
    image: redis:7-alpine
    container_name: toolboxai-redis-sentinel1
    restart: unless-stopped
    command: >
      sh -c '
        export REDIS_PASSWORD=$$(cat /run/secrets/redis_password) &&
        envsubst < /etc/redis/sentinel.conf.template > /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      '
    volumes:
      - redis_sentinel1_data:/data
      - ../config/redis/sentinel.conf:/etc/redis/sentinel.conf.template:ro
    secrets:
      - redis_password
    networks:
      - cache
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------------------------------
  # Redis Sentinel 2
  # ----------------------------------------
  redis-sentinel2:
    image: redis:7-alpine
    container_name: toolboxai-redis-sentinel2
    restart: unless-stopped
    command: >
      sh -c '
        export REDIS_PASSWORD=$$(cat /run/secrets/redis_password) &&
        envsubst < /etc/redis/sentinel.conf.template > /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      '
    volumes:
      - redis_sentinel2_data:/data
      - ../config/redis/sentinel.conf:/etc/redis/sentinel.conf.template:ro
    secrets:
      - redis_password
    networks:
      - cache
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2

  # ----------------------------------------
  # Redis Sentinel 3
  # ----------------------------------------
  redis-sentinel3:
    image: redis:7-alpine
    container_name: toolboxai-redis-sentinel3
    restart: unless-stopped
    command: >
      sh -c '
        export REDIS_PASSWORD=$$(cat /run/secrets/redis_password) &&
        envsubst < /etc/redis/sentinel.conf.template > /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      '
    volumes:
      - redis_sentinel3_data:/data
      - ../config/redis/sentinel.conf:/etc/redis/sentinel.conf.template:ro
    secrets:
      - redis_password
    networks:
      - cache
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2

