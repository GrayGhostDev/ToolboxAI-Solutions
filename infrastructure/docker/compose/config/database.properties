# ============================================
# TeamCity External Database Configuration
# ============================================
# Official documentation: https://www.jetbrains.com/help/teamcity/setting-up-an-external-database.html
# Database: PostgreSQL 17.6 (Supabase)
# Created: 2025-11-08
# ============================================

# Connection URL - Supabase PostgreSQL via Docker network
# Format: jdbc:postgresql://host:port/database?parameters
connectionUrl=jdbc:postgresql://supabase_db_supabase:5432/teamcity

# Database credentials
# Password will be read from Docker Secret at: /run/secrets/db_password
connectionProperties.user=postgres
connectionProperties.password=${POSTGRES_PASSWORD}

# Connection pool settings (recommended for 3-5 agents)
maxConnections=50
connectionTimeout=30

# Socket timeout (prevents hanging connections)
connectionProperties.socketTimeout=30

# SSL mode (not required for internal Docker network)
connectionProperties.sslmode=disable

# Application name (helps identify TeamCity connections in PostgreSQL logs)
connectionProperties.ApplicationName=TeamCity-Server

# Statement cache size (improves performance)
connectionProperties.prepareThreshold=5

# Connection retry settings
connectionProperties.loginTimeout=10
connectionProperties.connectTimeout=10

# Encoding (must match database encoding)
connectionProperties.characterEncoding=UTF8

# ============================================
# Performance Tuning
# ============================================
# Connection validation query
connectionProperties.validationQuery=SELECT 1

# Test connection on checkout
testConnectionOnCheckout=true

# Idle connection test period (seconds)
idleConnectionTestPeriod=900

# ============================================
# Notes
# ============================================
# - maxConnections should be set based on agent count
# - For 3 local agents: 50 connections is adequate
# - Socket timeout prevents hung connections
# - SSL disabled for internal Docker network (faster)
# - Password loaded from Docker Secret (not hardcoded)
