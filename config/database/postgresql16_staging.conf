# PostgreSQL 16 Configuration for ToolBoxAI Staging Environment
# Optimized for performance testing and migration validation
# September 2024

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Authentication
password_encryption = scram-sha-256

# =============================================================================
# RESOURCE USAGE (MEMORY)
# =============================================================================

# Memory settings optimized for staging (assuming 4GB RAM available)
shared_buffers = 1GB                    # 25% of RAM
effective_cache_size = 3GB              # 75% of RAM
work_mem = 8MB                          # Per operation
maintenance_work_mem = 256MB            # For maintenance operations
autovacuum_work_mem = 256MB            # For autovacuum workers

# =============================================================================
# JIT COMPILATION (PostgreSQL 16 Feature)
# =============================================================================

jit = on                               # Enable JIT compilation
jit_above_cost = 100000               # Enable JIT for queries with cost > 100k
jit_inline_above_cost = 500000        # Enable inlining for queries with cost > 500k
jit_optimize_above_cost = 500000      # Enable optimization for queries with cost > 500k

# =============================================================================
# PARALLEL QUERY EXECUTION
# =============================================================================

max_parallel_workers_per_gather = 4   # Workers per parallel operation
max_parallel_workers = 8              # Total parallel workers
max_parallel_maintenance_workers = 4   # Parallel maintenance workers
parallel_leader_participation = on     # Leader participates in parallel operations

# =============================================================================
# WRITE AHEAD LOG (WAL)
# =============================================================================

wal_level = logical                    # Required for logical replication
fsync = on                            # Force synchronization of updates to disk
synchronous_commit = on               # Synchronous commit for data safety
wal_sync_method = fsync               # Method to force WAL updates to disk

# WAL writing
wal_writer_delay = 200ms              # WAL writer sleep time
wal_writer_flush_after = 1MB          # Amount of WAL written before flush

# WAL archiving and replication
max_wal_senders = 10                  # Max replication connections
max_replication_slots = 10            # Max replication slots
wal_keep_size = 1GB                   # Amount of WAL to keep for standby servers

# =============================================================================
# CHECKPOINTS
# =============================================================================

checkpoint_timeout = 5min             # Maximum time between checkpoints
checkpoint_completion_target = 0.9    # Target for checkpoint completion
max_wal_size = 2GB                    # Maximum size to let WAL grow
min_wal_size = 512MB                  # Minimum size to reserve for WAL

# =============================================================================
# QUERY TUNING
# =============================================================================

# Cost-based optimizer settings
random_page_cost = 1.1                # Cost of random page access (SSD optimized)
effective_io_concurrency = 200        # Number of concurrent I/O operations (SSD)
maintenance_io_concurrency = 10       # Concurrent I/O for maintenance operations

# Statistics
default_statistics_target = 100       # Default statistics target for table columns

# =============================================================================
# VACUUM AND AUTOVACUUM
# =============================================================================

# Autovacuum settings
autovacuum = on                       # Enable autovacuum
autovacuum_max_workers = 3            # Maximum autovacuum worker processes
autovacuum_naptime = 1min             # Time between autovacuum runs

# Autovacuum thresholds
autovacuum_vacuum_threshold = 50      # Minimum number of updated tuples before vacuum
autovacuum_vacuum_scale_factor = 0.2  # Fraction of table size before vacuum
autovacuum_analyze_threshold = 50     # Minimum number of updated tuples before analyze
autovacuum_analyze_scale_factor = 0.1 # Fraction of table size before analyze

# Vacuum cost settings
autovacuum_vacuum_cost_delay = 10ms   # Vacuum cost delay for autovacuum
autovacuum_vacuum_cost_limit = 200    # Vacuum cost limit for autovacuum

# =============================================================================
# LOGGING
# =============================================================================

# Where to log
logging_collector = on                # Enable logging collector
log_directory = '/var/log/postgresql' # Directory for log files
log_filename = 'postgresql-staging-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0640                  # Log file permissions
log_rotation_age = 1d                 # Age at which log files are rotated
log_rotation_size = 100MB             # Size at which log files are rotated

# When to log
log_min_messages = info               # Minimum severity level to log
log_min_error_statement = error       # Minimum severity for error statements
log_min_duration_statement = 1000     # Log statements taking longer than 1s

# What to log
log_checkpoints = on                  # Log checkpoints
log_connections = on                  # Log connections
log_disconnections = on               # Log disconnections
log_lock_waits = on                   # Log long lock waits
log_temp_files = 0                    # Log temporary files
log_autovacuum_min_duration = 0       # Log all autovacuum operations

# Log line formatting
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# =============================================================================
# RUNTIME STATISTICS
# =============================================================================

# Statistics monitoring
track_activities = on                 # Collect information about running commands
track_counts = on                     # Collect statistics about table and index access
track_io_timing = on                  # Collect timing statistics for I/O operations
track_wal_io_timing = on             # Collect timing statistics for WAL I/O
track_functions = all                 # Track function call statistics

# pg_stat_statements extension
shared_preload_libraries = 'pg_stat_statements'

# =============================================================================
# NEW POSTGRESQL 16 FEATURES
# =============================================================================

# Partitioning improvements
enable_partitionwise_join = on        # Enable partition-wise joins
enable_partitionwise_aggregate = on   # Enable partition-wise aggregates

# Logical replication improvements
logical_decoding_work_mem = 64MB      # Memory for logical decoding

# Performance improvements
enable_incremental_sort = on          # Enable incremental sort
enable_memoize = on                   # Enable memoize node

# =============================================================================
# CONNECTION POOLING SUPPORT
# =============================================================================

# Settings to work well with PgBouncer
max_prepared_transactions = 0         # Disable prepared transactions for pooling
default_transaction_isolation = 'read committed'

# =============================================================================
# EXTENSIONS
# =============================================================================

# Required extensions for monitoring and performance
# These should be created in the database:
# CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
# CREATE EXTENSION IF NOT EXISTS pg_buffercache;
# CREATE EXTENSION IF NOT EXISTS pg_prewarm;

# =============================================================================
# STAGING-SPECIFIC SETTINGS
# =============================================================================

# Development and testing features
log_statement = 'all'                # Log all statements for debugging
log_duration = on                     # Log query durations
debug_print_plan = off               # Don't print execution plans (too verbose)
debug_print_parse = off              # Don't print parse trees
debug_print_rewritten = off          # Don't print rewritten queries

# Error reporting
log_error_verbosity = verbose         # Include DETAIL and HINT in error messages

# Statement timeout for long-running queries
statement_timeout = 300s             # 5 minutes timeout for statements
lock_timeout = 30s                   # 30 seconds timeout for locks

# =============================================================================
# LOCALE AND FORMATTING
# =============================================================================

datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'