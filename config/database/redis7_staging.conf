# Redis 7 Configuration for ToolBoxAI Staging Environment
# Optimized for performance testing and feature validation
# September 2024

# =============================================================================
# NETWORK AND SECURITY
# =============================================================================

# Network
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# Security
requirepass staging_redis7_password_2024
protected-mode yes

# ACL (Access Control Lists) - Redis 7 feature
aclfile /usr/local/etc/redis/users.acl

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Memory settings for staging (512MB limit)
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Memory usage optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000

# =============================================================================
# PERSISTENCE
# =============================================================================

# RDB snapshots
save 900 1      # Save after 900 seconds if at least 1 key changed
save 300 10     # Save after 300 seconds if at least 10 keys changed
save 60 10000   # Save after 60 seconds if at least 10,000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename staging-dump.rdb
rdb-del-sync-files no

# AOF (Append Only File)
appendonly yes
appendfilename "staging-appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# =============================================================================
# REDIS 7 SPECIFIC FEATURES
# =============================================================================

# Redis Functions (replacement for Lua scripting)
enable-module-command yes

# Eviction settings for Redis 7
maxmemory-eviction-tenacity 10

# Multi-part AOF (Redis 7 feature)
aof-rewrite-incremental-fsync yes

# =============================================================================
# LOGGING
# =============================================================================

# Log level and output
loglevel notice
logfile /var/log/redis/redis-staging.log
syslog-enabled yes
syslog-ident redis-staging
syslog-facility local0

# =============================================================================
# SLOW LOG
# =============================================================================

# Slow query logging
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128            # Keep last 128 slow queries

# =============================================================================
# CLIENT MANAGEMENT
# =============================================================================

# Client connections
maxclients 1000
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
client-query-buffer-limit 1gb

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Hash table configuration
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List configuration
list-max-ziplist-size -2
list-compress-depth 0

# Set configuration
set-max-intset-entries 512

# Sorted set configuration
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog configuration
hll-sparse-max-bytes 3000

# Streams configuration
stream-node-max-bytes 4096
stream-node-max-entries 100

# =============================================================================
# THREADING AND PERFORMANCE
# =============================================================================

# I/O threads (Redis 6.0+)
io-threads 4
io-threads-do-reads yes

# =============================================================================
# REPLICATION (for future scaling)
# =============================================================================

# Replication settings (if needed for staging tests)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# =============================================================================
# MODULES AND EXTENSIONS
# =============================================================================

# Load Redis modules if needed
# loadmodule /path/to/module.so

# =============================================================================
# REDIS CLUSTER (disabled for staging)
# =============================================================================

# cluster-enabled no

# =============================================================================
# LATENCY MONITORING
# =============================================================================

# Latency monitoring
latency-monitor-threshold 100  # Monitor operations taking longer than 100ms

# =============================================================================
# NOTIFY SETTINGS
# =============================================================================

# Keyspace notifications for monitoring
notify-keyspace-events Ex

# =============================================================================
# ADVANCED MEMORY SETTINGS
# =============================================================================

# Memory usage tracking
maxmemory-samples 5
activerehashing yes

# Lazy freeing (Redis 4.0+)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# =============================================================================
# STAGING-SPECIFIC SETTINGS
# =============================================================================

# Disable some safety features for testing
stop-writes-on-bgsave-error no

# Enable all commands for testing
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""

# Increase timeouts for debugging
timeout 0

# =============================================================================
# MONITORING AND DEBUGGING
# =============================================================================

# Enable all info sections
# This is useful for monitoring tools like Prometheus

# Performance monitoring
# These settings help with performance analysis
latency-monitor-threshold 100

# =============================================================================
# TLS/SSL (disabled for staging simplicity)
# =============================================================================

# port 0
# tls-port 6379
# tls-cert-file redis.crt
# tls-key-file redis.key
# tls-ca-cert-file ca.crt