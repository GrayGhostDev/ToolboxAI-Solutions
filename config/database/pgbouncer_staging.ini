# PgBouncer Configuration for ToolBoxAI Staging Environment
# Connection pooling for PostgreSQL 16
# September 2024

# =============================================================================
# DATABASE CONNECTIONS
# =============================================================================

[databases]
# Primary database
toolboxai_staging = host=postgres16 port=5432 dbname=toolboxai_staging user=toolboxai_user password=staging_pg16_password_2024

# Test database
toolboxai_test_staging = host=postgres16 port=5432 dbname=toolboxai_test_staging user=toolboxai_user password=staging_pg16_password_2024

# Legacy database (for migration testing)
toolboxai_staging_old = host=postgres15 port=5432 dbname=toolboxai_staging_old user=toolboxai_user password=staging_password_2024

# Catch-all for other databases
* = host=postgres16 port=5432 user=toolboxai_user password=staging_pg16_password_2024

# =============================================================================
# PGBOUNCER SETTINGS
# =============================================================================

[pgbouncer]

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================

# Listen settings
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt
auth_hba_file = /etc/pgbouncer/pg_hba.conf

# Admin settings
admin_users = postgres, toolboxai_user
stats_users = postgres, toolboxai_user, monitoring

# =============================================================================
# POOL SETTINGS
# =============================================================================

# Pool mode: session, transaction, or statement
pool_mode = transaction

# Pool sizing
max_client_conn = 1000          # Maximum client connections
default_pool_size = 100         # Default pool size per database
min_pool_size = 10              # Minimum pool size
reserve_pool_size = 10          # Reserved connections for admin users
max_db_connections = 200        # Maximum connections per database
max_user_connections = 100      # Maximum connections per user

# =============================================================================
# TIMING SETTINGS
# =============================================================================

# Server connection settings
server_lifetime = 3600          # Server connection lifetime (1 hour)
server_idle_timeout = 600       # Server idle timeout (10 minutes)
server_connect_timeout = 15     # Server connection timeout
server_login_retry = 15         # Server login retry interval

# Client connection settings
client_idle_timeout = 0         # Client idle timeout (0 = disabled)
client_login_timeout = 60       # Client login timeout

# Query settings
query_timeout = 300             # Query timeout (5 minutes)
query_wait_timeout = 120        # Query wait timeout (2 minutes)
cancel_wait_timeout = 10        # Cancel wait timeout

# =============================================================================
# MEMORY AND PERFORMANCE
# =============================================================================

# Memory settings
max_packet_size = 2147483647    # Maximum packet size
pkt_buf = 4096                  # Packet buffer size
listen_backlog = 128            # Listen backlog

# Performance tuning
so_reuseport = 1               # Enable SO_REUSEPORT
tcp_defer_accept = 1           # Enable TCP_DEFER_ACCEPT
tcp_keepalive = 1              # Enable TCP keepalive
tcp_keepcnt = 3                # TCP keepalive count
tcp_keepidle = 600             # TCP keepalive idle time
tcp_keepintvl = 30             # TCP keepalive interval

# =============================================================================
# LOGGING
# =============================================================================

# Log settings
logfile = /var/log/pgbouncer/pgbouncer-staging.log
pidfile = /var/run/pgbouncer/pgbouncer-staging.pid
syslog = 1
syslog_facility = daemon
syslog_ident = pgbouncer-staging

# Logging verbosity
log_connections = 1             # Log connections
log_disconnections = 1          # Log disconnections
log_pooler_errors = 1          # Log pooler errors
log_stats = 1                  # Log statistics

# Application name logging
application_name_add_host = 1   # Add hostname to application name

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Security
ignore_startup_parameters = extra_float_digits,search_path

# SSL/TLS (disabled for staging simplicity)
# server_tls_sslmode = prefer
# server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
# server_tls_key_file = /etc/pgbouncer/server.key
# server_tls_cert_file = /etc/pgbouncer/server.crt

# client_tls_sslmode = allow
# client_tls_key_file = /etc/pgbouncer/client.key
# client_tls_cert_file = /etc/pgbouncer/client.crt
# client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt

# =============================================================================
# ADVANCED SETTINGS
# =============================================================================

# DNS settings
dns_max_ttl = 15               # DNS cache TTL
dns_nxdomain_ttl = 15          # DNS negative cache TTL
dns_zone_check_period = 0      # DNS zone check period

# Resource limits
max_packet_size = 2147483647   # Maximum packet size

# Statement timeout
server_reset_query = DISCARD ALL  # Query to reset server state
server_reset_query_always = 0     # Always run reset query

# =============================================================================
# MONITORING AND HEALTH CHECKS
# =============================================================================

# Statistics
stats_period = 60              # Statistics collection period

# Health check settings
server_check_delay = 30        # Health check delay
server_check_query = SELECT 1  # Health check query

# =============================================================================
# STAGING-SPECIFIC SETTINGS
# =============================================================================

# Disable some features for easier debugging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# More verbose logging for staging
verbose = 0

# Allow test connections
ignore_startup_parameters = extra_float_digits,search_path,application_name

# =============================================================================
# USER LIST FILE FORMAT
# =============================================================================
# The /etc/pgbouncer/userlist.txt file should contain:
# "username" "password_in_scram_sha_256_format"
#
# To generate SCRAM-SHA-256 password:
# echo -n "password_with_salt_and_iterations" | sha256sum
#
# Example entries:
# "toolboxai_user" "SCRAM-SHA-256$4096:salt$hash:serverkey"
# "postgres" "SCRAM-SHA-256$4096:salt$hash:serverkey"