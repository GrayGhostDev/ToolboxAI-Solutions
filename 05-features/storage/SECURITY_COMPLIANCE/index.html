<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Comprehensive documentation for the ToolBoxAI educational platform with AI-powered content generation and Roblox integration" name="description"/><meta content="ToolBoxAI Team" name="author"/><link href="https://docs.toolboxai.com/05-features/storage/SECURITY_COMPLIANCE/" rel="canonical"/><link href="../../../images/favicon.png" rel="icon"/><meta content="mkdocs-1.6.1, mkdocs-material-9.6.21" name="generator"/><title>Security &amp; Compliance - ToolBoxAI Solutions Documentation</title><link href="../../../assets/stylesheets/main.2a3383ac.min.css" rel="stylesheet"/><link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href="../../../css/timeago.css" rel="stylesheet"/><link href="../../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#security-compliance"> Skip to content </a> </div> <div data-md-component="announce"> </div> <div data-md-color-scheme="default" data-md-component="outdated" hidden=""> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../../images/logo.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> ToolBoxAI Solutions Documentation </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Security &amp; Compliance </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0"> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> </nav> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../01-overview/README.md"> Getting Started </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../02-architecture/README.md"> Architecture </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../03-api/README.md"> API Documentation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../04-implementation/README.md"> Implementation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../README.md"> Features </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../06-user-guides/README.md"> User Guides </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../07-operations/README.md"> Operations </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../08-reference/README.md"> Reference </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../09-meta/README.md"> Meta </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../10-reports/README.md"> Reports </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../11-sdks/README.md"> SDKs </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../phase2/"> Phase 2 (Current) </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> Audit &amp; Reports </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../../images/logo.png"/> </a> ToolBoxAI Solutions Documentation </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../.."> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../01-overview/README.md"> <span class="md-ellipsis"> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../02-architecture/README.md"> <span class="md-ellipsis"> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../03-api/README.md"> <span class="md-ellipsis"> API Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../04-implementation/README.md"> <span class="md-ellipsis"> Implementation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../README.md"> <span class="md-ellipsis"> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../06-user-guides/README.md"> <span class="md-ellipsis"> User Guides </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../07-operations/README.md"> <span class="md-ellipsis"> Operations </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../08-reference/README.md"> <span class="md-ellipsis"> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../09-meta/README.md"> <span class="md-ellipsis"> Meta </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../10-reports/README.md"> <span class="md-ellipsis"> Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../11-sdks/README.md"> <span class="md-ellipsis"> SDKs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../phase2/"> <span class="md-ellipsis"> Phase 2 (Current) </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> <span class="md-ellipsis"> Audit &amp; Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/edit/main/docs/05-features/storage/SECURITY_COMPLIANCE.md" rel="edit" title="Edit this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/raw/main/docs/05-features/storage/SECURITY_COMPLIANCE.md" title="View source of this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id="security-compliance">Security &amp; Compliance<a class="headerlink" href="#security-compliance" title="Permanent link">¶</a></h1> <p>The ToolBoxAI Storage System implements comprehensive security measures and educational compliance features to protect sensitive student data and meet regulatory requirements including COPPA, FERPA, and general data protection standards.</p> <h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">¶</a></h2> <ul> <li><a href="#virus-scanning-with-clamav">Virus Scanning with ClamAV</a></li> <li><a href="#coppafferpa-compliance-measures">COPPA/FERPA Compliance Measures</a></li> <li><a href="#pii-detection-and-protection">PII Detection and Protection</a></li> <li><a href="#encryption-options">Encryption Options</a></li> <li><a href="#audit-logging">Audit Logging</a></li> <li><a href="#access-control">Access Control</a></li> <li><a href="#data-retention-and-deletion">Data Retention and Deletion</a></li> <li><a href="#incident-response">Incident Response</a></li> </ul> <h2 id="virus-scanning-with-clamav">Virus Scanning with ClamAV<a class="headerlink" href="#virus-scanning-with-clamav" title="Permanent link">¶</a></h2> <h3 id="clamav-integration-architecture">ClamAV Integration Architecture<a class="headerlink" href="#clamav-integration-architecture" title="Permanent link">¶</a></h3> <pre class="mermaid"><code>graph TB
    subgraph "Upload Pipeline"
        FileUpload[File Upload]
        SizeCheck{Size Check}
        DirectScan[Direct Scan]
        QueueScan[Queue for Scan]
    end

    subgraph "ClamAV Infrastructure"
        ClamAVDaemon[ClamAV Daemon]
        VirusDB[Virus Database]
        CustomSigs[Custom Signatures]
        UpdateService[Update Service]
    end

    subgraph "Quarantine System"
        QuarantineBucket[Quarantine Storage]
        ThreatAnalysis[Threat Analysis]
        ManualReview[Manual Review]
        AlertSystem[Alert System]
    end

    subgraph "Processing Results"
        CleanFile[Mark as Clean]
        InfectedFile[Mark as Infected]
        SuspiciousFile[Mark as Suspicious]
        ProcessingError[Processing Error]
    end

    FileUpload --&gt; SizeCheck
    SizeCheck --&gt;|&lt; 10MB| DirectScan
    SizeCheck --&gt;|&gt; 10MB| QueueScan

    DirectScan --&gt; ClamAVDaemon
    QueueScan --&gt; ClamAVDaemon

    ClamAVDaemon --&gt; VirusDB
    ClamAVDaemon --&gt; CustomSigs

    ClamAVDaemon --&gt; CleanFile
    ClamAVDaemon --&gt; InfectedFile
    ClamAVDaemon --&gt; SuspiciousFile
    ClamAVDaemon --&gt; ProcessingError

    InfectedFile --&gt; QuarantineBucket
    SuspiciousFile --&gt; ThreatAnalysis
    QuarantineBucket --&gt; ManualReview
    ThreatAnalysis --&gt; AlertSystem</code></pre> <h3 id="virus-scanner-implementation">Virus Scanner Implementation<a class="headerlink" href="#virus-scanner-implementation" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyclamd</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aiofiles</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">ThreatLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">CLEAN</span> <span class="o">=</span> <span class="s2">"clean"</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">SUSPICIOUS</span> <span class="o">=</span> <span class="s2">"suspicious"</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">INFECTED</span> <span class="o">=</span> <span class="s2">"infected"</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">"error"</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="nd">@dataclass</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">"""Virus scan result"""</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">is_clean</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">threat_level</span><span class="p">:</span> <span class="n">ThreatLevel</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">threat_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">threat_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">scan_duration_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">scan_timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">scanner_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">virus_db_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">quarantine_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-31"><a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">additional_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-32"><a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>
</span><span id="__span-0-33"><a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-34"><a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-35"><a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-0-36"><a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-37"><a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-0-38"><a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>
</span><span id="__span-0-39"><a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="k">class</span><span class="w"> </span><span class="nc">VirusScanner</span><span class="p">:</span>
</span><span id="__span-0-40"><a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="sd">"""Advanced virus scanning with ClamAV integration"""</span>
</span><span id="__span-0-41"><a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>
</span><span id="__span-0-42"><a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-0-43"><a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="__span-0-44"><a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clamav_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"clamav_socket_path"</span><span class="p">,</span> <span class="s2">"/var/run/clamav/clamd.ctl"</span><span class="p">)</span>
</span><span id="__span-0-45"><a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clamav_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"clamav_host"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">)</span>
</span><span id="__span-0-46"><a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clamav_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"clamav_port"</span><span class="p">,</span> <span class="mi">3310</span><span class="p">)</span>
</span><span id="__span-0-47"><a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"max_scan_size"</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># 100MB</span>
</span><span id="__span-0-48"><a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scan_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"scan_timeout"</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 60 seconds</span>
</span><span id="__span-0-49"><a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>
</span><span id="__span-0-50"><a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="c1"># Educational-specific virus patterns</span>
</span><span id="__span-0-51"><a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">educational_threat_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_educational_threat_patterns</span><span class="p">()</span>
</span><span id="__span-0-52"><a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>
</span><span id="__span-0-53"><a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Initialize connection</span>
</span><span id="__span-0-54"><a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-55"><a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_clamav_connection</span><span class="p">()</span>
</span><span id="__span-0-56"><a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>
</span><span id="__span-0-57"><a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_clamav_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-58"><a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">        </span><span class="sd">"""Initialize ClamAV connection"""</span>
</span><span id="__span-0-59"><a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-60"><a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clamav_socket</span><span class="p">):</span>
</span><span id="__span-0-61"><a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="c1"># Unix socket connection</span>
</span><span id="__span-0-62"><a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span> <span class="o">=</span> <span class="n">pyclamd</span><span class="o">.</span><span class="n">ClamdUnixSocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clamav_socket</span><span class="p">)</span>
</span><span id="__span-0-63"><a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-64"><a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="c1"># TCP connection</span>
</span><span id="__span-0-65"><a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span> <span class="o">=</span> <span class="n">pyclamd</span><span class="o">.</span><span class="n">ClamdNetworkSocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clamav_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamav_port</span><span class="p">)</span>
</span><span id="__span-0-66"><a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a>
</span><span id="__span-0-67"><a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="c1"># Test connection</span>
</span><span id="__span-0-68"><a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span><span class="o">.</span><span class="n">ping</span><span class="p">():</span>
</span><span id="__span-0-69"><a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a>                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">"Cannot connect to ClamAV daemon"</span><span class="p">)</span>
</span><span id="__span-0-70"><a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>
</span><span id="__span-0-71"><a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"ClamAV connection established successfully"</span><span class="p">)</span>
</span><span id="__span-0-72"><a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a>
</span><span id="__span-0-73"><a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-74"><a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to initialize ClamAV connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-75"><a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-76"><a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a>
</span><span id="__span-0-77"><a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_educational_threat_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="__span-0-78"><a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">        </span><span class="sd">"""Load educational-specific threat patterns"""</span>
</span><span id="__span-0-79"><a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a>
</span><span id="__span-0-80"><a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-81"><a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="s2">"inappropriate_content"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-0-82"><a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="c1"># Patterns for detecting inappropriate content in educational files</span>
</span><span id="__span-0-83"><a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="sa">r</span><span class="s2">"(?i)\b(password|login|credential)s?\s*[:=]\s*\w+"</span><span class="p">,</span>
</span><span id="__span-0-84"><a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="sa">r</span><span class="s2">"(?i)\b(social\s*security|ssn)\s*[:=]\s*\d</span><span class="si">{3}</span><span class="s2">-?\d</span><span class="si">{2}</span><span class="s2">-?\d</span><span class="si">{4}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-0-85"><a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="sa">r</span><span class="s2">"(?i)\b(credit\s*card|cc)\s*[:=]\s*\d</span><span class="si">{4}</span><span class="s2">[-\s]?\d</span><span class="si">{4}</span><span class="s2">[-\s]?\d</span><span class="si">{4}</span><span class="s2">[-\s]?\d</span><span class="si">{4}</span><span class="s2">"</span>
</span><span id="__span-0-86"><a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="p">],</span>
</span><span id="__span-0-87"><a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="s2">"suspicious_scripts"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-0-88"><a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="sa">r</span><span class="s2">"&lt;script[^&gt;]*&gt;.*?&lt;/script&gt;"</span><span class="p">,</span>
</span><span id="__span-0-89"><a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="sa">r</span><span class="s2">"javascript\s*:"</span><span class="p">,</span>
</span><span id="__span-0-90"><a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="sa">r</span><span class="s2">"vbscript\s*:"</span><span class="p">,</span>
</span><span id="__span-0-91"><a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="sa">r</span><span class="s2">"eval\s*\("</span><span class="p">,</span>
</span><span id="__span-0-92"><a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="sa">r</span><span class="s2">"document\.write\s*\("</span>
</span><span id="__span-0-93"><a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="p">],</span>
</span><span id="__span-0-94"><a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="s2">"malicious_macros"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-0-95"><a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="sa">r</span><span class="s2">"Auto_Open\s*\("</span><span class="p">,</span>
</span><span id="__span-0-96"><a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="sa">r</span><span class="s2">"Document_Open\s*\("</span><span class="p">,</span>
</span><span id="__span-0-97"><a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="sa">r</span><span class="s2">"Shell\s*\("</span><span class="p">,</span>
</span><span id="__span-0-98"><a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="sa">r</span><span class="s2">"CreateObject\s*\("</span><span class="p">,</span>
</span><span id="__span-0-99"><a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="sa">r</span><span class="s2">"WScript\.Shell"</span>
</span><span id="__span-0-100"><a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="p">]</span>
</span><span id="__span-0-101"><a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="p">}</span>
</span><span id="__span-0-102"><a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a>
</span><span id="__span-0-103"><a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">scan_data</span><span class="p">(</span>
</span><span id="__span-0-104"><a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-105"><a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-0-106"><a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-107"><a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">scan_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-108"><a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-109"><a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="w">        </span><span class="sd">"""Scan file data for viruses and threats"""</span>
</span><span id="__span-0-110"><a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a>
</span><span id="__span-0-111"><a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span><span class="p">:</span>
</span><span id="__span-0-112"><a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-113"><a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-114"><a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="__span-0-115"><a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">threat_description</span><span class="o">=</span><span class="s2">"ClamAV daemon not available"</span>
</span><span id="__span-0-116"><a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="p">)</span>
</span><span id="__span-0-117"><a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a>
</span><span id="__span-0-118"><a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">scan_options</span> <span class="o">=</span> <span class="n">scan_options</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="__span-0-119"><a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-0-120"><a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a>
</span><span id="__span-0-121"><a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-122"><a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="c1"># File size check</span>
</span><span id="__span-0-123"><a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_file_size</span><span class="p">:</span>
</span><span id="__span-0-124"><a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-125"><a href="#__codelineno-0-125" id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-126"><a href="#__codelineno-0-126" id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="__span-0-127"><a href="#__codelineno-0-127" id="__codelineno-0-127" name="__codelineno-0-127"></a>                    <span class="n">threat_description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"File size (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum scan size"</span>
</span><span id="__span-0-128"><a href="#__codelineno-0-128" id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="p">)</span>
</span><span id="__span-0-129"><a href="#__codelineno-0-129" id="__codelineno-0-129" name="__codelineno-0-129"></a>
</span><span id="__span-0-130"><a href="#__codelineno-0-130" id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="c1"># Get file hash for logging</span>
</span><span id="__span-0-131"><a href="#__codelineno-0-131" id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">file_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-0-132"><a href="#__codelineno-0-132" id="__codelineno-0-132" name="__codelineno-0-132"></a>
</span><span id="__span-0-133"><a href="#__codelineno-0-133" id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># Perform virus scan</span>
</span><span id="__span-0-134"><a href="#__codelineno-0-134" id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">scan_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_clamav_scan</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-0-135"><a href="#__codelineno-0-135" id="__codelineno-0-135" name="__codelineno-0-135"></a>
</span><span id="__span-0-136"><a href="#__codelineno-0-136" id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="c1"># Additional educational content scanning</span>
</span><span id="__span-0-137"><a href="#__codelineno-0-137" id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="k">if</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">is_clean</span> <span class="ow">and</span> <span class="n">scan_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"deep_scan"</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="__span-0-138"><a href="#__codelineno-0-138" id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">educational_scan</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_educational_content</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-0-139"><a href="#__codelineno-0-139" id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">educational_scan</span><span class="o">.</span><span class="n">is_clean</span><span class="p">:</span>
</span><span id="__span-0-140"><a href="#__codelineno-0-140" id="__codelineno-0-140" name="__codelineno-0-140"></a>                    <span class="n">scan_result</span> <span class="o">=</span> <span class="n">educational_scan</span>
</span><span id="__span-0-141"><a href="#__codelineno-0-141" id="__codelineno-0-141" name="__codelineno-0-141"></a>
</span><span id="__span-0-142"><a href="#__codelineno-0-142" id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="c1"># Calculate scan duration</span>
</span><span id="__span-0-143"><a href="#__codelineno-0-143" id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">scan_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="__span-0-144"><a href="#__codelineno-0-144" id="__codelineno-0-144" name="__codelineno-0-144"></a>
</span><span id="__span-0-145"><a href="#__codelineno-0-145" id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="c1"># Update result with metadata</span>
</span><span id="__span-0-146"><a href="#__codelineno-0-146" id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">scan_result</span><span class="o">.</span><span class="n">scan_duration_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan_duration</span><span class="p">)</span>
</span><span id="__span-0-147"><a href="#__codelineno-0-147" id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">scan_result</span><span class="o">.</span><span class="n">scanner_version</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scanner_version</span><span class="p">()</span>
</span><span id="__span-0-148"><a href="#__codelineno-0-148" id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">scan_result</span><span class="o">.</span><span class="n">virus_db_version</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_virus_db_version</span><span class="p">()</span>
</span><span id="__span-0-149"><a href="#__codelineno-0-149" id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">scan_result</span><span class="o">.</span><span class="n">additional_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="__span-0-150"><a href="#__codelineno-0-150" id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="s2">"file_hash"</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">,</span>
</span><span id="__span-0-151"><a href="#__codelineno-0-151" id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="s2">"file_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">),</span>
</span><span id="__span-0-152"><a href="#__codelineno-0-152" id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="s2">"filename"</span><span class="p">:</span> <span class="n">filename</span>
</span><span id="__span-0-153"><a href="#__codelineno-0-153" id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="p">})</span>
</span><span id="__span-0-154"><a href="#__codelineno-0-154" id="__codelineno-0-154" name="__codelineno-0-154"></a>
</span><span id="__span-0-155"><a href="#__codelineno-0-155" id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="c1"># Log scan result</span>
</span><span id="__span-0-156"><a href="#__codelineno-0-156" id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_scan_result</span><span class="p">(</span><span class="n">scan_result</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_hash</span><span class="p">)</span>
</span><span id="__span-0-157"><a href="#__codelineno-0-157" id="__codelineno-0-157" name="__codelineno-0-157"></a>
</span><span id="__span-0-158"><a href="#__codelineno-0-158" id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="c1"># Handle infected files</span>
</span><span id="__span-0-159"><a href="#__codelineno-0-159" id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">is_clean</span> <span class="ow">and</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">threat_level</span> <span class="o">==</span> <span class="n">ThreatLevel</span><span class="o">.</span><span class="n">INFECTED</span><span class="p">:</span>
</span><span id="__span-0-160"><a href="#__codelineno-0-160" id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="n">quarantine_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarantine_file</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">scan_result</span><span class="p">)</span>
</span><span id="__span-0-161"><a href="#__codelineno-0-161" id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="n">scan_result</span><span class="o">.</span><span class="n">quarantine_id</span> <span class="o">=</span> <span class="n">quarantine_id</span>
</span><span id="__span-0-162"><a href="#__codelineno-0-162" id="__codelineno-0-162" name="__codelineno-0-162"></a>
</span><span id="__span-0-163"><a href="#__codelineno-0-163" id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="k">return</span> <span class="n">scan_result</span>
</span><span id="__span-0-164"><a href="#__codelineno-0-164" id="__codelineno-0-164" name="__codelineno-0-164"></a>
</span><span id="__span-0-165"><a href="#__codelineno-0-165" id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-166"><a href="#__codelineno-0-166" id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Virus scan failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-167"><a href="#__codelineno-0-167" id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-168"><a href="#__codelineno-0-168" id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-169"><a href="#__codelineno-0-169" id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="__span-0-170"><a href="#__codelineno-0-170" id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">threat_description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Scan error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-0-171"><a href="#__codelineno-0-171" id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">scan_duration_ms</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-0-172"><a href="#__codelineno-0-172" id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="p">)</span>
</span><span id="__span-0-173"><a href="#__codelineno-0-173" id="__codelineno-0-173" name="__codelineno-0-173"></a>
</span><span id="__span-0-174"><a href="#__codelineno-0-174" id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_perform_clamav_scan</span><span class="p">(</span>
</span><span id="__span-0-175"><a href="#__codelineno-0-175" id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-176"><a href="#__codelineno-0-176" id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-0-177"><a href="#__codelineno-0-177" id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-178"><a href="#__codelineno-0-178" id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-179"><a href="#__codelineno-0-179" id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="w">        </span><span class="sd">"""Perform ClamAV virus scan"""</span>
</span><span id="__span-0-180"><a href="#__codelineno-0-180" id="__codelineno-0-180" name="__codelineno-0-180"></a>
</span><span id="__span-0-181"><a href="#__codelineno-0-181" id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-182"><a href="#__codelineno-0-182" id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="c1"># Scan the data directly</span>
</span><span id="__span-0-183"><a href="#__codelineno-0-183" id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">scan_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span><span class="o">.</span><span class="n">scan_stream</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-184"><a href="#__codelineno-0-184" id="__codelineno-0-184" name="__codelineno-0-184"></a>
</span><span id="__span-0-185"><a href="#__codelineno-0-185" id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="k">if</span> <span class="n">scan_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-186"><a href="#__codelineno-0-186" id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="c1"># Clean file</span>
</span><span id="__span-0-187"><a href="#__codelineno-0-187" id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-188"><a href="#__codelineno-0-188" id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-189"><a href="#__codelineno-0-189" id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span>
</span><span id="__span-0-190"><a href="#__codelineno-0-190" id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="p">)</span>
</span><span id="__span-0-191"><a href="#__codelineno-0-191" id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-192"><a href="#__codelineno-0-192" id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="c1"># Infected file</span>
</span><span id="__span-0-193"><a href="#__codelineno-0-193" id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="n">threat_info</span> <span class="o">=</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"stream"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"UNKNOWN"</span><span class="p">,</span> <span class="s2">"Unknown threat"</span><span class="p">))</span>
</span><span id="__span-0-194"><a href="#__codelineno-0-194" id="__codelineno-0-194" name="__codelineno-0-194"></a>
</span><span id="__span-0-195"><a href="#__codelineno-0-195" id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-196"><a href="#__codelineno-0-196" id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-197"><a href="#__codelineno-0-197" id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">INFECTED</span><span class="p">,</span>
</span><span id="__span-0-198"><a href="#__codelineno-0-198" id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="n">threat_name</span><span class="o">=</span><span class="n">threat_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">"Unknown"</span><span class="p">,</span>
</span><span id="__span-0-199"><a href="#__codelineno-0-199" id="__codelineno-0-199" name="__codelineno-0-199"></a>                    <span class="n">threat_description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Virus detected: </span><span class="si">{</span><span class="n">threat_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">threat_info</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'Unknown threat'</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-200"><a href="#__codelineno-0-200" id="__codelineno-0-200" name="__codelineno-0-200"></a>                <span class="p">)</span>
</span><span id="__span-0-201"><a href="#__codelineno-0-201" id="__codelineno-0-201" name="__codelineno-0-201"></a>
</span><span id="__span-0-202"><a href="#__codelineno-0-202" id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-203"><a href="#__codelineno-0-203" id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ClamAV scan failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-204"><a href="#__codelineno-0-204" id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-205"><a href="#__codelineno-0-205" id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-206"><a href="#__codelineno-0-206" id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="__span-0-207"><a href="#__codelineno-0-207" id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">threat_description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"ClamAV scan error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-208"><a href="#__codelineno-0-208" id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="p">)</span>
</span><span id="__span-0-209"><a href="#__codelineno-0-209" id="__codelineno-0-209" name="__codelineno-0-209"></a>
</span><span id="__span-0-210"><a href="#__codelineno-0-210" id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_scan_educational_content</span><span class="p">(</span>
</span><span id="__span-0-211"><a href="#__codelineno-0-211" id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-212"><a href="#__codelineno-0-212" id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-0-213"><a href="#__codelineno-0-213" id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-214"><a href="#__codelineno-0-214" id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-215"><a href="#__codelineno-0-215" id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="w">        </span><span class="sd">"""Scan for educational-specific threats and inappropriate content"""</span>
</span><span id="__span-0-216"><a href="#__codelineno-0-216" id="__codelineno-0-216" name="__codelineno-0-216"></a>
</span><span id="__span-0-217"><a href="#__codelineno-0-217" id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-218"><a href="#__codelineno-0-218" id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># Convert to text for pattern matching</span>
</span><span id="__span-0-219"><a href="#__codelineno-0-219" id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_text_content</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-0-220"><a href="#__codelineno-0-220" id="__codelineno-0-220" name="__codelineno-0-220"></a>
</span><span id="__span-0-221"><a href="#__codelineno-0-221" id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="c1"># Check for inappropriate content patterns</span>
</span><span id="__span-0-222"><a href="#__codelineno-0-222" id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">educational_threat_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-0-223"><a href="#__codelineno-0-223" id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="__span-0-224"><a href="#__codelineno-0-224" id="__codelineno-0-224" name="__codelineno-0-224"></a>                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-0-225"><a href="#__codelineno-0-225" id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span>
</span><span id="__span-0-226"><a href="#__codelineno-0-226" id="__codelineno-0-226" name="__codelineno-0-226"></a>                        <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-227"><a href="#__codelineno-0-227" id="__codelineno-0-227" name="__codelineno-0-227"></a>                            <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-228"><a href="#__codelineno-0-228" id="__codelineno-0-228" name="__codelineno-0-228"></a>                            <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">SUSPICIOUS</span><span class="p">,</span>
</span><span id="__span-0-229"><a href="#__codelineno-0-229" id="__codelineno-0-229" name="__codelineno-0-229"></a>                            <span class="n">threat_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">"educational_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-0-230"><a href="#__codelineno-0-230" id="__codelineno-0-230" name="__codelineno-0-230"></a>                            <span class="n">threat_description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Suspicious </span><span class="si">{</span><span class="n">category</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span><span class="w"> </span><span class="s1">' '</span><span class="p">)</span><span class="si">}</span><span class="s2"> detected in educational content"</span>
</span><span id="__span-0-231"><a href="#__codelineno-0-231" id="__codelineno-0-231" name="__codelineno-0-231"></a>                        <span class="p">)</span>
</span><span id="__span-0-232"><a href="#__codelineno-0-232" id="__codelineno-0-232" name="__codelineno-0-232"></a>
</span><span id="__span-0-233"><a href="#__codelineno-0-233" id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="c1"># Check for embedded executables</span>
</span><span id="__span-0-234"><a href="#__codelineno-0-234" id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_embedded_executable</span><span class="p">(</span><span class="n">file_data</span><span class="p">):</span>
</span><span id="__span-0-235"><a href="#__codelineno-0-235" id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-236"><a href="#__codelineno-0-236" id="__codelineno-0-236" name="__codelineno-0-236"></a>                    <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-237"><a href="#__codelineno-0-237" id="__codelineno-0-237" name="__codelineno-0-237"></a>                    <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">SUSPICIOUS</span><span class="p">,</span>
</span><span id="__span-0-238"><a href="#__codelineno-0-238" id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="n">threat_name</span><span class="o">=</span><span class="s2">"embedded_executable"</span><span class="p">,</span>
</span><span id="__span-0-239"><a href="#__codelineno-0-239" id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="n">threat_description</span><span class="o">=</span><span class="s2">"File contains embedded executable content"</span>
</span><span id="__span-0-240"><a href="#__codelineno-0-240" id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="p">)</span>
</span><span id="__span-0-241"><a href="#__codelineno-0-241" id="__codelineno-0-241" name="__codelineno-0-241"></a>
</span><span id="__span-0-242"><a href="#__codelineno-0-242" id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="c1"># Check for suspicious metadata</span>
</span><span id="__span-0-243"><a href="#__codelineno-0-243" id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="n">metadata_scan</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_file_metadata</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="__span-0-244"><a href="#__codelineno-0-244" id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_scan</span><span class="o">.</span><span class="n">is_clean</span><span class="p">:</span>
</span><span id="__span-0-245"><a href="#__codelineno-0-245" id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="k">return</span> <span class="n">metadata_scan</span>
</span><span id="__span-0-246"><a href="#__codelineno-0-246" id="__codelineno-0-246" name="__codelineno-0-246"></a>
</span><span id="__span-0-247"><a href="#__codelineno-0-247" id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="c1"># All checks passed</span>
</span><span id="__span-0-248"><a href="#__codelineno-0-248" id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-249"><a href="#__codelineno-0-249" id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-250"><a href="#__codelineno-0-250" id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span>
</span><span id="__span-0-251"><a href="#__codelineno-0-251" id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="p">)</span>
</span><span id="__span-0-252"><a href="#__codelineno-0-252" id="__codelineno-0-252" name="__codelineno-0-252"></a>
</span><span id="__span-0-253"><a href="#__codelineno-0-253" id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-254"><a href="#__codelineno-0-254" id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Educational content scan failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-255"><a href="#__codelineno-0-255" id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="c1"># Don't fail the overall scan for educational content issues</span>
</span><span id="__span-0-256"><a href="#__codelineno-0-256" id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-257"><a href="#__codelineno-0-257" id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-258"><a href="#__codelineno-0-258" id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span>
</span><span id="__span-0-259"><a href="#__codelineno-0-259" id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="p">)</span>
</span><span id="__span-0-260"><a href="#__codelineno-0-260" id="__codelineno-0-260" name="__codelineno-0-260"></a>
</span><span id="__span-0-261"><a href="#__codelineno-0-261" id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_text_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-262"><a href="#__codelineno-0-262" id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="w">        </span><span class="sd">"""Extract text content from various file formats"""</span>
</span><span id="__span-0-263"><a href="#__codelineno-0-263" id="__codelineno-0-263" name="__codelineno-0-263"></a>
</span><span id="__span-0-264"><a href="#__codelineno-0-264" id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-265"><a href="#__codelineno-0-265" id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-0-266"><a href="#__codelineno-0-266" id="__codelineno-0-266" name="__codelineno-0-266"></a>
</span><span id="__span-0-267"><a href="#__codelineno-0-267" id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="k">if</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'.txt'</span><span class="p">,</span> <span class="s1">'.html'</span><span class="p">,</span> <span class="s1">'.xml'</span><span class="p">,</span> <span class="s1">'.json'</span><span class="p">,</span> <span class="s1">'.csv'</span><span class="p">]:</span>
</span><span id="__span-0-268"><a href="#__codelineno-0-268" id="__codelineno-0-268" name="__codelineno-0-268"></a>                <span class="c1"># Plain text files</span>
</span><span id="__span-0-269"><a href="#__codelineno-0-269" id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="k">return</span> <span class="n">file_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span>
</span><span id="__span-0-270"><a href="#__codelineno-0-270" id="__codelineno-0-270" name="__codelineno-0-270"></a>
</span><span id="__span-0-271"><a href="#__codelineno-0-271" id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">'.pdf'</span><span class="p">:</span>
</span><span id="__span-0-272"><a href="#__codelineno-0-272" id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="c1"># PDF text extraction</span>
</span><span id="__span-0-273"><a href="#__codelineno-0-273" id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_pdf_text</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-274"><a href="#__codelineno-0-274" id="__codelineno-0-274" name="__codelineno-0-274"></a>
</span><span id="__span-0-275"><a href="#__codelineno-0-275" id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">elif</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'.doc'</span><span class="p">,</span> <span class="s1">'.docx'</span><span class="p">]:</span>
</span><span id="__span-0-276"><a href="#__codelineno-0-276" id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="c1"># Word document text extraction</span>
</span><span id="__span-0-277"><a href="#__codelineno-0-277" id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_word_text</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-278"><a href="#__codelineno-0-278" id="__codelineno-0-278" name="__codelineno-0-278"></a>
</span><span id="__span-0-279"><a href="#__codelineno-0-279" id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">elif</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'.xls'</span><span class="p">,</span> <span class="s1">'.xlsx'</span><span class="p">]:</span>
</span><span id="__span-0-280"><a href="#__codelineno-0-280" id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="c1"># Excel text extraction</span>
</span><span id="__span-0-281"><a href="#__codelineno-0-281" id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_excel_text</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-282"><a href="#__codelineno-0-282" id="__codelineno-0-282" name="__codelineno-0-282"></a>
</span><span id="__span-0-283"><a href="#__codelineno-0-283" id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-284"><a href="#__codelineno-0-284" id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="c1"># Try to decode as text (for unknown formats)</span>
</span><span id="__span-0-285"><a href="#__codelineno-0-285" id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="k">return</span> <span class="n">file_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span>
</span><span id="__span-0-286"><a href="#__codelineno-0-286" id="__codelineno-0-286" name="__codelineno-0-286"></a>
</span><span id="__span-0-287"><a href="#__codelineno-0-287" id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-288"><a href="#__codelineno-0-288" id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Text extraction failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-289"><a href="#__codelineno-0-289" id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="k">return</span> <span class="s2">""</span>
</span><span id="__span-0-290"><a href="#__codelineno-0-290" id="__codelineno-0-290" name="__codelineno-0-290"></a>
</span><span id="__span-0-291"><a href="#__codelineno-0-291" id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_pdf_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-292"><a href="#__codelineno-0-292" id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="w">        </span><span class="sd">"""Extract text from PDF files"""</span>
</span><span id="__span-0-293"><a href="#__codelineno-0-293" id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-294"><a href="#__codelineno-0-294" id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">PyPDF2</span>
</span><span id="__span-0-295"><a href="#__codelineno-0-295" id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="__span-0-296"><a href="#__codelineno-0-296" id="__codelineno-0-296" name="__codelineno-0-296"></a>
</span><span id="__span-0-297"><a href="#__codelineno-0-297" id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">pdf_reader</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_data</span><span class="p">))</span>
</span><span id="__span-0-298"><a href="#__codelineno-0-298" id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">text_content</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-0-299"><a href="#__codelineno-0-299" id="__codelineno-0-299" name="__codelineno-0-299"></a>
</span><span id="__span-0-300"><a href="#__codelineno-0-300" id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">for</span> <span class="n">page_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdf_reader</span><span class="o">.</span><span class="n">pages</span><span class="p">)):</span>
</span><span id="__span-0-301"><a href="#__codelineno-0-301" id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="n">page</span> <span class="o">=</span> <span class="n">pdf_reader</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page_num</span><span class="p">]</span>
</span><span id="__span-0-302"><a href="#__codelineno-0-302" id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">text_content</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span>
</span><span id="__span-0-303"><a href="#__codelineno-0-303" id="__codelineno-0-303" name="__codelineno-0-303"></a>
</span><span id="__span-0-304"><a href="#__codelineno-0-304" id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="k">return</span> <span class="n">text_content</span>
</span><span id="__span-0-305"><a href="#__codelineno-0-305" id="__codelineno-0-305" name="__codelineno-0-305"></a>
</span><span id="__span-0-306"><a href="#__codelineno-0-306" id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-307"><a href="#__codelineno-0-307" id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"PDF text extraction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-308"><a href="#__codelineno-0-308" id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="k">return</span> <span class="s2">""</span>
</span><span id="__span-0-309"><a href="#__codelineno-0-309" id="__codelineno-0-309" name="__codelineno-0-309"></a>
</span><span id="__span-0-310"><a href="#__codelineno-0-310" id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_contains_embedded_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-0-311"><a href="#__codelineno-0-311" id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="w">        </span><span class="sd">"""Check for embedded executable content"""</span>
</span><span id="__span-0-312"><a href="#__codelineno-0-312" id="__codelineno-0-312" name="__codelineno-0-312"></a>
</span><span id="__span-0-313"><a href="#__codelineno-0-313" id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="c1"># Check for common executable signatures</span>
</span><span id="__span-0-314"><a href="#__codelineno-0-314" id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="n">executable_signatures</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-0-315"><a href="#__codelineno-0-315" id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="sa">b</span><span class="s1">'MZ'</span><span class="p">,</span>      <span class="c1"># PE executable</span>
</span><span id="__span-0-316"><a href="#__codelineno-0-316" id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="sa">b</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">ELF'</span><span class="p">,</span> <span class="c1"># ELF executable</span>
</span><span id="__span-0-317"><a href="#__codelineno-0-317" id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="sa">b</span><span class="s1">'</span><span class="se">\xfe\xed\xfa</span><span class="s1">'</span><span class="p">,</span> <span class="c1"># Mach-O executable</span>
</span><span id="__span-0-318"><a href="#__codelineno-0-318" id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="sa">b</span><span class="s1">'PK</span><span class="se">\x03\x04</span><span class="s1">'</span><span class="p">,</span>   <span class="c1"># ZIP file (potential executable)</span>
</span><span id="__span-0-319"><a href="#__codelineno-0-319" id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="p">]</span>
</span><span id="__span-0-320"><a href="#__codelineno-0-320" id="__codelineno-0-320" name="__codelineno-0-320"></a>
</span><span id="__span-0-321"><a href="#__codelineno-0-321" id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="k">for</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">executable_signatures</span><span class="p">:</span>
</span><span id="__span-0-322"><a href="#__codelineno-0-322" id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">:</span>
</span><span id="__span-0-323"><a href="#__codelineno-0-323" id="__codelineno-0-323" name="__codelineno-0-323"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-0-324"><a href="#__codelineno-0-324" id="__codelineno-0-324" name="__codelineno-0-324"></a>
</span><span id="__span-0-325"><a href="#__codelineno-0-325" id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-0-326"><a href="#__codelineno-0-326" id="__codelineno-0-326" name="__codelineno-0-326"></a>
</span><span id="__span-0-327"><a href="#__codelineno-0-327" id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_scan_file_metadata</span><span class="p">(</span>
</span><span id="__span-0-328"><a href="#__codelineno-0-328" id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-329"><a href="#__codelineno-0-329" id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-0-330"><a href="#__codelineno-0-330" id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-331"><a href="#__codelineno-0-331" id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-332"><a href="#__codelineno-0-332" id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="w">        </span><span class="sd">"""Scan file metadata for suspicious content"""</span>
</span><span id="__span-0-333"><a href="#__codelineno-0-333" id="__codelineno-0-333" name="__codelineno-0-333"></a>
</span><span id="__span-0-334"><a href="#__codelineno-0-334" id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-335"><a href="#__codelineno-0-335" id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-0-336"><a href="#__codelineno-0-336" id="__codelineno-0-336" name="__codelineno-0-336"></a>
</span><span id="__span-0-337"><a href="#__codelineno-0-337" id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="k">if</span> <span class="n">file_extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'.jpg'</span><span class="p">,</span> <span class="s1">'.jpeg'</span><span class="p">,</span> <span class="s1">'.png'</span><span class="p">,</span> <span class="s1">'.gif'</span><span class="p">,</span> <span class="s1">'.tiff'</span><span class="p">]:</span>
</span><span id="__span-0-338"><a href="#__codelineno-0-338" id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_image_metadata</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-339"><a href="#__codelineno-0-339" id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">'.pdf'</span><span class="p">:</span>
</span><span id="__span-0-340"><a href="#__codelineno-0-340" id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_pdf_metadata</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-341"><a href="#__codelineno-0-341" id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-342"><a href="#__codelineno-0-342" id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="c1"># No metadata scanning for this file type</span>
</span><span id="__span-0-343"><a href="#__codelineno-0-343" id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">)</span>
</span><span id="__span-0-344"><a href="#__codelineno-0-344" id="__codelineno-0-344" name="__codelineno-0-344"></a>
</span><span id="__span-0-345"><a href="#__codelineno-0-345" id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-346"><a href="#__codelineno-0-346" id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Metadata scan failed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-347"><a href="#__codelineno-0-347" id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">)</span>
</span><span id="__span-0-348"><a href="#__codelineno-0-348" id="__codelineno-0-348" name="__codelineno-0-348"></a>
</span><span id="__span-0-349"><a href="#__codelineno-0-349" id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_scan_image_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScanResult</span><span class="p">:</span>
</span><span id="__span-0-350"><a href="#__codelineno-0-350" id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="w">        </span><span class="sd">"""Scan image metadata for suspicious content"""</span>
</span><span id="__span-0-351"><a href="#__codelineno-0-351" id="__codelineno-0-351" name="__codelineno-0-351"></a>
</span><span id="__span-0-352"><a href="#__codelineno-0-352" id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-353"><a href="#__codelineno-0-353" id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
</span><span id="__span-0-354"><a href="#__codelineno-0-354" id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">PIL.ExifTags</span><span class="w"> </span><span class="kn">import</span> <span class="n">TAGS</span>
</span><span id="__span-0-355"><a href="#__codelineno-0-355" id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="__span-0-356"><a href="#__codelineno-0-356" id="__codelineno-0-356" name="__codelineno-0-356"></a>
</span><span id="__span-0-357"><a href="#__codelineno-0-357" id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_data</span><span class="p">))</span>
</span><span id="__span-0-358"><a href="#__codelineno-0-358" id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">exif_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_getexif</span><span class="p">()</span>
</span><span id="__span-0-359"><a href="#__codelineno-0-359" id="__codelineno-0-359" name="__codelineno-0-359"></a>
</span><span id="__span-0-360"><a href="#__codelineno-0-360" id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="k">if</span> <span class="n">exif_data</span><span class="p">:</span>
</span><span id="__span-0-361"><a href="#__codelineno-0-361" id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="k">for</span> <span class="n">tag_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exif_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-0-362"><a href="#__codelineno-0-362" id="__codelineno-0-362" name="__codelineno-0-362"></a>                    <span class="n">tag</span> <span class="o">=</span> <span class="n">TAGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag_id</span><span class="p">)</span>
</span><span id="__span-0-363"><a href="#__codelineno-0-363" id="__codelineno-0-363" name="__codelineno-0-363"></a>
</span><span id="__span-0-364"><a href="#__codelineno-0-364" id="__codelineno-0-364" name="__codelineno-0-364"></a>                    <span class="c1"># Check for suspicious metadata</span>
</span><span id="__span-0-365"><a href="#__codelineno-0-365" id="__codelineno-0-365" name="__codelineno-0-365"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-0-366"><a href="#__codelineno-0-366" id="__codelineno-0-366" name="__codelineno-0-366"></a>                        <span class="c1"># Look for script-like content in metadata</span>
</span><span id="__span-0-367"><a href="#__codelineno-0-367" id="__codelineno-0-367" name="__codelineno-0-367"></a>                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'&lt;script'</span><span class="p">,</span> <span class="s1">'javascript:'</span><span class="p">,</span> <span class="s1">'eval('</span><span class="p">]):</span>
</span><span id="__span-0-368"><a href="#__codelineno-0-368" id="__codelineno-0-368" name="__codelineno-0-368"></a>                            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-369"><a href="#__codelineno-0-369" id="__codelineno-0-369" name="__codelineno-0-369"></a>                                <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-370"><a href="#__codelineno-0-370" id="__codelineno-0-370" name="__codelineno-0-370"></a>                                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">SUSPICIOUS</span><span class="p">,</span>
</span><span id="__span-0-371"><a href="#__codelineno-0-371" id="__codelineno-0-371" name="__codelineno-0-371"></a>                                <span class="n">threat_name</span><span class="o">=</span><span class="s2">"suspicious_metadata"</span><span class="p">,</span>
</span><span id="__span-0-372"><a href="#__codelineno-0-372" id="__codelineno-0-372" name="__codelineno-0-372"></a>                                <span class="n">threat_description</span><span class="o">=</span><span class="s2">"Suspicious script content found in image metadata"</span>
</span><span id="__span-0-373"><a href="#__codelineno-0-373" id="__codelineno-0-373" name="__codelineno-0-373"></a>                            <span class="p">)</span>
</span><span id="__span-0-374"><a href="#__codelineno-0-374" id="__codelineno-0-374" name="__codelineno-0-374"></a>
</span><span id="__span-0-375"><a href="#__codelineno-0-375" id="__codelineno-0-375" name="__codelineno-0-375"></a>                        <span class="c1"># Check for excessively long metadata (potential data hiding)</span>
</span><span id="__span-0-376"><a href="#__codelineno-0-376" id="__codelineno-0-376" name="__codelineno-0-376"></a>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
</span><span id="__span-0-377"><a href="#__codelineno-0-377" id="__codelineno-0-377" name="__codelineno-0-377"></a>                            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span>
</span><span id="__span-0-378"><a href="#__codelineno-0-378" id="__codelineno-0-378" name="__codelineno-0-378"></a>                                <span class="n">is_clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-379"><a href="#__codelineno-0-379" id="__codelineno-0-379" name="__codelineno-0-379"></a>                                <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">SUSPICIOUS</span><span class="p">,</span>
</span><span id="__span-0-380"><a href="#__codelineno-0-380" id="__codelineno-0-380" name="__codelineno-0-380"></a>                                <span class="n">threat_name</span><span class="o">=</span><span class="s2">"excessive_metadata"</span><span class="p">,</span>
</span><span id="__span-0-381"><a href="#__codelineno-0-381" id="__codelineno-0-381" name="__codelineno-0-381"></a>                                <span class="n">threat_description</span><span class="o">=</span><span class="s2">"Unusually large metadata content detected"</span>
</span><span id="__span-0-382"><a href="#__codelineno-0-382" id="__codelineno-0-382" name="__codelineno-0-382"></a>                            <span class="p">)</span>
</span><span id="__span-0-383"><a href="#__codelineno-0-383" id="__codelineno-0-383" name="__codelineno-0-383"></a>
</span><span id="__span-0-384"><a href="#__codelineno-0-384" id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">)</span>
</span><span id="__span-0-385"><a href="#__codelineno-0-385" id="__codelineno-0-385" name="__codelineno-0-385"></a>
</span><span id="__span-0-386"><a href="#__codelineno-0-386" id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-0-387"><a href="#__codelineno-0-387" id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="c1"># If we can't read the metadata, assume it's clean</span>
</span><span id="__span-0-388"><a href="#__codelineno-0-388" id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="k">return</span> <span class="n">ScanResult</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threat_level</span><span class="o">=</span><span class="n">ThreatLevel</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">)</span>
</span><span id="__span-0-389"><a href="#__codelineno-0-389" id="__codelineno-0-389" name="__codelineno-0-389"></a>
</span><span id="__span-0-390"><a href="#__codelineno-0-390" id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_quarantine_file</span><span class="p">(</span>
</span><span id="__span-0-391"><a href="#__codelineno-0-391" id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-392"><a href="#__codelineno-0-392" id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-0-393"><a href="#__codelineno-0-393" id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-394"><a href="#__codelineno-0-394" id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">scan_result</span><span class="p">:</span> <span class="n">ScanResult</span>
</span><span id="__span-0-395"><a href="#__codelineno-0-395" id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-396"><a href="#__codelineno-0-396" id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="w">        </span><span class="sd">"""Quarantine infected file"""</span>
</span><span id="__span-0-397"><a href="#__codelineno-0-397" id="__codelineno-0-397" name="__codelineno-0-397"></a>
</span><span id="__span-0-398"><a href="#__codelineno-0-398" id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
</span><span id="__span-0-399"><a href="#__codelineno-0-399" id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">quarantine_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="__span-0-400"><a href="#__codelineno-0-400" id="__codelineno-0-400" name="__codelineno-0-400"></a>
</span><span id="__span-0-401"><a href="#__codelineno-0-401" id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-402"><a href="#__codelineno-0-402" id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="c1"># Store in quarantine bucket with metadata</span>
</span><span id="__span-0-403"><a href="#__codelineno-0-403" id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">quarantine_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-404"><a href="#__codelineno-0-404" id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="s2">"quarantine_id"</span><span class="p">:</span> <span class="n">quarantine_id</span><span class="p">,</span>
</span><span id="__span-0-405"><a href="#__codelineno-0-405" id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="s2">"original_filename"</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="__span-0-406"><a href="#__codelineno-0-406" id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="s2">"threat_name"</span><span class="p">:</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">threat_name</span><span class="p">,</span>
</span><span id="__span-0-407"><a href="#__codelineno-0-407" id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="s2">"threat_description"</span><span class="p">:</span> <span class="n">scan_result</span><span class="o">.</span><span class="n">threat_description</span><span class="p">,</span>
</span><span id="__span-0-408"><a href="#__codelineno-0-408" id="__codelineno-0-408" name="__codelineno-0-408"></a>                <span class="s2">"quarantine_timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-0-409"><a href="#__codelineno-0-409" id="__codelineno-0-409" name="__codelineno-0-409"></a>                <span class="s2">"file_hash"</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
</span><span id="__span-0-410"><a href="#__codelineno-0-410" id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="s2">"file_size"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-411"><a href="#__codelineno-0-411" id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="p">}</span>
</span><span id="__span-0-412"><a href="#__codelineno-0-412" id="__codelineno-0-412" name="__codelineno-0-412"></a>
</span><span id="__span-0-413"><a href="#__codelineno-0-413" id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="c1"># Store quarantine metadata</span>
</span><span id="__span-0-414"><a href="#__codelineno-0-414" id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_quarantine_metadata</span><span class="p">(</span><span class="n">quarantine_id</span><span class="p">,</span> <span class="n">quarantine_data</span><span class="p">)</span>
</span><span id="__span-0-415"><a href="#__codelineno-0-415" id="__codelineno-0-415" name="__codelineno-0-415"></a>
</span><span id="__span-0-416"><a href="#__codelineno-0-416" id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="c1"># Store file in secure quarantine storage</span>
</span><span id="__span-0-417"><a href="#__codelineno-0-417" id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_quarantine_file</span><span class="p">(</span><span class="n">quarantine_id</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-0-418"><a href="#__codelineno-0-418" id="__codelineno-0-418" name="__codelineno-0-418"></a>
</span><span id="__span-0-419"><a href="#__codelineno-0-419" id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="c1"># Send alert</span>
</span><span id="__span-0-420"><a href="#__codelineno-0-420" id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_security_alert</span><span class="p">(</span><span class="n">quarantine_data</span><span class="p">)</span>
</span><span id="__span-0-421"><a href="#__codelineno-0-421" id="__codelineno-0-421" name="__codelineno-0-421"></a>
</span><span id="__span-0-422"><a href="#__codelineno-0-422" id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File quarantined: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">quarantine_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-423"><a href="#__codelineno-0-423" id="__codelineno-0-423" name="__codelineno-0-423"></a>
</span><span id="__span-0-424"><a href="#__codelineno-0-424" id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="k">return</span> <span class="n">quarantine_id</span>
</span><span id="__span-0-425"><a href="#__codelineno-0-425" id="__codelineno-0-425" name="__codelineno-0-425"></a>
</span><span id="__span-0-426"><a href="#__codelineno-0-426" id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-427"><a href="#__codelineno-0-427" id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to quarantine file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-428"><a href="#__codelineno-0-428" id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="k">raise</span>
</span><span id="__span-0-429"><a href="#__codelineno-0-429" id="__codelineno-0-429" name="__codelineno-0-429"></a>
</span><span id="__span-0-430"><a href="#__codelineno-0-430" id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_scanner_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-431"><a href="#__codelineno-0-431" id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="w">        </span><span class="sd">"""Get ClamAV scanner version"""</span>
</span><span id="__span-0-432"><a href="#__codelineno-0-432" id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-433"><a href="#__codelineno-0-433" id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">version_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
</span><span id="__span-0-434"><a href="#__codelineno-0-434" id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="k">return</span> <span class="n">version_info</span>
</span><span id="__span-0-435"><a href="#__codelineno-0-435" id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="__span-0-436"><a href="#__codelineno-0-436" id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="k">return</span> <span class="s2">"Unknown"</span>
</span><span id="__span-0-437"><a href="#__codelineno-0-437" id="__codelineno-0-437" name="__codelineno-0-437"></a>
</span><span id="__span-0-438"><a href="#__codelineno-0-438" id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_virus_db_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-439"><a href="#__codelineno-0-439" id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="w">        </span><span class="sd">"""Get virus database version"""</span>
</span><span id="__span-0-440"><a href="#__codelineno-0-440" id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-441"><a href="#__codelineno-0-441" id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamd</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
</span><span id="__span-0-442"><a href="#__codelineno-0-442" id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="c1"># Parse version from stats</span>
</span><span id="__span-0-443"><a href="#__codelineno-0-443" id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">):</span>
</span><span id="__span-0-444"><a href="#__codelineno-0-444" id="__codelineno-0-444" name="__codelineno-0-444"></a>                <span class="k">if</span> <span class="s1">'Database version:'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="__span-0-445"><a href="#__codelineno-0-445" id="__codelineno-0-445" name="__codelineno-0-445"></a>                    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-0-446"><a href="#__codelineno-0-446" id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="k">return</span> <span class="s2">"Unknown"</span>
</span><span id="__span-0-447"><a href="#__codelineno-0-447" id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="__span-0-448"><a href="#__codelineno-0-448" id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="k">return</span> <span class="s2">"Unknown"</span>
</span><span id="__span-0-449"><a href="#__codelineno-0-449" id="__codelineno-0-449" name="__codelineno-0-449"></a>
</span><span id="__span-0-450"><a href="#__codelineno-0-450" id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_virus_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-0-451"><a href="#__codelineno-0-451" id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="w">        </span><span class="sd">"""Update virus database"""</span>
</span><span id="__span-0-452"><a href="#__codelineno-0-452" id="__codelineno-0-452" name="__codelineno-0-452"></a>
</span><span id="__span-0-453"><a href="#__codelineno-0-453" id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-0-454"><a href="#__codelineno-0-454" id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Starting virus database update"</span><span class="p">)</span>
</span><span id="__span-0-455"><a href="#__codelineno-0-455" id="__codelineno-0-455" name="__codelineno-0-455"></a>
</span><span id="__span-0-456"><a href="#__codelineno-0-456" id="__codelineno-0-456" name="__codelineno-0-456"></a>            <span class="c1"># This would typically be handled by freshclam</span>
</span><span id="__span-0-457"><a href="#__codelineno-0-457" id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="c1"># For now, we'll just check if an update is needed</span>
</span><span id="__span-0-458"><a href="#__codelineno-0-458" id="__codelineno-0-458" name="__codelineno-0-458"></a>
</span><span id="__span-0-459"><a href="#__codelineno-0-459" id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">current_version</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_virus_db_version</span><span class="p">()</span>
</span><span id="__span-0-460"><a href="#__codelineno-0-460" id="__codelineno-0-460" name="__codelineno-0-460"></a>
</span><span id="__span-0-461"><a href="#__codelineno-0-461" id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="c1"># In a real implementation, you would:</span>
</span><span id="__span-0-462"><a href="#__codelineno-0-462" id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="c1"># 1. Check for available updates</span>
</span><span id="__span-0-463"><a href="#__codelineno-0-463" id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="c1"># 2. Download new signatures</span>
</span><span id="__span-0-464"><a href="#__codelineno-0-464" id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="c1"># 3. Reload ClamAV daemon</span>
</span><span id="__span-0-465"><a href="#__codelineno-0-465" id="__codelineno-0-465" name="__codelineno-0-465"></a>
</span><span id="__span-0-466"><a href="#__codelineno-0-466" id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-467"><a href="#__codelineno-0-467" id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-468"><a href="#__codelineno-0-468" id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="s2">"current_version"</span><span class="p">:</span> <span class="n">current_version</span><span class="p">,</span>
</span><span id="__span-0-469"><a href="#__codelineno-0-469" id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="s2">"update_timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-0-470"><a href="#__codelineno-0-470" id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Virus database update completed"</span>
</span><span id="__span-0-471"><a href="#__codelineno-0-471" id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="p">}</span>
</span><span id="__span-0-472"><a href="#__codelineno-0-472" id="__codelineno-0-472" name="__codelineno-0-472"></a>
</span><span id="__span-0-473"><a href="#__codelineno-0-473" id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-0-474"><a href="#__codelineno-0-474" id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Virus database update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-475"><a href="#__codelineno-0-475" id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-476"><a href="#__codelineno-0-476" id="__codelineno-0-476" name="__codelineno-0-476"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-477"><a href="#__codelineno-0-477" id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-0-478"><a href="#__codelineno-0-478" id="__codelineno-0-478" name="__codelineno-0-478"></a>                <span class="s2">"update_timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-0-479"><a href="#__codelineno-0-479" id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="p">}</span>
</span><span id="__span-0-480"><a href="#__codelineno-0-480" id="__codelineno-0-480" name="__codelineno-0-480"></a>
</span><span id="__span-0-481"><a href="#__codelineno-0-481" id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_scan_statistics</span><span class="p">(</span>
</span><span id="__span-0-482"><a href="#__codelineno-0-482" id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-483"><a href="#__codelineno-0-483" id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-0-484"><a href="#__codelineno-0-484" id="__codelineno-0-484" name="__codelineno-0-484"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-0-485"><a href="#__codelineno-0-485" id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="w">        </span><span class="sd">"""Get virus scanning statistics"""</span>
</span><span id="__span-0-486"><a href="#__codelineno-0-486" id="__codelineno-0-486" name="__codelineno-0-486"></a>
</span><span id="__span-0-487"><a href="#__codelineno-0-487" id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="c1"># This would query your database for scan statistics</span>
</span><span id="__span-0-488"><a href="#__codelineno-0-488" id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="c1"># Example implementation:</span>
</span><span id="__span-0-489"><a href="#__codelineno-0-489" id="__codelineno-0-489" name="__codelineno-0-489"></a>
</span><span id="__span-0-490"><a href="#__codelineno-0-490" id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-491"><a href="#__codelineno-0-491" id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="s2">"period_days"</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
</span><span id="__span-0-492"><a href="#__codelineno-0-492" id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="s2">"total_scans"</span><span class="p">:</span> <span class="mi">15420</span><span class="p">,</span>
</span><span id="__span-0-493"><a href="#__codelineno-0-493" id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="s2">"clean_files"</span><span class="p">:</span> <span class="mi">15398</span><span class="p">,</span>
</span><span id="__span-0-494"><a href="#__codelineno-0-494" id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="s2">"infected_files"</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
</span><span id="__span-0-495"><a href="#__codelineno-0-495" id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="s2">"suspicious_files"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="__span-0-496"><a href="#__codelineno-0-496" id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="s2">"scan_errors"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-497"><a href="#__codelineno-0-497" id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="s2">"average_scan_time_ms"</span><span class="p">:</span> <span class="mi">245</span><span class="p">,</span>
</span><span id="__span-0-498"><a href="#__codelineno-0-498" id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="s2">"threat_breakdown"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-499"><a href="#__codelineno-0-499" id="__codelineno-0-499" name="__codelineno-0-499"></a>                <span class="s2">"malware"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span><span id="__span-0-500"><a href="#__codelineno-0-500" id="__codelineno-0-500" name="__codelineno-0-500"></a>                <span class="s2">"adware"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-0-501"><a href="#__codelineno-0-501" id="__codelineno-0-501" name="__codelineno-0-501"></a>                <span class="s2">"suspicious_script"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="__span-0-502"><a href="#__codelineno-0-502" id="__codelineno-0-502" name="__codelineno-0-502"></a>                <span class="s2">"educational_inappropriate"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-503"><a href="#__codelineno-0-503" id="__codelineno-0-503" name="__codelineno-0-503"></a>                <span class="s2">"embedded_executable"</span><span class="p">:</span> <span class="mi">4</span>
</span><span id="__span-0-504"><a href="#__codelineno-0-504" id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="p">},</span>
</span><span id="__span-0-505"><a href="#__codelineno-0-505" id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="s2">"quarantine_status"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-506"><a href="#__codelineno-0-506" id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="s2">"files_in_quarantine"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
</span><span id="__span-0-507"><a href="#__codelineno-0-507" id="__codelineno-0-507" name="__codelineno-0-507"></a>                <span class="s2">"manual_review_pending"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="__span-0-508"><a href="#__codelineno-0-508" id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="s2">"false_positives_identified"</span><span class="p">:</span> <span class="mi">3</span>
</span><span id="__span-0-509"><a href="#__codelineno-0-509" id="__codelineno-0-509" name="__codelineno-0-509"></a>            <span class="p">}</span>
</span><span id="__span-0-510"><a href="#__codelineno-0-510" id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="p">}</span>
</span></code></pre></div> <h2 id="coppaferpa-compliance-measures">COPPA/FERPA Compliance Measures<a class="headerlink" href="#coppaferpa-compliance-measures" title="Permanent link">¶</a></h2> <h3 id="compliance-framework-implementation">Compliance Framework Implementation<a class="headerlink" href="#compliance-framework-implementation" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ComplianceStandard</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="n">COPPA</span> <span class="o">=</span> <span class="s2">"coppa"</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="n">FERPA</span> <span class="o">=</span> <span class="s2">"ferpa"</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span class="n">GDPR</span> <span class="o">=</span> <span class="s2">"gdpr"</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="n">CCPA</span> <span class="o">=</span> <span class="s2">"ccpa"</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">DataCategory</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>    <span class="n">EDUCATIONAL_RECORD</span> <span class="o">=</span> <span class="s2">"educational_record"</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>    <span class="n">DIRECTORY_INFORMATION</span> <span class="o">=</span> <span class="s2">"directory_information"</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span class="n">PERSONAL_INFORMATION</span> <span class="o">=</span> <span class="s2">"personal_information"</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="n">BIOMETRIC_DATA</span> <span class="o">=</span> <span class="s2">"biometric_data"</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="n">HEALTH_INFORMATION</span> <span class="o">=</span> <span class="s2">"health_information"</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="nd">@dataclass</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">ComplianceRequirement</span><span class="p">:</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="sd">"""Individual compliance requirement"""</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>    <span class="n">standard</span><span class="p">:</span> <span class="n">ComplianceStandard</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>    <span class="n">requirement_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>    <span class="n">applies_to</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DataCategory</span><span class="p">]</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>    <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>    <span class="n">implementation_status</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>    <span class="n">verification_method</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="nd">@dataclass</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="k">class</span><span class="w"> </span><span class="nc">ComplianceResult</span><span class="p">:</span>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="sd">"""Result of compliance check"""</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>    <span class="n">is_compliant</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>    <span class="n">applicable_standards</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ComplianceStandard</span><span class="p">]</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>    <span class="n">requirements_met</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ComplianceRequirement</span><span class="p">]</span>
</span><span id="__span-1-37"><a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>    <span class="n">requirements_failed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ComplianceRequirement</span><span class="p">]</span>
</span><span id="__span-1-38"><a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>    <span class="n">recommendations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-1-39"><a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>    <span class="n">risk_level</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-40"><a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>    <span class="n">remediation_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-1-41"><a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>
</span><span id="__span-1-42"><a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="k">class</span><span class="w"> </span><span class="nc">EducationalComplianceManager</span><span class="p">:</span>
</span><span id="__span-1-43"><a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="sd">"""Manages educational compliance requirements"""</span>
</span><span id="__span-1-44"><a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>
</span><span id="__span-1-45"><a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-1-46"><a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compliance_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_compliance_requirements</span><span class="p">()</span>
</span><span id="__span-1-47"><a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">age_verification_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-48"><a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-49"><a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>
</span><span id="__span-1-50"><a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_compliance_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ComplianceStandard</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ComplianceRequirement</span><span class="p">]]:</span>
</span><span id="__span-1-51"><a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">        </span><span class="sd">"""Load compliance requirements for educational standards"""</span>
</span><span id="__span-1-52"><a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>
</span><span id="__span-1-53"><a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-54"><a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>            <span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-1-55"><a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-56"><a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">,</span>
</span><span id="__span-1-57"><a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"COPPA_001"</span><span class="p">,</span>
</span><span id="__span-1-58"><a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Parental consent required for children under 13"</span><span class="p">,</span>
</span><span id="__span-1-59"><a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">PERSONAL_INFORMATION</span><span class="p">],</span>
</span><span id="__span-1-60"><a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-61"><a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-62"><a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"parental_consent_verification"</span>
</span><span id="__span-1-63"><a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>                <span class="p">),</span>
</span><span id="__span-1-64"><a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-65"><a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">,</span>
</span><span id="__span-1-66"><a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"COPPA_002"</span><span class="p">,</span>
</span><span id="__span-1-67"><a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Data minimization for children's personal information"</span><span class="p">,</span>
</span><span id="__span-1-68"><a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">PERSONAL_INFORMATION</span><span class="p">,</span> <span class="n">DataCategory</span><span class="o">.</span><span class="n">EDUCATIONAL_RECORD</span><span class="p">],</span>
</span><span id="__span-1-69"><a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-70"><a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-71"><a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"data_collection_audit"</span>
</span><span id="__span-1-72"><a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>                <span class="p">),</span>
</span><span id="__span-1-73"><a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-74"><a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">,</span>
</span><span id="__span-1-75"><a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"COPPA_003"</span><span class="p">,</span>
</span><span id="__span-1-76"><a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Enhanced security for children's data"</span><span class="p">,</span>
</span><span id="__span-1-77"><a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">PERSONAL_INFORMATION</span><span class="p">],</span>
</span><span id="__span-1-78"><a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-79"><a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-80"><a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"security_assessment"</span>
</span><span id="__span-1-81"><a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>                <span class="p">),</span>
</span><span id="__span-1-82"><a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-83"><a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">,</span>
</span><span id="__span-1-84"><a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"COPPA_004"</span><span class="p">,</span>
</span><span id="__span-1-85"><a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Parental access and deletion rights"</span><span class="p">,</span>
</span><span id="__span-1-86"><a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">PERSONAL_INFORMATION</span><span class="p">,</span> <span class="n">DataCategory</span><span class="o">.</span><span class="n">EDUCATIONAL_RECORD</span><span class="p">],</span>
</span><span id="__span-1-87"><a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-88"><a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-89"><a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"parental_access_verification"</span>
</span><span id="__span-1-90"><a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>                <span class="p">)</span>
</span><span id="__span-1-91"><a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a>            <span class="p">],</span>
</span><span id="__span-1-92"><a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a>            <span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-1-93"><a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-94"><a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">,</span>
</span><span id="__span-1-95"><a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"FERPA_001"</span><span class="p">,</span>
</span><span id="__span-1-96"><a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Legitimate educational interest required for access"</span><span class="p">,</span>
</span><span id="__span-1-97"><a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">EDUCATIONAL_RECORD</span><span class="p">],</span>
</span><span id="__span-1-98"><a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-99"><a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-100"><a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"access_control_audit"</span>
</span><span id="__span-1-101"><a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>                <span class="p">),</span>
</span><span id="__span-1-102"><a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-103"><a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">,</span>
</span><span id="__span-1-104"><a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"FERPA_002"</span><span class="p">,</span>
</span><span id="__span-1-105"><a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Comprehensive audit trail for all access"</span><span class="p">,</span>
</span><span id="__span-1-106"><a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">EDUCATIONAL_RECORD</span><span class="p">],</span>
</span><span id="__span-1-107"><a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-108"><a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-109"><a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"audit_log_review"</span>
</span><span id="__span-1-110"><a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a>                <span class="p">),</span>
</span><span id="__span-1-111"><a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-112"><a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">,</span>
</span><span id="__span-1-113"><a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"FERPA_003"</span><span class="p">,</span>
</span><span id="__span-1-114"><a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Student/parent consent for non-directory disclosures"</span><span class="p">,</span>
</span><span id="__span-1-115"><a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">EDUCATIONAL_RECORD</span><span class="p">],</span>
</span><span id="__span-1-116"><a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-117"><a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-118"><a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"consent_verification"</span>
</span><span id="__span-1-119"><a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>                <span class="p">),</span>
</span><span id="__span-1-120"><a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>                <span class="n">ComplianceRequirement</span><span class="p">(</span>
</span><span id="__span-1-121"><a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>                    <span class="n">standard</span><span class="o">=</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">,</span>
</span><span id="__span-1-122"><a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a>                    <span class="n">requirement_id</span><span class="o">=</span><span class="s2">"FERPA_004"</span><span class="p">,</span>
</span><span id="__span-1-123"><a href="#__codelineno-1-123" id="__codelineno-1-123" name="__codelineno-1-123"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">"Directory information opt-out capability"</span><span class="p">,</span>
</span><span id="__span-1-124"><a href="#__codelineno-1-124" id="__codelineno-1-124" name="__codelineno-1-124"></a>                    <span class="n">applies_to</span><span class="o">=</span><span class="p">[</span><span class="n">DataCategory</span><span class="o">.</span><span class="n">DIRECTORY_INFORMATION</span><span class="p">],</span>
</span><span id="__span-1-125"><a href="#__codelineno-1-125" id="__codelineno-1-125" name="__codelineno-1-125"></a>                    <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-126"><a href="#__codelineno-1-126" id="__codelineno-1-126" name="__codelineno-1-126"></a>                    <span class="n">implementation_status</span><span class="o">=</span><span class="s2">"implemented"</span><span class="p">,</span>
</span><span id="__span-1-127"><a href="#__codelineno-1-127" id="__codelineno-1-127" name="__codelineno-1-127"></a>                    <span class="n">verification_method</span><span class="o">=</span><span class="s2">"opt_out_mechanism_test"</span>
</span><span id="__span-1-128"><a href="#__codelineno-1-128" id="__codelineno-1-128" name="__codelineno-1-128"></a>                <span class="p">)</span>
</span><span id="__span-1-129"><a href="#__codelineno-1-129" id="__codelineno-1-129" name="__codelineno-1-129"></a>            <span class="p">]</span>
</span><span id="__span-1-130"><a href="#__codelineno-1-130" id="__codelineno-1-130" name="__codelineno-1-130"></a>        <span class="p">}</span>
</span><span id="__span-1-131"><a href="#__codelineno-1-131" id="__codelineno-1-131" name="__codelineno-1-131"></a>
</span><span id="__span-1-132"><a href="#__codelineno-1-132" id="__codelineno-1-132" name="__codelineno-1-132"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_compliance</span><span class="p">(</span>
</span><span id="__span-1-133"><a href="#__codelineno-1-133" id="__codelineno-1-133" name="__codelineno-1-133"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-134"><a href="#__codelineno-1-134" id="__codelineno-1-134" name="__codelineno-1-134"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-1-135"><a href="#__codelineno-1-135" id="__codelineno-1-135" name="__codelineno-1-135"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-136"><a href="#__codelineno-1-136" id="__codelineno-1-136" name="__codelineno-1-136"></a>        <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-137"><a href="#__codelineno-1-137" id="__codelineno-1-137" name="__codelineno-1-137"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-138"><a href="#__codelineno-1-138" id="__codelineno-1-138" name="__codelineno-1-138"></a>        <span class="n">organization_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-1-139"><a href="#__codelineno-1-139" id="__codelineno-1-139" name="__codelineno-1-139"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComplianceResult</span><span class="p">:</span>
</span><span id="__span-1-140"><a href="#__codelineno-1-140" id="__codelineno-1-140" name="__codelineno-1-140"></a><span class="w">        </span><span class="sd">"""Comprehensive compliance check for file upload"""</span>
</span><span id="__span-1-141"><a href="#__codelineno-1-141" id="__codelineno-1-141" name="__codelineno-1-141"></a>
</span><span id="__span-1-142"><a href="#__codelineno-1-142" id="__codelineno-1-142" name="__codelineno-1-142"></a>        <span class="c1"># Determine applicable standards</span>
</span><span id="__span-1-143"><a href="#__codelineno-1-143" id="__codelineno-1-143" name="__codelineno-1-143"></a>        <span class="n">applicable_standards</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_applicable_standards</span><span class="p">(</span>
</span><span id="__span-1-144"><a href="#__codelineno-1-144" id="__codelineno-1-144" name="__codelineno-1-144"></a>            <span class="n">file_category</span><span class="p">,</span> <span class="n">user_context</span><span class="p">,</span> <span class="n">organization_context</span>
</span><span id="__span-1-145"><a href="#__codelineno-1-145" id="__codelineno-1-145" name="__codelineno-1-145"></a>        <span class="p">)</span>
</span><span id="__span-1-146"><a href="#__codelineno-1-146" id="__codelineno-1-146" name="__codelineno-1-146"></a>
</span><span id="__span-1-147"><a href="#__codelineno-1-147" id="__codelineno-1-147" name="__codelineno-1-147"></a>        <span class="c1"># Check each applicable standard</span>
</span><span id="__span-1-148"><a href="#__codelineno-1-148" id="__codelineno-1-148" name="__codelineno-1-148"></a>        <span class="n">requirements_met</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-149"><a href="#__codelineno-1-149" id="__codelineno-1-149" name="__codelineno-1-149"></a>        <span class="n">requirements_failed</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-150"><a href="#__codelineno-1-150" id="__codelineno-1-150" name="__codelineno-1-150"></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-151"><a href="#__codelineno-1-151" id="__codelineno-1-151" name="__codelineno-1-151"></a>
</span><span id="__span-1-152"><a href="#__codelineno-1-152" id="__codelineno-1-152" name="__codelineno-1-152"></a>        <span class="k">for</span> <span class="n">standard</span> <span class="ow">in</span> <span class="n">applicable_standards</span><span class="p">:</span>
</span><span id="__span-1-153"><a href="#__codelineno-1-153" id="__codelineno-1-153" name="__codelineno-1-153"></a>            <span class="n">standard_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compliance_requirements</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">standard</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-1-154"><a href="#__codelineno-1-154" id="__codelineno-1-154" name="__codelineno-1-154"></a>
</span><span id="__span-1-155"><a href="#__codelineno-1-155" id="__codelineno-1-155" name="__codelineno-1-155"></a>            <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">standard_requirements</span><span class="p">:</span>
</span><span id="__span-1-156"><a href="#__codelineno-1-156" id="__codelineno-1-156" name="__codelineno-1-156"></a>                <span class="n">compliance_check</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_individual_requirement</span><span class="p">(</span>
</span><span id="__span-1-157"><a href="#__codelineno-1-157" id="__codelineno-1-157" name="__codelineno-1-157"></a>                    <span class="n">requirement</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_category</span><span class="p">,</span> <span class="n">user_context</span><span class="p">,</span> <span class="n">organization_context</span>
</span><span id="__span-1-158"><a href="#__codelineno-1-158" id="__codelineno-1-158" name="__codelineno-1-158"></a>                <span class="p">)</span>
</span><span id="__span-1-159"><a href="#__codelineno-1-159" id="__codelineno-1-159" name="__codelineno-1-159"></a>
</span><span id="__span-1-160"><a href="#__codelineno-1-160" id="__codelineno-1-160" name="__codelineno-1-160"></a>                <span class="k">if</span> <span class="n">compliance_check</span><span class="p">[</span><span class="s2">"compliant"</span><span class="p">]:</span>
</span><span id="__span-1-161"><a href="#__codelineno-1-161" id="__codelineno-1-161" name="__codelineno-1-161"></a>                    <span class="n">requirements_met</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>
</span><span id="__span-1-162"><a href="#__codelineno-1-162" id="__codelineno-1-162" name="__codelineno-1-162"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-163"><a href="#__codelineno-1-163" id="__codelineno-1-163" name="__codelineno-1-163"></a>                    <span class="n">requirements_failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">requirement</span><span class="p">)</span>
</span><span id="__span-1-164"><a href="#__codelineno-1-164" id="__codelineno-1-164" name="__codelineno-1-164"></a>                    <span class="n">recommendations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">compliance_check</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"recommendations"</span><span class="p">,</span> <span class="p">[]))</span>
</span><span id="__span-1-165"><a href="#__codelineno-1-165" id="__codelineno-1-165" name="__codelineno-1-165"></a>
</span><span id="__span-1-166"><a href="#__codelineno-1-166" id="__codelineno-1-166" name="__codelineno-1-166"></a>        <span class="c1"># Determine overall compliance</span>
</span><span id="__span-1-167"><a href="#__codelineno-1-167" id="__codelineno-1-167" name="__codelineno-1-167"></a>        <span class="n">is_compliant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">requirements_failed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-1-168"><a href="#__codelineno-1-168" id="__codelineno-1-168" name="__codelineno-1-168"></a>        <span class="n">risk_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assess_risk_level</span><span class="p">(</span><span class="n">requirements_failed</span><span class="p">,</span> <span class="n">user_context</span><span class="p">)</span>
</span><span id="__span-1-169"><a href="#__codelineno-1-169" id="__codelineno-1-169" name="__codelineno-1-169"></a>
</span><span id="__span-1-170"><a href="#__codelineno-1-170" id="__codelineno-1-170" name="__codelineno-1-170"></a>        <span class="c1"># Generate remediation steps</span>
</span><span id="__span-1-171"><a href="#__codelineno-1-171" id="__codelineno-1-171" name="__codelineno-1-171"></a>        <span class="n">remediation_steps</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_remediation_steps</span><span class="p">(</span><span class="n">requirements_failed</span><span class="p">)</span>
</span><span id="__span-1-172"><a href="#__codelineno-1-172" id="__codelineno-1-172" name="__codelineno-1-172"></a>
</span><span id="__span-1-173"><a href="#__codelineno-1-173" id="__codelineno-1-173" name="__codelineno-1-173"></a>        <span class="k">return</span> <span class="n">ComplianceResult</span><span class="p">(</span>
</span><span id="__span-1-174"><a href="#__codelineno-1-174" id="__codelineno-1-174" name="__codelineno-1-174"></a>            <span class="n">is_compliant</span><span class="o">=</span><span class="n">is_compliant</span><span class="p">,</span>
</span><span id="__span-1-175"><a href="#__codelineno-1-175" id="__codelineno-1-175" name="__codelineno-1-175"></a>            <span class="n">applicable_standards</span><span class="o">=</span><span class="n">applicable_standards</span><span class="p">,</span>
</span><span id="__span-1-176"><a href="#__codelineno-1-176" id="__codelineno-1-176" name="__codelineno-1-176"></a>            <span class="n">requirements_met</span><span class="o">=</span><span class="n">requirements_met</span><span class="p">,</span>
</span><span id="__span-1-177"><a href="#__codelineno-1-177" id="__codelineno-1-177" name="__codelineno-1-177"></a>            <span class="n">requirements_failed</span><span class="o">=</span><span class="n">requirements_failed</span><span class="p">,</span>
</span><span id="__span-1-178"><a href="#__codelineno-1-178" id="__codelineno-1-178" name="__codelineno-1-178"></a>            <span class="n">recommendations</span><span class="o">=</span><span class="n">recommendations</span><span class="p">,</span>
</span><span id="__span-1-179"><a href="#__codelineno-1-179" id="__codelineno-1-179" name="__codelineno-1-179"></a>            <span class="n">risk_level</span><span class="o">=</span><span class="n">risk_level</span><span class="p">,</span>
</span><span id="__span-1-180"><a href="#__codelineno-1-180" id="__codelineno-1-180" name="__codelineno-1-180"></a>            <span class="n">remediation_steps</span><span class="o">=</span><span class="n">remediation_steps</span>
</span><span id="__span-1-181"><a href="#__codelineno-1-181" id="__codelineno-1-181" name="__codelineno-1-181"></a>        <span class="p">)</span>
</span><span id="__span-1-182"><a href="#__codelineno-1-182" id="__codelineno-1-182" name="__codelineno-1-182"></a>
</span><span id="__span-1-183"><a href="#__codelineno-1-183" id="__codelineno-1-183" name="__codelineno-1-183"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_determine_applicable_standards</span><span class="p">(</span>
</span><span id="__span-1-184"><a href="#__codelineno-1-184" id="__codelineno-1-184" name="__codelineno-1-184"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-185"><a href="#__codelineno-1-185" id="__codelineno-1-185" name="__codelineno-1-185"></a>        <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-186"><a href="#__codelineno-1-186" id="__codelineno-1-186" name="__codelineno-1-186"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-187"><a href="#__codelineno-1-187" id="__codelineno-1-187" name="__codelineno-1-187"></a>        <span class="n">organization_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-1-188"><a href="#__codelineno-1-188" id="__codelineno-1-188" name="__codelineno-1-188"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ComplianceStandard</span><span class="p">]:</span>
</span><span id="__span-1-189"><a href="#__codelineno-1-189" id="__codelineno-1-189" name="__codelineno-1-189"></a><span class="w">        </span><span class="sd">"""Determine which compliance standards apply"""</span>
</span><span id="__span-1-190"><a href="#__codelineno-1-190" id="__codelineno-1-190" name="__codelineno-1-190"></a>
</span><span id="__span-1-191"><a href="#__codelineno-1-191" id="__codelineno-1-191" name="__codelineno-1-191"></a>        <span class="n">applicable_standards</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-192"><a href="#__codelineno-1-192" id="__codelineno-1-192" name="__codelineno-1-192"></a>
</span><span id="__span-1-193"><a href="#__codelineno-1-193" id="__codelineno-1-193" name="__codelineno-1-193"></a>        <span class="c1"># COPPA applies if user is under 13</span>
</span><span id="__span-1-194"><a href="#__codelineno-1-194" id="__codelineno-1-194" name="__codelineno-1-194"></a>        <span class="n">user_age</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span>
</span><span id="__span-1-195"><a href="#__codelineno-1-195" id="__codelineno-1-195" name="__codelineno-1-195"></a>        <span class="n">is_child_user</span> <span class="o">=</span> <span class="n">user_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user_age</span> <span class="o">&lt;</span> <span class="mi">13</span>
</span><span id="__span-1-196"><a href="#__codelineno-1-196" id="__codelineno-1-196" name="__codelineno-1-196"></a>
</span><span id="__span-1-197"><a href="#__codelineno-1-197" id="__codelineno-1-197" name="__codelineno-1-197"></a>        <span class="k">if</span> <span class="n">is_child_user</span> <span class="ow">or</span> <span class="n">file_category</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"avatar"</span><span class="p">,</span> <span class="s2">"personal_information"</span><span class="p">]:</span>
</span><span id="__span-1-198"><a href="#__codelineno-1-198" id="__codelineno-1-198" name="__codelineno-1-198"></a>            <span class="n">applicable_standards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">COPPA</span><span class="p">)</span>
</span><span id="__span-1-199"><a href="#__codelineno-1-199" id="__codelineno-1-199" name="__codelineno-1-199"></a>
</span><span id="__span-1-200"><a href="#__codelineno-1-200" id="__codelineno-1-200" name="__codelineno-1-200"></a>        <span class="c1"># FERPA applies to educational records</span>
</span><span id="__span-1-201"><a href="#__codelineno-1-201" id="__codelineno-1-201" name="__codelineno-1-201"></a>        <span class="k">if</span> <span class="n">file_category</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"educational_record"</span><span class="p">,</span> <span class="s2">"student_submission"</span><span class="p">,</span> <span class="s2">"assessment"</span><span class="p">,</span> <span class="s2">"administrative"</span><span class="p">]:</span>
</span><span id="__span-1-202"><a href="#__codelineno-1-202" id="__codelineno-1-202" name="__codelineno-1-202"></a>            <span class="n">applicable_standards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">FERPA</span><span class="p">)</span>
</span><span id="__span-1-203"><a href="#__codelineno-1-203" id="__codelineno-1-203" name="__codelineno-1-203"></a>
</span><span id="__span-1-204"><a href="#__codelineno-1-204" id="__codelineno-1-204" name="__codelineno-1-204"></a>        <span class="c1"># Check organization location for GDPR/CCPA</span>
</span><span id="__span-1-205"><a href="#__codelineno-1-205" id="__codelineno-1-205" name="__codelineno-1-205"></a>        <span class="n">organization_location</span> <span class="o">=</span> <span class="n">organization_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"location"</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-1-206"><a href="#__codelineno-1-206" id="__codelineno-1-206" name="__codelineno-1-206"></a>        <span class="k">if</span> <span class="n">organization_location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"region"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"EU"</span><span class="p">:</span>
</span><span id="__span-1-207"><a href="#__codelineno-1-207" id="__codelineno-1-207" name="__codelineno-1-207"></a>            <span class="n">applicable_standards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">GDPR</span><span class="p">)</span>
</span><span id="__span-1-208"><a href="#__codelineno-1-208" id="__codelineno-1-208" name="__codelineno-1-208"></a>        <span class="k">elif</span> <span class="n">organization_location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"state"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"CA"</span><span class="p">:</span>
</span><span id="__span-1-209"><a href="#__codelineno-1-209" id="__codelineno-1-209" name="__codelineno-1-209"></a>            <span class="n">applicable_standards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ComplianceStandard</span><span class="o">.</span><span class="n">CCPA</span><span class="p">)</span>
</span><span id="__span-1-210"><a href="#__codelineno-1-210" id="__codelineno-1-210" name="__codelineno-1-210"></a>
</span><span id="__span-1-211"><a href="#__codelineno-1-211" id="__codelineno-1-211" name="__codelineno-1-211"></a>        <span class="k">return</span> <span class="n">applicable_standards</span>
</span><span id="__span-1-212"><a href="#__codelineno-1-212" id="__codelineno-1-212" name="__codelineno-1-212"></a>
</span><span id="__span-1-213"><a href="#__codelineno-1-213" id="__codelineno-1-213" name="__codelineno-1-213"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_individual_requirement</span><span class="p">(</span>
</span><span id="__span-1-214"><a href="#__codelineno-1-214" id="__codelineno-1-214" name="__codelineno-1-214"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-215"><a href="#__codelineno-1-215" id="__codelineno-1-215" name="__codelineno-1-215"></a>        <span class="n">requirement</span><span class="p">:</span> <span class="n">ComplianceRequirement</span><span class="p">,</span>
</span><span id="__span-1-216"><a href="#__codelineno-1-216" id="__codelineno-1-216" name="__codelineno-1-216"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-1-217"><a href="#__codelineno-1-217" id="__codelineno-1-217" name="__codelineno-1-217"></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-218"><a href="#__codelineno-1-218" id="__codelineno-1-218" name="__codelineno-1-218"></a>        <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-219"><a href="#__codelineno-1-219" id="__codelineno-1-219" name="__codelineno-1-219"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-220"><a href="#__codelineno-1-220" id="__codelineno-1-220" name="__codelineno-1-220"></a>        <span class="n">organization_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-1-221"><a href="#__codelineno-1-221" id="__codelineno-1-221" name="__codelineno-1-221"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-222"><a href="#__codelineno-1-222" id="__codelineno-1-222" name="__codelineno-1-222"></a><span class="w">        </span><span class="sd">"""Check individual compliance requirement"""</span>
</span><span id="__span-1-223"><a href="#__codelineno-1-223" id="__codelineno-1-223" name="__codelineno-1-223"></a>
</span><span id="__span-1-224"><a href="#__codelineno-1-224" id="__codelineno-1-224" name="__codelineno-1-224"></a>        <span class="k">if</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"COPPA_001"</span><span class="p">:</span>
</span><span id="__span-1-225"><a href="#__codelineno-1-225" id="__codelineno-1-225" name="__codelineno-1-225"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_parental_consent</span><span class="p">(</span><span class="n">user_context</span><span class="p">)</span>
</span><span id="__span-1-226"><a href="#__codelineno-1-226" id="__codelineno-1-226" name="__codelineno-1-226"></a>        <span class="k">elif</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"COPPA_002"</span><span class="p">:</span>
</span><span id="__span-1-227"><a href="#__codelineno-1-227" id="__codelineno-1-227" name="__codelineno-1-227"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_data_minimization</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">user_context</span><span class="p">)</span>
</span><span id="__span-1-228"><a href="#__codelineno-1-228" id="__codelineno-1-228" name="__codelineno-1-228"></a>        <span class="k">elif</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"COPPA_003"</span><span class="p">:</span>
</span><span id="__span-1-229"><a href="#__codelineno-1-229" id="__codelineno-1-229" name="__codelineno-1-229"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_enhanced_security</span><span class="p">(</span><span class="n">file_category</span><span class="p">,</span> <span class="n">user_context</span><span class="p">)</span>
</span><span id="__span-1-230"><a href="#__codelineno-1-230" id="__codelineno-1-230" name="__codelineno-1-230"></a>        <span class="k">elif</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"FERPA_001"</span><span class="p">:</span>
</span><span id="__span-1-231"><a href="#__codelineno-1-231" id="__codelineno-1-231" name="__codelineno-1-231"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_legitimate_educational_interest</span><span class="p">(</span><span class="n">user_context</span><span class="p">,</span> <span class="n">file_category</span><span class="p">)</span>
</span><span id="__span-1-232"><a href="#__codelineno-1-232" id="__codelineno-1-232" name="__codelineno-1-232"></a>        <span class="k">elif</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"FERPA_002"</span><span class="p">:</span>
</span><span id="__span-1-233"><a href="#__codelineno-1-233" id="__codelineno-1-233" name="__codelineno-1-233"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_audit_trail_capability</span><span class="p">()</span>
</span><span id="__span-1-234"><a href="#__codelineno-1-234" id="__codelineno-1-234" name="__codelineno-1-234"></a>        <span class="k">elif</span> <span class="n">requirement</span><span class="o">.</span><span class="n">requirement_id</span> <span class="o">==</span> <span class="s2">"FERPA_003"</span><span class="p">:</span>
</span><span id="__span-1-235"><a href="#__codelineno-1-235" id="__codelineno-1-235" name="__codelineno-1-235"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_disclosure_consent</span><span class="p">(</span><span class="n">user_context</span><span class="p">,</span> <span class="n">file_category</span><span class="p">)</span>
</span><span id="__span-1-236"><a href="#__codelineno-1-236" id="__codelineno-1-236" name="__codelineno-1-236"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-237"><a href="#__codelineno-1-237" id="__codelineno-1-237" name="__codelineno-1-237"></a>            <span class="c1"># Default compliance check</span>
</span><span id="__span-1-238"><a href="#__codelineno-1-238" id="__codelineno-1-238" name="__codelineno-1-238"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Default compliance"</span><span class="p">}</span>
</span><span id="__span-1-239"><a href="#__codelineno-1-239" id="__codelineno-1-239" name="__codelineno-1-239"></a>
</span><span id="__span-1-240"><a href="#__codelineno-1-240" id="__codelineno-1-240" name="__codelineno-1-240"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_parental_consent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-241"><a href="#__codelineno-1-241" id="__codelineno-1-241" name="__codelineno-1-241"></a><span class="w">        </span><span class="sd">"""Check COPPA parental consent requirement"""</span>
</span><span id="__span-1-242"><a href="#__codelineno-1-242" id="__codelineno-1-242" name="__codelineno-1-242"></a>
</span><span id="__span-1-243"><a href="#__codelineno-1-243" id="__codelineno-1-243" name="__codelineno-1-243"></a>        <span class="n">user_age</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span>
</span><span id="__span-1-244"><a href="#__codelineno-1-244" id="__codelineno-1-244" name="__codelineno-1-244"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>
</span><span id="__span-1-245"><a href="#__codelineno-1-245" id="__codelineno-1-245" name="__codelineno-1-245"></a>
</span><span id="__span-1-246"><a href="#__codelineno-1-246" id="__codelineno-1-246" name="__codelineno-1-246"></a>        <span class="k">if</span> <span class="n">user_age</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">user_age</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
</span><span id="__span-1-247"><a href="#__codelineno-1-247" id="__codelineno-1-247" name="__codelineno-1-247"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"User is 13 or older, COPPA consent not required"</span><span class="p">}</span>
</span><span id="__span-1-248"><a href="#__codelineno-1-248" id="__codelineno-1-248" name="__codelineno-1-248"></a>
</span><span id="__span-1-249"><a href="#__codelineno-1-249" id="__codelineno-1-249" name="__codelineno-1-249"></a>        <span class="c1"># Check if parental consent exists</span>
</span><span id="__span-1-250"><a href="#__codelineno-1-250" id="__codelineno-1-250" name="__codelineno-1-250"></a>        <span class="n">consent_record</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parental_consent_record</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="__span-1-251"><a href="#__codelineno-1-251" id="__codelineno-1-251" name="__codelineno-1-251"></a>
</span><span id="__span-1-252"><a href="#__codelineno-1-252" id="__codelineno-1-252" name="__codelineno-1-252"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">consent_record</span><span class="p">:</span>
</span><span id="__span-1-253"><a href="#__codelineno-1-253" id="__codelineno-1-253" name="__codelineno-1-253"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-254"><a href="#__codelineno-1-254" id="__codelineno-1-254" name="__codelineno-1-254"></a>                <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-255"><a href="#__codelineno-1-255" id="__codelineno-1-255" name="__codelineno-1-255"></a>                <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Parental consent required but not found"</span><span class="p">,</span>
</span><span id="__span-1-256"><a href="#__codelineno-1-256" id="__codelineno-1-256" name="__codelineno-1-256"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Obtain verifiable parental consent before processing data"</span><span class="p">]</span>
</span><span id="__span-1-257"><a href="#__codelineno-1-257" id="__codelineno-1-257" name="__codelineno-1-257"></a>            <span class="p">}</span>
</span><span id="__span-1-258"><a href="#__codelineno-1-258" id="__codelineno-1-258" name="__codelineno-1-258"></a>
</span><span id="__span-1-259"><a href="#__codelineno-1-259" id="__codelineno-1-259" name="__codelineno-1-259"></a>        <span class="c1"># Check if consent is valid and current</span>
</span><span id="__span-1-260"><a href="#__codelineno-1-260" id="__codelineno-1-260" name="__codelineno-1-260"></a>        <span class="k">if</span> <span class="n">consent_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"status"</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">"active"</span><span class="p">:</span>
</span><span id="__span-1-261"><a href="#__codelineno-1-261" id="__codelineno-1-261" name="__codelineno-1-261"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-262"><a href="#__codelineno-1-262" id="__codelineno-1-262" name="__codelineno-1-262"></a>                <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-263"><a href="#__codelineno-1-263" id="__codelineno-1-263" name="__codelineno-1-263"></a>                <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Parental consent exists but is not active"</span><span class="p">,</span>
</span><span id="__span-1-264"><a href="#__codelineno-1-264" id="__codelineno-1-264" name="__codelineno-1-264"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Renew parental consent"</span><span class="p">]</span>
</span><span id="__span-1-265"><a href="#__codelineno-1-265" id="__codelineno-1-265" name="__codelineno-1-265"></a>            <span class="p">}</span>
</span><span id="__span-1-266"><a href="#__codelineno-1-266" id="__codelineno-1-266" name="__codelineno-1-266"></a>
</span><span id="__span-1-267"><a href="#__codelineno-1-267" id="__codelineno-1-267" name="__codelineno-1-267"></a>        <span class="c1"># Check consent expiration</span>
</span><span id="__span-1-268"><a href="#__codelineno-1-268" id="__codelineno-1-268" name="__codelineno-1-268"></a>        <span class="n">consent_expiry</span> <span class="o">=</span> <span class="n">consent_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"expires_at"</span><span class="p">)</span>
</span><span id="__span-1-269"><a href="#__codelineno-1-269" id="__codelineno-1-269" name="__codelineno-1-269"></a>        <span class="k">if</span> <span class="n">consent_expiry</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">consent_expiry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">():</span>
</span><span id="__span-1-270"><a href="#__codelineno-1-270" id="__codelineno-1-270" name="__codelineno-1-270"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-271"><a href="#__codelineno-1-271" id="__codelineno-1-271" name="__codelineno-1-271"></a>                <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-272"><a href="#__codelineno-1-272" id="__codelineno-1-272" name="__codelineno-1-272"></a>                <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Parental consent has expired"</span><span class="p">,</span>
</span><span id="__span-1-273"><a href="#__codelineno-1-273" id="__codelineno-1-273" name="__codelineno-1-273"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Renew expired parental consent"</span><span class="p">]</span>
</span><span id="__span-1-274"><a href="#__codelineno-1-274" id="__codelineno-1-274" name="__codelineno-1-274"></a>            <span class="p">}</span>
</span><span id="__span-1-275"><a href="#__codelineno-1-275" id="__codelineno-1-275" name="__codelineno-1-275"></a>
</span><span id="__span-1-276"><a href="#__codelineno-1-276" id="__codelineno-1-276" name="__codelineno-1-276"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Valid parental consent found"</span><span class="p">}</span>
</span><span id="__span-1-277"><a href="#__codelineno-1-277" id="__codelineno-1-277" name="__codelineno-1-277"></a>
</span><span id="__span-1-278"><a href="#__codelineno-1-278" id="__codelineno-1-278" name="__codelineno-1-278"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_data_minimization</span><span class="p">(</span>
</span><span id="__span-1-279"><a href="#__codelineno-1-279" id="__codelineno-1-279" name="__codelineno-1-279"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-280"><a href="#__codelineno-1-280" id="__codelineno-1-280" name="__codelineno-1-280"></a>        <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="__span-1-281"><a href="#__codelineno-1-281" id="__codelineno-1-281" name="__codelineno-1-281"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-1-282"><a href="#__codelineno-1-282" id="__codelineno-1-282" name="__codelineno-1-282"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-283"><a href="#__codelineno-1-283" id="__codelineno-1-283" name="__codelineno-1-283"></a><span class="w">        </span><span class="sd">"""Check COPPA data minimization requirement"""</span>
</span><span id="__span-1-284"><a href="#__codelineno-1-284" id="__codelineno-1-284" name="__codelineno-1-284"></a>
</span><span id="__span-1-285"><a href="#__codelineno-1-285" id="__codelineno-1-285" name="__codelineno-1-285"></a>        <span class="n">user_age</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)</span>
</span><span id="__span-1-286"><a href="#__codelineno-1-286" id="__codelineno-1-286" name="__codelineno-1-286"></a>
</span><span id="__span-1-287"><a href="#__codelineno-1-287" id="__codelineno-1-287" name="__codelineno-1-287"></a>        <span class="k">if</span> <span class="n">user_age</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">user_age</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
</span><span id="__span-1-288"><a href="#__codelineno-1-288" id="__codelineno-1-288" name="__codelineno-1-288"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"User is 13 or older, COPPA minimization not required"</span><span class="p">}</span>
</span><span id="__span-1-289"><a href="#__codelineno-1-289" id="__codelineno-1-289" name="__codelineno-1-289"></a>
</span><span id="__span-1-290"><a href="#__codelineno-1-290" id="__codelineno-1-290" name="__codelineno-1-290"></a>        <span class="c1"># Check file size (data minimization principle)</span>
</span><span id="__span-1-291"><a href="#__codelineno-1-291" id="__codelineno-1-291" name="__codelineno-1-291"></a>        <span class="n">file_size_mb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span><span id="__span-1-292"><a href="#__codelineno-1-292" id="__codelineno-1-292" name="__codelineno-1-292"></a>        <span class="n">max_size_for_children</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 10MB limit for children's files</span>
</span><span id="__span-1-293"><a href="#__codelineno-1-293" id="__codelineno-1-293" name="__codelineno-1-293"></a>
</span><span id="__span-1-294"><a href="#__codelineno-1-294" id="__codelineno-1-294" name="__codelineno-1-294"></a>        <span class="k">if</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="n">max_size_for_children</span><span class="p">:</span>
</span><span id="__span-1-295"><a href="#__codelineno-1-295" id="__codelineno-1-295" name="__codelineno-1-295"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-296"><a href="#__codelineno-1-296" id="__codelineno-1-296" name="__codelineno-1-296"></a>                <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-297"><a href="#__codelineno-1-297" id="__codelineno-1-297" name="__codelineno-1-297"></a>                <span class="s2">"details"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"File size (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MB) exceeds COPPA minimization guidelines"</span><span class="p">,</span>
</span><span id="__span-1-298"><a href="#__codelineno-1-298" id="__codelineno-1-298" name="__codelineno-1-298"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Reduce file size or request specific parental permission for large files"</span><span class="p">]</span>
</span><span id="__span-1-299"><a href="#__codelineno-1-299" id="__codelineno-1-299" name="__codelineno-1-299"></a>            <span class="p">}</span>
</span><span id="__span-1-300"><a href="#__codelineno-1-300" id="__codelineno-1-300" name="__codelineno-1-300"></a>
</span><span id="__span-1-301"><a href="#__codelineno-1-301" id="__codelineno-1-301" name="__codelineno-1-301"></a>        <span class="c1"># Check for PII in file content (basic check)</span>
</span><span id="__span-1-302"><a href="#__codelineno-1-302" id="__codelineno-1-302" name="__codelineno-1-302"></a>        <span class="n">pii_detected</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_pii_in_content</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="__span-1-303"><a href="#__codelineno-1-303" id="__codelineno-1-303" name="__codelineno-1-303"></a>
</span><span id="__span-1-304"><a href="#__codelineno-1-304" id="__codelineno-1-304" name="__codelineno-1-304"></a>        <span class="k">if</span> <span class="n">pii_detected</span><span class="p">[</span><span class="s2">"has_sensitive_pii"</span><span class="p">]:</span>
</span><span id="__span-1-305"><a href="#__codelineno-1-305" id="__codelineno-1-305" name="__codelineno-1-305"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-306"><a href="#__codelineno-1-306" id="__codelineno-1-306" name="__codelineno-1-306"></a>                <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-307"><a href="#__codelineno-1-307" id="__codelineno-1-307" name="__codelineno-1-307"></a>                <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Sensitive PII detected in child's file"</span><span class="p">,</span>
</span><span id="__span-1-308"><a href="#__codelineno-1-308" id="__codelineno-1-308" name="__codelineno-1-308"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Remove sensitive PII or obtain specific parental consent"</span><span class="p">]</span>
</span><span id="__span-1-309"><a href="#__codelineno-1-309" id="__codelineno-1-309" name="__codelineno-1-309"></a>            <span class="p">}</span>
</span><span id="__span-1-310"><a href="#__codelineno-1-310" id="__codelineno-1-310" name="__codelineno-1-310"></a>
</span><span id="__span-1-311"><a href="#__codelineno-1-311" id="__codelineno-1-311" name="__codelineno-1-311"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Data minimization requirements met"</span><span class="p">}</span>
</span><span id="__span-1-312"><a href="#__codelineno-1-312" id="__codelineno-1-312" name="__codelineno-1-312"></a>
</span><span id="__span-1-313"><a href="#__codelineno-1-313" id="__codelineno-1-313" name="__codelineno-1-313"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_legitimate_educational_interest</span><span class="p">(</span>
</span><span id="__span-1-314"><a href="#__codelineno-1-314" id="__codelineno-1-314" name="__codelineno-1-314"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-315"><a href="#__codelineno-1-315" id="__codelineno-1-315" name="__codelineno-1-315"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-316"><a href="#__codelineno-1-316" id="__codelineno-1-316" name="__codelineno-1-316"></a>        <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-317"><a href="#__codelineno-1-317" id="__codelineno-1-317" name="__codelineno-1-317"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-318"><a href="#__codelineno-1-318" id="__codelineno-1-318" name="__codelineno-1-318"></a><span class="w">        </span><span class="sd">"""Check FERPA legitimate educational interest requirement"""</span>
</span><span id="__span-1-319"><a href="#__codelineno-1-319" id="__codelineno-1-319" name="__codelineno-1-319"></a>
</span><span id="__span-1-320"><a href="#__codelineno-1-320" id="__codelineno-1-320" name="__codelineno-1-320"></a>        <span class="n">user_role</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"role"</span><span class="p">)</span>
</span><span id="__span-1-321"><a href="#__codelineno-1-321" id="__codelineno-1-321" name="__codelineno-1-321"></a>        <span class="n">requesting_user_id</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>
</span><span id="__span-1-322"><a href="#__codelineno-1-322" id="__codelineno-1-322" name="__codelineno-1-322"></a>        <span class="n">target_student_id</span> <span class="o">=</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"target_student_id"</span><span class="p">)</span>
</span><span id="__span-1-323"><a href="#__codelineno-1-323" id="__codelineno-1-323" name="__codelineno-1-323"></a>
</span><span id="__span-1-324"><a href="#__codelineno-1-324" id="__codelineno-1-324" name="__codelineno-1-324"></a>        <span class="c1"># Admin always has legitimate interest</span>
</span><span id="__span-1-325"><a href="#__codelineno-1-325" id="__codelineno-1-325" name="__codelineno-1-325"></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">:</span>
</span><span id="__span-1-326"><a href="#__codelineno-1-326" id="__codelineno-1-326" name="__codelineno-1-326"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Administrator access granted"</span><span class="p">}</span>
</span><span id="__span-1-327"><a href="#__codelineno-1-327" id="__codelineno-1-327" name="__codelineno-1-327"></a>
</span><span id="__span-1-328"><a href="#__codelineno-1-328" id="__codelineno-1-328" name="__codelineno-1-328"></a>        <span class="c1"># Teachers have legitimate interest in their students' records</span>
</span><span id="__span-1-329"><a href="#__codelineno-1-329" id="__codelineno-1-329" name="__codelineno-1-329"></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s2">"teacher"</span><span class="p">:</span>
</span><span id="__span-1-330"><a href="#__codelineno-1-330" id="__codelineno-1-330" name="__codelineno-1-330"></a>            <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_has_student_relationship</span><span class="p">(</span><span class="n">requesting_user_id</span><span class="p">,</span> <span class="n">target_student_id</span><span class="p">):</span>
</span><span id="__span-1-331"><a href="#__codelineno-1-331" id="__codelineno-1-331" name="__codelineno-1-331"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Teacher has legitimate educational interest"</span><span class="p">}</span>
</span><span id="__span-1-332"><a href="#__codelineno-1-332" id="__codelineno-1-332" name="__codelineno-1-332"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-333"><a href="#__codelineno-1-333" id="__codelineno-1-333" name="__codelineno-1-333"></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-334"><a href="#__codelineno-1-334" id="__codelineno-1-334" name="__codelineno-1-334"></a>                    <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-335"><a href="#__codelineno-1-335" id="__codelineno-1-335" name="__codelineno-1-335"></a>                    <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Teacher does not have legitimate educational interest in this student"</span><span class="p">,</span>
</span><span id="__span-1-336"><a href="#__codelineno-1-336" id="__codelineno-1-336" name="__codelineno-1-336"></a>                    <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Verify teacher-student relationship or obtain explicit consent"</span><span class="p">]</span>
</span><span id="__span-1-337"><a href="#__codelineno-1-337" id="__codelineno-1-337" name="__codelineno-1-337"></a>                <span class="p">}</span>
</span><span id="__span-1-338"><a href="#__codelineno-1-338" id="__codelineno-1-338" name="__codelineno-1-338"></a>
</span><span id="__span-1-339"><a href="#__codelineno-1-339" id="__codelineno-1-339" name="__codelineno-1-339"></a>        <span class="c1"># Students can access their own records</span>
</span><span id="__span-1-340"><a href="#__codelineno-1-340" id="__codelineno-1-340" name="__codelineno-1-340"></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="s2">"student"</span> <span class="ow">and</span> <span class="n">requesting_user_id</span> <span class="o">==</span> <span class="n">target_student_id</span><span class="p">:</span>
</span><span id="__span-1-341"><a href="#__codelineno-1-341" id="__codelineno-1-341" name="__codelineno-1-341"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"Student accessing own educational record"</span><span class="p">}</span>
</span><span id="__span-1-342"><a href="#__codelineno-1-342" id="__codelineno-1-342" name="__codelineno-1-342"></a>
</span><span id="__span-1-343"><a href="#__codelineno-1-343" id="__codelineno-1-343" name="__codelineno-1-343"></a>        <span class="c1"># Default deny</span>
</span><span id="__span-1-344"><a href="#__codelineno-1-344" id="__codelineno-1-344" name="__codelineno-1-344"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-345"><a href="#__codelineno-1-345" id="__codelineno-1-345" name="__codelineno-1-345"></a>            <span class="s2">"compliant"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-346"><a href="#__codelineno-1-346" id="__codelineno-1-346" name="__codelineno-1-346"></a>            <span class="s2">"details"</span><span class="p">:</span> <span class="s2">"No legitimate educational interest established"</span><span class="p">,</span>
</span><span id="__span-1-347"><a href="#__codelineno-1-347" id="__codelineno-1-347" name="__codelineno-1-347"></a>            <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Establish legitimate educational interest or obtain consent"</span><span class="p">]</span>
</span><span id="__span-1-348"><a href="#__codelineno-1-348" id="__codelineno-1-348" name="__codelineno-1-348"></a>        <span class="p">}</span>
</span><span id="__span-1-349"><a href="#__codelineno-1-349" id="__codelineno-1-349" name="__codelineno-1-349"></a>
</span><span id="__span-1-350"><a href="#__codelineno-1-350" id="__codelineno-1-350" name="__codelineno-1-350"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provided_age</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-351"><a href="#__codelineno-1-351" id="__codelineno-1-351" name="__codelineno-1-351"></a><span class="w">        </span><span class="sd">"""Verify user age for COPPA compliance"""</span>
</span><span id="__span-1-352"><a href="#__codelineno-1-352" id="__codelineno-1-352" name="__codelineno-1-352"></a>
</span><span id="__span-1-353"><a href="#__codelineno-1-353" id="__codelineno-1-353" name="__codelineno-1-353"></a>        <span class="c1"># In a real implementation, this would use more sophisticated age verification</span>
</span><span id="__span-1-354"><a href="#__codelineno-1-354" id="__codelineno-1-354" name="__codelineno-1-354"></a>        <span class="c1"># For now, we'll implement basic checks</span>
</span><span id="__span-1-355"><a href="#__codelineno-1-355" id="__codelineno-1-355" name="__codelineno-1-355"></a>
</span><span id="__span-1-356"><a href="#__codelineno-1-356" id="__codelineno-1-356" name="__codelineno-1-356"></a>        <span class="n">verification_result</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-357"><a href="#__codelineno-1-357" id="__codelineno-1-357" name="__codelineno-1-357"></a>            <span class="s2">"verified"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-358"><a href="#__codelineno-1-358" id="__codelineno-1-358" name="__codelineno-1-358"></a>            <span class="s2">"confidence_level"</span><span class="p">:</span> <span class="s2">"low"</span><span class="p">,</span>
</span><span id="__span-1-359"><a href="#__codelineno-1-359" id="__codelineno-1-359" name="__codelineno-1-359"></a>            <span class="s2">"verification_method"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-1-360"><a href="#__codelineno-1-360" id="__codelineno-1-360" name="__codelineno-1-360"></a>            <span class="s2">"requires_parental_verification"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-361"><a href="#__codelineno-1-361" id="__codelineno-1-361" name="__codelineno-1-361"></a>            <span class="s2">"recommendations"</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="__span-1-362"><a href="#__codelineno-1-362" id="__codelineno-1-362" name="__codelineno-1-362"></a>        <span class="p">}</span>
</span><span id="__span-1-363"><a href="#__codelineno-1-363" id="__codelineno-1-363" name="__codelineno-1-363"></a>
</span><span id="__span-1-364"><a href="#__codelineno-1-364" id="__codelineno-1-364" name="__codelineno-1-364"></a>        <span class="c1"># Check if age seems reasonable</span>
</span><span id="__span-1-365"><a href="#__codelineno-1-365" id="__codelineno-1-365" name="__codelineno-1-365"></a>        <span class="k">if</span> <span class="n">provided_age</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">provided_age</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="__span-1-366"><a href="#__codelineno-1-366" id="__codelineno-1-366" name="__codelineno-1-366"></a>            <span class="n">verification_result</span><span class="p">[</span><span class="s2">"recommendations"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Age seems unrealistic, manual verification required"</span><span class="p">)</span>
</span><span id="__span-1-367"><a href="#__codelineno-1-367" id="__codelineno-1-367" name="__codelineno-1-367"></a>            <span class="k">return</span> <span class="n">verification_result</span>
</span><span id="__span-1-368"><a href="#__codelineno-1-368" id="__codelineno-1-368" name="__codelineno-1-368"></a>
</span><span id="__span-1-369"><a href="#__codelineno-1-369" id="__codelineno-1-369" name="__codelineno-1-369"></a>        <span class="c1"># For children under 13, require parental verification</span>
</span><span id="__span-1-370"><a href="#__codelineno-1-370" id="__codelineno-1-370" name="__codelineno-1-370"></a>        <span class="k">if</span> <span class="n">provided_age</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
</span><span id="__span-1-371"><a href="#__codelineno-1-371" id="__codelineno-1-371" name="__codelineno-1-371"></a>            <span class="n">verification_result</span><span class="p">[</span><span class="s2">"requires_parental_verification"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-1-372"><a href="#__codelineno-1-372" id="__codelineno-1-372" name="__codelineno-1-372"></a>            <span class="n">verification_result</span><span class="p">[</span><span class="s2">"recommendations"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"COPPA requires parental consent for users under 13"</span><span class="p">)</span>
</span><span id="__span-1-373"><a href="#__codelineno-1-373" id="__codelineno-1-373" name="__codelineno-1-373"></a>
</span><span id="__span-1-374"><a href="#__codelineno-1-374" id="__codelineno-1-374" name="__codelineno-1-374"></a>        <span class="c1"># For users 13-17, implement additional protections</span>
</span><span id="__span-1-375"><a href="#__codelineno-1-375" id="__codelineno-1-375" name="__codelineno-1-375"></a>        <span class="k">if</span> <span class="mi">13</span> <span class="o">&lt;=</span> <span class="n">provided_age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
</span><span id="__span-1-376"><a href="#__codelineno-1-376" id="__codelineno-1-376" name="__codelineno-1-376"></a>            <span class="n">verification_result</span><span class="p">[</span><span class="s2">"recommendations"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Enhanced privacy protections for minor users"</span><span class="p">)</span>
</span><span id="__span-1-377"><a href="#__codelineno-1-377" id="__codelineno-1-377" name="__codelineno-1-377"></a>
</span><span id="__span-1-378"><a href="#__codelineno-1-378" id="__codelineno-1-378" name="__codelineno-1-378"></a>        <span class="c1"># In a production system, you might:</span>
</span><span id="__span-1-379"><a href="#__codelineno-1-379" id="__codelineno-1-379" name="__codelineno-1-379"></a>        <span class="c1"># 1. Cross-reference with school enrollment data</span>
</span><span id="__span-1-380"><a href="#__codelineno-1-380" id="__codelineno-1-380" name="__codelineno-1-380"></a>        <span class="c1"># 2. Use identity verification services</span>
</span><span id="__span-1-381"><a href="#__codelineno-1-381" id="__codelineno-1-381" name="__codelineno-1-381"></a>        <span class="c1"># 3. Implement additional verification steps</span>
</span><span id="__span-1-382"><a href="#__codelineno-1-382" id="__codelineno-1-382" name="__codelineno-1-382"></a>
</span><span id="__span-1-383"><a href="#__codelineno-1-383" id="__codelineno-1-383" name="__codelineno-1-383"></a>        <span class="n">verification_result</span><span class="p">[</span><span class="s2">"verified"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-1-384"><a href="#__codelineno-1-384" id="__codelineno-1-384" name="__codelineno-1-384"></a>        <span class="n">verification_result</span><span class="p">[</span><span class="s2">"confidence_level"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"medium"</span>
</span><span id="__span-1-385"><a href="#__codelineno-1-385" id="__codelineno-1-385" name="__codelineno-1-385"></a>        <span class="n">verification_result</span><span class="p">[</span><span class="s2">"verification_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"self_reported"</span>
</span><span id="__span-1-386"><a href="#__codelineno-1-386" id="__codelineno-1-386" name="__codelineno-1-386"></a>
</span><span id="__span-1-387"><a href="#__codelineno-1-387" id="__codelineno-1-387" name="__codelineno-1-387"></a>        <span class="k">return</span> <span class="n">verification_result</span>
</span><span id="__span-1-388"><a href="#__codelineno-1-388" id="__codelineno-1-388" name="__codelineno-1-388"></a>
</span><span id="__span-1-389"><a href="#__codelineno-1-389" id="__codelineno-1-389" name="__codelineno-1-389"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">manage_parental_consent</span><span class="p">(</span>
</span><span id="__span-1-390"><a href="#__codelineno-1-390" id="__codelineno-1-390" name="__codelineno-1-390"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-391"><a href="#__codelineno-1-391" id="__codelineno-1-391" name="__codelineno-1-391"></a>        <span class="n">student_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-392"><a href="#__codelineno-1-392" id="__codelineno-1-392" name="__codelineno-1-392"></a>        <span class="n">parent_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-393"><a href="#__codelineno-1-393" id="__codelineno-1-393" name="__codelineno-1-393"></a>        <span class="n">consent_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"general"</span>
</span><span id="__span-1-394"><a href="#__codelineno-1-394" id="__codelineno-1-394" name="__codelineno-1-394"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-395"><a href="#__codelineno-1-395" id="__codelineno-1-395" name="__codelineno-1-395"></a><span class="w">        </span><span class="sd">"""Manage parental consent process"""</span>
</span><span id="__span-1-396"><a href="#__codelineno-1-396" id="__codelineno-1-396" name="__codelineno-1-396"></a>
</span><span id="__span-1-397"><a href="#__codelineno-1-397" id="__codelineno-1-397" name="__codelineno-1-397"></a>        <span class="n">consent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"consent_</span><span class="si">{</span><span class="n">student_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-1-398"><a href="#__codelineno-1-398" id="__codelineno-1-398" name="__codelineno-1-398"></a>
</span><span id="__span-1-399"><a href="#__codelineno-1-399" id="__codelineno-1-399" name="__codelineno-1-399"></a>        <span class="n">consent_record</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-400"><a href="#__codelineno-1-400" id="__codelineno-1-400" name="__codelineno-1-400"></a>            <span class="s2">"consent_id"</span><span class="p">:</span> <span class="n">consent_id</span><span class="p">,</span>
</span><span id="__span-1-401"><a href="#__codelineno-1-401" id="__codelineno-1-401" name="__codelineno-1-401"></a>            <span class="s2">"student_id"</span><span class="p">:</span> <span class="n">student_id</span><span class="p">,</span>
</span><span id="__span-1-402"><a href="#__codelineno-1-402" id="__codelineno-1-402" name="__codelineno-1-402"></a>            <span class="s2">"parent_email"</span><span class="p">:</span> <span class="n">parent_email</span><span class="p">,</span>
</span><span id="__span-1-403"><a href="#__codelineno-1-403" id="__codelineno-1-403" name="__codelineno-1-403"></a>            <span class="s2">"consent_type"</span><span class="p">:</span> <span class="n">consent_type</span><span class="p">,</span>
</span><span id="__span-1-404"><a href="#__codelineno-1-404" id="__codelineno-1-404" name="__codelineno-1-404"></a>            <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"pending"</span><span class="p">,</span>
</span><span id="__span-1-405"><a href="#__codelineno-1-405" id="__codelineno-1-405" name="__codelineno-1-405"></a>            <span class="s2">"requested_at"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-1-406"><a href="#__codelineno-1-406" id="__codelineno-1-406" name="__codelineno-1-406"></a>            <span class="s2">"verification_method"</span><span class="p">:</span> <span class="s2">"email_plus_signature"</span><span class="p">,</span>
</span><span id="__span-1-407"><a href="#__codelineno-1-407" id="__codelineno-1-407" name="__codelineno-1-407"></a>            <span class="s2">"expires_at"</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>  <span class="c1"># 1 year</span>
</span><span id="__span-1-408"><a href="#__codelineno-1-408" id="__codelineno-1-408" name="__codelineno-1-408"></a>        <span class="p">}</span>
</span><span id="__span-1-409"><a href="#__codelineno-1-409" id="__codelineno-1-409" name="__codelineno-1-409"></a>
</span><span id="__span-1-410"><a href="#__codelineno-1-410" id="__codelineno-1-410" name="__codelineno-1-410"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-411"><a href="#__codelineno-1-411" id="__codelineno-1-411" name="__codelineno-1-411"></a>            <span class="c1"># Store consent record</span>
</span><span id="__span-1-412"><a href="#__codelineno-1-412" id="__codelineno-1-412" name="__codelineno-1-412"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_consent_record</span><span class="p">(</span><span class="n">consent_record</span><span class="p">)</span>
</span><span id="__span-1-413"><a href="#__codelineno-1-413" id="__codelineno-1-413" name="__codelineno-1-413"></a>
</span><span id="__span-1-414"><a href="#__codelineno-1-414" id="__codelineno-1-414" name="__codelineno-1-414"></a>            <span class="c1"># Send consent request to parent</span>
</span><span id="__span-1-415"><a href="#__codelineno-1-415" id="__codelineno-1-415" name="__codelineno-1-415"></a>            <span class="n">consent_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_consent_url</span><span class="p">(</span><span class="n">consent_id</span><span class="p">)</span>
</span><span id="__span-1-416"><a href="#__codelineno-1-416" id="__codelineno-1-416" name="__codelineno-1-416"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_consent_request_email</span><span class="p">(</span><span class="n">parent_email</span><span class="p">,</span> <span class="n">consent_url</span><span class="p">,</span> <span class="n">consent_record</span><span class="p">)</span>
</span><span id="__span-1-417"><a href="#__codelineno-1-417" id="__codelineno-1-417" name="__codelineno-1-417"></a>
</span><span id="__span-1-418"><a href="#__codelineno-1-418" id="__codelineno-1-418" name="__codelineno-1-418"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-419"><a href="#__codelineno-1-419" id="__codelineno-1-419" name="__codelineno-1-419"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-420"><a href="#__codelineno-1-420" id="__codelineno-1-420" name="__codelineno-1-420"></a>                <span class="s2">"consent_id"</span><span class="p">:</span> <span class="n">consent_id</span><span class="p">,</span>
</span><span id="__span-1-421"><a href="#__codelineno-1-421" id="__codelineno-1-421" name="__codelineno-1-421"></a>                <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"pending"</span><span class="p">,</span>
</span><span id="__span-1-422"><a href="#__codelineno-1-422" id="__codelineno-1-422" name="__codelineno-1-422"></a>                <span class="s2">"parent_email"</span><span class="p">:</span> <span class="n">parent_email</span><span class="p">,</span>
</span><span id="__span-1-423"><a href="#__codelineno-1-423" id="__codelineno-1-423" name="__codelineno-1-423"></a>                <span class="s2">"consent_url"</span><span class="p">:</span> <span class="n">consent_url</span><span class="p">,</span>
</span><span id="__span-1-424"><a href="#__codelineno-1-424" id="__codelineno-1-424" name="__codelineno-1-424"></a>                <span class="s2">"expires_at"</span><span class="p">:</span> <span class="n">consent_record</span><span class="p">[</span><span class="s2">"expires_at"</span><span class="p">]</span>
</span><span id="__span-1-425"><a href="#__codelineno-1-425" id="__codelineno-1-425" name="__codelineno-1-425"></a>            <span class="p">}</span>
</span><span id="__span-1-426"><a href="#__codelineno-1-426" id="__codelineno-1-426" name="__codelineno-1-426"></a>
</span><span id="__span-1-427"><a href="#__codelineno-1-427" id="__codelineno-1-427" name="__codelineno-1-427"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-1-428"><a href="#__codelineno-1-428" id="__codelineno-1-428" name="__codelineno-1-428"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to initiate parental consent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-1-429"><a href="#__codelineno-1-429" id="__codelineno-1-429" name="__codelineno-1-429"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-430"><a href="#__codelineno-1-430" id="__codelineno-1-430" name="__codelineno-1-430"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-1-431"><a href="#__codelineno-1-431" id="__codelineno-1-431" name="__codelineno-1-431"></a>                <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-1-432"><a href="#__codelineno-1-432" id="__codelineno-1-432" name="__codelineno-1-432"></a>            <span class="p">}</span>
</span><span id="__span-1-433"><a href="#__codelineno-1-433" id="__codelineno-1-433" name="__codelineno-1-433"></a>
</span><span id="__span-1-434"><a href="#__codelineno-1-434" id="__codelineno-1-434" name="__codelineno-1-434"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_consent_response</span><span class="p">(</span>
</span><span id="__span-1-435"><a href="#__codelineno-1-435" id="__codelineno-1-435" name="__codelineno-1-435"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-436"><a href="#__codelineno-1-436" id="__codelineno-1-436" name="__codelineno-1-436"></a>        <span class="n">consent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-437"><a href="#__codelineno-1-437" id="__codelineno-1-437" name="__codelineno-1-437"></a>        <span class="n">parent_signature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-438"><a href="#__codelineno-1-438" id="__codelineno-1-438" name="__codelineno-1-438"></a>        <span class="n">consent_granted</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-1-439"><a href="#__codelineno-1-439" id="__codelineno-1-439" name="__codelineno-1-439"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-440"><a href="#__codelineno-1-440" id="__codelineno-1-440" name="__codelineno-1-440"></a><span class="w">        </span><span class="sd">"""Process parental consent response"""</span>
</span><span id="__span-1-441"><a href="#__codelineno-1-441" id="__codelineno-1-441" name="__codelineno-1-441"></a>
</span><span id="__span-1-442"><a href="#__codelineno-1-442" id="__codelineno-1-442" name="__codelineno-1-442"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-443"><a href="#__codelineno-1-443" id="__codelineno-1-443" name="__codelineno-1-443"></a>            <span class="n">consent_record</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_consent_record</span><span class="p">(</span><span class="n">consent_id</span><span class="p">)</span>
</span><span id="__span-1-444"><a href="#__codelineno-1-444" id="__codelineno-1-444" name="__codelineno-1-444"></a>
</span><span id="__span-1-445"><a href="#__codelineno-1-445" id="__codelineno-1-445" name="__codelineno-1-445"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">consent_record</span><span class="p">:</span>
</span><span id="__span-1-446"><a href="#__codelineno-1-446" id="__codelineno-1-446" name="__codelineno-1-446"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">:</span> <span class="s2">"Consent record not found"</span><span class="p">}</span>
</span><span id="__span-1-447"><a href="#__codelineno-1-447" id="__codelineno-1-447" name="__codelineno-1-447"></a>
</span><span id="__span-1-448"><a href="#__codelineno-1-448" id="__codelineno-1-448" name="__codelineno-1-448"></a>            <span class="k">if</span> <span class="n">consent_record</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"pending"</span><span class="p">:</span>
</span><span id="__span-1-449"><a href="#__codelineno-1-449" id="__codelineno-1-449" name="__codelineno-1-449"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">:</span> <span class="s2">"Consent already processed"</span><span class="p">}</span>
</span><span id="__span-1-450"><a href="#__codelineno-1-450" id="__codelineno-1-450" name="__codelineno-1-450"></a>
</span><span id="__span-1-451"><a href="#__codelineno-1-451" id="__codelineno-1-451" name="__codelineno-1-451"></a>            <span class="c1"># Verify signature (in production, use proper digital signature verification)</span>
</span><span id="__span-1-452"><a href="#__codelineno-1-452" id="__codelineno-1-452" name="__codelineno-1-452"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_parent_signature</span><span class="p">(</span><span class="n">parent_signature</span><span class="p">,</span> <span class="n">consent_record</span><span class="p">):</span>
</span><span id="__span-1-453"><a href="#__codelineno-1-453" id="__codelineno-1-453" name="__codelineno-1-453"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">:</span> <span class="s2">"Invalid parent signature"</span><span class="p">}</span>
</span><span id="__span-1-454"><a href="#__codelineno-1-454" id="__codelineno-1-454" name="__codelineno-1-454"></a>
</span><span id="__span-1-455"><a href="#__codelineno-1-455" id="__codelineno-1-455" name="__codelineno-1-455"></a>            <span class="c1"># Update consent record</span>
</span><span id="__span-1-456"><a href="#__codelineno-1-456" id="__codelineno-1-456" name="__codelineno-1-456"></a>            <span class="n">consent_record</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="__span-1-457"><a href="#__codelineno-1-457" id="__codelineno-1-457" name="__codelineno-1-457"></a>                <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"active"</span> <span class="k">if</span> <span class="n">consent_granted</span> <span class="k">else</span> <span class="s2">"denied"</span><span class="p">,</span>
</span><span id="__span-1-458"><a href="#__codelineno-1-458" id="__codelineno-1-458" name="__codelineno-1-458"></a>                <span class="s2">"parent_signature"</span><span class="p">:</span> <span class="n">parent_signature</span><span class="p">,</span>
</span><span id="__span-1-459"><a href="#__codelineno-1-459" id="__codelineno-1-459" name="__codelineno-1-459"></a>                <span class="s2">"processed_at"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-1-460"><a href="#__codelineno-1-460" id="__codelineno-1-460" name="__codelineno-1-460"></a>                <span class="s2">"consent_granted"</span><span class="p">:</span> <span class="n">consent_granted</span>
</span><span id="__span-1-461"><a href="#__codelineno-1-461" id="__codelineno-1-461" name="__codelineno-1-461"></a>            <span class="p">})</span>
</span><span id="__span-1-462"><a href="#__codelineno-1-462" id="__codelineno-1-462" name="__codelineno-1-462"></a>
</span><span id="__span-1-463"><a href="#__codelineno-1-463" id="__codelineno-1-463" name="__codelineno-1-463"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_consent_record</span><span class="p">(</span><span class="n">consent_record</span><span class="p">)</span>
</span><span id="__span-1-464"><a href="#__codelineno-1-464" id="__codelineno-1-464" name="__codelineno-1-464"></a>
</span><span id="__span-1-465"><a href="#__codelineno-1-465" id="__codelineno-1-465" name="__codelineno-1-465"></a>            <span class="c1"># If consent denied, mark student account for data removal</span>
</span><span id="__span-1-466"><a href="#__codelineno-1-466" id="__codelineno-1-466" name="__codelineno-1-466"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">consent_granted</span><span class="p">:</span>
</span><span id="__span-1-467"><a href="#__codelineno-1-467" id="__codelineno-1-467" name="__codelineno-1-467"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_data_removal</span><span class="p">(</span><span class="n">consent_record</span><span class="p">[</span><span class="s2">"student_id"</span><span class="p">])</span>
</span><span id="__span-1-468"><a href="#__codelineno-1-468" id="__codelineno-1-468" name="__codelineno-1-468"></a>
</span><span id="__span-1-469"><a href="#__codelineno-1-469" id="__codelineno-1-469" name="__codelineno-1-469"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-470"><a href="#__codelineno-1-470" id="__codelineno-1-470" name="__codelineno-1-470"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-471"><a href="#__codelineno-1-471" id="__codelineno-1-471" name="__codelineno-1-471"></a>                <span class="s2">"consent_id"</span><span class="p">:</span> <span class="n">consent_id</span><span class="p">,</span>
</span><span id="__span-1-472"><a href="#__codelineno-1-472" id="__codelineno-1-472" name="__codelineno-1-472"></a>                <span class="s2">"status"</span><span class="p">:</span> <span class="n">consent_record</span><span class="p">[</span><span class="s2">"status"</span><span class="p">],</span>
</span><span id="__span-1-473"><a href="#__codelineno-1-473" id="__codelineno-1-473" name="__codelineno-1-473"></a>                <span class="s2">"consent_granted"</span><span class="p">:</span> <span class="n">consent_granted</span>
</span><span id="__span-1-474"><a href="#__codelineno-1-474" id="__codelineno-1-474" name="__codelineno-1-474"></a>            <span class="p">}</span>
</span><span id="__span-1-475"><a href="#__codelineno-1-475" id="__codelineno-1-475" name="__codelineno-1-475"></a>
</span><span id="__span-1-476"><a href="#__codelineno-1-476" id="__codelineno-1-476" name="__codelineno-1-476"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-1-477"><a href="#__codelineno-1-477" id="__codelineno-1-477" name="__codelineno-1-477"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to process consent response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-1-478"><a href="#__codelineno-1-478" id="__codelineno-1-478" name="__codelineno-1-478"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="__span-1-479"><a href="#__codelineno-1-479" id="__codelineno-1-479" name="__codelineno-1-479"></a>
</span><span id="__span-1-480"><a href="#__codelineno-1-480" id="__codelineno-1-480" name="__codelineno-1-480"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_compliance_report</span><span class="p">(</span>
</span><span id="__span-1-481"><a href="#__codelineno-1-481" id="__codelineno-1-481" name="__codelineno-1-481"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-482"><a href="#__codelineno-1-482" id="__codelineno-1-482" name="__codelineno-1-482"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-483"><a href="#__codelineno-1-483" id="__codelineno-1-483" name="__codelineno-1-483"></a>        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-1-484"><a href="#__codelineno-1-484" id="__codelineno-1-484" name="__codelineno-1-484"></a>        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-1-485"><a href="#__codelineno-1-485" id="__codelineno-1-485" name="__codelineno-1-485"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-486"><a href="#__codelineno-1-486" id="__codelineno-1-486" name="__codelineno-1-486"></a><span class="w">        </span><span class="sd">"""Generate comprehensive compliance report"""</span>
</span><span id="__span-1-487"><a href="#__codelineno-1-487" id="__codelineno-1-487" name="__codelineno-1-487"></a>
</span><span id="__span-1-488"><a href="#__codelineno-1-488" id="__codelineno-1-488" name="__codelineno-1-488"></a>        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-489"><a href="#__codelineno-1-489" id="__codelineno-1-489" name="__codelineno-1-489"></a>            <span class="s2">"organization_id"</span><span class="p">:</span> <span class="n">organization_id</span><span class="p">,</span>
</span><span id="__span-1-490"><a href="#__codelineno-1-490" id="__codelineno-1-490" name="__codelineno-1-490"></a>            <span class="s2">"report_period"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-491"><a href="#__codelineno-1-491" id="__codelineno-1-491" name="__codelineno-1-491"></a>                <span class="s2">"start_date"</span><span class="p">:</span> <span class="n">start_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-1-492"><a href="#__codelineno-1-492" id="__codelineno-1-492" name="__codelineno-1-492"></a>                <span class="s2">"end_date"</span><span class="p">:</span> <span class="n">end_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-1-493"><a href="#__codelineno-1-493" id="__codelineno-1-493" name="__codelineno-1-493"></a>            <span class="p">},</span>
</span><span id="__span-1-494"><a href="#__codelineno-1-494" id="__codelineno-1-494" name="__codelineno-1-494"></a>            <span class="s2">"coppa_compliance"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_coppa_report</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),</span>
</span><span id="__span-1-495"><a href="#__codelineno-1-495" id="__codelineno-1-495" name="__codelineno-1-495"></a>            <span class="s2">"ferpa_compliance"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_ferpa_report</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),</span>
</span><span id="__span-1-496"><a href="#__codelineno-1-496" id="__codelineno-1-496" name="__codelineno-1-496"></a>            <span class="s2">"data_handling_summary"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_data_handling_summary</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),</span>
</span><span id="__span-1-497"><a href="#__codelineno-1-497" id="__codelineno-1-497" name="__codelineno-1-497"></a>            <span class="s2">"access_audit"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_access_audit</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),</span>
</span><span id="__span-1-498"><a href="#__codelineno-1-498" id="__codelineno-1-498" name="__codelineno-1-498"></a>            <span class="s2">"violations_and_incidents"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_violations_report</span><span class="p">(</span><span class="n">organization_id</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),</span>
</span><span id="__span-1-499"><a href="#__codelineno-1-499" id="__codelineno-1-499" name="__codelineno-1-499"></a>            <span class="s2">"recommendations"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_compliance_recommendations</span><span class="p">(</span><span class="n">organization_id</span><span class="p">)</span>
</span><span id="__span-1-500"><a href="#__codelineno-1-500" id="__codelineno-1-500" name="__codelineno-1-500"></a>        <span class="p">}</span>
</span><span id="__span-1-501"><a href="#__codelineno-1-501" id="__codelineno-1-501" name="__codelineno-1-501"></a>
</span><span id="__span-1-502"><a href="#__codelineno-1-502" id="__codelineno-1-502" name="__codelineno-1-502"></a>        <span class="k">return</span> <span class="n">report</span>
</span><span id="__span-1-503"><a href="#__codelineno-1-503" id="__codelineno-1-503" name="__codelineno-1-503"></a>
</span><span id="__span-1-504"><a href="#__codelineno-1-504" id="__codelineno-1-504" name="__codelineno-1-504"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_coppa_report</span><span class="p">(</span>
</span><span id="__span-1-505"><a href="#__codelineno-1-505" id="__codelineno-1-505" name="__codelineno-1-505"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-506"><a href="#__codelineno-1-506" id="__codelineno-1-506" name="__codelineno-1-506"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-507"><a href="#__codelineno-1-507" id="__codelineno-1-507" name="__codelineno-1-507"></a>        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-1-508"><a href="#__codelineno-1-508" id="__codelineno-1-508" name="__codelineno-1-508"></a>        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-1-509"><a href="#__codelineno-1-509" id="__codelineno-1-509" name="__codelineno-1-509"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-510"><a href="#__codelineno-1-510" id="__codelineno-1-510" name="__codelineno-1-510"></a><span class="w">        </span><span class="sd">"""Generate COPPA compliance section of report"""</span>
</span><span id="__span-1-511"><a href="#__codelineno-1-511" id="__codelineno-1-511" name="__codelineno-1-511"></a>
</span><span id="__span-1-512"><a href="#__codelineno-1-512" id="__codelineno-1-512" name="__codelineno-1-512"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-513"><a href="#__codelineno-1-513" id="__codelineno-1-513" name="__codelineno-1-513"></a>            <span class="s2">"applicable"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-514"><a href="#__codelineno-1-514" id="__codelineno-1-514" name="__codelineno-1-514"></a>            <span class="s2">"child_users_count"</span><span class="p">:</span> <span class="mi">145</span><span class="p">,</span>
</span><span id="__span-1-515"><a href="#__codelineno-1-515" id="__codelineno-1-515" name="__codelineno-1-515"></a>            <span class="s2">"parental_consents"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-516"><a href="#__codelineno-1-516" id="__codelineno-1-516" name="__codelineno-1-516"></a>                <span class="s2">"active"</span><span class="p">:</span> <span class="mi">142</span><span class="p">,</span>
</span><span id="__span-1-517"><a href="#__codelineno-1-517" id="__codelineno-1-517" name="__codelineno-1-517"></a>                <span class="s2">"pending"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-1-518"><a href="#__codelineno-1-518" id="__codelineno-1-518" name="__codelineno-1-518"></a>                <span class="s2">"denied"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-1-519"><a href="#__codelineno-1-519" id="__codelineno-1-519" name="__codelineno-1-519"></a>                <span class="s2">"expired"</span><span class="p">:</span> <span class="mi">2</span>
</span><span id="__span-1-520"><a href="#__codelineno-1-520" id="__codelineno-1-520" name="__codelineno-1-520"></a>            <span class="p">},</span>
</span><span id="__span-1-521"><a href="#__codelineno-1-521" id="__codelineno-1-521" name="__codelineno-1-521"></a>            <span class="s2">"data_minimization"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-522"><a href="#__codelineno-1-522" id="__codelineno-1-522" name="__codelineno-1-522"></a>                <span class="s2">"compliant_uploads"</span><span class="p">:</span> <span class="mi">1387</span><span class="p">,</span>
</span><span id="__span-1-523"><a href="#__codelineno-1-523" id="__codelineno-1-523" name="__codelineno-1-523"></a>                <span class="s2">"flagged_uploads"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="__span-1-524"><a href="#__codelineno-1-524" id="__codelineno-1-524" name="__codelineno-1-524"></a>                <span class="s2">"resolved_issues"</span><span class="p">:</span> <span class="mi">4</span>
</span><span id="__span-1-525"><a href="#__codelineno-1-525" id="__codelineno-1-525" name="__codelineno-1-525"></a>            <span class="p">},</span>
</span><span id="__span-1-526"><a href="#__codelineno-1-526" id="__codelineno-1-526" name="__codelineno-1-526"></a>            <span class="s2">"security_measures"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-527"><a href="#__codelineno-1-527" id="__codelineno-1-527" name="__codelineno-1-527"></a>                <span class="s2">"enhanced_encryption"</span><span class="p">:</span> <span class="s2">"enabled"</span><span class="p">,</span>
</span><span id="__span-1-528"><a href="#__codelineno-1-528" id="__codelineno-1-528" name="__codelineno-1-528"></a>                <span class="s2">"access_restrictions"</span><span class="p">:</span> <span class="s2">"active"</span><span class="p">,</span>
</span><span id="__span-1-529"><a href="#__codelineno-1-529" id="__codelineno-1-529" name="__codelineno-1-529"></a>                <span class="s2">"audit_logging"</span><span class="p">:</span> <span class="s2">"comprehensive"</span>
</span><span id="__span-1-530"><a href="#__codelineno-1-530" id="__codelineno-1-530" name="__codelineno-1-530"></a>            <span class="p">},</span>
</span><span id="__span-1-531"><a href="#__codelineno-1-531" id="__codelineno-1-531" name="__codelineno-1-531"></a>            <span class="s2">"violations"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-1-532"><a href="#__codelineno-1-532" id="__codelineno-1-532" name="__codelineno-1-532"></a>            <span class="s2">"compliance_score"</span><span class="p">:</span> <span class="mf">98.5</span>
</span><span id="__span-1-533"><a href="#__codelineno-1-533" id="__codelineno-1-533" name="__codelineno-1-533"></a>        <span class="p">}</span>
</span><span id="__span-1-534"><a href="#__codelineno-1-534" id="__codelineno-1-534" name="__codelineno-1-534"></a>
</span><span id="__span-1-535"><a href="#__codelineno-1-535" id="__codelineno-1-535" name="__codelineno-1-535"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_ferpa_report</span><span class="p">(</span>
</span><span id="__span-1-536"><a href="#__codelineno-1-536" id="__codelineno-1-536" name="__codelineno-1-536"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-537"><a href="#__codelineno-1-537" id="__codelineno-1-537" name="__codelineno-1-537"></a>        <span class="n">organization_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-538"><a href="#__codelineno-1-538" id="__codelineno-1-538" name="__codelineno-1-538"></a>        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-1-539"><a href="#__codelineno-1-539" id="__codelineno-1-539" name="__codelineno-1-539"></a>        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-1-540"><a href="#__codelineno-1-540" id="__codelineno-1-540" name="__codelineno-1-540"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-541"><a href="#__codelineno-1-541" id="__codelineno-1-541" name="__codelineno-1-541"></a><span class="w">        </span><span class="sd">"""Generate FERPA compliance section of report"""</span>
</span><span id="__span-1-542"><a href="#__codelineno-1-542" id="__codelineno-1-542" name="__codelineno-1-542"></a>
</span><span id="__span-1-543"><a href="#__codelineno-1-543" id="__codelineno-1-543" name="__codelineno-1-543"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-544"><a href="#__codelineno-1-544" id="__codelineno-1-544" name="__codelineno-1-544"></a>            <span class="s2">"applicable"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-545"><a href="#__codelineno-1-545" id="__codelineno-1-545" name="__codelineno-1-545"></a>            <span class="s2">"educational_records_accessed"</span><span class="p">:</span> <span class="mi">2456</span><span class="p">,</span>
</span><span id="__span-1-546"><a href="#__codelineno-1-546" id="__codelineno-1-546" name="__codelineno-1-546"></a>            <span class="s2">"legitimate_interest_verifications"</span><span class="p">:</span> <span class="mi">2456</span><span class="p">,</span>
</span><span id="__span-1-547"><a href="#__codelineno-1-547" id="__codelineno-1-547" name="__codelineno-1-547"></a>            <span class="s2">"consent_required_disclosures"</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
</span><span id="__span-1-548"><a href="#__codelineno-1-548" id="__codelineno-1-548" name="__codelineno-1-548"></a>            <span class="s2">"consent_obtained"</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
</span><span id="__span-1-549"><a href="#__codelineno-1-549" id="__codelineno-1-549" name="__codelineno-1-549"></a>            <span class="s2">"directory_information_disclosures"</span><span class="p">:</span> <span class="mi">156</span><span class="p">,</span>
</span><span id="__span-1-550"><a href="#__codelineno-1-550" id="__codelineno-1-550" name="__codelineno-1-550"></a>            <span class="s2">"opt_out_requests"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="__span-1-551"><a href="#__codelineno-1-551" id="__codelineno-1-551" name="__codelineno-1-551"></a>            <span class="s2">"audit_trail_completeness"</span><span class="p">:</span> <span class="s2">"100%"</span><span class="p">,</span>
</span><span id="__span-1-552"><a href="#__codelineno-1-552" id="__codelineno-1-552" name="__codelineno-1-552"></a>            <span class="s2">"violations"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-1-553"><a href="#__codelineno-1-553" id="__codelineno-1-553" name="__codelineno-1-553"></a>            <span class="s2">"compliance_score"</span><span class="p">:</span> <span class="mf">100.0</span>
</span><span id="__span-1-554"><a href="#__codelineno-1-554" id="__codelineno-1-554" name="__codelineno-1-554"></a>        <span class="p">}</span>
</span></code></pre></div> <p>This comprehensive security and compliance system provides robust protection for educational data while maintaining compliance with key regulations. The implementation covers virus scanning, privacy protection, access control, and detailed audit capabilities specifically designed for educational institutions.</p> <p>The system ensures that all file operations are properly secured and compliant with educational regulations, providing a foundation for safe and legally compliant educational technology platforms.</p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:11:16 UTC"><span class="timeago" datetime="2025-09-28T04:11:16+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:11:16 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Created"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:11:16 UTC"><span class="timeago" datetime="2025-09-28T04:11:16+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:11:16 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Contributors"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"></path></svg> </span> <nav> <a href="mailto:140660682+grayghostdev@users.noreply.github.com">GrayGhostDev</a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button class="md-top md-icon" data-md-component="top" hidden="" type="button"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 ToolBoxAI Solutions </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/ToolBoxAI-Solutions" rel="noopener" target="_blank" title="ToolBoxAI on GitHub"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a class="md-social__link" href="https://discord.gg/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Discord"> <svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"></path></svg> </a> <a class="md-social__link" href="https://twitter.com/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Twitter"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <div class="md-progress" data-md-component="progress" role="progressbar"></div> <div class="md-consent" data-md-component="consent" hidden="" id="__consent"> <div class="md-consent__overlay"></div> <aside class="md-consent__inner"> <form class="md-consent__form md-grid md-typeset" name="consent"> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class="md-toggle" id="__settings" type="checkbox"/> <div class="md-consent__settings"> <ul class="task-list"> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="analytics" type="checkbox"/> <span class="task-list-indicator"></span> Google Analytics </label> </li> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="github" type="checkbox"/> <span class="task-list-indicator"></span> GitHub </label> </li> </ul> </div> <div class="md-consent__controls"> <button class="md-button md-button--primary">Accept</button> <label class="md-button" for="__settings">Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script> <script src="../../../js/timeago.min.js"></script> <script src="../../../js/timeago_mkdocs_material.js"></script> <script src="../../../javascripts/extra.js"></script> <script src="../../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> </body> </html>