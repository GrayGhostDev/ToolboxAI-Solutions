<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Comprehensive documentation for the ToolBoxAI educational platform with AI-powered content generation and Roblox integration" name="description"/><meta content="ToolBoxAI Team" name="author"/><link href="https://docs.toolboxai.com/05-features/storage/CDN_INTEGRATION/" rel="canonical"/><link href="../../../images/favicon.png" rel="icon"/><meta content="mkdocs-1.6.1, mkdocs-material-9.6.21" name="generator"/><title>CDN Integration - ToolBoxAI Solutions Documentation</title><link href="../../../assets/stylesheets/main.2a3383ac.min.css" rel="stylesheet"/><link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href="../../../css/timeago.css" rel="stylesheet"/><link href="../../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#cdn-integration"> Skip to content </a> </div> <div data-md-component="announce"> </div> <div data-md-color-scheme="default" data-md-component="outdated" hidden=""> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../../images/logo.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> ToolBoxAI Solutions Documentation </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> CDN Integration </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0"> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> </nav> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../01-overview/README.md"> Getting Started </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../02-architecture/README.md"> Architecture </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../03-api/README.md"> API Documentation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../04-implementation/README.md"> Implementation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../README.md"> Features </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../06-user-guides/README.md"> User Guides </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../07-operations/README.md"> Operations </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../08-reference/README.md"> Reference </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../09-meta/README.md"> Meta </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../10-reports/README.md"> Reports </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../11-sdks/README.md"> SDKs </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../phase2/"> Phase 2 (Current) </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> Audit &amp; Reports </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../../images/logo.png"/> </a> ToolBoxAI Solutions Documentation </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../.."> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../01-overview/README.md"> <span class="md-ellipsis"> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../02-architecture/README.md"> <span class="md-ellipsis"> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../03-api/README.md"> <span class="md-ellipsis"> API Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../04-implementation/README.md"> <span class="md-ellipsis"> Implementation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../README.md"> <span class="md-ellipsis"> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../06-user-guides/README.md"> <span class="md-ellipsis"> User Guides </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../07-operations/README.md"> <span class="md-ellipsis"> Operations </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../08-reference/README.md"> <span class="md-ellipsis"> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../09-meta/README.md"> <span class="md-ellipsis"> Meta </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../10-reports/README.md"> <span class="md-ellipsis"> Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../11-sdks/README.md"> <span class="md-ellipsis"> SDKs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../phase2/"> <span class="md-ellipsis"> Phase 2 (Current) </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> <span class="md-ellipsis"> Audit &amp; Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/edit/main/docs/05-features/storage/CDN_INTEGRATION.md" rel="edit" title="Edit this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/raw/main/docs/05-features/storage/CDN_INTEGRATION.md" title="View source of this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id="cdn-integration">CDN Integration<a class="headerlink" href="#cdn-integration" title="Permanent link">¶</a></h1> <p>The ToolBoxAI Storage System features intelligent CDN integration that provides global content delivery, on-the-fly image transformations, smart caching strategies, and performance optimization for educational content delivery.</p> <h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">¶</a></h2> <ul> <li><a href="#smart-cdn-configuration">Smart CDN Configuration</a></li> <li><a href="#image-transformations">Image Transformations</a></li> <li><a href="#cache-strategies">Cache Strategies</a></li> <li><a href="#global-distribution">Global Distribution</a></li> <li><a href="#performance-metrics">Performance Metrics</a></li> <li><a href="#cdn-provider-integration">CDN Provider Integration</a></li> <li><a href="#optimization-techniques">Optimization Techniques</a></li> <li><a href="#monitoring-and-analytics">Monitoring and Analytics</a></li> </ul> <h2 id="smart-cdn-configuration">Smart CDN Configuration<a class="headerlink" href="#smart-cdn-configuration" title="Permanent link">¶</a></h2> <h3 id="cdn-architecture-overview">CDN Architecture Overview<a class="headerlink" href="#cdn-architecture-overview" title="Permanent link">¶</a></h3> <pre class="mermaid"><code>graph TB
    subgraph "Global CDN Network"
        CDN_US[US East/West PoPs]
        CDN_EU[European PoPs]
        CDN_ASIA[Asian PoPs]
        CDN_GLOBAL[Other Global PoPs]
    end

    subgraph "Origin Infrastructure"
        SupabaseStorage[Supabase Storage]
        ImageProcessor[Image Processor]
        CacheWarmup[Cache Warmup]
    end

    subgraph "Smart Routing"
        GeoRouter[Geographic Router]
        LoadBalancer[Load Balancer]
        EdgeLogic[Edge Compute]
    end

    subgraph "Client Applications"
        Dashboard[Web Dashboard]
        Mobile[Mobile Apps]
        API[API Clients]
    end

    Dashboard --&gt; GeoRouter
    Mobile --&gt; GeoRouter
    API --&gt; GeoRouter

    GeoRouter --&gt; CDN_US
    GeoRouter --&gt; CDN_EU
    GeoRouter --&gt; CDN_ASIA
    GeoRouter --&gt; CDN_GLOBAL

    CDN_US --&gt; SupabaseStorage
    CDN_EU --&gt; SupabaseStorage
    CDN_ASIA --&gt; SupabaseStorage
    CDN_GLOBAL --&gt; SupabaseStorage

    ImageProcessor --&gt; CacheWarmup
    CacheWarmup --&gt; CDN_US</code></pre> <h3 id="cdn-configuration-class">CDN Configuration Class<a class="headerlink" href="#cdn-configuration-class" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CDNProvider</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="n">CLOUDFLARE</span> <span class="o">=</span> <span class="s2">"cloudflare"</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">KEYCDN</span> <span class="o">=</span> <span class="s2">"keycdn"</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="n">BUNNYCDN</span> <span class="o">=</span> <span class="s2">"bunnycdn"</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">FASTLY</span> <span class="o">=</span> <span class="s2">"fastly"</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">CUSTOM</span> <span class="o">=</span> <span class="s2">"custom"</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nd">@dataclass</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">CDNConfiguration</span><span class="p">:</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="sd">"""CDN configuration settings"""</span>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">provider</span><span class="p">:</span> <span class="n">CDNProvider</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">zone_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="c1"># Feature flags</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">enable_image_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">enable_webp_conversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">enable_avif_conversion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">enable_responsive_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">enable_video_transcoding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-0-31"><a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>
</span><span id="__span-0-32"><a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="c1"># Cache settings</span>
</span><span id="__span-0-33"><a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">default_cache_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># 24 hours</span>
</span><span id="__span-0-34"><a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">image_cache_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">604800</span>   <span class="c1"># 7 days</span>
</span><span id="__span-0-35"><a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">document_cache_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">172800</span>  <span class="c1"># 2 days</span>
</span><span id="__span-0-36"><a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>
</span><span id="__span-0-37"><a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="c1"># Geographic settings</span>
</span><span id="__span-0-38"><a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">primary_region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"us-east-1"</span>
</span><span id="__span-0-39"><a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">enabled_regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-40"><a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>
</span><span id="__span-0-41"><a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Performance settings</span>
</span><span id="__span-0-42"><a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">compression_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="__span-0-43"><a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">quality_auto</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-44"><a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">fetch_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-0-45"><a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>
</span><span id="__span-0-46"><a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-47"><a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_regions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-48"><a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">enabled_regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"us"</span><span class="p">,</span> <span class="s2">"eu"</span><span class="p">,</span> <span class="s2">"asia"</span><span class="p">]</span>
</span><span id="__span-0-49"><a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>
</span><span id="__span-0-50"><a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="k">class</span><span class="w"> </span><span class="nc">SmartCDNManager</span><span class="p">:</span>
</span><span id="__span-0-51"><a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="sd">"""Manages intelligent CDN operations"""</span>
</span><span id="__span-0-52"><a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>
</span><span id="__span-0-53"><a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">CDNConfiguration</span><span class="p">):</span>
</span><span id="__span-0-54"><a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="__span-0-55"><a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">provider_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_provider_client</span><span class="p">()</span>
</span><span id="__span-0-56"><a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformation_presets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_transformation_presets</span><span class="p">()</span>
</span><span id="__span-0-57"><a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_cache_rules</span><span class="p">()</span>
</span><span id="__span-0-58"><a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a>
</span><span id="__span-0-59"><a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_provider_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-60"><a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">        </span><span class="sd">"""Initialize CDN provider-specific client"""</span>
</span><span id="__span-0-61"><a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a>
</span><span id="__span-0-62"><a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">CLOUDFLARE</span><span class="p">:</span>
</span><span id="__span-0-63"><a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">return</span> <span class="n">CloudflareClient</span><span class="p">(</span>
</span><span id="__span-0-64"><a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="n">zone_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">zone_id</span><span class="p">,</span>
</span><span id="__span-0-65"><a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">api_key</span>
</span><span id="__span-0-66"><a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="p">)</span>
</span><span id="__span-0-67"><a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">KEYCDN</span><span class="p">:</span>
</span><span id="__span-0-68"><a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="k">return</span> <span class="n">KeyCDNClient</span><span class="p">(</span>
</span><span id="__span-0-69"><a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a>                <span class="n">zone_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">zone_id</span><span class="p">,</span>
</span><span id="__span-0-70"><a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">api_key</span>
</span><span id="__span-0-71"><a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="p">)</span>
</span><span id="__span-0-72"><a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">BUNNYCDN</span><span class="p">:</span>
</span><span id="__span-0-73"><a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="k">return</span> <span class="n">BunnyCDNClient</span><span class="p">(</span>
</span><span id="__span-0-74"><a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">zone_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">zone_id</span><span class="p">,</span>
</span><span id="__span-0-75"><a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">api_key</span>
</span><span id="__span-0-76"><a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="p">)</span>
</span><span id="__span-0-77"><a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-78"><a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="k">return</span> <span class="n">GenericCDNClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="__span-0-79"><a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a>
</span><span id="__span-0-80"><a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_transformation_presets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-0-81"><a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="w">        </span><span class="sd">"""Load predefined transformation presets"""</span>
</span><span id="__span-0-82"><a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a>
</span><span id="__span-0-83"><a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-84"><a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="s2">"avatar"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-85"><a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
</span><span id="__span-0-86"><a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
</span><span id="__span-0-87"><a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span><span class="p">,</span>
</span><span id="__span-0-88"><a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-0-89"><a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">,</span>
</span><span id="__span-0-90"><a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="s2">"background"</span><span class="p">:</span> <span class="s2">"ffffff"</span>
</span><span id="__span-0-91"><a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="p">},</span>
</span><span id="__span-0-92"><a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="s2">"thumbnail"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-93"><a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-0-94"><a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-0-95"><a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"smart"</span><span class="p">,</span>
</span><span id="__span-0-96"><a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
</span><span id="__span-0-97"><a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span>
</span><span id="__span-0-98"><a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">},</span>
</span><span id="__span-0-99"><a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="s2">"preview"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-100"><a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="__span-0-101"><a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span id="__span-0-102"><a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"scale"</span><span class="p">,</span>
</span><span id="__span-0-103"><a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-0-104"><a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span>
</span><span id="__span-0-105"><a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="p">},</span>
</span><span id="__span-0-106"><a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="s2">"hero"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-107"><a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
</span><span id="__span-0-108"><a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="__span-0-109"><a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span><span class="p">,</span>
</span><span id="__span-0-110"><a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
</span><span id="__span-0-111"><a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span>
</span><span id="__span-0-112"><a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="p">},</span>
</span><span id="__span-0-113"><a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="s2">"document_preview"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-0-114"><a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span id="__span-0-115"><a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="__span-0-116"><a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"fit"</span><span class="p">,</span>
</span><span id="__span-0-117"><a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
</span><span id="__span-0-118"><a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">,</span>
</span><span id="__span-0-119"><a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="s2">"page"</span><span class="p">:</span> <span class="mi">1</span>  <span class="c1"># For PDF preview</span>
</span><span id="__span-0-120"><a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="p">}</span>
</span><span id="__span-0-121"><a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="p">}</span>
</span><span id="__span-0-122"><a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a>
</span><span id="__span-0-123"><a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_optimized_url</span><span class="p">(</span>
</span><span id="__span-0-124"><a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-125"><a href="#__codelineno-0-125" id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-126"><a href="#__codelineno-0-126" id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-127"><a href="#__codelineno-0-127" id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-128"><a href="#__codelineno-0-128" id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>
</span><span id="__span-0-129"><a href="#__codelineno-0-129" id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-130"><a href="#__codelineno-0-130" id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">        </span><span class="sd">"""Generate optimized CDN URL with transformations"""</span>
</span><span id="__span-0-131"><a href="#__codelineno-0-131" id="__codelineno-0-131" name="__codelineno-0-131"></a>
</span><span id="__span-0-132"><a href="#__codelineno-0-132" id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># Build base URL</span>
</span><span id="__span-0-133"><a href="#__codelineno-0-133" id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">storage_path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-134"><a href="#__codelineno-0-134" id="__codelineno-0-134" name="__codelineno-0-134"></a>
</span><span id="__span-0-135"><a href="#__codelineno-0-135" id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">transformations</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">signed</span><span class="p">:</span>
</span><span id="__span-0-136"><a href="#__codelineno-0-136" id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">return</span> <span class="n">base_url</span>
</span><span id="__span-0-137"><a href="#__codelineno-0-137" id="__codelineno-0-137" name="__codelineno-0-137"></a>
</span><span id="__span-0-138"><a href="#__codelineno-0-138" id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="c1"># Apply transformations</span>
</span><span id="__span-0-139"><a href="#__codelineno-0-139" id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="p">:</span>
</span><span id="__span-0-140"><a href="#__codelineno-0-140" id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">transform_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_transformation_params</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-141"><a href="#__codelineno-0-141" id="__codelineno-0-141" name="__codelineno-0-141"></a>
</span><span id="__span-0-142"><a href="#__codelineno-0-142" id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">CLOUDFLARE</span><span class="p">:</span>
</span><span id="__span-0-143"><a href="#__codelineno-0-143" id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="c1"># Cloudflare Image Resizing</span>
</span><span id="__span-0-144"><a href="#__codelineno-0-144" id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/cdn-cgi/image/</span><span class="si">{</span><span class="n">transform_params</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-145"><a href="#__codelineno-0-145" id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">KEYCDN</span><span class="p">:</span>
</span><span id="__span-0-146"><a href="#__codelineno-0-146" id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="c1"># KeyCDN Image Processing</span>
</span><span id="__span-0-147"><a href="#__codelineno-0-147" id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transform_params</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-148"><a href="#__codelineno-0-148" id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-149"><a href="#__codelineno-0-149" id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="c1"># Generic query parameters</span>
</span><span id="__span-0-150"><a href="#__codelineno-0-150" id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">transform_params</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-151"><a href="#__codelineno-0-151" id="__codelineno-0-151" name="__codelineno-0-151"></a>
</span><span id="__span-0-152"><a href="#__codelineno-0-152" id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># Add signature if required</span>
</span><span id="__span-0-153"><a href="#__codelineno-0-153" id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
</span><span id="__span-0-154"><a href="#__codelineno-0-154" id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_url_signature</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">expires_in</span><span class="p">)</span>
</span><span id="__span-0-155"><a href="#__codelineno-0-155" id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">separator</span> <span class="o">=</span> <span class="s2">"&amp;"</span> <span class="k">if</span> <span class="s2">"?"</span> <span class="ow">in</span> <span class="n">base_url</span> <span class="k">else</span> <span class="s2">"?"</span>
</span><span id="__span-0-156"><a href="#__codelineno-0-156" id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">separator</span><span class="si">}</span><span class="s2">signature=</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s2">&amp;expires=</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-0-157"><a href="#__codelineno-0-157" id="__codelineno-0-157" name="__codelineno-0-157"></a>
</span><span id="__span-0-158"><a href="#__codelineno-0-158" id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">return</span> <span class="n">base_url</span>
</span><span id="__span-0-159"><a href="#__codelineno-0-159" id="__codelineno-0-159" name="__codelineno-0-159"></a>
</span><span id="__span-0-160"><a href="#__codelineno-0-160" id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_transformation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-161"><a href="#__codelineno-0-161" id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">        </span><span class="sd">"""Build provider-specific transformation parameters"""</span>
</span><span id="__span-0-162"><a href="#__codelineno-0-162" id="__codelineno-0-162" name="__codelineno-0-162"></a>
</span><span id="__span-0-163"><a href="#__codelineno-0-163" id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">CLOUDFLARE</span><span class="p">:</span>
</span><span id="__span-0-164"><a href="#__codelineno-0-164" id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cloudflare_params</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-165"><a href="#__codelineno-0-165" id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">KEYCDN</span><span class="p">:</span>
</span><span id="__span-0-166"><a href="#__codelineno-0-166" id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_keycdn_params</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-167"><a href="#__codelineno-0-167" id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">BUNNYCDN</span><span class="p">:</span>
</span><span id="__span-0-168"><a href="#__codelineno-0-168" id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_bunnycdn_params</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-169"><a href="#__codelineno-0-169" id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-170"><a href="#__codelineno-0-170" id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_generic_params</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-171"><a href="#__codelineno-0-171" id="__codelineno-0-171" name="__codelineno-0-171"></a>
</span><span id="__span-0-172"><a href="#__codelineno-0-172" id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_cloudflare_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-173"><a href="#__codelineno-0-173" id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="w">        </span><span class="sd">"""Build Cloudflare Image Resizing parameters"""</span>
</span><span id="__span-0-174"><a href="#__codelineno-0-174" id="__codelineno-0-174" name="__codelineno-0-174"></a>
</span><span id="__span-0-175"><a href="#__codelineno-0-175" id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-0-176"><a href="#__codelineno-0-176" id="__codelineno-0-176" name="__codelineno-0-176"></a>
</span><span id="__span-0-177"><a href="#__codelineno-0-177" id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">):</span>
</span><span id="__span-0-178"><a href="#__codelineno-0-178" id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"width=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-179"><a href="#__codelineno-0-179" id="__codelineno-0-179" name="__codelineno-0-179"></a>
</span><span id="__span-0-180"><a href="#__codelineno-0-180" id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">):</span>
</span><span id="__span-0-181"><a href="#__codelineno-0-181" id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"height=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-182"><a href="#__codelineno-0-182" id="__codelineno-0-182" name="__codelineno-0-182"></a>
</span><span id="__span-0-183"><a href="#__codelineno-0-183" id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">):</span>
</span><span id="__span-0-184"><a href="#__codelineno-0-184" id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"quality=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'quality'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-185"><a href="#__codelineno-0-185" id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">quality_auto</span><span class="p">:</span>
</span><span id="__span-0-186"><a href="#__codelineno-0-186" id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"quality=auto"</span><span class="p">)</span>
</span><span id="__span-0-187"><a href="#__codelineno-0-187" id="__codelineno-0-187" name="__codelineno-0-187"></a>
</span><span id="__span-0-188"><a href="#__codelineno-0-188" id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">):</span>
</span><span id="__span-0-189"><a href="#__codelineno-0-189" id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="k">if</span> <span class="n">transformations</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"auto"</span><span class="p">:</span>
</span><span id="__span-0-190"><a href="#__codelineno-0-190" id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"format=auto"</span><span class="p">)</span>
</span><span id="__span-0-191"><a href="#__codelineno-0-191" id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-192"><a href="#__codelineno-0-192" id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"format=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-193"><a href="#__codelineno-0-193" id="__codelineno-0-193" name="__codelineno-0-193"></a>
</span><span id="__span-0-194"><a href="#__codelineno-0-194" id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"crop"</span><span class="p">):</span>
</span><span id="__span-0-195"><a href="#__codelineno-0-195" id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">crop_mode</span> <span class="o">=</span> <span class="n">transformations</span><span class="p">[</span><span class="s2">"crop"</span><span class="p">]</span>
</span><span id="__span-0-196"><a href="#__codelineno-0-196" id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="k">if</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">"center"</span><span class="p">:</span>
</span><span id="__span-0-197"><a href="#__codelineno-0-197" id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"fit=crop"</span><span class="p">)</span>
</span><span id="__span-0-198"><a href="#__codelineno-0-198" id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"gravity=center"</span><span class="p">)</span>
</span><span id="__span-0-199"><a href="#__codelineno-0-199" id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="k">elif</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">"smart"</span><span class="p">:</span>
</span><span id="__span-0-200"><a href="#__codelineno-0-200" id="__codelineno-0-200" name="__codelineno-0-200"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"fit=crop"</span><span class="p">)</span>
</span><span id="__span-0-201"><a href="#__codelineno-0-201" id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"gravity=auto"</span><span class="p">)</span>
</span><span id="__span-0-202"><a href="#__codelineno-0-202" id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="k">elif</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">"scale"</span><span class="p">:</span>
</span><span id="__span-0-203"><a href="#__codelineno-0-203" id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"fit=scale-down"</span><span class="p">)</span>
</span><span id="__span-0-204"><a href="#__codelineno-0-204" id="__codelineno-0-204" name="__codelineno-0-204"></a>
</span><span id="__span-0-205"><a href="#__codelineno-0-205" id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"background"</span><span class="p">):</span>
</span><span id="__span-0-206"><a href="#__codelineno-0-206" id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"background=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'background'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-207"><a href="#__codelineno-0-207" id="__codelineno-0-207" name="__codelineno-0-207"></a>
</span><span id="__span-0-208"><a href="#__codelineno-0-208" id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"blur"</span><span class="p">):</span>
</span><span id="__span-0-209"><a href="#__codelineno-0-209" id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"blur=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'blur'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-210"><a href="#__codelineno-0-210" id="__codelineno-0-210" name="__codelineno-0-210"></a>
</span><span id="__span-0-211"><a href="#__codelineno-0-211" id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"sharpen"</span><span class="p">):</span>
</span><span id="__span-0-212"><a href="#__codelineno-0-212" id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sharpen=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'sharpen'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-213"><a href="#__codelineno-0-213" id="__codelineno-0-213" name="__codelineno-0-213"></a>
</span><span id="__span-0-214"><a href="#__codelineno-0-214" id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">return</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-0-215"><a href="#__codelineno-0-215" id="__codelineno-0-215" name="__codelineno-0-215"></a>
</span><span id="__span-0-216"><a href="#__codelineno-0-216" id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_keycdn_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-217"><a href="#__codelineno-0-217" id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="w">        </span><span class="sd">"""Build KeyCDN Image Processing parameters"""</span>
</span><span id="__span-0-218"><a href="#__codelineno-0-218" id="__codelineno-0-218" name="__codelineno-0-218"></a>
</span><span id="__span-0-219"><a href="#__codelineno-0-219" id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-0-220"><a href="#__codelineno-0-220" id="__codelineno-0-220" name="__codelineno-0-220"></a>
</span><span id="__span-0-221"><a href="#__codelineno-0-221" id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">):</span>
</span><span id="__span-0-222"><a href="#__codelineno-0-222" id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"w=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-223"><a href="#__codelineno-0-223" id="__codelineno-0-223" name="__codelineno-0-223"></a>
</span><span id="__span-0-224"><a href="#__codelineno-0-224" id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">):</span>
</span><span id="__span-0-225"><a href="#__codelineno-0-225" id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"h=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-226"><a href="#__codelineno-0-226" id="__codelineno-0-226" name="__codelineno-0-226"></a>
</span><span id="__span-0-227"><a href="#__codelineno-0-227" id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">):</span>
</span><span id="__span-0-228"><a href="#__codelineno-0-228" id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"q=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'quality'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-229"><a href="#__codelineno-0-229" id="__codelineno-0-229" name="__codelineno-0-229"></a>
</span><span id="__span-0-230"><a href="#__codelineno-0-230" id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">):</span>
</span><span id="__span-0-231"><a href="#__codelineno-0-231" id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="k">if</span> <span class="n">transformations</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"auto"</span><span class="p">:</span>
</span><span id="__span-0-232"><a href="#__codelineno-0-232" id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f=</span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-233"><a href="#__codelineno-0-233" id="__codelineno-0-233" name="__codelineno-0-233"></a>
</span><span id="__span-0-234"><a href="#__codelineno-0-234" id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"crop"</span><span class="p">):</span>
</span><span id="__span-0-235"><a href="#__codelineno-0-235" id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="n">crop_mode</span> <span class="o">=</span> <span class="n">transformations</span><span class="p">[</span><span class="s2">"crop"</span><span class="p">]</span>
</span><span id="__span-0-236"><a href="#__codelineno-0-236" id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">if</span> <span class="n">crop_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"center"</span><span class="p">,</span> <span class="s2">"smart"</span><span class="p">]:</span>
</span><span id="__span-0-237"><a href="#__codelineno-0-237" id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"c=1"</span><span class="p">)</span>  <span class="c1"># Enable cropping</span>
</span><span id="__span-0-238"><a href="#__codelineno-0-238" id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="k">elif</span> <span class="n">crop_mode</span> <span class="o">==</span> <span class="s2">"scale"</span><span class="p">:</span>
</span><span id="__span-0-239"><a href="#__codelineno-0-239" id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"c=0"</span><span class="p">)</span>  <span class="c1"># Disable cropping</span>
</span><span id="__span-0-240"><a href="#__codelineno-0-240" id="__codelineno-0-240" name="__codelineno-0-240"></a>
</span><span id="__span-0-241"><a href="#__codelineno-0-241" id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">return</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="__span-0-242"><a href="#__codelineno-0-242" id="__codelineno-0-242" name="__codelineno-0-242"></a>
</span><span id="__span-0-243"><a href="#__codelineno-0-243" id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_preset_url</span><span class="p">(</span>
</span><span id="__span-0-244"><a href="#__codelineno-0-244" id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-245"><a href="#__codelineno-0-245" id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-246"><a href="#__codelineno-0-246" id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">preset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-247"><a href="#__codelineno-0-247" id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-248"><a href="#__codelineno-0-248" id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>
</span><span id="__span-0-249"><a href="#__codelineno-0-249" id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-0-250"><a href="#__codelineno-0-250" id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="w">        </span><span class="sd">"""Get CDN URL using predefined transformation preset"""</span>
</span><span id="__span-0-251"><a href="#__codelineno-0-251" id="__codelineno-0-251" name="__codelineno-0-251"></a>
</span><span id="__span-0-252"><a href="#__codelineno-0-252" id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">if</span> <span class="n">preset_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_presets</span><span class="p">:</span>
</span><span id="__span-0-253"><a href="#__codelineno-0-253" id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown transformation preset: </span><span class="si">{</span><span class="n">preset_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-0-254"><a href="#__codelineno-0-254" id="__codelineno-0-254" name="__codelineno-0-254"></a>
</span><span id="__span-0-255"><a href="#__codelineno-0-255" id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">transformations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_presets</span><span class="p">[</span><span class="n">preset_name</span><span class="p">]</span>
</span><span id="__span-0-256"><a href="#__codelineno-0-256" id="__codelineno-0-256" name="__codelineno-0-256"></a>
</span><span id="__span-0-257"><a href="#__codelineno-0-257" id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span>
</span><span id="__span-0-258"><a href="#__codelineno-0-258" id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">storage_path</span><span class="o">=</span><span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-0-259"><a href="#__codelineno-0-259" id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">transformations</span><span class="o">=</span><span class="n">transformations</span><span class="p">,</span>
</span><span id="__span-0-260"><a href="#__codelineno-0-260" id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">,</span>
</span><span id="__span-0-261"><a href="#__codelineno-0-261" id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">expires_in</span><span class="o">=</span><span class="n">expires_in</span>
</span><span id="__span-0-262"><a href="#__codelineno-0-262" id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="p">)</span>
</span><span id="__span-0-263"><a href="#__codelineno-0-263" id="__codelineno-0-263" name="__codelineno-0-263"></a>
</span><span id="__span-0-264"><a href="#__codelineno-0-264" id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_responsive_urls</span><span class="p">(</span>
</span><span id="__span-0-265"><a href="#__codelineno-0-265" id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-266"><a href="#__codelineno-0-266" id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-267"><a href="#__codelineno-0-267" id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">breakpoints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-268"><a href="#__codelineno-0-268" id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">base_transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-269"><a href="#__codelineno-0-269" id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-0-270"><a href="#__codelineno-0-270" id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="w">        </span><span class="sd">"""Generate responsive image URLs for different breakpoints"""</span>
</span><span id="__span-0-271"><a href="#__codelineno-0-271" id="__codelineno-0-271" name="__codelineno-0-271"></a>
</span><span id="__span-0-272"><a href="#__codelineno-0-272" id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">breakpoints</span><span class="p">:</span>
</span><span id="__span-0-273"><a href="#__codelineno-0-273" id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1440</span><span class="p">,</span> <span class="mi">1920</span><span class="p">]</span>
</span><span id="__span-0-274"><a href="#__codelineno-0-274" id="__codelineno-0-274" name="__codelineno-0-274"></a>
</span><span id="__span-0-275"><a href="#__codelineno-0-275" id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_transformations</span><span class="p">:</span>
</span><span id="__span-0-276"><a href="#__codelineno-0-276" id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">base_transformations</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-277"><a href="#__codelineno-0-277" id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-0-278"><a href="#__codelineno-0-278" id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">,</span>
</span><span id="__span-0-279"><a href="#__codelineno-0-279" id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"scale"</span>
</span><span id="__span-0-280"><a href="#__codelineno-0-280" id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="p">}</span>
</span><span id="__span-0-281"><a href="#__codelineno-0-281" id="__codelineno-0-281" name="__codelineno-0-281"></a>
</span><span id="__span-0-282"><a href="#__codelineno-0-282" id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">responsive_urls</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-0-283"><a href="#__codelineno-0-283" id="__codelineno-0-283" name="__codelineno-0-283"></a>
</span><span id="__span-0-284"><a href="#__codelineno-0-284" id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
</span><span id="__span-0-285"><a href="#__codelineno-0-285" id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-286"><a href="#__codelineno-0-286" id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="o">**</span><span class="n">base_transformations</span><span class="p">,</span>
</span><span id="__span-0-287"><a href="#__codelineno-0-287" id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="n">width</span>
</span><span id="__span-0-288"><a href="#__codelineno-0-288" id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="p">}</span>
</span><span id="__span-0-289"><a href="#__codelineno-0-289" id="__codelineno-0-289" name="__codelineno-0-289"></a>
</span><span id="__span-0-290"><a href="#__codelineno-0-290" id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-0-291"><a href="#__codelineno-0-291" id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">responsive_urls</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">w"</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
</span><span id="__span-0-292"><a href="#__codelineno-0-292" id="__codelineno-0-292" name="__codelineno-0-292"></a>
</span><span id="__span-0-293"><a href="#__codelineno-0-293" id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="k">return</span> <span class="n">responsive_urls</span>
</span></code></pre></div> <h2 id="image-transformations">Image Transformations<a class="headerlink" href="#image-transformations" title="Permanent link">¶</a></h2> <h3 id="on-the-fly-image-processing">On-the-fly Image Processing<a class="headerlink" href="#on-the-fly-image-processing" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransformationEngine</span><span class="p">:</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="sd">"""Handles advanced image transformations"""</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span><span class="p">):</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">cdn_manager</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"jpeg"</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">,</span> <span class="s2">"webp"</span><span class="p">,</span> <span class="s2">"avif"</span><span class="p">]</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">quality_profiles</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>            <span class="s2">"low"</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>            <span class="s2">"medium"</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>            <span class="s2">"high"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>            <span class="s2">"lossless"</span><span class="p">:</span> <span class="mi">95</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="p">}</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">transform_image_url</span><span class="p">(</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="n">optimize_for_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="sd">"""Generate transformed image URL with device optimization"""</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="c1"># Apply device-specific optimizations</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="k">if</span> <span class="n">optimize_for_device</span><span class="p">:</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>            <span class="n">transformations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_device_optimizations</span><span class="p">(</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>                <span class="n">transformations</span><span class="p">,</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>                <span class="n">optimize_for_device</span>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>            <span class="p">)</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>        <span class="c1"># Smart format selection</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"auto"</span><span class="p">:</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>            <span class="n">transformations</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_optimal_format</span><span class="p">(</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>                <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-1-37"><a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>                <span class="n">optimize_for_device</span>
</span><span id="__span-1-38"><a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>            <span class="p">)</span>
</span><span id="__span-1-39"><a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>
</span><span id="__span-1-40"><a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>        <span class="c1"># Quality optimization</span>
</span><span id="__span-1-41"><a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="k">if</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"auto"</span><span class="p">:</span>
</span><span id="__span-1-42"><a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>            <span class="n">transformations</span><span class="p">[</span><span class="s2">"quality"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_optimal_quality</span><span class="p">(</span>
</span><span id="__span-1-43"><a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>                <span class="n">transformations</span><span class="p">,</span>
</span><span id="__span-1-44"><a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>                <span class="n">optimize_for_device</span>
</span><span id="__span-1-45"><a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>            <span class="p">)</span>
</span><span id="__span-1-46"><a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>
</span><span id="__span-1-47"><a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">transformations</span><span class="p">)</span>
</span><span id="__span-1-48"><a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>
</span><span id="__span-1-49"><a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_device_optimizations</span><span class="p">(</span>
</span><span id="__span-1-50"><a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-51"><a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-52"><a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>        <span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-53"><a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-54"><a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="sd">"""Apply device-specific optimizations"""</span>
</span><span id="__span-1-55"><a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>
</span><span id="__span-1-56"><a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>        <span class="n">optimized</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-1-57"><a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>
</span><span id="__span-1-58"><a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>        <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"mobile"</span><span class="p">:</span>
</span><span id="__span-1-59"><a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>            <span class="c1"># Mobile optimizations</span>
</span><span id="__span-1-60"><a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"quality"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="__span-1-61"><a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"webp"</span>  <span class="c1"># Better compression for mobile</span>
</span><span id="__span-1-62"><a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a>
</span><span id="__span-1-63"><a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>            <span class="c1"># Reduce dimensions for mobile if not specified</span>
</span><span id="__span-1-64"><a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">):</span>
</span><span id="__span-1-65"><a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>                <span class="n">optimized</span><span class="p">[</span><span class="s2">"width"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">768</span>  <span class="c1"># Max width for mobile</span>
</span><span id="__span-1-66"><a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>
</span><span id="__span-1-67"><a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"tablet"</span><span class="p">:</span>
</span><span id="__span-1-68"><a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>            <span class="c1"># Tablet optimizations</span>
</span><span id="__span-1-69"><a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"quality"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span> <span class="mi">85</span><span class="p">)</span>
</span><span id="__span-1-70"><a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"webp"</span>
</span><span id="__span-1-71"><a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>
</span><span id="__span-1-72"><a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">):</span>
</span><span id="__span-1-73"><a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>                <span class="n">optimized</span><span class="p">[</span><span class="s2">"width"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># Max width for tablet</span>
</span><span id="__span-1-74"><a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>
</span><span id="__span-1-75"><a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>        <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"desktop"</span><span class="p">:</span>
</span><span id="__span-1-76"><a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>            <span class="c1"># Desktop optimizations - higher quality acceptable</span>
</span><span id="__span-1-77"><a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"quality"</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
</span><span id="__span-1-78"><a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>
</span><span id="__span-1-79"><a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>            <span class="c1"># Use AVIF for modern browsers</span>
</span><span id="__span-1-80"><a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supports_avif</span><span class="p">(</span><span class="n">device_type</span><span class="p">):</span>
</span><span id="__span-1-81"><a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>                <span class="n">optimized</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"avif"</span>
</span><span id="__span-1-82"><a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>
</span><span id="__span-1-83"><a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>        <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"print"</span><span class="p">:</span>
</span><span id="__span-1-84"><a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>            <span class="c1"># Print optimizations - highest quality</span>
</span><span id="__span-1-85"><a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"quality"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">95</span>
</span><span id="__span-1-86"><a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>            <span class="n">optimized</span><span class="p">[</span><span class="s2">"format"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"png"</span>  <span class="c1"># Lossless for print</span>
</span><span id="__span-1-87"><a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>
</span><span id="__span-1-88"><a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a>        <span class="k">return</span> <span class="n">optimized</span>
</span><span id="__span-1-89"><a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>
</span><span id="__span-1-90"><a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_optimal_format</span><span class="p">(</span>
</span><span id="__span-1-91"><a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-92"><a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-93"><a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a>        <span class="n">device_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-94"><a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-95"><a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">        </span><span class="sd">"""Select optimal image format based on content and device"""</span>
</span><span id="__span-1-96"><a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>
</span><span id="__span-1-97"><a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>        <span class="n">file_extension</span> <span class="o">=</span> <span class="n">storage_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-1-98"><a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>
</span><span id="__span-1-99"><a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>        <span class="c1"># Check if original is already optimal</span>
</span><span id="__span-1-100"><a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">"webp"</span><span class="p">:</span>
</span><span id="__span-1-101"><a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>            <span class="k">return</span> <span class="s2">"webp"</span>
</span><span id="__span-1-102"><a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>        <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">"avif"</span><span class="p">:</span>
</span><span id="__span-1-103"><a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>            <span class="k">return</span> <span class="s2">"avif"</span>
</span><span id="__span-1-104"><a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>
</span><span id="__span-1-105"><a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a>        <span class="c1"># Device-based format selection</span>
</span><span id="__span-1-106"><a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a>        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"mobile"</span><span class="p">,</span> <span class="s2">"tablet"</span><span class="p">]:</span>
</span><span id="__span-1-107"><a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>            <span class="k">return</span> <span class="s2">"webp"</span>  <span class="c1"># Best compression for mobile devices</span>
</span><span id="__span-1-108"><a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a>        <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"desktop"</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supports_avif</span><span class="p">(</span><span class="n">device_type</span><span class="p">):</span>
</span><span id="__span-1-109"><a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a>            <span class="k">return</span> <span class="s2">"avif"</span>  <span class="c1"># Best quality/size ratio for modern browsers</span>
</span><span id="__span-1-110"><a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-111"><a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a>            <span class="k">return</span> <span class="s2">"webp"</span>  <span class="c1"># Safe fallback with good compression</span>
</span><span id="__span-1-112"><a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>
</span><span id="__span-1-113"><a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_optimal_quality</span><span class="p">(</span>
</span><span id="__span-1-114"><a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-115"><a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-1-116"><a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>        <span class="n">device_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-1-117"><a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-1-118"><a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a><span class="w">        </span><span class="sd">"""Calculate optimal quality based on transformations and device"""</span>
</span><span id="__span-1-119"><a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>
</span><span id="__span-1-120"><a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>        <span class="n">base_quality</span> <span class="o">=</span> <span class="mi">85</span>
</span><span id="__span-1-121"><a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>
</span><span id="__span-1-122"><a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a>        <span class="c1"># Adjust based on output format</span>
</span><span id="__span-1-123"><a href="#__codelineno-1-123" id="__codelineno-1-123" name="__codelineno-1-123"></a>        <span class="n">format_type</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">,</span> <span class="s2">"jpeg"</span><span class="p">)</span>
</span><span id="__span-1-124"><a href="#__codelineno-1-124" id="__codelineno-1-124" name="__codelineno-1-124"></a>        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">"webp"</span><span class="p">:</span>
</span><span id="__span-1-125"><a href="#__codelineno-1-125" id="__codelineno-1-125" name="__codelineno-1-125"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="mi">80</span>  <span class="c1"># WebP can maintain quality at lower settings</span>
</span><span id="__span-1-126"><a href="#__codelineno-1-126" id="__codelineno-1-126" name="__codelineno-1-126"></a>        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">"avif"</span><span class="p">:</span>
</span><span id="__span-1-127"><a href="#__codelineno-1-127" id="__codelineno-1-127" name="__codelineno-1-127"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># AVIF has even better compression</span>
</span><span id="__span-1-128"><a href="#__codelineno-1-128" id="__codelineno-1-128" name="__codelineno-1-128"></a>        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">"png"</span><span class="p">:</span>
</span><span id="__span-1-129"><a href="#__codelineno-1-129" id="__codelineno-1-129" name="__codelineno-1-129"></a>            <span class="k">return</span> <span class="mi">95</span>  <span class="c1"># PNG is lossless, use high quality</span>
</span><span id="__span-1-130"><a href="#__codelineno-1-130" id="__codelineno-1-130" name="__codelineno-1-130"></a>
</span><span id="__span-1-131"><a href="#__codelineno-1-131" id="__codelineno-1-131" name="__codelineno-1-131"></a>        <span class="c1"># Adjust based on dimensions</span>
</span><span id="__span-1-132"><a href="#__codelineno-1-132" id="__codelineno-1-132" name="__codelineno-1-132"></a>        <span class="n">width</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"width"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-133"><a href="#__codelineno-1-133" id="__codelineno-1-133" name="__codelineno-1-133"></a>        <span class="n">height</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"height"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-134"><a href="#__codelineno-1-134" id="__codelineno-1-134" name="__codelineno-1-134"></a>
</span><span id="__span-1-135"><a href="#__codelineno-1-135" id="__codelineno-1-135" name="__codelineno-1-135"></a>        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">300</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">300</span><span class="p">:</span>
</span><span id="__span-1-136"><a href="#__codelineno-1-136" id="__codelineno-1-136" name="__codelineno-1-136"></a>            <span class="c1"># Small images need higher quality to avoid artifacts</span>
</span><span id="__span-1-137"><a href="#__codelineno-1-137" id="__codelineno-1-137" name="__codelineno-1-137"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">base_quality</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
</span><span id="__span-1-138"><a href="#__codelineno-1-138" id="__codelineno-1-138" name="__codelineno-1-138"></a>        <span class="k">elif</span> <span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">1200</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">1200</span><span class="p">:</span>
</span><span id="__span-1-139"><a href="#__codelineno-1-139" id="__codelineno-1-139" name="__codelineno-1-139"></a>            <span class="c1"># Large images can tolerate lower quality</span>
</span><span id="__span-1-140"><a href="#__codelineno-1-140" id="__codelineno-1-140" name="__codelineno-1-140"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_quality</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
</span><span id="__span-1-141"><a href="#__codelineno-1-141" id="__codelineno-1-141" name="__codelineno-1-141"></a>
</span><span id="__span-1-142"><a href="#__codelineno-1-142" id="__codelineno-1-142" name="__codelineno-1-142"></a>        <span class="c1"># Device-based adjustments</span>
</span><span id="__span-1-143"><a href="#__codelineno-1-143" id="__codelineno-1-143" name="__codelineno-1-143"></a>        <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"mobile"</span><span class="p">:</span>
</span><span id="__span-1-144"><a href="#__codelineno-1-144" id="__codelineno-1-144" name="__codelineno-1-144"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_quality</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
</span><span id="__span-1-145"><a href="#__codelineno-1-145" id="__codelineno-1-145" name="__codelineno-1-145"></a>        <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"print"</span><span class="p">:</span>
</span><span id="__span-1-146"><a href="#__codelineno-1-146" id="__codelineno-1-146" name="__codelineno-1-146"></a>            <span class="n">base_quality</span> <span class="o">=</span> <span class="mi">95</span>
</span><span id="__span-1-147"><a href="#__codelineno-1-147" id="__codelineno-1-147" name="__codelineno-1-147"></a>
</span><span id="__span-1-148"><a href="#__codelineno-1-148" id="__codelineno-1-148" name="__codelineno-1-148"></a>        <span class="k">return</span> <span class="n">base_quality</span>
</span><span id="__span-1-149"><a href="#__codelineno-1-149" id="__codelineno-1-149" name="__codelineno-1-149"></a>
</span><span id="__span-1-150"><a href="#__codelineno-1-150" id="__codelineno-1-150" name="__codelineno-1-150"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_art_direction_variants</span><span class="p">(</span>
</span><span id="__span-1-151"><a href="#__codelineno-1-151" id="__codelineno-1-151" name="__codelineno-1-151"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-152"><a href="#__codelineno-1-152" id="__codelineno-1-152" name="__codelineno-1-152"></a>        <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-153"><a href="#__codelineno-1-153" id="__codelineno-1-153" name="__codelineno-1-153"></a>        <span class="n">art_direction_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</span><span id="__span-1-154"><a href="#__codelineno-1-154" id="__codelineno-1-154" name="__codelineno-1-154"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-1-155"><a href="#__codelineno-1-155" id="__codelineno-1-155" name="__codelineno-1-155"></a><span class="w">        </span><span class="sd">"""Create art direction variants for responsive design"""</span>
</span><span id="__span-1-156"><a href="#__codelineno-1-156" id="__codelineno-1-156" name="__codelineno-1-156"></a>
</span><span id="__span-1-157"><a href="#__codelineno-1-157" id="__codelineno-1-157" name="__codelineno-1-157"></a>        <span class="n">variants</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-158"><a href="#__codelineno-1-158" id="__codelineno-1-158" name="__codelineno-1-158"></a>
</span><span id="__span-1-159"><a href="#__codelineno-1-159" id="__codelineno-1-159" name="__codelineno-1-159"></a>        <span class="k">for</span> <span class="n">variant_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">art_direction_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-1-160"><a href="#__codelineno-1-160" id="__codelineno-1-160" name="__codelineno-1-160"></a>            <span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-161"><a href="#__codelineno-1-161" id="__codelineno-1-161" name="__codelineno-1-161"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">"width"</span><span class="p">],</span>
</span><span id="__span-1-162"><a href="#__codelineno-1-162" id="__codelineno-1-162" name="__codelineno-1-162"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">"height"</span><span class="p">],</span>
</span><span id="__span-1-163"><a href="#__codelineno-1-163" id="__codelineno-1-163" name="__codelineno-1-163"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"crop"</span><span class="p">,</span> <span class="s2">"smart"</span><span class="p">),</span>
</span><span id="__span-1-164"><a href="#__codelineno-1-164" id="__codelineno-1-164" name="__codelineno-1-164"></a>                <span class="s2">"quality"</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quality"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">),</span>
</span><span id="__span-1-165"><a href="#__codelineno-1-165" id="__codelineno-1-165" name="__codelineno-1-165"></a>                <span class="s2">"format"</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"format"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">)</span>
</span><span id="__span-1-166"><a href="#__codelineno-1-166" id="__codelineno-1-166" name="__codelineno-1-166"></a>            <span class="p">}</span>
</span><span id="__span-1-167"><a href="#__codelineno-1-167" id="__codelineno-1-167" name="__codelineno-1-167"></a>
</span><span id="__span-1-168"><a href="#__codelineno-1-168" id="__codelineno-1-168" name="__codelineno-1-168"></a>            <span class="c1"># Apply focal point if specified</span>
</span><span id="__span-1-169"><a href="#__codelineno-1-169" id="__codelineno-1-169" name="__codelineno-1-169"></a>            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"focal_point"</span><span class="p">):</span>
</span><span id="__span-1-170"><a href="#__codelineno-1-170" id="__codelineno-1-170" name="__codelineno-1-170"></a>                <span class="n">transformations</span><span class="p">[</span><span class="s2">"gravity"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'focal_point'</span><span class="p">][</span><span class="s1">'x'</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'focal_point'</span><span class="p">][</span><span class="s1">'y'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-1-171"><a href="#__codelineno-1-171" id="__codelineno-1-171" name="__codelineno-1-171"></a>
</span><span id="__span-1-172"><a href="#__codelineno-1-172" id="__codelineno-1-172" name="__codelineno-1-172"></a>            <span class="n">variant_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span>
</span><span id="__span-1-173"><a href="#__codelineno-1-173" id="__codelineno-1-173" name="__codelineno-1-173"></a>                <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-1-174"><a href="#__codelineno-1-174" id="__codelineno-1-174" name="__codelineno-1-174"></a>                <span class="n">transformations</span>
</span><span id="__span-1-175"><a href="#__codelineno-1-175" id="__codelineno-1-175" name="__codelineno-1-175"></a>            <span class="p">)</span>
</span><span id="__span-1-176"><a href="#__codelineno-1-176" id="__codelineno-1-176" name="__codelineno-1-176"></a>
</span><span id="__span-1-177"><a href="#__codelineno-1-177" id="__codelineno-1-177" name="__codelineno-1-177"></a>            <span class="n">variants</span><span class="p">[</span><span class="n">variant_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variant_url</span>
</span><span id="__span-1-178"><a href="#__codelineno-1-178" id="__codelineno-1-178" name="__codelineno-1-178"></a>
</span><span id="__span-1-179"><a href="#__codelineno-1-179" id="__codelineno-1-179" name="__codelineno-1-179"></a>        <span class="k">return</span> <span class="n">variants</span>
</span><span id="__span-1-180"><a href="#__codelineno-1-180" id="__codelineno-1-180" name="__codelineno-1-180"></a>
</span><span id="__span-1-181"><a href="#__codelineno-1-181" id="__codelineno-1-181" name="__codelineno-1-181"></a><span class="c1"># Usage examples</span>
</span><span id="__span-1-182"><a href="#__codelineno-1-182" id="__codelineno-1-182" name="__codelineno-1-182"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_educational_content_image_urls</span><span class="p">(</span>
</span><span id="__span-1-183"><a href="#__codelineno-1-183" id="__codelineno-1-183" name="__codelineno-1-183"></a>    <span class="n">storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-1-184"><a href="#__codelineno-1-184" id="__codelineno-1-184" name="__codelineno-1-184"></a>    <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span>
</span><span id="__span-1-185"><a href="#__codelineno-1-185" id="__codelineno-1-185" name="__codelineno-1-185"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-1-186"><a href="#__codelineno-1-186" id="__codelineno-1-186" name="__codelineno-1-186"></a><span class="w">    </span><span class="sd">"""Get optimized image URLs for educational content"""</span>
</span><span id="__span-1-187"><a href="#__codelineno-1-187" id="__codelineno-1-187" name="__codelineno-1-187"></a>
</span><span id="__span-1-188"><a href="#__codelineno-1-188" id="__codelineno-1-188" name="__codelineno-1-188"></a>    <span class="n">transformer</span> <span class="o">=</span> <span class="n">ImageTransformationEngine</span><span class="p">(</span><span class="n">cdn_manager</span><span class="p">)</span>
</span><span id="__span-1-189"><a href="#__codelineno-1-189" id="__codelineno-1-189" name="__codelineno-1-189"></a>
</span><span id="__span-1-190"><a href="#__codelineno-1-190" id="__codelineno-1-190" name="__codelineno-1-190"></a>    <span class="c1"># Main content image</span>
</span><span id="__span-1-191"><a href="#__codelineno-1-191" id="__codelineno-1-191" name="__codelineno-1-191"></a>    <span class="n">main_url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform_image_url</span><span class="p">(</span>
</span><span id="__span-1-192"><a href="#__codelineno-1-192" id="__codelineno-1-192" name="__codelineno-1-192"></a>        <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-1-193"><a href="#__codelineno-1-193" id="__codelineno-1-193" name="__codelineno-1-193"></a>        <span class="p">{</span>
</span><span id="__span-1-194"><a href="#__codelineno-1-194" id="__codelineno-1-194" name="__codelineno-1-194"></a>            <span class="s2">"width"</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
</span><span id="__span-1-195"><a href="#__codelineno-1-195" id="__codelineno-1-195" name="__codelineno-1-195"></a>            <span class="s2">"height"</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="__span-1-196"><a href="#__codelineno-1-196" id="__codelineno-1-196" name="__codelineno-1-196"></a>            <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"smart"</span><span class="p">,</span>
</span><span id="__span-1-197"><a href="#__codelineno-1-197" id="__codelineno-1-197" name="__codelineno-1-197"></a>            <span class="s2">"quality"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">,</span>
</span><span id="__span-1-198"><a href="#__codelineno-1-198" id="__codelineno-1-198" name="__codelineno-1-198"></a>            <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span>
</span><span id="__span-1-199"><a href="#__codelineno-1-199" id="__codelineno-1-199" name="__codelineno-1-199"></a>        <span class="p">}</span>
</span><span id="__span-1-200"><a href="#__codelineno-1-200" id="__codelineno-1-200" name="__codelineno-1-200"></a>    <span class="p">)</span>
</span><span id="__span-1-201"><a href="#__codelineno-1-201" id="__codelineno-1-201" name="__codelineno-1-201"></a>
</span><span id="__span-1-202"><a href="#__codelineno-1-202" id="__codelineno-1-202" name="__codelineno-1-202"></a>    <span class="c1"># Responsive variants</span>
</span><span id="__span-1-203"><a href="#__codelineno-1-203" id="__codelineno-1-203" name="__codelineno-1-203"></a>    <span class="n">responsive_urls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_responsive_urls</span><span class="p">(</span>
</span><span id="__span-1-204"><a href="#__codelineno-1-204" id="__codelineno-1-204" name="__codelineno-1-204"></a>        <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-1-205"><a href="#__codelineno-1-205" id="__codelineno-1-205" name="__codelineno-1-205"></a>        <span class="n">breakpoints</span><span class="o">=</span><span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1440</span><span class="p">],</span>
</span><span id="__span-1-206"><a href="#__codelineno-1-206" id="__codelineno-1-206" name="__codelineno-1-206"></a>        <span class="n">base_transformations</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-1-207"><a href="#__codelineno-1-207" id="__codelineno-1-207" name="__codelineno-1-207"></a>            <span class="s2">"quality"</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
</span><span id="__span-1-208"><a href="#__codelineno-1-208" id="__codelineno-1-208" name="__codelineno-1-208"></a>            <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">,</span>
</span><span id="__span-1-209"><a href="#__codelineno-1-209" id="__codelineno-1-209" name="__codelineno-1-209"></a>            <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"smart"</span>
</span><span id="__span-1-210"><a href="#__codelineno-1-210" id="__codelineno-1-210" name="__codelineno-1-210"></a>        <span class="p">}</span>
</span><span id="__span-1-211"><a href="#__codelineno-1-211" id="__codelineno-1-211" name="__codelineno-1-211"></a>    <span class="p">)</span>
</span><span id="__span-1-212"><a href="#__codelineno-1-212" id="__codelineno-1-212" name="__codelineno-1-212"></a>
</span><span id="__span-1-213"><a href="#__codelineno-1-213" id="__codelineno-1-213" name="__codelineno-1-213"></a>    <span class="c1"># Art direction variants</span>
</span><span id="__span-1-214"><a href="#__codelineno-1-214" id="__codelineno-1-214" name="__codelineno-1-214"></a>    <span class="n">art_direction_variants</span> <span class="o">=</span> <span class="k">await</span> <span class="n">transformer</span><span class="o">.</span><span class="n">create_art_direction_variants</span><span class="p">(</span>
</span><span id="__span-1-215"><a href="#__codelineno-1-215" id="__codelineno-1-215" name="__codelineno-1-215"></a>        <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-1-216"><a href="#__codelineno-1-216" id="__codelineno-1-216" name="__codelineno-1-216"></a>        <span class="p">{</span>
</span><span id="__span-1-217"><a href="#__codelineno-1-217" id="__codelineno-1-217" name="__codelineno-1-217"></a>            <span class="s2">"mobile"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-218"><a href="#__codelineno-1-218" id="__codelineno-1-218" name="__codelineno-1-218"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span id="__span-1-219"><a href="#__codelineno-1-219" id="__codelineno-1-219" name="__codelineno-1-219"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-1-220"><a href="#__codelineno-1-220" id="__codelineno-1-220" name="__codelineno-1-220"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span><span class="p">,</span>
</span><span id="__span-1-221"><a href="#__codelineno-1-221" id="__codelineno-1-221" name="__codelineno-1-221"></a>                <span class="s2">"focal_point"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>  <span class="c1"># Focus on upper portion</span>
</span><span id="__span-1-222"><a href="#__codelineno-1-222" id="__codelineno-1-222" name="__codelineno-1-222"></a>            <span class="p">},</span>
</span><span id="__span-1-223"><a href="#__codelineno-1-223" id="__codelineno-1-223" name="__codelineno-1-223"></a>            <span class="s2">"desktop"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-1-224"><a href="#__codelineno-1-224" id="__codelineno-1-224" name="__codelineno-1-224"></a>                <span class="s2">"width"</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
</span><span id="__span-1-225"><a href="#__codelineno-1-225" id="__codelineno-1-225" name="__codelineno-1-225"></a>                <span class="s2">"height"</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span id="__span-1-226"><a href="#__codelineno-1-226" id="__codelineno-1-226" name="__codelineno-1-226"></a>                <span class="s2">"crop"</span><span class="p">:</span> <span class="s2">"center"</span><span class="p">,</span>
</span><span id="__span-1-227"><a href="#__codelineno-1-227" id="__codelineno-1-227" name="__codelineno-1-227"></a>                <span class="s2">"focal_point"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>  <span class="c1"># Center focus</span>
</span><span id="__span-1-228"><a href="#__codelineno-1-228" id="__codelineno-1-228" name="__codelineno-1-228"></a>            <span class="p">}</span>
</span><span id="__span-1-229"><a href="#__codelineno-1-229" id="__codelineno-1-229" name="__codelineno-1-229"></a>        <span class="p">}</span>
</span><span id="__span-1-230"><a href="#__codelineno-1-230" id="__codelineno-1-230" name="__codelineno-1-230"></a>    <span class="p">)</span>
</span><span id="__span-1-231"><a href="#__codelineno-1-231" id="__codelineno-1-231" name="__codelineno-1-231"></a>
</span><span id="__span-1-232"><a href="#__codelineno-1-232" id="__codelineno-1-232" name="__codelineno-1-232"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-233"><a href="#__codelineno-1-233" id="__codelineno-1-233" name="__codelineno-1-233"></a>        <span class="s2">"main_url"</span><span class="p">:</span> <span class="n">main_url</span><span class="p">,</span>
</span><span id="__span-1-234"><a href="#__codelineno-1-234" id="__codelineno-1-234" name="__codelineno-1-234"></a>        <span class="s2">"responsive"</span><span class="p">:</span> <span class="n">responsive_urls</span><span class="p">,</span>
</span><span id="__span-1-235"><a href="#__codelineno-1-235" id="__codelineno-1-235" name="__codelineno-1-235"></a>        <span class="s2">"art_direction"</span><span class="p">:</span> <span class="n">art_direction_variants</span><span class="p">,</span>
</span><span id="__span-1-236"><a href="#__codelineno-1-236" id="__codelineno-1-236" name="__codelineno-1-236"></a>        <span class="s2">"thumbnail"</span><span class="p">:</span> <span class="k">await</span> <span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_preset_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">"thumbnail"</span><span class="p">),</span>
</span><span id="__span-1-237"><a href="#__codelineno-1-237" id="__codelineno-1-237" name="__codelineno-1-237"></a>        <span class="s2">"preview"</span><span class="p">:</span> <span class="k">await</span> <span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_preset_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">"preview"</span><span class="p">)</span>
</span><span id="__span-1-238"><a href="#__codelineno-1-238" id="__codelineno-1-238" name="__codelineno-1-238"></a>    <span class="p">}</span>
</span></code></pre></div> <h2 id="cache-strategies">Cache Strategies<a class="headerlink" href="#cache-strategies" title="Permanent link">¶</a></h2> <h3 id="intelligent-caching-system">Intelligent Caching System<a class="headerlink" href="#intelligent-caching-system" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CacheStrategy</span><span class="p">:</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="sd">"""Defines caching strategies for different content types"""</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>            <span class="s2">"educational_content"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>                <span class="s2">"ttl"</span><span class="p">:</span> <span class="mi">604800</span><span class="p">,</span>  <span class="c1"># 7 days</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>                <span class="s2">"stale_while_revalidate"</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>  <span class="c1"># 1 day</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>                <span class="s2">"cache_control"</span><span class="p">:</span> <span class="s2">"public, max-age=604800, stale-while-revalidate=86400"</span><span class="p">,</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>                <span class="s2">"vary_headers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Accept"</span><span class="p">,</span> <span class="s2">"Accept-Encoding"</span><span class="p">],</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>                <span class="s2">"edge_cache_tag"</span><span class="p">:</span> <span class="s2">"edu-content"</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>            <span class="p">},</span>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="s2">"student_submission"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>                <span class="s2">"ttl"</span><span class="p">:</span> <span class="mi">172800</span><span class="p">,</span>  <span class="c1"># 2 days</span>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>                <span class="s2">"stale_while_revalidate"</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>                <span class="s2">"cache_control"</span><span class="p">:</span> <span class="s2">"private, max-age=172800, stale-while-revalidate=3600"</span><span class="p">,</span>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>                <span class="s2">"vary_headers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Authorization"</span><span class="p">],</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>                <span class="s2">"edge_cache_tag"</span><span class="p">:</span> <span class="s2">"student-work"</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>            <span class="p">},</span>
</span><span id="__span-2-24"><a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>            <span class="s2">"media_resource"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-25"><a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>                <span class="s2">"ttl"</span><span class="p">:</span> <span class="mi">2592000</span><span class="p">,</span>  <span class="c1"># 30 days</span>
</span><span id="__span-2-26"><a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>                <span class="s2">"stale_while_revalidate"</span><span class="p">:</span> <span class="mi">604800</span><span class="p">,</span>  <span class="c1"># 7 days</span>
</span><span id="__span-2-27"><a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>                <span class="s2">"cache_control"</span><span class="p">:</span> <span class="s2">"public, max-age=2592000, stale-while-revalidate=604800"</span><span class="p">,</span>
</span><span id="__span-2-28"><a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>                <span class="s2">"vary_headers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Accept"</span><span class="p">,</span> <span class="s2">"Accept-Encoding"</span><span class="p">],</span>
</span><span id="__span-2-29"><a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>                <span class="s2">"edge_cache_tag"</span><span class="p">:</span> <span class="s2">"media"</span>
</span><span id="__span-2-30"><a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>            <span class="p">},</span>
</span><span id="__span-2-31"><a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>            <span class="s2">"avatar"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-32"><a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>                <span class="s2">"ttl"</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>  <span class="c1"># 1 day</span>
</span><span id="__span-2-33"><a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>                <span class="s2">"stale_while_revalidate"</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-2-34"><a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>                <span class="s2">"cache_control"</span><span class="p">:</span> <span class="s2">"public, max-age=86400, stale-while-revalidate=3600"</span><span class="p">,</span>
</span><span id="__span-2-35"><a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a>                <span class="s2">"vary_headers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Accept"</span><span class="p">],</span>
</span><span id="__span-2-36"><a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>                <span class="s2">"edge_cache_tag"</span><span class="p">:</span> <span class="s2">"avatars"</span>
</span><span id="__span-2-37"><a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>            <span class="p">},</span>
</span><span id="__span-2-38"><a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>            <span class="s2">"temporary"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-39"><a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>                <span class="s2">"ttl"</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-2-40"><a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>                <span class="s2">"stale_while_revalidate"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes</span>
</span><span id="__span-2-41"><a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>                <span class="s2">"cache_control"</span><span class="p">:</span> <span class="s2">"public, max-age=3600, stale-while-revalidate=300"</span><span class="p">,</span>
</span><span id="__span-2-42"><a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>                <span class="s2">"vary_headers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Accept"</span><span class="p">],</span>
</span><span id="__span-2-43"><a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>                <span class="s2">"edge_cache_tag"</span><span class="p">:</span> <span class="s2">"temp"</span>
</span><span id="__span-2-44"><a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>            <span class="p">}</span>
</span><span id="__span-2-45"><a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>        <span class="p">}</span>
</span><span id="__span-2-46"><a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>
</span><span id="__span-2-47"><a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geographic_cache_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-48"><a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>            <span class="s2">"us"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"high"</span><span class="p">,</span> <span class="s2">"replication"</span><span class="p">:</span> <span class="s2">"immediate"</span><span class="p">},</span>
</span><span id="__span-2-49"><a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>            <span class="s2">"eu"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"high"</span><span class="p">,</span> <span class="s2">"replication"</span><span class="p">:</span> <span class="s2">"immediate"</span><span class="p">},</span>
</span><span id="__span-2-50"><a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>            <span class="s2">"asia"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"medium"</span><span class="p">,</span> <span class="s2">"replication"</span><span class="p">:</span> <span class="s2">"delayed"</span><span class="p">},</span>
</span><span id="__span-2-51"><a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>            <span class="s2">"others"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"low"</span><span class="p">,</span> <span class="s2">"replication"</span><span class="p">:</span> <span class="s2">"on-demand"</span><span class="p">}</span>
</span><span id="__span-2-52"><a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>        <span class="p">}</span>
</span><span id="__span-2-53"><a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>
</span><span id="__span-2-54"><a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cache_headers</span><span class="p">(</span>
</span><span id="__span-2-55"><a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-56"><a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a>        <span class="n">file_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-2-57"><a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a>        <span class="n">file_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-2-58"><a href="#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a>        <span class="n">user_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-59"><a href="#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-2-60"><a href="#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a><span class="w">        </span><span class="sd">"""Generate appropriate cache headers for content"""</span>
</span><span id="__span-2-61"><a href="#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a>
</span><span id="__span-2-62"><a href="#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a>        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_rules</span><span class="p">[</span><span class="s2">"media_resource"</span><span class="p">])</span>
</span><span id="__span-2-63"><a href="#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a>
</span><span id="__span-2-64"><a href="#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-65"><a href="#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a>            <span class="s2">"Cache-Control"</span><span class="p">:</span> <span class="n">rules</span><span class="p">[</span><span class="s2">"cache_control"</span><span class="p">],</span>
</span><span id="__span-2-66"><a href="#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a>            <span class="s2">"Vary"</span><span class="p">:</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rules</span><span class="p">[</span><span class="s2">"vary_headers"</span><span class="p">]),</span>
</span><span id="__span-2-67"><a href="#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a>            <span class="s2">"X-Cache-Tag"</span><span class="p">:</span> <span class="n">rules</span><span class="p">[</span><span class="s2">"edge_cache_tag"</span><span class="p">]</span>
</span><span id="__span-2-68"><a href="#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a>        <span class="p">}</span>
</span><span id="__span-2-69"><a href="#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a>
</span><span id="__span-2-70"><a href="#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a>        <span class="c1"># Add ETag for cache validation</span>
</span><span id="__span-2-71"><a href="#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a>        <span class="n">etag_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">file_category</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-2-72"><a href="#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a>        <span class="n">headers</span><span class="p">[</span><span class="s2">"ETag"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'"</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">etag_data</span><span class="p">)</span><span class="si">}</span><span class="s1">"'</span>
</span><span id="__span-2-73"><a href="#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a>
</span><span id="__span-2-74"><a href="#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a>        <span class="c1"># Add Last-Modified</span>
</span><span id="__span-2-75"><a href="#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a>        <span class="n">headers</span><span class="p">[</span><span class="s2">"Last-Modified"</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT"</span><span class="p">)</span>
</span><span id="__span-2-76"><a href="#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a>
</span><span id="__span-2-77"><a href="#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a>        <span class="c1"># Adjust for user context</span>
</span><span id="__span-2-78"><a href="#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a>        <span class="k">if</span> <span class="n">user_context</span><span class="p">:</span>
</span><span id="__span-2-79"><a href="#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a>            <span class="k">if</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"role"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"student"</span><span class="p">:</span>
</span><span id="__span-2-80"><a href="#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a>                <span class="c1"># Student content might need shorter cache times</span>
</span><span id="__span-2-81"><a href="#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a>                <span class="n">headers</span><span class="p">[</span><span class="s2">"Cache-Control"</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">"Cache-Control"</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"max-age=604800"</span><span class="p">,</span> <span class="s2">"max-age=172800"</span><span class="p">)</span>
</span><span id="__span-2-82"><a href="#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a>            <span class="k">elif</span> <span class="n">file_category</span> <span class="o">==</span> <span class="s2">"student_submission"</span> <span class="ow">and</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">):</span>
</span><span id="__span-2-83"><a href="#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a>                <span class="c1"># Personal content should include user ID in vary</span>
</span><span id="__span-2-84"><a href="#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a>                <span class="n">headers</span><span class="p">[</span><span class="s2">"Vary"</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">", X-User-ID"</span>
</span><span id="__span-2-85"><a href="#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a>
</span><span id="__span-2-86"><a href="#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a>        <span class="k">return</span> <span class="n">headers</span>
</span><span id="__span-2-87"><a href="#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a>
</span><span id="__span-2-88"><a href="#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">SmartCacheManager</span><span class="p">:</span>
</span><span id="__span-2-89"><a href="#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a><span class="w">    </span><span class="sd">"""Manages intelligent caching across CDN network"""</span>
</span><span id="__span-2-90"><a href="#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a>
</span><span id="__span-2-91"><a href="#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span><span class="p">):</span>
</span><span id="__span-2-92"><a href="#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">cdn_manager</span>
</span><span id="__span-2-93"><a href="#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_strategy</span> <span class="o">=</span> <span class="n">CacheStrategy</span><span class="p">()</span>
</span><span id="__span-2-94"><a href="#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_analytics</span> <span class="o">=</span> <span class="n">CacheAnalytics</span><span class="p">()</span>
</span><span id="__span-2-95"><a href="#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a>
</span><span id="__span-2-96"><a href="#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">warmup_cache</span><span class="p">(</span>
</span><span id="__span-2-97"><a href="#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-98"><a href="#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a>        <span class="n">storage_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-2-99"><a href="#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a>        <span class="n">regions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-2-100"><a href="#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a>        <span class="n">transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-101"><a href="#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-102"><a href="#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a><span class="w">        </span><span class="sd">"""Preemptively warm cache for important content"""</span>
</span><span id="__span-2-103"><a href="#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a>
</span><span id="__span-2-104"><a href="#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="__span-2-105"><a href="#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a>            <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"us"</span><span class="p">,</span> <span class="s2">"eu"</span><span class="p">,</span> <span class="s2">"asia"</span><span class="p">]</span>
</span><span id="__span-2-106"><a href="#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a>
</span><span id="__span-2-107"><a href="#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a>        <span class="n">warmup_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-108"><a href="#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a>            <span class="s2">"total_urls"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-2-109"><a href="#__codelineno-2-109" id="__codelineno-2-109" name="__codelineno-2-109"></a>            <span class="s2">"successful_warmups"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-2-110"><a href="#__codelineno-2-110" id="__codelineno-2-110" name="__codelineno-2-110"></a>            <span class="s2">"failed_warmups"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-2-111"><a href="#__codelineno-2-111" id="__codelineno-2-111" name="__codelineno-2-111"></a>            <span class="s2">"regions"</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-2-112"><a href="#__codelineno-2-112" id="__codelineno-2-112" name="__codelineno-2-112"></a>            <span class="s2">"duration"</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="__span-2-113"><a href="#__codelineno-2-113" id="__codelineno-2-113" name="__codelineno-2-113"></a>        <span class="p">}</span>
</span><span id="__span-2-114"><a href="#__codelineno-2-114" id="__codelineno-2-114" name="__codelineno-2-114"></a>
</span><span id="__span-2-115"><a href="#__codelineno-2-115" id="__codelineno-2-115" name="__codelineno-2-115"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-2-116"><a href="#__codelineno-2-116" id="__codelineno-2-116" name="__codelineno-2-116"></a>
</span><span id="__span-2-117"><a href="#__codelineno-2-117" id="__codelineno-2-117" name="__codelineno-2-117"></a>        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="__span-2-118"><a href="#__codelineno-2-118" id="__codelineno-2-118" name="__codelineno-2-118"></a>            <span class="n">region_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-119"><a href="#__codelineno-2-119" id="__codelineno-2-119" name="__codelineno-2-119"></a>
</span><span id="__span-2-120"><a href="#__codelineno-2-120" id="__codelineno-2-120" name="__codelineno-2-120"></a>            <span class="k">for</span> <span class="n">storage_path</span> <span class="ow">in</span> <span class="n">storage_paths</span><span class="p">:</span>
</span><span id="__span-2-121"><a href="#__codelineno-2-121" id="__codelineno-2-121" name="__codelineno-2-121"></a>                <span class="c1"># Generate base URL</span>
</span><span id="__span-2-122"><a href="#__codelineno-2-122" id="__codelineno-2-122" name="__codelineno-2-122"></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>
</span><span id="__span-2-123"><a href="#__codelineno-2-123" id="__codelineno-2-123" name="__codelineno-2-123"></a>                <span class="n">warmup_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_url</span><span class="p">]</span>
</span><span id="__span-2-124"><a href="#__codelineno-2-124" id="__codelineno-2-124" name="__codelineno-2-124"></a>
</span><span id="__span-2-125"><a href="#__codelineno-2-125" id="__codelineno-2-125" name="__codelineno-2-125"></a>                <span class="c1"># Add transformation variants if specified</span>
</span><span id="__span-2-126"><a href="#__codelineno-2-126" id="__codelineno-2-126" name="__codelineno-2-126"></a>                <span class="k">if</span> <span class="n">transformations</span><span class="p">:</span>
</span><span id="__span-2-127"><a href="#__codelineno-2-127" id="__codelineno-2-127" name="__codelineno-2-127"></a>                    <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">transformations</span><span class="p">:</span>
</span><span id="__span-2-128"><a href="#__codelineno-2-128" id="__codelineno-2-128" name="__codelineno-2-128"></a>                        <span class="n">transform_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span>
</span><span id="__span-2-129"><a href="#__codelineno-2-129" id="__codelineno-2-129" name="__codelineno-2-129"></a>                            <span class="n">storage_path</span><span class="p">,</span>
</span><span id="__span-2-130"><a href="#__codelineno-2-130" id="__codelineno-2-130" name="__codelineno-2-130"></a>                            <span class="n">transform</span>
</span><span id="__span-2-131"><a href="#__codelineno-2-131" id="__codelineno-2-131" name="__codelineno-2-131"></a>                        <span class="p">)</span>
</span><span id="__span-2-132"><a href="#__codelineno-2-132" id="__codelineno-2-132" name="__codelineno-2-132"></a>                        <span class="n">warmup_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform_url</span><span class="p">)</span>
</span><span id="__span-2-133"><a href="#__codelineno-2-133" id="__codelineno-2-133" name="__codelineno-2-133"></a>
</span><span id="__span-2-134"><a href="#__codelineno-2-134" id="__codelineno-2-134" name="__codelineno-2-134"></a>                <span class="c1"># Warmup each URL in the region</span>
</span><span id="__span-2-135"><a href="#__codelineno-2-135" id="__codelineno-2-135" name="__codelineno-2-135"></a>                <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">warmup_urls</span><span class="p">:</span>
</span><span id="__span-2-136"><a href="#__codelineno-2-136" id="__codelineno-2-136" name="__codelineno-2-136"></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-137"><a href="#__codelineno-2-137" id="__codelineno-2-137" name="__codelineno-2-137"></a>                        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_url_in_region</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</span><span id="__span-2-138"><a href="#__codelineno-2-138" id="__codelineno-2-138" name="__codelineno-2-138"></a>                        <span class="n">region_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-139"><a href="#__codelineno-2-139" id="__codelineno-2-139" name="__codelineno-2-139"></a>                            <span class="s2">"url"</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="__span-2-140"><a href="#__codelineno-2-140" id="__codelineno-2-140" name="__codelineno-2-140"></a>                            <span class="s2">"success"</span><span class="p">:</span> <span class="n">success</span>
</span><span id="__span-2-141"><a href="#__codelineno-2-141" id="__codelineno-2-141" name="__codelineno-2-141"></a>                        <span class="p">})</span>
</span><span id="__span-2-142"><a href="#__codelineno-2-142" id="__codelineno-2-142" name="__codelineno-2-142"></a>
</span><span id="__span-2-143"><a href="#__codelineno-2-143" id="__codelineno-2-143" name="__codelineno-2-143"></a>                        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="__span-2-144"><a href="#__codelineno-2-144" id="__codelineno-2-144" name="__codelineno-2-144"></a>                            <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"successful_warmups"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-2-145"><a href="#__codelineno-2-145" id="__codelineno-2-145" name="__codelineno-2-145"></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-146"><a href="#__codelineno-2-146" id="__codelineno-2-146" name="__codelineno-2-146"></a>                            <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"failed_warmups"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-2-147"><a href="#__codelineno-2-147" id="__codelineno-2-147" name="__codelineno-2-147"></a>
</span><span id="__span-2-148"><a href="#__codelineno-2-148" id="__codelineno-2-148" name="__codelineno-2-148"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-149"><a href="#__codelineno-2-149" id="__codelineno-2-149" name="__codelineno-2-149"></a>                        <span class="n">region_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-150"><a href="#__codelineno-2-150" id="__codelineno-2-150" name="__codelineno-2-150"></a>                            <span class="s2">"url"</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="__span-2-151"><a href="#__codelineno-2-151" id="__codelineno-2-151" name="__codelineno-2-151"></a>                            <span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-2-152"><a href="#__codelineno-2-152" id="__codelineno-2-152" name="__codelineno-2-152"></a>                            <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-2-153"><a href="#__codelineno-2-153" id="__codelineno-2-153" name="__codelineno-2-153"></a>                        <span class="p">})</span>
</span><span id="__span-2-154"><a href="#__codelineno-2-154" id="__codelineno-2-154" name="__codelineno-2-154"></a>                        <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"failed_warmups"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-2-155"><a href="#__codelineno-2-155" id="__codelineno-2-155" name="__codelineno-2-155"></a>
</span><span id="__span-2-156"><a href="#__codelineno-2-156" id="__codelineno-2-156" name="__codelineno-2-156"></a>                    <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"total_urls"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-2-157"><a href="#__codelineno-2-157" id="__codelineno-2-157" name="__codelineno-2-157"></a>
</span><span id="__span-2-158"><a href="#__codelineno-2-158" id="__codelineno-2-158" name="__codelineno-2-158"></a>            <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"regions"</span><span class="p">][</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_results</span>
</span><span id="__span-2-159"><a href="#__codelineno-2-159" id="__codelineno-2-159" name="__codelineno-2-159"></a>
</span><span id="__span-2-160"><a href="#__codelineno-2-160" id="__codelineno-2-160" name="__codelineno-2-160"></a>        <span class="n">warmup_results</span><span class="p">[</span><span class="s2">"duration"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="__span-2-161"><a href="#__codelineno-2-161" id="__codelineno-2-161" name="__codelineno-2-161"></a>
</span><span id="__span-2-162"><a href="#__codelineno-2-162" id="__codelineno-2-162" name="__codelineno-2-162"></a>        <span class="k">return</span> <span class="n">warmup_results</span>
</span><span id="__span-2-163"><a href="#__codelineno-2-163" id="__codelineno-2-163" name="__codelineno-2-163"></a>
</span><span id="__span-2-164"><a href="#__codelineno-2-164" id="__codelineno-2-164" name="__codelineno-2-164"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_warmup_url_in_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-2-165"><a href="#__codelineno-2-165" id="__codelineno-2-165" name="__codelineno-2-165"></a><span class="w">        </span><span class="sd">"""Warmup a specific URL in a specific region"""</span>
</span><span id="__span-2-166"><a href="#__codelineno-2-166" id="__codelineno-2-166" name="__codelineno-2-166"></a>
</span><span id="__span-2-167"><a href="#__codelineno-2-167" id="__codelineno-2-167" name="__codelineno-2-167"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-168"><a href="#__codelineno-2-168" id="__codelineno-2-168" name="__codelineno-2-168"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
</span><span id="__span-2-169"><a href="#__codelineno-2-169" id="__codelineno-2-169" name="__codelineno-2-169"></a>
</span><span id="__span-2-170"><a href="#__codelineno-2-170" id="__codelineno-2-170" name="__codelineno-2-170"></a>            <span class="c1"># Use region-specific headers to target specific PoPs</span>
</span><span id="__span-2-171"><a href="#__codelineno-2-171" id="__codelineno-2-171" name="__codelineno-2-171"></a>            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-172"><a href="#__codelineno-2-172" id="__codelineno-2-172" name="__codelineno-2-172"></a>                <span class="s2">"User-Agent"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"ToolBoxAI-CacheWarmup/1.0 (Region: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">)"</span><span class="p">,</span>
</span><span id="__span-2-173"><a href="#__codelineno-2-173" id="__codelineno-2-173" name="__codelineno-2-173"></a>                <span class="s2">"Cache-Control"</span><span class="p">:</span> <span class="s2">"no-cache"</span><span class="p">,</span>
</span><span id="__span-2-174"><a href="#__codelineno-2-174" id="__codelineno-2-174" name="__codelineno-2-174"></a>                <span class="s2">"CF-IPCountry"</span><span class="p">:</span> <span class="n">region</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>  <span class="c1"># Cloudflare country hint</span>
</span><span id="__span-2-175"><a href="#__codelineno-2-175" id="__codelineno-2-175" name="__codelineno-2-175"></a>                <span class="s2">"X-Forwarded-For"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_region_ip</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>  <span class="c1"># IP hint for region</span>
</span><span id="__span-2-176"><a href="#__codelineno-2-176" id="__codelineno-2-176" name="__codelineno-2-176"></a>            <span class="p">}</span>
</span><span id="__span-2-177"><a href="#__codelineno-2-177" id="__codelineno-2-177" name="__codelineno-2-177"></a>
</span><span id="__span-2-178"><a href="#__codelineno-2-178" id="__codelineno-2-178" name="__codelineno-2-178"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-2-179"><a href="#__codelineno-2-179" id="__codelineno-2-179" name="__codelineno-2-179"></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-2-180"><a href="#__codelineno-2-180" id="__codelineno-2-180" name="__codelineno-2-180"></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-2-181"><a href="#__codelineno-2-181" id="__codelineno-2-181" name="__codelineno-2-181"></a>                        <span class="c1"># Consume the response to ensure it's cached</span>
</span><span id="__span-2-182"><a href="#__codelineno-2-182" id="__codelineno-2-182" name="__codelineno-2-182"></a>                        <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-2-183"><a href="#__codelineno-2-183" id="__codelineno-2-183" name="__codelineno-2-183"></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-2-184"><a href="#__codelineno-2-184" id="__codelineno-2-184" name="__codelineno-2-184"></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-185"><a href="#__codelineno-2-185" id="__codelineno-2-185" name="__codelineno-2-185"></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-2-186"><a href="#__codelineno-2-186" id="__codelineno-2-186" name="__codelineno-2-186"></a>
</span><span id="__span-2-187"><a href="#__codelineno-2-187" id="__codelineno-2-187" name="__codelineno-2-187"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-188"><a href="#__codelineno-2-188" id="__codelineno-2-188" name="__codelineno-2-188"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cache warmup failed for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-2-189"><a href="#__codelineno-2-189" id="__codelineno-2-189" name="__codelineno-2-189"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-2-190"><a href="#__codelineno-2-190" id="__codelineno-2-190" name="__codelineno-2-190"></a>
</span><span id="__span-2-191"><a href="#__codelineno-2-191" id="__codelineno-2-191" name="__codelineno-2-191"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_region_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-192"><a href="#__codelineno-2-192" id="__codelineno-2-192" name="__codelineno-2-192"></a><span class="w">        </span><span class="sd">"""Get representative IP for region (for testing)"""</span>
</span><span id="__span-2-193"><a href="#__codelineno-2-193" id="__codelineno-2-193" name="__codelineno-2-193"></a>
</span><span id="__span-2-194"><a href="#__codelineno-2-194" id="__codelineno-2-194" name="__codelineno-2-194"></a>        <span class="n">region_ips</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-195"><a href="#__codelineno-2-195" id="__codelineno-2-195" name="__codelineno-2-195"></a>            <span class="s2">"us"</span><span class="p">:</span> <span class="s2">"8.8.8.8"</span><span class="p">,</span>      <span class="c1"># US</span>
</span><span id="__span-2-196"><a href="#__codelineno-2-196" id="__codelineno-2-196" name="__codelineno-2-196"></a>            <span class="s2">"eu"</span><span class="p">:</span> <span class="s2">"1.1.1.1"</span><span class="p">,</span>      <span class="c1"># EU</span>
</span><span id="__span-2-197"><a href="#__codelineno-2-197" id="__codelineno-2-197" name="__codelineno-2-197"></a>            <span class="s2">"asia"</span><span class="p">:</span> <span class="s2">"208.67.222.222"</span>  <span class="c1"># Asia</span>
</span><span id="__span-2-198"><a href="#__codelineno-2-198" id="__codelineno-2-198" name="__codelineno-2-198"></a>        <span class="p">}</span>
</span><span id="__span-2-199"><a href="#__codelineno-2-199" id="__codelineno-2-199" name="__codelineno-2-199"></a>
</span><span id="__span-2-200"><a href="#__codelineno-2-200" id="__codelineno-2-200" name="__codelineno-2-200"></a>        <span class="k">return</span> <span class="n">region_ips</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="s2">"8.8.8.8"</span><span class="p">)</span>
</span><span id="__span-2-201"><a href="#__codelineno-2-201" id="__codelineno-2-201" name="__codelineno-2-201"></a>
</span><span id="__span-2-202"><a href="#__codelineno-2-202" id="__codelineno-2-202" name="__codelineno-2-202"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_cache</span><span class="p">(</span>
</span><span id="__span-2-203"><a href="#__codelineno-2-203" id="__codelineno-2-203" name="__codelineno-2-203"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-204"><a href="#__codelineno-2-204" id="__codelineno-2-204" name="__codelineno-2-204"></a>        <span class="n">storage_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-2-205"><a href="#__codelineno-2-205" id="__codelineno-2-205" name="__codelineno-2-205"></a>        <span class="n">cache_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-2-206"><a href="#__codelineno-2-206" id="__codelineno-2-206" name="__codelineno-2-206"></a>        <span class="n">patterns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-207"><a href="#__codelineno-2-207" id="__codelineno-2-207" name="__codelineno-2-207"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-208"><a href="#__codelineno-2-208" id="__codelineno-2-208" name="__codelineno-2-208"></a><span class="w">        </span><span class="sd">"""Intelligently invalidate cached content"""</span>
</span><span id="__span-2-209"><a href="#__codelineno-2-209" id="__codelineno-2-209" name="__codelineno-2-209"></a>
</span><span id="__span-2-210"><a href="#__codelineno-2-210" id="__codelineno-2-210" name="__codelineno-2-210"></a>        <span class="n">invalidation_methods</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-211"><a href="#__codelineno-2-211" id="__codelineno-2-211" name="__codelineno-2-211"></a>
</span><span id="__span-2-212"><a href="#__codelineno-2-212" id="__codelineno-2-212" name="__codelineno-2-212"></a>        <span class="c1"># Invalidate by specific URLs</span>
</span><span id="__span-2-213"><a href="#__codelineno-2-213" id="__codelineno-2-213" name="__codelineno-2-213"></a>        <span class="k">if</span> <span class="n">storage_paths</span><span class="p">:</span>
</span><span id="__span-2-214"><a href="#__codelineno-2-214" id="__codelineno-2-214" name="__codelineno-2-214"></a>            <span class="n">urls_to_invalidate</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-215"><a href="#__codelineno-2-215" id="__codelineno-2-215" name="__codelineno-2-215"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">storage_paths</span><span class="p">:</span>
</span><span id="__span-2-216"><a href="#__codelineno-2-216" id="__codelineno-2-216" name="__codelineno-2-216"></a>                <span class="c1"># Invalidate base URL and common transformations</span>
</span><span id="__span-2-217"><a href="#__codelineno-2-217" id="__codelineno-2-217" name="__codelineno-2-217"></a>                <span class="n">base_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-2-218"><a href="#__codelineno-2-218" id="__codelineno-2-218" name="__codelineno-2-218"></a>                <span class="n">urls_to_invalidate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="__span-2-219"><a href="#__codelineno-2-219" id="__codelineno-2-219" name="__codelineno-2-219"></a>
</span><span id="__span-2-220"><a href="#__codelineno-2-220" id="__codelineno-2-220" name="__codelineno-2-220"></a>                <span class="c1"># Add common transformation variants</span>
</span><span id="__span-2-221"><a href="#__codelineno-2-221" id="__codelineno-2-221" name="__codelineno-2-221"></a>                <span class="k">for</span> <span class="n">preset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"thumbnail"</span><span class="p">,</span> <span class="s2">"preview"</span><span class="p">,</span> <span class="s2">"avatar"</span><span class="p">]:</span>
</span><span id="__span-2-222"><a href="#__codelineno-2-222" id="__codelineno-2-222" name="__codelineno-2-222"></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-223"><a href="#__codelineno-2-223" id="__codelineno-2-223" name="__codelineno-2-223"></a>                        <span class="n">preset_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_preset_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">preset</span><span class="p">)</span>
</span><span id="__span-2-224"><a href="#__codelineno-2-224" id="__codelineno-2-224" name="__codelineno-2-224"></a>                        <span class="n">urls_to_invalidate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preset_url</span><span class="p">)</span>
</span><span id="__span-2-225"><a href="#__codelineno-2-225" id="__codelineno-2-225" name="__codelineno-2-225"></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-2-226"><a href="#__codelineno-2-226" id="__codelineno-2-226" name="__codelineno-2-226"></a>                        <span class="k">pass</span>  <span class="c1"># Preset might not be applicable</span>
</span><span id="__span-2-227"><a href="#__codelineno-2-227" id="__codelineno-2-227" name="__codelineno-2-227"></a>
</span><span id="__span-2-228"><a href="#__codelineno-2-228" id="__codelineno-2-228" name="__codelineno-2-228"></a>            <span class="n">invalidation_methods</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-229"><a href="#__codelineno-2-229" id="__codelineno-2-229" name="__codelineno-2-229"></a>                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"urls"</span><span class="p">,</span>
</span><span id="__span-2-230"><a href="#__codelineno-2-230" id="__codelineno-2-230" name="__codelineno-2-230"></a>                <span class="s2">"urls"</span><span class="p">:</span> <span class="n">urls_to_invalidate</span>
</span><span id="__span-2-231"><a href="#__codelineno-2-231" id="__codelineno-2-231" name="__codelineno-2-231"></a>            <span class="p">})</span>
</span><span id="__span-2-232"><a href="#__codelineno-2-232" id="__codelineno-2-232" name="__codelineno-2-232"></a>
</span><span id="__span-2-233"><a href="#__codelineno-2-233" id="__codelineno-2-233" name="__codelineno-2-233"></a>        <span class="c1"># Invalidate by cache tags</span>
</span><span id="__span-2-234"><a href="#__codelineno-2-234" id="__codelineno-2-234" name="__codelineno-2-234"></a>        <span class="k">if</span> <span class="n">cache_tags</span><span class="p">:</span>
</span><span id="__span-2-235"><a href="#__codelineno-2-235" id="__codelineno-2-235" name="__codelineno-2-235"></a>            <span class="n">invalidation_methods</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-236"><a href="#__codelineno-2-236" id="__codelineno-2-236" name="__codelineno-2-236"></a>                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"tags"</span><span class="p">,</span>
</span><span id="__span-2-237"><a href="#__codelineno-2-237" id="__codelineno-2-237" name="__codelineno-2-237"></a>                <span class="s2">"tags"</span><span class="p">:</span> <span class="n">cache_tags</span>
</span><span id="__span-2-238"><a href="#__codelineno-2-238" id="__codelineno-2-238" name="__codelineno-2-238"></a>            <span class="p">})</span>
</span><span id="__span-2-239"><a href="#__codelineno-2-239" id="__codelineno-2-239" name="__codelineno-2-239"></a>
</span><span id="__span-2-240"><a href="#__codelineno-2-240" id="__codelineno-2-240" name="__codelineno-2-240"></a>        <span class="c1"># Invalidate by patterns</span>
</span><span id="__span-2-241"><a href="#__codelineno-2-241" id="__codelineno-2-241" name="__codelineno-2-241"></a>        <span class="k">if</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="__span-2-242"><a href="#__codelineno-2-242" id="__codelineno-2-242" name="__codelineno-2-242"></a>            <span class="n">invalidation_methods</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-243"><a href="#__codelineno-2-243" id="__codelineno-2-243" name="__codelineno-2-243"></a>                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"patterns"</span><span class="p">,</span>
</span><span id="__span-2-244"><a href="#__codelineno-2-244" id="__codelineno-2-244" name="__codelineno-2-244"></a>                <span class="s2">"patterns"</span><span class="p">:</span> <span class="n">patterns</span>
</span><span id="__span-2-245"><a href="#__codelineno-2-245" id="__codelineno-2-245" name="__codelineno-2-245"></a>            <span class="p">})</span>
</span><span id="__span-2-246"><a href="#__codelineno-2-246" id="__codelineno-2-246" name="__codelineno-2-246"></a>
</span><span id="__span-2-247"><a href="#__codelineno-2-247" id="__codelineno-2-247" name="__codelineno-2-247"></a>        <span class="c1"># Execute invalidation through CDN provider</span>
</span><span id="__span-2-248"><a href="#__codelineno-2-248" id="__codelineno-2-248" name="__codelineno-2-248"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-249"><a href="#__codelineno-2-249" id="__codelineno-2-249" name="__codelineno-2-249"></a>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">invalidation_methods</span><span class="p">:</span>
</span><span id="__span-2-250"><a href="#__codelineno-2-250" id="__codelineno-2-250" name="__codelineno-2-250"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_invalidation</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
</span><span id="__span-2-251"><a href="#__codelineno-2-251" id="__codelineno-2-251" name="__codelineno-2-251"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="__span-2-252"><a href="#__codelineno-2-252" id="__codelineno-2-252" name="__codelineno-2-252"></a>
</span><span id="__span-2-253"><a href="#__codelineno-2-253" id="__codelineno-2-253" name="__codelineno-2-253"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-254"><a href="#__codelineno-2-254" id="__codelineno-2-254" name="__codelineno-2-254"></a>            <span class="s2">"invalidation_methods"</span><span class="p">:</span> <span class="n">invalidation_methods</span><span class="p">,</span>
</span><span id="__span-2-255"><a href="#__codelineno-2-255" id="__codelineno-2-255" name="__codelineno-2-255"></a>            <span class="s2">"results"</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
</span><span id="__span-2-256"><a href="#__codelineno-2-256" id="__codelineno-2-256" name="__codelineno-2-256"></a>            <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-2-257"><a href="#__codelineno-2-257" id="__codelineno-2-257" name="__codelineno-2-257"></a>        <span class="p">}</span>
</span><span id="__span-2-258"><a href="#__codelineno-2-258" id="__codelineno-2-258" name="__codelineno-2-258"></a>
</span><span id="__span-2-259"><a href="#__codelineno-2-259" id="__codelineno-2-259" name="__codelineno-2-259"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-260"><a href="#__codelineno-2-260" id="__codelineno-2-260" name="__codelineno-2-260"></a><span class="w">        </span><span class="sd">"""Execute cache invalidation through CDN provider"""</span>
</span><span id="__span-2-261"><a href="#__codelineno-2-261" id="__codelineno-2-261" name="__codelineno-2-261"></a>
</span><span id="__span-2-262"><a href="#__codelineno-2-262" id="__codelineno-2-262" name="__codelineno-2-262"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-263"><a href="#__codelineno-2-263" id="__codelineno-2-263" name="__codelineno-2-263"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">CLOUDFLARE</span><span class="p">:</span>
</span><span id="__span-2-264"><a href="#__codelineno-2-264" id="__codelineno-2-264" name="__codelineno-2-264"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloudflare_invalidation</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
</span><span id="__span-2-265"><a href="#__codelineno-2-265" id="__codelineno-2-265" name="__codelineno-2-265"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">CDNProvider</span><span class="o">.</span><span class="n">KEYCDN</span><span class="p">:</span>
</span><span id="__span-2-266"><a href="#__codelineno-2-266" id="__codelineno-2-266" name="__codelineno-2-266"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keycdn_invalidation</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
</span><span id="__span-2-267"><a href="#__codelineno-2-267" id="__codelineno-2-267" name="__codelineno-2-267"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-268"><a href="#__codelineno-2-268" id="__codelineno-2-268" name="__codelineno-2-268"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic_invalidation</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
</span><span id="__span-2-269"><a href="#__codelineno-2-269" id="__codelineno-2-269" name="__codelineno-2-269"></a>
</span><span id="__span-2-270"><a href="#__codelineno-2-270" id="__codelineno-2-270" name="__codelineno-2-270"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-271"><a href="#__codelineno-2-271" id="__codelineno-2-271" name="__codelineno-2-271"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-272"><a href="#__codelineno-2-272" id="__codelineno-2-272" name="__codelineno-2-272"></a>                <span class="s2">"success"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-2-273"><a href="#__codelineno-2-273" id="__codelineno-2-273" name="__codelineno-2-273"></a>                <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-2-274"><a href="#__codelineno-2-274" id="__codelineno-2-274" name="__codelineno-2-274"></a>                <span class="s2">"method"</span><span class="p">:</span> <span class="n">method</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span>
</span><span id="__span-2-275"><a href="#__codelineno-2-275" id="__codelineno-2-275" name="__codelineno-2-275"></a>            <span class="p">}</span>
</span><span id="__span-2-276"><a href="#__codelineno-2-276" id="__codelineno-2-276" name="__codelineno-2-276"></a>
</span><span id="__span-2-277"><a href="#__codelineno-2-277" id="__codelineno-2-277" name="__codelineno-2-277"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_cache_performance</span><span class="p">(</span>
</span><span id="__span-2-278"><a href="#__codelineno-2-278" id="__codelineno-2-278" name="__codelineno-2-278"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-279"><a href="#__codelineno-2-279" id="__codelineno-2-279" name="__codelineno-2-279"></a>        <span class="n">timeframe_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="__span-2-280"><a href="#__codelineno-2-280" id="__codelineno-2-280" name="__codelineno-2-280"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-281"><a href="#__codelineno-2-281" id="__codelineno-2-281" name="__codelineno-2-281"></a><span class="w">        </span><span class="sd">"""Get cache performance analytics"""</span>
</span><span id="__span-2-282"><a href="#__codelineno-2-282" id="__codelineno-2-282" name="__codelineno-2-282"></a>
</span><span id="__span-2-283"><a href="#__codelineno-2-283" id="__codelineno-2-283" name="__codelineno-2-283"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_analytics</span><span class="o">.</span><span class="n">get_performance_metrics</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">)</span>
</span><span id="__span-2-284"><a href="#__codelineno-2-284" id="__codelineno-2-284" name="__codelineno-2-284"></a>
</span><span id="__span-2-285"><a href="#__codelineno-2-285" id="__codelineno-2-285" name="__codelineno-2-285"></a><span class="k">class</span><span class="w"> </span><span class="nc">CacheAnalytics</span><span class="p">:</span>
</span><span id="__span-2-286"><a href="#__codelineno-2-286" id="__codelineno-2-286" name="__codelineno-2-286"></a><span class="w">    </span><span class="sd">"""Analytics for cache performance"""</span>
</span><span id="__span-2-287"><a href="#__codelineno-2-287" id="__codelineno-2-287" name="__codelineno-2-287"></a>
</span><span id="__span-2-288"><a href="#__codelineno-2-288" id="__codelineno-2-288" name="__codelineno-2-288"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_performance_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-289"><a href="#__codelineno-2-289" id="__codelineno-2-289" name="__codelineno-2-289"></a><span class="w">        </span><span class="sd">"""Get comprehensive cache performance metrics"""</span>
</span><span id="__span-2-290"><a href="#__codelineno-2-290" id="__codelineno-2-290" name="__codelineno-2-290"></a>
</span><span id="__span-2-291"><a href="#__codelineno-2-291" id="__codelineno-2-291" name="__codelineno-2-291"></a>        <span class="c1"># This would integrate with your CDN provider's analytics API</span>
</span><span id="__span-2-292"><a href="#__codelineno-2-292" id="__codelineno-2-292" name="__codelineno-2-292"></a>        <span class="c1"># or your own analytics system</span>
</span><span id="__span-2-293"><a href="#__codelineno-2-293" id="__codelineno-2-293" name="__codelineno-2-293"></a>
</span><span id="__span-2-294"><a href="#__codelineno-2-294" id="__codelineno-2-294" name="__codelineno-2-294"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-295"><a href="#__codelineno-2-295" id="__codelineno-2-295" name="__codelineno-2-295"></a>            <span class="s2">"timeframe_hours"</span><span class="p">:</span> <span class="n">timeframe_hours</span><span class="p">,</span>
</span><span id="__span-2-296"><a href="#__codelineno-2-296" id="__codelineno-2-296" name="__codelineno-2-296"></a>            <span class="s2">"cache_hit_ratio"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_hit_ratio</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-297"><a href="#__codelineno-2-297" id="__codelineno-2-297" name="__codelineno-2-297"></a>            <span class="s2">"bandwidth_savings"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bandwidth_savings</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-298"><a href="#__codelineno-2-298" id="__codelineno-2-298" name="__codelineno-2-298"></a>            <span class="s2">"response_time_improvement"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_response_time_improvement</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-299"><a href="#__codelineno-2-299" id="__codelineno-2-299" name="__codelineno-2-299"></a>            <span class="s2">"geographic_performance"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_geographic_performance</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-300"><a href="#__codelineno-2-300" id="__codelineno-2-300" name="__codelineno-2-300"></a>            <span class="s2">"content_type_performance"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content_type_performance</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-301"><a href="#__codelineno-2-301" id="__codelineno-2-301" name="__codelineno-2-301"></a>            <span class="s2">"popular_content"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_popular_content</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">),</span>
</span><span id="__span-2-302"><a href="#__codelineno-2-302" id="__codelineno-2-302" name="__codelineno-2-302"></a>            <span class="s2">"cache_misses"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_cache_misses</span><span class="p">(</span><span class="n">timeframe_hours</span><span class="p">)</span>
</span><span id="__span-2-303"><a href="#__codelineno-2-303" id="__codelineno-2-303" name="__codelineno-2-303"></a>        <span class="p">}</span>
</span><span id="__span-2-304"><a href="#__codelineno-2-304" id="__codelineno-2-304" name="__codelineno-2-304"></a>
</span><span id="__span-2-305"><a href="#__codelineno-2-305" id="__codelineno-2-305" name="__codelineno-2-305"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_hit_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-2-306"><a href="#__codelineno-2-306" id="__codelineno-2-306" name="__codelineno-2-306"></a><span class="w">        </span><span class="sd">"""Calculate cache hit ratio by content type"""</span>
</span><span id="__span-2-307"><a href="#__codelineno-2-307" id="__codelineno-2-307" name="__codelineno-2-307"></a>
</span><span id="__span-2-308"><a href="#__codelineno-2-308" id="__codelineno-2-308" name="__codelineno-2-308"></a>        <span class="c1"># Example implementation - would integrate with actual analytics</span>
</span><span id="__span-2-309"><a href="#__codelineno-2-309" id="__codelineno-2-309" name="__codelineno-2-309"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-310"><a href="#__codelineno-2-310" id="__codelineno-2-310" name="__codelineno-2-310"></a>            <span class="s2">"overall"</span><span class="p">:</span> <span class="mf">94.5</span><span class="p">,</span>
</span><span id="__span-2-311"><a href="#__codelineno-2-311" id="__codelineno-2-311" name="__codelineno-2-311"></a>            <span class="s2">"educational_content"</span><span class="p">:</span> <span class="mf">96.2</span><span class="p">,</span>
</span><span id="__span-2-312"><a href="#__codelineno-2-312" id="__codelineno-2-312" name="__codelineno-2-312"></a>            <span class="s2">"media_resource"</span><span class="p">:</span> <span class="mf">98.1</span><span class="p">,</span>
</span><span id="__span-2-313"><a href="#__codelineno-2-313" id="__codelineno-2-313" name="__codelineno-2-313"></a>            <span class="s2">"student_submission"</span><span class="p">:</span> <span class="mf">89.3</span><span class="p">,</span>
</span><span id="__span-2-314"><a href="#__codelineno-2-314" id="__codelineno-2-314" name="__codelineno-2-314"></a>            <span class="s2">"avatar"</span><span class="p">:</span> <span class="mf">92.7</span>
</span><span id="__span-2-315"><a href="#__codelineno-2-315" id="__codelineno-2-315" name="__codelineno-2-315"></a>        <span class="p">}</span>
</span><span id="__span-2-316"><a href="#__codelineno-2-316" id="__codelineno-2-316" name="__codelineno-2-316"></a>
</span><span id="__span-2-317"><a href="#__codelineno-2-317" id="__codelineno-2-317" name="__codelineno-2-317"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_bandwidth_savings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-318"><a href="#__codelineno-2-318" id="__codelineno-2-318" name="__codelineno-2-318"></a><span class="w">        </span><span class="sd">"""Calculate bandwidth savings from caching"""</span>
</span><span id="__span-2-319"><a href="#__codelineno-2-319" id="__codelineno-2-319" name="__codelineno-2-319"></a>
</span><span id="__span-2-320"><a href="#__codelineno-2-320" id="__codelineno-2-320" name="__codelineno-2-320"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-321"><a href="#__codelineno-2-321" id="__codelineno-2-321" name="__codelineno-2-321"></a>            <span class="s2">"total_requests"</span><span class="p">:</span> <span class="mi">1500000</span><span class="p">,</span>
</span><span id="__span-2-322"><a href="#__codelineno-2-322" id="__codelineno-2-322" name="__codelineno-2-322"></a>            <span class="s2">"cache_hits"</span><span class="p">:</span> <span class="mi">1417500</span><span class="p">,</span>
</span><span id="__span-2-323"><a href="#__codelineno-2-323" id="__codelineno-2-323" name="__codelineno-2-323"></a>            <span class="s2">"origin_requests"</span><span class="p">:</span> <span class="mi">82500</span><span class="p">,</span>
</span><span id="__span-2-324"><a href="#__codelineno-2-324" id="__codelineno-2-324" name="__codelineno-2-324"></a>            <span class="s2">"bandwidth_saved_gb"</span><span class="p">:</span> <span class="mf">450.2</span><span class="p">,</span>
</span><span id="__span-2-325"><a href="#__codelineno-2-325" id="__codelineno-2-325" name="__codelineno-2-325"></a>            <span class="s2">"cost_savings_usd"</span><span class="p">:</span> <span class="mf">125.30</span>
</span><span id="__span-2-326"><a href="#__codelineno-2-326" id="__codelineno-2-326" name="__codelineno-2-326"></a>        <span class="p">}</span>
</span><span id="__span-2-327"><a href="#__codelineno-2-327" id="__codelineno-2-327" name="__codelineno-2-327"></a>
</span><span id="__span-2-328"><a href="#__codelineno-2-328" id="__codelineno-2-328" name="__codelineno-2-328"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_geographic_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-329"><a href="#__codelineno-2-329" id="__codelineno-2-329" name="__codelineno-2-329"></a><span class="w">        </span><span class="sd">"""Get performance metrics by geographic region"""</span>
</span><span id="__span-2-330"><a href="#__codelineno-2-330" id="__codelineno-2-330" name="__codelineno-2-330"></a>
</span><span id="__span-2-331"><a href="#__codelineno-2-331" id="__codelineno-2-331" name="__codelineno-2-331"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-332"><a href="#__codelineno-2-332" id="__codelineno-2-332" name="__codelineno-2-332"></a>            <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="mf">95.2</span><span class="p">,</span> <span class="s2">"avg_response_time_ms"</span><span class="p">:</span> <span class="mi">45</span><span class="p">},</span>
</span><span id="__span-2-333"><a href="#__codelineno-2-333" id="__codelineno-2-333" name="__codelineno-2-333"></a>            <span class="s2">"us_west"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="mf">94.8</span><span class="p">,</span> <span class="s2">"avg_response_time_ms"</span><span class="p">:</span> <span class="mi">52</span><span class="p">},</span>
</span><span id="__span-2-334"><a href="#__codelineno-2-334" id="__codelineno-2-334" name="__codelineno-2-334"></a>            <span class="s2">"eu_central"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="mf">93.1</span><span class="p">,</span> <span class="s2">"avg_response_time_ms"</span><span class="p">:</span> <span class="mi">78</span><span class="p">},</span>
</span><span id="__span-2-335"><a href="#__codelineno-2-335" id="__codelineno-2-335" name="__codelineno-2-335"></a>            <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="mf">91.5</span><span class="p">,</span> <span class="s2">"avg_response_time_ms"</span><span class="p">:</span> <span class="mi">125</span><span class="p">},</span>
</span><span id="__span-2-336"><a href="#__codelineno-2-336" id="__codelineno-2-336" name="__codelineno-2-336"></a>            <span class="s2">"global_average"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="mf">94.1</span><span class="p">,</span> <span class="s2">"avg_response_time_ms"</span><span class="p">:</span> <span class="mi">75</span><span class="p">}</span>
</span><span id="__span-2-337"><a href="#__codelineno-2-337" id="__codelineno-2-337" name="__codelineno-2-337"></a>        <span class="p">}</span>
</span><span id="__span-2-338"><a href="#__codelineno-2-338" id="__codelineno-2-338" name="__codelineno-2-338"></a>
</span><span id="__span-2-339"><a href="#__codelineno-2-339" id="__codelineno-2-339" name="__codelineno-2-339"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">optimize_cache_strategy</span><span class="p">(</span>
</span><span id="__span-2-340"><a href="#__codelineno-2-340" id="__codelineno-2-340" name="__codelineno-2-340"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-341"><a href="#__codelineno-2-341" id="__codelineno-2-341" name="__codelineno-2-341"></a>        <span class="n">performance_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-2-342"><a href="#__codelineno-2-342" id="__codelineno-2-342" name="__codelineno-2-342"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-2-343"><a href="#__codelineno-2-343" id="__codelineno-2-343" name="__codelineno-2-343"></a><span class="w">        </span><span class="sd">"""Analyze performance and suggest cache optimizations"""</span>
</span><span id="__span-2-344"><a href="#__codelineno-2-344" id="__codelineno-2-344" name="__codelineno-2-344"></a>
</span><span id="__span-2-345"><a href="#__codelineno-2-345" id="__codelineno-2-345" name="__codelineno-2-345"></a>        <span class="n">optimizations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-346"><a href="#__codelineno-2-346" id="__codelineno-2-346" name="__codelineno-2-346"></a>
</span><span id="__span-2-347"><a href="#__codelineno-2-347" id="__codelineno-2-347" name="__codelineno-2-347"></a>        <span class="c1"># Analyze hit ratios</span>
</span><span id="__span-2-348"><a href="#__codelineno-2-348" id="__codelineno-2-348" name="__codelineno-2-348"></a>        <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">hit_ratio</span> <span class="ow">in</span> <span class="n">performance_data</span><span class="p">[</span><span class="s2">"cache_hit_ratio"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-2-349"><a href="#__codelineno-2-349" id="__codelineno-2-349" name="__codelineno-2-349"></a>            <span class="k">if</span> <span class="n">hit_ratio</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
</span><span id="__span-2-350"><a href="#__codelineno-2-350" id="__codelineno-2-350" name="__codelineno-2-350"></a>                <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-351"><a href="#__codelineno-2-351" id="__codelineno-2-351" name="__codelineno-2-351"></a>                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"increase_ttl"</span><span class="p">,</span>
</span><span id="__span-2-352"><a href="#__codelineno-2-352" id="__codelineno-2-352" name="__codelineno-2-352"></a>                    <span class="s2">"content_type"</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
</span><span id="__span-2-353"><a href="#__codelineno-2-353" id="__codelineno-2-353" name="__codelineno-2-353"></a>                    <span class="s2">"current_hit_ratio"</span><span class="p">:</span> <span class="n">hit_ratio</span><span class="p">,</span>
</span><span id="__span-2-354"><a href="#__codelineno-2-354" id="__codelineno-2-354" name="__codelineno-2-354"></a>                    <span class="s2">"suggested_action"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Increase TTL for </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2"> to improve caching"</span>
</span><span id="__span-2-355"><a href="#__codelineno-2-355" id="__codelineno-2-355" name="__codelineno-2-355"></a>                <span class="p">})</span>
</span><span id="__span-2-356"><a href="#__codelineno-2-356" id="__codelineno-2-356" name="__codelineno-2-356"></a>
</span><span id="__span-2-357"><a href="#__codelineno-2-357" id="__codelineno-2-357" name="__codelineno-2-357"></a>        <span class="c1"># Analyze geographic performance</span>
</span><span id="__span-2-358"><a href="#__codelineno-2-358" id="__codelineno-2-358" name="__codelineno-2-358"></a>        <span class="n">geo_performance</span> <span class="o">=</span> <span class="n">performance_data</span><span class="p">[</span><span class="s2">"geographic_performance"</span><span class="p">]</span>
</span><span id="__span-2-359"><a href="#__codelineno-2-359" id="__codelineno-2-359" name="__codelineno-2-359"></a>        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">geo_performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-2-360"><a href="#__codelineno-2-360" id="__codelineno-2-360" name="__codelineno-2-360"></a>            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">"hit_ratio"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">92</span><span class="p">:</span>
</span><span id="__span-2-361"><a href="#__codelineno-2-361" id="__codelineno-2-361" name="__codelineno-2-361"></a>                <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-362"><a href="#__codelineno-2-362" id="__codelineno-2-362" name="__codelineno-2-362"></a>                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"regional_warmup"</span><span class="p">,</span>
</span><span id="__span-2-363"><a href="#__codelineno-2-363" id="__codelineno-2-363" name="__codelineno-2-363"></a>                    <span class="s2">"region"</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
</span><span id="__span-2-364"><a href="#__codelineno-2-364" id="__codelineno-2-364" name="__codelineno-2-364"></a>                    <span class="s2">"current_hit_ratio"</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">"hit_ratio"</span><span class="p">],</span>
</span><span id="__span-2-365"><a href="#__codelineno-2-365" id="__codelineno-2-365" name="__codelineno-2-365"></a>                    <span class="s2">"suggested_action"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Implement proactive cache warmup for </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-2-366"><a href="#__codelineno-2-366" id="__codelineno-2-366" name="__codelineno-2-366"></a>                <span class="p">})</span>
</span><span id="__span-2-367"><a href="#__codelineno-2-367" id="__codelineno-2-367" name="__codelineno-2-367"></a>
</span><span id="__span-2-368"><a href="#__codelineno-2-368" id="__codelineno-2-368" name="__codelineno-2-368"></a>        <span class="c1"># Analyze popular content</span>
</span><span id="__span-2-369"><a href="#__codelineno-2-369" id="__codelineno-2-369" name="__codelineno-2-369"></a>        <span class="n">popular_content</span> <span class="o">=</span> <span class="n">performance_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"popular_content"</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-2-370"><a href="#__codelineno-2-370" id="__codelineno-2-370" name="__codelineno-2-370"></a>        <span class="k">if</span> <span class="n">popular_content</span><span class="p">:</span>
</span><span id="__span-2-371"><a href="#__codelineno-2-371" id="__codelineno-2-371" name="__codelineno-2-371"></a>            <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-372"><a href="#__codelineno-2-372" id="__codelineno-2-372" name="__codelineno-2-372"></a>                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"priority_caching"</span><span class="p">,</span>
</span><span id="__span-2-373"><a href="#__codelineno-2-373" id="__codelineno-2-373" name="__codelineno-2-373"></a>                <span class="s2">"suggested_action"</span><span class="p">:</span> <span class="s2">"Implement priority caching for top 10</span><span class="si">% o</span><span class="s2">f popular content"</span><span class="p">,</span>
</span><span id="__span-2-374"><a href="#__codelineno-2-374" id="__codelineno-2-374" name="__codelineno-2-374"></a>                <span class="s2">"affected_content"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">popular_content</span><span class="p">)</span>
</span><span id="__span-2-375"><a href="#__codelineno-2-375" id="__codelineno-2-375" name="__codelineno-2-375"></a>            <span class="p">})</span>
</span><span id="__span-2-376"><a href="#__codelineno-2-376" id="__codelineno-2-376" name="__codelineno-2-376"></a>
</span><span id="__span-2-377"><a href="#__codelineno-2-377" id="__codelineno-2-377" name="__codelineno-2-377"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-378"><a href="#__codelineno-2-378" id="__codelineno-2-378" name="__codelineno-2-378"></a>            <span class="s2">"optimizations"</span><span class="p">:</span> <span class="n">optimizations</span><span class="p">,</span>
</span><span id="__span-2-379"><a href="#__codelineno-2-379" id="__codelineno-2-379" name="__codelineno-2-379"></a>            <span class="s2">"estimated_improvement"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_optimization_impact</span><span class="p">(</span><span class="n">optimizations</span><span class="p">),</span>
</span><span id="__span-2-380"><a href="#__codelineno-2-380" id="__codelineno-2-380" name="__codelineno-2-380"></a>            <span class="s2">"implementation_priority"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prioritize_optimizations</span><span class="p">(</span><span class="n">optimizations</span><span class="p">)</span>
</span><span id="__span-2-381"><a href="#__codelineno-2-381" id="__codelineno-2-381" name="__codelineno-2-381"></a>        <span class="p">}</span>
</span></code></pre></div> <h2 id="global-distribution">Global Distribution<a class="headerlink" href="#global-distribution" title="Permanent link">¶</a></h2> <h3 id="geographic-optimization">Geographic Optimization<a class="headerlink" href="#geographic-optimization" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">GeographicDistributionManager</span><span class="p">:</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Manages global content distribution optimization"""</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span><span class="p">):</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">cdn_manager</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">region_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_region_configurations</span><span class="p">()</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">traffic_analyzer</span> <span class="o">=</span> <span class="n">TrafficAnalyzer</span><span class="p">()</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_region_configurations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">        </span><span class="sd">"""Load region-specific configurations"""</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>            <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>                <span class="s2">"pop_locations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"New York"</span><span class="p">,</span> <span class="s2">"Miami"</span><span class="p">,</span> <span class="s2">"Atlanta"</span><span class="p">],</span>
</span><span id="__span-3-15"><a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>                <span class="s2">"bandwidth_limit_gbps"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="__span-3-16"><a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>                <span class="s2">"storage_capacity_tb"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="__span-3-17"><a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>                <span class="s2">"primary_educational_hours"</span><span class="p">:</span> <span class="s2">"08:00-18:00 EST"</span><span class="p">,</span>
</span><span id="__span-3-18"><a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>                <span class="s2">"peak_traffic_multiplier"</span><span class="p">:</span> <span class="mf">3.2</span>
</span><span id="__span-3-19"><a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>            <span class="p">},</span>
</span><span id="__span-3-20"><a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>            <span class="s2">"us_west"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-21"><a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>                <span class="s2">"pop_locations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Los Angeles"</span><span class="p">,</span> <span class="s2">"San Francisco"</span><span class="p">,</span> <span class="s2">"Seattle"</span><span class="p">],</span>
</span><span id="__span-3-22"><a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>                <span class="s2">"bandwidth_limit_gbps"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
</span><span id="__span-3-23"><a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>                <span class="s2">"storage_capacity_tb"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="__span-3-24"><a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>                <span class="s2">"primary_educational_hours"</span><span class="p">:</span> <span class="s2">"08:00-18:00 PST"</span><span class="p">,</span>
</span><span id="__span-3-25"><a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>                <span class="s2">"peak_traffic_multiplier"</span><span class="p">:</span> <span class="mf">2.8</span>
</span><span id="__span-3-26"><a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>            <span class="p">},</span>
</span><span id="__span-3-27"><a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>            <span class="s2">"eu_central"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-28"><a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>                <span class="s2">"pop_locations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Frankfurt"</span><span class="p">,</span> <span class="s2">"Amsterdam"</span><span class="p">,</span> <span class="s2">"London"</span><span class="p">],</span>
</span><span id="__span-3-29"><a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>                <span class="s2">"bandwidth_limit_gbps"</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
</span><span id="__span-3-30"><a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>                <span class="s2">"storage_capacity_tb"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="__span-3-31"><a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>                <span class="s2">"primary_educational_hours"</span><span class="p">:</span> <span class="s2">"08:00-18:00 CET"</span><span class="p">,</span>
</span><span id="__span-3-32"><a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>                <span class="s2">"peak_traffic_multiplier"</span><span class="p">:</span> <span class="mf">2.5</span>
</span><span id="__span-3-33"><a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>            <span class="p">},</span>
</span><span id="__span-3-34"><a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>            <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-35"><a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>                <span class="s2">"pop_locations"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Tokyo"</span><span class="p">,</span> <span class="s2">"Singapore"</span><span class="p">,</span> <span class="s2">"Sydney"</span><span class="p">],</span>
</span><span id="__span-3-36"><a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>                <span class="s2">"bandwidth_limit_gbps"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span><span id="__span-3-37"><a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>                <span class="s2">"storage_capacity_tb"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="__span-3-38"><a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>                <span class="s2">"primary_educational_hours"</span><span class="p">:</span> <span class="s2">"08:00-18:00 JST"</span><span class="p">,</span>
</span><span id="__span-3-39"><a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>                <span class="s2">"peak_traffic_multiplier"</span><span class="p">:</span> <span class="mf">2.1</span>
</span><span id="__span-3-40"><a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>            <span class="p">}</span>
</span><span id="__span-3-41"><a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>        <span class="p">}</span>
</span><span id="__span-3-42"><a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>
</span><span id="__span-3-43"><a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">optimize_content_placement</span><span class="p">(</span>
</span><span id="__span-3-44"><a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-3-45"><a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>        <span class="n">content_analytics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-3-46"><a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>        <span class="n">forecast_period_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-3-47"><a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-48"><a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">        </span><span class="sd">"""Optimize content placement across global regions"""</span>
</span><span id="__span-3-49"><a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>
</span><span id="__span-3-50"><a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>        <span class="c1"># Analyze current traffic patterns</span>
</span><span id="__span-3-51"><a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>        <span class="n">traffic_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_analyzer</span><span class="o">.</span><span class="n">analyze_geographic_traffic</span><span class="p">(</span>
</span><span id="__span-3-52"><a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>            <span class="n">days</span><span class="o">=</span><span class="n">forecast_period_days</span>
</span><span id="__span-3-53"><a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>        <span class="p">)</span>
</span><span id="__span-3-54"><a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a>
</span><span id="__span-3-55"><a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>        <span class="n">placement_strategy</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-56"><a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a>
</span><span id="__span-3-57"><a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a>        <span class="k">for</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">analytics</span> <span class="ow">in</span> <span class="n">content_analytics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-3-58"><a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>            <span class="n">regional_demand</span> <span class="o">=</span> <span class="n">analytics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"regional_demand"</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-3-59"><a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a>            <span class="n">content_size</span> <span class="o">=</span> <span class="n">analytics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"total_size_gb"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-60"><a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a>            <span class="n">access_frequency</span> <span class="o">=</span> <span class="n">analytics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"access_frequency"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-61"><a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a>
</span><span id="__span-3-62"><a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a>            <span class="c1"># Determine optimal placement</span>
</span><span id="__span-3-63"><a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a>            <span class="n">placement</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_optimal_placement</span><span class="p">(</span>
</span><span id="__span-3-64"><a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a>                <span class="n">regional_demand</span><span class="p">,</span>
</span><span id="__span-3-65"><a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>                <span class="n">content_size</span><span class="p">,</span>
</span><span id="__span-3-66"><a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>                <span class="n">access_frequency</span><span class="p">,</span>
</span><span id="__span-3-67"><a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a>                <span class="n">traffic_analysis</span>
</span><span id="__span-3-68"><a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a>            <span class="p">)</span>
</span><span id="__span-3-69"><a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a>
</span><span id="__span-3-70"><a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>            <span class="n">placement_strategy</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">placement</span>
</span><span id="__span-3-71"><a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>
</span><span id="__span-3-72"><a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-73"><a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a>            <span class="s2">"placement_strategy"</span><span class="p">:</span> <span class="n">placement_strategy</span><span class="p">,</span>
</span><span id="__span-3-74"><a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a>            <span class="s2">"estimated_performance_improvement"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_performance_improvement</span><span class="p">(</span><span class="n">placement_strategy</span><span class="p">),</span>
</span><span id="__span-3-75"><a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>            <span class="s2">"cost_analysis"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_placement_costs</span><span class="p">(</span><span class="n">placement_strategy</span><span class="p">),</span>
</span><span id="__span-3-76"><a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a>            <span class="s2">"implementation_timeline"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_implementation_timeline</span><span class="p">(</span><span class="n">placement_strategy</span><span class="p">)</span>
</span><span id="__span-3-77"><a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>        <span class="p">}</span>
</span><span id="__span-3-78"><a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a>
</span><span id="__span-3-79"><a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_optimal_placement</span><span class="p">(</span>
</span><span id="__span-3-80"><a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-3-81"><a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="n">regional_demand</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="__span-3-82"><a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a>        <span class="n">content_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="__span-3-83"><a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a>        <span class="n">access_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="__span-3-84"><a href="#__codelineno-3-84" id="__codelineno-3-84" name="__codelineno-3-84"></a>        <span class="n">traffic_analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-3-85"><a href="#__codelineno-3-85" id="__codelineno-3-85" name="__codelineno-3-85"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-86"><a href="#__codelineno-3-86" id="__codelineno-3-86" name="__codelineno-3-86"></a><span class="w">        </span><span class="sd">"""Calculate optimal content placement strategy"""</span>
</span><span id="__span-3-87"><a href="#__codelineno-3-87" id="__codelineno-3-87" name="__codelineno-3-87"></a>
</span><span id="__span-3-88"><a href="#__codelineno-3-88" id="__codelineno-3-88" name="__codelineno-3-88"></a>        <span class="n">placement_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-89"><a href="#__codelineno-3-89" id="__codelineno-3-89" name="__codelineno-3-89"></a>
</span><span id="__span-3-90"><a href="#__codelineno-3-90" id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-3-91"><a href="#__codelineno-3-91" id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="c1"># Calculate placement score based on multiple factors</span>
</span><span id="__span-3-92"><a href="#__codelineno-3-92" id="__codelineno-3-92" name="__codelineno-3-92"></a>
</span><span id="__span-3-93"><a href="#__codelineno-3-93" id="__codelineno-3-93" name="__codelineno-3-93"></a>            <span class="c1"># Demand factor (40% weight)</span>
</span><span id="__span-3-94"><a href="#__codelineno-3-94" id="__codelineno-3-94" name="__codelineno-3-94"></a>            <span class="n">demand_score</span> <span class="o">=</span> <span class="n">regional_demand</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
</span><span id="__span-3-95"><a href="#__codelineno-3-95" id="__codelineno-3-95" name="__codelineno-3-95"></a>
</span><span id="__span-3-96"><a href="#__codelineno-3-96" id="__codelineno-3-96" name="__codelineno-3-96"></a>            <span class="c1"># Capacity factor (20% weight)</span>
</span><span id="__span-3-97"><a href="#__codelineno-3-97" id="__codelineno-3-97" name="__codelineno-3-97"></a>            <span class="n">available_capacity</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"storage_capacity_tb"</span><span class="p">]</span> <span class="o">-</span> <span class="n">traffic_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">_usage_tb"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-98"><a href="#__codelineno-3-98" id="__codelineno-3-98" name="__codelineno-3-98"></a>            <span class="n">capacity_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_capacity</span> <span class="o">/</span> <span class="n">content_size</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="k">if</span> <span class="n">content_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.2</span>
</span><span id="__span-3-99"><a href="#__codelineno-3-99" id="__codelineno-3-99" name="__codelineno-3-99"></a>
</span><span id="__span-3-100"><a href="#__codelineno-3-100" id="__codelineno-3-100" name="__codelineno-3-100"></a>            <span class="c1"># Network performance factor (25% weight)</span>
</span><span id="__span-3-101"><a href="#__codelineno-3-101" id="__codelineno-3-101" name="__codelineno-3-101"></a>            <span class="n">network_score</span> <span class="o">=</span> <span class="n">traffic_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">_performance_score"</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
</span><span id="__span-3-102"><a href="#__codelineno-3-102" id="__codelineno-3-102" name="__codelineno-3-102"></a>
</span><span id="__span-3-103"><a href="#__codelineno-3-103" id="__codelineno-3-103" name="__codelineno-3-103"></a>            <span class="c1"># Cost efficiency factor (15% weight)</span>
</span><span id="__span-3-104"><a href="#__codelineno-3-104" id="__codelineno-3-104" name="__codelineno-3-104"></a>            <span class="n">cost_score</span> <span class="o">=</span> <span class="n">traffic_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">_cost_efficiency"</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.15</span>
</span><span id="__span-3-105"><a href="#__codelineno-3-105" id="__codelineno-3-105" name="__codelineno-3-105"></a>
</span><span id="__span-3-106"><a href="#__codelineno-3-106" id="__codelineno-3-106" name="__codelineno-3-106"></a>            <span class="n">total_score</span> <span class="o">=</span> <span class="n">demand_score</span> <span class="o">+</span> <span class="n">capacity_score</span> <span class="o">+</span> <span class="n">network_score</span> <span class="o">+</span> <span class="n">cost_score</span>
</span><span id="__span-3-107"><a href="#__codelineno-3-107" id="__codelineno-3-107" name="__codelineno-3-107"></a>            <span class="n">placement_scores</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span>
</span><span id="__span-3-108"><a href="#__codelineno-3-108" id="__codelineno-3-108" name="__codelineno-3-108"></a>
</span><span id="__span-3-109"><a href="#__codelineno-3-109" id="__codelineno-3-109" name="__codelineno-3-109"></a>        <span class="c1"># Determine placement strategy</span>
</span><span id="__span-3-110"><a href="#__codelineno-3-110" id="__codelineno-3-110" name="__codelineno-3-110"></a>        <span class="n">sorted_regions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">placement_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-111"><a href="#__codelineno-3-111" id="__codelineno-3-111" name="__codelineno-3-111"></a>
</span><span id="__span-3-112"><a href="#__codelineno-3-112" id="__codelineno-3-112" name="__codelineno-3-112"></a>        <span class="c1"># Primary region (highest score)</span>
</span><span id="__span-3-113"><a href="#__codelineno-3-113" id="__codelineno-3-113" name="__codelineno-3-113"></a>        <span class="n">primary_region</span> <span class="o">=</span> <span class="n">sorted_regions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-3-114"><a href="#__codelineno-3-114" id="__codelineno-3-114" name="__codelineno-3-114"></a>
</span><span id="__span-3-115"><a href="#__codelineno-3-115" id="__codelineno-3-115" name="__codelineno-3-115"></a>        <span class="c1"># Secondary regions (for redundancy)</span>
</span><span id="__span-3-116"><a href="#__codelineno-3-116" id="__codelineno-3-116" name="__codelineno-3-116"></a>        <span class="n">secondary_regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">region</span> <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">sorted_regions</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">]</span>
</span><span id="__span-3-117"><a href="#__codelineno-3-117" id="__codelineno-3-117" name="__codelineno-3-117"></a>
</span><span id="__span-3-118"><a href="#__codelineno-3-118" id="__codelineno-3-118" name="__codelineno-3-118"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-119"><a href="#__codelineno-3-119" id="__codelineno-3-119" name="__codelineno-3-119"></a>            <span class="s2">"primary_region"</span><span class="p">:</span> <span class="n">primary_region</span><span class="p">,</span>
</span><span id="__span-3-120"><a href="#__codelineno-3-120" id="__codelineno-3-120" name="__codelineno-3-120"></a>            <span class="s2">"secondary_regions"</span><span class="p">:</span> <span class="n">secondary_regions</span><span class="p">,</span>
</span><span id="__span-3-121"><a href="#__codelineno-3-121" id="__codelineno-3-121" name="__codelineno-3-121"></a>            <span class="s2">"placement_scores"</span><span class="p">:</span> <span class="n">placement_scores</span><span class="p">,</span>
</span><span id="__span-3-122"><a href="#__codelineno-3-122" id="__codelineno-3-122" name="__codelineno-3-122"></a>            <span class="s2">"replication_strategy"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_replication_strategy</span><span class="p">(</span>
</span><span id="__span-3-123"><a href="#__codelineno-3-123" id="__codelineno-3-123" name="__codelineno-3-123"></a>                <span class="n">primary_region</span><span class="p">,</span>
</span><span id="__span-3-124"><a href="#__codelineno-3-124" id="__codelineno-3-124" name="__codelineno-3-124"></a>                <span class="n">secondary_regions</span><span class="p">,</span>
</span><span id="__span-3-125"><a href="#__codelineno-3-125" id="__codelineno-3-125" name="__codelineno-3-125"></a>                <span class="n">access_frequency</span>
</span><span id="__span-3-126"><a href="#__codelineno-3-126" id="__codelineno-3-126" name="__codelineno-3-126"></a>            <span class="p">)</span>
</span><span id="__span-3-127"><a href="#__codelineno-3-127" id="__codelineno-3-127" name="__codelineno-3-127"></a>        <span class="p">}</span>
</span><span id="__span-3-128"><a href="#__codelineno-3-128" id="__codelineno-3-128" name="__codelineno-3-128"></a>
</span><span id="__span-3-129"><a href="#__codelineno-3-129" id="__codelineno-3-129" name="__codelineno-3-129"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">implement_educational_schedule_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-130"><a href="#__codelineno-3-130" id="__codelineno-3-130" name="__codelineno-3-130"></a><span class="w">        </span><span class="sd">"""Optimize CDN behavior for educational schedules"""</span>
</span><span id="__span-3-131"><a href="#__codelineno-3-131" id="__codelineno-3-131" name="__codelineno-3-131"></a>
</span><span id="__span-3-132"><a href="#__codelineno-3-132" id="__codelineno-3-132" name="__codelineno-3-132"></a>        <span class="n">educational_optimizations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-133"><a href="#__codelineno-3-133" id="__codelineno-3-133" name="__codelineno-3-133"></a>
</span><span id="__span-3-134"><a href="#__codelineno-3-134" id="__codelineno-3-134" name="__codelineno-3-134"></a>        <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-3-135"><a href="#__codelineno-3-135" id="__codelineno-3-135" name="__codelineno-3-135"></a>            <span class="n">educational_hours</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"primary_educational_hours"</span><span class="p">]</span>
</span><span id="__span-3-136"><a href="#__codelineno-3-136" id="__codelineno-3-136" name="__codelineno-3-136"></a>            <span class="n">peak_multiplier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"peak_traffic_multiplier"</span><span class="p">]</span>
</span><span id="__span-3-137"><a href="#__codelineno-3-137" id="__codelineno-3-137" name="__codelineno-3-137"></a>
</span><span id="__span-3-138"><a href="#__codelineno-3-138" id="__codelineno-3-138" name="__codelineno-3-138"></a>            <span class="c1"># Schedule-based optimizations</span>
</span><span id="__span-3-139"><a href="#__codelineno-3-139" id="__codelineno-3-139" name="__codelineno-3-139"></a>            <span class="n">optimization_schedule</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-140"><a href="#__codelineno-3-140" id="__codelineno-3-140" name="__codelineno-3-140"></a>                <span class="s2">"pre_school_warmup"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-141"><a href="#__codelineno-3-141" id="__codelineno-3-141" name="__codelineno-3-141"></a>                    <span class="s2">"time"</span><span class="p">:</span> <span class="s2">"07:00"</span><span class="p">,</span>  <span class="c1"># 1 hour before school starts</span>
</span><span id="__span-3-142"><a href="#__codelineno-3-142" id="__codelineno-3-142" name="__codelineno-3-142"></a>                    <span class="s2">"action"</span><span class="p">:</span> <span class="s2">"warmup_educational_content"</span><span class="p">,</span>
</span><span id="__span-3-143"><a href="#__codelineno-3-143" id="__codelineno-3-143" name="__codelineno-3-143"></a>                    <span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"high"</span>
</span><span id="__span-3-144"><a href="#__codelineno-3-144" id="__codelineno-3-144" name="__codelineno-3-144"></a>                <span class="p">},</span>
</span><span id="__span-3-145"><a href="#__codelineno-3-145" id="__codelineno-3-145" name="__codelineno-3-145"></a>                <span class="s2">"school_hours_optimization"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-146"><a href="#__codelineno-3-146" id="__codelineno-3-146" name="__codelineno-3-146"></a>                    <span class="s2">"time_range"</span><span class="p">:</span> <span class="n">educational_hours</span><span class="p">,</span>
</span><span id="__span-3-147"><a href="#__codelineno-3-147" id="__codelineno-3-147" name="__codelineno-3-147"></a>                    <span class="s2">"actions"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-148"><a href="#__codelineno-3-148" id="__codelineno-3-148" name="__codelineno-3-148"></a>                        <span class="s2">"increase_cache_capacity"</span><span class="p">,</span>
</span><span id="__span-3-149"><a href="#__codelineno-3-149" id="__codelineno-3-149" name="__codelineno-3-149"></a>                        <span class="s2">"prioritize_educational_content"</span><span class="p">,</span>
</span><span id="__span-3-150"><a href="#__codelineno-3-150" id="__codelineno-3-150" name="__codelineno-3-150"></a>                        <span class="s2">"reduce_non_educational_cache_ttl"</span>
</span><span id="__span-3-151"><a href="#__codelineno-3-151" id="__codelineno-3-151" name="__codelineno-3-151"></a>                    <span class="p">]</span>
</span><span id="__span-3-152"><a href="#__codelineno-3-152" id="__codelineno-3-152" name="__codelineno-3-152"></a>                <span class="p">},</span>
</span><span id="__span-3-153"><a href="#__codelineno-3-153" id="__codelineno-3-153" name="__codelineno-3-153"></a>                <span class="s2">"after_school_optimization"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-154"><a href="#__codelineno-3-154" id="__codelineno-3-154" name="__codelineno-3-154"></a>                    <span class="s2">"time"</span><span class="p">:</span> <span class="s2">"19:00"</span><span class="p">,</span>  <span class="c1"># After school hours</span>
</span><span id="__span-3-155"><a href="#__codelineno-3-155" id="__codelineno-3-155" name="__codelineno-3-155"></a>                    <span class="s2">"action"</span><span class="p">:</span> <span class="s2">"prefetch_homework_content"</span><span class="p">,</span>
</span><span id="__span-3-156"><a href="#__codelineno-3-156" id="__codelineno-3-156" name="__codelineno-3-156"></a>                    <span class="s2">"priority"</span><span class="p">:</span> <span class="s2">"medium"</span>
</span><span id="__span-3-157"><a href="#__codelineno-3-157" id="__codelineno-3-157" name="__codelineno-3-157"></a>                <span class="p">},</span>
</span><span id="__span-3-158"><a href="#__codelineno-3-158" id="__codelineno-3-158" name="__codelineno-3-158"></a>                <span class="s2">"night_maintenance"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-159"><a href="#__codelineno-3-159" id="__codelineno-3-159" name="__codelineno-3-159"></a>                    <span class="s2">"time"</span><span class="p">:</span> <span class="s2">"02:00"</span><span class="p">,</span>
</span><span id="__span-3-160"><a href="#__codelineno-3-160" id="__codelineno-3-160" name="__codelineno-3-160"></a>                    <span class="s2">"actions"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-161"><a href="#__codelineno-3-161" id="__codelineno-3-161" name="__codelineno-3-161"></a>                        <span class="s2">"cleanup_temporary_cache"</span><span class="p">,</span>
</span><span id="__span-3-162"><a href="#__codelineno-3-162" id="__codelineno-3-162" name="__codelineno-3-162"></a>                        <span class="s2">"update_cache_strategies"</span><span class="p">,</span>
</span><span id="__span-3-163"><a href="#__codelineno-3-163" id="__codelineno-3-163" name="__codelineno-3-163"></a>                        <span class="s2">"sync_regional_content"</span>
</span><span id="__span-3-164"><a href="#__codelineno-3-164" id="__codelineno-3-164" name="__codelineno-3-164"></a>                    <span class="p">]</span>
</span><span id="__span-3-165"><a href="#__codelineno-3-165" id="__codelineno-3-165" name="__codelineno-3-165"></a>                <span class="p">}</span>
</span><span id="__span-3-166"><a href="#__codelineno-3-166" id="__codelineno-3-166" name="__codelineno-3-166"></a>            <span class="p">}</span>
</span><span id="__span-3-167"><a href="#__codelineno-3-167" id="__codelineno-3-167" name="__codelineno-3-167"></a>
</span><span id="__span-3-168"><a href="#__codelineno-3-168" id="__codelineno-3-168" name="__codelineno-3-168"></a>            <span class="n">educational_optimizations</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimization_schedule</span>
</span><span id="__span-3-169"><a href="#__codelineno-3-169" id="__codelineno-3-169" name="__codelineno-3-169"></a>
</span><span id="__span-3-170"><a href="#__codelineno-3-170" id="__codelineno-3-170" name="__codelineno-3-170"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-171"><a href="#__codelineno-3-171" id="__codelineno-3-171" name="__codelineno-3-171"></a>            <span class="s2">"regional_schedules"</span><span class="p">:</span> <span class="n">educational_optimizations</span><span class="p">,</span>
</span><span id="__span-3-172"><a href="#__codelineno-3-172" id="__codelineno-3-172" name="__codelineno-3-172"></a>            <span class="s2">"global_coordination"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_global_coordination_schedule</span><span class="p">(),</span>
</span><span id="__span-3-173"><a href="#__codelineno-3-173" id="__codelineno-3-173" name="__codelineno-3-173"></a>            <span class="s2">"monitoring_metrics"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_educational_monitoring_metrics</span><span class="p">()</span>
</span><span id="__span-3-174"><a href="#__codelineno-3-174" id="__codelineno-3-174" name="__codelineno-3-174"></a>        <span class="p">}</span>
</span><span id="__span-3-175"><a href="#__codelineno-3-175" id="__codelineno-3-175" name="__codelineno-3-175"></a>
</span><span id="__span-3-176"><a href="#__codelineno-3-176" id="__codelineno-3-176" name="__codelineno-3-176"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_global_coordination_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-177"><a href="#__codelineno-3-177" id="__codelineno-3-177" name="__codelineno-3-177"></a><span class="w">        </span><span class="sd">"""Create coordinated global schedule for educational optimization"""</span>
</span><span id="__span-3-178"><a href="#__codelineno-3-178" id="__codelineno-3-178" name="__codelineno-3-178"></a>
</span><span id="__span-3-179"><a href="#__codelineno-3-179" id="__codelineno-3-179" name="__codelineno-3-179"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-180"><a href="#__codelineno-3-180" id="__codelineno-3-180" name="__codelineno-3-180"></a>            <span class="s2">"timezone_cascade_warmup"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-181"><a href="#__codelineno-3-181" id="__codelineno-3-181" name="__codelineno-3-181"></a>                <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Warmup content as educational hours move across timezones"</span><span class="p">,</span>
</span><span id="__span-3-182"><a href="#__codelineno-3-182" id="__codelineno-3-182" name="__codelineno-3-182"></a>                <span class="s2">"schedule"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-183"><a href="#__codelineno-3-183" id="__codelineno-3-183" name="__codelineno-3-183"></a>                    <span class="p">{</span><span class="s2">"region"</span><span class="p">:</span> <span class="s2">"asia_pacific"</span><span class="p">,</span> <span class="s2">"warmup_time"</span><span class="p">:</span> <span class="s2">"06:00 JST"</span><span class="p">},</span>
</span><span id="__span-3-184"><a href="#__codelineno-3-184" id="__codelineno-3-184" name="__codelineno-3-184"></a>                    <span class="p">{</span><span class="s2">"region"</span><span class="p">:</span> <span class="s2">"eu_central"</span><span class="p">,</span> <span class="s2">"warmup_time"</span><span class="p">:</span> <span class="s2">"07:00 CET"</span><span class="p">},</span>
</span><span id="__span-3-185"><a href="#__codelineno-3-185" id="__codelineno-3-185" name="__codelineno-3-185"></a>                    <span class="p">{</span><span class="s2">"region"</span><span class="p">:</span> <span class="s2">"us_east"</span><span class="p">,</span> <span class="s2">"warmup_time"</span><span class="p">:</span> <span class="s2">"07:00 EST"</span><span class="p">},</span>
</span><span id="__span-3-186"><a href="#__codelineno-3-186" id="__codelineno-3-186" name="__codelineno-3-186"></a>                    <span class="p">{</span><span class="s2">"region"</span><span class="p">:</span> <span class="s2">"us_west"</span><span class="p">,</span> <span class="s2">"warmup_time"</span><span class="p">:</span> <span class="s2">"07:00 PST"</span><span class="p">}</span>
</span><span id="__span-3-187"><a href="#__codelineno-3-187" id="__codelineno-3-187" name="__codelineno-3-187"></a>                <span class="p">]</span>
</span><span id="__span-3-188"><a href="#__codelineno-3-188" id="__codelineno-3-188" name="__codelineno-3-188"></a>            <span class="p">},</span>
</span><span id="__span-3-189"><a href="#__codelineno-3-189" id="__codelineno-3-189" name="__codelineno-3-189"></a>            <span class="s2">"content_synchronization"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-190"><a href="#__codelineno-3-190" id="__codelineno-3-190" name="__codelineno-3-190"></a>                <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Sync new educational content across regions"</span><span class="p">,</span>
</span><span id="__span-3-191"><a href="#__codelineno-3-191" id="__codelineno-3-191" name="__codelineno-3-191"></a>                <span class="s2">"frequency"</span><span class="p">:</span> <span class="s2">"every_4_hours"</span><span class="p">,</span>
</span><span id="__span-3-192"><a href="#__codelineno-3-192" id="__codelineno-3-192" name="__codelineno-3-192"></a>                <span class="s2">"priority_content"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"daily_assignments"</span><span class="p">,</span> <span class="s2">"announcements"</span><span class="p">,</span> <span class="s2">"live_materials"</span><span class="p">]</span>
</span><span id="__span-3-193"><a href="#__codelineno-3-193" id="__codelineno-3-193" name="__codelineno-3-193"></a>            <span class="p">},</span>
</span><span id="__span-3-194"><a href="#__codelineno-3-194" id="__codelineno-3-194" name="__codelineno-3-194"></a>            <span class="s2">"cross_region_failover"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-195"><a href="#__codelineno-3-195" id="__codelineno-3-195" name="__codelineno-3-195"></a>                <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Automatic failover during regional issues"</span><span class="p">,</span>
</span><span id="__span-3-196"><a href="#__codelineno-3-196" id="__codelineno-3-196" name="__codelineno-3-196"></a>                <span class="s2">"failover_chains"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-197"><a href="#__codelineno-3-197" id="__codelineno-3-197" name="__codelineno-3-197"></a>                    <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"us_west"</span><span class="p">,</span> <span class="s2">"eu_central"</span><span class="p">],</span>
</span><span id="__span-3-198"><a href="#__codelineno-3-198" id="__codelineno-3-198" name="__codelineno-3-198"></a>                    <span class="s2">"us_west"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"us_east"</span><span class="p">,</span> <span class="s2">"asia_pacific"</span><span class="p">],</span>
</span><span id="__span-3-199"><a href="#__codelineno-3-199" id="__codelineno-3-199" name="__codelineno-3-199"></a>                    <span class="s2">"eu_central"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"us_east"</span><span class="p">,</span> <span class="s2">"asia_pacific"</span><span class="p">],</span>
</span><span id="__span-3-200"><a href="#__codelineno-3-200" id="__codelineno-3-200" name="__codelineno-3-200"></a>                    <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"us_west"</span><span class="p">,</span> <span class="s2">"eu_central"</span><span class="p">]</span>
</span><span id="__span-3-201"><a href="#__codelineno-3-201" id="__codelineno-3-201" name="__codelineno-3-201"></a>                <span class="p">}</span>
</span><span id="__span-3-202"><a href="#__codelineno-3-202" id="__codelineno-3-202" name="__codelineno-3-202"></a>            <span class="p">}</span>
</span><span id="__span-3-203"><a href="#__codelineno-3-203" id="__codelineno-3-203" name="__codelineno-3-203"></a>        <span class="p">}</span>
</span><span id="__span-3-204"><a href="#__codelineno-3-204" id="__codelineno-3-204" name="__codelineno-3-204"></a>
</span><span id="__span-3-205"><a href="#__codelineno-3-205" id="__codelineno-3-205" name="__codelineno-3-205"></a><span class="k">class</span><span class="w"> </span><span class="nc">TrafficAnalyzer</span><span class="p">:</span>
</span><span id="__span-3-206"><a href="#__codelineno-3-206" id="__codelineno-3-206" name="__codelineno-3-206"></a><span class="w">    </span><span class="sd">"""Analyzes traffic patterns for optimization"""</span>
</span><span id="__span-3-207"><a href="#__codelineno-3-207" id="__codelineno-3-207" name="__codelineno-3-207"></a>
</span><span id="__span-3-208"><a href="#__codelineno-3-208" id="__codelineno-3-208" name="__codelineno-3-208"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_geographic_traffic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-209"><a href="#__codelineno-3-209" id="__codelineno-3-209" name="__codelineno-3-209"></a><span class="w">        </span><span class="sd">"""Analyze traffic patterns across geographic regions"""</span>
</span><span id="__span-3-210"><a href="#__codelineno-3-210" id="__codelineno-3-210" name="__codelineno-3-210"></a>
</span><span id="__span-3-211"><a href="#__codelineno-3-211" id="__codelineno-3-211" name="__codelineno-3-211"></a>        <span class="c1"># This would integrate with actual CDN analytics</span>
</span><span id="__span-3-212"><a href="#__codelineno-3-212" id="__codelineno-3-212" name="__codelineno-3-212"></a>        <span class="c1"># Example implementation showing the structure</span>
</span><span id="__span-3-213"><a href="#__codelineno-3-213" id="__codelineno-3-213" name="__codelineno-3-213"></a>
</span><span id="__span-3-214"><a href="#__codelineno-3-214" id="__codelineno-3-214" name="__codelineno-3-214"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-215"><a href="#__codelineno-3-215" id="__codelineno-3-215" name="__codelineno-3-215"></a>            <span class="s2">"analysis_period_days"</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
</span><span id="__span-3-216"><a href="#__codelineno-3-216" id="__codelineno-3-216" name="__codelineno-3-216"></a>            <span class="s2">"total_requests"</span><span class="p">:</span> <span class="mi">45000000</span><span class="p">,</span>
</span><span id="__span-3-217"><a href="#__codelineno-3-217" id="__codelineno-3-217" name="__codelineno-3-217"></a>            <span class="s2">"total_bandwidth_tb"</span><span class="p">:</span> <span class="mf">125.5</span><span class="p">,</span>
</span><span id="__span-3-218"><a href="#__codelineno-3-218" id="__codelineno-3-218" name="__codelineno-3-218"></a>            <span class="s2">"regional_breakdown"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-219"><a href="#__codelineno-3-219" id="__codelineno-3-219" name="__codelineno-3-219"></a>                <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-220"><a href="#__codelineno-3-220" id="__codelineno-3-220" name="__codelineno-3-220"></a>                    <span class="s2">"requests"</span><span class="p">:</span> <span class="mi">18000000</span><span class="p">,</span>
</span><span id="__span-3-221"><a href="#__codelineno-3-221" id="__codelineno-3-221" name="__codelineno-3-221"></a>                    <span class="s2">"bandwidth_tb"</span><span class="p">:</span> <span class="mf">55.2</span><span class="p">,</span>
</span><span id="__span-3-222"><a href="#__codelineno-3-222" id="__codelineno-3-222" name="__codelineno-3-222"></a>                    <span class="s2">"peak_hours"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"09:00-12:00"</span><span class="p">,</span> <span class="s2">"14:00-16:00"</span><span class="p">],</span>
</span><span id="__span-3-223"><a href="#__codelineno-3-223" id="__codelineno-3-223" name="__codelineno-3-223"></a>                    <span class="s2">"performance_score"</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
</span><span id="__span-3-224"><a href="#__codelineno-3-224" id="__codelineno-3-224" name="__codelineno-3-224"></a>                    <span class="s2">"cost_efficiency"</span><span class="p">:</span> <span class="mf">0.85</span>
</span><span id="__span-3-225"><a href="#__codelineno-3-225" id="__codelineno-3-225" name="__codelineno-3-225"></a>                <span class="p">},</span>
</span><span id="__span-3-226"><a href="#__codelineno-3-226" id="__codelineno-3-226" name="__codelineno-3-226"></a>                <span class="s2">"us_west"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-227"><a href="#__codelineno-3-227" id="__codelineno-3-227" name="__codelineno-3-227"></a>                    <span class="s2">"requests"</span><span class="p">:</span> <span class="mi">12000000</span><span class="p">,</span>
</span><span id="__span-3-228"><a href="#__codelineno-3-228" id="__codelineno-3-228" name="__codelineno-3-228"></a>                    <span class="s2">"bandwidth_tb"</span><span class="p">:</span> <span class="mf">35.1</span><span class="p">,</span>
</span><span id="__span-3-229"><a href="#__codelineno-3-229" id="__codelineno-3-229" name="__codelineno-3-229"></a>                    <span class="s2">"peak_hours"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"10:00-13:00"</span><span class="p">,</span> <span class="s2">"15:00-17:00"</span><span class="p">],</span>
</span><span id="__span-3-230"><a href="#__codelineno-3-230" id="__codelineno-3-230" name="__codelineno-3-230"></a>                    <span class="s2">"performance_score"</span><span class="p">:</span> <span class="mf">0.89</span><span class="p">,</span>
</span><span id="__span-3-231"><a href="#__codelineno-3-231" id="__codelineno-3-231" name="__codelineno-3-231"></a>                    <span class="s2">"cost_efficiency"</span><span class="p">:</span> <span class="mf">0.82</span>
</span><span id="__span-3-232"><a href="#__codelineno-3-232" id="__codelineno-3-232" name="__codelineno-3-232"></a>                <span class="p">},</span>
</span><span id="__span-3-233"><a href="#__codelineno-3-233" id="__codelineno-3-233" name="__codelineno-3-233"></a>                <span class="s2">"eu_central"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-234"><a href="#__codelineno-3-234" id="__codelineno-3-234" name="__codelineno-3-234"></a>                    <span class="s2">"requests"</span><span class="p">:</span> <span class="mi">10000000</span><span class="p">,</span>
</span><span id="__span-3-235"><a href="#__codelineno-3-235" id="__codelineno-3-235" name="__codelineno-3-235"></a>                    <span class="s2">"bandwidth_tb"</span><span class="p">:</span> <span class="mf">25.8</span><span class="p">,</span>
</span><span id="__span-3-236"><a href="#__codelineno-3-236" id="__codelineno-3-236" name="__codelineno-3-236"></a>                    <span class="s2">"peak_hours"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"08:00-11:00"</span><span class="p">,</span> <span class="s2">"13:00-15:00"</span><span class="p">],</span>
</span><span id="__span-3-237"><a href="#__codelineno-3-237" id="__codelineno-3-237" name="__codelineno-3-237"></a>                    <span class="s2">"performance_score"</span><span class="p">:</span> <span class="mf">0.87</span><span class="p">,</span>
</span><span id="__span-3-238"><a href="#__codelineno-3-238" id="__codelineno-3-238" name="__codelineno-3-238"></a>                    <span class="s2">"cost_efficiency"</span><span class="p">:</span> <span class="mf">0.78</span>
</span><span id="__span-3-239"><a href="#__codelineno-3-239" id="__codelineno-3-239" name="__codelineno-3-239"></a>                <span class="p">},</span>
</span><span id="__span-3-240"><a href="#__codelineno-3-240" id="__codelineno-3-240" name="__codelineno-3-240"></a>                <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-241"><a href="#__codelineno-3-241" id="__codelineno-3-241" name="__codelineno-3-241"></a>                    <span class="s2">"requests"</span><span class="p">:</span> <span class="mi">5000000</span><span class="p">,</span>
</span><span id="__span-3-242"><a href="#__codelineno-3-242" id="__codelineno-3-242" name="__codelineno-3-242"></a>                    <span class="s2">"bandwidth_tb"</span><span class="p">:</span> <span class="mf">9.4</span><span class="p">,</span>
</span><span id="__span-3-243"><a href="#__codelineno-3-243" id="__codelineno-3-243" name="__codelineno-3-243"></a>                    <span class="s2">"peak_hours"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"09:00-12:00"</span><span class="p">,</span> <span class="s2">"14:00-16:00"</span><span class="p">],</span>
</span><span id="__span-3-244"><a href="#__codelineno-3-244" id="__codelineno-3-244" name="__codelineno-3-244"></a>                    <span class="s2">"performance_score"</span><span class="p">:</span> <span class="mf">0.81</span><span class="p">,</span>
</span><span id="__span-3-245"><a href="#__codelineno-3-245" id="__codelineno-3-245" name="__codelineno-3-245"></a>                    <span class="s2">"cost_efficiency"</span><span class="p">:</span> <span class="mf">0.75</span>
</span><span id="__span-3-246"><a href="#__codelineno-3-246" id="__codelineno-3-246" name="__codelineno-3-246"></a>                <span class="p">}</span>
</span><span id="__span-3-247"><a href="#__codelineno-3-247" id="__codelineno-3-247" name="__codelineno-3-247"></a>            <span class="p">},</span>
</span><span id="__span-3-248"><a href="#__codelineno-3-248" id="__codelineno-3-248" name="__codelineno-3-248"></a>            <span class="s2">"content_type_analysis"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_content_type_patterns</span><span class="p">(),</span>
</span><span id="__span-3-249"><a href="#__codelineno-3-249" id="__codelineno-3-249" name="__codelineno-3-249"></a>            <span class="s2">"temporal_patterns"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_temporal_patterns</span><span class="p">(),</span>
</span><span id="__span-3-250"><a href="#__codelineno-3-250" id="__codelineno-3-250" name="__codelineno-3-250"></a>            <span class="s2">"user_behavior_insights"</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_user_behavior</span><span class="p">()</span>
</span><span id="__span-3-251"><a href="#__codelineno-3-251" id="__codelineno-3-251" name="__codelineno-3-251"></a>        <span class="p">}</span>
</span><span id="__span-3-252"><a href="#__codelineno-3-252" id="__codelineno-3-252" name="__codelineno-3-252"></a>
</span><span id="__span-3-253"><a href="#__codelineno-3-253" id="__codelineno-3-253" name="__codelineno-3-253"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_content_type_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-254"><a href="#__codelineno-3-254" id="__codelineno-3-254" name="__codelineno-3-254"></a><span class="w">        </span><span class="sd">"""Analyze how different content types are accessed globally"""</span>
</span><span id="__span-3-255"><a href="#__codelineno-3-255" id="__codelineno-3-255" name="__codelineno-3-255"></a>
</span><span id="__span-3-256"><a href="#__codelineno-3-256" id="__codelineno-3-256" name="__codelineno-3-256"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-257"><a href="#__codelineno-3-257" id="__codelineno-3-257" name="__codelineno-3-257"></a>            <span class="s2">"educational_content"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-258"><a href="#__codelineno-3-258" id="__codelineno-3-258" name="__codelineno-3-258"></a>                <span class="s2">"global_distribution"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-259"><a href="#__codelineno-3-259" id="__codelineno-3-259" name="__codelineno-3-259"></a>                    <span class="s2">"us_east"</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>
</span><span id="__span-3-260"><a href="#__codelineno-3-260" id="__codelineno-3-260" name="__codelineno-3-260"></a>                    <span class="s2">"us_west"</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
</span><span id="__span-3-261"><a href="#__codelineno-3-261" id="__codelineno-3-261" name="__codelineno-3-261"></a>                    <span class="s2">"eu_central"</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
</span><span id="__span-3-262"><a href="#__codelineno-3-262" id="__codelineno-3-262" name="__codelineno-3-262"></a>                    <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="mf">0.15</span>
</span><span id="__span-3-263"><a href="#__codelineno-3-263" id="__codelineno-3-263" name="__codelineno-3-263"></a>                <span class="p">},</span>
</span><span id="__span-3-264"><a href="#__codelineno-3-264" id="__codelineno-3-264" name="__codelineno-3-264"></a>                <span class="s2">"peak_access_times"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"09:00-15:00"</span><span class="p">],</span>
</span><span id="__span-3-265"><a href="#__codelineno-3-265" id="__codelineno-3-265" name="__codelineno-3-265"></a>                <span class="s2">"seasonal_variations"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"fall_semester"</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span> <span class="s2">"spring_semester"</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s2">"summer"</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
</span><span id="__span-3-266"><a href="#__codelineno-3-266" id="__codelineno-3-266" name="__codelineno-3-266"></a>            <span class="p">},</span>
</span><span id="__span-3-267"><a href="#__codelineno-3-267" id="__codelineno-3-267" name="__codelineno-3-267"></a>            <span class="s2">"media_resource"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-268"><a href="#__codelineno-3-268" id="__codelineno-3-268" name="__codelineno-3-268"></a>                <span class="s2">"global_distribution"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-269"><a href="#__codelineno-3-269" id="__codelineno-3-269" name="__codelineno-3-269"></a>                    <span class="s2">"us_east"</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
</span><span id="__span-3-270"><a href="#__codelineno-3-270" id="__codelineno-3-270" name="__codelineno-3-270"></a>                    <span class="s2">"us_west"</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
</span><span id="__span-3-271"><a href="#__codelineno-3-271" id="__codelineno-3-271" name="__codelineno-3-271"></a>                    <span class="s2">"eu_central"</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
</span><span id="__span-3-272"><a href="#__codelineno-3-272" id="__codelineno-3-272" name="__codelineno-3-272"></a>                    <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="mf">0.10</span>
</span><span id="__span-3-273"><a href="#__codelineno-3-273" id="__codelineno-3-273" name="__codelineno-3-273"></a>                <span class="p">},</span>
</span><span id="__span-3-274"><a href="#__codelineno-3-274" id="__codelineno-3-274" name="__codelineno-3-274"></a>                <span class="s2">"peak_access_times"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"10:00-14:00"</span><span class="p">,</span> <span class="s2">"19:00-21:00"</span><span class="p">],</span>
</span><span id="__span-3-275"><a href="#__codelineno-3-275" id="__codelineno-3-275" name="__codelineno-3-275"></a>                <span class="s2">"seasonal_variations"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"fall_semester"</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span> <span class="s2">"spring_semester"</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span> <span class="s2">"summer"</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
</span><span id="__span-3-276"><a href="#__codelineno-3-276" id="__codelineno-3-276" name="__codelineno-3-276"></a>            <span class="p">}</span>
</span><span id="__span-3-277"><a href="#__codelineno-3-277" id="__codelineno-3-277" name="__codelineno-3-277"></a>        <span class="p">}</span>
</span><span id="__span-3-278"><a href="#__codelineno-3-278" id="__codelineno-3-278" name="__codelineno-3-278"></a>
</span><span id="__span-3-279"><a href="#__codelineno-3-279" id="__codelineno-3-279" name="__codelineno-3-279"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_traffic_patterns</span><span class="p">(</span>
</span><span id="__span-3-280"><a href="#__codelineno-3-280" id="__codelineno-3-280" name="__codelineno-3-280"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-3-281"><a href="#__codelineno-3-281" id="__codelineno-3-281" name="__codelineno-3-281"></a>        <span class="n">forecast_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-3-282"><a href="#__codelineno-3-282" id="__codelineno-3-282" name="__codelineno-3-282"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-283"><a href="#__codelineno-3-283" id="__codelineno-3-283" name="__codelineno-3-283"></a><span class="w">        </span><span class="sd">"""Predict future traffic patterns"""</span>
</span><span id="__span-3-284"><a href="#__codelineno-3-284" id="__codelineno-3-284" name="__codelineno-3-284"></a>
</span><span id="__span-3-285"><a href="#__codelineno-3-285" id="__codelineno-3-285" name="__codelineno-3-285"></a>        <span class="c1"># Machine learning model would be implemented here</span>
</span><span id="__span-3-286"><a href="#__codelineno-3-286" id="__codelineno-3-286" name="__codelineno-3-286"></a>        <span class="c1"># For now, returning example structured prediction</span>
</span><span id="__span-3-287"><a href="#__codelineno-3-287" id="__codelineno-3-287" name="__codelineno-3-287"></a>
</span><span id="__span-3-288"><a href="#__codelineno-3-288" id="__codelineno-3-288" name="__codelineno-3-288"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-289"><a href="#__codelineno-3-289" id="__codelineno-3-289" name="__codelineno-3-289"></a>            <span class="s2">"forecast_period_days"</span><span class="p">:</span> <span class="n">forecast_days</span><span class="p">,</span>
</span><span id="__span-3-290"><a href="#__codelineno-3-290" id="__codelineno-3-290" name="__codelineno-3-290"></a>            <span class="s2">"confidence_level"</span><span class="p">:</span> <span class="mf">0.87</span><span class="p">,</span>
</span><span id="__span-3-291"><a href="#__codelineno-3-291" id="__codelineno-3-291" name="__codelineno-3-291"></a>            <span class="s2">"predicted_growth_rate"</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>  <span class="c1"># 12% growth</span>
</span><span id="__span-3-292"><a href="#__codelineno-3-292" id="__codelineno-3-292" name="__codelineno-3-292"></a>            <span class="s2">"regional_predictions"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-293"><a href="#__codelineno-3-293" id="__codelineno-3-293" name="__codelineno-3-293"></a>                <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-294"><a href="#__codelineno-3-294" id="__codelineno-3-294" name="__codelineno-3-294"></a>                    <span class="s2">"expected_growth"</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
</span><span id="__span-3-295"><a href="#__codelineno-3-295" id="__codelineno-3-295" name="__codelineno-3-295"></a>                    <span class="s2">"peak_load_increase"</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
</span><span id="__span-3-296"><a href="#__codelineno-3-296" id="__codelineno-3-296" name="__codelineno-3-296"></a>                    <span class="s2">"new_content_demand"</span><span class="p">:</span> <span class="mi">1250</span>  <span class="c1"># GB</span>
</span><span id="__span-3-297"><a href="#__codelineno-3-297" id="__codelineno-3-297" name="__codelineno-3-297"></a>                <span class="p">},</span>
</span><span id="__span-3-298"><a href="#__codelineno-3-298" id="__codelineno-3-298" name="__codelineno-3-298"></a>                <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-299"><a href="#__codelineno-3-299" id="__codelineno-3-299" name="__codelineno-3-299"></a>                    <span class="s2">"expected_growth"</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># Highest growth region</span>
</span><span id="__span-3-300"><a href="#__codelineno-3-300" id="__codelineno-3-300" name="__codelineno-3-300"></a>                    <span class="s2">"peak_load_increase"</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>
</span><span id="__span-3-301"><a href="#__codelineno-3-301" id="__codelineno-3-301" name="__codelineno-3-301"></a>                    <span class="s2">"new_content_demand"</span><span class="p">:</span> <span class="mi">800</span>
</span><span id="__span-3-302"><a href="#__codelineno-3-302" id="__codelineno-3-302" name="__codelineno-3-302"></a>                <span class="p">}</span>
</span><span id="__span-3-303"><a href="#__codelineno-3-303" id="__codelineno-3-303" name="__codelineno-3-303"></a>            <span class="p">},</span>
</span><span id="__span-3-304"><a href="#__codelineno-3-304" id="__codelineno-3-304" name="__codelineno-3-304"></a>            <span class="s2">"recommended_actions"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-305"><a href="#__codelineno-3-305" id="__codelineno-3-305" name="__codelineno-3-305"></a>                <span class="s2">"Increase Asia-Pacific capacity by 30%"</span><span class="p">,</span>
</span><span id="__span-3-306"><a href="#__codelineno-3-306" id="__codelineno-3-306" name="__codelineno-3-306"></a>                <span class="s2">"Implement proactive cache warmup for US regions"</span><span class="p">,</span>
</span><span id="__span-3-307"><a href="#__codelineno-3-307" id="__codelineno-3-307" name="__codelineno-3-307"></a>                <span class="s2">"Consider new PoP in India for Asia-Pacific expansion"</span>
</span><span id="__span-3-308"><a href="#__codelineno-3-308" id="__codelineno-3-308" name="__codelineno-3-308"></a>            <span class="p">]</span>
</span><span id="__span-3-309"><a href="#__codelineno-3-309" id="__codelineno-3-309" name="__codelineno-3-309"></a>        <span class="p">}</span>
</span></code></pre></div> <h2 id="performance-metrics">Performance Metrics<a class="headerlink" href="#performance-metrics" title="Permanent link">¶</a></h2> <h3 id="comprehensive-performance-monitoring">Comprehensive Performance Monitoring<a class="headerlink" href="#comprehensive-performance-monitoring" title="Permanent link">¶</a></h3> <div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="nd">@dataclass</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMetric</span><span class="p">:</span>
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="sd">"""Individual performance metric"""</span>
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-14"><a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-4-15"><a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="n">region</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-16"><a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>    <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-17"><a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>
</span><span id="__span-4-18"><a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="nd">@dataclass</span>
</span><span id="__span-4-19"><a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceReport</span><span class="p">:</span>
</span><span id="__span-4-20"><a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="sd">"""Comprehensive performance report"""</span>
</span><span id="__span-4-21"><a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>    <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-22"><a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">]</span>
</span><span id="__span-4-23"><a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>    <span class="n">summary</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-4-24"><a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>    <span class="n">recommendations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-4-25"><a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>    <span class="n">alerts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-4-26"><a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>
</span><span id="__span-4-27"><a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">CDNPerformanceMonitor</span><span class="p">:</span>
</span><span id="__span-4-28"><a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="sd">"""Monitors and analyzes CDN performance"""</span>
</span><span id="__span-4-29"><a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a>
</span><span id="__span-4-30"><a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span><span class="p">):</span>
</span><span id="__span-4-31"><a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">cdn_manager</span>
</span><span id="__span-4-32"><a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_endpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_monitoring_endpoints</span><span class="p">()</span>
</span><span id="__span-4-33"><a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">performance_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_performance_thresholds</span><span class="p">()</span>
</span><span id="__span-4-34"><a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a>
</span><span id="__span-4-35"><a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_monitoring_endpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="__span-4-36"><a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">        </span><span class="sd">"""Setup monitoring endpoints for different regions"""</span>
</span><span id="__span-4-37"><a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a>
</span><span id="__span-4-38"><a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-39"><a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>            <span class="s2">"us_east"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-4-40"><a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a>                <span class="s2">"https://monitor-use1.toolboxai.com/health"</span><span class="p">,</span>
</span><span id="__span-4-41"><a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a>                <span class="s2">"https://monitor-use2.toolboxai.com/health"</span>
</span><span id="__span-4-42"><a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a>            <span class="p">],</span>
</span><span id="__span-4-43"><a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a>            <span class="s2">"us_west"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-4-44"><a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a>                <span class="s2">"https://monitor-usw1.toolboxai.com/health"</span><span class="p">,</span>
</span><span id="__span-4-45"><a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a>                <span class="s2">"https://monitor-usw2.toolboxai.com/health"</span>
</span><span id="__span-4-46"><a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="p">],</span>
</span><span id="__span-4-47"><a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="s2">"eu_central"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-4-48"><a href="#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a>                <span class="s2">"https://monitor-euc1.toolboxai.com/health"</span><span class="p">,</span>
</span><span id="__span-4-49"><a href="#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a>                <span class="s2">"https://monitor-euc2.toolboxai.com/health"</span>
</span><span id="__span-4-50"><a href="#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a>            <span class="p">],</span>
</span><span id="__span-4-51"><a href="#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a>            <span class="s2">"asia_pacific"</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-4-52"><a href="#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a>                <span class="s2">"https://monitor-apa1.toolboxai.com/health"</span><span class="p">,</span>
</span><span id="__span-4-53"><a href="#__codelineno-4-53" id="__codelineno-4-53" name="__codelineno-4-53"></a>                <span class="s2">"https://monitor-apa2.toolboxai.com/health"</span>
</span><span id="__span-4-54"><a href="#__codelineno-4-54" id="__codelineno-4-54" name="__codelineno-4-54"></a>            <span class="p">]</span>
</span><span id="__span-4-55"><a href="#__codelineno-4-55" id="__codelineno-4-55" name="__codelineno-4-55"></a>        <span class="p">}</span>
</span><span id="__span-4-56"><a href="#__codelineno-4-56" id="__codelineno-4-56" name="__codelineno-4-56"></a>
</span><span id="__span-4-57"><a href="#__codelineno-4-57" id="__codelineno-4-57" name="__codelineno-4-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_performance_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="__span-4-58"><a href="#__codelineno-4-58" id="__codelineno-4-58" name="__codelineno-4-58"></a><span class="w">        </span><span class="sd">"""Load performance thresholds for alerting"""</span>
</span><span id="__span-4-59"><a href="#__codelineno-4-59" id="__codelineno-4-59" name="__codelineno-4-59"></a>
</span><span id="__span-4-60"><a href="#__codelineno-4-60" id="__codelineno-4-60" name="__codelineno-4-60"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-61"><a href="#__codelineno-4-61" id="__codelineno-4-61" name="__codelineno-4-61"></a>            <span class="s2">"response_time_ms"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-62"><a href="#__codelineno-4-62" id="__codelineno-4-62" name="__codelineno-4-62"></a>                <span class="s2">"excellent"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="__span-4-63"><a href="#__codelineno-4-63" id="__codelineno-4-63" name="__codelineno-4-63"></a>                <span class="s2">"good"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span id="__span-4-64"><a href="#__codelineno-4-64" id="__codelineno-4-64" name="__codelineno-4-64"></a>                <span class="s2">"warning"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
</span><span id="__span-4-65"><a href="#__codelineno-4-65" id="__codelineno-4-65" name="__codelineno-4-65"></a>                <span class="s2">"critical"</span><span class="p">:</span> <span class="mi">1000</span>
</span><span id="__span-4-66"><a href="#__codelineno-4-66" id="__codelineno-4-66" name="__codelineno-4-66"></a>            <span class="p">},</span>
</span><span id="__span-4-67"><a href="#__codelineno-4-67" id="__codelineno-4-67" name="__codelineno-4-67"></a>            <span class="s2">"cache_hit_ratio"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-68"><a href="#__codelineno-4-68" id="__codelineno-4-68" name="__codelineno-4-68"></a>                <span class="s2">"excellent"</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="__span-4-69"><a href="#__codelineno-4-69" id="__codelineno-4-69" name="__codelineno-4-69"></a>                <span class="s2">"good"</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
</span><span id="__span-4-70"><a href="#__codelineno-4-70" id="__codelineno-4-70" name="__codelineno-4-70"></a>                <span class="s2">"warning"</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
</span><span id="__span-4-71"><a href="#__codelineno-4-71" id="__codelineno-4-71" name="__codelineno-4-71"></a>                <span class="s2">"critical"</span><span class="p">:</span> <span class="mf">0.80</span>
</span><span id="__span-4-72"><a href="#__codelineno-4-72" id="__codelineno-4-72" name="__codelineno-4-72"></a>            <span class="p">},</span>
</span><span id="__span-4-73"><a href="#__codelineno-4-73" id="__codelineno-4-73" name="__codelineno-4-73"></a>            <span class="s2">"error_rate"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-74"><a href="#__codelineno-4-74" id="__codelineno-4-74" name="__codelineno-4-74"></a>                <span class="s2">"excellent"</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
</span><span id="__span-4-75"><a href="#__codelineno-4-75" id="__codelineno-4-75" name="__codelineno-4-75"></a>                <span class="s2">"good"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="__span-4-76"><a href="#__codelineno-4-76" id="__codelineno-4-76" name="__codelineno-4-76"></a>                <span class="s2">"warning"</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="__span-4-77"><a href="#__codelineno-4-77" id="__codelineno-4-77" name="__codelineno-4-77"></a>                <span class="s2">"critical"</span><span class="p">:</span> <span class="mf">0.10</span>
</span><span id="__span-4-78"><a href="#__codelineno-4-78" id="__codelineno-4-78" name="__codelineno-4-78"></a>            <span class="p">},</span>
</span><span id="__span-4-79"><a href="#__codelineno-4-79" id="__codelineno-4-79" name="__codelineno-4-79"></a>            <span class="s2">"bandwidth_utilization"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-80"><a href="#__codelineno-4-80" id="__codelineno-4-80" name="__codelineno-4-80"></a>                <span class="s2">"excellent"</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">,</span>
</span><span id="__span-4-81"><a href="#__codelineno-4-81" id="__codelineno-4-81" name="__codelineno-4-81"></a>                <span class="s2">"good"</span><span class="p">:</span> <span class="mf">0.80</span><span class="p">,</span>
</span><span id="__span-4-82"><a href="#__codelineno-4-82" id="__codelineno-4-82" name="__codelineno-4-82"></a>                <span class="s2">"warning"</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">,</span>
</span><span id="__span-4-83"><a href="#__codelineno-4-83" id="__codelineno-4-83" name="__codelineno-4-83"></a>                <span class="s2">"critical"</span><span class="p">:</span> <span class="mf">0.95</span>
</span><span id="__span-4-84"><a href="#__codelineno-4-84" id="__codelineno-4-84" name="__codelineno-4-84"></a>            <span class="p">}</span>
</span><span id="__span-4-85"><a href="#__codelineno-4-85" id="__codelineno-4-85" name="__codelineno-4-85"></a>        <span class="p">}</span>
</span><span id="__span-4-86"><a href="#__codelineno-4-86" id="__codelineno-4-86" name="__codelineno-4-86"></a>
</span><span id="__span-4-87"><a href="#__codelineno-4-87" id="__codelineno-4-87" name="__codelineno-4-87"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">measure_performance</span><span class="p">(</span>
</span><span id="__span-4-88"><a href="#__codelineno-4-88" id="__codelineno-4-88" name="__codelineno-4-88"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-89"><a href="#__codelineno-4-89" id="__codelineno-4-89" name="__codelineno-4-89"></a>        <span class="n">test_urls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-90"><a href="#__codelineno-4-90" id="__codelineno-4-90" name="__codelineno-4-90"></a>        <span class="n">regions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-91"><a href="#__codelineno-4-91" id="__codelineno-4-91" name="__codelineno-4-91"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PerformanceReport</span><span class="p">:</span>
</span><span id="__span-4-92"><a href="#__codelineno-4-92" id="__codelineno-4-92" name="__codelineno-4-92"></a><span class="w">        </span><span class="sd">"""Measure comprehensive CDN performance"""</span>
</span><span id="__span-4-93"><a href="#__codelineno-4-93" id="__codelineno-4-93" name="__codelineno-4-93"></a>
</span><span id="__span-4-94"><a href="#__codelineno-4-94" id="__codelineno-4-94" name="__codelineno-4-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="__span-4-95"><a href="#__codelineno-4-95" id="__codelineno-4-95" name="__codelineno-4-95"></a>            <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"us_east"</span><span class="p">,</span> <span class="s2">"us_west"</span><span class="p">,</span> <span class="s2">"eu_central"</span><span class="p">,</span> <span class="s2">"asia_pacific"</span><span class="p">]</span>
</span><span id="__span-4-96"><a href="#__codelineno-4-96" id="__codelineno-4-96" name="__codelineno-4-96"></a>
</span><span id="__span-4-97"><a href="#__codelineno-4-97" id="__codelineno-4-97" name="__codelineno-4-97"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_urls</span><span class="p">:</span>
</span><span id="__span-4-98"><a href="#__codelineno-4-98" id="__codelineno-4-98" name="__codelineno-4-98"></a>            <span class="n">test_urls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_test_urls</span><span class="p">()</span>
</span><span id="__span-4-99"><a href="#__codelineno-4-99" id="__codelineno-4-99" name="__codelineno-4-99"></a>
</span><span id="__span-4-100"><a href="#__codelineno-4-100" id="__codelineno-4-100" name="__codelineno-4-100"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-4-101"><a href="#__codelineno-4-101" id="__codelineno-4-101" name="__codelineno-4-101"></a>        <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-102"><a href="#__codelineno-4-102" id="__codelineno-4-102" name="__codelineno-4-102"></a>
</span><span id="__span-4-103"><a href="#__codelineno-4-103" id="__codelineno-4-103" name="__codelineno-4-103"></a>        <span class="c1"># Measure performance from each region</span>
</span><span id="__span-4-104"><a href="#__codelineno-4-104" id="__codelineno-4-104" name="__codelineno-4-104"></a>        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="__span-4-105"><a href="#__codelineno-4-105" id="__codelineno-4-105" name="__codelineno-4-105"></a>            <span class="n">region_metrics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_region_performance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">test_urls</span><span class="p">)</span>
</span><span id="__span-4-106"><a href="#__codelineno-4-106" id="__codelineno-4-106" name="__codelineno-4-106"></a>            <span class="n">all_metrics</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">region_metrics</span><span class="p">)</span>
</span><span id="__span-4-107"><a href="#__codelineno-4-107" id="__codelineno-4-107" name="__codelineno-4-107"></a>
</span><span id="__span-4-108"><a href="#__codelineno-4-108" id="__codelineno-4-108" name="__codelineno-4-108"></a>        <span class="c1"># Measure global performance</span>
</span><span id="__span-4-109"><a href="#__codelineno-4-109" id="__codelineno-4-109" name="__codelineno-4-109"></a>        <span class="n">global_metrics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_global_performance</span><span class="p">(</span><span class="n">test_urls</span><span class="p">)</span>
</span><span id="__span-4-110"><a href="#__codelineno-4-110" id="__codelineno-4-110" name="__codelineno-4-110"></a>        <span class="n">all_metrics</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">global_metrics</span><span class="p">)</span>
</span><span id="__span-4-111"><a href="#__codelineno-4-111" id="__codelineno-4-111" name="__codelineno-4-111"></a>
</span><span id="__span-4-112"><a href="#__codelineno-4-112" id="__codelineno-4-112" name="__codelineno-4-112"></a>        <span class="c1"># Generate summary</span>
</span><span id="__span-4-113"><a href="#__codelineno-4-113" id="__codelineno-4-113" name="__codelineno-4-113"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_performance_summary</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">)</span>
</span><span id="__span-4-114"><a href="#__codelineno-4-114" id="__codelineno-4-114" name="__codelineno-4-114"></a>
</span><span id="__span-4-115"><a href="#__codelineno-4-115" id="__codelineno-4-115" name="__codelineno-4-115"></a>        <span class="c1"># Generate recommendations</span>
</span><span id="__span-4-116"><a href="#__codelineno-4-116" id="__codelineno-4-116" name="__codelineno-4-116"></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_recommendations</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
</span><span id="__span-4-117"><a href="#__codelineno-4-117" id="__codelineno-4-117" name="__codelineno-4-117"></a>
</span><span id="__span-4-118"><a href="#__codelineno-4-118" id="__codelineno-4-118" name="__codelineno-4-118"></a>        <span class="c1"># Check for alerts</span>
</span><span id="__span-4-119"><a href="#__codelineno-4-119" id="__codelineno-4-119" name="__codelineno-4-119"></a>        <span class="n">alerts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_performance_alerts</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">)</span>
</span><span id="__span-4-120"><a href="#__codelineno-4-120" id="__codelineno-4-120" name="__codelineno-4-120"></a>
</span><span id="__span-4-121"><a href="#__codelineno-4-121" id="__codelineno-4-121" name="__codelineno-4-121"></a>        <span class="k">return</span> <span class="n">PerformanceReport</span><span class="p">(</span>
</span><span id="__span-4-122"><a href="#__codelineno-4-122" id="__codelineno-4-122" name="__codelineno-4-122"></a>            <span class="n">timeframe</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-4-123"><a href="#__codelineno-4-123" id="__codelineno-4-123" name="__codelineno-4-123"></a>            <span class="n">metrics</span><span class="o">=</span><span class="n">all_metrics</span><span class="p">,</span>
</span><span id="__span-4-124"><a href="#__codelineno-4-124" id="__codelineno-4-124" name="__codelineno-4-124"></a>            <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
</span><span id="__span-4-125"><a href="#__codelineno-4-125" id="__codelineno-4-125" name="__codelineno-4-125"></a>            <span class="n">recommendations</span><span class="o">=</span><span class="n">recommendations</span><span class="p">,</span>
</span><span id="__span-4-126"><a href="#__codelineno-4-126" id="__codelineno-4-126" name="__codelineno-4-126"></a>            <span class="n">alerts</span><span class="o">=</span><span class="n">alerts</span>
</span><span id="__span-4-127"><a href="#__codelineno-4-127" id="__codelineno-4-127" name="__codelineno-4-127"></a>        <span class="p">)</span>
</span><span id="__span-4-128"><a href="#__codelineno-4-128" id="__codelineno-4-128" name="__codelineno-4-128"></a>
</span><span id="__span-4-129"><a href="#__codelineno-4-129" id="__codelineno-4-129" name="__codelineno-4-129"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_test_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-4-130"><a href="#__codelineno-4-130" id="__codelineno-4-130" name="__codelineno-4-130"></a><span class="w">        </span><span class="sd">"""Generate representative test URLs"""</span>
</span><span id="__span-4-131"><a href="#__codelineno-4-131" id="__codelineno-4-131" name="__codelineno-4-131"></a>
</span><span id="__span-4-132"><a href="#__codelineno-4-132" id="__codelineno-4-132" name="__codelineno-4-132"></a>        <span class="n">base_files</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-133"><a href="#__codelineno-4-133" id="__codelineno-4-133" name="__codelineno-4-133"></a>            <span class="s2">"test-files/image-small.jpg"</span><span class="p">,</span>
</span><span id="__span-4-134"><a href="#__codelineno-4-134" id="__codelineno-4-134" name="__codelineno-4-134"></a>            <span class="s2">"test-files/image-large.jpg"</span><span class="p">,</span>
</span><span id="__span-4-135"><a href="#__codelineno-4-135" id="__codelineno-4-135" name="__codelineno-4-135"></a>            <span class="s2">"test-files/document.pdf"</span><span class="p">,</span>
</span><span id="__span-4-136"><a href="#__codelineno-4-136" id="__codelineno-4-136" name="__codelineno-4-136"></a>            <span class="s2">"test-files/video-preview.mp4"</span>
</span><span id="__span-4-137"><a href="#__codelineno-4-137" id="__codelineno-4-137" name="__codelineno-4-137"></a>        <span class="p">]</span>
</span><span id="__span-4-138"><a href="#__codelineno-4-138" id="__codelineno-4-138" name="__codelineno-4-138"></a>
</span><span id="__span-4-139"><a href="#__codelineno-4-139" id="__codelineno-4-139" name="__codelineno-4-139"></a>        <span class="n">test_urls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-140"><a href="#__codelineno-4-140" id="__codelineno-4-140" name="__codelineno-4-140"></a>
</span><span id="__span-4-141"><a href="#__codelineno-4-141" id="__codelineno-4-141" name="__codelineno-4-141"></a>        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">base_files</span><span class="p">:</span>
</span><span id="__span-4-142"><a href="#__codelineno-4-142" id="__codelineno-4-142" name="__codelineno-4-142"></a>            <span class="c1"># Base URL</span>
</span><span id="__span-4-143"><a href="#__codelineno-4-143" id="__codelineno-4-143" name="__codelineno-4-143"></a>            <span class="n">base_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_optimized_url</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-4-144"><a href="#__codelineno-4-144" id="__codelineno-4-144" name="__codelineno-4-144"></a>            <span class="n">test_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="__span-4-145"><a href="#__codelineno-4-145" id="__codelineno-4-145" name="__codelineno-4-145"></a>
</span><span id="__span-4-146"><a href="#__codelineno-4-146" id="__codelineno-4-146" name="__codelineno-4-146"></a>            <span class="c1"># Transformed URLs</span>
</span><span id="__span-4-147"><a href="#__codelineno-4-147" id="__codelineno-4-147" name="__codelineno-4-147"></a>            <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_preset_url</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">"thumbnail"</span><span class="p">)</span>
</span><span id="__span-4-148"><a href="#__codelineno-4-148" id="__codelineno-4-148" name="__codelineno-4-148"></a>            <span class="n">test_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thumbnail_url</span><span class="p">)</span>
</span><span id="__span-4-149"><a href="#__codelineno-4-149" id="__codelineno-4-149" name="__codelineno-4-149"></a>
</span><span id="__span-4-150"><a href="#__codelineno-4-150" id="__codelineno-4-150" name="__codelineno-4-150"></a>            <span class="c1"># Responsive variants</span>
</span><span id="__span-4-151"><a href="#__codelineno-4-151" id="__codelineno-4-151" name="__codelineno-4-151"></a>            <span class="n">responsive_urls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="o">.</span><span class="n">get_responsive_urls</span><span class="p">(</span>
</span><span id="__span-4-152"><a href="#__codelineno-4-152" id="__codelineno-4-152" name="__codelineno-4-152"></a>                <span class="n">file_path</span><span class="p">,</span>
</span><span id="__span-4-153"><a href="#__codelineno-4-153" id="__codelineno-4-153" name="__codelineno-4-153"></a>                <span class="n">breakpoints</span><span class="o">=</span><span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
</span><span id="__span-4-154"><a href="#__codelineno-4-154" id="__codelineno-4-154" name="__codelineno-4-154"></a>            <span class="p">)</span>
</span><span id="__span-4-155"><a href="#__codelineno-4-155" id="__codelineno-4-155" name="__codelineno-4-155"></a>            <span class="n">test_urls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">responsive_urls</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="__span-4-156"><a href="#__codelineno-4-156" id="__codelineno-4-156" name="__codelineno-4-156"></a>
</span><span id="__span-4-157"><a href="#__codelineno-4-157" id="__codelineno-4-157" name="__codelineno-4-157"></a>        <span class="k">return</span> <span class="n">test_urls</span>
</span><span id="__span-4-158"><a href="#__codelineno-4-158" id="__codelineno-4-158" name="__codelineno-4-158"></a>
</span><span id="__span-4-159"><a href="#__codelineno-4-159" id="__codelineno-4-159" name="__codelineno-4-159"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_measure_region_performance</span><span class="p">(</span>
</span><span id="__span-4-160"><a href="#__codelineno-4-160" id="__codelineno-4-160" name="__codelineno-4-160"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-161"><a href="#__codelineno-4-161" id="__codelineno-4-161" name="__codelineno-4-161"></a>        <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-4-162"><a href="#__codelineno-4-162" id="__codelineno-4-162" name="__codelineno-4-162"></a>        <span class="n">test_urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-4-163"><a href="#__codelineno-4-163" id="__codelineno-4-163" name="__codelineno-4-163"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">]:</span>
</span><span id="__span-4-164"><a href="#__codelineno-4-164" id="__codelineno-4-164" name="__codelineno-4-164"></a><span class="w">        </span><span class="sd">"""Measure performance from specific region"""</span>
</span><span id="__span-4-165"><a href="#__codelineno-4-165" id="__codelineno-4-165" name="__codelineno-4-165"></a>
</span><span id="__span-4-166"><a href="#__codelineno-4-166" id="__codelineno-4-166" name="__codelineno-4-166"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-167"><a href="#__codelineno-4-167" id="__codelineno-4-167" name="__codelineno-4-167"></a>
</span><span id="__span-4-168"><a href="#__codelineno-4-168" id="__codelineno-4-168" name="__codelineno-4-168"></a>        <span class="c1"># Response time metrics</span>
</span><span id="__span-4-169"><a href="#__codelineno-4-169" id="__codelineno-4-169" name="__codelineno-4-169"></a>        <span class="n">response_times</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_response_times</span><span class="p">(</span><span class="n">test_urls</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</span><span id="__span-4-170"><a href="#__codelineno-4-170" id="__codelineno-4-170" name="__codelineno-4-170"></a>        <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">response_time</span> <span class="ow">in</span> <span class="n">response_times</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-4-171"><a href="#__codelineno-4-171" id="__codelineno-4-171" name="__codelineno-4-171"></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerformanceMetric</span><span class="p">(</span>
</span><span id="__span-4-172"><a href="#__codelineno-4-172" id="__codelineno-4-172" name="__codelineno-4-172"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"response_time"</span><span class="p">,</span>
</span><span id="__span-4-173"><a href="#__codelineno-4-173" id="__codelineno-4-173" name="__codelineno-4-173"></a>                <span class="n">value</span><span class="o">=</span><span class="n">response_time</span><span class="p">,</span>
</span><span id="__span-4-174"><a href="#__codelineno-4-174" id="__codelineno-4-174" name="__codelineno-4-174"></a>                <span class="n">unit</span><span class="o">=</span><span class="s2">"ms"</span><span class="p">,</span>
</span><span id="__span-4-175"><a href="#__codelineno-4-175" id="__codelineno-4-175" name="__codelineno-4-175"></a>                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-176"><a href="#__codelineno-4-176" id="__codelineno-4-176" name="__codelineno-4-176"></a>                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
</span><span id="__span-4-177"><a href="#__codelineno-4-177" id="__codelineno-4-177" name="__codelineno-4-177"></a>                <span class="n">content_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_classify_content_type</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-4-178"><a href="#__codelineno-4-178" id="__codelineno-4-178" name="__codelineno-4-178"></a>            <span class="p">))</span>
</span><span id="__span-4-179"><a href="#__codelineno-4-179" id="__codelineno-4-179" name="__codelineno-4-179"></a>
</span><span id="__span-4-180"><a href="#__codelineno-4-180" id="__codelineno-4-180" name="__codelineno-4-180"></a>        <span class="c1"># Cache hit ratio</span>
</span><span id="__span-4-181"><a href="#__codelineno-4-181" id="__codelineno-4-181" name="__codelineno-4-181"></a>        <span class="n">cache_metrics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_cache_performance</span><span class="p">(</span><span class="n">test_urls</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</span><span id="__span-4-182"><a href="#__codelineno-4-182" id="__codelineno-4-182" name="__codelineno-4-182"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerformanceMetric</span><span class="p">(</span>
</span><span id="__span-4-183"><a href="#__codelineno-4-183" id="__codelineno-4-183" name="__codelineno-4-183"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"cache_hit_ratio"</span><span class="p">,</span>
</span><span id="__span-4-184"><a href="#__codelineno-4-184" id="__codelineno-4-184" name="__codelineno-4-184"></a>            <span class="n">value</span><span class="o">=</span><span class="n">cache_metrics</span><span class="p">[</span><span class="s2">"hit_ratio"</span><span class="p">],</span>
</span><span id="__span-4-185"><a href="#__codelineno-4-185" id="__codelineno-4-185" name="__codelineno-4-185"></a>            <span class="n">unit</span><span class="o">=</span><span class="s2">"ratio"</span><span class="p">,</span>
</span><span id="__span-4-186"><a href="#__codelineno-4-186" id="__codelineno-4-186" name="__codelineno-4-186"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-187"><a href="#__codelineno-4-187" id="__codelineno-4-187" name="__codelineno-4-187"></a>            <span class="n">region</span><span class="o">=</span><span class="n">region</span>
</span><span id="__span-4-188"><a href="#__codelineno-4-188" id="__codelineno-4-188" name="__codelineno-4-188"></a>        <span class="p">))</span>
</span><span id="__span-4-189"><a href="#__codelineno-4-189" id="__codelineno-4-189" name="__codelineno-4-189"></a>
</span><span id="__span-4-190"><a href="#__codelineno-4-190" id="__codelineno-4-190" name="__codelineno-4-190"></a>        <span class="c1"># Error rate</span>
</span><span id="__span-4-191"><a href="#__codelineno-4-191" id="__codelineno-4-191" name="__codelineno-4-191"></a>        <span class="n">error_rate</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_error_rate</span><span class="p">(</span><span class="n">test_urls</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</span><span id="__span-4-192"><a href="#__codelineno-4-192" id="__codelineno-4-192" name="__codelineno-4-192"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerformanceMetric</span><span class="p">(</span>
</span><span id="__span-4-193"><a href="#__codelineno-4-193" id="__codelineno-4-193" name="__codelineno-4-193"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"error_rate"</span><span class="p">,</span>
</span><span id="__span-4-194"><a href="#__codelineno-4-194" id="__codelineno-4-194" name="__codelineno-4-194"></a>            <span class="n">value</span><span class="o">=</span><span class="n">error_rate</span><span class="p">,</span>
</span><span id="__span-4-195"><a href="#__codelineno-4-195" id="__codelineno-4-195" name="__codelineno-4-195"></a>            <span class="n">unit</span><span class="o">=</span><span class="s2">"ratio"</span><span class="p">,</span>
</span><span id="__span-4-196"><a href="#__codelineno-4-196" id="__codelineno-4-196" name="__codelineno-4-196"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-197"><a href="#__codelineno-4-197" id="__codelineno-4-197" name="__codelineno-4-197"></a>            <span class="n">region</span><span class="o">=</span><span class="n">region</span>
</span><span id="__span-4-198"><a href="#__codelineno-4-198" id="__codelineno-4-198" name="__codelineno-4-198"></a>        <span class="p">))</span>
</span><span id="__span-4-199"><a href="#__codelineno-4-199" id="__codelineno-4-199" name="__codelineno-4-199"></a>
</span><span id="__span-4-200"><a href="#__codelineno-4-200" id="__codelineno-4-200" name="__codelineno-4-200"></a>        <span class="c1"># Bandwidth utilization</span>
</span><span id="__span-4-201"><a href="#__codelineno-4-201" id="__codelineno-4-201" name="__codelineno-4-201"></a>        <span class="n">bandwidth_util</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_bandwidth_utilization</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
</span><span id="__span-4-202"><a href="#__codelineno-4-202" id="__codelineno-4-202" name="__codelineno-4-202"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerformanceMetric</span><span class="p">(</span>
</span><span id="__span-4-203"><a href="#__codelineno-4-203" id="__codelineno-4-203" name="__codelineno-4-203"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">"bandwidth_utilization"</span><span class="p">,</span>
</span><span id="__span-4-204"><a href="#__codelineno-4-204" id="__codelineno-4-204" name="__codelineno-4-204"></a>            <span class="n">value</span><span class="o">=</span><span class="n">bandwidth_util</span><span class="p">,</span>
</span><span id="__span-4-205"><a href="#__codelineno-4-205" id="__codelineno-4-205" name="__codelineno-4-205"></a>            <span class="n">unit</span><span class="o">=</span><span class="s2">"ratio"</span><span class="p">,</span>
</span><span id="__span-4-206"><a href="#__codelineno-4-206" id="__codelineno-4-206" name="__codelineno-4-206"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-207"><a href="#__codelineno-4-207" id="__codelineno-4-207" name="__codelineno-4-207"></a>            <span class="n">region</span><span class="o">=</span><span class="n">region</span>
</span><span id="__span-4-208"><a href="#__codelineno-4-208" id="__codelineno-4-208" name="__codelineno-4-208"></a>        <span class="p">))</span>
</span><span id="__span-4-209"><a href="#__codelineno-4-209" id="__codelineno-4-209" name="__codelineno-4-209"></a>
</span><span id="__span-4-210"><a href="#__codelineno-4-210" id="__codelineno-4-210" name="__codelineno-4-210"></a>        <span class="c1"># Time to First Byte (TTFB)</span>
</span><span id="__span-4-211"><a href="#__codelineno-4-211" id="__codelineno-4-211" name="__codelineno-4-211"></a>        <span class="n">ttfb_metrics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_ttfb</span><span class="p">(</span><span class="n">test_urls</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</span><span id="__span-4-212"><a href="#__codelineno-4-212" id="__codelineno-4-212" name="__codelineno-4-212"></a>        <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">ttfb</span> <span class="ow">in</span> <span class="n">ttfb_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-4-213"><a href="#__codelineno-4-213" id="__codelineno-4-213" name="__codelineno-4-213"></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerformanceMetric</span><span class="p">(</span>
</span><span id="__span-4-214"><a href="#__codelineno-4-214" id="__codelineno-4-214" name="__codelineno-4-214"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"time_to_first_byte"</span><span class="p">,</span>
</span><span id="__span-4-215"><a href="#__codelineno-4-215" id="__codelineno-4-215" name="__codelineno-4-215"></a>                <span class="n">value</span><span class="o">=</span><span class="n">ttfb</span><span class="p">,</span>
</span><span id="__span-4-216"><a href="#__codelineno-4-216" id="__codelineno-4-216" name="__codelineno-4-216"></a>                <span class="n">unit</span><span class="o">=</span><span class="s2">"ms"</span><span class="p">,</span>
</span><span id="__span-4-217"><a href="#__codelineno-4-217" id="__codelineno-4-217" name="__codelineno-4-217"></a>                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-218"><a href="#__codelineno-4-218" id="__codelineno-4-218" name="__codelineno-4-218"></a>                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
</span><span id="__span-4-219"><a href="#__codelineno-4-219" id="__codelineno-4-219" name="__codelineno-4-219"></a>                <span class="n">content_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_classify_content_type</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-4-220"><a href="#__codelineno-4-220" id="__codelineno-4-220" name="__codelineno-4-220"></a>            <span class="p">))</span>
</span><span id="__span-4-221"><a href="#__codelineno-4-221" id="__codelineno-4-221" name="__codelineno-4-221"></a>
</span><span id="__span-4-222"><a href="#__codelineno-4-222" id="__codelineno-4-222" name="__codelineno-4-222"></a>        <span class="k">return</span> <span class="n">metrics</span>
</span><span id="__span-4-223"><a href="#__codelineno-4-223" id="__codelineno-4-223" name="__codelineno-4-223"></a>
</span><span id="__span-4-224"><a href="#__codelineno-4-224" id="__codelineno-4-224" name="__codelineno-4-224"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_measure_response_times</span><span class="p">(</span>
</span><span id="__span-4-225"><a href="#__codelineno-4-225" id="__codelineno-4-225" name="__codelineno-4-225"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-226"><a href="#__codelineno-4-226" id="__codelineno-4-226" name="__codelineno-4-226"></a>        <span class="n">test_urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-4-227"><a href="#__codelineno-4-227" id="__codelineno-4-227" name="__codelineno-4-227"></a>        <span class="n">region</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-228"><a href="#__codelineno-4-228" id="__codelineno-4-228" name="__codelineno-4-228"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-4-229"><a href="#__codelineno-4-229" id="__codelineno-4-229" name="__codelineno-4-229"></a><span class="w">        </span><span class="sd">"""Measure response times for URLs from specific region"""</span>
</span><span id="__span-4-230"><a href="#__codelineno-4-230" id="__codelineno-4-230" name="__codelineno-4-230"></a>
</span><span id="__span-4-231"><a href="#__codelineno-4-231" id="__codelineno-4-231" name="__codelineno-4-231"></a>        <span class="n">response_times</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-232"><a href="#__codelineno-4-232" id="__codelineno-4-232" name="__codelineno-4-232"></a>
</span><span id="__span-4-233"><a href="#__codelineno-4-233" id="__codelineno-4-233" name="__codelineno-4-233"></a>        <span class="c1"># Use region-specific monitoring endpoint for accurate measurement</span>
</span><span id="__span-4-234"><a href="#__codelineno-4-234" id="__codelineno-4-234" name="__codelineno-4-234"></a>        <span class="n">monitoring_endpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_endpoints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-4-235"><a href="#__codelineno-4-235" id="__codelineno-4-235" name="__codelineno-4-235"></a>
</span><span id="__span-4-236"><a href="#__codelineno-4-236" id="__codelineno-4-236" name="__codelineno-4-236"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">monitoring_endpoints</span><span class="p">:</span>
</span><span id="__span-4-237"><a href="#__codelineno-4-237" id="__codelineno-4-237" name="__codelineno-4-237"></a>            <span class="c1"># Fallback to direct measurement</span>
</span><span id="__span-4-238"><a href="#__codelineno-4-238" id="__codelineno-4-238" name="__codelineno-4-238"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_response_time_measurement</span><span class="p">(</span><span class="n">test_urls</span><span class="p">)</span>
</span><span id="__span-4-239"><a href="#__codelineno-4-239" id="__codelineno-4-239" name="__codelineno-4-239"></a>
</span><span id="__span-4-240"><a href="#__codelineno-4-240" id="__codelineno-4-240" name="__codelineno-4-240"></a>        <span class="c1"># Use monitoring infrastructure</span>
</span><span id="__span-4-241"><a href="#__codelineno-4-241" id="__codelineno-4-241" name="__codelineno-4-241"></a>        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">test_urls</span><span class="p">:</span>
</span><span id="__span-4-242"><a href="#__codelineno-4-242" id="__codelineno-4-242" name="__codelineno-4-242"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-243"><a href="#__codelineno-4-243" id="__codelineno-4-243" name="__codelineno-4-243"></a>                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-4-244"><a href="#__codelineno-4-244" id="__codelineno-4-244" name="__codelineno-4-244"></a>
</span><span id="__span-4-245"><a href="#__codelineno-4-245" id="__codelineno-4-245" name="__codelineno-4-245"></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-4-246"><a href="#__codelineno-4-246" id="__codelineno-4-246" name="__codelineno-4-246"></a>                    <span class="c1"># Add region-specific headers</span>
</span><span id="__span-4-247"><a href="#__codelineno-4-247" id="__codelineno-4-247" name="__codelineno-4-247"></a>                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-248"><a href="#__codelineno-4-248" id="__codelineno-4-248" name="__codelineno-4-248"></a>                        <span class="s2">"User-Agent"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"ToolBoxAI-Monitor/</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-4-249"><a href="#__codelineno-4-249" id="__codelineno-4-249" name="__codelineno-4-249"></a>                        <span class="s2">"X-Monitoring-Region"</span><span class="p">:</span> <span class="n">region</span>
</span><span id="__span-4-250"><a href="#__codelineno-4-250" id="__codelineno-4-250" name="__codelineno-4-250"></a>                    <span class="p">}</span>
</span><span id="__span-4-251"><a href="#__codelineno-4-251" id="__codelineno-4-251" name="__codelineno-4-251"></a>
</span><span id="__span-4-252"><a href="#__codelineno-4-252" id="__codelineno-4-252" name="__codelineno-4-252"></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-4-253"><a href="#__codelineno-4-253" id="__codelineno-4-253" name="__codelineno-4-253"></a>                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-4-254"><a href="#__codelineno-4-254" id="__codelineno-4-254" name="__codelineno-4-254"></a>                            <span class="c1"># Ensure content is fully loaded</span>
</span><span id="__span-4-255"><a href="#__codelineno-4-255" id="__codelineno-4-255" name="__codelineno-4-255"></a>                            <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-4-256"><a href="#__codelineno-4-256" id="__codelineno-4-256" name="__codelineno-4-256"></a>
</span><span id="__span-4-257"><a href="#__codelineno-4-257" id="__codelineno-4-257" name="__codelineno-4-257"></a>                        <span class="n">response_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to ms</span>
</span><span id="__span-4-258"><a href="#__codelineno-4-258" id="__codelineno-4-258" name="__codelineno-4-258"></a>                        <span class="n">response_times</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_time</span>
</span><span id="__span-4-259"><a href="#__codelineno-4-259" id="__codelineno-4-259" name="__codelineno-4-259"></a>
</span><span id="__span-4-260"><a href="#__codelineno-4-260" id="__codelineno-4-260" name="__codelineno-4-260"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-261"><a href="#__codelineno-4-261" id="__codelineno-4-261" name="__codelineno-4-261"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to measure response time for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-262"><a href="#__codelineno-4-262" id="__codelineno-4-262" name="__codelineno-4-262"></a>                <span class="n">response_times</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999</span>  <span class="c1"># High value to indicate failure</span>
</span><span id="__span-4-263"><a href="#__codelineno-4-263" id="__codelineno-4-263" name="__codelineno-4-263"></a>
</span><span id="__span-4-264"><a href="#__codelineno-4-264" id="__codelineno-4-264" name="__codelineno-4-264"></a>        <span class="k">return</span> <span class="n">response_times</span>
</span><span id="__span-4-265"><a href="#__codelineno-4-265" id="__codelineno-4-265" name="__codelineno-4-265"></a>
</span><span id="__span-4-266"><a href="#__codelineno-4-266" id="__codelineno-4-266" name="__codelineno-4-266"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_measure_cache_performance</span><span class="p">(</span>
</span><span id="__span-4-267"><a href="#__codelineno-4-267" id="__codelineno-4-267" name="__codelineno-4-267"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-268"><a href="#__codelineno-4-268" id="__codelineno-4-268" name="__codelineno-4-268"></a>        <span class="n">test_urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-4-269"><a href="#__codelineno-4-269" id="__codelineno-4-269" name="__codelineno-4-269"></a>        <span class="n">region</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-270"><a href="#__codelineno-4-270" id="__codelineno-4-270" name="__codelineno-4-270"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-4-271"><a href="#__codelineno-4-271" id="__codelineno-4-271" name="__codelineno-4-271"></a><span class="w">        </span><span class="sd">"""Measure cache performance metrics"""</span>
</span><span id="__span-4-272"><a href="#__codelineno-4-272" id="__codelineno-4-272" name="__codelineno-4-272"></a>
</span><span id="__span-4-273"><a href="#__codelineno-4-273" id="__codelineno-4-273" name="__codelineno-4-273"></a>        <span class="n">cache_hits</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-274"><a href="#__codelineno-4-274" id="__codelineno-4-274" name="__codelineno-4-274"></a>        <span class="n">total_requests</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-275"><a href="#__codelineno-4-275" id="__codelineno-4-275" name="__codelineno-4-275"></a>
</span><span id="__span-4-276"><a href="#__codelineno-4-276" id="__codelineno-4-276" name="__codelineno-4-276"></a>        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">test_urls</span><span class="p">:</span>
</span><span id="__span-4-277"><a href="#__codelineno-4-277" id="__codelineno-4-277" name="__codelineno-4-277"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-278"><a href="#__codelineno-4-278" id="__codelineno-4-278" name="__codelineno-4-278"></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-4-279"><a href="#__codelineno-4-279" id="__codelineno-4-279" name="__codelineno-4-279"></a>                    <span class="c1"># First request (should be cache miss or hit)</span>
</span><span id="__span-4-280"><a href="#__codelineno-4-280" id="__codelineno-4-280" name="__codelineno-4-280"></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-4-281"><a href="#__codelineno-4-281" id="__codelineno-4-281" name="__codelineno-4-281"></a>                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-4-282"><a href="#__codelineno-4-282" id="__codelineno-4-282" name="__codelineno-4-282"></a>                            <span class="n">total_requests</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-283"><a href="#__codelineno-4-283" id="__codelineno-4-283" name="__codelineno-4-283"></a>
</span><span id="__span-4-284"><a href="#__codelineno-4-284" id="__codelineno-4-284" name="__codelineno-4-284"></a>                            <span class="c1"># Check cache headers</span>
</span><span id="__span-4-285"><a href="#__codelineno-4-285" id="__codelineno-4-285" name="__codelineno-4-285"></a>                            <span class="n">cache_status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"CF-Cache-Status"</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="__span-4-286"><a href="#__codelineno-4-286" id="__codelineno-4-286" name="__codelineno-4-286"></a>                                         <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"X-Cache"</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="__span-4-287"><a href="#__codelineno-4-287" id="__codelineno-4-287" name="__codelineno-4-287"></a>                                         <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Cache-Status"</span><span class="p">)</span>
</span><span id="__span-4-288"><a href="#__codelineno-4-288" id="__codelineno-4-288" name="__codelineno-4-288"></a>
</span><span id="__span-4-289"><a href="#__codelineno-4-289" id="__codelineno-4-289" name="__codelineno-4-289"></a>                            <span class="k">if</span> <span class="n">cache_status</span> <span class="ow">and</span> <span class="s2">"hit"</span> <span class="ow">in</span> <span class="n">cache_status</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-4-290"><a href="#__codelineno-4-290" id="__codelineno-4-290" name="__codelineno-4-290"></a>                                <span class="n">cache_hits</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-291"><a href="#__codelineno-4-291" id="__codelineno-4-291" name="__codelineno-4-291"></a>
</span><span id="__span-4-292"><a href="#__codelineno-4-292" id="__codelineno-4-292" name="__codelineno-4-292"></a>                    <span class="c1"># Second request (should be cache hit)</span>
</span><span id="__span-4-293"><a href="#__codelineno-4-293" id="__codelineno-4-293" name="__codelineno-4-293"></a>                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Small delay</span>
</span><span id="__span-4-294"><a href="#__codelineno-4-294" id="__codelineno-4-294" name="__codelineno-4-294"></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-4-295"><a href="#__codelineno-4-295" id="__codelineno-4-295" name="__codelineno-4-295"></a>                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-4-296"><a href="#__codelineno-4-296" id="__codelineno-4-296" name="__codelineno-4-296"></a>                            <span class="n">total_requests</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-297"><a href="#__codelineno-4-297" id="__codelineno-4-297" name="__codelineno-4-297"></a>
</span><span id="__span-4-298"><a href="#__codelineno-4-298" id="__codelineno-4-298" name="__codelineno-4-298"></a>                            <span class="n">cache_status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"CF-Cache-Status"</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="__span-4-299"><a href="#__codelineno-4-299" id="__codelineno-4-299" name="__codelineno-4-299"></a>                                         <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"X-Cache"</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="__span-4-300"><a href="#__codelineno-4-300" id="__codelineno-4-300" name="__codelineno-4-300"></a>                                         <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Cache-Status"</span><span class="p">)</span>
</span><span id="__span-4-301"><a href="#__codelineno-4-301" id="__codelineno-4-301" name="__codelineno-4-301"></a>
</span><span id="__span-4-302"><a href="#__codelineno-4-302" id="__codelineno-4-302" name="__codelineno-4-302"></a>                            <span class="k">if</span> <span class="n">cache_status</span> <span class="ow">and</span> <span class="s2">"hit"</span> <span class="ow">in</span> <span class="n">cache_status</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-4-303"><a href="#__codelineno-4-303" id="__codelineno-4-303" name="__codelineno-4-303"></a>                                <span class="n">cache_hits</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-304"><a href="#__codelineno-4-304" id="__codelineno-4-304" name="__codelineno-4-304"></a>
</span><span id="__span-4-305"><a href="#__codelineno-4-305" id="__codelineno-4-305" name="__codelineno-4-305"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-306"><a href="#__codelineno-4-306" id="__codelineno-4-306" name="__codelineno-4-306"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to measure cache performance for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-307"><a href="#__codelineno-4-307" id="__codelineno-4-307" name="__codelineno-4-307"></a>
</span><span id="__span-4-308"><a href="#__codelineno-4-308" id="__codelineno-4-308" name="__codelineno-4-308"></a>        <span class="n">hit_ratio</span> <span class="o">=</span> <span class="n">cache_hits</span> <span class="o">/</span> <span class="n">total_requests</span> <span class="k">if</span> <span class="n">total_requests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-4-309"><a href="#__codelineno-4-309" id="__codelineno-4-309" name="__codelineno-4-309"></a>
</span><span id="__span-4-310"><a href="#__codelineno-4-310" id="__codelineno-4-310" name="__codelineno-4-310"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-311"><a href="#__codelineno-4-311" id="__codelineno-4-311" name="__codelineno-4-311"></a>            <span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="n">hit_ratio</span><span class="p">,</span>
</span><span id="__span-4-312"><a href="#__codelineno-4-312" id="__codelineno-4-312" name="__codelineno-4-312"></a>            <span class="s2">"cache_hits"</span><span class="p">:</span> <span class="n">cache_hits</span><span class="p">,</span>
</span><span id="__span-4-313"><a href="#__codelineno-4-313" id="__codelineno-4-313" name="__codelineno-4-313"></a>            <span class="s2">"total_requests"</span><span class="p">:</span> <span class="n">total_requests</span>
</span><span id="__span-4-314"><a href="#__codelineno-4-314" id="__codelineno-4-314" name="__codelineno-4-314"></a>        <span class="p">}</span>
</span><span id="__span-4-315"><a href="#__codelineno-4-315" id="__codelineno-4-315" name="__codelineno-4-315"></a>
</span><span id="__span-4-316"><a href="#__codelineno-4-316" id="__codelineno-4-316" name="__codelineno-4-316"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_measure_ttfb</span><span class="p">(</span>
</span><span id="__span-4-317"><a href="#__codelineno-4-317" id="__codelineno-4-317" name="__codelineno-4-317"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-318"><a href="#__codelineno-4-318" id="__codelineno-4-318" name="__codelineno-4-318"></a>        <span class="n">test_urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-4-319"><a href="#__codelineno-4-319" id="__codelineno-4-319" name="__codelineno-4-319"></a>        <span class="n">region</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-320"><a href="#__codelineno-4-320" id="__codelineno-4-320" name="__codelineno-4-320"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="__span-4-321"><a href="#__codelineno-4-321" id="__codelineno-4-321" name="__codelineno-4-321"></a><span class="w">        </span><span class="sd">"""Measure Time to First Byte"""</span>
</span><span id="__span-4-322"><a href="#__codelineno-4-322" id="__codelineno-4-322" name="__codelineno-4-322"></a>
</span><span id="__span-4-323"><a href="#__codelineno-4-323" id="__codelineno-4-323" name="__codelineno-4-323"></a>        <span class="n">ttfb_measurements</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-324"><a href="#__codelineno-4-324" id="__codelineno-4-324" name="__codelineno-4-324"></a>
</span><span id="__span-4-325"><a href="#__codelineno-4-325" id="__codelineno-4-325" name="__codelineno-4-325"></a>        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">test_urls</span><span class="p">:</span>
</span><span id="__span-4-326"><a href="#__codelineno-4-326" id="__codelineno-4-326" name="__codelineno-4-326"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-327"><a href="#__codelineno-4-327" id="__codelineno-4-327" name="__codelineno-4-327"></a>                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-4-328"><a href="#__codelineno-4-328" id="__codelineno-4-328" name="__codelineno-4-328"></a>
</span><span id="__span-4-329"><a href="#__codelineno-4-329" id="__codelineno-4-329" name="__codelineno-4-329"></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-4-330"><a href="#__codelineno-4-330" id="__codelineno-4-330" name="__codelineno-4-330"></a>                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="__span-4-331"><a href="#__codelineno-4-331" id="__codelineno-4-331" name="__codelineno-4-331"></a>                        <span class="c1"># Time to first byte is when we get response headers</span>
</span><span id="__span-4-332"><a href="#__codelineno-4-332" id="__codelineno-4-332" name="__codelineno-4-332"></a>                        <span class="n">ttfb</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="__span-4-333"><a href="#__codelineno-4-333" id="__codelineno-4-333" name="__codelineno-4-333"></a>                        <span class="n">ttfb_measurements</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttfb</span>
</span><span id="__span-4-334"><a href="#__codelineno-4-334" id="__codelineno-4-334" name="__codelineno-4-334"></a>
</span><span id="__span-4-335"><a href="#__codelineno-4-335" id="__codelineno-4-335" name="__codelineno-4-335"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-336"><a href="#__codelineno-4-336" id="__codelineno-4-336" name="__codelineno-4-336"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to measure TTFB for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-337"><a href="#__codelineno-4-337" id="__codelineno-4-337" name="__codelineno-4-337"></a>                <span class="n">ttfb_measurements</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999</span>
</span><span id="__span-4-338"><a href="#__codelineno-4-338" id="__codelineno-4-338" name="__codelineno-4-338"></a>
</span><span id="__span-4-339"><a href="#__codelineno-4-339" id="__codelineno-4-339" name="__codelineno-4-339"></a>        <span class="k">return</span> <span class="n">ttfb_measurements</span>
</span><span id="__span-4-340"><a href="#__codelineno-4-340" id="__codelineno-4-340" name="__codelineno-4-340"></a>
</span><span id="__span-4-341"><a href="#__codelineno-4-341" id="__codelineno-4-341" name="__codelineno-4-341"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_performance_summary</span><span class="p">(</span>
</span><span id="__span-4-342"><a href="#__codelineno-4-342" id="__codelineno-4-342" name="__codelineno-4-342"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-343"><a href="#__codelineno-4-343" id="__codelineno-4-343" name="__codelineno-4-343"></a>        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">]</span>
</span><span id="__span-4-344"><a href="#__codelineno-4-344" id="__codelineno-4-344" name="__codelineno-4-344"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-345"><a href="#__codelineno-4-345" id="__codelineno-4-345" name="__codelineno-4-345"></a><span class="w">        </span><span class="sd">"""Generate performance summary from metrics"""</span>
</span><span id="__span-4-346"><a href="#__codelineno-4-346" id="__codelineno-4-346" name="__codelineno-4-346"></a>
</span><span id="__span-4-347"><a href="#__codelineno-4-347" id="__codelineno-4-347" name="__codelineno-4-347"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-348"><a href="#__codelineno-4-348" id="__codelineno-4-348" name="__codelineno-4-348"></a>            <span class="s2">"overall_score"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-4-349"><a href="#__codelineno-4-349" id="__codelineno-4-349" name="__codelineno-4-349"></a>            <span class="s2">"response_time"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-350"><a href="#__codelineno-4-350" id="__codelineno-4-350" name="__codelineno-4-350"></a>                <span class="s2">"average"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-4-351"><a href="#__codelineno-4-351" id="__codelineno-4-351" name="__codelineno-4-351"></a>                <span class="s2">"p95"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-4-352"><a href="#__codelineno-4-352" id="__codelineno-4-352" name="__codelineno-4-352"></a>                <span class="s2">"p99"</span><span class="p">:</span> <span class="mf">0.0</span>
</span><span id="__span-4-353"><a href="#__codelineno-4-353" id="__codelineno-4-353" name="__codelineno-4-353"></a>            <span class="p">},</span>
</span><span id="__span-4-354"><a href="#__codelineno-4-354" id="__codelineno-4-354" name="__codelineno-4-354"></a>            <span class="s2">"cache_performance"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-355"><a href="#__codelineno-4-355" id="__codelineno-4-355" name="__codelineno-4-355"></a>                <span class="s2">"average_hit_ratio"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-4-356"><a href="#__codelineno-4-356" id="__codelineno-4-356" name="__codelineno-4-356"></a>                <span class="s2">"best_region"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-357"><a href="#__codelineno-4-357" id="__codelineno-4-357" name="__codelineno-4-357"></a>                <span class="s2">"worst_region"</span><span class="p">:</span> <span class="kc">None</span>
</span><span id="__span-4-358"><a href="#__codelineno-4-358" id="__codelineno-4-358" name="__codelineno-4-358"></a>            <span class="p">},</span>
</span><span id="__span-4-359"><a href="#__codelineno-4-359" id="__codelineno-4-359" name="__codelineno-4-359"></a>            <span class="s2">"regional_performance"</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-4-360"><a href="#__codelineno-4-360" id="__codelineno-4-360" name="__codelineno-4-360"></a>            <span class="s2">"content_type_performance"</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="__span-4-361"><a href="#__codelineno-4-361" id="__codelineno-4-361" name="__codelineno-4-361"></a>        <span class="p">}</span>
</span><span id="__span-4-362"><a href="#__codelineno-4-362" id="__codelineno-4-362" name="__codelineno-4-362"></a>
</span><span id="__span-4-363"><a href="#__codelineno-4-363" id="__codelineno-4-363" name="__codelineno-4-363"></a>        <span class="c1"># Group metrics by type and region</span>
</span><span id="__span-4-364"><a href="#__codelineno-4-364" id="__codelineno-4-364" name="__codelineno-4-364"></a>        <span class="n">response_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"response_time"</span><span class="p">]</span>
</span><span id="__span-4-365"><a href="#__codelineno-4-365" id="__codelineno-4-365" name="__codelineno-4-365"></a>        <span class="n">cache_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"cache_hit_ratio"</span><span class="p">]</span>
</span><span id="__span-4-366"><a href="#__codelineno-4-366" id="__codelineno-4-366" name="__codelineno-4-366"></a>
</span><span id="__span-4-367"><a href="#__codelineno-4-367" id="__codelineno-4-367" name="__codelineno-4-367"></a>        <span class="c1"># Calculate response time statistics</span>
</span><span id="__span-4-368"><a href="#__codelineno-4-368" id="__codelineno-4-368" name="__codelineno-4-368"></a>        <span class="k">if</span> <span class="n">response_times</span><span class="p">:</span>
</span><span id="__span-4-369"><a href="#__codelineno-4-369" id="__codelineno-4-369" name="__codelineno-4-369"></a>            <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">response_times</span><span class="p">]</span>
</span><span id="__span-4-370"><a href="#__codelineno-4-370" id="__codelineno-4-370" name="__codelineno-4-370"></a>            <span class="n">summary</span><span class="p">[</span><span class="s2">"response_time"</span><span class="p">][</span><span class="s2">"average"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
</span><span id="__span-4-371"><a href="#__codelineno-4-371" id="__codelineno-4-371" name="__codelineno-4-371"></a>            <span class="n">summary</span><span class="p">[</span><span class="s2">"response_time"</span><span class="p">][</span><span class="s2">"p95"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_percentile</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
</span><span id="__span-4-372"><a href="#__codelineno-4-372" id="__codelineno-4-372" name="__codelineno-4-372"></a>            <span class="n">summary</span><span class="p">[</span><span class="s2">"response_time"</span><span class="p">][</span><span class="s2">"p99"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_percentile</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
</span><span id="__span-4-373"><a href="#__codelineno-4-373" id="__codelineno-4-373" name="__codelineno-4-373"></a>
</span><span id="__span-4-374"><a href="#__codelineno-4-374" id="__codelineno-4-374" name="__codelineno-4-374"></a>        <span class="c1"># Calculate cache performance</span>
</span><span id="__span-4-375"><a href="#__codelineno-4-375" id="__codelineno-4-375" name="__codelineno-4-375"></a>        <span class="k">if</span> <span class="n">cache_ratios</span><span class="p">:</span>
</span><span id="__span-4-376"><a href="#__codelineno-4-376" id="__codelineno-4-376" name="__codelineno-4-376"></a>            <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cache_ratios</span><span class="p">]</span>
</span><span id="__span-4-377"><a href="#__codelineno-4-377" id="__codelineno-4-377" name="__codelineno-4-377"></a>            <span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">][</span><span class="s2">"average_hit_ratio"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
</span><span id="__span-4-378"><a href="#__codelineno-4-378" id="__codelineno-4-378" name="__codelineno-4-378"></a>
</span><span id="__span-4-379"><a href="#__codelineno-4-379" id="__codelineno-4-379" name="__codelineno-4-379"></a>            <span class="c1"># Find best and worst performing regions</span>
</span><span id="__span-4-380"><a href="#__codelineno-4-380" id="__codelineno-4-380" name="__codelineno-4-380"></a>            <span class="n">region_cache_performance</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-381"><a href="#__codelineno-4-381" id="__codelineno-4-381" name="__codelineno-4-381"></a>            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">cache_ratios</span><span class="p">:</span>
</span><span id="__span-4-382"><a href="#__codelineno-4-382" id="__codelineno-4-382" name="__codelineno-4-382"></a>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
</span><span id="__span-4-383"><a href="#__codelineno-4-383" id="__codelineno-4-383" name="__codelineno-4-383"></a>                    <span class="n">region_cache_performance</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span>
</span><span id="__span-4-384"><a href="#__codelineno-4-384" id="__codelineno-4-384" name="__codelineno-4-384"></a>
</span><span id="__span-4-385"><a href="#__codelineno-4-385" id="__codelineno-4-385" name="__codelineno-4-385"></a>            <span class="k">if</span> <span class="n">region_cache_performance</span><span class="p">:</span>
</span><span id="__span-4-386"><a href="#__codelineno-4-386" id="__codelineno-4-386" name="__codelineno-4-386"></a>                <span class="n">best_region</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">region_cache_performance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-4-387"><a href="#__codelineno-4-387" id="__codelineno-4-387" name="__codelineno-4-387"></a>                <span class="n">worst_region</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">region_cache_performance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-4-388"><a href="#__codelineno-4-388" id="__codelineno-4-388" name="__codelineno-4-388"></a>
</span><span id="__span-4-389"><a href="#__codelineno-4-389" id="__codelineno-4-389" name="__codelineno-4-389"></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">][</span><span class="s2">"best_region"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-390"><a href="#__codelineno-4-390" id="__codelineno-4-390" name="__codelineno-4-390"></a>                    <span class="s2">"region"</span><span class="p">:</span> <span class="n">best_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-4-391"><a href="#__codelineno-4-391" id="__codelineno-4-391" name="__codelineno-4-391"></a>                    <span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="n">best_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-4-392"><a href="#__codelineno-4-392" id="__codelineno-4-392" name="__codelineno-4-392"></a>                <span class="p">}</span>
</span><span id="__span-4-393"><a href="#__codelineno-4-393" id="__codelineno-4-393" name="__codelineno-4-393"></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">][</span><span class="s2">"worst_region"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-394"><a href="#__codelineno-4-394" id="__codelineno-4-394" name="__codelineno-4-394"></a>                    <span class="s2">"region"</span><span class="p">:</span> <span class="n">worst_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="__span-4-395"><a href="#__codelineno-4-395" id="__codelineno-4-395" name="__codelineno-4-395"></a>                    <span class="s2">"hit_ratio"</span><span class="p">:</span> <span class="n">worst_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-4-396"><a href="#__codelineno-4-396" id="__codelineno-4-396" name="__codelineno-4-396"></a>                <span class="p">}</span>
</span><span id="__span-4-397"><a href="#__codelineno-4-397" id="__codelineno-4-397" name="__codelineno-4-397"></a>
</span><span id="__span-4-398"><a href="#__codelineno-4-398" id="__codelineno-4-398" name="__codelineno-4-398"></a>        <span class="c1"># Calculate overall performance score</span>
</span><span id="__span-4-399"><a href="#__codelineno-4-399" id="__codelineno-4-399" name="__codelineno-4-399"></a>        <span class="n">summary</span><span class="p">[</span><span class="s2">"overall_score"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overall_score</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</span><span id="__span-4-400"><a href="#__codelineno-4-400" id="__codelineno-4-400" name="__codelineno-4-400"></a>
</span><span id="__span-4-401"><a href="#__codelineno-4-401" id="__codelineno-4-401" name="__codelineno-4-401"></a>        <span class="k">return</span> <span class="n">summary</span>
</span><span id="__span-4-402"><a href="#__codelineno-4-402" id="__codelineno-4-402" name="__codelineno-4-402"></a>
</span><span id="__span-4-403"><a href="#__codelineno-4-403" id="__codelineno-4-403" name="__codelineno-4-403"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">percentile</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="__span-4-404"><a href="#__codelineno-4-404" id="__codelineno-4-404" name="__codelineno-4-404"></a><span class="w">        </span><span class="sd">"""Calculate percentile of values"""</span>
</span><span id="__span-4-405"><a href="#__codelineno-4-405" id="__codelineno-4-405" name="__codelineno-4-405"></a>
</span><span id="__span-4-406"><a href="#__codelineno-4-406" id="__codelineno-4-406" name="__codelineno-4-406"></a>        <span class="n">sorted_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-4-407"><a href="#__codelineno-4-407" id="__codelineno-4-407" name="__codelineno-4-407"></a>        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">percentile</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">))</span>
</span><span id="__span-4-408"><a href="#__codelineno-4-408" id="__codelineno-4-408" name="__codelineno-4-408"></a>
</span><span id="__span-4-409"><a href="#__codelineno-4-409" id="__codelineno-4-409" name="__codelineno-4-409"></a>        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">):</span>
</span><span id="__span-4-410"><a href="#__codelineno-4-410" id="__codelineno-4-410" name="__codelineno-4-410"></a>            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="__span-4-411"><a href="#__codelineno-4-411" id="__codelineno-4-411" name="__codelineno-4-411"></a>
</span><span id="__span-4-412"><a href="#__codelineno-4-412" id="__codelineno-4-412" name="__codelineno-4-412"></a>        <span class="k">return</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="__span-4-413"><a href="#__codelineno-4-413" id="__codelineno-4-413" name="__codelineno-4-413"></a>
</span><span id="__span-4-414"><a href="#__codelineno-4-414" id="__codelineno-4-414" name="__codelineno-4-414"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_overall_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="__span-4-415"><a href="#__codelineno-4-415" id="__codelineno-4-415" name="__codelineno-4-415"></a><span class="w">        </span><span class="sd">"""Calculate overall performance score (0-100)"""</span>
</span><span id="__span-4-416"><a href="#__codelineno-4-416" id="__codelineno-4-416" name="__codelineno-4-416"></a>
</span><span id="__span-4-417"><a href="#__codelineno-4-417" id="__codelineno-4-417" name="__codelineno-4-417"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-418"><a href="#__codelineno-4-418" id="__codelineno-4-418" name="__codelineno-4-418"></a>        <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_thresholds</span>
</span><span id="__span-4-419"><a href="#__codelineno-4-419" id="__codelineno-4-419" name="__codelineno-4-419"></a>
</span><span id="__span-4-420"><a href="#__codelineno-4-420" id="__codelineno-4-420" name="__codelineno-4-420"></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span><span id="__span-4-421"><a href="#__codelineno-4-421" id="__codelineno-4-421" name="__codelineno-4-421"></a>            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
</span><span id="__span-4-422"><a href="#__codelineno-4-422" id="__codelineno-4-422" name="__codelineno-4-422"></a>                <span class="n">metric_thresholds</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="__span-4-423"><a href="#__codelineno-4-423" id="__codelineno-4-423" name="__codelineno-4-423"></a>
</span><span id="__span-4-424"><a href="#__codelineno-4-424" id="__codelineno-4-424" name="__codelineno-4-424"></a>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">metric_thresholds</span><span class="p">[</span><span class="s2">"excellent"</span><span class="p">]:</span>
</span><span id="__span-4-425"><a href="#__codelineno-4-425" id="__codelineno-4-425" name="__codelineno-4-425"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-4-426"><a href="#__codelineno-4-426" id="__codelineno-4-426" name="__codelineno-4-426"></a>                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">metric_thresholds</span><span class="p">[</span><span class="s2">"good"</span><span class="p">]:</span>
</span><span id="__span-4-427"><a href="#__codelineno-4-427" id="__codelineno-4-427" name="__codelineno-4-427"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="mi">85</span>
</span><span id="__span-4-428"><a href="#__codelineno-4-428" id="__codelineno-4-428" name="__codelineno-4-428"></a>                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">metric_thresholds</span><span class="p">[</span><span class="s2">"warning"</span><span class="p">]:</span>
</span><span id="__span-4-429"><a href="#__codelineno-4-429" id="__codelineno-4-429" name="__codelineno-4-429"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="mi">70</span>
</span><span id="__span-4-430"><a href="#__codelineno-4-430" id="__codelineno-4-430" name="__codelineno-4-430"></a>                <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">metric_thresholds</span><span class="p">[</span><span class="s2">"critical"</span><span class="p">]:</span>
</span><span id="__span-4-431"><a href="#__codelineno-4-431" id="__codelineno-4-431" name="__codelineno-4-431"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="__span-4-432"><a href="#__codelineno-4-432" id="__codelineno-4-432" name="__codelineno-4-432"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-433"><a href="#__codelineno-4-433" id="__codelineno-4-433" name="__codelineno-4-433"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="mi">25</span>
</span><span id="__span-4-434"><a href="#__codelineno-4-434" id="__codelineno-4-434" name="__codelineno-4-434"></a>
</span><span id="__span-4-435"><a href="#__codelineno-4-435" id="__codelineno-4-435" name="__codelineno-4-435"></a>                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="__span-4-436"><a href="#__codelineno-4-436" id="__codelineno-4-436" name="__codelineno-4-436"></a>
</span><span id="__span-4-437"><a href="#__codelineno-4-437" id="__codelineno-4-437" name="__codelineno-4-437"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">scores</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-4-438"><a href="#__codelineno-4-438" id="__codelineno-4-438" name="__codelineno-4-438"></a>
</span><span id="__span-4-439"><a href="#__codelineno-4-439" id="__codelineno-4-439" name="__codelineno-4-439"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_recommendations</span><span class="p">(</span>
</span><span id="__span-4-440"><a href="#__codelineno-4-440" id="__codelineno-4-440" name="__codelineno-4-440"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-4-441"><a href="#__codelineno-4-441" id="__codelineno-4-441" name="__codelineno-4-441"></a>        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">],</span>
</span><span id="__span-4-442"><a href="#__codelineno-4-442" id="__codelineno-4-442" name="__codelineno-4-442"></a>        <span class="n">summary</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-4-443"><a href="#__codelineno-4-443" id="__codelineno-4-443" name="__codelineno-4-443"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-4-444"><a href="#__codelineno-4-444" id="__codelineno-4-444" name="__codelineno-4-444"></a><span class="w">        </span><span class="sd">"""Generate performance improvement recommendations"""</span>
</span><span id="__span-4-445"><a href="#__codelineno-4-445" id="__codelineno-4-445" name="__codelineno-4-445"></a>
</span><span id="__span-4-446"><a href="#__codelineno-4-446" id="__codelineno-4-446" name="__codelineno-4-446"></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-447"><a href="#__codelineno-4-447" id="__codelineno-4-447" name="__codelineno-4-447"></a>
</span><span id="__span-4-448"><a href="#__codelineno-4-448" id="__codelineno-4-448" name="__codelineno-4-448"></a>        <span class="c1"># Response time recommendations</span>
</span><span id="__span-4-449"><a href="#__codelineno-4-449" id="__codelineno-4-449" name="__codelineno-4-449"></a>        <span class="n">avg_response_time</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">"response_time"</span><span class="p">][</span><span class="s2">"average"</span><span class="p">]</span>
</span><span id="__span-4-450"><a href="#__codelineno-4-450" id="__codelineno-4-450" name="__codelineno-4-450"></a>        <span class="k">if</span> <span class="n">avg_response_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_thresholds</span><span class="p">[</span><span class="s2">"response_time_ms"</span><span class="p">][</span><span class="s2">"warning"</span><span class="p">]:</span>
</span><span id="__span-4-451"><a href="#__codelineno-4-451" id="__codelineno-4-451" name="__codelineno-4-451"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-4-452"><a href="#__codelineno-4-452" id="__codelineno-4-452" name="__codelineno-4-452"></a>                <span class="sa">f</span><span class="s2">"Average response time (</span><span class="si">{</span><span class="n">avg_response_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms) is above warning threshold. "</span>
</span><span id="__span-4-453"><a href="#__codelineno-4-453" id="__codelineno-4-453" name="__codelineno-4-453"></a>                <span class="s2">"Consider implementing more aggressive caching or adding additional PoPs."</span>
</span><span id="__span-4-454"><a href="#__codelineno-4-454" id="__codelineno-4-454" name="__codelineno-4-454"></a>            <span class="p">)</span>
</span><span id="__span-4-455"><a href="#__codelineno-4-455" id="__codelineno-4-455" name="__codelineno-4-455"></a>
</span><span id="__span-4-456"><a href="#__codelineno-4-456" id="__codelineno-4-456" name="__codelineno-4-456"></a>        <span class="c1"># Cache performance recommendations</span>
</span><span id="__span-4-457"><a href="#__codelineno-4-457" id="__codelineno-4-457" name="__codelineno-4-457"></a>        <span class="n">avg_cache_ratio</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">][</span><span class="s2">"average_hit_ratio"</span><span class="p">]</span>
</span><span id="__span-4-458"><a href="#__codelineno-4-458" id="__codelineno-4-458" name="__codelineno-4-458"></a>        <span class="k">if</span> <span class="n">avg_cache_ratio</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_thresholds</span><span class="p">[</span><span class="s2">"cache_hit_ratio"</span><span class="p">][</span><span class="s2">"warning"</span><span class="p">]:</span>
</span><span id="__span-4-459"><a href="#__codelineno-4-459" id="__codelineno-4-459" name="__codelineno-4-459"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-4-460"><a href="#__codelineno-4-460" id="__codelineno-4-460" name="__codelineno-4-460"></a>                <span class="sa">f</span><span class="s2">"Cache hit ratio (</span><span class="si">{</span><span class="n">avg_cache_ratio</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">) is below optimal. "</span>
</span><span id="__span-4-461"><a href="#__codelineno-4-461" id="__codelineno-4-461" name="__codelineno-4-461"></a>                <span class="s2">"Consider increasing cache TTL or implementing cache warmup strategies."</span>
</span><span id="__span-4-462"><a href="#__codelineno-4-462" id="__codelineno-4-462" name="__codelineno-4-462"></a>            <span class="p">)</span>
</span><span id="__span-4-463"><a href="#__codelineno-4-463" id="__codelineno-4-463" name="__codelineno-4-463"></a>
</span><span id="__span-4-464"><a href="#__codelineno-4-464" id="__codelineno-4-464" name="__codelineno-4-464"></a>        <span class="c1"># Regional performance recommendations</span>
</span><span id="__span-4-465"><a href="#__codelineno-4-465" id="__codelineno-4-465" name="__codelineno-4-465"></a>        <span class="n">worst_region</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"worst_region"</span><span class="p">)</span>
</span><span id="__span-4-466"><a href="#__codelineno-4-466" id="__codelineno-4-466" name="__codelineno-4-466"></a>        <span class="k">if</span> <span class="n">worst_region</span> <span class="ow">and</span> <span class="n">worst_region</span><span class="p">[</span><span class="s2">"hit_ratio"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.85</span><span class="p">:</span>
</span><span id="__span-4-467"><a href="#__codelineno-4-467" id="__codelineno-4-467" name="__codelineno-4-467"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-4-468"><a href="#__codelineno-4-468" id="__codelineno-4-468" name="__codelineno-4-468"></a>                <span class="sa">f</span><span class="s2">"Region </span><span class="si">{</span><span class="n">worst_region</span><span class="p">[</span><span class="s1">'region'</span><span class="p">]</span><span class="si">}</span><span class="s2"> has poor cache performance (</span><span class="si">{</span><span class="n">worst_region</span><span class="p">[</span><span class="s1">'hit_ratio'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">). "</span>
</span><span id="__span-4-469"><a href="#__codelineno-4-469" id="__codelineno-4-469" name="__codelineno-4-469"></a>                <span class="s2">"Consider regional cache optimization or capacity increase."</span>
</span><span id="__span-4-470"><a href="#__codelineno-4-470" id="__codelineno-4-470" name="__codelineno-4-470"></a>            <span class="p">)</span>
</span><span id="__span-4-471"><a href="#__codelineno-4-471" id="__codelineno-4-471" name="__codelineno-4-471"></a>
</span><span id="__span-4-472"><a href="#__codelineno-4-472" id="__codelineno-4-472" name="__codelineno-4-472"></a>        <span class="k">return</span> <span class="n">recommendations</span>
</span><span id="__span-4-473"><a href="#__codelineno-4-473" id="__codelineno-4-473" name="__codelineno-4-473"></a>
</span><span id="__span-4-474"><a href="#__codelineno-4-474" id="__codelineno-4-474" name="__codelineno-4-474"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_performance_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceMetric</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-4-475"><a href="#__codelineno-4-475" id="__codelineno-4-475" name="__codelineno-4-475"></a><span class="w">        </span><span class="sd">"""Check for performance alerts"""</span>
</span><span id="__span-4-476"><a href="#__codelineno-4-476" id="__codelineno-4-476" name="__codelineno-4-476"></a>
</span><span id="__span-4-477"><a href="#__codelineno-4-477" id="__codelineno-4-477" name="__codelineno-4-477"></a>        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-478"><a href="#__codelineno-4-478" id="__codelineno-4-478" name="__codelineno-4-478"></a>        <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_thresholds</span>
</span><span id="__span-4-479"><a href="#__codelineno-4-479" id="__codelineno-4-479" name="__codelineno-4-479"></a>
</span><span id="__span-4-480"><a href="#__codelineno-4-480" id="__codelineno-4-480" name="__codelineno-4-480"></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span><span id="__span-4-481"><a href="#__codelineno-4-481" id="__codelineno-4-481" name="__codelineno-4-481"></a>            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
</span><span id="__span-4-482"><a href="#__codelineno-4-482" id="__codelineno-4-482" name="__codelineno-4-482"></a>                <span class="n">critical_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">"critical"</span><span class="p">]</span>
</span><span id="__span-4-483"><a href="#__codelineno-4-483" id="__codelineno-4-483" name="__codelineno-4-483"></a>
</span><span id="__span-4-484"><a href="#__codelineno-4-484" id="__codelineno-4-484" name="__codelineno-4-484"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"response_time_ms"</span><span class="p">,</span> <span class="s2">"error_rate"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">critical_threshold</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="__span-4-485"><a href="#__codelineno-4-485" id="__codelineno-4-485" name="__codelineno-4-485"></a>                   <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"cache_hit_ratio"</span><span class="p">,</span> <span class="s2">"bandwidth_utilization"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">metric</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">critical_threshold</span><span class="p">):</span>
</span><span id="__span-4-486"><a href="#__codelineno-4-486" id="__codelineno-4-486" name="__codelineno-4-486"></a>
</span><span id="__span-4-487"><a href="#__codelineno-4-487" id="__codelineno-4-487" name="__codelineno-4-487"></a>                    <span class="n">region_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">" in </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">""</span>
</span><span id="__span-4-488"><a href="#__codelineno-4-488" id="__codelineno-4-488" name="__codelineno-4-488"></a>                    <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-4-489"><a href="#__codelineno-4-489" id="__codelineno-4-489" name="__codelineno-4-489"></a>                        <span class="sa">f</span><span class="s2">"CRITICAL: </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">) exceeded critical threshold "</span>
</span><span id="__span-4-490"><a href="#__codelineno-4-490" id="__codelineno-4-490" name="__codelineno-4-490"></a>                        <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">critical_threshold</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">region_info</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-4-491"><a href="#__codelineno-4-491" id="__codelineno-4-491" name="__codelineno-4-491"></a>                    <span class="p">)</span>
</span><span id="__span-4-492"><a href="#__codelineno-4-492" id="__codelineno-4-492" name="__codelineno-4-492"></a>
</span><span id="__span-4-493"><a href="#__codelineno-4-493" id="__codelineno-4-493" name="__codelineno-4-493"></a>        <span class="k">return</span> <span class="n">alerts</span>
</span><span id="__span-4-494"><a href="#__codelineno-4-494" id="__codelineno-4-494" name="__codelineno-4-494"></a>
</span><span id="__span-4-495"><a href="#__codelineno-4-495" id="__codelineno-4-495" name="__codelineno-4-495"></a><span class="c1"># Real-time performance monitoring</span>
</span><span id="__span-4-496"><a href="#__codelineno-4-496" id="__codelineno-4-496" name="__codelineno-4-496"></a><span class="k">class</span><span class="w"> </span><span class="nc">RealTimePerformanceMonitor</span><span class="p">:</span>
</span><span id="__span-4-497"><a href="#__codelineno-4-497" id="__codelineno-4-497" name="__codelineno-4-497"></a><span class="w">    </span><span class="sd">"""Real-time CDN performance monitoring"""</span>
</span><span id="__span-4-498"><a href="#__codelineno-4-498" id="__codelineno-4-498" name="__codelineno-4-498"></a>
</span><span id="__span-4-499"><a href="#__codelineno-4-499" id="__codelineno-4-499" name="__codelineno-4-499"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdn_manager</span><span class="p">:</span> <span class="n">SmartCDNManager</span><span class="p">):</span>
</span><span id="__span-4-500"><a href="#__codelineno-4-500" id="__codelineno-4-500" name="__codelineno-4-500"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span> <span class="o">=</span> <span class="n">cdn_manager</span>
</span><span id="__span-4-501"><a href="#__codelineno-4-501" id="__codelineno-4-501" name="__codelineno-4-501"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-4-502"><a href="#__codelineno-4-502" id="__codelineno-4-502" name="__codelineno-4-502"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">performance_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-503"><a href="#__codelineno-4-503" id="__codelineno-4-503" name="__codelineno-4-503"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-504"><a href="#__codelineno-4-504" id="__codelineno-4-504" name="__codelineno-4-504"></a>
</span><span id="__span-4-505"><a href="#__codelineno-4-505" id="__codelineno-4-505" name="__codelineno-4-505"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
</span><span id="__span-4-506"><a href="#__codelineno-4-506" id="__codelineno-4-506" name="__codelineno-4-506"></a><span class="w">        </span><span class="sd">"""Start real-time performance monitoring"""</span>
</span><span id="__span-4-507"><a href="#__codelineno-4-507" id="__codelineno-4-507" name="__codelineno-4-507"></a>
</span><span id="__span-4-508"><a href="#__codelineno-4-508" id="__codelineno-4-508" name="__codelineno-4-508"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-4-509"><a href="#__codelineno-4-509" id="__codelineno-4-509" name="__codelineno-4-509"></a>
</span><span id="__span-4-510"><a href="#__codelineno-4-510" id="__codelineno-4-510" name="__codelineno-4-510"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span><span class="p">:</span>
</span><span id="__span-4-511"><a href="#__codelineno-4-511" id="__codelineno-4-511" name="__codelineno-4-511"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-512"><a href="#__codelineno-4-512" id="__codelineno-4-512" name="__codelineno-4-512"></a>                <span class="c1"># Collect performance metrics</span>
</span><span id="__span-4-513"><a href="#__codelineno-4-513" id="__codelineno-4-513" name="__codelineno-4-513"></a>                <span class="n">monitor</span> <span class="o">=</span> <span class="n">CDNPerformanceMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cdn_manager</span><span class="p">)</span>
</span><span id="__span-4-514"><a href="#__codelineno-4-514" id="__codelineno-4-514" name="__codelineno-4-514"></a>                <span class="n">report</span> <span class="o">=</span> <span class="k">await</span> <span class="n">monitor</span><span class="o">.</span><span class="n">measure_performance</span><span class="p">()</span>
</span><span id="__span-4-515"><a href="#__codelineno-4-515" id="__codelineno-4-515" name="__codelineno-4-515"></a>
</span><span id="__span-4-516"><a href="#__codelineno-4-516" id="__codelineno-4-516" name="__codelineno-4-516"></a>                <span class="c1"># Store metrics</span>
</span><span id="__span-4-517"><a href="#__codelineno-4-517" id="__codelineno-4-517" name="__codelineno-4-517"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">performance_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-4-518"><a href="#__codelineno-4-518" id="__codelineno-4-518" name="__codelineno-4-518"></a>                    <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
</span><span id="__span-4-519"><a href="#__codelineno-4-519" id="__codelineno-4-519" name="__codelineno-4-519"></a>                    <span class="s2">"metrics"</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
</span><span id="__span-4-520"><a href="#__codelineno-4-520" id="__codelineno-4-520" name="__codelineno-4-520"></a>                    <span class="s2">"summary"</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">summary</span>
</span><span id="__span-4-521"><a href="#__codelineno-4-521" id="__codelineno-4-521" name="__codelineno-4-521"></a>                <span class="p">})</span>
</span><span id="__span-4-522"><a href="#__codelineno-4-522" id="__codelineno-4-522" name="__codelineno-4-522"></a>
</span><span id="__span-4-523"><a href="#__codelineno-4-523" id="__codelineno-4-523" name="__codelineno-4-523"></a>                <span class="c1"># Trim buffer to last 24 hours</span>
</span><span id="__span-4-524"><a href="#__codelineno-4-524" id="__codelineno-4-524" name="__codelineno-4-524"></a>                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="__span-4-525"><a href="#__codelineno-4-525" id="__codelineno-4-525" name="__codelineno-4-525"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">performance_buffer</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-526"><a href="#__codelineno-4-526" id="__codelineno-4-526" name="__codelineno-4-526"></a>                    <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_buffer</span>
</span><span id="__span-4-527"><a href="#__codelineno-4-527" id="__codelineno-4-527" name="__codelineno-4-527"></a>                    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span>
</span><span id="__span-4-528"><a href="#__codelineno-4-528" id="__codelineno-4-528" name="__codelineno-4-528"></a>                <span class="p">]</span>
</span><span id="__span-4-529"><a href="#__codelineno-4-529" id="__codelineno-4-529" name="__codelineno-4-529"></a>
</span><span id="__span-4-530"><a href="#__codelineno-4-530" id="__codelineno-4-530" name="__codelineno-4-530"></a>                <span class="c1"># Check for alerts</span>
</span><span id="__span-4-531"><a href="#__codelineno-4-531" id="__codelineno-4-531" name="__codelineno-4-531"></a>                <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">alerts</span><span class="p">:</span>
</span><span id="__span-4-532"><a href="#__codelineno-4-532" id="__codelineno-4-532" name="__codelineno-4-532"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_alerts</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">alerts</span><span class="p">)</span>
</span><span id="__span-4-533"><a href="#__codelineno-4-533" id="__codelineno-4-533" name="__codelineno-4-533"></a>
</span><span id="__span-4-534"><a href="#__codelineno-4-534" id="__codelineno-4-534" name="__codelineno-4-534"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval_seconds</span><span class="p">)</span>
</span><span id="__span-4-535"><a href="#__codelineno-4-535" id="__codelineno-4-535" name="__codelineno-4-535"></a>
</span><span id="__span-4-536"><a href="#__codelineno-4-536" id="__codelineno-4-536" name="__codelineno-4-536"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-537"><a href="#__codelineno-4-537" id="__codelineno-4-537" name="__codelineno-4-537"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Real-time monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-538"><a href="#__codelineno-4-538" id="__codelineno-4-538" name="__codelineno-4-538"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval_seconds</span><span class="p">)</span>
</span><span id="__span-4-539"><a href="#__codelineno-4-539" id="__codelineno-4-539" name="__codelineno-4-539"></a>
</span><span id="__span-4-540"><a href="#__codelineno-4-540" id="__codelineno-4-540" name="__codelineno-4-540"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alerts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span><span id="__span-4-541"><a href="#__codelineno-4-541" id="__codelineno-4-541" name="__codelineno-4-541"></a><span class="w">        </span><span class="sd">"""Handle performance alerts"""</span>
</span><span id="__span-4-542"><a href="#__codelineno-4-542" id="__codelineno-4-542" name="__codelineno-4-542"></a>
</span><span id="__span-4-543"><a href="#__codelineno-4-543" id="__codelineno-4-543" name="__codelineno-4-543"></a>        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">alerts</span><span class="p">:</span>
</span><span id="__span-4-544"><a href="#__codelineno-4-544" id="__codelineno-4-544" name="__codelineno-4-544"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CDN Performance Alert: </span><span class="si">{</span><span class="n">alert</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-545"><a href="#__codelineno-4-545" id="__codelineno-4-545" name="__codelineno-4-545"></a>
</span><span id="__span-4-546"><a href="#__codelineno-4-546" id="__codelineno-4-546" name="__codelineno-4-546"></a>            <span class="c1"># Notify registered callbacks</span>
</span><span id="__span-4-547"><a href="#__codelineno-4-547" id="__codelineno-4-547" name="__codelineno-4-547"></a>            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_callbacks</span><span class="p">:</span>
</span><span id="__span-4-548"><a href="#__codelineno-4-548" id="__codelineno-4-548" name="__codelineno-4-548"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-549"><a href="#__codelineno-4-549" id="__codelineno-4-549" name="__codelineno-4-549"></a>                    <span class="k">await</span> <span class="n">callback</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
</span><span id="__span-4-550"><a href="#__codelineno-4-550" id="__codelineno-4-550" name="__codelineno-4-550"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-551"><a href="#__codelineno-4-551" id="__codelineno-4-551" name="__codelineno-4-551"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Alert callback failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-552"><a href="#__codelineno-4-552" id="__codelineno-4-552" name="__codelineno-4-552"></a>
</span><span id="__span-4-553"><a href="#__codelineno-4-553" id="__codelineno-4-553" name="__codelineno-4-553"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_alert_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
</span><span id="__span-4-554"><a href="#__codelineno-4-554" id="__codelineno-4-554" name="__codelineno-4-554"></a><span class="w">        </span><span class="sd">"""Register callback for performance alerts"""</span>
</span><span id="__span-4-555"><a href="#__codelineno-4-555" id="__codelineno-4-555" name="__codelineno-4-555"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span id="__span-4-556"><a href="#__codelineno-4-556" id="__codelineno-4-556" name="__codelineno-4-556"></a>
</span><span id="__span-4-557"><a href="#__codelineno-4-557" id="__codelineno-4-557" name="__codelineno-4-557"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_recent_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-558"><a href="#__codelineno-4-558" id="__codelineno-4-558" name="__codelineno-4-558"></a><span class="w">        </span><span class="sd">"""Get recent performance data"""</span>
</span><span id="__span-4-559"><a href="#__codelineno-4-559" id="__codelineno-4-559" name="__codelineno-4-559"></a>
</span><span id="__span-4-560"><a href="#__codelineno-4-560" id="__codelineno-4-560" name="__codelineno-4-560"></a>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="__span-4-561"><a href="#__codelineno-4-561" id="__codelineno-4-561" name="__codelineno-4-561"></a>        <span class="n">recent_data</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-562"><a href="#__codelineno-4-562" id="__codelineno-4-562" name="__codelineno-4-562"></a>            <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_buffer</span>
</span><span id="__span-4-563"><a href="#__codelineno-4-563" id="__codelineno-4-563" name="__codelineno-4-563"></a>            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span>
</span><span id="__span-4-564"><a href="#__codelineno-4-564" id="__codelineno-4-564" name="__codelineno-4-564"></a>        <span class="p">]</span>
</span><span id="__span-4-565"><a href="#__codelineno-4-565" id="__codelineno-4-565" name="__codelineno-4-565"></a>
</span><span id="__span-4-566"><a href="#__codelineno-4-566" id="__codelineno-4-566" name="__codelineno-4-566"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_data</span><span class="p">:</span>
</span><span id="__span-4-567"><a href="#__codelineno-4-567" id="__codelineno-4-567" name="__codelineno-4-567"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"No recent performance data available"</span><span class="p">}</span>
</span><span id="__span-4-568"><a href="#__codelineno-4-568" id="__codelineno-4-568" name="__codelineno-4-568"></a>
</span><span id="__span-4-569"><a href="#__codelineno-4-569" id="__codelineno-4-569" name="__codelineno-4-569"></a>        <span class="c1"># Aggregate recent performance</span>
</span><span id="__span-4-570"><a href="#__codelineno-4-570" id="__codelineno-4-570" name="__codelineno-4-570"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-571"><a href="#__codelineno-4-571" id="__codelineno-4-571" name="__codelineno-4-571"></a>            <span class="s2">"timeframe_hours"</span><span class="p">:</span> <span class="n">hours</span><span class="p">,</span>
</span><span id="__span-4-572"><a href="#__codelineno-4-572" id="__codelineno-4-572" name="__codelineno-4-572"></a>            <span class="s2">"data_points"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_data</span><span class="p">),</span>
</span><span id="__span-4-573"><a href="#__codelineno-4-573" id="__codelineno-4-573" name="__codelineno-4-573"></a>            <span class="s2">"latest_summary"</span><span class="p">:</span> <span class="n">recent_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"summary"</span><span class="p">]</span> <span class="k">if</span> <span class="n">recent_data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-574"><a href="#__codelineno-4-574" id="__codelineno-4-574" name="__codelineno-4-574"></a>            <span class="s2">"trend_analysis"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_performance_trends</span><span class="p">(</span><span class="n">recent_data</span><span class="p">)</span>
</span><span id="__span-4-575"><a href="#__codelineno-4-575" id="__codelineno-4-575" name="__codelineno-4-575"></a>        <span class="p">}</span>
</span><span id="__span-4-576"><a href="#__codelineno-4-576" id="__codelineno-4-576" name="__codelineno-4-576"></a>
</span><span id="__span-4-577"><a href="#__codelineno-4-577" id="__codelineno-4-577" name="__codelineno-4-577"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_performance_trends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-578"><a href="#__codelineno-4-578" id="__codelineno-4-578" name="__codelineno-4-578"></a><span class="w">        </span><span class="sd">"""Analyze performance trends"""</span>
</span><span id="__span-4-579"><a href="#__codelineno-4-579" id="__codelineno-4-579" name="__codelineno-4-579"></a>
</span><span id="__span-4-580"><a href="#__codelineno-4-580" id="__codelineno-4-580" name="__codelineno-4-580"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-4-581"><a href="#__codelineno-4-581" id="__codelineno-4-581" name="__codelineno-4-581"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Insufficient data for trend analysis"</span><span class="p">}</span>
</span><span id="__span-4-582"><a href="#__codelineno-4-582" id="__codelineno-4-582" name="__codelineno-4-582"></a>
</span><span id="__span-4-583"><a href="#__codelineno-4-583" id="__codelineno-4-583" name="__codelineno-4-583"></a>        <span class="c1"># Extract key metrics over time</span>
</span><span id="__span-4-584"><a href="#__codelineno-4-584" id="__codelineno-4-584" name="__codelineno-4-584"></a>        <span class="n">response_times</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-585"><a href="#__codelineno-4-585" id="__codelineno-4-585" name="__codelineno-4-585"></a>        <span class="n">cache_ratios</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-586"><a href="#__codelineno-4-586" id="__codelineno-4-586" name="__codelineno-4-586"></a>        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-587"><a href="#__codelineno-4-587" id="__codelineno-4-587" name="__codelineno-4-587"></a>
</span><span id="__span-4-588"><a href="#__codelineno-4-588" id="__codelineno-4-588" name="__codelineno-4-588"></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-4-589"><a href="#__codelineno-4-589" id="__codelineno-4-589" name="__codelineno-4-589"></a>            <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">])</span>
</span><span id="__span-4-590"><a href="#__codelineno-4-590" id="__codelineno-4-590" name="__codelineno-4-590"></a>            <span class="n">summary</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"summary"</span><span class="p">]</span>
</span><span id="__span-4-591"><a href="#__codelineno-4-591" id="__codelineno-4-591" name="__codelineno-4-591"></a>            <span class="n">response_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s2">"response_time"</span><span class="p">][</span><span class="s2">"average"</span><span class="p">])</span>
</span><span id="__span-4-592"><a href="#__codelineno-4-592" id="__codelineno-4-592" name="__codelineno-4-592"></a>            <span class="n">cache_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s2">"cache_performance"</span><span class="p">][</span><span class="s2">"average_hit_ratio"</span><span class="p">])</span>
</span><span id="__span-4-593"><a href="#__codelineno-4-593" id="__codelineno-4-593" name="__codelineno-4-593"></a>
</span><span id="__span-4-594"><a href="#__codelineno-4-594" id="__codelineno-4-594" name="__codelineno-4-594"></a>        <span class="c1"># Calculate trends</span>
</span><span id="__span-4-595"><a href="#__codelineno-4-595" id="__codelineno-4-595" name="__codelineno-4-595"></a>        <span class="n">response_time_trend</span> <span class="o">=</span> <span class="s2">"improving"</span> <span class="k">if</span> <span class="n">response_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">response_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">"degrading"</span>
</span><span id="__span-4-596"><a href="#__codelineno-4-596" id="__codelineno-4-596" name="__codelineno-4-596"></a>        <span class="n">cache_trend</span> <span class="o">=</span> <span class="s2">"improving"</span> <span class="k">if</span> <span class="n">cache_ratios</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cache_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">"degrading"</span>
</span><span id="__span-4-597"><a href="#__codelineno-4-597" id="__codelineno-4-597" name="__codelineno-4-597"></a>
</span><span id="__span-4-598"><a href="#__codelineno-4-598" id="__codelineno-4-598" name="__codelineno-4-598"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-599"><a href="#__codelineno-4-599" id="__codelineno-4-599" name="__codelineno-4-599"></a>            <span class="s2">"response_time_trend"</span><span class="p">:</span> <span class="n">response_time_trend</span><span class="p">,</span>
</span><span id="__span-4-600"><a href="#__codelineno-4-600" id="__codelineno-4-600" name="__codelineno-4-600"></a>            <span class="s2">"cache_performance_trend"</span><span class="p">:</span> <span class="n">cache_trend</span><span class="p">,</span>
</span><span id="__span-4-601"><a href="#__codelineno-4-601" id="__codelineno-4-601" name="__codelineno-4-601"></a>            <span class="s2">"data_points_analyzed"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
</span><span id="__span-4-602"><a href="#__codelineno-4-602" id="__codelineno-4-602" name="__codelineno-4-602"></a>            <span class="s2">"time_span_minutes"</span><span class="p">:</span> <span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
</span><span id="__span-4-603"><a href="#__codelineno-4-603" id="__codelineno-4-603" name="__codelineno-4-603"></a>        <span class="p">}</span>
</span><span id="__span-4-604"><a href="#__codelineno-4-604" id="__codelineno-4-604" name="__codelineno-4-604"></a>
</span><span id="__span-4-605"><a href="#__codelineno-4-605" id="__codelineno-4-605" name="__codelineno-4-605"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-4-606"><a href="#__codelineno-4-606" id="__codelineno-4-606" name="__codelineno-4-606"></a><span class="w">        </span><span class="sd">"""Stop real-time monitoring"""</span>
</span><span id="__span-4-607"><a href="#__codelineno-4-607" id="__codelineno-4-607" name="__codelineno-4-607"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_active</span> <span class="o">=</span> <span class="kc">False</span>
</span></code></pre></div> <p>This comprehensive CDN integration system provides intelligent content delivery optimization, real-time performance monitoring, and automated optimization strategies specifically designed for educational platforms. The system ensures optimal performance across global regions while maintaining cost efficiency and educational compliance requirements.</p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:00:33 UTC"><span class="timeago" datetime="2025-09-28T04:00:33+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:00:33 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Created"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 04:00:33 UTC"><span class="timeago" datetime="2025-09-28T04:00:33+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 04:00:33 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Contributors"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"></path></svg> </span> <nav> <a href="mailto:140660682+grayghostdev@users.noreply.github.com">GrayGhostDev</a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button class="md-top md-icon" data-md-component="top" hidden="" type="button"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 ToolBoxAI Solutions </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/ToolBoxAI-Solutions" rel="noopener" target="_blank" title="ToolBoxAI on GitHub"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a class="md-social__link" href="https://discord.gg/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Discord"> <svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"></path></svg> </a> <a class="md-social__link" href="https://twitter.com/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Twitter"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <div class="md-progress" data-md-component="progress" role="progressbar"></div> <div class="md-consent" data-md-component="consent" hidden="" id="__consent"> <div class="md-consent__overlay"></div> <aside class="md-consent__inner"> <form class="md-consent__form md-grid md-typeset" name="consent"> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class="md-toggle" id="__settings" type="checkbox"/> <div class="md-consent__settings"> <ul class="task-list"> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="analytics" type="checkbox"/> <span class="task-list-indicator"></span> Google Analytics </label> </li> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="github" type="checkbox"/> <span class="task-list-indicator"></span> GitHub </label> </li> </ul> </div> <div class="md-consent__controls"> <button class="md-button md-button--primary">Accept</button> <label class="md-button" for="__settings">Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script> <script src="../../../js/timeago.min.js"></script> <script src="../../../js/timeago_mkdocs_material.js"></script> <script src="../../../javascripts/extra.js"></script> <script src="../../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> </body> </html>