name: Security Agents Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - dependencies
          - licenses
          - vulnerabilities
          - quick

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20.12.0'

jobs:
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-security-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-security-
            ${{ runner.os }}-pip-

      - name: Cache Node dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-security-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-security-
            ${{ runner.os }}-node-

      - name: Install Python security tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety pip-audit bandit semgrep pylint

      - name: Install Node security tools
        working-directory: apps/dashboard
        run: |
          npm ci
          npm install -g npm-audit-html license-checker

      - name: Run Dependency Security Agent
        id: dependency-scan
        run: |
          python -c "
          import asyncio
          import json
          import sys
          import os
          from datetime import datetime
          sys.path.insert(0, '.')

          from core.agents.github_agents import DependencySecurityAgent

          async def main():
              agent = DependencySecurityAgent()

              # Determine scan type
              scan_type = '${{ github.event.inputs.scan_type || 'comprehensive' }}'

              scan_python = scan_type in ['comprehensive', 'dependencies', 'vulnerabilities']
              scan_nodejs = scan_type in ['comprehensive', 'dependencies', 'vulnerabilities']
              check_licenses = scan_type in ['comprehensive', 'licenses']

              print(f'ðŸ” Running {scan_type} security scan...')
              print(f'Scan Python: {scan_python}')
              print(f'Scan Node.js: {scan_nodejs}')
              print(f'Check Licenses: {check_licenses}')

              result = await agent.analyze(
                  scan_python=scan_python,
                  scan_nodejs=scan_nodejs,
                  check_licenses=check_licenses,
                  repo_path='.'
              )

              # Write results
              timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
              report_file = f'security_report_{timestamp}.json'
              with open(report_file, 'w') as f:
                  json.dump(result, f, indent=2)

              # Print summary
              print()
              print('## ðŸ“Š Security Scan Results')
              print()

              if 'vulnerabilities' in result:
                  vulns = result['vulnerabilities']
                  critical = len([v for v in vulns if v.get('severity') == 'critical'])
                  high = len([v for v in vulns if v.get('severity') == 'high'])
                  medium = len([v for v in vulns if v.get('severity') == 'medium'])
                  low = len([v for v in vulns if v.get('severity') == 'low'])

                  print(f'### Vulnerabilities Found')
                  print(f'- Critical: {critical}')
                  print(f'- High: {high}')
                  print(f'- Medium: {medium}')
                  print(f'- Low: {low}')
                  print()

                  if critical > 0 or high > 0:
                      print('### âš ï¸ Critical/High Vulnerabilities')
                      for v in vulns:
                          if v.get('severity') in ['critical', 'high']:
                              print(f\"- **{v.get('package', 'unknown')}**: {v.get('vulnerability_id', 'N/A')} - {v.get('title', 'No description')}\")
                      print()

              if 'outdated_packages' in result:
                  outdated = result['outdated_packages']
                  major = len([p for p in outdated if p.get('update_type') == 'major'])
                  minor = len([p for p in outdated if p.get('update_type') == 'minor'])
                  patch = len([p for p in outdated if p.get('update_type') == 'patch'])

                  print(f'### Outdated Packages')
                  print(f'- Major updates: {major}')
                  print(f'- Minor updates: {minor}')
                  print(f'- Patch updates: {patch}')
                  print()

              if 'license_issues' in result:
                  issues = result['license_issues']
                  if issues:
                      print(f'### License Issues')
                      print(f'Found {len(issues)} packages with license concerns')
                      for issue in issues[:5]:
                          print(f\"- {issue.get('package', 'unknown')}: {issue.get('license', 'unknown license')}\")
                      print()

              # Set outputs
              has_critical = any(
                  v.get('severity') == 'critical'
                  for v in result.get('vulnerabilities', [])
              )

              print(f'::set-output name=has_critical::{str(has_critical).lower()}')
              print(f'::set-output name=report_file::{report_file}')

              return 0 if not has_critical else 1

          exit_code = asyncio.run(main())
          sys.exit(exit_code)
          " || true

      - name: Run Bandit Security Scan (Python)
        if: github.event.inputs.scan_type == 'comprehensive' || github.event.inputs.scan_type == 'vulnerabilities'
        run: |
          echo "## Running Bandit static analysis..."
          bandit -r apps/backend core -f json -o bandit_report.json || true
          bandit -r apps/backend core -f txt || true

      - name: Run Semgrep Analysis
        if: github.event.inputs.scan_type == 'comprehensive'
        run: |
          echo "## Running Semgrep security analysis..."
          semgrep --config=auto --json -o semgrep_report.json . || true
          semgrep --config=auto --text . || true

      - name: Run npm audit
        if: github.event.inputs.scan_type == 'comprehensive' || github.event.inputs.scan_type == 'dependencies'
        working-directory: apps/dashboard
        run: |
          echo "## Running npm audit..."
          npm audit --json > npm_audit_report.json || true
          npm audit || true

      - name: Generate Security Report
        if: always()
        run: |
          python -c "
          import json
          import os
          from datetime import datetime

          # Collect all security reports
          reports = {}
          report_files = {
              'dependency_security': 'security_report_*.json',
              'bandit': 'bandit_report.json',
              'semgrep': 'semgrep_report.json',
              'npm_audit': 'apps/dashboard/npm_audit_report.json'
          }

          import glob
          for name, pattern in report_files.items():
              files = glob.glob(pattern)
              if files:
                  try:
                      with open(files[0], 'r') as f:
                          reports[name] = json.load(f)
                  except Exception as e:
                      print(f'Failed to load {name}: {e}')

          # Create comprehensive security report
          comprehensive_report = {
              'timestamp': datetime.now().isoformat(),
              'repository': '${{ github.repository }}',
              'branch': '${{ github.ref_name }}',
              'scan_type': '${{ github.event.inputs.scan_type || 'comprehensive' }}',
              'reports': reports,
              'summary': {
                  'total_vulnerabilities': 0,
                  'critical_vulnerabilities': 0,
                  'high_vulnerabilities': 0,
                  'outdated_packages': 0,
                  'license_issues': 0
              }
          }

          # Calculate summary statistics
          if 'dependency_security' in reports:
              ds = reports['dependency_security']
              if 'vulnerabilities' in ds:
                  vulns = ds['vulnerabilities']
                  comprehensive_report['summary']['total_vulnerabilities'] = len(vulns)
                  comprehensive_report['summary']['critical_vulnerabilities'] = len([v for v in vulns if v.get('severity') == 'critical'])
                  comprehensive_report['summary']['high_vulnerabilities'] = len([v for v in vulns if v.get('severity') == 'high'])
              if 'outdated_packages' in ds:
                  comprehensive_report['summary']['outdated_packages'] = len(ds['outdated_packages'])
              if 'license_issues' in ds:
                  comprehensive_report['summary']['license_issues'] = len(ds['license_issues'])

          # Save comprehensive report
          with open('comprehensive_security_report.json', 'w') as f:
              json.dump(comprehensive_report, f, indent=2)

          # Generate markdown report
          with open('security_report.md', 'w') as f:
              f.write('# ðŸ”’ Security Scan Report\\n\\n')
              f.write(f\"**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}\\n\")
              f.write(f\"**Repository:** {comprehensive_report['repository']}\\n\")
              f.write(f\"**Branch:** {comprehensive_report['branch']}\\n\")
              f.write(f\"**Scan Type:** {comprehensive_report['scan_type']}\\n\\n\")

              f.write('## Summary\\n\\n')
              summary = comprehensive_report['summary']
              f.write(f\"- **Total Vulnerabilities:** {summary['total_vulnerabilities']}\\n\")
              f.write(f\"- **Critical:** {summary['critical_vulnerabilities']}\\n\")
              f.write(f\"- **High:** {summary['high_vulnerabilities']}\\n\")
              f.write(f\"- **Outdated Packages:** {summary['outdated_packages']}\\n\")
              f.write(f\"- **License Issues:** {summary['license_issues']}\\n\\n\")

              if summary['critical_vulnerabilities'] > 0:
                  f.write('## âš ï¸ Critical Security Issues\\n\\n')
                  f.write('Critical vulnerabilities were found that require immediate attention.\\n\\n')

              f.write('## Recommendations\\n\\n')
              if summary['critical_vulnerabilities'] > 0 or summary['high_vulnerabilities'] > 0:
                  f.write('1. **Update vulnerable packages immediately**\\n')
                  f.write('2. **Review and apply security patches**\\n')
                  f.write('3. **Run security scans after updates**\\n')
              if summary['outdated_packages'] > 0:
                  f.write('- Consider updating outdated packages to latest stable versions\\n')
              if summary['license_issues'] > 0:
                  f.write('- Review packages with restrictive licenses for compliance\\n')

          print('Security reports generated successfully')
          "

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            security_report_*.json
            bandit_report.json
            semgrep_report.json
            npm_audit_report.json
            comprehensive_security_report.json
            security_report.md

      - name: Create Security Issue if Critical Vulnerabilities
        if: steps.dependency-scan.outputs.has_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = {};
            try {
              const files = require('glob').sync('security_report_*.json');
              if (files.length > 0) {
                const reportContent = fs.readFileSync(files[0], 'utf8');
                report = JSON.parse(reportContent);
              }
            } catch (e) {
              console.error('Failed to read security report:', e);
              return;
            }

            const criticalVulns = report.vulnerabilities?.filter(v => v.severity === 'critical') || [];

            if (criticalVulns.length > 0) {
              const issueTitle = `ðŸš¨ Critical Security Vulnerabilities Detected (${criticalVulns.length})`;

              let issueBody = '## Critical Security Vulnerabilities Found\n\n';
              issueBody += `A scheduled security scan on ${new Date().toISOString()} detected ${criticalVulns.length} critical vulnerabilities.\n\n`;

              issueBody += '### Affected Packages\n\n';
              for (const vuln of criticalVulns) {
                issueBody += `- **${vuln.package}** (${vuln.installed_version})\n`;
                issueBody += `  - Vulnerability: ${vuln.vulnerability_id}\n`;
                issueBody += `  - Description: ${vuln.title}\n`;
                issueBody += `  - Fixed in: ${vuln.fixed_version || 'No fix available'}\n\n`;
              }

              issueBody += '### Required Actions\n\n';
              issueBody += '1. Review the vulnerabilities listed above\n';
              issueBody += '2. Update affected packages to secure versions\n';
              issueBody += '3. Test the application after updates\n';
              issueBody += '4. Re-run security scans to verify fixes\n\n';

              issueBody += '---\n';
              issueBody += '*This issue was automatically created by the Security Agents Scan workflow.*';

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'critical', 'automated']
              });

              console.log('Security issue created successfully');
            }

      - name: Post to Slack/Discord
        if: steps.dependency-scan.outputs.has_critical == 'true'
        run: |
          echo "Would post security alert to Slack/Discord (webhook not configured)"
          # Uncomment and configure when webhooks are available:
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"ðŸš¨ Critical security vulnerabilities detected in ${{ github.repository }}"}'