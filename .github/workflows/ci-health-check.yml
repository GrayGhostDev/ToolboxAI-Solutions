name: CI/CD Health Check
# Monitors the health of all CI/CD workflows and dependencies

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch: {}  # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  check-dependencies:
    name: Dependency Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for outdated npm packages
        working-directory: apps/dashboard
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for outdated Python packages
        run: |
          pip install pip-check
          pip-check || true

  check-workflows:
    name: Workflow Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count workflow files
        id: count
        run: |
          total=$(find .github/workflows -name "*.yml" | wc -l)
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Total workflows: $total"

      - name: Check for duplicate workflows
        run: |
          echo "ðŸ” Checking for potential duplicates..."
          find .github/workflows -name "*test*.yml" | wc -l | xargs -I {} echo "Test workflows: {}"
          find .github/workflows -name "*ci*.yml" | wc -l | xargs -I {} echo "CI workflows: {}"
          find .github/workflows -name "*deploy*.yml" | wc -l | xargs -I {} echo "Deploy workflows: {}"

      - name: Validate workflow syntax
        run: |
          echo "âœ… Workflow syntax validation (checked by GitHub on push)"

  check-pr-health:
    name: PR Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Check open PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Checking open PRs..."
          gh pr list --repo ${{ github.repository }} --state open --json number,title,createdAt,author | \
            jq -r '.[] | "PR #\(.number): \(.title) (by \(.author.login)) - \(.createdAt)"'

      - name: Check stale PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“… Checking for stale PRs (>30 days)..."
          gh pr list --repo ${{ github.repository }} --state open --json number,title,createdAt | \
            jq -r --arg days_ago "$(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-30d +%Y-%m-%dT%H:%M:%SZ)" \
            '.[] | select(.createdAt < $days_ago) | "âš ï¸ Stale PR #\(.number): \(.title)"'

  check-security:
    name: Security Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dependabot alerts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ”’ Checking Dependabot alerts..."
          gh api /repos/${{ github.repository }}/dependabot/alerts?state=open | \
            jq -r '.[] | "Alert #\(.number): \(.security_vulnerability.package.name) - \(.security_advisory.severity)"' || \
            echo "âœ… No open Dependabot alerts"

  report:
    name: Generate Health Report
    needs: [check-dependencies, check-workflows, check-pr-health, check-security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸ¥ CI/CD Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies: Checked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflows: Analyzed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pull Requests: Reviewed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security: Scanned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the job logs above for detailed findings." >> $GITHUB_STEP_SUMMARY
