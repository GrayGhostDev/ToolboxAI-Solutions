name: Deploy to Render
# Enhanced Render deployment with health checks and rollback
# Replaces: render-deploy.yml, deploy.yml (render parts)

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/backend/**'
      - 'requirements*.txt'
      - 'render.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  RENDER_API_URL: 'https://api.render.com/v1'

permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  # Build and Test
  build:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: pytest apps/backend/tests/ --cov=apps/backend -v
      
      - name: Build application
        run: |
          python -m pip install build
          python -m build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: dist/
          retention-days: 7
  
  # Deploy to Staging (develop branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.service-url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Trigger Render deploy (Staging)
        id: deploy
        run: |
          response=$(curl -X POST "${{ env.RENDER_API_URL }}/services/${{ secrets.RENDER_SERVICE_ID_STAGING }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')
          
          deploy_id=$(echo $response | jq -r '.id')
          echo "deploy-id=$deploy_id" >> $GITHUB_OUTPUT
          echo "service-url=https://toolboxai-api-staging.onrender.com" >> $GITHUB_OUTPUT
      
      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 60
      
      - name: Health check
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s https://toolboxai-api-staging.onrender.com/health; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts failed, retrying..."
            sleep 30
            attempt=$((attempt+1))
          done
          
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Run smoke tests
        run: |
          curl -f https://toolboxai-api-staging.onrender.com/api/v1/status
          echo "âœ… Smoke tests passed"
  
  # Deploy to Production (main branch)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.service-url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Get current deployment info
        id: current
        run: |
          response=$(curl -s "${{ env.RENDER_API_URL }}/services/${{ secrets.RENDER_SERVICE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
          
          current_deploy_id=$(echo $response | jq -r '.service.deployments[0].id')
          echo "current-deploy-id=$current_deploy_id" >> $GITHUB_OUTPUT
      
      - name: Trigger Render deploy (Production)
        id: deploy
        run: |
          response=$(curl -X POST "${{ env.RENDER_API_URL }}/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')
          
          deploy_id=$(echo $response | jq -r '.id')
          echo "deploy-id=$deploy_id" >> $GITHUB_OUTPUT
          echo "service-url=https://toolboxai-api.onrender.com" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployment triggered: $deploy_id"
      
      - name: Monitor deployment
        run: |
          deploy_id="${{ steps.deploy.outputs.deploy-id }}"
          max_wait=600  # 10 minutes
          elapsed=0
          
          while [ $elapsed -lt $max_wait ]; do
            status=$(curl -s "${{ env.RENDER_API_URL }}/deploys/$deploy_id" \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" | jq -r '.status')
            
            echo "Deployment status: $status (elapsed: ${elapsed}s)"
            
            if [ "$status" == "live" ]; then
              echo "âœ… Deployment successful"
              exit 0
            elif [ "$status" == "failed" ]; then
              echo "âŒ Deployment failed"
              exit 1
            fi
            
            sleep 30
            elapsed=$((elapsed+30))
          done
          
          echo "âš ï¸ Deployment timeout"
          exit 1
      
      - name: Health check
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -f -s https://toolboxai-api.onrender.com/health)
            if [ $? -eq 0 ]; then
              echo "âœ… Health check passed: $response"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts failed, retrying..."
            sleep 30
            attempt=$((attempt+1))
          done
          
          echo "âŒ Health check failed"
          exit 1
      
      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."
          
          # Test health endpoint
          curl -f https://toolboxai-api.onrender.com/health
          
          # Test API status
          curl -f https://toolboxai-api.onrender.com/api/v1/status
          
          # Test authentication endpoint
          curl -f https://toolboxai-api.onrender.com/api/v1/auth/check
          
          echo "âœ… All smoke tests passed"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "ðŸ”„ Rolling back to previous deployment..."
          
          curl -X POST "${{ env.RENDER_API_URL }}/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "deployId": "${{ steps.current.outputs.current-deploy-id }}",
              "clearCache": false
            }'
          
          echo "âš ï¸ Rolled back to deployment: ${{ steps.current.outputs.current-deploy-id }}"
      
      - name: Post deployment summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** Backend API" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://toolboxai-api.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID:** ${{ steps.deploy.outputs.deploy-id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Smoke Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
  
  # Preview Environment (for PRs)
  deploy-preview:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” Backend Build Status\n\nâœ… Backend build completed successfully!\n\n**Note:** Render preview environments require manual configuration.\nTo test this PR:\n1. Deploy to staging first\n2. Run integration tests\n3. Review logs in Render dashboard\n\n**Build artifacts available for 7 days**`
            })
  
  # Deployment Summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Render Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Render" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deployment workflow completed" >> $GITHUB_STEP_SUMMARY
