name: ðŸ” Automated Security Audit

on:
  schedule:
    # Run daily at 8 AM UTC to check for new vulnerabilities
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      audit_scope:
        description: 'Audit scope'
        type: choice
        options: ['all', 'python-only', 'nodejs-only']
        default: 'all'
  push:
    branches: [main, develop]
    paths:
      - '**/requirements*.txt'
      - '**/package*.json'
      - '.github/workflows/security-audit.yml'

# Prevent concurrent runs
concurrency:
  group: security-audit-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18.x'

jobs:
  # ðŸ” Automated Security Audit
  security-audit:
    name: ðŸ” Comprehensive Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: read
      security-events: write
      issues: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Security Tools
        run: |
          # Python security tools
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit semgrep
          
          # Node.js security tools  
          npm install -g npm-audit-ci retire @cyclone-dx/cyclonedx-npm

      - name: ðŸ” Python Security Audit
        if: github.event.inputs.audit_scope != 'nodejs-only'
        run: |
          echo "ðŸ Running Python security audit..."
          
          # Create reports directory
          mkdir -p security_reports
          
          # Audit main requirements file
          if [ -f "src/roblox-environment/requirements-verified.txt" ]; then
            echo "ðŸ” Auditing: src/roblox-environment/requirements-verified.txt"
            pip-audit --requirement "src/roblox-environment/requirements-verified.txt" \
              --format json --output "security_reports/pip-audit-main.json" || echo "pip-audit completed with findings"
          fi
          
          # Run basic static analysis
          if [ -d "src" ]; then
            bandit -r src/ -f json -o "security_reports/bandit-src.json" --exit-zero || true
          fi

      - name: ðŸŸ¢ Node.js Security Audit
        if: github.event.inputs.audit_scope != 'python-only'
        run: |
          echo "ðŸŸ¢ Running Node.js security audit..."
          
          # Audit main package.json file
          if [ -f "package.json" ]; then
            echo "ðŸ” Auditing main package.json"
            npm audit --json > "security_reports/npm-audit-main.json" 2>/dev/null || echo "npm audit completed with findings"
          fi
          
          # Check dashboard package.json if exists
          if [ -f "src/dashboard/package.json" ]; then
            echo "ðŸ” Auditing dashboard package.json"
            cd src/dashboard
            npm audit --json > "../../security_reports/npm-audit-dashboard.json" 2>/dev/null || echo "npm audit completed with findings"
            cd ../..
          fi

      - name: ðŸ§  AI/ML Security Scan
        if: github.event.inputs.audit_scope != 'nodejs-only'
        run: |
          echo "ðŸ§  Running AI/ML specific security scan..."
          
          # Check for unsafe AI library usage patterns
          echo "ðŸ” Scanning for unsafe pickle/joblib usage..."
          grep -r "pickle.load\|joblib.load\|torch.load" --include="*.py" . > security_reports/unsafe-ai-patterns.txt || echo "No unsafe patterns found"
          
          # Check for hardcoded API keys in AI configs
          echo "ðŸ” Scanning for hardcoded API keys..."
          grep -r -E "(OPENAI_API_KEY|ANTHROPIC_API_KEY|HUGGINGFACE_API_TOKEN).*=" --include="*.py" --include="*.json" . > security_reports/hardcoded-keys.txt || echo "No hardcoded keys found"

      - name: ðŸ“Š Generate Security Report
        run: |
          echo "ðŸ“Š Generating comprehensive security report..."
          
          # Run our custom security audit script
          chmod +x scripts/security_audit.sh
          ./scripts/security_audit.sh || echo "Security audit completed with findings"

      - name: ðŸš¨ Process Security Findings
        id: security-findings
        run: |
          echo "ðŸš¨ Processing security findings..."
          
          # Count findings across all reports
          critical_count=0
          high_count=0
          medium_count=0
          
          # Process pip-audit findings
          for file in security_reports/pip-audit-*.json; do
            if [ -f "$file" ]; then
              vuln_count=$(jq '.vulnerabilities | length' "$file" 2>/dev/null || echo "0")
              critical_count=$((critical_count + vuln_count))
            fi
          done
          
          # Process npm audit findings
          for file in security_reports/npm-audit-*.json; do
            if [ -f "$file" ]; then
              vuln_count=$(jq '.metadata.vulnerabilities.total' "$file" 2>/dev/null || echo "0")
              high_count=$((high_count + vuln_count))
            fi
          done
          
          # Set outputs
          echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
          echo "high_count=$high_count" >> $GITHUB_OUTPUT
          echo "medium_count=$medium_count" >> $GITHUB_OUTPUT
          
          total_count=$((critical_count + high_count + medium_count))
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
          
          if [ $total_count -gt 0 ]; then
            echo "has_findings=true" >> $GITHUB_OUTPUT
          else
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Ž Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports-${{ github.run_number }}
          path: |
            security_reports/
            *.md
          retention-days: 30

      - name: ðŸ“ Update Security Dashboard
        if: steps.security-findings.outputs.has_findings == 'true'
        run: |
          echo "ðŸ“ Updating security dashboard..."
          
          # Create GitHub issue with security findings
          cat > security-issue.md << EOF
          ## ðŸš¨ Security Audit Findings - $(date)
          
          **Audit Run**: ${{ github.run_number }}  
          **Branch**: ${{ github.ref_name }}  
          **Commit**: ${{ github.sha }}
          
          ### ðŸ“Š Findings Summary
          
          | Severity | Count |
          |----------|-------|
          | Critical | ${{ steps.security-findings.outputs.critical_count }} |
          | High | ${{ steps.security-findings.outputs.high_count }} |
          | Medium | ${{ steps.security-findings.outputs.medium_count }} |
          | **Total** | **${{ steps.security-findings.outputs.total_count }}** |
          
          ### ðŸ”§ Recommended Actions
          
          1. **Critical Issues**: Address immediately (within 24 hours)
          2. **High Issues**: Plan fixes within 1 week
          3. **Medium Issues**: Include in next maintenance cycle
          
          ### ðŸ“ Detailed Reports
          
          Detailed security reports are available in the workflow artifacts:
          - **pip-audit reports**: Python dependency vulnerabilities
          - **npm audit reports**: Node.js dependency vulnerabilities  
          - **Bandit reports**: Python code security issues
          - **Custom scans**: AI/ML specific security patterns
          
          ### ðŸ“ž Support
          
          - **Security Team**: security@toolboxai.example.com
          - **Documentation**: See \`SECURITY_REMEDIATION_REPORT.md\`
          - **Workflow**: [${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          *Automated Security Audit - Generated by GitHub Actions*
          EOF
          
          echo "security_issue_body<<EOF" >> $GITHUB_ENV
          cat security-issue.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ðŸš¨ Create Security Issue
        if: steps.security-findings.outputs.has_findings == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Security Audit Alert - ${new Date().toISOString().split('T')[0]} - ${{ steps.security-findings.outputs.total_count }} Issues`;
            
            // Check if there's already an open security audit issue today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-audit,automated',
              per_page: 100
            });
            
            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Security Audit Alert') && 
              issue.title.includes(today)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: process.env.security_issue_body,
                labels: ['security', 'security-audit', 'automated', 'high-priority']
              });
            } else {
              // Update existing issue with latest findings
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Updated Findings\n\n${process.env.security_issue_body}`
              });
            }

      - name: ðŸ’¬ Slack Notification
        if: steps.security-findings.outputs.has_findings == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            // This would send a Slack notification if webhook is configured
            console.log('ðŸš¨ Security findings detected - manual Slack notification recommended');
            console.log('Critical:', '${{ steps.security-findings.outputs.critical_count }}');
            console.log('High:', '${{ steps.security-findings.outputs.high_count }}');
            console.log('Medium:', '${{ steps.security-findings.outputs.medium_count }}');

      - name: ðŸ“‹ Security Audit Summary
        if: always()
        run: |
          echo "## ðŸ” Security Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Scope**: ${{ github.event.inputs.audit_scope || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Findings Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | ${{ steps.security-findings.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | ${{ steps.security-findings.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | ${{ steps.security-findings.outputs.medium_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.security-findings.outputs.total_count }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.security-findings.outputs.total_count }}" -eq 0 ]; then
            echo "âœ… **Status**: No security vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status**: Security vulnerabilities require attention" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review detailed reports in workflow artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. Address critical and high-severity issues immediately" >> $GITHUB_STEP_SUMMARY
            echo "3. Update vulnerable dependencies using the remediation guide" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ Fail on Critical Vulnerabilities
        if: steps.security-findings.outputs.critical_count > 0
        run: |
          echo "ðŸš¨ CRITICAL SECURITY VULNERABILITIES DETECTED"
          echo "Critical vulnerabilities found: ${{ steps.security-findings.outputs.critical_count }}"
          echo "This workflow will fail to alert the team of critical security issues."
          echo ""
          echo "IMMEDIATE ACTION REQUIRED:"
          echo "1. Review the security reports in workflow artifacts"
          echo "2. Update vulnerable dependencies immediately"
          echo "3. Follow the security remediation procedures"
          echo ""
          exit 1