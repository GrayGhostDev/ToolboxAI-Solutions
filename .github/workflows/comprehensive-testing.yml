name: Comprehensive Testing Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20.11.0'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'

jobs:
  # ============================================
  # Security Scanning
  # ============================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2
        continue-on-error: true
        with:
          config-path: .gitsecrets

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Python Security Check with Bandit
        run: |
          pip install bandit
          bandit -r apps/ core/ -f json -o bandit-report.json || true

      - name: Check for Exposed Secrets
        continue-on-error: true
        run: |
          pip install detect-secrets
          if [ -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline
          else
            echo "No secrets baseline found, skipping..."
          fi

  # ============================================
  # Backend Testing (Python)
  # ============================================
  backend-tests:
    name: Backend Tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov pytest-xdist pytest-timeout

      - name: Run Unit Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET_KEY: test-secret-key
          TESTING: true
          USE_MOCK_LLM: true
        run: |
          if [ -d tests/unit ]; then
            pytest tests/unit/ \
              -v \
              --cov=apps \
              --cov=core \
              --cov-report=xml \
              --cov-report=html \
              --junit-xml=test-results/unit-tests.xml \
              -n auto || echo "Unit tests completed with issues"
          else
            echo "No unit tests found, skipping..."
          fi
        continue-on-error: true

      - name: Run Integration Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
        run: |
          if [ -d tests/integration ]; then
            pytest tests/integration/ \
              -v \
              --junit-xml=test-results/integration-tests.xml \
              -m "not slow" || echo "Integration tests completed with issues"
          else
            echo "No integration tests found, skipping..."
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: test-results/

  # ============================================
  # Frontend Testing (React/TypeScript)
  # ============================================
  frontend-tests:
    name: Frontend Tests - Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18.x', '20.x']
      fail-fast: false

    steps:
      - uses: actions/checkout@v5

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: apps/dashboard
        run: npm ci

      - name: Run linting
        working-directory: apps/dashboard
        continue-on-error: true
        run: npm run lint

      - name: Run type checking
        working-directory: apps/dashboard
        continue-on-error: true
        run: npm run typecheck

      - name: Run unit tests with coverage
        working-directory: apps/dashboard
        run: |
          npm run test -- \
            --reporter=json \
            --outputFile=../../test-results/frontend-tests.json || echo "Tests completed with issues"
        continue-on-error: true

      - name: Check coverage thresholds
        working-directory: apps/dashboard
        continue-on-error: true
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 90" | bc -l) )); then
              echo "⚠️ Coverage $COVERAGE% is below 90% threshold"
            else
              echo "✅ Coverage $COVERAGE% meets threshold"
            fi
          else
            echo "⚠️ No coverage summary found"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: apps/dashboard/coverage
          flags: frontend
          name: frontend-coverage

  # ============================================
  # E2E Testing with Playwright
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        run: |
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: apps/dashboard
        run: npm ci

      - name: Install Playwright
        run: |
          npm install -g playwright
          playwright install chromium

      - name: Start backend server
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd apps/backend
          uvicorn main:app --host 0.0.0.0 --port 8009 &
          sleep 5

      - name: Start frontend server
        working-directory: apps/dashboard
        run: |
          npm run build
          npm run preview &
          sleep 5

      - name: Run E2E tests
        run: |
          playwright test tests/e2e/ \
            --reporter=html \
            --output=test-results/e2e/

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/e2e/

  # ============================================
  # Performance Testing with k6
  # ============================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v5

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Start test environment
        run: |
          docker-compose -f infrastructure/docker/docker-compose.dev.yml up -d
          sleep 30  # Wait for services to be ready

      - name: Run k6 load tests
        run: |
          k6 run tests/performance/load-test.js \
            --out json=test-results/k6-results.json

      - name: Check performance thresholds
        run: |
          # Parse k6 results and check thresholds
          python scripts/check_performance_thresholds.py test-results/k6-results.json

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: test-results/k6-results.json

  # ============================================
  # OWASP Security Testing
  # ============================================
  owasp-security-tests:
    name: OWASP Security Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[security]')

    steps:
      - uses: actions/checkout@v5

      - name: Run OWASP ZAP Security Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:8009'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -m 10 -T 60'
          issue_title: 'OWASP ZAP Security Report'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'ToolBoxAI'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental

      - name: Upload OWASP results
        uses: actions/upload-artifact@v4
        with:
          name: owasp-security-results
          path: |
            **/dependency-check-report.*
            **/zap-report.*

  # ============================================
  # Quality Gates
  # ============================================
  quality-gates:
    name: Quality Gates Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]
    if: always()

    steps:
      - uses: actions/checkout@v5

      - name: Download all test results
        uses: actions/download-artifact@v4

      - name: Check Quality Gates
        run: |
          echo "Checking quality gates..."

          # Check backend coverage
          BACKEND_COV=$(cat backend-test-results/coverage.xml | grep -oP 'line-rate="\K[^"]+' | head -1)
          BACKEND_PCT=$(echo "$BACKEND_COV * 100" | bc -l | cut -d. -f1)
          echo "Backend coverage: $BACKEND_PCT%"
          if [ $BACKEND_PCT -lt 90 ]; then
            echo "❌ Backend coverage below 90% threshold"
            exit 1
          fi

          # Check frontend coverage
          FRONTEND_COV=$(cat frontend-test-results/coverage-summary.json | jq '.total.lines.pct')
          echo "Frontend coverage: $FRONTEND_COV%"
          if (( $(echo "$FRONTEND_COV < 90" | bc -l) )); then
            echo "❌ Frontend coverage below 90% threshold"
            exit 1
          fi

          # Check security scan results
          if [ -f "bandit-report.json" ]; then
            HIGH_SEVERITY=$(cat bandit-report.json | jq '[.results[] | select(.issue_severity=="HIGH")] | length')
            if [ $HIGH_SEVERITY -gt 0 ]; then
              echo "❌ Found $HIGH_SEVERITY high severity security issues"
              exit 1
            fi
          fi

          echo "✅ All quality gates passed!"

  # ============================================
  # Deploy to Staging (if all tests pass)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-gates, e2e-tests]
    if: github.ref == 'refs/heads/main' && success()
    environment: staging

    steps:
      - uses: actions/checkout@v5

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment commands here