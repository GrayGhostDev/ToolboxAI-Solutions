name: Documentation Health Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'scripts/documentation/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'scripts/documentation/**'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  documentation-health:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Enforce documentation placement
      run: make docs-enforce

    - name: Verify dashboard hygiene
      run: make dashboard-hygiene

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml gitpython

    - name: Install Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'

    - name: Install markdownlint
      run: npm install -g markdownlint-cli

    - name: Validate documentation structure
      id: structure
      run: |
        python scripts/documentation/validate-structure.py
        echo "structure_exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Check link validity
      id: links
      run: |
        python scripts/documentation/check-links.py
        echo "links_exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Check documentation coverage
      id: coverage
      run: |
        python scripts/documentation/check-coverage.py
        echo "coverage_exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Run markdownlint
      id: markdownlint
      run: |
        markdownlint docs/**/*.md
        echo "markdownlint_exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Generate health metrics
      id: health
      run: |
        python scripts/documentation/health-metrics.py
        echo "health_exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Upload health reports
      uses: actions/upload-artifact@v5
      with:
        name: documentation-health-reports
        path: docs/10-reports/
        retention-days: 30

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Find the latest health report
          const reportsDir = 'docs/10-reports';
          const files = fs.readdirSync(reportsDir).filter(f => f.startsWith('health-metrics-'));

          if (files.length > 0) {
            const latestReport = files.sort().pop();
            const reportPath = path.join(reportsDir, latestReport);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const overall = report.overall_health;
            const metrics = report.metrics;

            const comment = `## Documentation Health Report ðŸ“Š

            **Overall Health:** ${overall.overall_score}/100 (${overall.overall_grade})

            ### Component Scores:
            - **Coverage:** ${metrics.coverage.score}/100 (${metrics.coverage.grade})
            - **Link Validity:** ${metrics.link_validity.score}/100 (${metrics.link_validity.grade})
            - **Structure:** ${metrics.structure_compliance.score}/100 (${metrics.structure_compliance.grade})
            - **Freshness:** ${metrics.freshness.score}/100 (${metrics.freshness.grade})

            ### Recommendations:
            ${report.recommendations.map(rec => `- ${rec}`).join('\n')}

            ${overall.improvement_priority.length > 0 ?
              `### Priority Areas:\n${overall.improvement_priority.map(area => `- ${area.replace('_', ' ')}`).join('\n')}` :
              'âœ… All areas are performing well!'}

            *Report generated at ${report.timestamp}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Check overall status
      run: |
        structure_code=${{ steps.structure.outputs.structure_exit_code }}
        links_code=${{ steps.links.outputs.links_exit_code }}
        coverage_code=${{ steps.coverage.outputs.coverage_exit_code }}
        health_code=${{ steps.health.outputs.health_exit_code }}

        echo "Structure validation: $structure_code"
        echo "Link checking: $links_code"
        echo "Coverage check: $coverage_code"
        echo "Health metrics: $health_code"

        # Fail if critical checks failed
        if [ "$structure_code" -ne 0 ] || [ "$links_code" -ne 0 ]; then
          echo "Critical documentation issues found!"
          exit 1
        fi

        # Warn if health is poor
        if [ "$health_code" -eq 2 ]; then
          echo "Documentation health is poor but not failing the build"
          exit 0
        fi

  update-indexes:
    runs-on: ubuntu-latest
    needs: documentation-health
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Generate documentation indexes
      run: python scripts/documentation/generate-index.py

    - name: Commit updated indexes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/**/README.md
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "docs: Update documentation indexes [skip ci]"
          git push
        fi
