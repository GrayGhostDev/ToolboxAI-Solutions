version: '3.8'

services:
  # PostgreSQL 16 - Primary Database
  postgres16:
    image: postgres:16-alpine
    container_name: toolboxai-postgres16-staging
    environment:
      POSTGRES_DB: toolboxai_staging
      POSTGRES_USER: toolboxai_user
      POSTGRES_PASSWORD: staging_pg16_password_2024
      POSTGRES_INITDB_ARGS: "--auth-host=md5"
    volumes:
      - postgres16_data:/var/lib/postgresql/data
      - ./configs/postgresql16_staging.conf:/etc/postgresql/postgresql.conf
      - ./configs/pg_hba_staging.conf:/var/lib/postgresql/data/pg_hba.conf
      - ./database/migrations:/docker-entrypoint-initdb.d
      - ./backups:/backups
    ports:
      - "5432:5432"
    networks:
      - backend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U toolboxai_user -d toolboxai_staging"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      bash -c "
        if [ ! -f /var/lib/postgresql/data/postgresql.conf ]; then
          cp /etc/postgresql/postgresql.conf /var/lib/postgresql/data/postgresql.conf
        fi &&
        docker-entrypoint.sh postgres -c config_file=/var/lib/postgresql/data/postgresql.conf
      "

  # PostgreSQL 15 - Legacy (for migration testing)
  postgres15:
    image: postgres:15-alpine
    container_name: toolboxai-postgres15-staging
    environment:
      POSTGRES_DB: toolboxai_staging_old
      POSTGRES_USER: toolboxai_user
      POSTGRES_PASSWORD: staging_password_2024
    volumes:
      - postgres15_data:/var/lib/postgresql/data
      - ./database/legacy_data:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U toolboxai_user -d toolboxai_staging_old"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis 7 - Cache and Session Store
  redis7:
    image: redis:7-alpine
    container_name: toolboxai-redis7-staging
    command: >
      redis-server
      --requirepass staging_redis7_password_2024
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
    volumes:
      - redis7_data:/data
      - ./configs/redis7_staging.conf:/usr/local/etc/redis/redis.conf
      - ./configs/redis7_acl_staging.conf:/usr/local/etc/redis/users.acl
    ports:
      - "6379:6379"
    networks:
      - backend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    sysctls:
      - net.core.somaxconn=1024

  # PgBouncer - Connection Pooling
  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: toolboxai-pgbouncer-staging
    environment:
      DATABASES_HOST: postgres16
      DATABASES_PORT: 5432
      DATABASES_USER: toolboxai_user
      DATABASES_PASSWORD: staging_pg16_password_2024
      DATABASES_DBNAME: toolboxai_staging
      POOL_MODE: transaction
      LISTEN_PORT: 6432
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 100
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 10
      SERVER_LIFETIME: 3600
      SERVER_IDLE_TIMEOUT: 600
    volumes:
      - ./configs/pgbouncer_staging.ini:/etc/pgbouncer/pgbouncer.ini
    ports:
      - "6432:6432"
    networks:
      - backend
      - monitoring
    depends_on:
      postgres16:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "psql", "-h", "localhost", "-p", "6432", "-U", "toolboxai_user", "-c", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Application Backend
  backend:
    build:
      context: .
      dockerfile: infrastructure/docker/backend.Dockerfile
      args:
        ENVIRONMENT: staging
    container_name: toolboxai-backend-staging
    environment:
      - ENVIRONMENT=staging
    env_file:
      - .env.staging
    volumes:
      - ./apps/backend:/app
      - ./logs:/app/logs
      - ./backups:/app/backups
      - ./uploads:/app/uploads
    ports:
      - "8000:8000"
    networks:
      - backend
      - monitoring
    depends_on:
      postgres16:
        condition: service_healthy
      redis7:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      bash -c "
        echo 'Waiting for database migration...' &&
        python -m alembic upgrade head &&
        echo 'Starting FastAPI server...' &&
        uvicorn core.main:app --host 0.0.0.0 --port 8000 --reload
      "

  # Frontend Dashboard
  frontend:
    build:
      context: .
      dockerfile: infrastructure/docker/dashboard.Dockerfile
      args:
        ENVIRONMENT: staging
    container_name: toolboxai-frontend-staging
    environment:
      - NODE_ENV=staging
      - VITE_API_URL=http://backend:8000
      - VITE_WS_URL=ws://backend:8000
    volumes:
      - ./apps/dashboard:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    networks:
      - backend
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: toolboxai-nginx-staging
    volumes:
      - ./configs/nginx_staging.conf:/etc/nginx/nginx.conf
      - ./logs/nginx:/var/log/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - backend
      - monitoring
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Migration Runner
  migration-runner:
    build:
      context: .
      dockerfile: infrastructure/docker/backend.Dockerfile
    container_name: toolboxai-migration-staging
    environment:
      - ENVIRONMENT=staging
    env_file:
      - .env.staging
    volumes:
      - ./scripts:/scripts
      - ./backups:/backups
      - ./logs:/logs
    networks:
      - backend
    depends_on:
      postgres15:
        condition: service_healthy
      postgres16:
        condition: service_healthy
    restart: "no"
    command: >
      bash -c "
        echo 'Starting PostgreSQL 16 migration...' &&
        /scripts/postgres16_migration.sh --staging &&
        echo 'Migration completed successfully!'
      "

  # Health Check Service
  health-checker:
    image: alpine:latest
    container_name: toolboxai-health-checker-staging
    environment:
      - CHECK_INTERVAL=60
    volumes:
      - ./scripts/health_checks:/scripts
    networks:
      - backend
      - monitoring
    depends_on:
      - postgres16
      - redis7
      - backend
    restart: unless-stopped
    command: >
      sh -c "
        apk add --no-cache curl postgresql-client redis &&
        while true; do
          /scripts/run_health_checks.sh staging
          sleep \$CHECK_INTERVAL
        done
      "

volumes:
  postgres16_data:
    driver: local
  postgres15_data:
    driver: local
  redis7_data:
    driver: local

networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  monitoring:
    external: true