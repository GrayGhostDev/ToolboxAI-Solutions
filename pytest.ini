[pytest]
# Pytest configuration following 2025 best practices

# Test discovery patterns
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Markers for test categorization (2025 pattern)
markers =
    unit: Unit tests - fast, isolated tests
    integration: Integration tests - test component interactions
    e2e: End-to-end tests - full system tests
    performance: Performance tests - benchmarking and optimization
    slow: Slow tests (>5s) that should be run separately
    asyncio: Async tests (auto-applied by pytest-asyncio in auto mode)
    langgraph: LangGraph workflow tests
    langchain: LangChain agent tests
    database: Database-related tests
    api: API endpoint tests
    websocket: WebSocket and realtime tests
    pusher: Pusher channel tests
    skip_in_ci: Skip in CI/CD pipeline
    requires_redis: Tests requiring Redis connection
    requires_postgres: Tests requiring PostgreSQL connection
    requires_openai: Tests requiring OpenAI API key
    xdist_group: Group tests for xdist execution

# Asyncio configuration (2025 best practices for pytest-asyncio 0.24+)
asyncio_mode = auto
# Use session scope to prevent "event loop already running" errors
asyncio_default_fixture_loop_scope = session

# Logging configuration (optimized for performance)
log_cli = false
log_cli_level = WARNING
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %H:%M:%S
# Log file configuration - disabled by default to avoid file handle issues
# Uncomment to enable file logging when needed
# log_file = tests/logs/pytest_run.log
# log_file_level = INFO
# log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)d] %(message)s
# log_file_date_format = %Y-%m-%d %H:%M:%S
# Disable log capture during successful tests for better performance
log_capture = false
log_level = WARNING

# JUnit XML for CI/CD
junit_family = xunit2
junit_logging = all
junit_log_passing_tests = true

# Command line options (optimized for performance)
addopts =
    -q
    --tb=short
    --strict-markers
    --disable-warnings
    --timeout=30
    --timeout-method=thread
    -p no:unraisableexception
    -p no:cacheprovider
    # Disable junit report by default (use --junitxml option when needed)
    # --junitxml=tests/logs/junit_report.xml
    # Optional for parallel execution (uncomment to enable)
    # -n auto
    # --dist loadfile

# Timeout configuration (increased for integration tests)
timeout = 30
timeout_method = thread
faulthandler_timeout = 0
timeout_func_only = False

# Coverage configuration (if using pytest-cov)
# --cov=core --cov=apps
# --cov=apps/backend
# --cov-report=term-missing
# --cov-report=html

# Ignore warnings from dependencies (2025 pattern)
filterwarnings =
    ignore::DeprecationWarning:sqlalchemy.*
    ignore::DeprecationWarning:pydantic.*
    ignore::PendingDeprecationWarning
    ignore::ResourceWarning

# Console output style
console_output_style = progress

# Doctest configuration
doctest_optionflags = NORMALIZE_WHITESPACE IGNORE_EXCEPTION_DETAIL

# Cache configuration
cache_dir = .pytest_cache
