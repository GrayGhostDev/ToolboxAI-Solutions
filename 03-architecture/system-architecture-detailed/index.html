<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Comprehensive documentation for the ToolBoxAI educational platform with AI-powered content generation and Roblox integration" name="description"/><meta content="ToolBoxAI Team" name="author"/><link href="https://docs.toolboxai.com/03-architecture/system-architecture-detailed/" rel="canonical"/><link href="../../images/favicon.png" rel="icon"/><meta content="mkdocs-1.6.1, mkdocs-material-9.6.21" name="generator"/><title>Detailed System Architecture - ToolBoxAI Solutions Documentation</title><link href="../../assets/stylesheets/main.2a3383ac.min.css" rel="stylesheet"/><link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href="../../css/timeago.css" rel="stylesheet"/><link href="../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#detailed-system-architecture"> Skip to content </a> </div> <div data-md-component="announce"> </div> <div data-md-color-scheme="default" data-md-component="outdated" hidden=""> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../images/logo.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> ToolBoxAI Solutions Documentation </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Detailed System Architecture </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0"> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> </nav> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../01-overview/README.md"> Getting Started </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../02-architecture/README.md"> Architecture </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../03-api/README.md"> API Documentation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../04-implementation/README.md"> Implementation </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../05-features/README.md"> Features </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../06-user-guides/README.md"> User Guides </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../07-operations/README.md"> Operations </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../08-reference/README.md"> Reference </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../09-meta/README.md"> Meta </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../10-reports/README.md"> Reports </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../11-sdks/README.md"> SDKs </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../phase2/"> Phase 2 (Current) </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> Audit &amp; Reports </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="ToolBoxAI Solutions Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="ToolBoxAI Solutions Documentation"> <img alt="logo" src="../../images/logo.png"/> </a> ToolBoxAI Solutions Documentation </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/ToolBoxAI-Solutions/toolboxai" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> ToolBoxAI-Solutions/toolboxai </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../.."> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../01-overview/README.md"> <span class="md-ellipsis"> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../02-architecture/README.md"> <span class="md-ellipsis"> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../03-api/README.md"> <span class="md-ellipsis"> API Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../04-implementation/README.md"> <span class="md-ellipsis"> Implementation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../05-features/README.md"> <span class="md-ellipsis"> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../06-user-guides/README.md"> <span class="md-ellipsis"> User Guides </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../07-operations/README.md"> <span class="md-ellipsis"> Operations </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../08-reference/README.md"> <span class="md-ellipsis"> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../09-meta/README.md"> <span class="md-ellipsis"> Meta </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../10-reports/README.md"> <span class="md-ellipsis"> Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../11-sdks/README.md"> <span class="md-ellipsis"> SDKs </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../phase2/"> <span class="md-ellipsis"> Phase 2 (Current) </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a class="md-nav__link" href="../../DOCUMENTATION_AUDIT_REPORT_2025-10-01/"> <span class="md-ellipsis"> Audit &amp; Reports </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/edit/main/docs/03-architecture/system-architecture-detailed.md" rel="edit" title="Edit this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a class="md-content__button md-icon" href="https://github.com/ToolBoxAI-Solutions/toolboxai/raw/main/docs/03-architecture/system-architecture-detailed.md" title="View source of this page"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id="detailed-system-architecture">Detailed System Architecture<a class="headerlink" href="#detailed-system-architecture" title="Permanent link">¶</a></h1> <p>This document provides an in-depth technical analysis of the ToolBoxAI Solutions architecture, covering system components, data flow, integration patterns, and scalability considerations.</p> <h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">¶</a></h2> <ol> <li><a href="#architecture-overview">Architecture Overview</a></li> <li><a href="#component-architecture">Component Architecture</a></li> <li><a href="#data-architecture">Data Architecture</a></li> <li><a href="#integration-architecture">Integration Architecture</a></li> <li><a href="#ai-agent-system-architecture">AI Agent System Architecture</a></li> <li><a href="#security-architecture">Security Architecture</a></li> <li><a href="#scalability-and-performance">Scalability and Performance</a></li> <li><a href="#deployment-architecture">Deployment Architecture</a></li> </ol> <h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">¶</a></h2> <h3 id="system-context-diagram">System Context Diagram<a class="headerlink" href="#system-context-diagram" title="Permanent link">¶</a></h3> <pre class="mermaid"><code>graph TB
    subgraph "External Users"
        T[Teachers]
        S[Students]
        A[Administrators]
        P[Parents]
    end

    subgraph "External Systems"
        R[Roblox Platform]
        LMS[Learning Management Systems]
        AI[AI Services - Claude/OpenAI]
        EMAIL[Email Services]
        PUSH[Pusher Channels]
    end

    subgraph "ToolBoxAI Platform"
        WEB[Web Application]
        API[FastAPI Backend]
        DB[(PostgreSQL)]
        CACHE[(Redis)]
        AGENTS[AI Agent System]
    end

    T --&gt; WEB
    S --&gt; WEB
    A --&gt; WEB
    P --&gt; WEB

    WEB --&gt; API
    API --&gt; DB
    API --&gt; CACHE
    API --&gt; AGENTS

    AGENTS --&gt; AI
    API --&gt; R
    API --&gt; LMS
    API --&gt; EMAIL
    WEB --&gt; PUSH</code></pre> <h3 id="high-level-architecture-principles">High-Level Architecture Principles<a class="headerlink" href="#high-level-architecture-principles" title="Permanent link">¶</a></h3> <h4 id="design-philosophy">Design Philosophy<a class="headerlink" href="#design-philosophy" title="Permanent link">¶</a></h4> <ul> <li><strong>Microservices-Ready</strong>: Modular design enabling future service decomposition</li> <li><strong>Event-Driven</strong>: Asynchronous processing for better user experience</li> <li><strong>AI-First</strong>: Built around AI capabilities with human oversight</li> <li><strong>Educational Focus</strong>: Purpose-built for educational workflows and compliance</li> <li><strong>Scalable Foundation</strong>: Architecture supports growth from classrooms to districts</li> </ul> <h4 id="key-architectural-patterns">Key Architectural Patterns<a class="headerlink" href="#key-architectural-patterns" title="Permanent link">¶</a></h4> <ul> <li><strong>CQRS (Command Query Responsibility Segregation)</strong>: Separate read and write operations</li> <li><strong>Event Sourcing</strong>: Track state changes for audit and replay capabilities</li> <li><strong>Repository Pattern</strong>: Abstract data access layer</li> <li><strong>Dependency Injection</strong>: Loose coupling and testability</li> <li><strong>Circuit Breaker</strong>: Resilience for external service calls</li> </ul> <h2 id="component-architecture">Component Architecture<a class="headerlink" href="#component-architecture" title="Permanent link">¶</a></h2> <h3 id="frontend-architecture-react-dashboard">Frontend Architecture (React Dashboard)<a class="headerlink" href="#frontend-architecture-react-dashboard" title="Permanent link">¶</a></h3> <h4 id="component-hierarchy">Component Hierarchy<a class="headerlink" href="#component-hierarchy" title="Permanent link">¶</a></h4> <div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>App
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>├── AuthProvider
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>│   ├── Router
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>│   │   ├── PublicRoutes
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>│   │   │   ├── Login
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>│   │   │   ├── Register
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>│   │   │   └── ForgotPassword
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>│   │   └── ProtectedRoutes
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>│   │       ├── DashboardLayout
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>│   │       │   ├── Header
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>│   │       │   ├── Sidebar
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>│   │       │   └── MainContent
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>│   │       ├── TeacherRoutes
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>│   │       │   ├── ContentCreator
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>│   │       │   ├── ClassManagement
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>│   │       │   └── Analytics
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>│   │       ├── StudentRoutes
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>│   │       │   ├── LessonBrowser
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>│   │       │   ├── ProgressTracker
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>│   │       │   └── Achievements
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>│   │       └── AdminRoutes
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>│   │           ├── UserManagement
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>│   │           ├── SystemConfig
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>│   │           └── SystemMonitoring
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>└── GlobalProviders
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>    ├── ThemeProvider
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>    ├── QueryProvider
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>    ├── NotificationProvider
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>    └── PusherProvider
</span></code></pre></div> <h4 id="state-management-architecture">State Management Architecture<a class="headerlink" href="#state-management-architecture" title="Permanent link">¶</a></h4> <div class="language-typescript highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// Redux Store Structure</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">RootState</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">User</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nx">isAuthenticated</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="nx">loading</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="nx">ui</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nx">theme</span><span class="o">:</span><span class="w"> </span><span class="s1">'light'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">'dark'</span><span class="p">;</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="nx">sidebar</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="nx">isOpen</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="nx">activeSection</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nx">notifications</span><span class="o">:</span><span class="w"> </span><span class="kt">Notification</span><span class="p">[];</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nx">lessons</span><span class="o">:</span><span class="w"> </span><span class="kt">Lesson</span><span class="p">[];</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nx">currentLesson</span><span class="o">:</span><span class="w"> </span><span class="kt">Lesson</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="nx">generationStatus</span><span class="o">:</span><span class="w"> </span><span class="kt">GenerationStatus</span><span class="p">;</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="nx">classes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="nx">userClasses</span><span class="o">:</span><span class="w"> </span><span class="kt">Class</span><span class="p">[];</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="nx">currentClass</span><span class="o">:</span><span class="w"> </span><span class="kt">Class</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="nx">students</span><span class="o">:</span><span class="w"> </span><span class="kt">Student</span><span class="p">[];</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="nx">realtime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="nx">channels</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">    </span><span class="nx">lastUpdate</span><span class="o">:</span><span class="w"> </span><span class="kt">timestamp</span><span class="p">;</span>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="p">}</span>
</span></code></pre></div> <h4 id="component-design-patterns">Component Design Patterns<a class="headerlink" href="#component-design-patterns" title="Permanent link">¶</a></h4> <p><strong>Higher-Order Components (HOCs)</strong>: <div class="language-typescript highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// withAuth HOC for protected routes</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">withAuth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">P</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nx">Component</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ComponentType</span><span class="o">&lt;</span><span class="nx">P</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nx">requiredRole?</span><span class="o">:</span><span class="w"> </span><span class="kt">UserRole</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kt">P</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">isAuthenticated</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useAuth</span><span class="p">();</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAuthenticated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Navigate</span><span class="w"> </span><span class="nx">to</span><span class="o">=</span><span class="s2">"/login"</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">requiredRole</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">requiredRole</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">AccessDenied</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Component</span><span class="w"> </span><span class="p">{...</span><span class="nx">props</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="p">};</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="c1">// withErrorBoundary HOC for error handling</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">withErrorBoundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">P</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">  </span><span class="nx">Component</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ComponentType</span><span class="o">&lt;</span><span class="nx">P</span><span class="o">&gt;</span>
</span><span id="__span-2-24"><a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-25"><a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kt">P</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-26"><a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">ErrorBoundary</span><span class="o">&gt;</span>
</span><span id="__span-2-27"><a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">Component</span><span class="w"> </span><span class="p">{...</span><span class="nx">props</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span>
</span><span id="__span-2-28"><a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/ErrorBoundary&gt;</span>
</span><span id="__span-2-29"><a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-2-30"><a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="p">};</span>
</span></code></pre></div></p> <p><strong>Custom Hooks Pattern</strong>: <div class="language-typescript highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">// useRealtime hook for Pusher integration</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useRealtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">channels</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">connected</span><span class="p">,</span><span class="w"> </span><span class="nx">setConnected</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">lastUpdate</span><span class="p">,</span><span class="w"> </span><span class="nx">setLastUpdate</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nb">Date</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pusher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Pusher</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pusher</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">      </span><span class="nx">cluster</span><span class="o">:</span><span class="w"> </span><span class="kt">config.pusher.cluster</span><span class="p">,</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">      </span><span class="nx">authEndpoint</span><span class="o">:</span><span class="w"> </span><span class="s1">'/api/v1/pusher/auth'</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nx">channels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">channelName</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">channelName</span><span class="p">);</span>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="nx">channel</span><span class="p">.</span><span class="nx">bind_global</span><span class="p">((</span><span class="nx">eventName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-15"><a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="nx">setLastUpdate</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">());</span>
</span><span id="__span-3-16"><a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">        </span><span class="c1">// Handle event based on type</span>
</span><span id="__span-3-17"><a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-3-18"><a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-3-19"><a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>
</span><span id="__span-3-20"><a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="nx">setConnected</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-3-21"><a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>
</span><span id="__span-3-22"><a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-23"><a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">      </span><span class="nx">pusher</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span id="__span-3-24"><a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">      </span><span class="nx">setConnected</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-3-25"><a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-3-26"><a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">channels</span><span class="p">]);</span>
</span><span id="__span-3-27"><a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>
</span><span id="__span-3-28"><a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">connected</span><span class="p">,</span><span class="w"> </span><span class="nx">lastUpdate</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-3-29"><a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="p">};</span>
</span></code></pre></div></p> <h3 id="backend-architecture-fastapi">Backend Architecture (FastAPI)<a class="headerlink" href="#backend-architecture-fastapi" title="Permanent link">¶</a></h3> <h4 id="application-structure">Application Structure<a class="headerlink" href="#application-structure" title="Permanent link">¶</a></h4> <div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>apps/backend/
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>├── main.py                    # Application entry point
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>├── api/                       # API layer
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>│   ├── v1/                   # API version 1
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>│   │   ├── endpoints/        # API endpoints
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>│   │   └── dependencies.py   # Shared dependencies
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>│   └── middleware/           # Custom middleware
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>├── core/                     # Core business logic
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>│   ├── auth/                 # Authentication
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>│   ├── config/               # Configuration
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>│   ├── database/             # Database utilities
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>│   └── exceptions/           # Custom exceptions
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>├── models/                   # Data models
</span><span id="__span-4-14"><a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>│   ├── database/             # SQLAlchemy models
</span><span id="__span-4-15"><a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>│   └── schemas/              # Pydantic schemas
</span><span id="__span-4-16"><a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>├── services/                 # Business services
</span><span id="__span-4-17"><a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>│   ├── user_service.py
</span><span id="__span-4-18"><a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>│   ├── content_service.py
</span><span id="__span-4-19"><a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>│   └── ai_service.py
</span><span id="__span-4-20"><a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>└── utils/                    # Utility functions
</span></code></pre></div> <h4 id="dependency-injection-system">Dependency Injection System<a class="headerlink" href="#dependency-injection-system" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># Dependency injection container</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Container</span><span class="p">:</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_singletons</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_transient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">implementation</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">        </span><span class="sd">"""Register a transient service (new instance each time)."""</span>
</span><span id="__span-5-9"><a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="n">interface</span><span class="p">]</span> <span class="o">=</span> <span class="n">implementation</span>
</span><span id="__span-5-10"><a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>
</span><span id="__span-5-11"><a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_singleton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">implementation</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-5-12"><a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="sd">"""Register a singleton service (same instance always)."""</span>
</span><span id="__span-5-13"><a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_singletons</span><span class="p">[</span><span class="n">interface</span><span class="p">]</span> <span class="o">=</span> <span class="n">implementation</span>
</span><span id="__span-5-14"><a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>
</span><span id="__span-5-15"><a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="__span-5-16"><a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">        </span><span class="sd">"""Resolve a service instance."""</span>
</span><span id="__span-5-17"><a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>        <span class="k">if</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_singletons</span><span class="p">:</span>
</span><span id="__span-5-18"><a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>            <span class="k">if</span> <span class="n">interface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
</span><span id="__span-5-19"><a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">interface</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_singletons</span><span class="p">[</span><span class="n">interface</span><span class="p">]()</span>
</span><span id="__span-5-20"><a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">interface</span><span class="p">]</span>
</span><span id="__span-5-21"><a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>
</span><span id="__span-5-22"><a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="k">if</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">:</span>
</span><span id="__span-5-23"><a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="n">interface</span><span class="p">]()</span>
</span><span id="__span-5-24"><a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>
</span><span id="__span-5-25"><a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>        <span class="k">raise</span> <span class="n">ServiceNotRegisteredError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Service </span><span class="si">{</span><span class="n">interface</span><span class="si">}</span><span class="s2"> not registered"</span><span class="p">)</span>
</span><span id="__span-5-26"><a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a>
</span><span id="__span-5-27"><a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="c1"># Usage in FastAPI</span>
</span><span id="__span-5-28"><a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_container</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Container</span><span class="p">:</span>
</span><span id="__span-5-29"><a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a>    <span class="k">return</span> <span class="n">container</span>
</span><span id="__span-5-30"><a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a>
</span><span id="__span-5-31"><a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_service</span><span class="p">(</span>
</span><span id="__span-5-32"><a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a>    <span class="n">container</span><span class="p">:</span> <span class="n">Container</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_container</span><span class="p">)</span>
</span><span id="__span-5-33"><a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserService</span><span class="p">:</span>
</span><span id="__span-5-34"><a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="k">return</span> <span class="n">container</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">IUserService</span><span class="p">)</span>
</span></code></pre></div> <h4 id="requestresponse-flow">Request/Response Flow<a class="headerlink" href="#requestresponse-flow" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># Middleware stack (executed in order)</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">"http"</span><span class="p">)</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">correlation_id_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="sd">"""Add correlation ID to all requests."""</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">correlation_id</span> <span class="o">=</span> <span class="n">correlation_id</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"X-Correlation-ID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation_id</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">"http"</span><span class="p">)</span>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">timing_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
</span><span id="__span-6-14"><a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="sd">"""Add timing information to responses."""</span>
</span><span id="__span-6-15"><a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-6-16"><a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span id="__span-6-17"><a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>    <span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-6-18"><a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"X-Process-Time"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_time</span><span class="p">)</span>
</span><span id="__span-6-19"><a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a>    <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-6-20"><a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>
</span><span id="__span-6-21"><a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="c1"># Request flow:</span>
</span><span id="__span-6-22"><a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="c1"># 1. Middleware stack (pre-processing)</span>
</span><span id="__span-6-23"><a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="c1"># 2. Route handler with dependencies</span>
</span><span id="__span-6-24"><a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="c1"># 3. Business service layer</span>
</span><span id="__span-6-25"><a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="c1"># 4. Data access layer</span>
</span><span id="__span-6-26"><a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="c1"># 5. Response serialization</span>
</span><span id="__span-6-27"><a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="c1"># 6. Middleware stack (post-processing)</span>
</span></code></pre></div> <h3 id="database-architecture">Database Architecture<a class="headerlink" href="#database-architecture" title="Permanent link">¶</a></h3> <h4 id="entity-relationship-model">Entity Relationship Model<a class="headerlink" href="#entity-relationship-model" title="Permanent link">¶</a></h4> <pre class="mermaid"><code>erDiagram
    User {
        uuid id PK
        string email UK
        string username UK
        string password_hash
        enum role
        string roblox_user_id UK
        boolean is_active
        timestamp created_at
    }

    Class {
        uuid id PK
        string name
        uuid teacher_id FK
        string subject
        integer grade_level
        integer max_students
        boolean is_active
        timestamp created_at
    }

    Lesson {
        uuid id PK
        string title
        uuid creator_id FK
        string subject
        integer grade_level
        json content
        enum status
        timestamp created_at
    }

    Progress {
        uuid id PK
        uuid student_id FK
        uuid lesson_id FK
        integer completion_percentage
        integer xp_earned
        json metadata
        timestamp started_at
        timestamp completed_at
    }

    User ||--o{ Class : teaches
    User ||--o{ Progress : completes
    Class ||--o{ Lesson : contains
    Lesson ||--o{ Progress : tracks</code></pre> <h4 id="data-access-patterns">Data Access Patterns<a class="headerlink" href="#data-access-patterns" title="Permanent link">¶</a></h4> <p><strong>Repository Pattern Implementation</strong>: <div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># Base repository</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseRepository</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-7-15"><a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="k">return</span> <span class="n">entity</span>
</span><span id="__span-7-16"><a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>
</span><span id="__span-7-17"><a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="__span-7-18"><a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-19"><a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-7-20"><a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>        <span class="k">return</span> <span class="n">entity</span>
</span><span id="__span-7-21"><a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>
</span><span id="__span-7-22"><a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-23"><a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-7-24"><a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-25"><a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a>
</span><span id="__span-7-26"><a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span>
</span><span id="__span-7-27"><a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-7-28"><a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-7-29"><a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-7-30"><a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-7-31"><a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
</span><span id="__span-7-32"><a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-7-33"><a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>
</span><span id="__span-7-34"><a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a>        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
</span><span id="__span-7-35"><a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-36"><a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a>                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
</span><span id="__span-7-37"><a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a>
</span><span id="__span-7-38"><a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
</span><span id="__span-7-39"><a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-7-40"><a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="__span-7-41"><a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a>
</span><span id="__span-7-42"><a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="c1"># Specialized repository</span>
</span><span id="__span-7-43"><a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserRepository</span><span class="p">(</span><span class="n">BaseRepository</span><span class="p">[</span><span class="n">User</span><span class="p">]):</span>
</span><span id="__span-7-44"><a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
</span><span id="__span-7-45"><a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span>
</span><span id="__span-7-46"><a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-7-47"><a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
</span><span id="__span-7-48"><a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a>
</span><span id="__span-7-49"><a href="#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
</span><span id="__span-7-50"><a href="#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="__span-7-51"><a href="#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-7-52"><a href="#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></code></pre></div></p> <p><strong>Unit of Work Pattern</strong>: <div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">UnitOfWork</span><span class="p">:</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">AsyncSession</span><span class="p">]):</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span> <span class="o">=</span> <span class="n">session_factory</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">ClassRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">Class</span><span class="p">)</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lessons</span> <span class="o">=</span> <span class="n">LessonRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">Lesson</span><span class="p">)</span>
</span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>
</span><span id="__span-8-13"><a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span id="__span-8-14"><a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
</span><span id="__span-8-15"><a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-8-16"><a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-8-17"><a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-8-18"><a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-8-19"><a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a>
</span><span id="__span-8-20"><a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="c1"># Usage</span>
</span><span id="__span-8-21"><a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_class_with_students</span><span class="p">(</span>
</span><span id="__span-8-22"><a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a>    <span class="n">class_data</span><span class="p">:</span> <span class="n">ClassCreate</span><span class="p">,</span>
</span><span id="__span-8-23"><a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a>    <span class="n">student_emails</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-8-24"><a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Class</span><span class="p">:</span>
</span><span id="__span-8-25"><a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">UnitOfWork</span><span class="p">(</span><span class="n">get_session</span><span class="p">)</span> <span class="k">as</span> <span class="n">uow</span><span class="p">:</span>
</span><span id="__span-8-26"><a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a>        <span class="c1"># Create class</span>
</span><span id="__span-8-27"><a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a>        <span class="n">new_class</span> <span class="o">=</span> <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Class</span><span class="p">(</span><span class="o">**</span><span class="n">class_data</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>
</span><span id="__span-8-28"><a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a>
</span><span id="__span-8-29"><a href="#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a>        <span class="c1"># Add students</span>
</span><span id="__span-8-30"><a href="#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a>        <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">student_emails</span><span class="p">:</span>
</span><span id="__span-8-31"><a href="#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a>            <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span id="__span-8-32"><a href="#__codelineno-8-32" id="__codelineno-8-32" name="__codelineno-8-32"></a>            <span class="k">if</span> <span class="n">student</span><span class="p">:</span>
</span><span id="__span-8-33"><a href="#__codelineno-8-33" id="__codelineno-8-33" name="__codelineno-8-33"></a>                <span class="n">enrollment</span> <span class="o">=</span> <span class="n">ClassEnrollment</span><span class="p">(</span>
</span><span id="__span-8-34"><a href="#__codelineno-8-34" id="__codelineno-8-34" name="__codelineno-8-34"></a>                    <span class="n">class_id</span><span class="o">=</span><span class="n">new_class</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-8-35"><a href="#__codelineno-8-35" id="__codelineno-8-35" name="__codelineno-8-35"></a>                    <span class="n">student_id</span><span class="o">=</span><span class="n">student</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-8-36"><a href="#__codelineno-8-36" id="__codelineno-8-36" name="__codelineno-8-36"></a>                <span class="p">)</span>
</span><span id="__span-8-37"><a href="#__codelineno-8-37" id="__codelineno-8-37" name="__codelineno-8-37"></a>                <span class="k">await</span> <span class="n">uow</span><span class="o">.</span><span class="n">enrollments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">enrollment</span><span class="p">)</span>
</span><span id="__span-8-38"><a href="#__codelineno-8-38" id="__codelineno-8-38" name="__codelineno-8-38"></a>
</span><span id="__span-8-39"><a href="#__codelineno-8-39" id="__codelineno-8-39" name="__codelineno-8-39"></a>        <span class="k">return</span> <span class="n">new_class</span>
</span></code></pre></div></p> <h2 id="integration-architecture">Integration Architecture<a class="headerlink" href="#integration-architecture" title="Permanent link">¶</a></h2> <h3 id="ai-service-integration">AI Service Integration<a class="headerlink" href="#ai-service-integration" title="Permanent link">¶</a></h3> <h4 id="ai-agent-orchestration">AI Agent Orchestration<a class="headerlink" href="#ai-agent-orchestration" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># Agent coordination system</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentOrchestrator</span><span class="p">:</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>            <span class="s1">'content'</span><span class="p">:</span> <span class="n">ContentAgent</span><span class="p">(),</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>            <span class="s1">'environment'</span><span class="p">:</span> <span class="n">EnvironmentAgent</span><span class="p">(),</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>            <span class="s1">'assessment'</span><span class="p">:</span> <span class="n">AssessmentAgent</span><span class="p">(),</span>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>            <span class="s1">'validation'</span><span class="p">:</span> <span class="n">ValidationAgent</span><span class="p">()</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>        <span class="p">}</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_engine</span> <span class="o">=</span> <span class="n">WorkflowEngine</span><span class="p">()</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_lesson</span><span class="p">(</span>
</span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a>        <span class="n">request</span><span class="p">:</span> <span class="n">ContentGenerationRequest</span>
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContentGenerationResult</span><span class="p">:</span>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">        </span><span class="sd">"""Orchestrate multiple agents to generate comprehensive lesson."""</span>
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a>
</span><span id="__span-9-18"><a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a>        <span class="c1"># Create workflow context</span>
</span><span id="__span-9-19"><a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">WorkflowContext</span><span class="p">(</span>
</span><span id="__span-9-20"><a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a>            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
</span><span id="__span-9-21"><a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>            <span class="n">correlation_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="__span-9-22"><a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-9-23"><a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>        <span class="p">)</span>
</span><span id="__span-9-24"><a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a>
</span><span id="__span-9-25"><a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a>        <span class="c1"># Define workflow steps</span>
</span><span id="__span-9-26"><a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>        <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span>
</span><span id="__span-9-27"><a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a>            <span class="n">WorkflowStep</span><span class="p">(</span>
</span><span id="__span-9-28"><a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"analyze_requirements"</span><span class="p">,</span>
</span><span id="__span-9-29"><a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>                <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="s1">'content'</span><span class="p">],</span>
</span><span id="__span-9-30"><a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'request'</span><span class="p">],</span>
</span><span id="__span-9-31"><a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a>                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'lesson_structure'</span><span class="p">]</span>
</span><span id="__span-9-32"><a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a>            <span class="p">),</span>
</span><span id="__span-9-33"><a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a>            <span class="n">WorkflowStep</span><span class="p">(</span>
</span><span id="__span-9-34"><a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"create_environment"</span><span class="p">,</span>
</span><span id="__span-9-35"><a href="#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a>                <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="s1">'environment'</span><span class="p">],</span>
</span><span id="__span-9-36"><a href="#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'lesson_structure'</span><span class="p">],</span>
</span><span id="__span-9-37"><a href="#__codelineno-9-37" id="__codelineno-9-37" name="__codelineno-9-37"></a>                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'environment_config'</span><span class="p">]</span>
</span><span id="__span-9-38"><a href="#__codelineno-9-38" id="__codelineno-9-38" name="__codelineno-9-38"></a>            <span class="p">),</span>
</span><span id="__span-9-39"><a href="#__codelineno-9-39" id="__codelineno-9-39" name="__codelineno-9-39"></a>            <span class="n">WorkflowStep</span><span class="p">(</span>
</span><span id="__span-9-40"><a href="#__codelineno-9-40" id="__codelineno-9-40" name="__codelineno-9-40"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"generate_assessments"</span><span class="p">,</span>
</span><span id="__span-9-41"><a href="#__codelineno-9-41" id="__codelineno-9-41" name="__codelineno-9-41"></a>                <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="s1">'assessment'</span><span class="p">],</span>
</span><span id="__span-9-42"><a href="#__codelineno-9-42" id="__codelineno-9-42" name="__codelineno-9-42"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'lesson_structure'</span><span class="p">],</span>
</span><span id="__span-9-43"><a href="#__codelineno-9-43" id="__codelineno-9-43" name="__codelineno-9-43"></a>                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'assessment_config'</span><span class="p">]</span>
</span><span id="__span-9-44"><a href="#__codelineno-9-44" id="__codelineno-9-44" name="__codelineno-9-44"></a>            <span class="p">),</span>
</span><span id="__span-9-45"><a href="#__codelineno-9-45" id="__codelineno-9-45" name="__codelineno-9-45"></a>            <span class="n">WorkflowStep</span><span class="p">(</span>
</span><span id="__span-9-46"><a href="#__codelineno-9-46" id="__codelineno-9-46" name="__codelineno-9-46"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">"validate_content"</span><span class="p">,</span>
</span><span id="__span-9-47"><a href="#__codelineno-9-47" id="__codelineno-9-47" name="__codelineno-9-47"></a>                <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="s1">'validation'</span><span class="p">],</span>
</span><span id="__span-9-48"><a href="#__codelineno-9-48" id="__codelineno-9-48" name="__codelineno-9-48"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'lesson_structure'</span><span class="p">,</span> <span class="s1">'environment_config'</span><span class="p">,</span> <span class="s1">'assessment_config'</span><span class="p">],</span>
</span><span id="__span-9-49"><a href="#__codelineno-9-49" id="__codelineno-9-49" name="__codelineno-9-49"></a>                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">'validation_result'</span><span class="p">]</span>
</span><span id="__span-9-50"><a href="#__codelineno-9-50" id="__codelineno-9-50" name="__codelineno-9-50"></a>            <span class="p">)</span>
</span><span id="__span-9-51"><a href="#__codelineno-9-51" id="__codelineno-9-51" name="__codelineno-9-51"></a>        <span class="p">])</span>
</span><span id="__span-9-52"><a href="#__codelineno-9-52" id="__codelineno-9-52" name="__codelineno-9-52"></a>
</span><span id="__span-9-53"><a href="#__codelineno-9-53" id="__codelineno-9-53" name="__codelineno-9-53"></a>        <span class="c1"># Execute workflow</span>
</span><span id="__span-9-54"><a href="#__codelineno-9-54" id="__codelineno-9-54" name="__codelineno-9-54"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-9-55"><a href="#__codelineno-9-55" id="__codelineno-9-55" name="__codelineno-9-55"></a>
</span><span id="__span-9-56"><a href="#__codelineno-9-56" id="__codelineno-9-56" name="__codelineno-9-56"></a>        <span class="k">return</span> <span class="n">ContentGenerationResult</span><span class="p">(</span>
</span><span id="__span-9-57"><a href="#__codelineno-9-57" id="__codelineno-9-57" name="__codelineno-9-57"></a>            <span class="n">content_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="__span-9-58"><a href="#__codelineno-9-58" id="__codelineno-9-58" name="__codelineno-9-58"></a>            <span class="n">lesson_content</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'lesson_structure'</span><span class="p">],</span>
</span><span id="__span-9-59"><a href="#__codelineno-9-59" id="__codelineno-9-59" name="__codelineno-9-59"></a>            <span class="n">environment_config</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'environment_config'</span><span class="p">],</span>
</span><span id="__span-9-60"><a href="#__codelineno-9-60" id="__codelineno-9-60" name="__codelineno-9-60"></a>            <span class="n">assessment_config</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'assessment_config'</span><span class="p">],</span>
</span><span id="__span-9-61"><a href="#__codelineno-9-61" id="__codelineno-9-61" name="__codelineno-9-61"></a>            <span class="n">validation_result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'validation_result'</span><span class="p">]</span>
</span><span id="__span-9-62"><a href="#__codelineno-9-62" id="__codelineno-9-62" name="__codelineno-9-62"></a>        <span class="p">)</span>
</span></code></pre></div> <h4 id="external-ai-service-integration">External AI Service Integration<a class="headerlink" href="#external-ai-service-integration" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># AI service abstraction</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AIServiceProvider</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_completion</span><span class="p">(</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="k">pass</span>
</span><span id="__span-10-11"><a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>
</span><span id="__span-10-12"><a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-10-13"><a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_streaming</span><span class="p">(</span>
</span><span id="__span-10-14"><a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-10-15"><a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-16"><a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-17"><a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-10-18"><a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-19"><a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="k">pass</span>
</span><span id="__span-10-20"><a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>
</span><span id="__span-10-21"><a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="c1"># Anthropic implementation</span>
</span><span id="__span-10-22"><a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">AnthropicProvider</span><span class="p">(</span><span class="n">AIServiceProvider</span><span class="p">):</span>
</span><span id="__span-10-23"><a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-10-24"><a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">AsyncAnthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
</span><span id="__span-10-25"><a href="#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a>
</span><span id="__span-10-26"><a href="#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_completion</span><span class="p">(</span>
</span><span id="__span-10-27"><a href="#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-10-28"><a href="#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-29"><a href="#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"claude-3-sonnet-20240229"</span><span class="p">,</span>
</span><span id="__span-10-30"><a href="#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a>        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-10-31"><a href="#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-10-32"><a href="#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a>        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="__span-10-33"><a href="#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-10-34"><a href="#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
</span><span id="__span-10-35"><a href="#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a>            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
</span><span id="__span-10-36"><a href="#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a>        <span class="p">)</span>
</span><span id="__span-10-37"><a href="#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a>        <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-10-38"><a href="#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a>
</span><span id="__span-10-39"><a href="#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_streaming</span><span class="p">(</span>
</span><span id="__span-10-40"><a href="#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-10-41"><a href="#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-10-42"><a href="#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"claude-3-sonnet-20240229"</span><span class="p">,</span>
</span><span id="__span-10-43"><a href="#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a>        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-10-44"><a href="#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-45"><a href="#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-10-46"><a href="#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-10-47"><a href="#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-10-48"><a href="#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a>            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
</span><span id="__span-10-49"><a href="#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
</span><span id="__span-10-50"><a href="#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">text_stream</span><span class="p">:</span>
</span><span id="__span-10-51"><a href="#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a>                <span class="n">callback</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="__span-10-52"><a href="#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a>
</span><span id="__span-10-53"><a href="#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="c1"># Service factory with fallback</span>
</span><span id="__span-10-54"><a href="#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="k">class</span><span class="w"> </span><span class="nc">AIServiceFactory</span><span class="p">:</span>
</span><span id="__span-10-55"><a href="#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-56"><a href="#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-10-57"><a href="#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a>            <span class="n">AnthropicProvider</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">anthropic_api_key</span><span class="p">),</span>
</span><span id="__span-10-58"><a href="#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a>            <span class="n">OpenAIProvider</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">openai_api_key</span><span class="p">)</span>
</span><span id="__span-10-59"><a href="#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a>        <span class="p">]</span>
</span><span id="__span-10-60"><a href="#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a>
</span><span id="__span-10-61"><a href="#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-10-62"><a href="#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a>        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">:</span>
</span><span id="__span-10-63"><a href="#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-64"><a href="#__codelineno-10-64" id="__codelineno-10-64" name="__codelineno-10-64"></a>                <span class="k">return</span> <span class="k">await</span> <span class="n">provider</span><span class="o">.</span><span class="n">generate_completion</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-10-65"><a href="#__codelineno-10-65" id="__codelineno-10-65" name="__codelineno-10-65"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-10-66"><a href="#__codelineno-10-66" id="__codelineno-10-66" name="__codelineno-10-66"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Provider failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-10-67"><a href="#__codelineno-10-67" id="__codelineno-10-67" name="__codelineno-10-67"></a>                <span class="k">continue</span>
</span><span id="__span-10-68"><a href="#__codelineno-10-68" id="__codelineno-10-68" name="__codelineno-10-68"></a>
</span><span id="__span-10-69"><a href="#__codelineno-10-69" id="__codelineno-10-69" name="__codelineno-10-69"></a>        <span class="k">raise</span> <span class="n">AIServiceUnavailableError</span><span class="p">(</span><span class="s2">"All AI providers failed"</span><span class="p">)</span>
</span></code></pre></div> <h3 id="roblox-platform-integration">Roblox Platform Integration<a class="headerlink" href="#roblox-platform-integration" title="Permanent link">¶</a></h3> <h4 id="roblox-api-client">Roblox API Client<a class="headerlink" href="#roblox-api-client" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RobloxAPIClient</span><span class="p">:</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://apis.roblox.com"</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">place_config</span><span class="p">:</span> <span class="n">PlaceConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Place</span><span class="p">:</span>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">        </span><span class="sd">"""Create a new place in a Roblox universe."""</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-11-10"><a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/universes/</span><span class="si">{</span><span class="n">universe_id</span><span class="si">}</span><span class="s2">/places"</span><span class="p">,</span>
</span><span id="__span-11-11"><a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">"</span><span class="p">},</span>
</span><span id="__span-11-12"><a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a>            <span class="n">json</span><span class="o">=</span><span class="n">place_config</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
</span><span id="__span-11-13"><a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="p">)</span>
</span><span id="__span-11-14"><a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-11-15"><a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a>        <span class="k">return</span> <span class="n">Place</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="__span-11-16"><a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a>
</span><span id="__span-11-17"><a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_place_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rbxl_content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-18"><a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">        </span><span class="sd">"""Upload a place file to Roblox."""</span>
</span><span id="__span-11-19"><a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-11-20"><a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/places/</span><span class="si">{</span><span class="n">place_id</span><span class="si">}</span><span class="s2">/upload"</span><span class="p">,</span>
</span><span id="__span-11-21"><a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">"</span><span class="p">},</span>
</span><span id="__span-11-22"><a href="#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a>            <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s2">"file"</span><span class="p">:</span> <span class="p">(</span><span class="s2">"place.rbxl"</span><span class="p">,</span> <span class="n">rbxl_content</span><span class="p">,</span> <span class="s2">"application/octet-stream"</span><span class="p">)}</span>
</span><span id="__span-11-23"><a href="#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a>        <span class="p">)</span>
</span><span id="__span-11-24"><a href="#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-11-25"><a href="#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a>
</span><span id="__span-11-26"><a href="#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_place_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlaceInfo</span><span class="p">:</span>
</span><span id="__span-11-27"><a href="#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">        </span><span class="sd">"""Get information about a Roblox place."""</span>
</span><span id="__span-11-28"><a href="#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-11-29"><a href="#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/places/</span><span class="si">{</span><span class="n">place_id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-11-30"><a href="#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
</span><span id="__span-11-31"><a href="#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a>        <span class="p">)</span>
</span><span id="__span-11-32"><a href="#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-11-33"><a href="#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a>        <span class="k">return</span> <span class="n">PlaceInfo</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span></code></pre></div> <h4 id="content-deployment-pipeline">Content Deployment Pipeline<a class="headerlink" href="#content-deployment-pipeline" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RobloxDeploymentService</span><span class="p">:</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roblox_client</span><span class="p">:</span> <span class="n">RobloxAPIClient</span><span class="p">):</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">roblox_client</span> <span class="o">=</span> <span class="n">roblox_client</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">template_engine</span> <span class="o">=</span> <span class="n">RobloxTemplateEngine</span><span class="p">()</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deploy_lesson_content</span><span class="p">(</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>        <span class="n">lesson</span><span class="p">:</span> <span class="n">Lesson</span><span class="p">,</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="n">environment_config</span><span class="p">:</span> <span class="n">EnvironmentConfig</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeploymentResult</span><span class="p">:</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">        </span><span class="sd">"""Deploy generated lesson content to Roblox."""</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-14"><a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a>            <span class="c1"># Generate Roblox place file</span>
</span><span id="__span-12-15"><a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a>            <span class="n">place_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_engine</span><span class="o">.</span><span class="n">generate_place</span><span class="p">(</span>
</span><span id="__span-12-16"><a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a>                <span class="n">lesson_content</span><span class="o">=</span><span class="n">lesson</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="__span-12-17"><a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a>                <span class="n">environment_config</span><span class="o">=</span><span class="n">environment_config</span>
</span><span id="__span-12-18"><a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a>            <span class="p">)</span>
</span><span id="__span-12-19"><a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a>
</span><span id="__span-12-20"><a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a>            <span class="c1"># Create or update Roblox place</span>
</span><span id="__span-12-21"><a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a>            <span class="k">if</span> <span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_id</span><span class="p">:</span>
</span><span id="__span-12-22"><a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a>                <span class="c1"># Update existing place</span>
</span><span id="__span-12-23"><a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">roblox_client</span><span class="o">.</span><span class="n">upload_place_file</span><span class="p">(</span>
</span><span id="__span-12-24"><a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a>                    <span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_id</span><span class="p">,</span>
</span><span id="__span-12-25"><a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a>                    <span class="n">place_data</span>
</span><span id="__span-12-26"><a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a>                <span class="p">)</span>
</span><span id="__span-12-27"><a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a>                <span class="n">place_id</span> <span class="o">=</span> <span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_id</span>
</span><span id="__span-12-28"><a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-29"><a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a>                <span class="c1"># Create new place</span>
</span><span id="__span-12-30"><a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a>                <span class="n">place</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">roblox_client</span><span class="o">.</span><span class="n">create_place</span><span class="p">(</span>
</span><span id="__span-12-31"><a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a>                    <span class="n">universe_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">roblox_universe_id</span><span class="p">,</span>
</span><span id="__span-12-32"><a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a>                    <span class="n">place_config</span><span class="o">=</span><span class="n">PlaceConfig</span><span class="p">(</span>
</span><span id="__span-12-33"><a href="#__codelineno-12-33" id="__codelineno-12-33" name="__codelineno-12-33"></a>                        <span class="n">name</span><span class="o">=</span><span class="n">lesson</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
</span><span id="__span-12-34"><a href="#__codelineno-12-34" id="__codelineno-12-34" name="__codelineno-12-34"></a>                        <span class="n">description</span><span class="o">=</span><span class="n">lesson</span><span class="o">.</span><span class="n">description</span>
</span><span id="__span-12-35"><a href="#__codelineno-12-35" id="__codelineno-12-35" name="__codelineno-12-35"></a>                    <span class="p">)</span>
</span><span id="__span-12-36"><a href="#__codelineno-12-36" id="__codelineno-12-36" name="__codelineno-12-36"></a>                <span class="p">)</span>
</span><span id="__span-12-37"><a href="#__codelineno-12-37" id="__codelineno-12-37" name="__codelineno-12-37"></a>                <span class="n">place_id</span> <span class="o">=</span> <span class="n">place</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-12-38"><a href="#__codelineno-12-38" id="__codelineno-12-38" name="__codelineno-12-38"></a>
</span><span id="__span-12-39"><a href="#__codelineno-12-39" id="__codelineno-12-39" name="__codelineno-12-39"></a>                <span class="c1"># Upload content</span>
</span><span id="__span-12-40"><a href="#__codelineno-12-40" id="__codelineno-12-40" name="__codelineno-12-40"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">roblox_client</span><span class="o">.</span><span class="n">upload_place_file</span><span class="p">(</span><span class="n">place_id</span><span class="p">,</span> <span class="n">place_data</span><span class="p">)</span>
</span><span id="__span-12-41"><a href="#__codelineno-12-41" id="__codelineno-12-41" name="__codelineno-12-41"></a>
</span><span id="__span-12-42"><a href="#__codelineno-12-42" id="__codelineno-12-42" name="__codelineno-12-42"></a>            <span class="c1"># Update lesson with Roblox information</span>
</span><span id="__span-12-43"><a href="#__codelineno-12-43" id="__codelineno-12-43" name="__codelineno-12-43"></a>            <span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_id</span> <span class="o">=</span> <span class="n">place_id</span>
</span><span id="__span-12-44"><a href="#__codelineno-12-44" id="__codelineno-12-44" name="__codelineno-12-44"></a>            <span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"https://www.roblox.com/games/</span><span class="si">{</span><span class="n">place_id</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-12-45"><a href="#__codelineno-12-45" id="__codelineno-12-45" name="__codelineno-12-45"></a>
</span><span id="__span-12-46"><a href="#__codelineno-12-46" id="__codelineno-12-46" name="__codelineno-12-46"></a>            <span class="k">return</span> <span class="n">DeploymentResult</span><span class="p">(</span>
</span><span id="__span-12-47"><a href="#__codelineno-12-47" id="__codelineno-12-47" name="__codelineno-12-47"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-48"><a href="#__codelineno-12-48" id="__codelineno-12-48" name="__codelineno-12-48"></a>                <span class="n">place_id</span><span class="o">=</span><span class="n">place_id</span><span class="p">,</span>
</span><span id="__span-12-49"><a href="#__codelineno-12-49" id="__codelineno-12-49" name="__codelineno-12-49"></a>                <span class="n">place_url</span><span class="o">=</span><span class="n">lesson</span><span class="o">.</span><span class="n">roblox_place_url</span>
</span><span id="__span-12-50"><a href="#__codelineno-12-50" id="__codelineno-12-50" name="__codelineno-12-50"></a>            <span class="p">)</span>
</span><span id="__span-12-51"><a href="#__codelineno-12-51" id="__codelineno-12-51" name="__codelineno-12-51"></a>
</span><span id="__span-12-52"><a href="#__codelineno-12-52" id="__codelineno-12-52" name="__codelineno-12-52"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-12-53"><a href="#__codelineno-12-53" id="__codelineno-12-53" name="__codelineno-12-53"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deployment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-54"><a href="#__codelineno-12-54" id="__codelineno-12-54" name="__codelineno-12-54"></a>            <span class="k">return</span> <span class="n">DeploymentResult</span><span class="p">(</span>
</span><span id="__span-12-55"><a href="#__codelineno-12-55" id="__codelineno-12-55" name="__codelineno-12-55"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-56"><a href="#__codelineno-12-56" id="__codelineno-12-56" name="__codelineno-12-56"></a>                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-12-57"><a href="#__codelineno-12-57" id="__codelineno-12-57" name="__codelineno-12-57"></a>            <span class="p">)</span>
</span></code></pre></div> <h3 id="real-time-communication-architecture">Real-time Communication Architecture<a class="headerlink" href="#real-time-communication-architecture" title="Permanent link">¶</a></h3> <blockquote> <p>✅ <strong>Migration Complete</strong>: WebSocket implementation has been fully replaced with Pusher Channels for improved reliability and scalability. See <a href="../WEBSOCKET_TO_PUSHER_MIGRATION_COMPLETE.md">Migration Guide</a>.</p> </blockquote> <h4 id="websocket-and-pusher-integration-pusher-primary"><del>WebSocket</del> and Pusher Integration (Pusher Primary)<a class="headerlink" href="#websocket-and-pusher-integration-pusher-primary" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># OLD WebSocket manager - DEPRECATED (maintained for compatibility)</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="c1"># class WebSocketManager:</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="c1">#     def __init__(self):</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1">#         self.active_connections: Dict[str, WebSocket] = {}</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="c1">#         # ... WebSocket implementation (deprecated)</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="c1"># NEW Pusher-based communication (PRIMARY)</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">RealTimeService</span><span class="p">:</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="sd">"""Unified real-time communication service using Pusher."""</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="n">pusher</span><span class="o">.</span><span class="n">Pusher</span><span class="p">(</span>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a>            <span class="n">app_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PUSHER_APP_ID</span><span class="p">,</span>
</span><span id="__span-13-14"><a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a>            <span class="n">key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PUSHER_KEY</span><span class="p">,</span>
</span><span id="__span-13-15"><a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a>            <span class="n">secret</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PUSHER_SECRET</span><span class="p">,</span>
</span><span id="__span-13-16"><a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a>            <span class="n">cluster</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PUSHER_CLUSTER</span><span class="p">,</span>
</span><span id="__span-13-17"><a href="#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a>            <span class="n">ssl</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-13-18"><a href="#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a>        <span class="p">)</span>
</span><span id="__span-13-19"><a href="#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a>
</span><span id="__span-13-20"><a href="#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_to_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-13-21"><a href="#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">        </span><span class="sd">"""Send message to specific user via private channel."""</span>
</span><span id="__span-13-22"><a href="#__codelineno-13-22" id="__codelineno-13-22" name="__codelineno-13-22"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-23"><a href="#__codelineno-13-23" id="__codelineno-13-23" name="__codelineno-13-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span>
</span><span id="__span-13-24"><a href="#__codelineno-13-24" id="__codelineno-13-24" name="__codelineno-13-24"></a>                <span class="sa">f</span><span class="s1">'private-user-</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
</span><span id="__span-13-25"><a href="#__codelineno-13-25" id="__codelineno-13-25" name="__codelineno-13-25"></a>                <span class="n">event</span><span class="p">,</span>
</span><span id="__span-13-26"><a href="#__codelineno-13-26" id="__codelineno-13-26" name="__codelineno-13-26"></a>                <span class="n">data</span>
</span><span id="__span-13-27"><a href="#__codelineno-13-27" id="__codelineno-13-27" name="__codelineno-13-27"></a>            <span class="p">)</span>
</span><span id="__span-13-28"><a href="#__codelineno-13-28" id="__codelineno-13-28" name="__codelineno-13-28"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-29"><a href="#__codelineno-13-29" id="__codelineno-13-29" name="__codelineno-13-29"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to send Pusher message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-13-30"><a href="#__codelineno-13-30" id="__codelineno-13-30" name="__codelineno-13-30"></a>
</span><span id="__span-13-31"><a href="#__codelineno-13-31" id="__codelineno-13-31" name="__codelineno-13-31"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">broadcast_to_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-13-32"><a href="#__codelineno-13-32" id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">        </span><span class="sd">"""Broadcast message to all subscribers of a channel."""</span>
</span><span id="__span-13-33"><a href="#__codelineno-13-33" id="__codelineno-13-33" name="__codelineno-13-33"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-34"><a href="#__codelineno-13-34" id="__codelineno-13-34" name="__codelineno-13-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="__span-13-35"><a href="#__codelineno-13-35" id="__codelineno-13-35" name="__codelineno-13-35"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-36"><a href="#__codelineno-13-36" id="__codelineno-13-36" name="__codelineno-13-36"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to broadcast to channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-13-37"><a href="#__codelineno-13-37" id="__codelineno-13-37" name="__codelineno-13-37"></a>
</span><span id="__span-13-38"><a href="#__codelineno-13-38" id="__codelineno-13-38" name="__codelineno-13-38"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger_content_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">update_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-13-39"><a href="#__codelineno-13-39" id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">        </span><span class="sd">"""Trigger content generation progress update."""</span>
</span><span id="__span-13-40"><a href="#__codelineno-13-40" id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_to_channel</span><span class="p">(</span>
</span><span id="__span-13-41"><a href="#__codelineno-13-41" id="__codelineno-13-41" name="__codelineno-13-41"></a>            <span class="sa">f</span><span class="s1">'content-generation-</span><span class="si">{</span><span class="n">content_id</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
</span><span id="__span-13-42"><a href="#__codelineno-13-42" id="__codelineno-13-42" name="__codelineno-13-42"></a>            <span class="s1">'progress'</span><span class="p">,</span>
</span><span id="__span-13-43"><a href="#__codelineno-13-43" id="__codelineno-13-43" name="__codelineno-13-43"></a>            <span class="n">update_data</span>
</span><span id="__span-13-44"><a href="#__codelineno-13-44" id="__codelineno-13-44" name="__codelineno-13-44"></a>        <span class="p">)</span>
</span><span id="__span-13-45"><a href="#__codelineno-13-45" id="__codelineno-13-45" name="__codelineno-13-45"></a>
</span><span id="__span-13-46"><a href="#__codelineno-13-46" id="__codelineno-13-46" name="__codelineno-13-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger_roblox_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sync_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-13-47"><a href="#__codelineno-13-47" id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="w">        </span><span class="sd">"""Trigger Roblox environment synchronization."""</span>
</span><span id="__span-13-48"><a href="#__codelineno-13-48" id="__codelineno-13-48" name="__codelineno-13-48"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_to_channel</span><span class="p">(</span>
</span><span id="__span-13-49"><a href="#__codelineno-13-49" id="__codelineno-13-49" name="__codelineno-13-49"></a>            <span class="sa">f</span><span class="s1">'roblox-environment-</span><span class="si">{</span><span class="n">environment_id</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
</span><span id="__span-13-50"><a href="#__codelineno-13-50" id="__codelineno-13-50" name="__codelineno-13-50"></a>            <span class="s1">'sync_update'</span><span class="p">,</span>
</span><span id="__span-13-51"><a href="#__codelineno-13-51" id="__codelineno-13-51" name="__codelineno-13-51"></a>            <span class="n">sync_data</span>
</span><span id="__span-13-52"><a href="#__codelineno-13-52" id="__codelineno-13-52" name="__codelineno-13-52"></a>        <span class="p">)</span>
</span><span id="__span-13-53"><a href="#__codelineno-13-53" id="__codelineno-13-53" name="__codelineno-13-53"></a>
</span><span id="__span-13-54"><a href="#__codelineno-13-54" id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="c1"># Enhanced Pusher service integration</span>
</span><span id="__span-13-55"><a href="#__codelineno-13-55" id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="k">class</span><span class="w"> </span><span class="nc">PusherAuthService</span><span class="p">:</span>
</span><span id="__span-13-56"><a href="#__codelineno-13-56" id="__codelineno-13-56" name="__codelineno-13-56"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pusher_client</span><span class="p">):</span>
</span><span id="__span-13-57"><a href="#__codelineno-13-57" id="__codelineno-13-57" name="__codelineno-13-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="n">pusher_client</span>
</span><span id="__span-13-58"><a href="#__codelineno-13-58" id="__codelineno-13-58" name="__codelineno-13-58"></a>
</span><span id="__span-13-59"><a href="#__codelineno-13-59" id="__codelineno-13-59" name="__codelineno-13-59"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger_event</span><span class="p">(</span>
</span><span id="__span-13-60"><a href="#__codelineno-13-60" id="__codelineno-13-60" name="__codelineno-13-60"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-13-61"><a href="#__codelineno-13-61" id="__codelineno-13-61" name="__codelineno-13-61"></a>        <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-62"><a href="#__codelineno-13-62" id="__codelineno-13-62" name="__codelineno-13-62"></a>        <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-63"><a href="#__codelineno-13-63" id="__codelineno-13-63" name="__codelineno-13-63"></a>        <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="__span-13-64"><a href="#__codelineno-13-64" id="__codelineno-13-64" name="__codelineno-13-64"></a>        <span class="n">socket_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-65"><a href="#__codelineno-13-65" id="__codelineno-13-65" name="__codelineno-13-65"></a>    <span class="p">):</span>
</span><span id="__span-13-66"><a href="#__codelineno-13-66" id="__codelineno-13-66" name="__codelineno-13-66"></a><span class="w">        </span><span class="sd">"""Trigger a Pusher event."""</span>
</span><span id="__span-13-67"><a href="#__codelineno-13-67" id="__codelineno-13-67" name="__codelineno-13-67"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-68"><a href="#__codelineno-13-68" id="__codelineno-13-68" name="__codelineno-13-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span>
</span><span id="__span-13-69"><a href="#__codelineno-13-69" id="__codelineno-13-69" name="__codelineno-13-69"></a>                <span class="n">channel</span><span class="p">,</span>
</span><span id="__span-13-70"><a href="#__codelineno-13-70" id="__codelineno-13-70" name="__codelineno-13-70"></a>                <span class="n">event</span><span class="p">,</span>
</span><span id="__span-13-71"><a href="#__codelineno-13-71" id="__codelineno-13-71" name="__codelineno-13-71"></a>                <span class="n">data</span><span class="p">,</span>
</span><span id="__span-13-72"><a href="#__codelineno-13-72" id="__codelineno-13-72" name="__codelineno-13-72"></a>                <span class="n">socket_id</span><span class="o">=</span><span class="n">socket_id</span>
</span><span id="__span-13-73"><a href="#__codelineno-13-73" id="__codelineno-13-73" name="__codelineno-13-73"></a>            <span class="p">)</span>
</span><span id="__span-13-74"><a href="#__codelineno-13-74" id="__codelineno-13-74" name="__codelineno-13-74"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-75"><a href="#__codelineno-13-75" id="__codelineno-13-75" name="__codelineno-13-75"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to trigger Pusher event: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-13-76"><a href="#__codelineno-13-76" id="__codelineno-13-76" name="__codelineno-13-76"></a>
</span><span id="__span-13-77"><a href="#__codelineno-13-77" id="__codelineno-13-77" name="__codelineno-13-77"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">authenticate_channel</span><span class="p">(</span>
</span><span id="__span-13-78"><a href="#__codelineno-13-78" id="__codelineno-13-78" name="__codelineno-13-78"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-13-79"><a href="#__codelineno-13-79" id="__codelineno-13-79" name="__codelineno-13-79"></a>        <span class="n">socket_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-80"><a href="#__codelineno-13-80" id="__codelineno-13-80" name="__codelineno-13-80"></a>        <span class="n">channel_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-81"><a href="#__codelineno-13-81" id="__codelineno-13-81" name="__codelineno-13-81"></a>        <span class="n">user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-82"><a href="#__codelineno-13-82" id="__codelineno-13-82" name="__codelineno-13-82"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-13-83"><a href="#__codelineno-13-83" id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="w">        </span><span class="sd">"""Authenticate a private or presence channel."""</span>
</span><span id="__span-13-84"><a href="#__codelineno-13-84" id="__codelineno-13-84" name="__codelineno-13-84"></a>        <span class="k">if</span> <span class="n">channel_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'presence-'</span><span class="p">):</span>
</span><span id="__span-13-85"><a href="#__codelineno-13-85" id="__codelineno-13-85" name="__codelineno-13-85"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span>
</span><span id="__span-13-86"><a href="#__codelineno-13-86" id="__codelineno-13-86" name="__codelineno-13-86"></a>                <span class="n">channel</span><span class="o">=</span><span class="n">channel_name</span><span class="p">,</span>
</span><span id="__span-13-87"><a href="#__codelineno-13-87" id="__codelineno-13-87" name="__codelineno-13-87"></a>                <span class="n">socket_id</span><span class="o">=</span><span class="n">socket_id</span><span class="p">,</span>
</span><span id="__span-13-88"><a href="#__codelineno-13-88" id="__codelineno-13-88" name="__codelineno-13-88"></a>                <span class="n">custom_data</span><span class="o">=</span><span class="n">user_data</span>
</span><span id="__span-13-89"><a href="#__codelineno-13-89" id="__codelineno-13-89" name="__codelineno-13-89"></a>            <span class="p">)</span>
</span><span id="__span-13-90"><a href="#__codelineno-13-90" id="__codelineno-13-90" name="__codelineno-13-90"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-91"><a href="#__codelineno-13-91" id="__codelineno-13-91" name="__codelineno-13-91"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span>
</span><span id="__span-13-92"><a href="#__codelineno-13-92" id="__codelineno-13-92" name="__codelineno-13-92"></a>                <span class="n">channel</span><span class="o">=</span><span class="n">channel_name</span><span class="p">,</span>
</span><span id="__span-13-93"><a href="#__codelineno-13-93" id="__codelineno-13-93" name="__codelineno-13-93"></a>                <span class="n">socket_id</span><span class="o">=</span><span class="n">socket_id</span>
</span><span id="__span-13-94"><a href="#__codelineno-13-94" id="__codelineno-13-94" name="__codelineno-13-94"></a>            <span class="p">)</span>
</span></code></pre></div> <h2 id="ai-agent-system-architecture">AI Agent System Architecture<a class="headerlink" href="#ai-agent-system-architecture" title="Permanent link">¶</a></h2> <h3 id="sparc-framework-implementation">SPARC Framework Implementation<a class="headerlink" href="#sparc-framework-implementation" title="Permanent link">¶</a></h3> <h4 id="sparc-components">SPARC Components<a class="headerlink" href="#sparc-components" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># Specification phase</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">SpecificationAgent</span><span class="p">:</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_requirements</span><span class="p">(</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>        <span class="n">user_request</span><span class="p">:</span> <span class="n">ContentGenerationRequest</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LessonSpecification</span><span class="p">:</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">        </span><span class="sd">"""Analyze user requirements and create detailed specification."""</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="s2">        Analyze this educational content request and create a detailed specification:</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="s2">        Subject: </span><span class="si">{</span><span class="n">user_request</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span>
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="s2">        Grade Level: </span><span class="si">{</span><span class="n">user_request</span><span class="o">.</span><span class="n">grade_level</span><span class="si">}</span>
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="s2">        Learning Objectives: </span><span class="si">{</span><span class="n">user_request</span><span class="o">.</span><span class="n">learning_objectives</span><span class="si">}</span>
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="s2">        Duration: </span><span class="si">{</span><span class="n">user_request</span><span class="o">.</span><span class="n">duration_minutes</span><span class="si">}</span><span class="s2"> minutes</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="s2">        Provide a structured specification including:</span>
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="s2">        1. Detailed learning objectives with measurable outcomes</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="s2">        2. Content structure and key concepts</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="s2">        3. Interactive elements and activities</span>
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="s2">        4. Assessment criteria</span>
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="s2">        5. Prerequisite knowledge</span>
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="s2">        """</span>
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a>
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a>        <span class="n">specification_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai_service</span><span class="o">.</span><span class="n">generate_completion</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a>        <span class="k">return</span> <span class="n">LessonSpecification</span><span class="o">.</span><span class="n">parse_from_text</span><span class="p">(</span><span class="n">specification_text</span><span class="p">)</span>
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="c1"># Pseudocode phase</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">PseudocodeAgent</span><span class="p">:</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_lesson_pseudocode</span><span class="p">(</span>
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="n">specification</span><span class="p">:</span> <span class="n">LessonSpecification</span>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LessonPseudocode</span><span class="p">:</span>
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="w">        </span><span class="sd">"""Create pseudocode for lesson implementation."""</span>
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a>
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span>
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="s2">        Create detailed pseudocode for implementing this lesson:</span>
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a>
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="s2">        Specification: </span><span class="si">{</span><span class="n">specification</span><span class="o">.</span><span class="n">to_text</span><span class="p">()</span><span class="si">}</span>
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a>
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="s2">        Include:</span>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="s2">        1. Lesson flow and structure</span>
</span><span id="__span-14-43"><a href="#__codelineno-14-43" id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="s2">        2. Interactive element definitions</span>
</span><span id="__span-14-44"><a href="#__codelineno-14-44" id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="s2">        3. Assessment integration points</span>
</span><span id="__span-14-45"><a href="#__codelineno-14-45" id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="s2">        4. 3D environment requirements</span>
</span><span id="__span-14-46"><a href="#__codelineno-14-46" id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="s2">        5. Student progression logic</span>
</span><span id="__span-14-47"><a href="#__codelineno-14-47" id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="s2">        """</span>
</span><span id="__span-14-48"><a href="#__codelineno-14-48" id="__codelineno-14-48" name="__codelineno-14-48"></a>
</span><span id="__span-14-49"><a href="#__codelineno-14-49" id="__codelineno-14-49" name="__codelineno-14-49"></a>        <span class="n">pseudocode_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai_service</span><span class="o">.</span><span class="n">generate_completion</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-14-50"><a href="#__codelineno-14-50" id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="k">return</span> <span class="n">LessonPseudocode</span><span class="o">.</span><span class="n">parse_from_text</span><span class="p">(</span><span class="n">pseudocode_text</span><span class="p">)</span>
</span><span id="__span-14-51"><a href="#__codelineno-14-51" id="__codelineno-14-51" name="__codelineno-14-51"></a>
</span><span id="__span-14-52"><a href="#__codelineno-14-52" id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="c1"># Architecture phase</span>
</span><span id="__span-14-53"><a href="#__codelineno-14-53" id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArchitectureAgent</span><span class="p">:</span>
</span><span id="__span-14-54"><a href="#__codelineno-14-54" id="__codelineno-14-54" name="__codelineno-14-54"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">design_lesson_architecture</span><span class="p">(</span>
</span><span id="__span-14-55"><a href="#__codelineno-14-55" id="__codelineno-14-55" name="__codelineno-14-55"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-56"><a href="#__codelineno-14-56" id="__codelineno-14-56" name="__codelineno-14-56"></a>        <span class="n">pseudocode</span><span class="p">:</span> <span class="n">LessonPseudocode</span>
</span><span id="__span-14-57"><a href="#__codelineno-14-57" id="__codelineno-14-57" name="__codelineno-14-57"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LessonArchitecture</span><span class="p">:</span>
</span><span id="__span-14-58"><a href="#__codelineno-14-58" id="__codelineno-14-58" name="__codelineno-14-58"></a><span class="w">        </span><span class="sd">"""Design the technical architecture for the lesson."""</span>
</span><span id="__span-14-59"><a href="#__codelineno-14-59" id="__codelineno-14-59" name="__codelineno-14-59"></a>
</span><span id="__span-14-60"><a href="#__codelineno-14-60" id="__codelineno-14-60" name="__codelineno-14-60"></a>        <span class="k">return</span> <span class="n">LessonArchitecture</span><span class="p">(</span>
</span><span id="__span-14-61"><a href="#__codelineno-14-61" id="__codelineno-14-61" name="__codelineno-14-61"></a>            <span class="n">components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identify_components</span><span class="p">(</span><span class="n">pseudocode</span><span class="p">),</span>
</span><span id="__span-14-62"><a href="#__codelineno-14-62" id="__codelineno-14-62" name="__codelineno-14-62"></a>            <span class="n">data_flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_design_data_flow</span><span class="p">(</span><span class="n">pseudocode</span><span class="p">),</span>
</span><span id="__span-14-63"><a href="#__codelineno-14-63" id="__codelineno-14-63" name="__codelineno-14-63"></a>            <span class="n">interfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_define_interfaces</span><span class="p">(</span><span class="n">pseudocode</span><span class="p">),</span>
</span><span id="__span-14-64"><a href="#__codelineno-14-64" id="__codelineno-14-64" name="__codelineno-14-64"></a>            <span class="n">environment_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_environment_specs</span><span class="p">(</span><span class="n">pseudocode</span><span class="p">)</span>
</span><span id="__span-14-65"><a href="#__codelineno-14-65" id="__codelineno-14-65" name="__codelineno-14-65"></a>        <span class="p">)</span>
</span><span id="__span-14-66"><a href="#__codelineno-14-66" id="__codelineno-14-66" name="__codelineno-14-66"></a>
</span><span id="__span-14-67"><a href="#__codelineno-14-67" id="__codelineno-14-67" name="__codelineno-14-67"></a><span class="c1"># Refinement phase</span>
</span><span id="__span-14-68"><a href="#__codelineno-14-68" id="__codelineno-14-68" name="__codelineno-14-68"></a><span class="k">class</span><span class="w"> </span><span class="nc">RefinementAgent</span><span class="p">:</span>
</span><span id="__span-14-69"><a href="#__codelineno-14-69" id="__codelineno-14-69" name="__codelineno-14-69"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refine_lesson_design</span><span class="p">(</span>
</span><span id="__span-14-70"><a href="#__codelineno-14-70" id="__codelineno-14-70" name="__codelineno-14-70"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-71"><a href="#__codelineno-14-71" id="__codelineno-14-71" name="__codelineno-14-71"></a>        <span class="n">architecture</span><span class="p">:</span> <span class="n">LessonArchitecture</span><span class="p">,</span>
</span><span id="__span-14-72"><a href="#__codelineno-14-72" id="__codelineno-14-72" name="__codelineno-14-72"></a>        <span class="n">feedback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">FeedbackItem</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-73"><a href="#__codelineno-14-73" id="__codelineno-14-73" name="__codelineno-14-73"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RefinedLessonDesign</span><span class="p">:</span>
</span><span id="__span-14-74"><a href="#__codelineno-14-74" id="__codelineno-14-74" name="__codelineno-14-74"></a><span class="w">        </span><span class="sd">"""Refine the lesson design based on architecture and feedback."""</span>
</span><span id="__span-14-75"><a href="#__codelineno-14-75" id="__codelineno-14-75" name="__codelineno-14-75"></a>
</span><span id="__span-14-76"><a href="#__codelineno-14-76" id="__codelineno-14-76" name="__codelineno-14-76"></a>        <span class="n">refinements</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-14-77"><a href="#__codelineno-14-77" id="__codelineno-14-77" name="__codelineno-14-77"></a>
</span><span id="__span-14-78"><a href="#__codelineno-14-78" id="__codelineno-14-78" name="__codelineno-14-78"></a>        <span class="c1"># Apply educational best practices</span>
</span><span id="__span-14-79"><a href="#__codelineno-14-79" id="__codelineno-14-79" name="__codelineno-14-79"></a>        <span class="n">refinements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_pedagogical_principles</span><span class="p">(</span><span class="n">architecture</span><span class="p">))</span>
</span><span id="__span-14-80"><a href="#__codelineno-14-80" id="__codelineno-14-80" name="__codelineno-14-80"></a>
</span><span id="__span-14-81"><a href="#__codelineno-14-81" id="__codelineno-14-81" name="__codelineno-14-81"></a>        <span class="c1"># Incorporate feedback</span>
</span><span id="__span-14-82"><a href="#__codelineno-14-82" id="__codelineno-14-82" name="__codelineno-14-82"></a>        <span class="k">if</span> <span class="n">feedback</span><span class="p">:</span>
</span><span id="__span-14-83"><a href="#__codelineno-14-83" id="__codelineno-14-83" name="__codelineno-14-83"></a>            <span class="n">refinements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_feedback</span><span class="p">(</span><span class="n">feedback</span><span class="p">))</span>
</span><span id="__span-14-84"><a href="#__codelineno-14-84" id="__codelineno-14-84" name="__codelineno-14-84"></a>
</span><span id="__span-14-85"><a href="#__codelineno-14-85" id="__codelineno-14-85" name="__codelineno-14-85"></a>        <span class="c1"># Optimize for platform constraints</span>
</span><span id="__span-14-86"><a href="#__codelineno-14-86" id="__codelineno-14-86" name="__codelineno-14-86"></a>        <span class="n">refinements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimize_for_roblox</span><span class="p">(</span><span class="n">architecture</span><span class="p">))</span>
</span><span id="__span-14-87"><a href="#__codelineno-14-87" id="__codelineno-14-87" name="__codelineno-14-87"></a>
</span><span id="__span-14-88"><a href="#__codelineno-14-88" id="__codelineno-14-88" name="__codelineno-14-88"></a>        <span class="k">return</span> <span class="n">RefinedLessonDesign</span><span class="p">(</span>
</span><span id="__span-14-89"><a href="#__codelineno-14-89" id="__codelineno-14-89" name="__codelineno-14-89"></a>            <span class="n">architecture</span><span class="o">=</span><span class="n">architecture</span><span class="p">,</span>
</span><span id="__span-14-90"><a href="#__codelineno-14-90" id="__codelineno-14-90" name="__codelineno-14-90"></a>            <span class="n">refinements</span><span class="o">=</span><span class="n">refinements</span><span class="p">,</span>
</span><span id="__span-14-91"><a href="#__codelineno-14-91" id="__codelineno-14-91" name="__codelineno-14-91"></a>            <span class="n">quality_score</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_quality_score</span><span class="p">(</span><span class="n">architecture</span><span class="p">)</span>
</span><span id="__span-14-92"><a href="#__codelineno-14-92" id="__codelineno-14-92" name="__codelineno-14-92"></a>        <span class="p">)</span>
</span><span id="__span-14-93"><a href="#__codelineno-14-93" id="__codelineno-14-93" name="__codelineno-14-93"></a>
</span><span id="__span-14-94"><a href="#__codelineno-14-94" id="__codelineno-14-94" name="__codelineno-14-94"></a><span class="c1"># Code generation phase</span>
</span><span id="__span-14-95"><a href="#__codelineno-14-95" id="__codelineno-14-95" name="__codelineno-14-95"></a><span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerationAgent</span><span class="p">:</span>
</span><span id="__span-14-96"><a href="#__codelineno-14-96" id="__codelineno-14-96" name="__codelineno-14-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_lesson_implementation</span><span class="p">(</span>
</span><span id="__span-14-97"><a href="#__codelineno-14-97" id="__codelineno-14-97" name="__codelineno-14-97"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-14-98"><a href="#__codelineno-14-98" id="__codelineno-14-98" name="__codelineno-14-98"></a>        <span class="n">refined_design</span><span class="p">:</span> <span class="n">RefinedLessonDesign</span>
</span><span id="__span-14-99"><a href="#__codelineno-14-99" id="__codelineno-14-99" name="__codelineno-14-99"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LessonImplementation</span><span class="p">:</span>
</span><span id="__span-14-100"><a href="#__codelineno-14-100" id="__codelineno-14-100" name="__codelineno-14-100"></a><span class="w">        </span><span class="sd">"""Generate the actual lesson implementation."""</span>
</span><span id="__span-14-101"><a href="#__codelineno-14-101" id="__codelineno-14-101" name="__codelineno-14-101"></a>
</span><span id="__span-14-102"><a href="#__codelineno-14-102" id="__codelineno-14-102" name="__codelineno-14-102"></a>        <span class="c1"># Generate Lua scripts for Roblox</span>
</span><span id="__span-14-103"><a href="#__codelineno-14-103" id="__codelineno-14-103" name="__codelineno-14-103"></a>        <span class="n">roblox_scripts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_roblox_scripts</span><span class="p">(</span><span class="n">refined_design</span><span class="p">)</span>
</span><span id="__span-14-104"><a href="#__codelineno-14-104" id="__codelineno-14-104" name="__codelineno-14-104"></a>
</span><span id="__span-14-105"><a href="#__codelineno-14-105" id="__codelineno-14-105" name="__codelineno-14-105"></a>        <span class="c1"># Generate web interface components</span>
</span><span id="__span-14-106"><a href="#__codelineno-14-106" id="__codelineno-14-106" name="__codelineno-14-106"></a>        <span class="n">web_components</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_web_components</span><span class="p">(</span><span class="n">refined_design</span><span class="p">)</span>
</span><span id="__span-14-107"><a href="#__codelineno-14-107" id="__codelineno-14-107" name="__codelineno-14-107"></a>
</span><span id="__span-14-108"><a href="#__codelineno-14-108" id="__codelineno-14-108" name="__codelineno-14-108"></a>        <span class="c1"># Generate assessment configurations</span>
</span><span id="__span-14-109"><a href="#__codelineno-14-109" id="__codelineno-14-109" name="__codelineno-14-109"></a>        <span class="n">assessments</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_assessments</span><span class="p">(</span><span class="n">refined_design</span><span class="p">)</span>
</span><span id="__span-14-110"><a href="#__codelineno-14-110" id="__codelineno-14-110" name="__codelineno-14-110"></a>
</span><span id="__span-14-111"><a href="#__codelineno-14-111" id="__codelineno-14-111" name="__codelineno-14-111"></a>        <span class="c1"># Generate progress tracking</span>
</span><span id="__span-14-112"><a href="#__codelineno-14-112" id="__codelineno-14-112" name="__codelineno-14-112"></a>        <span class="n">progress_tracking</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_progress_tracking</span><span class="p">(</span><span class="n">refined_design</span><span class="p">)</span>
</span><span id="__span-14-113"><a href="#__codelineno-14-113" id="__codelineno-14-113" name="__codelineno-14-113"></a>
</span><span id="__span-14-114"><a href="#__codelineno-14-114" id="__codelineno-14-114" name="__codelineno-14-114"></a>        <span class="k">return</span> <span class="n">LessonImplementation</span><span class="p">(</span>
</span><span id="__span-14-115"><a href="#__codelineno-14-115" id="__codelineno-14-115" name="__codelineno-14-115"></a>            <span class="n">roblox_scripts</span><span class="o">=</span><span class="n">roblox_scripts</span><span class="p">,</span>
</span><span id="__span-14-116"><a href="#__codelineno-14-116" id="__codelineno-14-116" name="__codelineno-14-116"></a>            <span class="n">web_components</span><span class="o">=</span><span class="n">web_components</span><span class="p">,</span>
</span><span id="__span-14-117"><a href="#__codelineno-14-117" id="__codelineno-14-117" name="__codelineno-14-117"></a>            <span class="n">assessments</span><span class="o">=</span><span class="n">assessments</span><span class="p">,</span>
</span><span id="__span-14-118"><a href="#__codelineno-14-118" id="__codelineno-14-118" name="__codelineno-14-118"></a>            <span class="n">progress_tracking</span><span class="o">=</span><span class="n">progress_tracking</span><span class="p">,</span>
</span><span id="__span-14-119"><a href="#__codelineno-14-119" id="__codelineno-14-119" name="__codelineno-14-119"></a>            <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_metadata</span><span class="p">(</span><span class="n">refined_design</span><span class="p">)</span>
</span><span id="__span-14-120"><a href="#__codelineno-14-120" id="__codelineno-14-120" name="__codelineno-14-120"></a>        <span class="p">)</span>
</span></code></pre></div> <h3 id="agent-coordination-system">Agent Coordination System<a class="headerlink" href="#agent-coordination-system" title="Permanent link">¶</a></h3> <h4 id="workflow-engine">Workflow Engine<a class="headerlink" href="#workflow-engine" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">WorkflowEngine</span><span class="p">:</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step_executors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">EventBus</span><span class="p">()</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_workflow</span><span class="p">(</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a>        <span class="n">workflow</span><span class="p">:</span> <span class="n">Workflow</span><span class="p">,</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">WorkflowContext</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowResult</span><span class="p">:</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">        </span><span class="sd">"""Execute a workflow with proper error handling and monitoring."""</span>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">WorkflowResult</span><span class="p">(</span><span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a>
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a>            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a>                <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a>                <span class="n">result</span><span class="o">.</span><span class="n">step_results</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_result</span>
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a>
</span><span id="__span-15-20"><a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a>                <span class="c1"># Update context with step outputs</span>
</span><span id="__span-15-21"><a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a>                <span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step_result</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
</span><span id="__span-15-22"><a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a>
</span><span id="__span-15-23"><a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a>                <span class="c1"># Publish step completion event</span>
</span><span id="__span-15-24"><a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">StepCompletedEvent</span><span class="p">(</span>
</span><span id="__span-15-25"><a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a>                    <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-15-26"><a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a>                    <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-15-27"><a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a>                    <span class="n">result</span><span class="o">=</span><span class="n">step_result</span>
</span><span id="__span-15-28"><a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a>                <span class="p">))</span>
</span><span id="__span-15-29"><a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a>
</span><span id="__span-15-30"><a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a>                <span class="c1"># Check for early termination conditions</span>
</span><span id="__span-15-31"><a href="#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a>                <span class="k">if</span> <span class="n">step_result</span><span class="o">.</span><span class="n">should_terminate</span><span class="p">:</span>
</span><span id="__span-15-32"><a href="#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a>                    <span class="k">break</span>
</span><span id="__span-15-33"><a href="#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a>
</span><span id="__span-15-34"><a href="#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a>            <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">COMPLETED</span>
</span><span id="__span-15-35"><a href="#__codelineno-15-35" id="__codelineno-15-35" name="__codelineno-15-35"></a>
</span><span id="__span-15-36"><a href="#__codelineno-15-36" id="__codelineno-15-36" name="__codelineno-15-36"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-15-37"><a href="#__codelineno-15-37" id="__codelineno-15-37" name="__codelineno-15-37"></a>            <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">FAILED</span>
</span><span id="__span-15-38"><a href="#__codelineno-15-38" id="__codelineno-15-38" name="__codelineno-15-38"></a>            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-15-39"><a href="#__codelineno-15-39" id="__codelineno-15-39" name="__codelineno-15-39"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Workflow </span><span class="si">{</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-40"><a href="#__codelineno-15-40" id="__codelineno-15-40" name="__codelineno-15-40"></a>
</span><span id="__span-15-41"><a href="#__codelineno-15-41" id="__codelineno-15-41" name="__codelineno-15-41"></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-15-42"><a href="#__codelineno-15-42" id="__codelineno-15-42" name="__codelineno-15-42"></a>            <span class="c1"># Publish workflow completion event</span>
</span><span id="__span-15-43"><a href="#__codelineno-15-43" id="__codelineno-15-43" name="__codelineno-15-43"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">WorkflowCompletedEvent</span><span class="p">(</span>
</span><span id="__span-15-44"><a href="#__codelineno-15-44" id="__codelineno-15-44" name="__codelineno-15-44"></a>                <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-15-45"><a href="#__codelineno-15-45" id="__codelineno-15-45" name="__codelineno-15-45"></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
</span><span id="__span-15-46"><a href="#__codelineno-15-46" id="__codelineno-15-46" name="__codelineno-15-46"></a>            <span class="p">))</span>
</span><span id="__span-15-47"><a href="#__codelineno-15-47" id="__codelineno-15-47" name="__codelineno-15-47"></a>
</span><span id="__span-15-48"><a href="#__codelineno-15-48" id="__codelineno-15-48" name="__codelineno-15-48"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-15-49"><a href="#__codelineno-15-49" id="__codelineno-15-49" name="__codelineno-15-49"></a>
</span><span id="__span-15-50"><a href="#__codelineno-15-50" id="__codelineno-15-50" name="__codelineno-15-50"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_step</span><span class="p">(</span>
</span><span id="__span-15-51"><a href="#__codelineno-15-51" id="__codelineno-15-51" name="__codelineno-15-51"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-15-52"><a href="#__codelineno-15-52" id="__codelineno-15-52" name="__codelineno-15-52"></a>        <span class="n">step</span><span class="p">:</span> <span class="n">WorkflowStep</span><span class="p">,</span>
</span><span id="__span-15-53"><a href="#__codelineno-15-53" id="__codelineno-15-53" name="__codelineno-15-53"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">WorkflowContext</span>
</span><span id="__span-15-54"><a href="#__codelineno-15-54" id="__codelineno-15-54" name="__codelineno-15-54"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StepResult</span><span class="p">:</span>
</span><span id="__span-15-55"><a href="#__codelineno-15-55" id="__codelineno-15-55" name="__codelineno-15-55"></a><span class="w">        </span><span class="sd">"""Execute a single workflow step."""</span>
</span><span id="__span-15-56"><a href="#__codelineno-15-56" id="__codelineno-15-56" name="__codelineno-15-56"></a>
</span><span id="__span-15-57"><a href="#__codelineno-15-57" id="__codelineno-15-57" name="__codelineno-15-57"></a>        <span class="c1"># Prepare step inputs</span>
</span><span id="__span-15-58"><a href="#__codelineno-15-58" id="__codelineno-15-58" name="__codelineno-15-58"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-15-59"><a href="#__codelineno-15-59" id="__codelineno-15-59" name="__codelineno-15-59"></a>        <span class="k">for</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
</span><span id="__span-15-60"><a href="#__codelineno-15-60" id="__codelineno-15-60" name="__codelineno-15-60"></a>            <span class="k">if</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="__span-15-61"><a href="#__codelineno-15-61" id="__codelineno-15-61" name="__codelineno-15-61"></a>                <span class="n">inputs</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
</span><span id="__span-15-62"><a href="#__codelineno-15-62" id="__codelineno-15-62" name="__codelineno-15-62"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-63"><a href="#__codelineno-15-63" id="__codelineno-15-63" name="__codelineno-15-63"></a>                <span class="k">raise</span> <span class="n">WorkflowExecutionError</span><span class="p">(</span>
</span><span id="__span-15-64"><a href="#__codelineno-15-64" id="__codelineno-15-64" name="__codelineno-15-64"></a>                    <span class="sa">f</span><span class="s2">"Required input '</span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2">' not found in context"</span>
</span><span id="__span-15-65"><a href="#__codelineno-15-65" id="__codelineno-15-65" name="__codelineno-15-65"></a>                <span class="p">)</span>
</span><span id="__span-15-66"><a href="#__codelineno-15-66" id="__codelineno-15-66" name="__codelineno-15-66"></a>
</span><span id="__span-15-67"><a href="#__codelineno-15-67" id="__codelineno-15-67" name="__codelineno-15-67"></a>        <span class="c1"># Execute step</span>
</span><span id="__span-15-68"><a href="#__codelineno-15-68" id="__codelineno-15-68" name="__codelineno-15-68"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-15-69"><a href="#__codelineno-15-69" id="__codelineno-15-69" name="__codelineno-15-69"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-70"><a href="#__codelineno-15-70" id="__codelineno-15-70" name="__codelineno-15-70"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">step</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="__span-15-71"><a href="#__codelineno-15-71" id="__codelineno-15-71" name="__codelineno-15-71"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-15-72"><a href="#__codelineno-15-72" id="__codelineno-15-72" name="__codelineno-15-72"></a>
</span><span id="__span-15-73"><a href="#__codelineno-15-73" id="__codelineno-15-73" name="__codelineno-15-73"></a>            <span class="k">return</span> <span class="n">StepResult</span><span class="p">(</span>
</span><span id="__span-15-74"><a href="#__codelineno-15-74" id="__codelineno-15-74" name="__codelineno-15-74"></a>                <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-15-75"><a href="#__codelineno-15-75" id="__codelineno-15-75" name="__codelineno-15-75"></a>                <span class="n">status</span><span class="o">=</span><span class="n">StepStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
</span><span id="__span-15-76"><a href="#__codelineno-15-76" id="__codelineno-15-76" name="__codelineno-15-76"></a>                <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
</span><span id="__span-15-77"><a href="#__codelineno-15-77" id="__codelineno-15-77" name="__codelineno-15-77"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span>
</span><span id="__span-15-78"><a href="#__codelineno-15-78" id="__codelineno-15-78" name="__codelineno-15-78"></a>            <span class="p">)</span>
</span><span id="__span-15-79"><a href="#__codelineno-15-79" id="__codelineno-15-79" name="__codelineno-15-79"></a>
</span><span id="__span-15-80"><a href="#__codelineno-15-80" id="__codelineno-15-80" name="__codelineno-15-80"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-15-81"><a href="#__codelineno-15-81" id="__codelineno-15-81" name="__codelineno-15-81"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-15-82"><a href="#__codelineno-15-82" id="__codelineno-15-82" name="__codelineno-15-82"></a>            <span class="k">return</span> <span class="n">StepResult</span><span class="p">(</span>
</span><span id="__span-15-83"><a href="#__codelineno-15-83" id="__codelineno-15-83" name="__codelineno-15-83"></a>                <span class="n">step_name</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-15-84"><a href="#__codelineno-15-84" id="__codelineno-15-84" name="__codelineno-15-84"></a>                <span class="n">status</span><span class="o">=</span><span class="n">StepStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
</span><span id="__span-15-85"><a href="#__codelineno-15-85" id="__codelineno-15-85" name="__codelineno-15-85"></a>                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-15-86"><a href="#__codelineno-15-86" id="__codelineno-15-86" name="__codelineno-15-86"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span>
</span><span id="__span-15-87"><a href="#__codelineno-15-87" id="__codelineno-15-87" name="__codelineno-15-87"></a>            <span class="p">)</span>
</span></code></pre></div> <h2 id="security-architecture">Security Architecture<a class="headerlink" href="#security-architecture" title="Permanent link">¶</a></h2> <h3 id="authentication-and-authorization">Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permanent link">¶</a></h3> <h4 id="jwt-token-architecture">JWT Token Architecture<a class="headerlink" href="#jwt-token-architecture" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Token service with refresh capability</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenService</span><span class="p">:</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"HS256"</span><span class="p">):</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">access_token_expire_minutes</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token_expire_days</span> <span class="o">=</span> <span class="mi">7</span>
</span><span id="__span-16-8"><a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a>
</span><span id="__span-16-9"><a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_token_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenPair</span><span class="p">:</span>
</span><span id="__span-16-10"><a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">        </span><span class="sd">"""Create access and refresh token pair."""</span>
</span><span id="__span-16-11"><a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a>
</span><span id="__span-16-12"><a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a>        <span class="c1"># Access token with short expiration</span>
</span><span id="__span-16-13"><a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span class="n">access_payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-14"><a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a>            <span class="s2">"sub"</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
</span><span id="__span-16-15"><a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a>            <span class="s2">"user_id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-16-16"><a href="#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a>            <span class="s2">"role"</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span><span id="__span-16-17"><a href="#__codelineno-16-17" id="__codelineno-16-17" name="__codelineno-16-17"></a>            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"access"</span><span class="p">,</span>
</span><span id="__span-16-18"><a href="#__codelineno-16-18" id="__codelineno-16-18" name="__codelineno-16-18"></a>            <span class="s2">"exp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">access_token_expire_minutes</span><span class="p">),</span>
</span><span id="__span-16-19"><a href="#__codelineno-16-19" id="__codelineno-16-19" name="__codelineno-16-19"></a>            <span class="s2">"iat"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-16-20"><a href="#__codelineno-16-20" id="__codelineno-16-20" name="__codelineno-16-20"></a>        <span class="p">}</span>
</span><span id="__span-16-21"><a href="#__codelineno-16-21" id="__codelineno-16-21" name="__codelineno-16-21"></a>
</span><span id="__span-16-22"><a href="#__codelineno-16-22" id="__codelineno-16-22" name="__codelineno-16-22"></a>        <span class="c1"># Refresh token with longer expiration</span>
</span><span id="__span-16-23"><a href="#__codelineno-16-23" id="__codelineno-16-23" name="__codelineno-16-23"></a>        <span class="n">refresh_payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-24"><a href="#__codelineno-16-24" id="__codelineno-16-24" name="__codelineno-16-24"></a>            <span class="s2">"sub"</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
</span><span id="__span-16-25"><a href="#__codelineno-16-25" id="__codelineno-16-25" name="__codelineno-16-25"></a>            <span class="s2">"user_id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-16-26"><a href="#__codelineno-16-26" id="__codelineno-16-26" name="__codelineno-16-26"></a>            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"refresh"</span><span class="p">,</span>
</span><span id="__span-16-27"><a href="#__codelineno-16-27" id="__codelineno-16-27" name="__codelineno-16-27"></a>            <span class="s2">"exp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_token_expire_days</span><span class="p">),</span>
</span><span id="__span-16-28"><a href="#__codelineno-16-28" id="__codelineno-16-28" name="__codelineno-16-28"></a>            <span class="s2">"iat"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-16-29"><a href="#__codelineno-16-29" id="__codelineno-16-29" name="__codelineno-16-29"></a>        <span class="p">}</span>
</span><span id="__span-16-30"><a href="#__codelineno-16-30" id="__codelineno-16-30" name="__codelineno-16-30"></a>
</span><span id="__span-16-31"><a href="#__codelineno-16-31" id="__codelineno-16-31" name="__codelineno-16-31"></a>        <span class="n">access_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">access_payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</span><span id="__span-16-32"><a href="#__codelineno-16-32" id="__codelineno-16-32" name="__codelineno-16-32"></a>        <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">refresh_payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</span><span id="__span-16-33"><a href="#__codelineno-16-33" id="__codelineno-16-33" name="__codelineno-16-33"></a>
</span><span id="__span-16-34"><a href="#__codelineno-16-34" id="__codelineno-16-34" name="__codelineno-16-34"></a>        <span class="k">return</span> <span class="n">TokenPair</span><span class="p">(</span>
</span><span id="__span-16-35"><a href="#__codelineno-16-35" id="__codelineno-16-35" name="__codelineno-16-35"></a>            <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
</span><span id="__span-16-36"><a href="#__codelineno-16-36" id="__codelineno-16-36" name="__codelineno-16-36"></a>            <span class="n">refresh_token</span><span class="o">=</span><span class="n">refresh_token</span><span class="p">,</span>
</span><span id="__span-16-37"><a href="#__codelineno-16-37" id="__codelineno-16-37" name="__codelineno-16-37"></a>            <span class="n">token_type</span><span class="o">=</span><span class="s2">"bearer"</span><span class="p">,</span>
</span><span id="__span-16-38"><a href="#__codelineno-16-38" id="__codelineno-16-38" name="__codelineno-16-38"></a>            <span class="n">expires_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">access_token_expire_minutes</span> <span class="o">*</span> <span class="mi">60</span>
</span><span id="__span-16-39"><a href="#__codelineno-16-39" id="__codelineno-16-39" name="__codelineno-16-39"></a>        <span class="p">)</span>
</span><span id="__span-16-40"><a href="#__codelineno-16-40" id="__codelineno-16-40" name="__codelineno-16-40"></a>
</span><span id="__span-16-41"><a href="#__codelineno-16-41" id="__codelineno-16-41" name="__codelineno-16-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"access"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="__span-16-42"><a href="#__codelineno-16-42" id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">        </span><span class="sd">"""Verify and decode a JWT token."""</span>
</span><span id="__span-16-43"><a href="#__codelineno-16-43" id="__codelineno-16-43" name="__codelineno-16-43"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-16-44"><a href="#__codelineno-16-44" id="__codelineno-16-44" name="__codelineno-16-44"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">])</span>
</span><span id="__span-16-45"><a href="#__codelineno-16-45" id="__codelineno-16-45" name="__codelineno-16-45"></a>
</span><span id="__span-16-46"><a href="#__codelineno-16-46" id="__codelineno-16-46" name="__codelineno-16-46"></a>            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">token_type</span><span class="p">:</span>
</span><span id="__span-16-47"><a href="#__codelineno-16-47" id="__codelineno-16-47" name="__codelineno-16-47"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-16-48"><a href="#__codelineno-16-48" id="__codelineno-16-48" name="__codelineno-16-48"></a>
</span><span id="__span-16-49"><a href="#__codelineno-16-49" id="__codelineno-16-49" name="__codelineno-16-49"></a>            <span class="k">return</span> <span class="n">payload</span>
</span><span id="__span-16-50"><a href="#__codelineno-16-50" id="__codelineno-16-50" name="__codelineno-16-50"></a>
</span><span id="__span-16-51"><a href="#__codelineno-16-51" id="__codelineno-16-51" name="__codelineno-16-51"></a>        <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
</span><span id="__span-16-52"><a href="#__codelineno-16-52" id="__codelineno-16-52" name="__codelineno-16-52"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-16-53"><a href="#__codelineno-16-53" id="__codelineno-16-53" name="__codelineno-16-53"></a>
</span><span id="__span-16-54"><a href="#__codelineno-16-54" id="__codelineno-16-54" name="__codelineno-16-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-16-55"><a href="#__codelineno-16-55" id="__codelineno-16-55" name="__codelineno-16-55"></a><span class="w">        </span><span class="sd">"""Generate new access token from valid refresh token."""</span>
</span><span id="__span-16-56"><a href="#__codelineno-16-56" id="__codelineno-16-56" name="__codelineno-16-56"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">,</span> <span class="s2">"refresh"</span><span class="p">)</span>
</span><span id="__span-16-57"><a href="#__codelineno-16-57" id="__codelineno-16-57" name="__codelineno-16-57"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
</span><span id="__span-16-58"><a href="#__codelineno-16-58" id="__codelineno-16-58" name="__codelineno-16-58"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-16-59"><a href="#__codelineno-16-59" id="__codelineno-16-59" name="__codelineno-16-59"></a>
</span><span id="__span-16-60"><a href="#__codelineno-16-60" id="__codelineno-16-60" name="__codelineno-16-60"></a>        <span class="c1"># Create new access token</span>
</span><span id="__span-16-61"><a href="#__codelineno-16-61" id="__codelineno-16-61" name="__codelineno-16-61"></a>        <span class="n">access_payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-62"><a href="#__codelineno-16-62" id="__codelineno-16-62" name="__codelineno-16-62"></a>            <span class="s2">"sub"</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">"sub"</span><span class="p">],</span>
</span><span id="__span-16-63"><a href="#__codelineno-16-63" id="__codelineno-16-63" name="__codelineno-16-63"></a>            <span class="s2">"user_id"</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">],</span>
</span><span id="__span-16-64"><a href="#__codelineno-16-64" id="__codelineno-16-64" name="__codelineno-16-64"></a>            <span class="s2">"role"</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">"role"</span><span class="p">],</span>
</span><span id="__span-16-65"><a href="#__codelineno-16-65" id="__codelineno-16-65" name="__codelineno-16-65"></a>            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"access"</span><span class="p">,</span>
</span><span id="__span-16-66"><a href="#__codelineno-16-66" id="__codelineno-16-66" name="__codelineno-16-66"></a>            <span class="s2">"exp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">access_token_expire_minutes</span><span class="p">),</span>
</span><span id="__span-16-67"><a href="#__codelineno-16-67" id="__codelineno-16-67" name="__codelineno-16-67"></a>            <span class="s2">"iat"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-16-68"><a href="#__codelineno-16-68" id="__codelineno-16-68" name="__codelineno-16-68"></a>        <span class="p">}</span>
</span><span id="__span-16-69"><a href="#__codelineno-16-69" id="__codelineno-16-69" name="__codelineno-16-69"></a>
</span><span id="__span-16-70"><a href="#__codelineno-16-70" id="__codelineno-16-70" name="__codelineno-16-70"></a>        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">access_payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</span></code></pre></div> <h4 id="role-based-access-control-rbac">Role-Based Access Control (RBAC)<a class="headerlink" href="#role-based-access-control-rbac" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># Permission system</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>    <span class="n">READ_OWN_PROFILE</span> <span class="o">=</span> <span class="s2">"read:own_profile"</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>    <span class="n">UPDATE_OWN_PROFILE</span> <span class="o">=</span> <span class="s2">"update:own_profile"</span>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>    <span class="n">READ_STUDENTS</span> <span class="o">=</span> <span class="s2">"read:students"</span>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>    <span class="n">MANAGE_CLASSES</span> <span class="o">=</span> <span class="s2">"manage:classes"</span>
</span><span id="__span-17-7"><a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a>    <span class="n">CREATE_CONTENT</span> <span class="o">=</span> <span class="s2">"create:content"</span>
</span><span id="__span-17-8"><a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>    <span class="n">MODERATE_CONTENT</span> <span class="o">=</span> <span class="s2">"moderate:content"</span>
</span><span id="__span-17-9"><a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>    <span class="n">ADMIN_USERS</span> <span class="o">=</span> <span class="s2">"admin:users"</span>
</span><span id="__span-17-10"><a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a>    <span class="n">ADMIN_SYSTEM</span> <span class="o">=</span> <span class="s2">"admin:system"</span>
</span><span id="__span-17-11"><a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a>
</span><span id="__span-17-12"><a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-17-13"><a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a>    <span class="n">STUDENT</span> <span class="o">=</span> <span class="s2">"student"</span>
</span><span id="__span-17-14"><a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a>    <span class="n">TEACHER</span> <span class="o">=</span> <span class="s2">"teacher"</span>
</span><span id="__span-17-15"><a href="#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a>    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">"admin"</span>
</span><span id="__span-17-16"><a href="#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a>    <span class="n">PARENT</span> <span class="o">=</span> <span class="s2">"parent"</span>
</span><span id="__span-17-17"><a href="#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a>
</span><span id="__span-17-18"><a href="#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="c1"># Role-permission mapping</span>
</span><span id="__span-17-19"><a href="#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="n">ROLE_PERMISSIONS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-20"><a href="#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a>    <span class="n">Role</span><span class="o">.</span><span class="n">STUDENT</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-17-21"><a href="#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">READ_OWN_PROFILE</span><span class="p">,</span>
</span><span id="__span-17-22"><a href="#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_OWN_PROFILE</span>
</span><span id="__span-17-23"><a href="#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a>    <span class="p">],</span>
</span><span id="__span-17-24"><a href="#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a>    <span class="n">Role</span><span class="o">.</span><span class="n">TEACHER</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-17-25"><a href="#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">READ_OWN_PROFILE</span><span class="p">,</span>
</span><span id="__span-17-26"><a href="#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_OWN_PROFILE</span><span class="p">,</span>
</span><span id="__span-17-27"><a href="#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">READ_STUDENTS</span><span class="p">,</span>
</span><span id="__span-17-28"><a href="#__codelineno-17-28" id="__codelineno-17-28" name="__codelineno-17-28"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">MANAGE_CLASSES</span><span class="p">,</span>
</span><span id="__span-17-29"><a href="#__codelineno-17-29" id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">CREATE_CONTENT</span>
</span><span id="__span-17-30"><a href="#__codelineno-17-30" id="__codelineno-17-30" name="__codelineno-17-30"></a>    <span class="p">],</span>
</span><span id="__span-17-31"><a href="#__codelineno-17-31" id="__codelineno-17-31" name="__codelineno-17-31"></a>    <span class="n">Role</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-17-32"><a href="#__codelineno-17-32" id="__codelineno-17-32" name="__codelineno-17-32"></a>        <span class="c1"># Admins get all permissions</span>
</span><span id="__span-17-33"><a href="#__codelineno-17-33" id="__codelineno-17-33" name="__codelineno-17-33"></a>        <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">Permission</span><span class="p">)</span>
</span><span id="__span-17-34"><a href="#__codelineno-17-34" id="__codelineno-17-34" name="__codelineno-17-34"></a>    <span class="p">],</span>
</span><span id="__span-17-35"><a href="#__codelineno-17-35" id="__codelineno-17-35" name="__codelineno-17-35"></a>    <span class="n">Role</span><span class="o">.</span><span class="n">PARENT</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-17-36"><a href="#__codelineno-17-36" id="__codelineno-17-36" name="__codelineno-17-36"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">READ_OWN_PROFILE</span><span class="p">,</span>
</span><span id="__span-17-37"><a href="#__codelineno-17-37" id="__codelineno-17-37" name="__codelineno-17-37"></a>        <span class="n">Permission</span><span class="o">.</span><span class="n">UPDATE_OWN_PROFILE</span><span class="p">,</span>
</span><span id="__span-17-38"><a href="#__codelineno-17-38" id="__codelineno-17-38" name="__codelineno-17-38"></a>        <span class="c1"># Can read children's data (implemented in business logic)</span>
</span><span id="__span-17-39"><a href="#__codelineno-17-39" id="__codelineno-17-39" name="__codelineno-17-39"></a>    <span class="p">]</span>
</span><span id="__span-17-40"><a href="#__codelineno-17-40" id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="p">}</span>
</span><span id="__span-17-41"><a href="#__codelineno-17-41" id="__codelineno-17-41" name="__codelineno-17-41"></a>
</span><span id="__span-17-42"><a href="#__codelineno-17-42" id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="c1"># Authorization service</span>
</span><span id="__span-17-43"><a href="#__codelineno-17-43" id="__codelineno-17-43" name="__codelineno-17-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthorizationService</span><span class="p">:</span>
</span><span id="__span-17-44"><a href="#__codelineno-17-44" id="__codelineno-17-44" name="__codelineno-17-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">user_has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-17-45"><a href="#__codelineno-17-45" id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">        </span><span class="sd">"""Check if user has specific permission."""</span>
</span><span id="__span-17-46"><a href="#__codelineno-17-46" id="__codelineno-17-46" name="__codelineno-17-46"></a>        <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
</span><span id="__span-17-47"><a href="#__codelineno-17-47" id="__codelineno-17-47" name="__codelineno-17-47"></a>        <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="n">ROLE_PERMISSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_role</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-17-48"><a href="#__codelineno-17-48" id="__codelineno-17-48" name="__codelineno-17-48"></a>
</span><span id="__span-17-49"><a href="#__codelineno-17-49" id="__codelineno-17-49" name="__codelineno-17-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">require_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">):</span>
</span><span id="__span-17-50"><a href="#__codelineno-17-50" id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="w">        </span><span class="sd">"""Dependency to require specific permission."""</span>
</span><span id="__span-17-51"><a href="#__codelineno-17-51" id="__codelineno-17-51" name="__codelineno-17-51"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">permission_checker</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
</span><span id="__span-17-52"><a href="#__codelineno-17-52" id="__codelineno-17-52" name="__codelineno-17-52"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_permission</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
</span><span id="__span-17-53"><a href="#__codelineno-17-53" id="__codelineno-17-53" name="__codelineno-17-53"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-17-54"><a href="#__codelineno-17-54" id="__codelineno-17-54" name="__codelineno-17-54"></a>                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
</span><span id="__span-17-55"><a href="#__codelineno-17-55" id="__codelineno-17-55" name="__codelineno-17-55"></a>                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Permission '</span><span class="si">{</span><span class="n">permission</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">' required"</span>
</span><span id="__span-17-56"><a href="#__codelineno-17-56" id="__codelineno-17-56" name="__codelineno-17-56"></a>                <span class="p">)</span>
</span><span id="__span-17-57"><a href="#__codelineno-17-57" id="__codelineno-17-57" name="__codelineno-17-57"></a>            <span class="k">return</span> <span class="n">current_user</span>
</span><span id="__span-17-58"><a href="#__codelineno-17-58" id="__codelineno-17-58" name="__codelineno-17-58"></a>        <span class="k">return</span> <span class="n">permission_checker</span>
</span><span id="__span-17-59"><a href="#__codelineno-17-59" id="__codelineno-17-59" name="__codelineno-17-59"></a>
</span><span id="__span-17-60"><a href="#__codelineno-17-60" id="__codelineno-17-60" name="__codelineno-17-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">can_access_resource</span><span class="p">(</span>
</span><span id="__span-17-61"><a href="#__codelineno-17-61" id="__codelineno-17-61" name="__codelineno-17-61"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-17-62"><a href="#__codelineno-17-62" id="__codelineno-17-62" name="__codelineno-17-62"></a>        <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span>
</span><span id="__span-17-63"><a href="#__codelineno-17-63" id="__codelineno-17-63" name="__codelineno-17-63"></a>        <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-17-64"><a href="#__codelineno-17-64" id="__codelineno-17-64" name="__codelineno-17-64"></a>        <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-17-65"><a href="#__codelineno-17-65" id="__codelineno-17-65" name="__codelineno-17-65"></a>        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-17-66"><a href="#__codelineno-17-66" id="__codelineno-17-66" name="__codelineno-17-66"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-17-67"><a href="#__codelineno-17-67" id="__codelineno-17-67" name="__codelineno-17-67"></a><span class="w">        </span><span class="sd">"""Check if user can perform action on specific resource."""</span>
</span><span id="__span-17-68"><a href="#__codelineno-17-68" id="__codelineno-17-68" name="__codelineno-17-68"></a>
</span><span id="__span-17-69"><a href="#__codelineno-17-69" id="__codelineno-17-69" name="__codelineno-17-69"></a>        <span class="c1"># Resource-specific access control logic</span>
</span><span id="__span-17-70"><a href="#__codelineno-17-70" id="__codelineno-17-70" name="__codelineno-17-70"></a>        <span class="k">if</span> <span class="n">resource_type</span> <span class="o">==</span> <span class="s2">"student_data"</span><span class="p">:</span>
</span><span id="__span-17-71"><a href="#__codelineno-17-71" id="__codelineno-17-71" name="__codelineno-17-71"></a>            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">"teacher"</span><span class="p">:</span>
</span><span id="__span-17-72"><a href="#__codelineno-17-72" id="__codelineno-17-72" name="__codelineno-17-72"></a>                <span class="c1"># Teachers can access their students' data</span>
</span><span id="__span-17-73"><a href="#__codelineno-17-73" id="__codelineno-17-73" name="__codelineno-17-73"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_teacher_of_student</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)</span>
</span><span id="__span-17-74"><a href="#__codelineno-17-74" id="__codelineno-17-74" name="__codelineno-17-74"></a>            <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">"parent"</span><span class="p">:</span>
</span><span id="__span-17-75"><a href="#__codelineno-17-75" id="__codelineno-17-75" name="__codelineno-17-75"></a>                <span class="c1"># Parents can access their children's data</span>
</span><span id="__span-17-76"><a href="#__codelineno-17-76" id="__codelineno-17-76" name="__codelineno-17-76"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_parent_of_student</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)</span>
</span><span id="__span-17-77"><a href="#__codelineno-17-77" id="__codelineno-17-77" name="__codelineno-17-77"></a>            <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">:</span>
</span><span id="__span-17-78"><a href="#__codelineno-17-78" id="__codelineno-17-78" name="__codelineno-17-78"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-17-79"><a href="#__codelineno-17-79" id="__codelineno-17-79" name="__codelineno-17-79"></a>            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">resource_id</span><span class="p">:</span>
</span><span id="__span-17-80"><a href="#__codelineno-17-80" id="__codelineno-17-80" name="__codelineno-17-80"></a>                <span class="c1"># Users can access their own data</span>
</span><span id="__span-17-81"><a href="#__codelineno-17-81" id="__codelineno-17-81" name="__codelineno-17-81"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-17-82"><a href="#__codelineno-17-82" id="__codelineno-17-82" name="__codelineno-17-82"></a>
</span><span id="__span-17-83"><a href="#__codelineno-17-83" id="__codelineno-17-83" name="__codelineno-17-83"></a>        <span class="k">return</span> <span class="kc">False</span>
</span></code></pre></div> <h3 id="data-protection-and-privacy">Data Protection and Privacy<a class="headerlink" href="#data-protection-and-privacy" title="Permanent link">¶</a></h3> <h4 id="data-encryption">Data Encryption<a class="headerlink" href="#data-encryption" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># Field-level encryption for sensitive data</span>
</span><span id="__span-18-2"><a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EncryptedField</span><span class="p">:</span>
</span><span id="__span-18-3"><a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type</span><span class="o">=</span><span class="n">String</span><span class="p">,</span> <span class="n">encryption_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-18-4"><a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field_type</span> <span class="o">=</span> <span class="n">field_type</span>
</span><span id="__span-18-5"><a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_key</span> <span class="o">=</span> <span class="n">encryption_key</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">field_encryption_key</span>
</span><span id="__span-18-6"><a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encryption_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span id="__span-18-7"><a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a>
</span><span id="__span-18-8"><a href="#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
</span><span id="__span-18-9"><a href="#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">        </span><span class="sd">"""Encrypt value before storing in database."""</span>
</span><span id="__span-18-10"><a href="#__codelineno-18-10" id="__codelineno-18-10" name="__codelineno-18-10"></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-11"><a href="#__codelineno-18-11" id="__codelineno-18-11" name="__codelineno-18-11"></a>            <span class="n">encrypted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span id="__span-18-12"><a href="#__codelineno-18-12" id="__codelineno-18-12" name="__codelineno-18-12"></a>            <span class="k">return</span> <span class="n">encrypted_value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="__span-18-13"><a href="#__codelineno-18-13" id="__codelineno-18-13" name="__codelineno-18-13"></a>        <span class="k">return</span> <span class="n">value</span>
</span><span id="__span-18-14"><a href="#__codelineno-18-14" id="__codelineno-18-14" name="__codelineno-18-14"></a>
</span><span id="__span-18-15"><a href="#__codelineno-18-15" id="__codelineno-18-15" name="__codelineno-18-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
</span><span id="__span-18-16"><a href="#__codelineno-18-16" id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">        </span><span class="sd">"""Decrypt value after retrieving from database."""</span>
</span><span id="__span-18-17"><a href="#__codelineno-18-17" id="__codelineno-18-17" name="__codelineno-18-17"></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-18-18"><a href="#__codelineno-18-18" id="__codelineno-18-18" name="__codelineno-18-18"></a>            <span class="n">decrypted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span id="__span-18-19"><a href="#__codelineno-18-19" id="__codelineno-18-19" name="__codelineno-18-19"></a>            <span class="k">return</span> <span class="n">decrypted_value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="__span-18-20"><a href="#__codelineno-18-20" id="__codelineno-18-20" name="__codelineno-18-20"></a>        <span class="k">return</span> <span class="n">value</span>
</span><span id="__span-18-21"><a href="#__codelineno-18-21" id="__codelineno-18-21" name="__codelineno-18-21"></a>
</span><span id="__span-18-22"><a href="#__codelineno-18-22" id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="c1"># Usage in models</span>
</span><span id="__span-18-23"><a href="#__codelineno-18-23" id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span id="__span-18-24"><a href="#__codelineno-18-24" id="__codelineno-18-24" name="__codelineno-18-24"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"students"</span>
</span><span id="__span-18-25"><a href="#__codelineno-18-25" id="__codelineno-18-25" name="__codelineno-18-25"></a>
</span><span id="__span-18-26"><a href="#__codelineno-18-26" id="__codelineno-18-26" name="__codelineno-18-26"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UUID</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-18-27"><a href="#__codelineno-18-27" id="__codelineno-18-27" name="__codelineno-18-27"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-18-28"><a href="#__codelineno-18-28" id="__codelineno-18-28" name="__codelineno-18-28"></a>    <span class="c1"># Encrypt sensitive personal information</span>
</span><span id="__span-18-29"><a href="#__codelineno-18-29" id="__codelineno-18-29" name="__codelineno-18-29"></a>    <span class="n">ssn</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">EncryptedField</span><span class="p">())</span>
</span><span id="__span-18-30"><a href="#__codelineno-18-30" id="__codelineno-18-30" name="__codelineno-18-30"></a>    <span class="n">parent_contact</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">EncryptedField</span><span class="p">())</span>
</span></code></pre></div> <h4 id="audit-logging">Audit Logging<a class="headerlink" href="#audit-logging" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1"># Audit logging system</span>
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuditLogger</span><span class="p">:</span>
</span><span id="__span-19-3"><a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
</span><span id="__span-19-4"><a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
</span><span id="__span-19-5"><a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a>
</span><span id="__span-19-6"><a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_action</span><span class="p">(</span>
</span><span id="__span-19-7"><a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-19-8"><a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-19-9"><a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a>        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-19-10"><a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a>        <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-19-11"><a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a>        <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-19-12"><a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a>        <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-13"><a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>        <span class="n">ip_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-14"><a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>    <span class="p">):</span>
</span><span id="__span-19-15"><a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">        </span><span class="sd">"""Log user action for audit trail."""</span>
</span><span id="__span-19-16"><a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a>
</span><span id="__span-19-17"><a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="n">audit_entry</span> <span class="o">=</span> <span class="n">AuditLog</span><span class="p">(</span>
</span><span id="__span-19-18"><a href="#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a>            <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="__span-19-19"><a href="#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-19-20"><a href="#__codelineno-19-20" id="__codelineno-19-20" name="__codelineno-19-20"></a>            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
</span><span id="__span-19-21"><a href="#__codelineno-19-21" id="__codelineno-19-21" name="__codelineno-19-21"></a>            <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
</span><span id="__span-19-22"><a href="#__codelineno-19-22" id="__codelineno-19-22" name="__codelineno-19-22"></a>            <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
</span><span id="__span-19-23"><a href="#__codelineno-19-23" id="__codelineno-19-23" name="__codelineno-19-23"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="__span-19-24"><a href="#__codelineno-19-24" id="__codelineno-19-24" name="__codelineno-19-24"></a>            <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="__span-19-25"><a href="#__codelineno-19-25" id="__codelineno-19-25" name="__codelineno-19-25"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-19-26"><a href="#__codelineno-19-26" id="__codelineno-19-26" name="__codelineno-19-26"></a>        <span class="p">)</span>
</span><span id="__span-19-27"><a href="#__codelineno-19-27" id="__codelineno-19-27" name="__codelineno-19-27"></a>
</span><span id="__span-19-28"><a href="#__codelineno-19-28" id="__codelineno-19-28" name="__codelineno-19-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">audit_entry</span><span class="p">)</span>
</span><span id="__span-19-29"><a href="#__codelineno-19-29" id="__codelineno-19-29" name="__codelineno-19-29"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-19-30"><a href="#__codelineno-19-30" id="__codelineno-19-30" name="__codelineno-19-30"></a>
</span><span id="__span-19-31"><a href="#__codelineno-19-31" id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="c1"># Audit middleware</span>
</span><span id="__span-19-32"><a href="#__codelineno-19-32" id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">"http"</span><span class="p">)</span>
</span><span id="__span-19-33"><a href="#__codelineno-19-33" id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">audit_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
</span><span id="__span-19-34"><a href="#__codelineno-19-34" id="__codelineno-19-34" name="__codelineno-19-34"></a><span class="w">    </span><span class="sd">"""Log all API requests for audit purposes."""</span>
</span><span id="__span-19-35"><a href="#__codelineno-19-35" id="__codelineno-19-35" name="__codelineno-19-35"></a>
</span><span id="__span-19-36"><a href="#__codelineno-19-36" id="__codelineno-19-36" name="__codelineno-19-36"></a>    <span class="c1"># Skip health checks and static files</span>
</span><span id="__span-19-37"><a href="#__codelineno-19-37" id="__codelineno-19-37" name="__codelineno-19-37"></a>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"/health"</span><span class="p">,</span> <span class="s2">"/metrics"</span><span class="p">]</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"/static"</span><span class="p">):</span>
</span><span id="__span-19-38"><a href="#__codelineno-19-38" id="__codelineno-19-38" name="__codelineno-19-38"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span id="__span-19-39"><a href="#__codelineno-19-39" id="__codelineno-19-39" name="__codelineno-19-39"></a>
</span><span id="__span-19-40"><a href="#__codelineno-19-40" id="__codelineno-19-40" name="__codelineno-19-40"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-19-41"><a href="#__codelineno-19-41" id="__codelineno-19-41" name="__codelineno-19-41"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span id="__span-19-42"><a href="#__codelineno-19-42" id="__codelineno-19-42" name="__codelineno-19-42"></a>    <span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-19-43"><a href="#__codelineno-19-43" id="__codelineno-19-43" name="__codelineno-19-43"></a>
</span><span id="__span-19-44"><a href="#__codelineno-19-44" id="__codelineno-19-44" name="__codelineno-19-44"></a>    <span class="c1"># Log request details</span>
</span><span id="__span-19-45"><a href="#__codelineno-19-45" id="__codelineno-19-45" name="__codelineno-19-45"></a>    <span class="n">audit_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-19-46"><a href="#__codelineno-19-46" id="__codelineno-19-46" name="__codelineno-19-46"></a>        <span class="s2">"method"</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-19-47"><a href="#__codelineno-19-47" id="__codelineno-19-47" name="__codelineno-19-47"></a>        <span class="s2">"url"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
</span><span id="__span-19-48"><a href="#__codelineno-19-48" id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="s2">"status_code"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="__span-19-49"><a href="#__codelineno-19-49" id="__codelineno-19-49" name="__codelineno-19-49"></a>        <span class="s2">"process_time"</span><span class="p">:</span> <span class="n">process_time</span><span class="p">,</span>
</span><span id="__span-19-50"><a href="#__codelineno-19-50" id="__codelineno-19-50" name="__codelineno-19-50"></a>        <span class="s2">"user_agent"</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user-agent"</span><span class="p">),</span>
</span><span id="__span-19-51"><a href="#__codelineno-19-51" id="__codelineno-19-51" name="__codelineno-19-51"></a>        <span class="s2">"ip_address"</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-19-52"><a href="#__codelineno-19-52" id="__codelineno-19-52" name="__codelineno-19-52"></a>    <span class="p">}</span>
</span><span id="__span-19-53"><a href="#__codelineno-19-53" id="__codelineno-19-53" name="__codelineno-19-53"></a>
</span><span id="__span-19-54"><a href="#__codelineno-19-54" id="__codelineno-19-54" name="__codelineno-19-54"></a>    <span class="c1"># Add user context if available</span>
</span><span id="__span-19-55"><a href="#__codelineno-19-55" id="__codelineno-19-55" name="__codelineno-19-55"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">"user"</span><span class="p">):</span>
</span><span id="__span-19-56"><a href="#__codelineno-19-56" id="__codelineno-19-56" name="__codelineno-19-56"></a>        <span class="n">audit_data</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-19-57"><a href="#__codelineno-19-57" id="__codelineno-19-57" name="__codelineno-19-57"></a>
</span><span id="__span-19-58"><a href="#__codelineno-19-58" id="__codelineno-19-58" name="__codelineno-19-58"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"API Request"</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">audit_data</span><span class="p">)</span>
</span><span id="__span-19-59"><a href="#__codelineno-19-59" id="__codelineno-19-59" name="__codelineno-19-59"></a>
</span><span id="__span-19-60"><a href="#__codelineno-19-60" id="__codelineno-19-60" name="__codelineno-19-60"></a>    <span class="k">return</span> <span class="n">response</span>
</span></code></pre></div> <h2 id="scalability-and-performance">Scalability and Performance<a class="headerlink" href="#scalability-and-performance" title="Permanent link">¶</a></h2> <h3 id="horizontal-scaling-architecture">Horizontal Scaling Architecture<a class="headerlink" href="#horizontal-scaling-architecture" title="Permanent link">¶</a></h3> <h4 id="database-scaling-strategy">Database Scaling Strategy<a class="headerlink" href="#database-scaling-strategy" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1"># Database read/write splitting</span>
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseRouter</span><span class="p">:</span>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">write_database_url</span><span class="p">)</span>
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">read_engines</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>            <span class="n">create_async_engine</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">read_database_urls</span>
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>        <span class="p">]</span>
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_read_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_write_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSession</span><span class="p">:</span>
</span><span id="__span-20-11"><a href="#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span><span class="sd">"""Get session for write operations."""</span>
</span><span id="__span-20-12"><a href="#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a>        <span class="k">return</span> <span class="n">AsyncSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_engine</span><span class="p">)</span>
</span><span id="__span-20-13"><a href="#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a>
</span><span id="__span-20-14"><a href="#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_read_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncSession</span><span class="p">:</span>
</span><span id="__span-20-15"><a href="#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">        </span><span class="sd">"""Get session for read operations with load balancing."""</span>
</span><span id="__span-20-16"><a href="#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a>        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_engines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_read_index</span><span class="p">]</span>
</span><span id="__span-20-17"><a href="#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_read_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_read_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_engines</span><span class="p">)</span>
</span><span id="__span-20-18"><a href="#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>        <span class="k">return</span> <span class="n">AsyncSession</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span><span id="__span-20-19"><a href="#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a>
</span><span id="__span-20-20"><a href="#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="c1"># Repository with read/write splitting</span>
</span><span id="__span-20-21"><a href="#__codelineno-20-21" id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScalableRepository</span><span class="p">(</span><span class="n">BaseRepository</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-20-22"><a href="#__codelineno-20-22" id="__codelineno-20-22" name="__codelineno-20-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_router</span><span class="p">:</span> <span class="n">DatabaseRouter</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
</span><span id="__span-20-23"><a href="#__codelineno-20-23" id="__codelineno-20-23" name="__codelineno-20-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_router</span> <span class="o">=</span> <span class="n">db_router</span>
</span><span id="__span-20-24"><a href="#__codelineno-20-24" id="__codelineno-20-24" name="__codelineno-20-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="__span-20-25"><a href="#__codelineno-20-25" id="__codelineno-20-25" name="__codelineno-20-25"></a>
</span><span id="__span-20-26"><a href="#__codelineno-20-26" id="__codelineno-20-26" name="__codelineno-20-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
</span><span id="__span-20-27"><a href="#__codelineno-20-27" id="__codelineno-20-27" name="__codelineno-20-27"></a><span class="w">        </span><span class="sd">"""Read operation - use read replica."""</span>
</span><span id="__span-20-28"><a href="#__codelineno-20-28" id="__codelineno-20-28" name="__codelineno-20-28"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_router</span><span class="o">.</span><span class="n">get_read_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-20-29"><a href="#__codelineno-20-29" id="__codelineno-20-29" name="__codelineno-20-29"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="__span-20-30"><a href="#__codelineno-20-30" id="__codelineno-20-30" name="__codelineno-20-30"></a>
</span><span id="__span-20-31"><a href="#__codelineno-20-31" id="__codelineno-20-31" name="__codelineno-20-31"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="__span-20-32"><a href="#__codelineno-20-32" id="__codelineno-20-32" name="__codelineno-20-32"></a><span class="w">        </span><span class="sd">"""Write operation - use primary database."""</span>
</span><span id="__span-20-33"><a href="#__codelineno-20-33" id="__codelineno-20-33" name="__codelineno-20-33"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_router</span><span class="o">.</span><span class="n">get_write_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-20-34"><a href="#__codelineno-20-34" id="__codelineno-20-34" name="__codelineno-20-34"></a>            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-20-35"><a href="#__codelineno-20-35" id="__codelineno-20-35" name="__codelineno-20-35"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-20-36"><a href="#__codelineno-20-36" id="__codelineno-20-36" name="__codelineno-20-36"></a>            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="__span-20-37"><a href="#__codelineno-20-37" id="__codelineno-20-37" name="__codelineno-20-37"></a>            <span class="k">return</span> <span class="n">entity</span>
</span></code></pre></div> <h4 id="caching-architecture">Caching Architecture<a class="headerlink" href="#caching-architecture" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1"># Multi-level caching system</span>
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CacheManager</span><span class="p">:</span>
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-21-4"><a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a>        <span class="c1"># L1: In-memory cache (fastest, smallest)</span>
</span><span id="__span-21-5"><a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span> <span class="o">=</span> <span class="n">TTLCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 minutes</span>
</span><span id="__span-21-6"><a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a>
</span><span id="__span-21-7"><a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a>        <span class="c1"># L2: Redis cache (fast, larger)</span>
</span><span id="__span-21-8"><a href="#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">redis_url</span><span class="p">)</span>
</span><span id="__span-21-9"><a href="#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a>
</span><span id="__span-21-10"><a href="#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a>        <span class="c1"># L3: Database (slowest, largest)</span>
</span><span id="__span-21-11"><a href="#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">DatabaseService</span><span class="p">()</span>
</span><span id="__span-21-12"><a href="#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a>
</span><span id="__span-21-13"><a href="#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-21-14"><a href="#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="w">        </span><span class="sd">"""Get value with cache hierarchy."""</span>
</span><span id="__span-21-15"><a href="#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a>
</span><span id="__span-21-16"><a href="#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a>        <span class="c1"># Try L1 cache first</span>
</span><span id="__span-21-17"><a href="#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
</span><span id="__span-21-18"><a href="#__codelineno-21-18" id="__codelineno-21-18" name="__codelineno-21-18"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="__span-21-19"><a href="#__codelineno-21-19" id="__codelineno-21-19" name="__codelineno-21-19"></a>
</span><span id="__span-21-20"><a href="#__codelineno-21-20" id="__codelineno-21-20" name="__codelineno-21-20"></a>        <span class="c1"># Try L2 cache</span>
</span><span id="__span-21-21"><a href="#__codelineno-21-21" id="__codelineno-21-21" name="__codelineno-21-21"></a>        <span class="n">l2_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="__span-21-22"><a href="#__codelineno-21-22" id="__codelineno-21-22" name="__codelineno-21-22"></a>        <span class="k">if</span> <span class="n">l2_value</span><span class="p">:</span>
</span><span id="__span-21-23"><a href="#__codelineno-21-23" id="__codelineno-21-23" name="__codelineno-21-23"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">l2_value</span><span class="p">)</span>
</span><span id="__span-21-24"><a href="#__codelineno-21-24" id="__codelineno-21-24" name="__codelineno-21-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># Populate L1</span>
</span><span id="__span-21-25"><a href="#__codelineno-21-25" id="__codelineno-21-25" name="__codelineno-21-25"></a>            <span class="k">return</span> <span class="n">value</span>
</span><span id="__span-21-26"><a href="#__codelineno-21-26" id="__codelineno-21-26" name="__codelineno-21-26"></a>
</span><span id="__span-21-27"><a href="#__codelineno-21-27" id="__codelineno-21-27" name="__codelineno-21-27"></a>        <span class="c1"># Fall back to database</span>
</span><span id="__span-21-28"><a href="#__codelineno-21-28" id="__codelineno-21-28" name="__codelineno-21-28"></a>        <span class="n">value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="__span-21-29"><a href="#__codelineno-21-29" id="__codelineno-21-29" name="__codelineno-21-29"></a>        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span id="__span-21-30"><a href="#__codelineno-21-30" id="__codelineno-21-30" name="__codelineno-21-30"></a>            <span class="c1"># Populate both cache levels</span>
</span><span id="__span-21-31"><a href="#__codelineno-21-31" id="__codelineno-21-31" name="__codelineno-21-31"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># 30 minutes</span>
</span><span id="__span-21-32"><a href="#__codelineno-21-32" id="__codelineno-21-32" name="__codelineno-21-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-21-33"><a href="#__codelineno-21-33" id="__codelineno-21-33" name="__codelineno-21-33"></a>
</span><span id="__span-21-34"><a href="#__codelineno-21-34" id="__codelineno-21-34" name="__codelineno-21-34"></a>        <span class="k">return</span> <span class="n">value</span>
</span><span id="__span-21-35"><a href="#__codelineno-21-35" id="__codelineno-21-35" name="__codelineno-21-35"></a>
</span><span id="__span-21-36"><a href="#__codelineno-21-36" id="__codelineno-21-36" name="__codelineno-21-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">):</span>
</span><span id="__span-21-37"><a href="#__codelineno-21-37" id="__codelineno-21-37" name="__codelineno-21-37"></a><span class="w">        </span><span class="sd">"""Set value in all cache levels."""</span>
</span><span id="__span-21-38"><a href="#__codelineno-21-38" id="__codelineno-21-38" name="__codelineno-21-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-21-39"><a href="#__codelineno-21-39" id="__codelineno-21-39" name="__codelineno-21-39"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="__span-21-40"><a href="#__codelineno-21-40" id="__codelineno-21-40" name="__codelineno-21-40"></a>
</span><span id="__span-21-41"><a href="#__codelineno-21-41" id="__codelineno-21-41" name="__codelineno-21-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-21-42"><a href="#__codelineno-21-42" id="__codelineno-21-42" name="__codelineno-21-42"></a><span class="w">        </span><span class="sd">"""Invalidate cache entries matching pattern."""</span>
</span><span id="__span-21-43"><a href="#__codelineno-21-43" id="__codelineno-21-43" name="__codelineno-21-43"></a>        <span class="c1"># Clear L1 cache entries</span>
</span><span id="__span-21-44"><a href="#__codelineno-21-44" id="__codelineno-21-44" name="__codelineno-21-44"></a>        <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)]</span>
</span><span id="__span-21-45"><a href="#__codelineno-21-45" id="__codelineno-21-45" name="__codelineno-21-45"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
</span><span id="__span-21-46"><a href="#__codelineno-21-46" id="__codelineno-21-46" name="__codelineno-21-46"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="__span-21-47"><a href="#__codelineno-21-47" id="__codelineno-21-47" name="__codelineno-21-47"></a>
</span><span id="__span-21-48"><a href="#__codelineno-21-48" id="__codelineno-21-48" name="__codelineno-21-48"></a>        <span class="c1"># Clear L2 cache entries</span>
</span><span id="__span-21-49"><a href="#__codelineno-21-49" id="__codelineno-21-49" name="__codelineno-21-49"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">):</span>
</span><span id="__span-21-50"><a href="#__codelineno-21-50" id="__codelineno-21-50" name="__codelineno-21-50"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></code></pre></div> <h4 id="background-task-processing">Background Task Processing<a class="headerlink" href="#background-task-processing" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1"># Task queue system with Celery</span>
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="n">celery_app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>    <span class="s2">"toolboxai"</span><span class="p">,</span>
</span><span id="__span-22-6"><a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a>    <span class="n">broker</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_broker_url</span><span class="p">,</span>
</span><span id="__span-22-7"><a href="#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a>    <span class="n">backend</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_result_backend</span>
</span><span id="__span-22-8"><a href="#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="p">)</span>
</span><span id="__span-22-9"><a href="#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a>
</span><span id="__span-22-10"><a href="#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-22-11"><a href="#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_content_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-22-12"><a href="#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="sd">"""Background task for content generation."""</span>
</span><span id="__span-22-13"><a href="#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-22-14"><a href="#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a>        <span class="c1"># Long-running content generation process</span>
</span><span id="__span-22-15"><a href="#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">generate_educational_content</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>
</span><span id="__span-22-16"><a href="#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a>
</span><span id="__span-22-17"><a href="#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a>        <span class="c1"># Notify completion via Pusher</span>
</span><span id="__span-22-18"><a href="#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a>        <span class="n">pusher_client</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span>
</span><span id="__span-22-19"><a href="#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a>            <span class="sa">f</span><span class="s2">"private-user-</span><span class="si">{</span><span class="n">request_data</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-22-20"><a href="#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a>            <span class="s2">"content_generated"</span><span class="p">,</span>
</span><span id="__span-22-21"><a href="#__codelineno-22-21" id="__codelineno-22-21" name="__codelineno-22-21"></a>            <span class="p">{</span><span class="s2">"content_id"</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">content_id</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"completed"</span><span class="p">}</span>
</span><span id="__span-22-22"><a href="#__codelineno-22-22" id="__codelineno-22-22" name="__codelineno-22-22"></a>        <span class="p">)</span>
</span><span id="__span-22-23"><a href="#__codelineno-22-23" id="__codelineno-22-23" name="__codelineno-22-23"></a>
</span><span id="__span-22-24"><a href="#__codelineno-22-24" id="__codelineno-22-24" name="__codelineno-22-24"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
</span><span id="__span-22-25"><a href="#__codelineno-22-25" id="__codelineno-22-25" name="__codelineno-22-25"></a>
</span><span id="__span-22-26"><a href="#__codelineno-22-26" id="__codelineno-22-26" name="__codelineno-22-26"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="__span-22-27"><a href="#__codelineno-22-27" id="__codelineno-22-27" name="__codelineno-22-27"></a>        <span class="c1"># Retry with exponential backoff</span>
</span><span id="__span-22-28"><a href="#__codelineno-22-28" id="__codelineno-22-28" name="__codelineno-22-28"></a>        <span class="n">countdown</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">retries</span>
</span><span id="__span-22-29"><a href="#__codelineno-22-29" id="__codelineno-22-29" name="__codelineno-22-29"></a>        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">)</span>
</span><span id="__span-22-30"><a href="#__codelineno-22-30" id="__codelineno-22-30" name="__codelineno-22-30"></a>
</span><span id="__span-22-31"><a href="#__codelineno-22-31" id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="c1"># Task orchestration service</span>
</span><span id="__span-22-32"><a href="#__codelineno-22-32" id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="k">class</span><span class="w"> </span><span class="nc">TaskOrchestrator</span><span class="p">:</span>
</span><span id="__span-22-33"><a href="#__codelineno-22-33" id="__codelineno-22-33" name="__codelineno-22-33"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-34"><a href="#__codelineno-22-34" id="__codelineno-22-34" name="__codelineno-22-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">celery</span> <span class="o">=</span> <span class="n">celery_app</span>
</span><span id="__span-22-35"><a href="#__codelineno-22-35" id="__codelineno-22-35" name="__codelineno-22-35"></a>
</span><span id="__span-22-36"><a href="#__codelineno-22-36" id="__codelineno-22-36" name="__codelineno-22-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">submit_content_generation</span><span class="p">(</span>
</span><span id="__span-22-37"><a href="#__codelineno-22-37" id="__codelineno-22-37" name="__codelineno-22-37"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-22-38"><a href="#__codelineno-22-38" id="__codelineno-22-38" name="__codelineno-22-38"></a>        <span class="n">request</span><span class="p">:</span> <span class="n">ContentGenerationRequest</span><span class="p">,</span>
</span><span id="__span-22-39"><a href="#__codelineno-22-39" id="__codelineno-22-39" name="__codelineno-22-39"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-40"><a href="#__codelineno-22-40" id="__codelineno-22-40" name="__codelineno-22-40"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-22-41"><a href="#__codelineno-22-41" id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="w">        </span><span class="sd">"""Submit content generation task."""</span>
</span><span id="__span-22-42"><a href="#__codelineno-22-42" id="__codelineno-22-42" name="__codelineno-22-42"></a>
</span><span id="__span-22-43"><a href="#__codelineno-22-43" id="__codelineno-22-43" name="__codelineno-22-43"></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">generate_content_task</span><span class="o">.</span><span class="n">delay</span><span class="p">({</span>
</span><span id="__span-22-44"><a href="#__codelineno-22-44" id="__codelineno-22-44" name="__codelineno-22-44"></a>            <span class="s2">"request"</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
</span><span id="__span-22-45"><a href="#__codelineno-22-45" id="__codelineno-22-45" name="__codelineno-22-45"></a>            <span class="s2">"user_id"</span><span class="p">:</span> <span class="n">user_id</span>
</span><span id="__span-22-46"><a href="#__codelineno-22-46" id="__codelineno-22-46" name="__codelineno-22-46"></a>        <span class="p">})</span>
</span><span id="__span-22-47"><a href="#__codelineno-22-47" id="__codelineno-22-47" name="__codelineno-22-47"></a>
</span><span id="__span-22-48"><a href="#__codelineno-22-48" id="__codelineno-22-48" name="__codelineno-22-48"></a>        <span class="c1"># Store task ID for tracking</span>
</span><span id="__span-22-49"><a href="#__codelineno-22-49" id="__codelineno-22-49" name="__codelineno-22-49"></a>        <span class="k">await</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
</span><span id="__span-22-50"><a href="#__codelineno-22-50" id="__codelineno-22-50" name="__codelineno-22-50"></a>            <span class="sa">f</span><span class="s2">"task:</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-22-51"><a href="#__codelineno-22-51" id="__codelineno-22-51" name="__codelineno-22-51"></a>            <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-22-52"><a href="#__codelineno-22-52" id="__codelineno-22-52" name="__codelineno-22-52"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"user_id"</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"content_generation"</span><span class="p">})</span>
</span><span id="__span-22-53"><a href="#__codelineno-22-53" id="__codelineno-22-53" name="__codelineno-22-53"></a>        <span class="p">)</span>
</span><span id="__span-22-54"><a href="#__codelineno-22-54" id="__codelineno-22-54" name="__codelineno-22-54"></a>
</span><span id="__span-22-55"><a href="#__codelineno-22-55" id="__codelineno-22-55" name="__codelineno-22-55"></a>        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-22-56"><a href="#__codelineno-22-56" id="__codelineno-22-56" name="__codelineno-22-56"></a>
</span><span id="__span-22-57"><a href="#__codelineno-22-57" id="__codelineno-22-57" name="__codelineno-22-57"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_task_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
</span><span id="__span-22-58"><a href="#__codelineno-22-58" id="__codelineno-22-58" name="__codelineno-22-58"></a><span class="w">        </span><span class="sd">"""Get status of background task."""</span>
</span><span id="__span-22-59"><a href="#__codelineno-22-59" id="__codelineno-22-59" name="__codelineno-22-59"></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span id="__span-22-60"><a href="#__codelineno-22-60" id="__codelineno-22-60" name="__codelineno-22-60"></a>
</span><span id="__span-22-61"><a href="#__codelineno-22-61" id="__codelineno-22-61" name="__codelineno-22-61"></a>        <span class="k">return</span> <span class="n">TaskStatus</span><span class="p">(</span>
</span><span id="__span-22-62"><a href="#__codelineno-22-62" id="__codelineno-22-62" name="__codelineno-22-62"></a>            <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="__span-22-63"><a href="#__codelineno-22-63" id="__codelineno-22-63" name="__codelineno-22-63"></a>            <span class="n">status</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-22-64"><a href="#__codelineno-22-64" id="__codelineno-22-64" name="__codelineno-22-64"></a>            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-22-65"><a href="#__codelineno-22-65" id="__codelineno-22-65" name="__codelineno-22-65"></a>            <span class="n">progress</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"progress"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">info</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-22-66"><a href="#__codelineno-22-66" id="__codelineno-22-66" name="__codelineno-22-66"></a>        <span class="p">)</span>
</span></code></pre></div> <h2 id="deployment-architecture">Deployment Architecture<a class="headerlink" href="#deployment-architecture" title="Permanent link">¶</a></h2> <h3 id="container-orchestration">Container Orchestration<a class="headerlink" href="#container-orchestration" title="Permanent link">¶</a></h3> <h4 id="kubernetes-deployment-configuration">Kubernetes Deployment Configuration<a class="headerlink" href="#kubernetes-deployment-configuration" title="Permanent link">¶</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1"># k8s/namespace.yaml</span>
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-6"><a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>
</span><span id="__span-23-7"><a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="nn">---</span>
</span><span id="__span-23-8"><a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="c1"># k8s/configmap.yaml</span>
</span><span id="__span-23-9"><a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-23-10"><a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-23-11"><a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-12"><a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-config</span>
</span><span id="__span-23-13"><a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-14"><a href="#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-23-15"><a href="#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">  </span><span class="nt">DATABASE_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">"postgres-service"</span>
</span><span id="__span-23-16"><a href="#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">  </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">"redis-service"</span>
</span><span id="__span-23-17"><a href="#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="w">  </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">"INFO"</span>
</span><span id="__span-23-18"><a href="#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">  </span><span class="nt">ENVIRONMENT</span><span class="p">:</span><span class="w"> </span><span class="s">"production"</span>
</span><span id="__span-23-19"><a href="#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a>
</span><span id="__span-23-20"><a href="#__codelineno-23-20" id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="nn">---</span>
</span><span id="__span-23-21"><a href="#__codelineno-23-21" id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="c1"># k8s/secret.yaml</span>
</span><span id="__span-23-22"><a href="#__codelineno-23-22" id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-23-23"><a href="#__codelineno-23-23" id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-23-24"><a href="#__codelineno-23-24" id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-25"><a href="#__codelineno-23-25" id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-secrets</span>
</span><span id="__span-23-26"><a href="#__codelineno-23-26" id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-27"><a href="#__codelineno-23-27" id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span><span id="__span-23-28"><a href="#__codelineno-23-28" id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-23-29"><a href="#__codelineno-23-29" id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="w">  </span><span class="nt">JWT_SECRET_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-secret&gt;</span>
</span><span id="__span-23-30"><a href="#__codelineno-23-30" id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="w">  </span><span class="nt">DATABASE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-password&gt;</span>
</span><span id="__span-23-31"><a href="#__codelineno-23-31" id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">  </span><span class="nt">OPENAI_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-key&gt;</span>
</span><span id="__span-23-32"><a href="#__codelineno-23-32" id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="w">  </span><span class="nt">ANTHROPIC_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-key&gt;</span>
</span><span id="__span-23-33"><a href="#__codelineno-23-33" id="__codelineno-23-33" name="__codelineno-23-33"></a>
</span><span id="__span-23-34"><a href="#__codelineno-23-34" id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="nn">---</span>
</span><span id="__span-23-35"><a href="#__codelineno-23-35" id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="c1"># k8s/backend-deployment.yaml</span>
</span><span id="__span-23-36"><a href="#__codelineno-23-36" id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-23-37"><a href="#__codelineno-23-37" id="__codelineno-23-37" name="__codelineno-23-37"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-23-38"><a href="#__codelineno-23-38" id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-39"><a href="#__codelineno-23-39" id="__codelineno-23-39" name="__codelineno-23-39"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend</span>
</span><span id="__span-23-40"><a href="#__codelineno-23-40" id="__codelineno-23-40" name="__codelineno-23-40"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-41"><a href="#__codelineno-23-41" id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-42"><a href="#__codelineno-23-42" id="__codelineno-23-42" name="__codelineno-23-42"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-23-43"><a href="#__codelineno-23-43" id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-23-44"><a href="#__codelineno-23-44" id="__codelineno-23-44" name="__codelineno-23-44"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-23-45"><a href="#__codelineno-23-45" id="__codelineno-23-45" name="__codelineno-23-45"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend</span>
</span><span id="__span-23-46"><a href="#__codelineno-23-46" id="__codelineno-23-46" name="__codelineno-23-46"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-23-47"><a href="#__codelineno-23-47" id="__codelineno-23-47" name="__codelineno-23-47"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-48"><a href="#__codelineno-23-48" id="__codelineno-23-48" name="__codelineno-23-48"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-23-49"><a href="#__codelineno-23-49" id="__codelineno-23-49" name="__codelineno-23-49"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend</span>
</span><span id="__span-23-50"><a href="#__codelineno-23-50" id="__codelineno-23-50" name="__codelineno-23-50"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-51"><a href="#__codelineno-23-51" id="__codelineno-23-51" name="__codelineno-23-51"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-23-52"><a href="#__codelineno-23-52" id="__codelineno-23-52" name="__codelineno-23-52"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
</span><span id="__span-23-53"><a href="#__codelineno-23-53" id="__codelineno-23-53" name="__codelineno-23-53"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai/backend:latest</span>
</span><span id="__span-23-54"><a href="#__codelineno-23-54" id="__codelineno-23-54" name="__codelineno-23-54"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-23-55"><a href="#__codelineno-23-55" id="__codelineno-23-55" name="__codelineno-23-55"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8009</span>
</span><span id="__span-23-56"><a href="#__codelineno-23-56" id="__codelineno-23-56" name="__codelineno-23-56"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-23-57"><a href="#__codelineno-23-57" id="__codelineno-23-57" name="__codelineno-23-57"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL</span>
</span><span id="__span-23-58"><a href="#__codelineno-23-58" id="__codelineno-23-58" name="__codelineno-23-58"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
</span><span id="__span-23-59"><a href="#__codelineno-23-59" id="__codelineno-23-59" name="__codelineno-23-59"></a><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
</span><span id="__span-23-60"><a href="#__codelineno-23-60" id="__codelineno-23-60" name="__codelineno-23-60"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-secrets</span>
</span><span id="__span-23-61"><a href="#__codelineno-23-61" id="__codelineno-23-61" name="__codelineno-23-61"></a><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL</span>
</span><span id="__span-23-62"><a href="#__codelineno-23-62" id="__codelineno-23-62" name="__codelineno-23-62"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT_SECRET_KEY</span>
</span><span id="__span-23-63"><a href="#__codelineno-23-63" id="__codelineno-23-63" name="__codelineno-23-63"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
</span><span id="__span-23-64"><a href="#__codelineno-23-64" id="__codelineno-23-64" name="__codelineno-23-64"></a><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
</span><span id="__span-23-65"><a href="#__codelineno-23-65" id="__codelineno-23-65" name="__codelineno-23-65"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-secrets</span>
</span><span id="__span-23-66"><a href="#__codelineno-23-66" id="__codelineno-23-66" name="__codelineno-23-66"></a><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JWT_SECRET_KEY</span>
</span><span id="__span-23-67"><a href="#__codelineno-23-67" id="__codelineno-23-67" name="__codelineno-23-67"></a><span class="w">        </span><span class="nt">envFrom</span><span class="p">:</span>
</span><span id="__span-23-68"><a href="#__codelineno-23-68" id="__codelineno-23-68" name="__codelineno-23-68"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMapRef</span><span class="p">:</span>
</span><span id="__span-23-69"><a href="#__codelineno-23-69" id="__codelineno-23-69" name="__codelineno-23-69"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-config</span>
</span><span id="__span-23-70"><a href="#__codelineno-23-70" id="__codelineno-23-70" name="__codelineno-23-70"></a><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span>
</span><span id="__span-23-71"><a href="#__codelineno-23-71" id="__codelineno-23-71" name="__codelineno-23-71"></a><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
</span><span id="__span-23-72"><a href="#__codelineno-23-72" id="__codelineno-23-72" name="__codelineno-23-72"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
</span><span id="__span-23-73"><a href="#__codelineno-23-73" id="__codelineno-23-73" name="__codelineno-23-73"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8009</span>
</span><span id="__span-23-74"><a href="#__codelineno-23-74" id="__codelineno-23-74" name="__codelineno-23-74"></a><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span id="__span-23-75"><a href="#__codelineno-23-75" id="__codelineno-23-75" name="__codelineno-23-75"></a><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-23-76"><a href="#__codelineno-23-76" id="__codelineno-23-76" name="__codelineno-23-76"></a><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span>
</span><span id="__span-23-77"><a href="#__codelineno-23-77" id="__codelineno-23-77" name="__codelineno-23-77"></a><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
</span><span id="__span-23-78"><a href="#__codelineno-23-78" id="__codelineno-23-78" name="__codelineno-23-78"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
</span><span id="__span-23-79"><a href="#__codelineno-23-79" id="__codelineno-23-79" name="__codelineno-23-79"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8009</span>
</span><span id="__span-23-80"><a href="#__codelineno-23-80" id="__codelineno-23-80" name="__codelineno-23-80"></a><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-23-81"><a href="#__codelineno-23-81" id="__codelineno-23-81" name="__codelineno-23-81"></a><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-23-82"><a href="#__codelineno-23-82" id="__codelineno-23-82" name="__codelineno-23-82"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-23-83"><a href="#__codelineno-23-83" id="__codelineno-23-83" name="__codelineno-23-83"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-23-84"><a href="#__codelineno-23-84" id="__codelineno-23-84" name="__codelineno-23-84"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"512Mi"</span>
</span><span id="__span-23-85"><a href="#__codelineno-23-85" id="__codelineno-23-85" name="__codelineno-23-85"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"250m"</span>
</span><span id="__span-23-86"><a href="#__codelineno-23-86" id="__codelineno-23-86" name="__codelineno-23-86"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-23-87"><a href="#__codelineno-23-87" id="__codelineno-23-87" name="__codelineno-23-87"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"1Gi"</span>
</span><span id="__span-23-88"><a href="#__codelineno-23-88" id="__codelineno-23-88" name="__codelineno-23-88"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"500m"</span>
</span><span id="__span-23-89"><a href="#__codelineno-23-89" id="__codelineno-23-89" name="__codelineno-23-89"></a>
</span><span id="__span-23-90"><a href="#__codelineno-23-90" id="__codelineno-23-90" name="__codelineno-23-90"></a><span class="nn">---</span>
</span><span id="__span-23-91"><a href="#__codelineno-23-91" id="__codelineno-23-91" name="__codelineno-23-91"></a><span class="c1"># k8s/backend-service.yaml</span>
</span><span id="__span-23-92"><a href="#__codelineno-23-92" id="__codelineno-23-92" name="__codelineno-23-92"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-23-93"><a href="#__codelineno-23-93" id="__codelineno-23-93" name="__codelineno-23-93"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-23-94"><a href="#__codelineno-23-94" id="__codelineno-23-94" name="__codelineno-23-94"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-95"><a href="#__codelineno-23-95" id="__codelineno-23-95" name="__codelineno-23-95"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend-service</span>
</span><span id="__span-23-96"><a href="#__codelineno-23-96" id="__codelineno-23-96" name="__codelineno-23-96"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-97"><a href="#__codelineno-23-97" id="__codelineno-23-97" name="__codelineno-23-97"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-98"><a href="#__codelineno-23-98" id="__codelineno-23-98" name="__codelineno-23-98"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-23-99"><a href="#__codelineno-23-99" id="__codelineno-23-99" name="__codelineno-23-99"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend</span>
</span><span id="__span-23-100"><a href="#__codelineno-23-100" id="__codelineno-23-100" name="__codelineno-23-100"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-23-101"><a href="#__codelineno-23-101" id="__codelineno-23-101" name="__codelineno-23-101"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-23-102"><a href="#__codelineno-23-102" id="__codelineno-23-102" name="__codelineno-23-102"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-23-103"><a href="#__codelineno-23-103" id="__codelineno-23-103" name="__codelineno-23-103"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8009</span>
</span><span id="__span-23-104"><a href="#__codelineno-23-104" id="__codelineno-23-104" name="__codelineno-23-104"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</span><span id="__span-23-105"><a href="#__codelineno-23-105" id="__codelineno-23-105" name="__codelineno-23-105"></a>
</span><span id="__span-23-106"><a href="#__codelineno-23-106" id="__codelineno-23-106" name="__codelineno-23-106"></a><span class="nn">---</span>
</span><span id="__span-23-107"><a href="#__codelineno-23-107" id="__codelineno-23-107" name="__codelineno-23-107"></a><span class="c1"># k8s/frontend-deployment.yaml</span>
</span><span id="__span-23-108"><a href="#__codelineno-23-108" id="__codelineno-23-108" name="__codelineno-23-108"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-23-109"><a href="#__codelineno-23-109" id="__codelineno-23-109" name="__codelineno-23-109"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-23-110"><a href="#__codelineno-23-110" id="__codelineno-23-110" name="__codelineno-23-110"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-111"><a href="#__codelineno-23-111" id="__codelineno-23-111" name="__codelineno-23-111"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-frontend</span>
</span><span id="__span-23-112"><a href="#__codelineno-23-112" id="__codelineno-23-112" name="__codelineno-23-112"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-113"><a href="#__codelineno-23-113" id="__codelineno-23-113" name="__codelineno-23-113"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-114"><a href="#__codelineno-23-114" id="__codelineno-23-114" name="__codelineno-23-114"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-23-115"><a href="#__codelineno-23-115" id="__codelineno-23-115" name="__codelineno-23-115"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-23-116"><a href="#__codelineno-23-116" id="__codelineno-23-116" name="__codelineno-23-116"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-23-117"><a href="#__codelineno-23-117" id="__codelineno-23-117" name="__codelineno-23-117"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-frontend</span>
</span><span id="__span-23-118"><a href="#__codelineno-23-118" id="__codelineno-23-118" name="__codelineno-23-118"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-23-119"><a href="#__codelineno-23-119" id="__codelineno-23-119" name="__codelineno-23-119"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-120"><a href="#__codelineno-23-120" id="__codelineno-23-120" name="__codelineno-23-120"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-23-121"><a href="#__codelineno-23-121" id="__codelineno-23-121" name="__codelineno-23-121"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-frontend</span>
</span><span id="__span-23-122"><a href="#__codelineno-23-122" id="__codelineno-23-122" name="__codelineno-23-122"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-123"><a href="#__codelineno-23-123" id="__codelineno-23-123" name="__codelineno-23-123"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-23-124"><a href="#__codelineno-23-124" id="__codelineno-23-124" name="__codelineno-23-124"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
</span><span id="__span-23-125"><a href="#__codelineno-23-125" id="__codelineno-23-125" name="__codelineno-23-125"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai/frontend:latest</span>
</span><span id="__span-23-126"><a href="#__codelineno-23-126" id="__codelineno-23-126" name="__codelineno-23-126"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-23-127"><a href="#__codelineno-23-127" id="__codelineno-23-127" name="__codelineno-23-127"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-23-128"><a href="#__codelineno-23-128" id="__codelineno-23-128" name="__codelineno-23-128"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-23-129"><a href="#__codelineno-23-129" id="__codelineno-23-129" name="__codelineno-23-129"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-23-130"><a href="#__codelineno-23-130" id="__codelineno-23-130" name="__codelineno-23-130"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"256Mi"</span>
</span><span id="__span-23-131"><a href="#__codelineno-23-131" id="__codelineno-23-131" name="__codelineno-23-131"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"100m"</span>
</span><span id="__span-23-132"><a href="#__codelineno-23-132" id="__codelineno-23-132" name="__codelineno-23-132"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-23-133"><a href="#__codelineno-23-133" id="__codelineno-23-133" name="__codelineno-23-133"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"512Mi"</span>
</span><span id="__span-23-134"><a href="#__codelineno-23-134" id="__codelineno-23-134" name="__codelineno-23-134"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">"200m"</span>
</span><span id="__span-23-135"><a href="#__codelineno-23-135" id="__codelineno-23-135" name="__codelineno-23-135"></a>
</span><span id="__span-23-136"><a href="#__codelineno-23-136" id="__codelineno-23-136" name="__codelineno-23-136"></a><span class="nn">---</span>
</span><span id="__span-23-137"><a href="#__codelineno-23-137" id="__codelineno-23-137" name="__codelineno-23-137"></a><span class="c1"># k8s/ingress.yaml</span>
</span><span id="__span-23-138"><a href="#__codelineno-23-138" id="__codelineno-23-138" name="__codelineno-23-138"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-23-139"><a href="#__codelineno-23-139" id="__codelineno-23-139" name="__codelineno-23-139"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-23-140"><a href="#__codelineno-23-140" id="__codelineno-23-140" name="__codelineno-23-140"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-23-141"><a href="#__codelineno-23-141" id="__codelineno-23-141" name="__codelineno-23-141"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-ingress</span>
</span><span id="__span-23-142"><a href="#__codelineno-23-142" id="__codelineno-23-142" name="__codelineno-23-142"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-23-143"><a href="#__codelineno-23-143" id="__codelineno-23-143" name="__codelineno-23-143"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-23-144"><a href="#__codelineno-23-144" id="__codelineno-23-144" name="__codelineno-23-144"></a><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s">"nginx"</span>
</span><span id="__span-23-145"><a href="#__codelineno-23-145" id="__codelineno-23-145" name="__codelineno-23-145"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="s">"letsencrypt-prod"</span>
</span><span id="__span-23-146"><a href="#__codelineno-23-146" id="__codelineno-23-146" name="__codelineno-23-146"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-23-147"><a href="#__codelineno-23-147" id="__codelineno-23-147" name="__codelineno-23-147"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-23-148"><a href="#__codelineno-23-148" id="__codelineno-23-148" name="__codelineno-23-148"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-23-149"><a href="#__codelineno-23-149" id="__codelineno-23-149" name="__codelineno-23-149"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-23-150"><a href="#__codelineno-23-150" id="__codelineno-23-150" name="__codelineno-23-150"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.toolboxai.com</span>
</span><span id="__span-23-151"><a href="#__codelineno-23-151" id="__codelineno-23-151" name="__codelineno-23-151"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">platform.toolboxai.com</span>
</span><span id="__span-23-152"><a href="#__codelineno-23-152" id="__codelineno-23-152" name="__codelineno-23-152"></a><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-tls</span>
</span><span id="__span-23-153"><a href="#__codelineno-23-153" id="__codelineno-23-153" name="__codelineno-23-153"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-23-154"><a href="#__codelineno-23-154" id="__codelineno-23-154" name="__codelineno-23-154"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">platform.toolboxai.com</span>
</span><span id="__span-23-155"><a href="#__codelineno-23-155" id="__codelineno-23-155" name="__codelineno-23-155"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-23-156"><a href="#__codelineno-23-156" id="__codelineno-23-156" name="__codelineno-23-156"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-23-157"><a href="#__codelineno-23-157" id="__codelineno-23-157" name="__codelineno-23-157"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-23-158"><a href="#__codelineno-23-158" id="__codelineno-23-158" name="__codelineno-23-158"></a><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-23-159"><a href="#__codelineno-23-159" id="__codelineno-23-159" name="__codelineno-23-159"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-23-160"><a href="#__codelineno-23-160" id="__codelineno-23-160" name="__codelineno-23-160"></a><span class="w">          </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-23-161"><a href="#__codelineno-23-161" id="__codelineno-23-161" name="__codelineno-23-161"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-frontend-service</span>
</span><span id="__span-23-162"><a href="#__codelineno-23-162" id="__codelineno-23-162" name="__codelineno-23-162"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-23-163"><a href="#__codelineno-23-163" id="__codelineno-23-163" name="__codelineno-23-163"></a><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-23-164"><a href="#__codelineno-23-164" id="__codelineno-23-164" name="__codelineno-23-164"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api.toolboxai.com</span>
</span><span id="__span-23-165"><a href="#__codelineno-23-165" id="__codelineno-23-165" name="__codelineno-23-165"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-23-166"><a href="#__codelineno-23-166" id="__codelineno-23-166" name="__codelineno-23-166"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-23-167"><a href="#__codelineno-23-167" id="__codelineno-23-167" name="__codelineno-23-167"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-23-168"><a href="#__codelineno-23-168" id="__codelineno-23-168" name="__codelineno-23-168"></a><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-23-169"><a href="#__codelineno-23-169" id="__codelineno-23-169" name="__codelineno-23-169"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-23-170"><a href="#__codelineno-23-170" id="__codelineno-23-170" name="__codelineno-23-170"></a><span class="w">          </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-23-171"><a href="#__codelineno-23-171" id="__codelineno-23-171" name="__codelineno-23-171"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend-service</span>
</span><span id="__span-23-172"><a href="#__codelineno-23-172" id="__codelineno-23-172" name="__codelineno-23-172"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-23-173"><a href="#__codelineno-23-173" id="__codelineno-23-173" name="__codelineno-23-173"></a><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span></code></pre></div> <h4 id="auto-scaling-configuration">Auto-scaling Configuration<a class="headerlink" href="#auto-scaling-configuration" title="Permanent link">¶</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1"># k8s/hpa.yaml</span>
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autoscaling/v2</span>
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HorizontalPodAutoscaler</span>
</span><span id="__span-24-4"><a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-24-5"><a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend-hpa</span>
</span><span id="__span-24-6"><a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-production</span>
</span><span id="__span-24-7"><a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-24-8"><a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span>
</span><span id="__span-24-9"><a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-24-10"><a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-24-11"><a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toolboxai-backend</span>
</span><span id="__span-24-12"><a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-24-13"><a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-24-14"><a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span>
</span><span id="__span-24-15"><a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Resource</span>
</span><span id="__span-24-16"><a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="w">    </span><span class="nt">resource</span><span class="p">:</span>
</span><span id="__span-24-17"><a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpu</span>
</span><span id="__span-24-18"><a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="w">      </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-24-19"><a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Utilization</span>
</span><span id="__span-24-20"><a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">70</span>
</span><span id="__span-24-21"><a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Resource</span>
</span><span id="__span-24-22"><a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="w">    </span><span class="nt">resource</span><span class="p">:</span>
</span><span id="__span-24-23"><a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory</span>
</span><span id="__span-24-24"><a href="#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="w">      </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-24-25"><a href="#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Utilization</span>
</span><span id="__span-24-26"><a href="#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-24-27"><a href="#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a><span class="w">  </span><span class="nt">behavior</span><span class="p">:</span>
</span><span id="__span-24-28"><a href="#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="w">    </span><span class="nt">scaleDown</span><span class="p">:</span>
</span><span id="__span-24-29"><a href="#__codelineno-24-29" id="__codelineno-24-29" name="__codelineno-24-29"></a><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
</span><span id="__span-24-30"><a href="#__codelineno-24-30" id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="w">      </span><span class="nt">policies</span><span class="p">:</span>
</span><span id="__span-24-31"><a href="#__codelineno-24-31" id="__codelineno-24-31" name="__codelineno-24-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Percent</span>
</span><span id="__span-24-32"><a href="#__codelineno-24-32" id="__codelineno-24-32" name="__codelineno-24-32"></a><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
</span><span id="__span-24-33"><a href="#__codelineno-24-33" id="__codelineno-24-33" name="__codelineno-24-33"></a><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
</span><span id="__span-24-34"><a href="#__codelineno-24-34" id="__codelineno-24-34" name="__codelineno-24-34"></a><span class="w">    </span><span class="nt">scaleUp</span><span class="p">:</span>
</span><span id="__span-24-35"><a href="#__codelineno-24-35" id="__codelineno-24-35" name="__codelineno-24-35"></a><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
</span><span id="__span-24-36"><a href="#__codelineno-24-36" id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="w">      </span><span class="nt">policies</span><span class="p">:</span>
</span><span id="__span-24-37"><a href="#__codelineno-24-37" id="__codelineno-24-37" name="__codelineno-24-37"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Percent</span>
</span><span id="__span-24-38"><a href="#__codelineno-24-38" id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</span><span id="__span-24-39"><a href="#__codelineno-24-39" id="__codelineno-24-39" name="__codelineno-24-39"></a><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
</span></code></pre></div> <h3 id="monitoring-and-observability">Monitoring and Observability<a class="headerlink" href="#monitoring-and-observability" title="Permanent link">¶</a></h3> <h4 id="prometheus-monitoring">Prometheus Monitoring<a class="headerlink" href="#prometheus-monitoring" title="Permanent link">¶</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1"># monitoring/prometheus-config.yaml</span>
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-config</span>
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-25-7"><a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">  </span><span class="nt">prometheus.yml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-25-8"><a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">    </span><span class="no">global:</span>
</span><span id="__span-25-9"><a href="#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">      </span><span class="no">scrape_interval: 15s</span>
</span><span id="__span-25-10"><a href="#__codelineno-25-10" id="__codelineno-25-10" name="__codelineno-25-10"></a>
</span><span id="__span-25-11"><a href="#__codelineno-25-11" id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">    </span><span class="no">scrape_configs:</span>
</span><span id="__span-25-12"><a href="#__codelineno-25-12" id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">    </span><span class="no">- job_name: 'toolboxai-backend'</span>
</span><span id="__span-25-13"><a href="#__codelineno-25-13" id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="w">      </span><span class="no">static_configs:</span>
</span><span id="__span-25-14"><a href="#__codelineno-25-14" id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="w">      </span><span class="no">- targets: ['toolboxai-backend-service:80']</span>
</span><span id="__span-25-15"><a href="#__codelineno-25-15" id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="w">      </span><span class="no">metrics_path: '/metrics'</span>
</span><span id="__span-25-16"><a href="#__codelineno-25-16" id="__codelineno-25-16" name="__codelineno-25-16"></a>
</span><span id="__span-25-17"><a href="#__codelineno-25-17" id="__codelineno-25-17" name="__codelineno-25-17"></a><span class="w">    </span><span class="no">- job_name: 'toolboxai-postgres'</span>
</span><span id="__span-25-18"><a href="#__codelineno-25-18" id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="w">      </span><span class="no">static_configs:</span>
</span><span id="__span-25-19"><a href="#__codelineno-25-19" id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="w">      </span><span class="no">- targets: ['postgres-exporter:9187']</span>
</span><span id="__span-25-20"><a href="#__codelineno-25-20" id="__codelineno-25-20" name="__codelineno-25-20"></a>
</span><span id="__span-25-21"><a href="#__codelineno-25-21" id="__codelineno-25-21" name="__codelineno-25-21"></a><span class="w">    </span><span class="no">- job_name: 'toolboxai-redis'</span>
</span><span id="__span-25-22"><a href="#__codelineno-25-22" id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="w">      </span><span class="no">static_configs:</span>
</span><span id="__span-25-23"><a href="#__codelineno-25-23" id="__codelineno-25-23" name="__codelineno-25-23"></a><span class="w">      </span><span class="no">- targets: ['redis-exporter:9121']</span>
</span><span id="__span-25-24"><a href="#__codelineno-25-24" id="__codelineno-25-24" name="__codelineno-25-24"></a>
</span><span id="__span-25-25"><a href="#__codelineno-25-25" id="__codelineno-25-25" name="__codelineno-25-25"></a><span class="w">    </span><span class="no">rule_files:</span>
</span><span id="__span-25-26"><a href="#__codelineno-25-26" id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">    </span><span class="no">- "alert_rules.yml"</span>
</span><span id="__span-25-27"><a href="#__codelineno-25-27" id="__codelineno-25-27" name="__codelineno-25-27"></a>
</span><span id="__span-25-28"><a href="#__codelineno-25-28" id="__codelineno-25-28" name="__codelineno-25-28"></a><span class="w">    </span><span class="no">alerting:</span>
</span><span id="__span-25-29"><a href="#__codelineno-25-29" id="__codelineno-25-29" name="__codelineno-25-29"></a><span class="w">      </span><span class="no">alertmanagers:</span>
</span><span id="__span-25-30"><a href="#__codelineno-25-30" id="__codelineno-25-30" name="__codelineno-25-30"></a><span class="w">      </span><span class="no">- static_configs:</span>
</span><span id="__span-25-31"><a href="#__codelineno-25-31" id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="w">        </span><span class="no">- targets:</span>
</span><span id="__span-25-32"><a href="#__codelineno-25-32" id="__codelineno-25-32" name="__codelineno-25-32"></a><span class="w">          </span><span class="no">- alertmanager:9093</span>
</span></code></pre></div> <h4 id="application-metrics">Application Metrics<a class="headerlink" href="#application-metrics" title="Permanent link">¶</a></h4> <div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c1"># Prometheus metrics for the application</span>
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>
</span><span id="__span-26-3"><a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>
</span><span id="__span-26-4"><a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="c1"># Request metrics</span>
</span><span id="__span-26-5"><a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="n">REQUEST_COUNT</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
</span><span id="__span-26-6"><a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a>    <span class="s1">'http_requests_total'</span><span class="p">,</span>
</span><span id="__span-26-7"><a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a>    <span class="s1">'Total HTTP requests'</span><span class="p">,</span>
</span><span id="__span-26-8"><a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a>    <span class="p">[</span><span class="s1">'method'</span><span class="p">,</span> <span class="s1">'endpoint'</span><span class="p">,</span> <span class="s1">'status'</span><span class="p">]</span>
</span><span id="__span-26-9"><a href="#__codelineno-26-9" id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="p">)</span>
</span><span id="__span-26-10"><a href="#__codelineno-26-10" id="__codelineno-26-10" name="__codelineno-26-10"></a>
</span><span id="__span-26-11"><a href="#__codelineno-26-11" id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="n">REQUEST_DURATION</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
</span><span id="__span-26-12"><a href="#__codelineno-26-12" id="__codelineno-26-12" name="__codelineno-26-12"></a>    <span class="s1">'http_request_duration_seconds'</span><span class="p">,</span>
</span><span id="__span-26-13"><a href="#__codelineno-26-13" id="__codelineno-26-13" name="__codelineno-26-13"></a>    <span class="s1">'HTTP request duration'</span><span class="p">,</span>
</span><span id="__span-26-14"><a href="#__codelineno-26-14" id="__codelineno-26-14" name="__codelineno-26-14"></a>    <span class="p">[</span><span class="s1">'method'</span><span class="p">,</span> <span class="s1">'endpoint'</span><span class="p">]</span>
</span><span id="__span-26-15"><a href="#__codelineno-26-15" id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="p">)</span>
</span><span id="__span-26-16"><a href="#__codelineno-26-16" id="__codelineno-26-16" name="__codelineno-26-16"></a>
</span><span id="__span-26-17"><a href="#__codelineno-26-17" id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="c1"># Business metrics</span>
</span><span id="__span-26-18"><a href="#__codelineno-26-18" id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="n">CONTENT_GENERATION_DURATION</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
</span><span id="__span-26-19"><a href="#__codelineno-26-19" id="__codelineno-26-19" name="__codelineno-26-19"></a>    <span class="s1">'content_generation_duration_seconds'</span><span class="p">,</span>
</span><span id="__span-26-20"><a href="#__codelineno-26-20" id="__codelineno-26-20" name="__codelineno-26-20"></a>    <span class="s1">'Time taken to generate content'</span><span class="p">,</span>
</span><span id="__span-26-21"><a href="#__codelineno-26-21" id="__codelineno-26-21" name="__codelineno-26-21"></a>    <span class="p">[</span><span class="s1">'content_type'</span><span class="p">,</span> <span class="s1">'grade_level'</span><span class="p">]</span>
</span><span id="__span-26-22"><a href="#__codelineno-26-22" id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="p">)</span>
</span><span id="__span-26-23"><a href="#__codelineno-26-23" id="__codelineno-26-23" name="__codelineno-26-23"></a>
</span><span id="__span-26-24"><a href="#__codelineno-26-24" id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="n">ACTIVE_USERS</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
</span><span id="__span-26-25"><a href="#__codelineno-26-25" id="__codelineno-26-25" name="__codelineno-26-25"></a>    <span class="s1">'active_users_total'</span><span class="p">,</span>
</span><span id="__span-26-26"><a href="#__codelineno-26-26" id="__codelineno-26-26" name="__codelineno-26-26"></a>    <span class="s1">'Number of currently active users'</span><span class="p">,</span>
</span><span id="__span-26-27"><a href="#__codelineno-26-27" id="__codelineno-26-27" name="__codelineno-26-27"></a>    <span class="p">[</span><span class="s1">'role'</span><span class="p">]</span>
</span><span id="__span-26-28"><a href="#__codelineno-26-28" id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="p">)</span>
</span><span id="__span-26-29"><a href="#__codelineno-26-29" id="__codelineno-26-29" name="__codelineno-26-29"></a>
</span><span id="__span-26-30"><a href="#__codelineno-26-30" id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="n">AI_API_CALLS</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
</span><span id="__span-26-31"><a href="#__codelineno-26-31" id="__codelineno-26-31" name="__codelineno-26-31"></a>    <span class="s1">'ai_api_calls_total'</span><span class="p">,</span>
</span><span id="__span-26-32"><a href="#__codelineno-26-32" id="__codelineno-26-32" name="__codelineno-26-32"></a>    <span class="s1">'Total AI API calls'</span><span class="p">,</span>
</span><span id="__span-26-33"><a href="#__codelineno-26-33" id="__codelineno-26-33" name="__codelineno-26-33"></a>    <span class="p">[</span><span class="s1">'provider'</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">,</span> <span class="s1">'status'</span><span class="p">]</span>
</span><span id="__span-26-34"><a href="#__codelineno-26-34" id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="p">)</span>
</span><span id="__span-26-35"><a href="#__codelineno-26-35" id="__codelineno-26-35" name="__codelineno-26-35"></a>
</span><span id="__span-26-36"><a href="#__codelineno-26-36" id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="c1"># Middleware to collect metrics</span>
</span><span id="__span-26-37"><a href="#__codelineno-26-37" id="__codelineno-26-37" name="__codelineno-26-37"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">"http"</span><span class="p">)</span>
</span><span id="__span-26-38"><a href="#__codelineno-26-38" id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
</span><span id="__span-26-39"><a href="#__codelineno-26-39" id="__codelineno-26-39" name="__codelineno-26-39"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-26-40"><a href="#__codelineno-26-40" id="__codelineno-26-40" name="__codelineno-26-40"></a>
</span><span id="__span-26-41"><a href="#__codelineno-26-41" id="__codelineno-26-41" name="__codelineno-26-41"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span id="__span-26-42"><a href="#__codelineno-26-42" id="__codelineno-26-42" name="__codelineno-26-42"></a>
</span><span id="__span-26-43"><a href="#__codelineno-26-43" id="__codelineno-26-43" name="__codelineno-26-43"></a>    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-26-44"><a href="#__codelineno-26-44" id="__codelineno-26-44" name="__codelineno-26-44"></a>    <span class="n">REQUEST_DURATION</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
</span><span id="__span-26-45"><a href="#__codelineno-26-45" id="__codelineno-26-45" name="__codelineno-26-45"></a>        <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-26-46"><a href="#__codelineno-26-46" id="__codelineno-26-46" name="__codelineno-26-46"></a>        <span class="n">endpoint</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
</span><span id="__span-26-47"><a href="#__codelineno-26-47" id="__codelineno-26-47" name="__codelineno-26-47"></a>    <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="__span-26-48"><a href="#__codelineno-26-48" id="__codelineno-26-48" name="__codelineno-26-48"></a>
</span><span id="__span-26-49"><a href="#__codelineno-26-49" id="__codelineno-26-49" name="__codelineno-26-49"></a>    <span class="n">REQUEST_COUNT</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
</span><span id="__span-26-50"><a href="#__codelineno-26-50" id="__codelineno-26-50" name="__codelineno-26-50"></a>        <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-26-51"><a href="#__codelineno-26-51" id="__codelineno-26-51" name="__codelineno-26-51"></a>        <span class="n">endpoint</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-26-52"><a href="#__codelineno-26-52" id="__codelineno-26-52" name="__codelineno-26-52"></a>        <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span id="__span-26-53"><a href="#__codelineno-26-53" id="__codelineno-26-53" name="__codelineno-26-53"></a>    <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</span><span id="__span-26-54"><a href="#__codelineno-26-54" id="__codelineno-26-54" name="__codelineno-26-54"></a>
</span><span id="__span-26-55"><a href="#__codelineno-26-55" id="__codelineno-26-55" name="__codelineno-26-55"></a>    <span class="k">return</span> <span class="n">response</span>
</span></code></pre></div> <hr/> <p><strong>Document Version</strong>: 2.0.0 <strong>Last Updated</strong>: January 2025 <strong>Architecture Review Date</strong>: January 2025</p> <p><em>This architecture document is reviewed quarterly and updated with significant system changes.</em></p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 28, 2025 02:20:28 UTC"><span class="timeago" datetime="2025-09-28T02:20:28+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 28, 2025 02:20:28 UTC">2025-09-28</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Created"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 21, 2025 11:26:59 UTC"><span class="timeago" datetime="2025-09-21T11:26:59+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 21, 2025 11:26:59 UTC">2025-09-21</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Contributors"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"></path></svg> </span> <nav> <a href="mailto:140660682+grayghostdev@users.noreply.github.com">GrayGhostDev</a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button class="md-top md-icon" data-md-component="top" hidden="" type="button"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 ToolBoxAI Solutions </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/ToolBoxAI-Solutions" rel="noopener" target="_blank" title="ToolBoxAI on GitHub"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a class="md-social__link" href="https://discord.gg/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Discord"> <svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"></path></svg> </a> <a class="md-social__link" href="https://twitter.com/toolboxai" rel="noopener" target="_blank" title="ToolBoxAI on Twitter"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <div class="md-progress" data-md-component="progress" role="progressbar"></div> <div class="md-consent" data-md-component="consent" hidden="" id="__consent"> <div class="md-consent__overlay"></div> <aside class="md-consent__inner"> <form class="md-consent__form md-grid md-typeset" name="consent"> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class="md-toggle" id="__settings" type="checkbox"/> <div class="md-consent__settings"> <ul class="task-list"> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="analytics" type="checkbox"/> <span class="task-list-indicator"></span> Google Analytics </label> </li> <li class="task-list-item"> <label class="task-list-control"> <input checked="" name="github" type="checkbox"/> <span class="task-list-indicator"></span> GitHub </label> </li> </ul> </div> <div class="md-consent__controls"> <button class="md-button md-button--primary">Accept</button> <label class="md-button" for="__settings">Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script> <script src="../../js/timeago.min.js"></script> <script src="../../js/timeago_mkdocs_material.js"></script> <script src="../../javascripts/extra.js"></script> <script src="../../javascripts/mathjax.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> </body> </html>