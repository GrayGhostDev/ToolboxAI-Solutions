"># Automated Render Environment Group Linking Guide\n\n**Status**: ✅ Implementation Complete & Tested\n**Last Updated**: 2025-11-08\n**Script Location**: `scripts/link_env_groups_api.py`\n\n## Overview\n\nThis guide documents the automated solution for linking environment groups to ToolBoxAI services in Render and triggering redeployments via the Render API.\n\n## Quick Start\n\n```bash\n# 1. Ensure RENDER_API_KEY is set in .env\ngrep RENDER_API_KEY .env\n\n# 2. Run the automated linking script\npython3 scripts/link_env_groups_api.py\n\n# 3. Verify the setup\npython3 scripts/verify_render_setup.py\n```\n\n## What the Script Does\n\n### Step 1: Verify API Connection\n- Tests connectivity to Render API v1 endpoints\n- Confirms RENDER_API_KEY is valid\n\n### Step 2: Verify Environment Groups\n- Validates all 3 required environment groups exist:\n  - `toolboxai-secrets` (39 variables)\n  - `toolboxai-frontend-env` (12 variables)\n  - `toolboxai-monitoring` (5 variables)\n\n### Step 3: Verify Services Exist\n- Confirms all 9 services are deployed and accessible\n- Checks for potential deployment conflicts\n\n### Step 4: Link Environment Groups\n**Uses Render API PATCH endpoint**: `PATCH /v1/services/{serviceId}`\n\n**Linking Mapping**:\n```python\n# Backend Services (7) → toolboxai-secrets\ntoolboxai-backend              → evg-d479opq4d50c73813bu0\ntoolboxai-mcp                  → evg-d479opq4d50c73813bu0\ntoolboxai-agent-coordinator    → evg-d479opq4d50c73813bu0\ntoolboxai-celery-worker        → evg-d479opq4d50c73813bu0\ntoolboxai-celery-beat          → evg-d479opq4d50c73813bu0\ntoolboxai-celery-flower        → evg-d479opq4d50c73813bu0\ntoolboxai-cleanup              → evg-d479opq4d50c73813bu0\n\n# Frontend (1) → toolboxai-frontend-env\ntoolboxai-dashboard            → evg-d479opq4d50c73813c2g\n\n# Monitoring (1) → toolboxai-monitoring\ntoolboxai-monitoring           → evg-d479opq4d50c73813c4g\n```\n\n**API Payload**:\n```json\nPATCH /v1/services/{serviceId}\nContent-Type: application/json\n\n{\n  \"envGroupIds\": [\"env-group-id\"]\n}\n```\n\n### Step 5: Trigger Deployments\n**Uses Render API POST endpoint**: `POST /v1/services/{serviceId}/deploys`\n\n**Deployment Order** (respects dependencies):\n1. toolboxai-monitoring (infrastructure)\n2. toolboxai-backend (core)\n3. toolboxai-mcp (MCP server)\n4. toolboxai-agent-coordinator (orchestration)\n5. toolboxai-celery-worker (async workers)\n6. toolboxai-celery-beat (scheduled tasks)\n7. toolboxai-celery-flower (worker monitoring)\n8. toolboxai-cleanup (maintenance)\n9. toolboxai-dashboard (frontend)\n\n**Deployment Features**:\n- Empty payload (Render API best practice)\n- 1-second rate limiting between requests\n- Returns deploy IDs for monitoring\n\n### Step 6: Monitor Deployments\n**Uses Render API GET endpoint**: `GET /v1/deploys/{deployId}`\n\n**Status Tracking**:\n- `live` ✓ - Deployment successful\n- `build_in_progress` ⏳ - Building\n- `build_failed` ✗ - Build error\n- `deploy_failed` ✗ - Deployment error\n\n**Monitoring Configuration**:\n- Poll interval: 10 seconds\n- Timeout: 10 minutes (600 seconds)\n- Real-time status display\n\n## API Implementation Details\n\n### Authentication\n```python\nheaders = {\n    \"Authorization\": f\"Bearer {RENDER_API_KEY}\",\n    \"Content-Type\": \"application/json\"\n}\n```\n\n### Request Patterns\n\n**1. Get Environment Groups**\n```bash\nGET /v1/env-groups\nResponse: List of environment group objects\n```\n\n**2. Get Service Details**\n```bash\nGET /v1/services/{serviceId}\nResponse: Service object with configuration\n```\n\n**3. Link Environment Groups** (Our Implementation)\n```bash\nPATCH /v1/services/{serviceId}\nPayload: {\"envGroupIds\": [\"group-id\"]}\nResponse: Updated service object (200 OK)\n```\n\n**Note**: The Render API does NOT return `envGroupIds` in the GET response. This is a known limitation of the API. Linking is confirmed by the 200 status code from the PATCH request.\n\n**4. Trigger Deployment**\n```bash\nPOST /v1/services/{serviceId}/deploys\nPayload: {} (empty)\nResponse: Deploy object with deployment ID\n```\n\n**5. Get Deployment Status**\n```bash\nGET /v1/deploys/{deployId}\nResponse: Deploy object with current status\n```\n\n### Error Handling\n\n**Exponential Backoff Retry**:\n- Max retries: 3\n- Delays: 2s, 4s, 8s\n- HTTP 429 (rate limit): Automatic retry\n- Timeout: Automatic retry with exponential backoff\n\n**Error Responses**:\n- `401 Unauthorized` - Invalid RENDER_API_KEY\n- `404 Not Found` - Invalid service ID or environment group\n- `400 Bad Request` - Invalid payload format\n- `429 Too Many Requests` - Rate limited (auto-retry)\n- `500 Server Error` - Render API issue (auto-retry)\n\n## Service Types & Considerations\n\n### Web Services\n- **Examples**: backend, mcp, agent-coordinator, celery-flower, monitoring\n- **Endpoint**: Standard service update\n- **Health Check**: Available via HTTP endpoint\n- **Redeployment**: Normal process\n\n### Workers\n- **Examples**: celery-worker, celery-beat\n- **Endpoint**: Standard service update\n- **Health Check**: N/A (no HTTP endpoint)\n- **Redeployment**: No health check validation\n\n### Cron Jobs\n- **Examples**: toolboxai-cleanup\n- **Endpoint**: Standard service update\n- **Health Check**: N/A\n- **Redeployment**: Schedule preserved\n\n### Static Sites\n- **Examples**: toolboxai-dashboard\n- **Endpoint**: Standard service update\n- **Health Check**: Can access built static files\n- **Redeployment**: Triggers build process\n\n### MCP Server\n- **Examples**: toolboxai-mcp\n- **Endpoint**: Standard service update\n- **Protocol**: Model Context Protocol\n- **Requirements**: MCP environment variables must be present in linked env group\n- **Note**: MCP has no special API requirements; handled like any web service\n\n## Verification\n\n### After Running the Script\n\n**Check Render Dashboard**:\n1. Go to https://dashboard.render.com\n2. For each service:\n   - Service → Environment tab\n   - Should show \"Linked\" status for environment groups\n   - Deployments tab should show new deployment in progress\n\n**Check API Status**:\n```bash\npython3 scripts/verify_render_setup.py\n```\n\n**Expected Output**:\n```\n✓ Step 1: API Connection verified\n✓ Step 2: All 3 environment groups exist\n✓ Step 3: All 9 services have correct groups linked\n✓ Step 4: Services deploying/live\n```\n\n### Monitor Build Progress\n\n**Render Dashboard**:\n- Dashboard → Service → Deploys tab\n- Watch build logs in real-time\n\n**Via API**:\n```bash\npython3 << 'EOF'\nimport requests\nimport os\nfrom dotenv import load_dotenv\n\nload_dotenv()\napi_key = os.getenv('RENDER_API_KEY')\nheaders = {\"Authorization\": f\"Bearer {api_key}\"}\n\n# Replace with actual deploy ID\ndeploy_id = \"dep-d47pi5ripnbc73d2bjhg\"\nresponse = requests.get(\n    f\"https://api.render.com/v1/deploys/{deploy_id}\",\n    headers=headers\n)\nprint(response.json()['deploy']['status'])\nEOF\n```\n\n## Troubleshooting\n\n### Issue: \"401 Unauthorized\"\n**Cause**: Invalid or missing RENDER_API_KEY\n\n**Solution**:\n```bash\n# 1. Check if RENDER_API_KEY is set\necho $RENDER_API_KEY\n\n# 2. Verify in .env file\ngrep RENDER_API_KEY .env\n\n# 3. If missing, get it from Render Dashboard:\n#    Account → API Tokens → Create API Token\n#    Copy and add to .env\n```\n\n### Issue: \"404 Not Found\" for service or environment group\n**Cause**: Invalid service ID or environment group ID\n\n**Solution**:\n```bash\n# Get correct IDs from verify script output\npython3 scripts/verify_render_setup.py\n\n# Update in link_env_groups_api.py if needed\n# Look for service_mapping and env_group IDs\n```\n\n### Issue: \"429 Too Many Requests\"\n**Cause**: Rate limiting\n\n**Solution**: Script has built-in retry logic. Increase delays if needed:\n```python\n# In link_env_groups_api.py\nself.rate_limit_delay = 2.0  # Increase from 1.0\n```\n\n### Issue: Deployments still failing after linking\n**Cause**: Build errors not related to environment variables\n\n**Solution**:\n1. Check build logs: Dashboard → Service → Deploys → View logs\n2. Common issues:\n   - Missing dependencies (check requirements.txt)\n   - Code syntax errors\n   - Runtime errors in startup command\n3. Fix in code repository and re-run script\n\n### Issue: Services deployed but not using environment variables\n**Cause**: Services need to restart to pick up new environment variables\n\n**Solution**:\n```bash\n# Re-run deployment script\npython3 scripts/link_env_groups_api.py\n\n# Or manually redeploy each service in Dashboard\n```\n\n## Performance Notes\n\n**Execution Time**:\n- Pre-flight checks: ~5 seconds\n- Linking 9 services: ~20 seconds (1s/request with retries)\n- Triggering 9 deployments: ~15 seconds (1s/request)\n- Monitoring: ~10-15 minutes (depends on build times)\n- **Total**: ~15-30 minutes\n\n**API Rate Limits**:\n- Default: 10 requests/second\n- Script uses: 1 request/second (conservative)\n- Retry strategy: Exponential backoff for 429 responses\n\n**Network Requirements**:\n- Outbound HTTPS to api.render.com\n- No special firewall rules needed\n- Reliable internet connection recommended\n\n## Advanced Configuration\n\n### Custom Service IDs\nIf your service IDs differ from the default, update the mapping:\n\n```python\nself.service_mapping = {\n    'toolboxai-backend': {\n        'service_id': 'YOUR-SERVICE-ID-HERE',  # Get from Render Dashboard URL\n        'env_groups': ['evg-d479opq4d50c73813bu0'],\n        'type': 'web_service'\n    },\n    # ... rest of services\n}\n```\n\n### Custom Environment Group IDs\nIf your environment group IDs differ:\n\n```python\nrequired_groups = {\n    'YOUR-GROUP-ID-HERE': 'toolboxai-secrets',\n    # ... rest of groups\n}\n```\n\n### Modify Deployment Order\nIf services have different dependencies:\n\n```python\nself.deployment_order = [\n    'service-1',\n    'service-2',\n    # ... customize as needed\n]\n```\n\n## API Reference\n\n**Base URL**: `https://api.render.com/v1`\n\n**Authentication**: Bearer token in Authorization header\n\n**Key Endpoints**:\n- `GET /env-groups` - List environment groups\n- `POST /env-groups` - Create environment group\n- `GET /services` - List all services\n- `GET /services/{serviceId}` - Get service details\n- `PATCH /services/{serviceId}` - Update service (including linking env groups)\n- `POST /services/{serviceId}/deploys` - Trigger deployment\n- `GET /deploys/{deployId}` - Get deployment status\n\n**Response Format**: JSON\n\n**Rate Limiting**: Implement with 1-second delays and exponential backoff\n\n## Next Steps\n\n1. **Monitor Deployments**: Watch Render Dashboard for build completion\n2. **Verify Health**: Once live, test health endpoints\n3. **Configure Domains**: Add custom domains if needed\n4. **Setup Monitoring**: Configure alerts and logging\n5. **Documentation**: Update deployment runbooks\n\n## Support & Resources\n\n- **Render API Docs**: https://render.com/docs/api-reference\n- **Render Dashboard**: https://dashboard.render.com\n- **Script Issues**: Check `scripts/link_env_groups_api.py` for detailed comments\n- **Environment Variables**: See `docs/RENDER_ENVIRONMENT_SETUP.md`\n\n## Changelog\n\n### Version 1.0 (2025-11-08)\n- Initial implementation\n- Support for 9 services\n- Automatic retry logic with exponential backoff\n- Real-time deployment monitoring\n- Pre-flight validation checks\n- Rate limiting and error handling\n"